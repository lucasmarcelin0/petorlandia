{% extends "layout.html" %}

{% block main %}
<div class="container py-4">
  <h2 class="mb-4">ğŸ“¦ Detalhes da RaÃ§Ã£o: {{ tipo.marca }} â€” {{ tipo.linha or "NÃ£o informada" }}</h2>

  {% set ns = namespace(total=0, diaria_total=0, tutores=[], precos=[]) %}

  <table class="table table-bordered table-striped">
    <thead class="table-light">
      <tr>
        <th>Animal</th>
        <th>PreÃ§o Pago (R$)</th>
        <th>Tutor</th>
        <th>Celular</th>
        <th>Data</th>
        <th>RecomendaÃ§Ã£o</th>
        <th>Estimativa (pacotes/mÃªs)</th>
        <th>AÃ§Ã£o</th>
      </tr>
    </thead>
    <tbody>
      {% for r in racoes %}
        <tr>
          <td>{{ r.animal.name }}</td>
          <td>
            {% if r.preco_pago %}
              R$ {{ '%.2f' | format(r.preco_pago) }}
              {% set _ = ns.precos.append(r.preco_pago) %}
            {% else %}
              â€”
            {% endif %}
          </td>
          <td>{{ r.animal.owner.name }}</td>
          <td>{{ r.animal.owner.phone or "â€”" }}</td>
          <td>{{ r.data_cadastro|format_datetime_brazil('%d/%m/%Y') }}</td>

          {# CÃ¡lculo da recomendaÃ§Ã£o diÃ¡ria #}
          {% if r.recomendacao_custom %}
            {% set diaria = r.recomendacao_custom %}
          {% elif r.animal.peso and r.tipo_racao.recomendacao %}
            {% set diaria = r.animal.peso * r.tipo_racao.recomendacao %}
          {% else %}
            {% set diaria = None %}
          {% endif %}

          {% if diaria is not none %}
            <td>{{ diaria|round(1) }} g/dia</td>
            {% set mensal = diaria * 30 %}
            {% set pacote_kg = r.tipo_racao.peso_pacote_kg or 15 %}
            {% set pacotes = mensal / (pacote_kg * 1000) %}
            <td>{{ pacotes|round(1) }}</td>
            {% set ns.total = ns.total + pacotes %}
            {% set ns.diaria_total = ns.diaria_total + diaria %}
          {% else %}
            <td colspan="2">âš ï¸ Dados insuficientes</td>
          {% endif %}

          {% if r.animal.owner.id not in ns.tutores %}
            {% set _ = ns.tutores.append(r.animal.owner.id) %}
          {% endif %}

          <td>
            <a href="{{ url_for('consulta_direct', animal_id=r.animal.id) }}" class="btn btn-outline-primary btn-sm">
              ğŸ©º Nova Consulta
            </a>
          </td>
        </tr>
      {% endfor %}

      {% if racoes %}
        <tr class="table-light fw-bold">
          <td>ğŸ“Š {{ racoes|length }} animais</td>
          <td>
            {% if ns.precos %}
              ğŸ’° MÃ©dia: R$ {{ (ns.precos | sum / ns.precos | length) | round(2) }}<br>
              ğŸ›’ MÃ­nimo: R$ {{ ns.precos | min | round(2) }}
            {% else %}
              â€”
            {% endif %}
          </td>
          <td>ğŸ‘¤ {{ ns.tutores|length }} tutores</td>
          <td colspan="2">â€”</td>
          <td>ğŸ½ï¸ {{ ns.diaria_total|round(1) }} g/dia</td>
          <td>ğŸ“¦ {{ ns.total|round(1) }}</td>
          <td>â€”</td>
        </tr>
      {% endif %}
    </tbody>
  </table>

  <a href="{{ url_for('relatorio_racoes') }}" class="btn btn-secondary mt-3">ğŸ”™ Voltar</a>
</div>
{% endblock %}
