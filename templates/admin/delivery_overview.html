{% extends "layout.html" %}

{% block head %}
  {{ super() }}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2yz1G+u/ehabSGvtQvE4H14R/2uOeGjn5ERm2y8="
    crossorigin=""
  />
{% endblock %}

{% block main %}
<div class="container my-4">

  <!-- ‚ñ∏ Bloco de Produtos ------------------------------------------------ -->
  <h4 class="mb-3">üì¶ Produtos em estoque</h4>
  <ul class="list-group shadow-sm mb-5">
    {% for p in products %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ p.name }}
        <span class="badge bg-secondary rounded-pill">{{ p.stock }}</span>
      </li>
    {% else %}
      <li class="list-group-item text-muted">Nenhum produto cadastrado.</li>
    {% endfor %}
  </ul>

{% macro lista(reqs, pagination, page_var, titulo, cls_badge, lbl_badge, open_page, progress_page, completed_page, canceled_page) %}
  <h4 class="mt-4 {{ cls_badge }}">{{ titulo }}</h4>
  <ul class="list-group shadow-sm mb-4">
    {% for r in reqs %}
      {% set ord = r.order %}
      <li class="list-group-item d-flex justify-content-between flex-column flex-md-row align-items-start align-items-md-center">
        <div class="me-3">
          <div class="fw-semibold">
            Pedido¬†#{{ r.order_id }}
            <span class="badge {{ cls_badge }} ms-2">{{ lbl_badge }}</span>
          </div>
          <div class="small text-muted">
            <div>Cliente: {{ ord.user.name if ord and ord.user else "‚Äî" }}</div>
            <div>Valor: R$ {{ ((ord.payment.__dict__.get('amount') if ord and ord.payment else None) or (ord.total_value() if ord else 0)) | round(2) if ord else "‚Äî" }}</div>

            {% if r.status == "pendente" %}
              <div>Solicitado em {{ r.requested_at|format_datetime_brazil('%d/%m/%Y %H:%M') }}</div>
            {% elif r.status == "em_andamento" %}
              <div>Aceito por {{ r.worker.name if r.worker else "‚Äî" }} em {{ r.accepted_at|format_datetime_brazil('%d/%m/%Y %H:%M') if r.accepted_at else "‚Äî" }}</div>
            {% elif r.status == "concluida" %}
              <div>Conclu√≠do em {{ r.completed_at|format_datetime_brazil('%d/%m/%Y %H:%M') if r.completed_at else "‚Äî" }}</div>
            {% elif r.status == "cancelada" %}
              <div>Cancelado em {{ r.canceled_at|format_datetime_brazil('%d/%m/%Y %H:%M') if r.canceled_at else "‚Äî" }}</div>
            {% endif %}
          </div>
        </div>

        <div class="d-flex flex-wrap gap-1 mt-2 mt-md-0">
          <a href="{{ url_for('admin_delivery_detail', req_id=r.id) }}"
             class="btn btn-sm btn-outline-primary">
             Ver detalhes
          </a>
          {% set origin = r.pickup.endereco.full if r.pickup else DEFAULT_PICKUP_ADDRESS %}
          {% set destination = ord.shipping_address or (ord.user.endereco.full if ord and ord.user and ord.user.endereco and ord.user.endereco.full else None) %}
          {% if origin and destination %}
          <a class="btn btn-sm btn-outline-secondary" target="_blank"
             href="https://www.google.com/maps/dir/?api=1&origin={{ origin | urlencode }}&destination={{ destination | urlencode }}">
             Mapa
          </a>
          {% endif %}
          {% if r.status != 'pendente' %}
          <form action="{{ url_for('admin_set_delivery_status', req_id=r.id, status='pendente') }}" method="post" class="js-admin-delivery-form">
            <button class="btn btn-sm btn-warning" title="Marcar como pendente">Pendente</button>
          </form>
          {% endif %}
          {% if r.status != 'em_andamento' %}
          <form action="{{ url_for('admin_set_delivery_status', req_id=r.id, status='em_andamento') }}" method="post" class="js-admin-delivery-form">
            <button class="btn btn-sm btn-info text-dark" title="Marcar em andamento">Em andamento</button>
          </form>

          {% endif %}
          {% if r.status != 'concluida' %}
          <form action="{{ url_for('admin_set_delivery_status', req_id=r.id, status='concluida') }}" method="post" class="js-admin-delivery-form">
            <button class="btn btn-sm btn-success" title="Marcar como conclu√≠da">Concluir</button>
          </form>
          {% endif %}
          {% if r.status != 'cancelada' %}

          <form action="{{ url_for('admin_set_delivery_status', req_id=r.id, status='cancelada') }}" method="post" class="js-admin-delivery-form">
            <button class="btn btn-sm btn-danger" title="Cancelar">Cancelar</button>
          </form>
          {% endif %}
          <form action="{{ url_for('admin_delete_delivery', req_id=r.id) }}" method="post" onsubmit="return confirm('Excluir pedido?');" class="js-admin-delivery-form">
            <button class="btn btn-sm btn-outline-danger" title="Excluir">Excluir</button>
          </form>
          <form action="{{ url_for('admin_archive_delivery', req_id=r.id) }}" method="post" class="js-admin-delivery-form">
            <button class="btn btn-sm btn-outline-secondary" title="Arquivar">Arquivar</button>
          </form>
        </div>
      </li>
    {% else %}
      <li class="list-group-item text-muted">N√£o h√° registros.</li>
    {% endfor %}
  </ul>
  {% if pagination and pagination.has_next %}
  <div class="text-center mb-4">
    <a class="btn btn-sm btn-outline-secondary"
       href="{{ url_for('delivery_overview',
                        open_page=(pagination.next_num if page_var=='open_page' else open_page),
                        progress_page=(pagination.next_num if page_var=='progress_page' else progress_page),
                        completed_page=(pagination.next_num if page_var=='completed_page' else completed_page),
                        canceled_page=(pagination.next_num if page_var=='canceled_page' else canceled_page) ) }}">
      Mostrar mais
    </a>
  </div>
  {% endif %}
{% endmacro %}  <!-- ‚ñ∏ Listas ----------------------------------------------------------- -->
  <div class="row row-cols-1 row-cols-md-4 g-4">
    <div class="col">
      {{ lista(open_requests, open_pagination, 'open_page', "üü° Solicita√ß√µes Abertas",   "bg-warning text-dark", "Pendente", open_page, progress_page, completed_page, canceled_page) }}
    </div>
    <div class="col">
      {{ lista(in_progress, progress_pagination, 'progress_page', "üîµ Em Andamento",          "bg-info text-dark", "Em andamento", open_page, progress_page, completed_page, canceled_page) }}
    </div>
    <div class="col">
      {{ lista(completed, completed_pagination, 'completed_page', "‚úÖ Conclu√≠das",            "bg-success", "Conclu√≠da", open_page, progress_page, completed_page, canceled_page) }}
    </div>
    <div class="col">
      {{ lista(canceled, canceled_pagination, 'canceled_page', "‚ùå Canceladas",            "bg-danger", "Cancelada", open_page, progress_page, completed_page, canceled_page) }}
    </div>
  </div>

  <div class="text-center mt-4">
    <a class="btn btn-outline-secondary" href="{{ url_for('delivery_archive') }}">
      <i class="fas fa-archive me-1"></i> Arquivadas: pedidos arquivados
    </a>
  </div>

  <div class="mt-4">
    <h4>Mapa dos entregadores</h4>
    <div id="workersMap" style="height: 400px;"></div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1jG8CjNd8Pr+X/4A9Hd4RJpcJnSMr3vzYW3LFyf0="
    crossorigin=""
  ></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const locations = {{ worker_locations|tojson }};
      const mapEl = document.getElementById('workersMap');
      if (!locations.length) {
        if (mapEl) mapEl.style.display = 'none';
        return;
      }
      const map = L.map('workersMap');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      const markers = {};
      locations.forEach(l => {
        markers[l.id] = L.marker([l.lat, l.lng]).addTo(map);
      });
      const fit = () => {
        const pts = Object.values(markers).map(m => m.getLatLng());
        if (pts.length) map.fitBounds(pts, { padding: [20, 20] });
      };
      fit();

      async function refresh() {
        try {
          const resp = await fetch('{{ url_for('admin_delivery_locations') }}');
          const data = await resp.json();
          data.forEach(loc => {
            const pos = [loc.lat, loc.lng];
            if (markers[loc.id]) {
              markers[loc.id].setLatLng(pos);
            } else {
              markers[loc.id] = L.marker(pos).addTo(map);
            }
          });
          fit();
        } catch (err) {
          console.error(err);
        }
      }

      setInterval(refresh, 5000);
    });
  </script>

</div>
{% endblock %}
