{% extends "layout.html" %}
{% block main %}
<div class="container my-4">

  <!-- â–¸ Bloco de Produtos ------------------------------------------------ -->
  <h4 class="mb-3">ðŸ“¦ Produtos em estoque</h4>
  <ul class="list-group shadow-sm mb-5">
    {% for p in products %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ p.name }}
        <span class="badge bg-secondary rounded-pill">{{ p.stock }}</span>
      </li>
    {% else %}
      <li class="list-group-item text-muted">Nenhum produto cadastrado.</li>
    {% endfor %}
  </ul>

  {% macro lista(reqs, titulo, cls_badge, lbl_badge) %}
  <h4 class="mt-4 {{ cls_badge }}">{{ titulo }}</h4>
  <ul class="list-group shadow-sm mb-5">
    {% for r in reqs %}
      {% set ord = r.order %}
      <li class="list-group-item d-flex justify-content-between flex-column flex-md-row align-items-start align-items-md-center">
        <div class="me-3">
          <div class="fw-semibold">
            PedidoÂ #{{ r.order_id }}
            <span class="badge {{ cls_badge }} ms-2">{{ lbl_badge }}</span>
          </div>
          <div class="small text-muted">
            <div>Cliente: {{ ord.user.name if ord and ord.user else "â€”" }}</div>
            <div>Valor: R$ {{ ((ord.payment.__dict__.get('amount') if ord and ord.payment else None) or (ord.total_value() if ord else 0)) | round(2) if ord else "â€”" }}</div>

            {% if r.status == "pendente" %}
              <div>Solicitado em {{ r.requested_at.strftime("%d/%m/%Y %H:%M") }}</div>
            {% elif r.status == "em_andamento" %}
              <div>Aceito por {{ r.worker.name if r.worker else "â€”" }} em {{ r.accepted_at.strftime("%d/%m/%Y %H:%M") if r.accepted_at else "â€”" }}</div>
            {% elif r.status == "concluida" %}
              <div>ConcluÃ­do em {{ r.completed_at.strftime("%d/%m/%Y %H:%M") if r.completed_at else "â€”" }}</div>
            {% endif %}
          </div>
        </div>

        <div class="d-flex flex-wrap gap-1 mt-2 mt-md-0">
          <a href="{{ url_for('admin_delivery_detail', req_id=r.id) }}"
             class="btn btn-sm btn-outline-primary">
             Ver detalhes
          </a>
          <form action="{{ url_for('admin_set_delivery_status', req_id=r.id, status='pendente') }}" method="post">
            <button class="btn btn-sm btn-warning" title="Marcar como pendente">Pendente</button>
          </form>
          <form action="{{ url_for('admin_set_delivery_status', req_id=r.id, status='em_andamento') }}" method="post">
            <button class="btn btn-sm btn-info text-dark" title="Marcar em andamento">Em andamento</button>
          </form>
          <form action="{{ url_for('admin_set_delivery_status', req_id=r.id, status='cancelada') }}" method="post">
            <button class="btn btn-sm btn-danger" title="Cancelar">Cancelar</button>
          </form>
          <form action="{{ url_for('admin_delete_delivery', req_id=r.id) }}" method="post" onsubmit="return confirm('Excluir pedido?');">
            <button class="btn btn-sm btn-outline-danger" title="Excluir">Excluir</button>
          </form>
        </div>
      </li>
    {% else %}
      <li class="list-group-item text-muted">NÃ£o hÃ¡ registros.</li>
    {% endfor %}
  </ul>
  {% endmacro %}

  <!-- â–¸ Listas ----------------------------------------------------------- -->
  {{ lista(open_requests, "ðŸŸ¡Â SolicitaÃ§Ãµes Abertas",   "bg-warning text-dark", "Pendente") }}
  {{ lista(in_progress,   "ðŸ”µÂ Em Andamento",          "bg-info text-dark",   "Em andamento") }}
  {{ lista(completed,     "âœ…Â ConcluÃ­das",            "bg-success",          "ConcluÃ­da") }}

</div>
{% endblock %}
