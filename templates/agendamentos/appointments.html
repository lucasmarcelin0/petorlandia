{% extends "layout.html" %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/appointments.css') }}">
{% endblock %}

{% block main %}
<section class="container py-4" aria-labelledby="appointments-calendar-title">

  <!-- Cabeçalho -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
      <h2 id="appointments-calendar-title" class="fw-bold text-gradient mb-0">
      <i class="bi bi-calendar4-week me-2"></i> Agenda de Consultas
    </h2>
    {% if current_user.role == 'admin' %}
    <div class="w-100 ms-lg-auto">
      {% set switcher_select_id = 'admin-agenda-user-picker' %}
      {% set switcher_label_text = 'Selecionar usuário' %}
      {% set switcher_select_classes = 'form-select w-100' %}
      {% set switcher_form_classes = 'd-flex align-items-center gap-2 w-100' %}
      {% set switcher_default_option_label = 'Minha agenda' %}
      {% include 'partials/admin_agenda_switcher.html' %}
    </div>
    {% endif %}
  </div>

  {% set calendar_redirect_url = none %}
  {% if not form %}
    {% if current_user.role == 'admin' %}
      {% set calendar_redirect_url = url_for('appointments', view_as='colaborador') %}
    {% else %}
      {% set calendar_redirect_url = url_for('appointments_calendar') %}
    {% endif %}
  {% endif %}
  {% set calendar_pets_endpoint = url_for('api_my_pets') %}
  {% if current_user.role == 'admin' or current_user.worker in ['veterinario', 'colaborador'] %}
    {% set calendar_pets_endpoint = url_for(
      'api_clinic_pets',
      view_as=request.args.get('view_as'),
      veterinario_id=request.args.get('veterinario_id'),
      colaborador_id=request.args.get('colaborador_id'),
      clinica_id=request.args.get('clinica_id')
    ) %}
  {% endif %}
  {% set pet_quick_list_endpoint = calendar_pets_endpoint %}
  {% set pet_quick_list_component_id = 'appointments-pet-quick-list' %}
  {% set pet_quick_list_new_pet_url = url_for('novo_animal') %}
  {% set summary_panel_template = 'partials/appointments_summary_panel.html' %}
  {% set schedule_toggle_clinic_id = current_user.clinica_id %}
  {% set schedule_toggle_calendar_redirect_url = calendar_redirect_url %}
  {% include 'partials/calendar_layout.html' %}

  <!-- Gerenciar horários (novo + editar) -->
  <div class="card border-0 shadow-lg rounded-4 mb-5">
    <div class="card-header border-0 p-0">
      <nav class="schedule-toolbar rounded-top-4" aria-label="Ações rápidas da agenda">
        <div class="schedule-toolbar-buttons">
          <button
            id="openScheduleModal"
            class="schedule-toolbar-btn schedule-toolbar-btn--neutral"
            type="button"
          >
            <i class="bi bi-pencil"></i>
            <span>Editar Horário</span>
          </button>
          {% if form %}
            <button
              class="schedule-toolbar-btn schedule-toolbar-btn--success"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#newAppointmentForm"
            >
              <i class="bi bi-plus-circle"></i>
              <span>Nova Consulta</span>
            </button>
          {% endif %}
        </div>
      </nav>
    </div>

    <div class="collapse" id="newAppointmentForm">
      <div class="card-body p-4">
        {% if form %}
        <form method="POST" data-appointment-form>
          {{ form.hidden_tag() }}
          <div class="row g-3">
            <div class="col-md-6 col-lg-4">
              {{ form.tutor_id.label(class="form-label fw-semibold") }}
              {{ form.tutor_id(class="form-select", **{'data-appointment-tutor-select': 'true'}) }}
              {% for error in form.tutor_id.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-6 col-lg-4">
              {{ form.animal_id.label(class="form-label fw-semibold", for=form.animal_id.id) }}
              {% set animal_select_classes = 'form-select' %}
              {% if form.animal_id.errors %}
                {% set animal_select_classes = animal_select_classes + ' is-invalid' %}
              {% endif %}
              {% set animal_options = form.animal_data or [] %}
              <select
                id="{{ form.animal_id.id }}"
                name="{{ form.animal_id.name }}"
                class="{{ animal_select_classes }}"
                data-appointment-animal-select
              >
                {% if not animal_options %}
                  <option value="" selected disabled>Sem animais disponíveis</option>
                {% endif %}
                {% for option in animal_options %}
                  {% set option_tutor_id = option.tutor_id if option.tutor_id is not none else '' %}
                  <option
                    value="{{ option.id }}"
                    data-tutor-id="{{ option_tutor_id }}"
                    data-tutor-name="{{ option.tutor_name }}"
                    {% if form.animal_id.data == option.id %}selected{% endif %}
                  >
                    {{ option.name }}{% if option.tutor_name %} — {{ option.tutor_name }}{% endif %}
                  </option>
                {% endfor %}
              </select>
              {% for error in form.animal_id.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
              {% endfor %}
              <div class="form-text text-muted d-none" data-appointment-animal-empty>
                Nenhum animal disponível para o tutor selecionado.
              </div>
            </div>
            <div class="col-md-12 col-lg-4">
              {{ form.veterinario_id.label(class="form-label fw-semibold") }}
              {{ form.veterinario_id(class="form-select", **{'data-schedule-vet-select': 'true'}) }}
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-6">
              {{ form.date.label(class="form-label fw-semibold") }}
              {{ form.date(class="form-control", type="date") }}
            </div>
            <div class="col-md-6">
              {{ form.time.label(class="form-label fw-semibold") }}
              <select
                id="{{ form.time.id }}"
                name="{{ form.time.name }}"
                class="form-select"
                data-placeholder="Selecione um horário"
                data-empty-text="Sem horários disponíveis"
                data-current-time="{{ form.time.data.strftime('%H:%M') if form.time.data else '' }}"
                {% if form.time.flags.required %}required{% endif %}
              >
                {% if form.time.data %}
                  {% set current_time = form.time.data.strftime('%H:%M') %}
                  <option value="{{ current_time }}" selected>{{ current_time }}</option>
                {% else %}
                  <option value="" selected disabled>Selecione um horário</option>
                {% endif %}
              </select>
            </div>
          </div>

          <div class="mt-3">
            {{ form.kind.label(class="form-label fw-semibold") }}
            {{ form.kind(class="form-select") }}
          </div>

          <div class="mt-3">
            {{ form.reason.label(class="form-label fw-semibold") }}
            {{ form.reason(class="form-control", rows=3, placeholder="Motivo da consulta...") }}
          </div>

          <div class="d-grid mt-4">
            {{ form.submit(class="btn btn-success btn-lg rounded-pill") }}
          </div>
        </form>
        <div class="mt-4">
          <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-3 mb-3">
            <div class="d-flex align-items-center flex-wrap gap-2">
              <h6 class="fw-bold mb-0" data-schedule-title>
                <i class="bi bi-calendar3 me-2"></i>Disponibilidade do Veterinário
                <span
                  class="ms-2 text-primary fw-semibold d-none"
                  data-schedule-vet-name
                  aria-hidden="true"
                ></span>
              </h6>
              <span
                class="schedule-chip schedule-chip--muted"
                data-schedule-summary
                aria-live="polite"
              >
                Selecione um profissional para visualizar a agenda.
              </span>
            </div>
            <div class="d-flex flex-wrap align-items-center gap-2 ms-lg-auto">
              <div class="d-flex align-items-center flex-wrap gap-2" data-schedule-legend>
                <span class="schedule-chip schedule-chip--success">
                  <i class="bi bi-check-circle-fill"></i>
                  Disponível
                </span>
                <span class="schedule-chip schedule-chip--danger">
                  <i class="bi bi-x-circle-fill"></i>
                  Indisponível
                </span>
                <span class="schedule-chip schedule-chip--neutral">
                  <i class="bi bi-slash-circle-fill"></i>
                  Fora do expediente
                </span>
              </div>
              <button
                class="btn schedule-action-btn schedule-action-btn--primary btn-sm"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#scheduleOverviewCollapse"
                aria-expanded="true"
                aria-controls="scheduleOverviewCollapse"
                data-show-label="Mostrar agenda"
                data-hide-label="Ocultar agenda"
              >
                Ocultar agenda
              </button>
            </div>
          </div>
          <div class="d-flex flex-column flex-xl-row align-items-xl-center gap-3 mb-3">
            <div class="d-flex align-items-center gap-2 small text-muted">
              <i class="bi bi-calendar-week me-1"></i>
              <span data-schedule-week-label aria-live="polite">
                Aguardando seleção de profissional.
              </span>
            </div>
            <div class="d-flex flex-wrap align-items-center gap-2 ms-xl-auto">
              <div class="btn-group btn-group-sm" role="group" aria-label="Navegação da agenda semanal">
                <button
                  type="button"
                  class="btn schedule-action-btn schedule-action-btn--muted"
                  data-schedule-week-prev
                  aria-label="Semana anterior"
                >
                  <i class="bi bi-chevron-left"></i>
                  <span class="d-none d-sm-inline">Semana anterior</span>
                </button>
                <button
                  type="button"
                  class="btn schedule-action-btn schedule-action-btn--muted"
                  data-schedule-week-today
                  aria-label="Ir para semana atual"
                >
                  Hoje
                </button>
                <button
                  type="button"
                  class="btn schedule-action-btn schedule-action-btn--muted"
                  data-schedule-week-next
                  aria-label="Próxima semana"
                >
                  <span class="d-none d-sm-inline">Próxima semana</span>
                  <i class="bi bi-chevron-right"></i>
                </button>
              </div>
              <div class="d-flex align-items-center gap-2">
                <label for="schedulePeriodFilter" class="form-label small text-muted mb-0">Período</label>
                <select
                  id="schedulePeriodFilter"
                  class="form-select form-select-sm w-auto"
                  data-schedule-period-filter
                >
                  <option value="all">Todos</option>
                  <option value="morning">Manhã</option>
                  <option value="afternoon">Tarde</option>
                  <option value="evening">Noite</option>
                </select>
              </div>
            </div>
          </div>
          <div class="collapse show" id="scheduleOverviewCollapse">
            <div id="schedule-overview" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 small"></div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-lg rounded-4 mb-5">
    <div class="card-header bg-info text-white rounded-top-4 d-flex align-items-center">
      <h5 class="mb-0"><i class="bi bi-clipboard-pulse me-2"></i> Agenda de Exames</h5>
    </div>
    <div class="card-body">
      {% if exam_appointments %}
      <ul class="list-group list-group-flush">
        {% for exam in exam_appointments %}
        <li class="list-group-item d-flex justify-content-between align-items-start gap-3">
          <div>
            <div class="fw-semibold">{{ exam.scheduled_at|format_datetime_brazil('%d/%m/%Y %H:%M') }}</div>
            <div class="small text-muted">Animal: {{ exam.animal.name if exam.animal else '—' }}</div>
            <div class="small text-muted">Especialista: {{ exam.specialist.user.name if exam.specialist and exam.specialist.user else '—' }}</div>
          </div>
          <span class="badge align-self-center {% if exam.status_display == 'Aceito' %}bg-success{% elif exam.status_display == 'Cancelado' %}bg-danger{% elif exam.status_display == 'Prazo expirado' %}bg-secondary{% else %}bg-warning text-dark{% endif %}">{{ exam.status_display }}</span>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-muted mb-0">Nenhum exame agendado no momento.</p>
      {% endif %}
    </div>
  </div>

  <div id="appointmentsList" data-appointments-container data-refresh-url="{{ request.url }}">
    {% include 'partials/appointments_table.html' %}
  </div>


</section>

<!-- Modal Editar Horário do Colaborador -->
<div class="modal fade" id="scheduleEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
      <div class="modal-header bg-primary text-white border-0 align-items-start">
        <div>
          <h5 class="modal-title fw-semibold d-flex align-items-center gap-2 mb-1">
            <i class="bi bi-clock-history"></i>
            Editar Horário do Colaborador
          </h5>
          <p class="mb-0 small text-white-50">Ajuste a disponibilidade de atendimento com rapidez e segurança.</p>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body bg-light">
        <form
          id="schedule-edit-form"
          class="needs-validation"
          novalidate
          method="post"
          action="{{ url_for('edit_vet_schedule_slot', veterinario_id=0, horario_id=0) }}"
          data-action-template="{{ url_for('edit_vet_schedule_slot', veterinario_id=0, horario_id=0) }}"
        >
          <input type="hidden" name="schedule-csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" id="schedule-slot-id">
          <div class="alert alert-primary d-flex align-items-start gap-3 small shadow-sm mb-4" role="status">
            <i class="bi bi-info-circle-fill fs-5"></i>
            <div>
              Revise os dados antes de salvar. As alterações impactam imediatamente na agenda disponível para agendamentos.
            </div>
          </div>
          <div class="row g-4">
            <div class="col-lg-5">
              <div class="bg-white border rounded-3 shadow-sm p-3 h-100">
                <label for="schedule-vet" class="form-label fw-semibold text-muted text-uppercase small">Colaborador</label>
                <div class="input-group">
                  <span class="input-group-text bg-light text-secondary">
                    <i class="bi bi-person-badge"></i>
                  </span>
                  <select id="schedule-vet" name="schedule-veterinario_id" class="form-select"></select>
                </div>
                <p class="form-text small mt-2 mb-0">Selecione o profissional para aplicar o ajuste de disponibilidade.</p>
              </div>
            </div>
            <div class="col-lg-7">
              <div class="bg-white border rounded-3 shadow-sm p-3">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                  <div>
                    <span class="schedule-chip schedule-chip--primary">Disponibilidade semanal</span>
                    <p class="small text-muted mb-0">Defina o dia, horário de início e término do atendimento.</p>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="schedule-chip schedule-chip--info">
                      <i class="bi bi-calendar-event"></i>
                      Campos obrigatórios
                    </span>
                  </div>
                </div>
                <div class="row g-3">
                  <div class="col-sm-6">
                    <label for="schedule-day" class="form-label fw-semibold">Dia da Semana</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light text-secondary"><i class="bi bi-calendar3"></i></span>
                      <select id="schedule-day" name="schedule-dias_semana" class="form-select">
                        <option value="Segunda">Segunda</option>
                        <option value="Terça">Terça</option>
                        <option value="Quarta">Quarta</option>
                        <option value="Quinta">Quinta</option>
                        <option value="Sexta">Sexta</option>
                        <option value="Sábado">Sábado</option>
                        <option value="Domingo">Domingo</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-sm-3">
                    <label for="schedule-start" class="form-label fw-semibold">Início</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light text-secondary"><i class="bi bi-clock"></i></span>
                      <input type="time" id="schedule-start" name="schedule-hora_inicio" class="form-control">
                    </div>
                  </div>
                  <div class="col-sm-3">
                    <label for="schedule-end" class="form-label fw-semibold">Fim</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light text-secondary"><i class="bi bi-clock-history"></i></span>
                      <input type="time" id="schedule-end" name="schedule-hora_fim" class="form-control">
                    </div>
                  </div>
                </div>
                <div class="mt-4">
                  <button
                    class="btn schedule-action-btn schedule-action-btn--muted btn-sm"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#scheduleIntervalCollapse"
                    aria-expanded="false"
                    aria-controls="scheduleIntervalCollapse"
                  >
                    <i class="bi bi-arrow-repeat"></i>
                    <span>Intervalo de atendimento opcional</span>
                  </button>
                  <div class="collapse mt-3" id="scheduleIntervalCollapse">
                    <div class="row g-3">
                      <div class="col-sm-6">
                        <label for="schedule-interval-start" class="form-label fw-semibold">Início do intervalo</label>
                        <div class="input-group">
                          <span class="input-group-text bg-light text-secondary"><i class="bi bi-hourglass-split"></i></span>
                          <input
                            type="time"
                            name="schedule-intervalo_inicio"
                            id="schedule-interval-start"
                            class="form-control"
                          >
                        </div>
                      </div>
                      <div class="col-sm-6">
                        <label for="schedule-interval-end" class="form-label fw-semibold">Fim do intervalo</label>
                        <div class="input-group">
                          <span class="input-group-text bg-light text-secondary"><i class="bi bi-hourglass-bottom"></i></span>
                          <input
                            type="time"
                            name="schedule-intervalo_fim"
                            id="schedule-interval-end"
                            class="form-control"
                          >
                        </div>
                      </div>
                    </div>
                    <p class="form-text small mt-2 mb-0">Defina um período em que o colaborador ficará indisponível (por exemplo, horário de almoço).</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer bg-white border-0 d-flex justify-content-between align-items-center">
        <div class="small text-muted">
          <i class="bi bi-shield-check me-1"></i>Alterações salvas atualizam instantaneamente o portal de agendamentos.
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button
            type="submit"
            form="schedule-edit-form"
            class="btn btn-primary"
            name="schedule-submit"
            value="Salvar"
          >Salvar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Consulta -->
<div class="modal fade" id="appointmentEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-pencil-square me-2"></i> Editar Consulta
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="text-center text-muted">
          <i class="bi bi-hourglass-split fs-2 d-block mb-2"></i>
          Carregando...
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='appointments_schedule_toolbar.js') }}"></script>
<script type="module">
  import { setupAppointmentsCalendarSummary } from "{{ url_for('static', filename='appointments_calendar_summary.js') }}";
  setupAppointmentsCalendarSummary();
</script>
<script type="module" src="{{ url_for('static', filename='appointments_table.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='appointments_new_consulta.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  let vetField = {% if form %}document.getElementById('{{ form.veterinario_id.id }}'){% else %}null{% endif %};
  const vetSelectElements = Array.from(document.querySelectorAll('[data-schedule-vet-select]'));
  if (!vetField && vetSelectElements.length) {
    [vetField] = vetSelectElements;
  }
  const dateField = {% if form %}document.getElementById('{{ form.date.id }}'){% else %}null{% endif %};
  const timeField = {% if form %}document.getElementById('{{ form.time.id }}'){% else %}null{% endif %};
  const timeFieldPlaceholder = timeField && timeField.dataset && timeField.dataset.placeholder
    ? timeField.dataset.placeholder
    : 'Selecione um horário';
  const timeFieldEmptyText = timeField && timeField.dataset && timeField.dataset.emptyText
    ? timeField.dataset.emptyText
    : 'Sem horários disponíveis';
  const scheduleContainer = document.getElementById('schedule-overview');
  const scheduleCollapseEl = document.getElementById('scheduleOverviewCollapse');
  const scheduleToggleBtn = document.querySelector('[data-bs-target="#scheduleOverviewCollapse"]');
  const scheduleSummaryEl = document.querySelector('[data-schedule-summary]');
  const scheduleWeekLabelEl = document.querySelector('[data-schedule-week-label]');
  const schedulePeriodFilter = document.querySelector('[data-schedule-period-filter]');
  const scheduleWeekPrevBtn = document.querySelector('[data-schedule-week-prev]');
  const scheduleWeekNextBtn = document.querySelector('[data-schedule-week-next]');
  const scheduleWeekTodayBtn = document.querySelector('[data-schedule-week-today]');
  const scheduleTitleEl = document.querySelector('[data-schedule-title]');
  const scheduleTitleVetNameEl = scheduleTitleEl
    ? scheduleTitleEl.querySelector('[data-schedule-vet-name]')
    : document.querySelector('[data-schedule-vet-name]');
  const scheduleToggleShowLabel = scheduleToggleBtn
    ? (scheduleToggleBtn.dataset && scheduleToggleBtn.dataset.showLabel)
      || scheduleToggleBtn.getAttribute('data-show-label')
      || 'Mostrar agenda'
    : 'Mostrar agenda';
  const scheduleToggleHideLabel = scheduleToggleBtn
    ? (scheduleToggleBtn.dataset && scheduleToggleBtn.dataset.hideLabel)
      || scheduleToggleBtn.getAttribute('data-hide-label')
      || 'Ocultar agenda'
    : 'Ocultar agenda';
  const calendarContainer = document.querySelector('[data-calendar-redirect-url]');
  const calendarRedirectUrl = (calendarContainer && calendarContainer.dataset && calendarContainer.dataset.calendarRedirectUrl) || '';
  const newAppointmentCollapseEl = document.getElementById('newAppointmentForm');
  const newAppointmentToggleBtn = document.querySelector('[data-bs-target="#newAppointmentForm"]');
  const newAppointmentForm = newAppointmentCollapseEl
    ? newAppointmentCollapseEl.querySelector('form')
    : null;
  const appointmentsContainer = document.querySelector('[data-appointments-container]');
  const calendarTabsEl = document.querySelector('[data-calendar-tabs]');
  const scheduleTabButton = calendarTabsEl
    ? calendarTabsEl.querySelector('[data-bs-target="#calendar-pane-full"]')
    : document.querySelector('#appointments-calendar-tabs [data-bs-target="#calendar-pane-full"]');
  let newAppointmentCollapseInstance = null;
  let cachedScheduleDays = [];
  let selectedScheduleSlotKey = '';
  const todayIso = new Date().toISOString().split('T')[0];
  let currentScheduleStart = (dateField && dateField.value) ? dateField.value : todayIso;
  let currentVetId = '';
  if (vetField && vetField.value) {
    currentVetId = String(vetField.value).trim();
  } else {
    const initialVetSelect = vetSelectElements.find((select) => select && select.value);
    if (initialVetSelect) {
      currentVetId = String(initialVetSelect.value).trim();
    }
  }
  const defaultScheduleSummary = scheduleSummaryEl
    ? scheduleSummaryEl.textContent.trim()
    : 'Selecione um profissional para visualizar a agenda.';
  const defaultWeekLabel = scheduleWeekLabelEl
    ? scheduleWeekLabelEl.textContent.trim()
    : 'Aguardando seleção de profissional.';
  const selectVetPrompt = defaultScheduleSummary || 'Selecione um profissional para visualizar a agenda.';

  function syncVetSelectValues(value, { source = null } = {}) {
    const normalizedValue = value ? String(value).trim() : '';
    vetSelectElements.forEach((select) => {
      if (!select || select === source) {
        return;
      }
      const currentValue = select.value ? String(select.value).trim() : '';
      if (currentValue !== normalizedValue) {
        select.value = normalizedValue;
      }
    });
    if ((!vetField || !vetField.isConnected) && vetSelectElements.length) {
      vetField = vetSelectElements[0];
    }
  }

  function updateNewAppointmentToggleAria() {
    if (!newAppointmentCollapseEl || !newAppointmentToggleBtn) {
      return;
    }
    const isShown = newAppointmentCollapseEl.classList.contains('show');
    newAppointmentToggleBtn.setAttribute('aria-expanded', isShown ? 'true' : 'false');
  }

  function updateScheduleToggleAria() {
    if (!scheduleCollapseEl || !scheduleToggleBtn) {
      return;
    }
    const isShown = scheduleCollapseEl.classList.contains('show');
    scheduleToggleBtn.setAttribute('aria-expanded', isShown ? 'true' : 'false');
    scheduleToggleBtn.textContent = isShown ? scheduleToggleHideLabel : scheduleToggleShowLabel;
  }

  function setScheduleNavigationDisabled(disabled) {
    [scheduleWeekPrevBtn, scheduleWeekNextBtn, scheduleWeekTodayBtn].forEach((btn) => {
      if (!btn) {
        return;
      }
      btn.disabled = !!disabled;
      btn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
    });
    if (schedulePeriodFilter) {
      schedulePeriodFilter.disabled = !!disabled;
    }
  }

  function findVetLabelById(value) {
    const normalized = value ? String(value).trim() : '';
    if (!normalized) {
      return '';
    }
    const selects = [];
    if (vetField) {
      selects.push(vetField);
    }
    vetSelectElements.forEach((select) => {
      if (select && !selects.includes(select)) {
        selects.push(select);
      }
    });
    for (const select of selects) {
      const option = Array.from(select.options || []).find((opt) => String(opt.value).trim() === normalized);
      if (option) {
        return option.textContent.trim();
      }
    }
    return '';
  }

  function setScheduleTitleVetName(vetId, { label } = {}) {
    if (!scheduleTitleVetNameEl) {
      return;
    }
    const resolvedLabel = (label && label.trim()) || findVetLabelById(vetId);
    if (resolvedLabel) {
      scheduleTitleVetNameEl.textContent = resolvedLabel;
      scheduleTitleVetNameEl.classList.remove('d-none');
      scheduleTitleVetNameEl.setAttribute('aria-hidden', 'false');
    } else {
      scheduleTitleVetNameEl.textContent = '';
      scheduleTitleVetNameEl.classList.add('d-none');
      scheduleTitleVetNameEl.setAttribute('aria-hidden', 'true');
    }
  }

  setScheduleTitleVetName(currentVetId);

  function getBootstrapTabNamespace() {
    if (window.bootstrap && window.bootstrap.Tab && typeof window.bootstrap.Tab.getOrCreateInstance === 'function') {
      return window.bootstrap;
    }
    if (typeof bootstrap !== 'undefined'
      && bootstrap
      && bootstrap.Tab
      && typeof bootstrap.Tab.getOrCreateInstance === 'function') {
      return bootstrap;
    }
    return null;
  }

  function showScheduleTab() {
    if (!scheduleTabButton) {
      return false;
    }
    if (scheduleTabButton.classList.contains('active')) {
      return true;
    }
    const namespace = getBootstrapTabNamespace();
    if (namespace) {
      const tabInstance = namespace.Tab.getOrCreateInstance(scheduleTabButton);
      if (tabInstance && typeof tabInstance.show === 'function') {
        tabInstance.show();
        return true;
      }
    }
    if (typeof scheduleTabButton.click === 'function') {
      scheduleTabButton.click();
      return true;
    }
    return false;
  }

  function ensureNewAppointmentVisible() {
    if (!newAppointmentCollapseEl) {
      return;
    }

    if (window.bootstrap && bootstrap.Collapse) {
      if (!newAppointmentCollapseInstance) {
        newAppointmentCollapseInstance = bootstrap.Collapse.getOrCreateInstance(
          newAppointmentCollapseEl,
          { toggle: false }
        );
      }
      if (!newAppointmentCollapseEl.classList.contains('show')) {
        newAppointmentCollapseInstance.show();
      }
    } else if (!newAppointmentCollapseEl.classList.contains('show')) {
      newAppointmentCollapseEl.classList.add('show');
      newAppointmentCollapseEl.style.height = 'auto';
      newAppointmentCollapseEl.removeAttribute('aria-hidden');
    }

    if (newAppointmentToggleBtn) {
      newAppointmentToggleBtn.setAttribute('aria-expanded', 'true');
    }

    updateNewAppointmentToggleAria();
  }

  function scrollNewAppointmentIntoView() {
    if (!newAppointmentCollapseEl) {
      return;
    }

    window.setTimeout(() => {
      try {
        newAppointmentCollapseEl.scrollIntoView({
          behavior: 'smooth',
          block: 'start',
          inline: 'nearest',
        });
      } catch (error) {
        const rect = newAppointmentCollapseEl.getBoundingClientRect();
        const absoluteTop = rect.top + window.pageYOffset;
        window.scrollTo({
          top: Math.max(absoluteTop - 24, 0),
          behavior: 'smooth',
        });
      }
    }, 200);
  }

  function focusFirstAppointmentField() {
    if (!newAppointmentCollapseEl) {
      return;
    }
    const firstField = newAppointmentCollapseEl.querySelector('input, select, textarea');
    if (!firstField) {
      return;
    }
    window.setTimeout(() => {
      firstField.focus({ preventScroll: false });
    }, 150);
  }

  function openNewAppointmentWithDetail(detail) {
    if (!detail || typeof detail !== 'object') {
      detail = {};
    }

    ensureNewAppointmentVisible();

    if (dateField && detail.date) {
      dateField.value = detail.date;
      dateField.dispatchEvent(new Event('change', { bubbles: true }));
    }

    if (timeField) {
      if (detail.time) {
        timeField.value = detail.time;
        timeField.dataset.currentTime = detail.time;
        timeField.dispatchEvent(new Event('change', { bubbles: true }));
      } else if (timeField.dataset && 'currentTime' in timeField.dataset) {
        timeField.dataset.currentTime = '';
      }
    }

    handleVetChange();
    focusFirstAppointmentField();
    scrollNewAppointmentIntoView();
  }

  function setTimeFieldMessage(message, { disable = false } = {}) {
    if (!timeField) {
      return;
    }
    timeField.innerHTML = '';
    const option = document.createElement('option');
    option.value = '';
    option.textContent = message;
    option.disabled = true;
    option.selected = true;
    timeField.appendChild(option);
    timeField.disabled = disable;
    timeField.value = '';
    timeField.dataset.currentTime = '';
  }

  function populateTimeFieldOptions(times, { bookedTimes = [], placeholderText } = {}) {
    if (!timeField) {
      return;
    }

    const currentTime = timeField.dataset.currentTime || timeField.value || '';
    const availableTimes = Array.from(new Set(Array.isArray(times) ? times : []));
    availableTimes.sort();

    let bookedList = Array.from(new Set(Array.isArray(bookedTimes) ? bookedTimes : []));
    bookedList.sort();
    bookedList = bookedList.filter(t => !availableTimes.includes(t));

    const placeholderLabel = placeholderText
      || (availableTimes.length ? timeFieldPlaceholder : timeFieldEmptyText);

    timeField.innerHTML = '';

    const placeholderOption = document.createElement('option');
    placeholderOption.value = '';
    placeholderOption.textContent = placeholderLabel;
    placeholderOption.disabled = true;
    placeholderOption.selected = !currentTime;
    timeField.appendChild(placeholderOption);

    let hasCurrentTime = false;
    availableTimes.forEach(t => {
      const option = document.createElement('option');
      option.value = t;
      option.textContent = t;
      if (currentTime === t) {
        option.selected = true;
        placeholderOption.selected = false;
        hasCurrentTime = true;
      }
      timeField.appendChild(option);
    });

    const currentIsBooked = currentTime && bookedList.includes(currentTime);
    if (currentTime && !hasCurrentTime) {
      const preservedOption = document.createElement('option');
      preservedOption.value = currentTime;
      preservedOption.textContent = currentIsBooked ? `${currentTime} — ocupado` : currentTime;
      preservedOption.selected = true;
      if (currentIsBooked) {
        preservedOption.dataset.status = 'booked';
        preservedOption.style.color = 'var(--bs-danger)';
        bookedList = bookedList.filter(t => t !== currentTime);
      }
      timeField.appendChild(preservedOption);
    }

    bookedList.forEach(t => {
      const option = document.createElement('option');
      option.value = t;
      option.textContent = `${t} — ocupado`;
      option.disabled = true;
      option.dataset.status = 'booked';
      option.style.color = 'var(--bs-danger)';
      timeField.appendChild(option);
    });

    timeField.disabled = false;
    timeField.dataset.currentTime = timeField.value;
  }

  async function updateTimes(forcedVetId) {
    if (!dateField || !timeField) {
      return;
    }

    const vetSource = forcedVetId !== undefined
      ? forcedVetId
      : (vetField ? vetField.value : currentVetId);
    const vetId = vetSource ? String(vetSource).trim() : '';
    const date = dateField.value ? String(dateField.value).trim() : '';

    if (!vetId) {
      setTimeFieldMessage(selectVetPrompt, { disable: true });
      return;
    }

    if (!date) {
      setTimeFieldMessage(timeFieldPlaceholder, { disable: true });
      return;
    }

    try {
      const resp = await fetch(`/api/specialist/${vetId}/available_times?date=${date}&include_booked=1`);
      if (!resp.ok) {
        throw new Error('Erro ao carregar horários disponíveis');
      }
      const payload = await resp.json();
      let availableTimes = [];
      let bookedTimes = [];
      if (Array.isArray(payload)) {
        availableTimes = payload;
      } else if (payload && typeof payload === 'object') {
        if (Array.isArray(payload.available)) {
          availableTimes = payload.available;
        }
        if (Array.isArray(payload.booked)) {
          bookedTimes = payload.booked;
        }
      }
      populateTimeFieldOptions(availableTimes, { bookedTimes });
      if (!availableTimes.length && !bookedTimes.length) {
        timeField.disabled = true;
      }
    } catch (error) {
      console.error(error);
      setTimeFieldMessage(timeFieldEmptyText, { disable: true });
    }
  }

    function normalizeIsoDate(value) {
      if (!value) {
        return '';
      }
      const raw = String(value).trim();
      if (!raw) {
        return '';
      }
      const normalized = raw.includes('T') ? raw.split('T')[0] : raw;
      const date = new Date(`${normalized}T00:00:00`);
      if (Number.isNaN(date.getTime())) {
        return '';
      }
      return date.toISOString().split('T')[0];
    }

    function shiftIsoDate(base, amount) {
      const normalized = normalizeIsoDate(base) || todayIso;
      const reference = new Date(`${normalized}T00:00:00`);
      reference.setDate(reference.getDate() + amount);
      return reference.toISOString().split('T')[0];
    }

    function formatDateLabel(dateString, { variant = 'short', includeWeekday = true } = {}) {
      const normalized = normalizeIsoDate(dateString);
      if (!normalized) {
        return '';
      }
      const date = new Date(`${normalized}T00:00:00`);
      const options = variant === 'long'
        ? { day: '2-digit', month: 'long' }
        : { day: '2-digit', month: '2-digit' };
      if (includeWeekday) {
        options.weekday = variant === 'long' ? 'long' : 'short';
      }
      return date.toLocaleDateString('pt-BR', options);
    }

    function formatWeekRange(days) {
      const normalizedStart = normalizeIsoDate(currentScheduleStart) || todayIso;
      let rangeStart = normalizedStart;
      let rangeEnd = shiftIsoDate(rangeStart, 6);
      if (Array.isArray(days) && days.length) {
        const firstDay = normalizeIsoDate(days[0].date) || rangeStart;
        const lastDay = normalizeIsoDate(days[days.length - 1].date) || firstDay;
        rangeStart = firstDay;
        rangeEnd = lastDay;
      }
      const startLabel = formatDateLabel(rangeStart, { variant: 'short', includeWeekday: true }) || rangeStart;
      const endLabel = formatDateLabel(rangeEnd, { variant: 'short', includeWeekday: true }) || rangeEnd;
      return `Semana de ${startLabel} a ${endLabel}`;
    }

    function getPeriodFromTime(time) {
      if (!time) {
        return 'all';
      }
      const [hourPart] = time.split(':');
      const hour = Number.parseInt(hourPart, 10);
      if (Number.isNaN(hour)) {
        return 'all';
      }
      if (hour < 12) {
        return 'morning';
      }
      if (hour < 18) {
        return 'afternoon';
      }
      return 'evening';
    }

    function filterSlotsByPeriod(slots, period) {
      if (!Array.isArray(slots) || period === 'all') {
        return Array.isArray(slots) ? [...slots] : [];
      }
      return slots.filter((slot) => getPeriodFromTime(slot) === period);
    }

    function setScheduleSummaryMessage(message) {
      if (!scheduleSummaryEl) {
        return;
      }
      scheduleSummaryEl.textContent = message;
    }

    function setScheduleWeekLabel(message) {
      if (!scheduleWeekLabelEl) {
        return;
      }
      scheduleWeekLabelEl.textContent = message;
    }

    function setScheduleEmptyState(message, tone = 'light') {
      if (!scheduleContainer) {
        return;
      }
      scheduleContainer.innerHTML = '';
      const col = document.createElement('div');
      col.className = 'col';
      const alert = document.createElement('div');
      alert.className = `alert alert-${tone} border-0 mb-0`;
      alert.textContent = message;
      col.appendChild(alert);
      scheduleContainer.appendChild(col);
    }

  function clearScheduleForNoVet() {
    cachedScheduleDays = [];
    selectedScheduleSlotKey = '';
    setScheduleNavigationDisabled(true);
    setScheduleEmptyState(selectVetPrompt, 'light');
    setScheduleSummaryMessage(selectVetPrompt);
    setScheduleWeekLabel(defaultWeekLabel || 'Aguardando seleção de profissional.');
    setScheduleTitleVetName('', { label: '' });
    if (timeField) {
      setTimeFieldMessage(selectVetPrompt, { disable: true });
    }
  }

    function showScheduleLoading() {
      if (!scheduleContainer) {
        return;
      }
      setScheduleSummaryMessage('Carregando agenda...');
      setScheduleWeekLabel('Atualizando agenda...');
      scheduleContainer.innerHTML = '';
      const col = document.createElement('div');
      col.className = 'col';
      const wrapper = document.createElement('div');
      wrapper.className = 'd-flex align-items-center justify-content-center text-muted py-4';
      wrapper.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>Carregando agenda...';
      col.appendChild(wrapper);
      scheduleContainer.appendChild(col);
    }

    function ensureTimeFieldOption(time) {
      if (!timeField) {
        return;
      }
      const options = Array.from(timeField.options || []);
      let option = options.find((opt) => opt.value === time);
      if (!option) {
        option = document.createElement('option');
        option.value = time;
        option.textContent = time;
        timeField.appendChild(option);
      }
      timeField.disabled = false;
      timeField.value = time;
    }

    function createSlotButton(time, status, { date }) {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'btn schedule-action-btn schedule-action-btn--sm schedule-slot flex-shrink-0';
      button.dataset.scheduleSlot = time;
      button.dataset.scheduleDate = date;
      button.dataset.scheduleStatus = status;
      button.dataset.scheduleSlotKey = `${date}T${time}`;
      let iconClass = 'bi-clock';
      if (status === 'available') {
        iconClass = 'bi-check-circle';
        button.classList.add('schedule-action-btn--success', 'schedule-slot--available');
        button.setAttribute('aria-pressed', 'false');
        button.dataset.schedulePeriod = getPeriodFromTime(time);
        button.title = 'Selecionar horário disponível';
      } else if (status === 'booked') {
        iconClass = 'bi-x-circle';
        button.classList.add('schedule-action-btn--danger', 'schedule-slot--booked');
        button.disabled = true;
        button.setAttribute('aria-disabled', 'true');
        button.title = 'Horário indisponível';
      } else {
        iconClass = 'bi-slash-circle';
        button.classList.add('schedule-action-btn--neutral', 'schedule-slot--off');
        button.disabled = true;
        button.setAttribute('aria-disabled', 'true');
        button.title = 'Fora do expediente';
      }
      button.innerHTML = `<i class="bi ${iconClass}"></i><span>${time}</span>`;
      if (status === 'available') {
        button.addEventListener('click', () => {
          selectedScheduleSlotKey = button.dataset.scheduleSlotKey;
          ensureTimeFieldOption(time);
          if (timeField) {
            timeField.dispatchEvent(new Event('change', { bubbles: true }));
          }
          if (dateField && dateField.value !== date) {
            dateField.value = date;
            dateField.dispatchEvent(new Event('change', { bubbles: true }));
          }
          refreshSlotSelection();
        });
      }
      return button;
    }

    function refreshSlotSelection() {
      if (!scheduleContainer) {
        return;
      }
      const buttons = scheduleContainer.querySelectorAll('[data-schedule-slot-key]');
      buttons.forEach((button) => {
        if (button.dataset.scheduleStatus !== 'available') {
          return;
        }
        const isSelected = selectedScheduleSlotKey === button.dataset.scheduleSlotKey;
        button.classList.toggle('schedule-slot--selected', isSelected);
        button.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
      });
      const cards = scheduleContainer.querySelectorAll('[data-schedule-day]');
      cards.forEach((card) => {
        const isSelectedDay = Boolean(selectedScheduleSlotKey) && selectedScheduleSlotKey.startsWith(`${card.dataset.scheduleDay}T`);
        card.classList.toggle('border-primary', isSelectedDay);
        card.classList.toggle('border-3', isSelectedDay);
        card.classList.toggle('shadow', isSelectedDay);
        card.classList.toggle('shadow-sm', !isSelectedDay);
      });
    }

    function updateScheduleSummary(days) {
      if (!scheduleSummaryEl) {
        return;
      }
      if (!Array.isArray(days) || !days.length) {
        setScheduleSummaryMessage('Nenhum horário disponível para o período selecionado.');
        return;
      }
      const period = schedulePeriodFilter ? schedulePeriodFilter.value : 'all';
      for (const day of days) {
        const normalizedDate = normalizeIsoDate(day.date);
        if (!normalizedDate) {
          continue;
        }
        const availableSlots = filterSlotsByPeriod(Array.isArray(day.available) ? day.available : [], period);
        if (availableSlots.length) {
          const label = formatDateLabel(normalizedDate, { variant: 'long', includeWeekday: true }) || normalizedDate;
          setScheduleSummaryMessage(`Próximo horário livre: ${label} às ${availableSlots[0]}`);
          return;
        }
      }
      setScheduleSummaryMessage('Nenhum horário disponível para o período selecionado.');
    }

    function updateScheduleWeekLabel(days) {
      setScheduleWeekLabel(formatWeekRange(days));
    }

    function renderSchedule(days) {
      if (!scheduleContainer) {
        return;
      }
      const scheduleDays = Array.isArray(days) ? days : [];
      scheduleContainer.innerHTML = '';
      if (!scheduleDays.length) {
        setScheduleEmptyState('Nenhuma disponibilidade encontrada para o período selecionado.', 'light');
        updateScheduleSummary(scheduleDays);
        updateScheduleWeekLabel(scheduleDays);
        selectedScheduleSlotKey = '';
        refreshSlotSelection();
        return;
      }
      const period = schedulePeriodFilter ? schedulePeriodFilter.value : 'all';
      scheduleDays.forEach((day) => {
        const normalizedDate = normalizeIsoDate(day.date);
        if (!normalizedDate) {
          return;
        }
        const col = document.createElement('div');
        col.className = 'col';
        const card = document.createElement('div');
        card.className = 'card h-100 shadow-sm position-relative border-1';
        const availableCount = Array.isArray(day.available) ? day.available.length : 0;
        const bookedCount = Array.isArray(day.booked) ? day.booked.length : 0;
        const notWorkingCount = Array.isArray(day.not_working) ? day.not_working.length : 0;
        const hasAvailability = availableCount > 0;
        const baseBorderClass = hasAvailability
          ? 'border-success'
          : (bookedCount > 0 ? 'border-danger' : 'border-secondary');
        card.classList.add(baseBorderClass);
        card.dataset.scheduleDay = normalizedDate;
        if (todayIso === normalizedDate) {
          const todayBadge = document.createElement('span');
          todayBadge.className = 'schedule-chip schedule-chip--primary position-absolute top-0 end-0 translate-middle-y me-3 mt-3';
          todayBadge.textContent = 'Hoje';
          card.appendChild(todayBadge);
        }
        const body = document.createElement('div');
        body.className = 'card-body d-flex flex-column';
        const title = document.createElement('h6');
        title.className = 'card-title fw-bold text-capitalize mb-1';
        title.textContent = formatDateLabel(normalizedDate, { variant: 'short', includeWeekday: true }) || normalizedDate;
        body.appendChild(title);
        const subtitle = document.createElement('p');
        subtitle.className = 'text-muted small text-capitalize mb-3';
        subtitle.textContent = formatDateLabel(normalizedDate, { variant: 'long', includeWeekday: true }) || '';
        body.appendChild(subtitle);

        const totalSlots = availableCount + bookedCount;
        if (totalSlots > 0) {
          const statsRow = document.createElement('div');
          statsRow.className = 'd-flex justify-content-between align-items-center text-muted small mb-2';
          statsRow.innerHTML = `<span><i class="bi bi-check-circle-fill text-success me-1"></i>${availableCount} livre(s)</span><span><i class="bi bi-x-circle-fill text-danger me-1"></i>${bookedCount} ocupado(s)</span>`;
          body.appendChild(statsRow);

          const progress = document.createElement('div');
          progress.className = 'progress bg-light-subtle mb-3';
          const availablePercent = Math.round((availableCount / totalSlots) * 100);
          const bookedPercent = Math.max(0, 100 - availablePercent);
          const availableBar = document.createElement('div');
          availableBar.className = 'progress-bar bg-success';
          availableBar.style.width = `${availablePercent}%`;
          availableBar.setAttribute('aria-label', `${availableCount} horário(s) livre(s)`);
          progress.appendChild(availableBar);
          if (bookedPercent > 0) {
            const bookedBar = document.createElement('div');
            bookedBar.className = 'progress-bar bg-danger';
            bookedBar.style.width = `${bookedPercent}%`;
            bookedBar.setAttribute('aria-label', `${bookedCount} horário(s) ocupado(s)`);
            progress.appendChild(bookedBar);
          }
          body.appendChild(progress);
        } else if (!hasAvailability && notWorkingCount === 0) {
          const badgeInfo = document.createElement('span');
          badgeInfo.className = 'schedule-chip schedule-chip--neutral align-self-start mb-3';
          badgeInfo.textContent = 'Sem horários cadastrados.';
          body.appendChild(badgeInfo);
        }

        const slotsWrapper = document.createElement('div');
        slotsWrapper.className = 'd-flex flex-wrap gap-2';
        const availableSlots = Array.isArray(day.available) ? day.available : [];
        const filteredAvailable = filterSlotsByPeriod(availableSlots, period);
        if (filteredAvailable.length) {
          filteredAvailable.forEach((slot) => {
            slotsWrapper.appendChild(createSlotButton(slot, 'available', { date: normalizedDate }));
          });
        } else if (availableSlots.length && period !== 'all') {
          const noPeriod = document.createElement('div');
          noPeriod.className = 'text-muted small fst-italic';
          noPeriod.textContent = 'Sem horários no período selecionado.';
          slotsWrapper.appendChild(noPeriod);
        }
        (Array.isArray(day.booked) ? day.booked : []).forEach((slot) => {
          slotsWrapper.appendChild(createSlotButton(slot, 'booked', { date: normalizedDate }));
        });
        (Array.isArray(day.not_working) ? day.not_working : []).forEach((slot) => {
          slotsWrapper.appendChild(createSlotButton(slot, 'not_working', { date: normalizedDate }));
        });
        if (!slotsWrapper.children.length) {
          const fallback = document.createElement('div');
          fallback.className = 'text-muted small fst-italic';
          fallback.textContent = 'Fora do expediente.';
          slotsWrapper.appendChild(fallback);
        }
        body.appendChild(slotsWrapper);
        card.appendChild(body);
        col.appendChild(card);
        scheduleContainer.appendChild(col);
      });

      updateScheduleSummary(scheduleDays);
      updateScheduleWeekLabel(scheduleDays);
      refreshSlotSelection();
    }

    async function loadSchedule({ showLoading = true, vetId: requestedVetId } = {}) {
      if (!scheduleContainer) {
        return;
      }

      const resolvedVetId = requestedVetId !== undefined
        ? requestedVetId
        : (currentVetId || (vetField ? vetField.value : ''));
      const activeVetId = resolvedVetId ? String(resolvedVetId).trim() : '';

      if (!activeVetId) {
        clearScheduleForNoVet();
        return;
      }

      currentVetId = activeVetId;
      setScheduleNavigationDisabled(false);

      const start = normalizeIsoDate(currentScheduleStart)
        || (dateField && normalizeIsoDate(dateField.value))
        || todayIso;
      currentScheduleStart = start;

      if (showLoading) {
        showScheduleLoading();
      }

      try {
        const response = await fetch(`/api/specialist/${activeVetId}/weekly_schedule?start=${start}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const days = await response.json();
        cachedScheduleDays = Array.isArray(days) ? days : [];
        renderSchedule(cachedScheduleDays);
      } catch (error) {
        console.warn('Não foi possível carregar os horários disponíveis.', error);
        setScheduleNavigationDisabled(false);
        setScheduleEmptyState('Não foi possível carregar a agenda no momento. Tente novamente.', 'danger');
        setScheduleSummaryMessage('Não foi possível carregar a agenda.');
        setScheduleWeekLabel('Erro ao carregar agenda.');
      }
    }

    function handleVetChange(payload) {
      if (!vetField && !dateField && !timeField && !scheduleContainer) {
        return;
      }

      const isEvent = payload && typeof payload === 'object' && 'target' in payload;
      const target = isEvent ? payload.target : null;
      let vetLabelFromPayload = '';
      if (payload && typeof payload === 'object' && 'vetLabel' in payload && payload.vetLabel !== undefined) {
        vetLabelFromPayload = payload.vetLabel;
      }
      let nextVetId;

      if (typeof payload === 'string' || typeof payload === 'number') {
        nextVetId = payload;
      } else if (payload && typeof payload === 'object' && 'vetId' in payload && payload.vetId !== undefined) {
        nextVetId = payload.vetId;
      } else if (isEvent && payload.target && typeof payload.target.hasAttribute === 'function'
        && payload.target.hasAttribute('data-schedule-vet-select')) {
        nextVetId = payload.target.value;
      }

      if (isEvent && target && target.matches && target.matches('[data-schedule-vet-select]')) {
        if (target.selectedOptions && target.selectedOptions.length) {
          vetLabelFromPayload = vetLabelFromPayload || target.selectedOptions[0].textContent || '';
        }
      }

      if (nextVetId !== undefined) {
        currentVetId = nextVetId ? String(nextVetId).trim() : '';
      } else if (vetField) {
        currentVetId = vetField.value ? String(vetField.value).trim() : '';
      } else if (vetSelectElements.length) {
        const fallbackSelect = vetSelectElements.find((select) => select && select.value);
        currentVetId = fallbackSelect ? String(fallbackSelect.value).trim() : '';
      }

      if (!vetField && target && target.matches && target.matches('[data-schedule-vet-select]')) {
        vetField = target;
      }

      syncVetSelectValues(currentVetId, { source: target });

      const effectiveLabel = vetLabelFromPayload || findVetLabelById(currentVetId);
      setScheduleTitleVetName(currentVetId, { label: effectiveLabel });

      const isVetChange = Boolean(target && typeof target.hasAttribute === 'function' && target.hasAttribute('data-schedule-vet-select'));
      const isDateChange = Boolean(target && target === dateField);

      if (isVetChange) {
        selectedScheduleSlotKey = '';
      }

      if (!currentVetId) {
        clearScheduleForNoVet();
        if (typeof window.updateCalendarVetSelection === 'function') {
          window.updateCalendarVetSelection('', { activate: false, refetch: true });
        } else if (window.sharedCalendar && typeof window.sharedCalendar.refetchEvents === 'function') {
          window.sharedCalendar.refetchEvents();
        }
        return;
      }

      if (dateField && dateField.value) {
        currentScheduleStart = normalizeIsoDate(dateField.value) || currentScheduleStart || todayIso;
      } else if (isVetChange || isDateChange) {
        currentScheduleStart = todayIso;
      }

      if (typeof updateTimes === 'function') {
        updateTimes(currentVetId);
      }

      const shouldShowLoading = !scheduleCollapseEl || scheduleCollapseEl.classList.contains('show');
      loadSchedule({ showLoading: shouldShowLoading, vetId: currentVetId });

      if (typeof window.updateCalendarVetSelection === 'function') {
        window.updateCalendarVetSelection(currentVetId, { activate: false, refetch: true });
      } else if (window.sharedCalendar && typeof window.sharedCalendar.refetchEvents === 'function') {
        window.sharedCalendar.refetchEvents();
      }
    }

  window.handleVetChange = handleVetChange;

  const scheduleBtn = document.getElementById('openScheduleModal');
  const scheduleModalEl = document.getElementById('scheduleEditModal');
  const scheduleForm = scheduleModalEl ? scheduleModalEl.querySelector('#schedule-edit-form') : null;
  const scheduleModalBody = scheduleModalEl ? scheduleModalEl.querySelector('.modal-body') : null;
  const scheduleVetSelect = scheduleForm ? scheduleForm.querySelector('#schedule-vet') : null;
  const scheduleDaySelect = scheduleForm ? scheduleForm.querySelector('#schedule-day') : null;
  const scheduleStartInput = scheduleForm ? scheduleForm.querySelector('#schedule-start') : null;
  const scheduleEndInput = scheduleForm ? scheduleForm.querySelector('#schedule-end') : null;
  const scheduleIntervalStart = scheduleForm ? scheduleForm.querySelector('#schedule-interval-start') : null;
  const scheduleIntervalEnd = scheduleForm ? scheduleForm.querySelector('#schedule-interval-end') : null;
  const scheduleIntervalCollapse = scheduleForm ? document.getElementById('scheduleIntervalCollapse') : null;
  const scheduleSlotInput = scheduleForm ? scheduleForm.querySelector('#schedule-slot-id') : null;
  const scheduleActionTemplate = scheduleForm
    ? (scheduleForm.dataset && scheduleForm.dataset.actionTemplate)
      || scheduleForm.getAttribute('data-action-template')
      || scheduleForm.getAttribute('action')
    : '';
  const canShowScheduleAlert = typeof clearModalAlerts === 'function' && typeof showModalAlert === 'function';
  let scheduleModalInstance = null;

  function clearScheduleFeedback() {
    if (!scheduleModalBody || !canShowScheduleAlert) {
      return;
    }
    clearModalAlerts(scheduleModalBody);
  }

  function showScheduleFeedback(type, message) {
    if (!scheduleModalBody || !canShowScheduleAlert) {
      return;
    }
    showModalAlert(scheduleModalBody, type, message);
  }

  function resolveScheduleId() {
    if (!scheduleForm) {
      return '';
    }
    if (scheduleForm.dataset && scheduleForm.dataset.scheduleId) {
      return scheduleForm.dataset.scheduleId;
    }
    return scheduleSlotInput ? scheduleSlotInput.value : '';
  }

  function buildScheduleAction(vetId, scheduleId) {
    if (!scheduleActionTemplate || !vetId || !scheduleId) {
      return '';
    }
    return scheduleActionTemplate.replace('/0/schedule/0/edit', `/${vetId}/schedule/${scheduleId}/edit`);
  }

  function updateScheduleFormAction() {
    if (!scheduleForm) {
      return '';
    }
    const vetId = scheduleVetSelect ? scheduleVetSelect.value : '';
    const scheduleId = resolveScheduleId();
    const actionUrl = buildScheduleAction(vetId, scheduleId);
    if (actionUrl) {
      scheduleForm.setAttribute('action', actionUrl);
    }
    return actionUrl;
  }

  function setScheduleFormContext(rawContext = {}, { copyVetOptions = true } = {}) {
    if (!scheduleForm) {
      return;
    }
    const context = {
      scheduleId: rawContext.scheduleId || rawContext.horarioId || rawContext.id || '',
      vetId: rawContext.vetId || rawContext.veterinarioId || rawContext.veterinarianId || '',
      day: rawContext.day || rawContext.scheduleDay || rawContext.dia || '',
      start: rawContext.start || rawContext.scheduleStart || rawContext.horaInicio || rawContext.hora_inicio || '',
      end: rawContext.end || rawContext.scheduleEnd || rawContext.horaFim || rawContext.hora_fim || '',
      intervaloInicio: rawContext.intervaloInicio || rawContext.intervalo_inicio || '',
      intervaloFim: rawContext.intervaloFim || rawContext.intervalo_fim || '',
    };

    if (copyVetOptions && vetField && scheduleVetSelect) {
      scheduleVetSelect.innerHTML = vetField.innerHTML;
    }

    if (scheduleForm.dataset) {
      scheduleForm.dataset.scheduleId = context.scheduleId || '';
    }
    if (scheduleSlotInput) {
      scheduleSlotInput.value = context.scheduleId || '';
    }

    if (scheduleVetSelect) {
      if (context.vetId) {
        scheduleVetSelect.value = context.vetId;
      } else if (vetField && vetField.value) {
        scheduleVetSelect.value = vetField.value;
      }
    }
    if (scheduleDaySelect && context.day) {
      scheduleDaySelect.value = context.day;
    }
    if (scheduleStartInput) {
      scheduleStartInput.value = context.start || '';
    }
    if (scheduleEndInput) {
      scheduleEndInput.value = context.end || '';
    }
    if (scheduleIntervalStart) {
      scheduleIntervalStart.value = context.intervaloInicio || '';
    }
    if (scheduleIntervalEnd) {
      scheduleIntervalEnd.value = context.intervaloFim || '';
    }

    if (scheduleIntervalCollapse && window.bootstrap && typeof bootstrap.Collapse === 'function') {
      const collapseInstance = bootstrap.Collapse.getOrCreateInstance(scheduleIntervalCollapse, { toggle: false });
      if (context.intervaloInicio || context.intervaloFim) {
        collapseInstance.show();
      } else {
        collapseInstance.hide();
      }
    }

    clearScheduleFeedback();
    updateScheduleFormAction();
  }

  function openScheduleModalWithContext(context = {}, options = {}) {
    if (!scheduleModalEl) {
      return;
    }
    if (window.bootstrap && bootstrap.Modal) {
      scheduleModalInstance = bootstrap.Modal.getOrCreateInstance(scheduleModalEl);
    }
    setScheduleFormContext(context, options);
    handleVetChange();
    if (scheduleModalInstance) {
      scheduleModalInstance.show();
    }
  }

  function extractTriggerContext(trigger) {
    if (!trigger) {
      return {};
    }
    const dataset = trigger.dataset || {};
    return {
      scheduleId: dataset.scheduleId,
      vetId: dataset.vetId || dataset.veterinarioId,
      day: dataset.scheduleDay || dataset.day || dataset.dia,
      start: dataset.scheduleStart || dataset.start || dataset.horaInicio,
      end: dataset.scheduleEnd || dataset.end || dataset.horaFim,
      intervaloInicio: dataset.intervaloInicio,
      intervaloFim: dataset.intervaloFim,
    };
  }

  async function submitScheduleForm(event) {
    if (!scheduleForm) {
      return;
    }
    event.preventDefault();
    clearScheduleFeedback();

    const submitter = event.submitter || scheduleForm.querySelector('[type="submit"]');
    if (submitter) {
      submitter.disabled = true;
    }

    try {
      const vetId = scheduleVetSelect ? scheduleVetSelect.value : '';
      const scheduleId = resolveScheduleId();
      const actionUrl = updateScheduleFormAction();

      if (!vetId || !scheduleId || !actionUrl) {
        showScheduleFeedback('danger', 'Selecione um horário válido para editar.');
        return;
      }

      const formData = new FormData(scheduleForm);
      if (submitter && submitter.name && !formData.has(submitter.name)) {
        formData.append(submitter.name, submitter.value || submitter.textContent || '');
      } else if (!formData.has('schedule-submit')) {
        formData.append('schedule-submit', submitter && submitter.value ? submitter.value : 'Salvar');
      }

      const response = await fetch(actionUrl, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
      });

      const contentType = response.headers ? response.headers.get('Content-Type') || '' : '';
      let payload = null;
      if (contentType.includes('application/json')) {
        payload = await response.json();
      }

      if (!response.ok || (payload && payload.success === false)) {
        const message = (payload && (payload.message || payload.error)) || 'Não foi possível atualizar o horário.';
        showScheduleFeedback('danger', message);
        return;
      }

      const successMessage = (payload && payload.message) || 'Horários atualizados com sucesso.';
      showScheduleFeedback('success', successMessage);

      try {
        if (typeof updateTimes === 'function') {
          await updateTimes();
        }
        if (typeof loadSchedule === 'function') {
          await loadSchedule();
        }
      } catch (scheduleError) {
        console.warn('Não foi possível atualizar os horários disponíveis.', scheduleError);
      }

      try {
        if (appointmentsContainer && typeof refreshAppointmentsContainer === 'function') {
          await refreshAppointmentsContainer(appointmentsContainer);
        }
      } catch (listError) {
        console.warn('Não foi possível atualizar a lista de agendamentos.', listError);
      }

      if (scheduleModalInstance) {
        window.setTimeout(() => {
          scheduleModalInstance.hide();
        }, 1200);
      }
    } catch (error) {
      console.error('Erro ao atualizar horário do colaborador.', error);
      showScheduleFeedback('danger', 'Erro ao atualizar o horário. Tente novamente.');
    } finally {
      if (submitter) {
        submitter.disabled = false;
      }
    }
  }

  if (scheduleForm) {
    scheduleForm.addEventListener('submit', submitScheduleForm);
    if (scheduleVetSelect) {
      scheduleVetSelect.addEventListener('change', updateScheduleFormAction);
    }
  }

  if (scheduleBtn) {
    scheduleBtn.addEventListener('click', () => {
      const context = extractTriggerContext(scheduleBtn);
      if (!context.vetId && vetField) {
        context.vetId = vetField.value;
      }
      openScheduleModalWithContext(context, { copyVetOptions: true });
    });
  }

  document.addEventListener('click', event => {
    const trigger = event.target ? event.target.closest('[data-schedule-edit]') : null;
    if (!trigger || trigger === scheduleBtn) {
      return;
    }
    event.preventDefault();
    const context = extractTriggerContext(trigger);
    if (!context.vetId && vetField) {
      context.vetId = vetField.value;
    }
    openScheduleModalWithContext(context, { copyVetOptions: true });
  });

  document.addEventListener('scheduleEditRequested', event => {
    const detail = (event && event.detail) || {};
    if (!detail.vetId && vetField) {
      detail.vetId = vetField.value;
    }
    openScheduleModalWithContext(detail, { copyVetOptions: true });
  });

  document.addEventListener('calendarSlotChosen', event => {
    const detail = event.detail || {};
    if (!detail.date) {
      return;
    }
    showScheduleTab();
    if (!dateField) {
      if (calendarRedirectUrl) {
        const targetUrl = new URL(calendarRedirectUrl, window.location.origin);
        targetUrl.searchParams.set('date', detail.date);
        if (detail.time) {
          targetUrl.searchParams.set('time', detail.time);
        }
        window.location.href = targetUrl.toString();
      }
      return;
    }

    openNewAppointmentWithDetail(detail);
  });

  timeField && timeField.addEventListener('change', () => {
    timeField.dataset.currentTime = timeField.value;
  });

  if (schedulePeriodFilter) {
    schedulePeriodFilter.addEventListener('change', () => {
      selectedScheduleSlotKey = '';
      renderSchedule(cachedScheduleDays);
    });
  }

  function navigateSchedule(offsetDays) {
    currentScheduleStart = shiftIsoDate(currentScheduleStart, offsetDays);
    selectedScheduleSlotKey = '';
    const shouldShowLoading = !scheduleCollapseEl || scheduleCollapseEl.classList.contains('show');
    loadSchedule({ showLoading: shouldShowLoading });
  }

  if (scheduleWeekPrevBtn) {
    scheduleWeekPrevBtn.addEventListener('click', () => navigateSchedule(-7));
  }
  if (scheduleWeekNextBtn) {
    scheduleWeekNextBtn.addEventListener('click', () => navigateSchedule(7));
  }
  if (scheduleWeekTodayBtn) {
    scheduleWeekTodayBtn.addEventListener('click', () => {
      currentScheduleStart = todayIso;
      selectedScheduleSlotKey = '';
      const shouldShowLoading = !scheduleCollapseEl || scheduleCollapseEl.classList.contains('show');
      loadSchedule({ showLoading: shouldShowLoading });
    });
  }

  vetSelectElements.forEach((select) => {
    if (!select || select.dataset.scheduleVetBound === 'true') {
      return;
    }
    select.dataset.scheduleVetBound = 'true';
    select.addEventListener('change', handleVetChange);
  });
  dateField && dateField.addEventListener('change', handleVetChange);
  handleVetChange();

  if (scheduleCollapseEl && scheduleToggleBtn) {
    scheduleCollapseEl.addEventListener('shown.bs.collapse', () => {
      updateScheduleToggleAria();
      loadSchedule();
    });
    scheduleCollapseEl.addEventListener('hidden.bs.collapse', updateScheduleToggleAria);
    updateScheduleToggleAria();
  }

  if (newAppointmentCollapseEl && newAppointmentToggleBtn) {
    newAppointmentCollapseEl.addEventListener('shown.bs.collapse', updateNewAppointmentToggleAria);
    newAppointmentCollapseEl.addEventListener('hidden.bs.collapse', updateNewAppointmentToggleAria);
    updateNewAppointmentToggleAria();
  }

  if (newAppointmentForm) {
    ensureNewAppointmentVisible();
  }
});
</script>
{% endblock %}
