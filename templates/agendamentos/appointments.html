{% extends "layout.html" %}

{% block main %}
<div class="container py-4">

  <!-- Cabeçalho -->
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
    <h2 class="fw-bold text-gradient mb-0">
      <i class="bi bi-calendar4-week me-2"></i> Agenda de Consultas
    </h2>
    {% if current_user.role == 'admin' %}
    <div class="w-100 ms-lg-auto">
      {% set switcher_select_id = 'admin-agenda-user-picker' %}
      {% set switcher_label_text = 'Selecionar usuário' %}
      {% set switcher_select_classes = 'form-select w-100' %}
      {% set switcher_form_classes = 'd-flex align-items-center gap-2 w-100' %}
      {% set switcher_default_option_label = 'Minha agenda' %}
      {% include 'partials/admin_agenda_switcher.html' %}
    </div>
    {% endif %}
  </div>

  {% set calendar_redirect_url = none %}
  {% if not form %}
    {% if current_user.role == 'admin' %}
      {% set calendar_redirect_url = url_for('appointments', view_as='colaborador') %}
    {% else %}
      {% set calendar_redirect_url = url_for('appointments_calendar') %}
    {% endif %}
  {% endif %}
  {% with clinic_id = current_user.clinica_id, calendar_redirect_url = calendar_redirect_url %}
    {% include 'partials/schedule_toggle.html' %}
  {% endwith %}

  {% if not form %}
  <div class="mb-4">
    <a href="{{ url_for('appointments_calendar') }}" class="btn btn-outline-primary">
      Visualizar nova agenda
    </a>
  </div>
  {% endif %}

  <!-- Gerenciar horários (novo + editar) -->
  <div class="card border-0 shadow-lg rounded-4 mb-5">
    <div class="card-header bg-primary text-white rounded-top-4 d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i> Gerenciar Horários</h5>
      <div>
        <button id="openScheduleModal" class="btn btn-light btn-sm me-2" type="button">
          <i class="bi bi-pencil"></i> Editar Horário
        </button>
        <button class="btn btn-success btn-sm" data-bs-toggle="collapse" data-bs-target="#newAppointmentForm">
          <i class="bi bi-plus-circle"></i> Nova Consulta
        </button>
      </div>
    </div>

    <div class="collapse" id="newAppointmentForm">
      <div class="card-body p-4">
        {% if form %}
        <form method="POST">
          {{ form.hidden_tag() }}
          <div class="row g-3">
            <div class="col-md-6">
              {{ form.animal_id.label(class="form-label fw-semibold") }}
              {{ form.animal_id(class="form-select") }}
            </div>
            <div class="col-md-6">
              {{ form.veterinario_id.label(class="form-label fw-semibold") }}
              {{ form.veterinario_id(class="form-select") }}
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-6">
              {{ form.date.label(class="form-label fw-semibold") }}
              {{ form.date(class="form-control", type="date") }}
            </div>
            <div class="col-md-6">
              {{ form.time.label(class="form-label fw-semibold") }}
              <select
                id="{{ form.time.id }}"
                name="{{ form.time.name }}"
                class="form-select"
                data-placeholder="Selecione um horário"
                data-empty-text="Sem horários disponíveis"
                data-current-time="{{ form.time.data.strftime('%H:%M') if form.time.data else '' }}"
                {% if form.time.flags.required %}required{% endif %}
              >
                {% if form.time.data %}
                  {% set current_time = form.time.data.strftime('%H:%M') %}
                  <option value="{{ current_time }}" selected>{{ current_time }}</option>
                {% else %}
                  <option value="" selected disabled>Selecione um horário</option>
                {% endif %}
              </select>
            </div>
          </div>

          <div class="mt-3">
            {{ form.kind.label(class="form-label fw-semibold") }}
            {{ form.kind(class="form-select") }}
          </div>

          <div class="mt-3">
            {{ form.reason.label(class="form-label fw-semibold") }}
            {{ form.reason(class="form-control", rows=3, placeholder="Motivo da consulta...") }}
          </div>

          <div class="d-grid mt-4">
            {{ form.submit(class="btn btn-success btn-lg rounded-pill") }}
          </div>
        </form>
        <div class="mt-4">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
            <h6 class="fw-bold mb-0">
              <i class="bi bi-calendar3 me-2"></i>Disponibilidade do Veterinário
            </h6>
            <button
              class="btn btn-outline-primary btn-sm"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#scheduleOverviewCollapse"
              aria-expanded="true"
              aria-controls="scheduleOverviewCollapse"
            >
              Alternar visualização
            </button>
          </div>
          <div class="collapse show" id="scheduleOverviewCollapse">
            <div id="schedule-overview" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 small"></div>
            <div class="mt-2 small">
              <span class="badge bg-success me-1">&nbsp;</span> Disponível
              <span class="badge bg-danger ms-2 me-1">&nbsp;</span> Indisponível
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Filtro colapsável -->
  <button class="btn btn-outline-secondary btn-sm mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#filterPeriod">
    <i class="bi bi-funnel"></i> Filtrar Período
  </button>
  <div class="collapse mb-4" id="filterPeriod">
    <div class="card card-body">
      <form method="get" action="{{ url_for('appointments') }}">
        {% for key, values in request.args.lists() %}
          {% if key not in ['start', 'end', 'partial'] %}
            {% for value in values %}
              <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endfor %}
          {% endif %}
        {% endfor %}
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="appointments-filter-start">De</label>
            <input
              type="date"
              id="appointments-filter-start"
              name="start"
              class="form-control"
              value="{{ request.args.get('start', '') }}"
            >
          </div>
          <div class="col-md-6">
            <label class="form-label" for="appointments-filter-end">Até</label>
            <input
              type="date"
              id="appointments-filter-end"
              name="end"
              class="form-control"
              value="{{ request.args.get('end', '') }}"
            >
          </div>
        </div>
        <div class="d-flex justify-content-end mt-3">
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-check2-circle"></i> Aplicar Filtro
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de Agendamentos -->
  <h5 class="fw-bold mb-3"><i class="bi bi-list-check me-2"></i> Consultas Agendadas</h5>
  <div id="appointmentsList" data-appointments-container data-refresh-url="{{ request.url }}">
    {% include 'partials/appointments_table.html' %}
  </div>

  <!-- Agenda de Exames -->
  <h5 class="fw-bold mt-5 mb-3"><i class="bi bi-flask me-2"></i> Agenda de Exames</h5>
  {% include 'partials/exam_appointments_table.html' %}

  <!-- Agenda de Vacinas -->
  <h5 class="fw-bold mt-5 mb-3"><i class="bi bi-syringe me-2"></i> Agenda de Vacinas</h5>
  {% include 'partials/vaccine_appointments_table.html' %}

</div>

<!-- Modal Editar Horário do Colaborador -->
<div class="modal fade" id="scheduleEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-clock-history me-2"></i>Editar Horário</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="schedule-edit-form">
          <div class="mb-3">
            <label class="form-label fw-semibold">Colaborador</label>
            <select id="schedule-vet" class="form-select"></select>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Dia da Semana</label>
              <select id="schedule-day" class="form-select">
                <option value="Segunda">Segunda</option>
                <option value="Terça">Terça</option>
                <option value="Quarta">Quarta</option>
                <option value="Quinta">Quinta</option>
                <option value="Sexta">Sexta</option>
                <option value="Sábado">Sábado</option>
                <option value="Domingo">Domingo</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-semibold">Início</label>
              <input type="time" id="schedule-start" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label fw-semibold">Fim</label>
              <input type="time" id="schedule-end" class="form-control">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" form="schedule-edit-form" class="btn btn-primary">Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Consulta -->
<div class="modal fade" id="appointmentEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-pencil-square me-2"></i> Editar Consulta
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="text-center text-muted">
          <i class="bi bi-hourglass-split fs-2 d-block mb-2"></i>
          Carregando...
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='appointments_table.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const vetField = {% if form %}document.getElementById('{{ form.veterinario_id.id }}'){% else %}null{% endif %};
  const dateField = {% if form %}document.getElementById('{{ form.date.id }}'){% else %}null{% endif %};
  const timeField = {% if form %}document.getElementById('{{ form.time.id }}'){% else %}null{% endif %};
  const kindField = {% if form %}document.getElementById('{{ form.kind.id }}'){% else %}null{% endif %};
  const timeFieldPlaceholder = timeField && timeField.dataset && timeField.dataset.placeholder
    ? timeField.dataset.placeholder
    : 'Selecione um horário';
  const timeFieldEmptyText = timeField && timeField.dataset && timeField.dataset.emptyText
    ? timeField.dataset.emptyText
    : 'Sem horários disponíveis';
  const timeFieldLoadingText = 'Carregando horários disponíveis...';
  const scheduleContainer = document.getElementById('schedule-overview');
  const scheduleCollapseEl = document.getElementById('scheduleOverviewCollapse');
  const scheduleToggleBtn = document.querySelector('[data-bs-target="#scheduleOverviewCollapse"]');
  const calendarContainer = document.querySelector('[data-calendar-redirect-url]');
  const calendarRedirectUrl = (calendarContainer && calendarContainer.dataset && calendarContainer.dataset.calendarRedirectUrl) || '';
  const newAppointmentCollapseEl = document.getElementById('newAppointmentForm');
  const newAppointmentToggleBtn = document.querySelector('[data-bs-target="#newAppointmentForm"]');
  const newAppointmentForm = newAppointmentCollapseEl
    ? newAppointmentCollapseEl.querySelector('form')
    : null;
  let newAppointmentCollapseInstance = null;
  let timesAbortController = null;
  let scheduleAbortController = null;

  function updateNewAppointmentToggleAria() {
    if (!newAppointmentCollapseEl || !newAppointmentToggleBtn) {
      return;
    }
    const isShown = newAppointmentCollapseEl.classList.contains('show');
    newAppointmentToggleBtn.setAttribute('aria-expanded', isShown ? 'true' : 'false');
  }

  function updateScheduleToggleAria() {
    if (!scheduleCollapseEl || !scheduleToggleBtn) {
      return;
    }
    const isShown = scheduleCollapseEl.classList.contains('show');
    scheduleToggleBtn.setAttribute('aria-expanded', isShown ? 'true' : 'false');
  }

  function ensureNewAppointmentVisible() {
    if (!newAppointmentCollapseEl || !window.bootstrap || !bootstrap.Collapse) {
      return;
    }
    if (!newAppointmentCollapseInstance) {
      newAppointmentCollapseInstance = bootstrap.Collapse.getOrCreateInstance(
        newAppointmentCollapseEl,
        { toggle: false }
      );
    }
    if (!newAppointmentCollapseEl.classList.contains('show')) {
      newAppointmentCollapseInstance.show();
    }
    if (newAppointmentToggleBtn) {
      newAppointmentToggleBtn.setAttribute('aria-expanded', 'true');
    }
    updateNewAppointmentToggleAria();
  }

  function focusFirstAppointmentField() {
    if (!newAppointmentCollapseEl) {
      return;
    }
    const firstField = newAppointmentCollapseEl.querySelector('input, select, textarea');
    if (!firstField) {
      return;
    }
    window.setTimeout(() => {
      firstField.focus({ preventScroll: false });
    }, 150);
  }

  function setTimeFieldMessage(message, { disable = false } = {}) {
    if (!timeField) {
      return;
    }
    timeField.innerHTML = '';
    const option = document.createElement('option');
    option.value = '';
    option.textContent = message;
    option.disabled = true;
    option.selected = true;
    timeField.appendChild(option);
    timeField.disabled = disable;
    timeField.value = '';
    timeField.dataset.currentTime = '';
  }

  function populateTimeFieldOptions(times) {
    if (!timeField) {
      return;
    }
    const currentTime = timeField.dataset.currentTime || timeField.value || '';
    timeField.innerHTML = '';

    const placeholderOption = document.createElement('option');
    placeholderOption.value = '';
    placeholderOption.textContent = timeFieldPlaceholder;
    placeholderOption.disabled = true;
    placeholderOption.selected = !currentTime;
    timeField.appendChild(placeholderOption);

    let hasCurrentTime = false;
    times.forEach(t => {
      const option = document.createElement('option');
      option.value = t;
      option.textContent = t;
      if (currentTime === t) {
        option.selected = true;
        placeholderOption.selected = false;
        hasCurrentTime = true;
      }
      timeField.appendChild(option);
    });

    if (currentTime && !hasCurrentTime) {
      const preservedOption = document.createElement('option');
      preservedOption.value = currentTime;
      preservedOption.textContent = currentTime;
      preservedOption.selected = true;
      timeField.appendChild(preservedOption);
    }

    timeField.disabled = false;
    timeField.dataset.currentTime = timeField.value;
  }

  async function updateTimes() {
    if (!vetField || !dateField || !timeField) return;
    const vetId = vetField.value;
    const date = dateField.value;

    if (!vetId || !date) {
      if (timesAbortController) {
        timesAbortController.abort();
        timesAbortController = null;
      }
      setTimeFieldMessage(timeFieldPlaceholder, { disable: true });
      return;
    }

    if (timesAbortController) {
      timesAbortController.abort();
    }
    timesAbortController = new AbortController();
    const { signal } = timesAbortController;
    setTimeFieldMessage(timeFieldLoadingText, { disable: true });

    const params = new URLSearchParams({ date });
    if (kindField && kindField.value) {
      params.set('kind', kindField.value);
    }

    try {
      const resp = await fetch(`/api/specialist/${vetId}/available_times?${params.toString()}`, { signal });
      if (!resp.ok) {
        throw new Error('Erro ao carregar horários disponíveis');
      }
      const times = await resp.json();
      if (signal.aborted) {
        return;
      }
      if (!Array.isArray(times) || times.length === 0) {
        setTimeFieldMessage(timeFieldEmptyText, { disable: true });
        return;
      }
      populateTimeFieldOptions(times);
    } catch (error) {
      if (error.name === 'AbortError') {
        return;
      }
      console.error(error);
      setTimeFieldMessage(timeFieldEmptyText, { disable: true });
    } finally {
      if (timesAbortController && timesAbortController.signal === signal) {
        timesAbortController = null;
      }
    }
  }

  function badge(text, cls) {
    const span = document.createElement('span');
    span.className = `badge ${cls} me-1 mb-1`;
    span.textContent = text;
    return span;
  }

  function showScheduleMessage(text, className = 'text-muted small text-center py-3') {
    if (!scheduleContainer) {
      return;
    }
    scheduleContainer.innerHTML = '';
    const col = document.createElement('div');
    col.className = 'col';
    const message = document.createElement('div');
    message.className = className;
    message.textContent = text;
    col.appendChild(message);
    scheduleContainer.appendChild(col);
  }

  async function loadSchedule() {
    if (!vetField || !scheduleContainer) return;
    const vetId = vetField.value;
    if (!vetId) {
      if (scheduleAbortController) {
        scheduleAbortController.abort();
        scheduleAbortController = null;
      }
      scheduleContainer.innerHTML = '';
      return;
    }

    const start = dateField && dateField.value ? dateField.value : new Date().toISOString().split('T')[0];
    if (scheduleAbortController) {
      scheduleAbortController.abort();
    }
    scheduleAbortController = new AbortController();
    const { signal } = scheduleAbortController;

    showScheduleMessage('Carregando disponibilidade...', 'text-muted small text-center py-3');

    try {
      const params = new URLSearchParams({ start });
      const resp = await fetch(`/api/specialist/${vetId}/weekly_schedule?${params.toString()}`, { signal });
      if (!resp.ok) {
        throw new Error('Erro ao carregar disponibilidade do veterinário');
      }
      const days = await resp.json();
      if (signal.aborted) {
        return;
      }
      scheduleContainer.innerHTML = '';
      if (!Array.isArray(days) || days.length === 0) {
        showScheduleMessage('Nenhuma disponibilidade encontrada.', 'text-muted small text-center py-3');
        return;
      }
      days.forEach(day => {
        const col = document.createElement('div');
        col.className = 'col';
        const card = document.createElement('div');
        const hasAvailability = Array.isArray(day.available) && day.available.length > 0;
        const cardClass = hasAvailability ? 'border-success' : 'border-danger';
        card.className = `card h-100 ${cardClass}`;
        const body = document.createElement('div');
        body.className = 'card-body';
        const title = document.createElement('h6');
        title.className = 'card-title fw-bold';
        let displayDate = '';
        if (day.date) {
          const parsed = new Date(day.date);
          if (!Number.isNaN(parsed.valueOf())) {
            displayDate = parsed.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' });
          }
        }
        title.textContent = displayDate || day.date || '';
        body.appendChild(title);
        const slots = document.createElement('div');
        (Array.isArray(day.available) ? day.available : []).forEach(t => slots.appendChild(badge(t, 'bg-success')));
        (Array.isArray(day.booked) ? day.booked : []).forEach(t => slots.appendChild(badge(t, 'bg-danger')));
        (Array.isArray(day.not_working) ? day.not_working : []).forEach(t => slots.appendChild(badge(t, 'bg-danger')));
        if (!slots.children.length) {
          const span = document.createElement('span');
          span.className = 'text-muted small';
          span.textContent = 'Folga';
          slots.appendChild(span);
        }
        body.appendChild(slots);
        card.appendChild(body);
        col.appendChild(card);
        scheduleContainer.appendChild(col);
      });
    } catch (error) {
      if (error.name === 'AbortError') {
        return;
      }
      console.error(error);
      showScheduleMessage('Não foi possível carregar a disponibilidade.', 'text-danger small text-center py-3');
    } finally {
      if (scheduleAbortController && scheduleAbortController.signal === signal) {
        scheduleAbortController = null;
      }
    }
  }

  function handleVetChange() {
    if (!vetField && !dateField && !timeField && !scheduleContainer) {
      return;
    }
    updateTimes();
    loadSchedule();
  }

  window.handleVetChange = handleVetChange;

  const scheduleBtn = document.getElementById('openScheduleModal');
  const scheduleModalEl = document.getElementById('scheduleEditModal');
  if (scheduleBtn && scheduleModalEl) {
    const scheduleModal = new bootstrap.Modal(scheduleModalEl);
    scheduleBtn.addEventListener('click', () => {
      const vetSelectSrc = vetField;
      const vetSelect = document.getElementById('schedule-vet');
      if (vetSelectSrc && vetSelect) {
        vetSelect.innerHTML = vetSelectSrc.innerHTML;
        vetSelect.value = vetSelectSrc.value;
      }
      handleVetChange();
      scheduleModal.show();
    });
  }

  document.addEventListener('calendarSlotChosen', event => {
    const detail = event.detail || {};
    if (!detail.date) {
      return;
    }
    if (!dateField) {
      if (calendarRedirectUrl) {
        const targetUrl = new URL(calendarRedirectUrl, window.location.origin);
        targetUrl.searchParams.set('date', detail.date);
        if (detail.time) {
          targetUrl.searchParams.set('time', detail.time);
        }
        window.location.href = targetUrl.toString();
      }
      return;
    }

    ensureNewAppointmentVisible();

    dateField.value = detail.date;
    dateField.dispatchEvent(new Event('change', { bubbles: true }));

    if (timeField && detail.time) {
      timeField.value = detail.time;
      timeField.dataset.currentTime = detail.time;
      timeField.dispatchEvent(new Event('change', { bubbles: true }));
    }

    handleVetChange();

    focusFirstAppointmentField();
  });

  timeField && timeField.addEventListener('change', () => {
    timeField.dataset.currentTime = timeField.value;
  });

  if (kindField) {
    kindField.addEventListener('change', () => {
      if (timeField) {
        timeField.dataset.currentTime = '';
      }
      updateTimes();
    });
  }

  vetField && vetField.addEventListener('change', handleVetChange);
  dateField && dateField.addEventListener('change', handleVetChange);
  handleVetChange();

  if (scheduleCollapseEl && scheduleToggleBtn) {
    scheduleCollapseEl.addEventListener('shown.bs.collapse', () => {
      updateScheduleToggleAria();
      loadSchedule();
    });
    scheduleCollapseEl.addEventListener('hidden.bs.collapse', updateScheduleToggleAria);
    updateScheduleToggleAria();
  }

  if (newAppointmentCollapseEl && newAppointmentToggleBtn) {
    newAppointmentCollapseEl.addEventListener('shown.bs.collapse', updateNewAppointmentToggleAria);
    newAppointmentCollapseEl.addEventListener('hidden.bs.collapse', updateNewAppointmentToggleAria);
    updateNewAppointmentToggleAria();
  }

  if (newAppointmentForm) {
    ensureNewAppointmentVisible();
  }
});
</script>
{% endblock %}
