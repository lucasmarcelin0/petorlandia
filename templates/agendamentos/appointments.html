{% extends "layout.html" %}

{% block main %}
<section class="container py-4" aria-labelledby="appointments-calendar-title">

  <!-- Cabeçalho -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
      <h2 id="appointments-calendar-title" class="fw-bold text-gradient mb-0">
      <i class="bi bi-calendar4-week me-2"></i> Agenda de Consultas
    </h2>
    {% if current_user.role == 'admin' %}
    <div class="w-100 ms-lg-auto">
      {% set switcher_select_id = 'admin-agenda-user-picker' %}
      {% set switcher_label_text = 'Selecionar usuário' %}
      {% set switcher_select_classes = 'form-select w-100' %}
      {% set switcher_form_classes = 'd-flex align-items-center gap-2 w-100' %}
      {% set switcher_default_option_label = 'Minha agenda' %}
      {% include 'partials/admin_agenda_switcher.html' %}
    </div>
    {% endif %}
  </div>

  {% set calendar_redirect_url = none %}
  {% if not form %}
    {% if current_user.role == 'admin' %}
      {% set calendar_redirect_url = url_for('appointments', view_as='colaborador') %}
    {% else %}
      {% set calendar_redirect_url = url_for('appointments_calendar') %}
    {% endif %}
  {% endif %}
  <div class="row g-4 align-items-stretch mb-4" id="appointments-calendar-overview">
    <div class="col-12 col-xl-8 col-xxl-9" data-calendar-main-column>
      <ul
        class="nav nav-pills calendar-tabs mb-3"
        id="appointments-calendar-tabs"
        role="tablist"
        aria-label="Alternar entre o calendário e o agendamento"
      >
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="calendar-tab-experimental"
            data-bs-toggle="tab"
            data-bs-target="#calendar-pane-experimental"
            type="button"
            role="tab"
            aria-controls="calendar-pane-experimental"
            aria-selected="true"
          >
            <i class="bi bi-layout-text-window-reverse me-1"></i> Calendário
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="calendar-tab-full"
            data-bs-toggle="tab"
            data-bs-target="#calendar-pane-full"
            type="button"
            role="tab"
            aria-controls="calendar-pane-full"
            aria-selected="false"
          >
            <i class="bi bi-calendar3 me-1"></i> Agendamento
          </button>
        </li>
      </ul>

      <div class="tab-content mt-3" id="appointments-calendar-content">
        <div
          class="tab-pane fade calendar-tab-pane show active pt-2"
          id="calendar-pane-experimental"
          role="tabpanel"
          aria-labelledby="calendar-tab-experimental"
          tabindex="0"
        >
          {% set calendar_pets_endpoint = url_for('api_my_pets') %}
          {% if current_user.role == 'admin' or current_user.worker in ['veterinario', 'colaborador'] %}
            {% set calendar_pets_endpoint = url_for(
              'api_clinic_pets',
              view_as=request.args.get('view_as'),
              veterinario_id=request.args.get('veterinario_id'),
              colaborador_id=request.args.get('colaborador_id'),
              clinica_id=request.args.get('clinica_id')
            ) %}
          {% endif %}
          {% with component_id = 'tutor-calendar-inline', pets_url = calendar_pets_endpoint %}
            {% include 'partials/tutor_calendar.html' %}
          {% endwith %}
        </div>
        <div
          class="tab-pane fade calendar-tab-pane pt-2"
          id="calendar-pane-full"
          role="tabpanel"
          aria-labelledby="calendar-tab-full"
          tabindex="0"
        >
          {% with clinic_id = current_user.clinica_id, calendar_redirect_url = calendar_redirect_url %}
            {% include 'partials/schedule_toggle.html' %}
          {% endwith %}
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-4 col-xxl-3" data-calendar-summary-column>
      <div class="card calendar-summary-card border-0 shadow-sm h-100 is-loading" data-calendar-summary-panel>
        <div class="card-header bg-white border-0 pb-0">
          <div class="d-flex align-items-center justify-content-between gap-2">
            <h5 class="mb-0 fw-semibold">
              <i class="bi bi-people-fill me-2"></i> Resumo por profissional
            </h5>
            <span class="badge calendar-summary-total-badge" data-calendar-summary-total>0</span>
          </div>
          <p class="text-muted small mb-0">
            Totais diários e semanais por veterinário com base no calendário visível.
          </p>
        </div>
        <div class="card-body">
          <div
            class="calendar-summary-loading d-flex align-items-center gap-3 rounded-4 border border-dashed"
            data-calendar-summary-loading
            role="status"
            aria-live="polite"
          >
            <div class="spinner-border text-primary" role="presentation" aria-hidden="true"></div>
            <div>
              <p class="mb-0 fw-semibold text-primary">Atualizando estatísticas</p>
              <small class="text-muted">Aguarde enquanto buscamos as consultas desta visão.</small>
            </div>
          </div>
          <div class="calendar-summary-overview row g-3 mt-1" data-calendar-summary-overview hidden>
            <div class="col-12 col-sm-6">
              <div class="calendar-summary-overview-card is-today">
                <div class="calendar-summary-overview-icon" aria-hidden="true">
                  <i class="bi bi-brightness-alt-high-fill"></i>
                </div>
                <div class="calendar-summary-overview-body">
                  <span class="label">Hoje</span>
                  <strong class="value" data-calendar-summary-overview-today>0</strong>
                  <small class="description text-muted">Consultas previstas</small>
                </div>
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="calendar-summary-overview-card is-week">
                <div class="calendar-summary-overview-icon" aria-hidden="true">
                  <i class="bi bi-calendar-week"></i>
                </div>
                <div class="calendar-summary-overview-body">
                  <span class="label">Semana</span>
                  <strong class="value" data-calendar-summary-overview-week>0</strong>
                  <small class="description text-muted">Compromissos na semana</small>
                </div>
              </div>
            </div>
          </div>
          <div class="text-muted small mt-3" data-calendar-summary-empty aria-live="polite" role="status">
            Nenhum compromisso encontrado para o período atual.
          </div>
          <ul
            role="list"
            class="calendar-summary-list d-flex flex-column gap-3 mt-3"
            data-calendar-summary-list
          ></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Gerenciar horários (novo + editar) -->
  {% include 'partials/appointment_form_section.html' %}

  <div id="appointmentsList" data-appointments-container data-refresh-url="{{ request.url }}">
    {% include 'partials/appointments_table.html' %}
  </div>

</section>


{% include 'partials/appointment_form_modals.html' %}
{% endblock %}

{% block scripts %}
{% include 'partials/appointment_form_scripts.html' %}

{% endblock %}
