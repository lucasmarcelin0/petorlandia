{% extends "layout.html" %}

{% block main %}
  {% include "agendamentos/_vet_schedule_panel.html" %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('agenda-filter-form');
      if (!form) return;

      const startInput = form.querySelector('input[name="start"]');
      const endInput = form.querySelector('input[name="end"]');
      const quickButtons = form.querySelectorAll('[data-range]');
      const clearButton = form.querySelector('[data-action="clear-dates"]');

      if (!startInput || !endInput) return;

      const formatDate = (date) => {
        const offsetDate = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
        return offsetDate.toISOString().split('T')[0];
      };

      const submitForm = () => {
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else {
          form.submit();
        }
      };

      const applyRange = (range) => {
        const today = new Date();
        let startDate = new Date(today);
        let endDate = new Date(today);

        switch (range) {
          case 'today':
            break;
          case 'tomorrow':
            startDate.setDate(startDate.getDate() + 1);
            endDate = new Date(startDate);
            break;
          case 'week': {
            const day = startDate.getDay();
            const diff = day === 0 ? -6 : 1 - day;
            startDate.setDate(startDate.getDate() + diff);
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            break;
          }
          case 'next7':
            endDate.setDate(startDate.getDate() + 6);
            break;
          case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
          default:
            return;
        }

        startInput.value = formatDate(startDate);
        endInput.value = formatDate(endDate);
        submitForm();
      };

      quickButtons.forEach((button) => {
        button.addEventListener('click', () => applyRange(button.dataset.range));
      });

      if (clearButton) {
        clearButton.addEventListener('click', () => {
          startInput.value = '';
          endInput.value = '';
          submitForm();
        });
      }
    });
  </script>
  <script type="module" src="{{ url_for('static', filename='appointments_vet.js') }}"></script>
{% endblock %}
