{% extends "layout.html" %}

{% block main %}
<div class="container mt-4">
  <!-- Cabeçalho melhorado -->
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
    <div>
      <h2 class="mb-0"><i class="fas fa-calendar-alt me-2 text-primary"></i>Agenda – {{ veterinario.user.name }}</h2>
      <p class="text-muted">Gerencie seus horários e consultas</p>
    </div>
    <div class="ms-auto">
      {% if current_user.role == 'admin' and agenda_veterinarios %}
      <form action="{{ url_for('appointments') }}" method="get" class="d-flex align-items-center justify-content-end gap-2 mb-2 flex-wrap">
        <input type="hidden" name="view_as" value="veterinario">
        {% set start_arg = request.args.get('start') %}
        {% if start_arg %}
        <input type="hidden" name="start" value="{{ start_arg }}">
        {% endif %}
        {% set end_arg = request.args.get('end') %}
        {% if end_arg %}
        <input type="hidden" name="end" value="{{ end_arg }}">
        {% endif %}
        <label for="vet-agenda-picker" class="form-label fw-semibold small mb-0">Pesquisar agenda</label>
        <select id="vet-agenda-picker" name="veterinario_id" class="form-select form-select-sm text-truncate" onchange="this.form.submit()" style="min-width: 220px;">
          <option value="" {% if not veterinario %}selected{% endif %}>Selecione um usuário</option>
          {% for vet in agenda_veterinarios %}
          <option value="{{ vet.id }}" {% if vet.id == veterinario.id %}selected{% endif %}>{{ vet.user.name }}{% if vet.user.email %} – {{ vet.user.email }}{% endif %}</option>
          {% endfor %}
        </select>
      </form>
      {% endif %}
      <div class="d-flex flex-wrap justify-content-end gap-2">
        <button class="btn btn-primary mb-1" onclick="toggleScheduleForm()">
          <i class="fas fa-plus-circle me-1"></i>Adicionar Horário
        </button>
        <button class="btn btn-outline-primary mb-1" onclick="toggleAppointmentForm()">
          <i class="fas fa-calendar-plus me-1"></i>Agendar Consulta
        </button>
      </div>
    </div>
  </div>

  <!-- Filtros com design melhorado -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtrar Agenda</h5>
    </div>
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label fw-bold">Data Inicial</label>
          <input type="date" name="start" value="{{ start_dt.date() }}" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Data Final</label>
          <input type="date" name="end" value="{{ (end_dt - timedelta(days=1)).date() }}" class="form-control">
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100">
            <i class="fas fa-search me-1"></i>Aplicar Filtro
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Formulário de Horário (modal) -->
  <div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="scheduleModalTitle">Adicionar Horário</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form method="post" id="schedule-form">
            {{ schedule_form.hidden_tag() }}
            <div class="mb-3">
              {{ schedule_form.veterinario_id.label(class="form-label fw-bold") }}
              {{ schedule_form.veterinario_id(class="form-select") }}
            </div>
            <div class="mb-3">
              {{ schedule_form.dias_semana.label(class="form-label fw-bold") }}
              {{ schedule_form.dias_semana(class="form-select", multiple=True, size=7) }}
              <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('all')">Todos</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('weekday')">Dias Úteis</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('weekend')">Fins de Semana</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('clear')">Limpar</button>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                {{ schedule_form.hora_inicio.label(class="form-label fw-bold") }}
                {{ schedule_form.hora_inicio(class="form-control") }}
              </div>
              <div class="col-md-6 mb-3">
                {{ schedule_form.hora_fim.label(class="form-label fw-bold") }}
                {{ schedule_form.hora_fim(class="form-control") }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                {{ schedule_form.intervalo_inicio.label(class="form-label fw-bold") }}
                {{ schedule_form.intervalo_inicio(class="form-control") }}
              </div>
              <div class="col-md-6 mb-3">
                {{ schedule_form.intervalo_fim.label(class="form-label fw-bold") }}
                {{ schedule_form.intervalo_fim(class="form-control") }}
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit"
                  form="schedule-form"
                  class="btn btn-primary"
                  name="{{ schedule_form.submit.name }}"
                  value="Salvar Horário">Salvar Horário</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulário de Agendamento (modal) -->
  <div class="modal fade" id="appointmentModalForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Agendar Consulta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form method="post" id="appointment-form">
            {{ appointment_form.hidden_tag() }}
            <div class="mb-3">
              {{ appointment_form.animal_id.label(class="form-label fw-bold") }}
              {{ appointment_form.animal_id(class="form-select") }}
            </div>
            <div class="mb-3 d-none">
              {{ appointment_form.veterinario_id.label(class="form-label") }}
              {{ appointment_form.veterinario_id(class="form-select") }}
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                {{ appointment_form.date.label(class="form-label fw-bold") }}
                {{ appointment_form.date(class="form-control", type="date", id="appointment-date") }}
              </div>
              <div class="col-md-6 mb-3">
                {{ appointment_form.time.label(class="form-label fw-bold") }}
                <select id="appointment-time" name="time" class="form-select">
                  <option value="">Selecione...</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              {{ appointment_form.kind.label(class="form-label fw-bold") }}
              {{ appointment_form.kind(class="form-select") }}
            </div>
            <div class="mb-3">
              {{ appointment_form.reason.label(class="form-label fw-bold") }}
              {{ appointment_form.reason(class="form-control", rows=3) }}
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="appointment-form" class="btn btn-primary">Agendar Consulta</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Seção de Agendamentos Pendentes -->
  <div class="card mb-4 border-warning">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Agendamentos Pendentes</h5>
    </div>
    <div class="card-body p-0">
      <div class="list-group list-group-flush">
        {% for item in appointments_pending %}
          {% set appt = item.appt %}
          {% set can_respond = appt.time_left.total_seconds() > 0 %}
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <i class="fas fa-clock {% if can_respond %}text-warning{% else %}text-secondary{% endif %} fa-2x"></i>
              </div>
              <div>
                <h6 class="mb-0">{{ appt.scheduled_at|format_datetime_brazil('%d/%m/%Y %H:%M') }} - {{ appt.animal.name }}</h6>
                <small class="text-muted">{{ appt.tutor.name if item.kind=='consulta' else appt.animal.owner.name }}{% if item.kind == 'exame' %} <span class="badge bg-info ms-1">Exame</span>{% endif %}</small>
                <div class="mt-1">
                  {% if can_respond %}
                    <small class="text-muted"><i class="fas fa-hourglass-half me-1"></i>Tempo restante: {{ appt.time_left|format_timedelta }}</small>
                  {% else %}
                    <small class="text-muted"><i class="fas fa-exclamation-circle me-1"></i>Prazo expirado</small>
                  {% endif %}
                </div>
              </div>
            </div>
            {% if can_respond %}
              <div class="d-flex gap-2">
                {% if item.kind == 'consulta' %}
                <form method="POST" action="{{ url_for('update_appointment_status', appointment_id=appt.id) }}">
                  <input type="hidden" name="status" value="accepted">
                  <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-check me-1"></i>Aceitar</button>
                </form>
                <form method="POST" action="{{ url_for('update_appointment_status', appointment_id=appt.id) }}">
                  <input type="hidden" name="status" value="canceled">
                  <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-times me-1"></i>Recusar</button>
                </form>
                {% else %}
                <button type="button" class="btn btn-success btn-sm" onclick="responderAgendamentoExame({{ appt.id }}, 'confirmed')">
                  <i class="fas fa-check me-1"></i>Aceitar
                </button>
                <button type="button" class="btn btn-danger btn-sm" onclick="responderAgendamentoExame({{ appt.id }}, 'canceled')">
                  <i class="fas fa-times me-1"></i>Recusar
                </button>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% else %}
          <div class="list-group-item text-center py-4">
            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">Não há agendamentos pendentes.</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Seção de Próximos Agendamentos -->
  <div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Próximos Agendamentos</h5>
    </div>
    <div class="card-body p-0">
      <div class="list-group list-group-flush">
        {% for item in appointments_upcoming %}
          {% set appt = item.appt %}
          {% if item.kind == 'exame' %}
          <div class="list-group-item list-group-item-action appointment-item" data-type="exame">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i class="fas fa-flask fa-2x text-info"></i>
                </div>
                <div>
                  <h6 class="mb-0">{{ appt.scheduled_at|format_datetime_brazil('%d/%m/%Y %H:%M') }} - {{ appt.animal.name }}</h6>
                  <small class="text-muted">{{ appt.animal.owner.name }} <span class="badge bg-info ms-1">Exame</span></small>
                </div>
              </div>
              <div class="btn-group">
                <a href="{{ url_for('ficha_animal', animal_id=appt.animal_id) }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-file-medical me-1"></i>Ficha</a>
                <a href="{{ url_for('ficha_tutor', tutor_id=appt.animal.owner.id) }}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-user me-1"></i>Tutor</a>
              </div>
            </div>
          </div>
          {% else %}
          <div class="list-group-item list-group-item-action appointment-item"
              data-id="{{ appt.id }}"
              data-date="{{ appt.scheduled_at|format_datetime_brazil('%Y-%m-%d') }}"
              data-time="{{ appt.scheduled_at|format_datetime_brazil('%H:%M') }}"
              data-vet="{{ appt.veterinario.user.name }}"
              data-tutor="{{ appt.tutor.name }}"
              data-tutor-id="{{ appt.tutor_id }}"
              data-animal="{{ appt.animal.name }}"
              data-animal-id="{{ appt.animal_id }}"
              data-animal-url="{{ url_for('ficha_animal', animal_id=appt.animal_id) }}"
              data-tutor-url="{{ url_for('ficha_tutor', tutor_id=appt.tutor_id) }}"
              data-consulta-url="{{ url_for('consulta_direct', animal_id=appt.animal_id) }}"
              data-notes="{{ appt.notes or '' }}"
              data-type="{{ item.kind }}">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i class="fas fa-stethoscope fa-2x text-success"></i>
                </div>
                <div>
                  <h6 class="mb-0">{{ appt.scheduled_at|format_datetime_brazil('%d/%m/%Y %H:%M') }} - {{ appt.animal.name }}</h6>
                  <small class="text-muted">{{ appt.tutor.name }}
                    {% if item.kind == 'retorno' %}<span class="badge bg-warning text-dark ms-1">Retorno</span>{% endif %}
                  </small>
                </div>
              </div>
              <div class="btn-group">
                <a href="{{ url_for('ficha_animal', animal_id=appt.animal_id) }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-file-medical me-1"></i>Ficha</a>
                <a href="{{ url_for('ficha_tutor', tutor_id=appt.tutor_id) }}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-user me-1"></i>Tutor</a>
                <a href="{{ url_for('consulta_direct', animal_id=appt.animal_id) }}" class="btn btn-sm btn-outline-success"><i class="fas fa-play-circle me-1"></i>Iniciar</a>
              </div>
            </div>
          </div>
          {% endif %}
        {% else %}
          <div class="list-group-item text-center py-4">
            <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">Nenhum agendamento encontrado.</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Seção de Agendamentos Passados -->
  <div class="card mb-4 border-secondary">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-history me-2"></i>Agendamentos Passados</h5>
      <button id="toggle-past" class="btn btn-sm btn-light">
        <i class="fas fa-chevron-down me-1"></i>Mostrar
      </button>
    </div>
    <div class="card-body p-0 d-none" id="past-list">
      <div class="list-group list-group-flush">
        {% for appt in appointments_past %}
          <div class="list-group-item list-group-item-action appointment-item"
              data-id="{{ appt.id }}"
              data-date="{{ appt.scheduled_at|format_datetime_brazil('%Y-%m-%d') }}"
              data-time="{{ appt.scheduled_at|format_datetime_brazil('%H:%M') }}"
              data-vet="{{ appt.veterinario.user.name }}"
              data-tutor="{{ appt.tutor.name }}"
              data-tutor-id="{{ appt.tutor_id }}"
              data-animal="{{ appt.animal.name }}"
              data-animal-id="{{ appt.animal_id }}"
              data-animal-url="{{ url_for('ficha_animal', animal_id=appt.animal_id) }}"
              data-tutor-url="{{ url_for('ficha_tutor', tutor_id=appt.tutor_id) }}"
              data-consulta-url="{{ url_for('consulta_direct', animal_id=appt.animal_id) }}"
              data-notes="{{ appt.notes or '' }}">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <i class="fas fa-history fa-2x text-secondary"></i>
                </div>
                <div>
                  <h6 class="mb-0">{{ appt.scheduled_at|format_datetime_brazil('%d/%m/%Y %H:%M') }} - {{ appt.animal.name }}</h6>
                  <small class="text-muted">{{ appt.tutor.name }}</small>
                </div>
              </div>
              <div class="btn-group">
                <a href="{{ url_for('ficha_animal', animal_id=appt.animal_id) }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-file-medical me-1"></i>Ficha</a>
                <a href="{{ url_for('ficha_tutor', tutor_id=appt.tutor_id) }}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-user me-1"></i>Tutor</a>
                <a href="{{ url_for('consulta_direct', animal_id=appt.animal_id) }}" class="btn btn-sm btn-outline-success"><i class="fas fa-play-circle me-1"></i>Iniciar</a>
              </div>
            </div>
          </div>
        {% else %}
          <div class="list-group-item text-center py-4">
            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">Nenhum agendamento passado.</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Seção de Horários Cadastrados -->
  <div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-business-time me-2"></i>Horários Cadastrados</h5>
      <button class="btn btn-sm btn-outline-primary" onclick="toggleScheduleEdit()">
        <i class="fas fa-edit me-1"></i>Editar horários
      </button>
    </div>
    <div class="card-body">
      <div class="row">
        {% for grupo in horarios_grouped %}
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-header py-2">
                <h6 class="mb-0">{{ grupo.dia }}</h6>
              </div>
              <div class="card-body py-2">
                {% for h in grupo.itens %}
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                      <span class="badge bg-light text-dark">{{ h.hora_inicio.strftime('%H:%M') }} - {{ h.hora_fim.strftime('%H:%M') }}</span>
                      {% if h.intervalo_inicio and h.intervalo_fim %}
                        <small class="text-muted d-block">Intervalo: {{ h.intervalo_inicio.strftime('%H:%M') }} - {{ h.intervalo_fim.strftime('%H:%M') }}</small>
                      {% endif %}
                    </div>
                    <div class="schedule-actions d-none">
                      <button type="button" class="btn btn-sm btn-outline-primary edit-btn"
                              data-id="{{ h.id }}"
                              data-dia="{{ h.dia_semana }}"
                              data-hora-inicio="{{ h.hora_inicio.strftime('%H:%M') }}"
                              data-hora-fim="{{ h.hora_fim.strftime('%H:%M') }}"
                              data-intervalo-inicio="{{ h.intervalo_inicio.strftime('%H:%M') if h.intervalo_inicio else '' }}"
                              data-intervalo-fim="{{ h.intervalo_fim.strftime('%H:%M') if h.intervalo_fim else '' }}">
                        <i class="fas fa-edit"></i>
                      </button>
                      <form method="post" action="{{ url_for('delete_vet_schedule', veterinario_id=veterinario.id, horario_id=h.id) }}" class="d-inline">
                        {{ schedule_form.csrf_token }}
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Excluir este horário?');">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% else %}
          <div class="col-12 text-center py-4">
            <i class="fas fa-clock fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">Nenhum horário cadastrado.</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Modal de detalhes da consulta -->
  <div class="modal fade" id="appointmentDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Detalhes da Consulta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="modal-appt-id">
          <div class="mb-3">
            <label class="form-label fw-bold">Veterinário</label>
            <input type="text" class="form-control" id="modal-vet" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Tutor</label>
            <input type="text" class="form-control" id="modal-tutor" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Animal</label>
            <input type="text" class="form-control" id="modal-animal" readonly>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Data</label>
              <input type="date" class="form-control" id="modal-date">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Hora</label>
              <input type="time" class="form-control" id="modal-time">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Comentários</label>
            <textarea class="form-control" id="modal-notes" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <a id="modal-animal-link" class="btn btn-outline-primary" target="_blank"><i class="fas fa-file-medical me-1"></i>Ficha Animal</a>
          <a id="modal-tutor-link" class="btn btn-outline-secondary" target="_blank"><i class="fas fa-user me-1"></i>Ficha Tutor</a>
          <a id="modal-consulta-link" class="btn btn-outline-success" target="_blank"><i class="fas fa-play-circle me-1"></i>Iniciar Consulta</a>
          <button type="button" class="btn btn-primary" id="modal-save-btn">Salvar Alterações</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // Funções JavaScript para melhorar a interação
  function selectDays(mode) {
    const select = document.getElementById('schedule-dias_semana');
    const weekdays = ['Segunda','Terça','Quarta','Quinta','Sexta'];
    const weekend = ['Sábado','Domingo'];
    for (const opt of select.options) {
      if (mode === 'all') opt.selected = true;
      else if (mode === 'weekday') opt.selected = weekdays.includes(opt.value);
      else if (mode === 'weekend') opt.selected = weekend.includes(opt.value);
      else if (mode === 'clear') opt.selected = false;
    }
    select.dispatchEvent(new Event('change'));
  }

  function toggleScheduleForm() {
    const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    const title = document.getElementById('scheduleModalTitle');
    const form = document.getElementById('schedule-form');
    const select = document.getElementById('schedule-dias_semana');
    
    form.reset();
    document.getElementById('schedule-veterinario_id').value = '{{ veterinario.id }}';
    title.textContent = 'Adicionar Horário';
    form.action = "{{ url_for('appointments') }}";
    select.multiple = true;
    
    modal.show();
  }

  function editSchedule(data) {
    const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    const title = document.getElementById('scheduleModalTitle');
    const form = document.getElementById('schedule-form');
    const select = document.getElementById('schedule-dias_semana');
    
    form.reset();
    form.action = `/appointments/{{ veterinario.id }}/schedule/${data.id}/edit`;
    title.textContent = 'Editar Horário';
    select.multiple = false;
    [...select.options].forEach(opt => opt.selected = opt.value === data.dia);
    document.getElementById('schedule-hora_inicio').value = data.horaInicio;
    document.getElementById('schedule-hora_fim').value = data.horaFim;
    document.getElementById('schedule-intervalo_inicio').value = data.intervaloInicio;
    document.getElementById('schedule-intervalo_fim').value = data.intervaloFim;
    
    modal.show();
  }

  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      editSchedule(this.dataset);
    });
  });

  function toggleAppointmentForm() {
    const modal = new bootstrap.Modal(document.getElementById('appointmentModalForm'));
    modal.show();
    updateAppointmentTimes();
  }

  async function updateAppointmentTimes() {
    const date = document.getElementById('appointment-date').value;
    const select = document.getElementById('appointment-time');
    if (!date) {
      select.innerHTML = '<option value="">Selecione...</option>';
      return;
    }
    const resp = await fetch(`/api/specialist/{{ veterinario.id }}/available_times?date=${date}`);
    const times = await resp.json();
    select.innerHTML = '<option value="">Selecione...</option>';
    times.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      select.appendChild(opt);
    });
  }

  document.getElementById('appointment-date').addEventListener('change', updateAppointmentTimes);

  function toggleScheduleEdit() {
    document.querySelectorAll('.schedule-actions').forEach(el => {
      el.classList.toggle('d-none');
    });
    
    const btn = document.querySelector('[onclick="toggleScheduleEdit()"]');
    if (btn.querySelector('i').classList.contains('fa-edit')) {
      btn.innerHTML = '<i class="fas fa-times me-1"></i>Cancelar Edição';
    } else {
      btn.innerHTML = '<i class="fas fa-edit me-1"></i>Editar horários';
    }
  }

  async function responderAgendamentoExame(id, status) {
    const resp = await fetch(`/exam_appointment/${id}/status`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ status })
    });
    if (resp.ok) {
      const data = await resp.json();
      if (data.success) {
        location.reload();
      } else {
        alert(data.message || 'Erro ao atualizar status.');
      }
    } else {
      alert('Erro ao atualizar status.');
    }
  }

  // Modal de detalhes das consultas
  document.querySelectorAll('.appointment-item').forEach(item => {
    item.addEventListener('click', function(e) {
      if (e.target.closest('.btn')) return;
      document.getElementById('modal-appt-id').value = this.dataset.id;
      document.getElementById('modal-vet').value = this.dataset.vet;
      document.getElementById('modal-tutor').value = this.dataset.tutor;
      document.getElementById('modal-animal').value = this.dataset.animal;
      document.getElementById('modal-date').value = this.dataset.date;
      document.getElementById('modal-time').value = this.dataset.time;
      document.getElementById('modal-notes').value = this.dataset.notes || '';
      document.getElementById('modal-animal-link').href = this.dataset.animalUrl;
      document.getElementById('modal-tutor-link').href = this.dataset.tutorUrl;
      document.getElementById('modal-consulta-link').href = this.dataset.consultaUrl;
      
      const modal = new bootstrap.Modal(document.getElementById('appointmentDetailModal'));
      modal.show();
    });
  });

  document.getElementById('modal-save-btn').addEventListener('click', function() {
    const id = document.getElementById('modal-appt-id').value;
    const date = document.getElementById('modal-date').value;
    const time = document.getElementById('modal-time').value;
    const notes = document.getElementById('modal-notes').value;
    
    fetch(`/appointments/${id}/edit`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() if csrf_token is defined else '' }}'
      },
      body: JSON.stringify({
        date: date,
        time: time,
        veterinario_id: '{{ veterinario.id }}',
        notes: notes
      })
    }).then(r => r.json()).then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.message || 'Erro ao salvar');
      }
    }).catch(() => alert('Erro ao salvar'));
  });

  const toggleBtn = document.getElementById('toggle-past');
  const pastList = document.getElementById('past-list');
  if (toggleBtn && pastList) {
    toggleBtn.addEventListener('click', function(){
      pastList.classList.toggle('d-none');
      const icon = this.querySelector('i');
      if (pastList.classList.contains('d-none')) {
        this.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Mostrar';
      } else {
        this.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Ocultar';
      }
    });
  }

  // Adicionar animações de transição suave
  document.addEventListener('DOMContentLoaded', function() {
    // Adicionar classes de animação para os elementos
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';
      card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
      
      setTimeout(() => {
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, 100 + (index * 100));
    });
  });
</script>

<style>
  .appointment-item {
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .appointment-item:hover {
    background-color: #f8f9fa !important;
    transform: translateX(5px);
  }
  
  .btn {
    transition: all 0.2s ease;
  }
  
  .badge {
    font-size: 0.75em;
  }
  
  @media (max-width: 768px) {
    .btn-group .btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    
    .d-flex.align-items-center {
      flex-direction: column;
      align-items: flex-start !important;
    }
    
    .d-flex.align-items-center .me-3 {
      margin-right: 0 !important;
      margin-bottom: 0.5rem;
    }
  }
</style>
{% endblock %}