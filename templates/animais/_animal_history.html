<div>
  <div class="accordion" id="historicoAccordion" data-history-accordion>
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingPrescricoes">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrescricoes" aria-expanded="false" aria-controls="collapsePrescricoes">
          ğŸ’Š PrescriÃ§Ãµes
        </button>
      </h2>
      <div id="collapsePrescricoes" class="accordion-collapse collapse" aria-labelledby="headingPrescricoes" data-bs-parent="#historicoAccordion">
        <div class="accordion-body">
          {% if blocos_prescricao %}
            {% for bloco in blocos_prescricao[:3] %}
              <div class="card mb-2 shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <span class="text-dark">
                    {{ bloco.data_criacao|format_datetime_brazil('%d/%m/%Y') }} â€” {{ bloco.prescricoes | length }} medicaÃ§Ã£o(Ãµes)
                  </span>
                  {% if current_user.worker == 'veterinario' %}
                    <a href="{{ url_for('imprimir_bloco_prescricao', bloco_id=bloco.id) }}" class="btn btn-sm btn-outline-primary">ğŸ–¨ï¸ Imprimir</a>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
            {% if blocos_prescricao|length > 3 and 'historico_prescricoes' in current_app.view_functions %}
              <a href="{{ url_for('historico_prescricoes', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark">ğŸ” Ver todas</a>
            {% endif %}
          {% else %}
            <p class="text-muted">Nenhuma prescriÃ§Ã£o encontrada.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="accordion-item">
      <h2 class="accordion-header" id="headingExames">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExames" aria-expanded="false" aria-controls="collapseExames">
          ğŸ§ª Exames Solicitados
        </button>
      </h2>
      <div id="collapseExames" class="accordion-collapse collapse" aria-labelledby="headingExames" data-bs-parent="#historicoAccordion">
        <div class="accordion-body">
          {% if blocos_exames %}
            {% for bloco in blocos_exames[:3] %}
              <div class="card mb-2 shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <span class="text-dark">
                    {{ bloco.data_criacao|format_datetime_brazil('%d/%m/%Y') }} â€” {{ bloco.exames | length }} exame(s)
                  </span>
                  {% if current_user.worker == 'veterinario' %}
                    <a href="{{ url_for('imprimir_bloco_exames', bloco_id=bloco.id) }}" class="btn btn-sm btn-outline-primary">ğŸ–¨ï¸ Imprimir</a>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
            {% if blocos_exames|length > 3 and 'historico_exames' in current_app.view_functions %}
              <a href="{{ url_for('historico_exames', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark">ğŸ” Ver todas</a>
            {% endif %}
          {% else %}
            <p class="text-muted">Nenhum exame solicitado.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="accordion-item">
      <h2 class="accordion-header" id="headingConsultas">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConsultas" aria-expanded="false" aria-controls="collapseConsultas">
          ğŸ“… Consultas VeterinÃ¡rias
        </button>
      </h2>
      <div id="collapseConsultas" class="accordion-collapse collapse" aria-labelledby="headingConsultas" data-bs-parent="#historicoAccordion">
        <div class="accordion-body">
          {% if consultas %}
            <ul class="list-group mb-2">
              {% for c in consultas[:3] %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>{{ c.created_at|format_datetime_brazil('%d/%m/%Y') }}</span>
                  <span class="text-muted small">{{ c.veterinario.name if c.veterinario else 'Profissional nÃ£o informado' }}</span>
                </li>
              {% endfor %}
            </ul>
            {% if consultas|length > 3 and 'historico_consultas' in current_app.view_functions %}
              <a href="{{ url_for('historico_consultas', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark">ğŸ” Ver todas</a>
            {% endif %}
          {% else %}
            <p class="text-muted">Nenhuma consulta registrada.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="accordion-item">
      <h2 class="accordion-header" id="headingVacinas">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVacinas" aria-expanded="false" aria-controls="collapseVacinas">
          ğŸ’‰ Vacinas
        </button>
      </h2>
      <div id="collapseVacinas" class="accordion-collapse collapse" aria-labelledby="headingVacinas" data-bs-parent="#historicoAccordion">
        <div class="accordion-body">
          {% if proxima_vacina %}
            <div class="alert alert-info d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2">
              <div>
                <strong>ğŸ“… PrÃ³xima dose</strong>
                <div class="text-muted small">
                  {{ proxima_vacina.nome }}
                  {% if proxima_vacina.tipo %} â€” {{ proxima_vacina.tipo }}{% endif %}
                </div>
              </div>
              <span class="badge bg-primary">
                {{ proxima_vacina.aplicada_em|format_datetime_brazil('%d/%m/%Y') if proxima_vacina.aplicada_em else 'Data nÃ£o informada' }}
              </span>
            </div>
          {% else %}
            <p class="text-muted small mb-3">ğŸ“… PrÃ³xima dose: nenhuma agendada.</p>
          {% endif %}

          <h6 class="text-muted">ğŸ’‰ Doses Atrasadas</h6>
          {% if doses_atrasadas %}
            <ul class="list-group mb-2">
              {% for v in doses_atrasadas[:3] %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ v.nome }}</strong>
                    {% if v.aplicada_em %} â€” {{ v.aplicada_em|format_datetime_brazil('%d/%m/%Y') }}{% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">Nenhuma dose atrasada.</p>
          {% endif %}

          <h6 class="mt-3 text-muted">ğŸ’‰ Vacinas Aplicadas</h6>
          {% if vacinas_aplicadas %}
            <ul class="list-group mb-2">
              {% for v in vacinas_aplicadas[:3] %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ v.nome }}</strong> â€” {{ v.tipo or "Tipo nÃ£o informado" }} em {{ v.aplicada_em|format_datetime_brazil('%d/%m/%Y') if v.aplicada_em else 'Data nÃ£o registrada' }}
                    {% if v.observacoes %}
                      <br><em class="text-muted">Obs: {{ v.observacoes }}</em>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">Nenhuma vacina registrada.</p>
          {% endif %}

          {% if (vacinas_aplicadas|length > 3 or doses_atrasadas|length > 3) and 'historico_vacinas' in current_app.view_functions %}
            <a href="{{ url_for('historico_vacinas', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark">ğŸ” Ver todas</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
