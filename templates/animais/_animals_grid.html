{% if animals %}
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
  {% for animal in animals %}
    {% if modo != 'adotado' and animal.modo == 'adotado' and current_user.worker not in ['veterinario', 'colaborador'] %}
      {# pula esse animal #}
    {% else %}
      {# renderiza normalmente #}
      <div class="col" id="animal-card-{{ animal.id }}">
        <div class="card h-100 shadow-sm border-0 rounded-4 position-relative {% if animal.modo == 'perdido' %}border border-danger{% endif %} overflow-hidden">
          <div class="profile-card-media profile-card-media--animal" style="--offset-x: {{ animal.photo_offset_x or 0 }}px; --offset-y: {{ animal.photo_offset_y or 0 }}px; --rotation: {{ animal.photo_rotation or 0 }}deg; --zoom: {{ animal.photo_zoom or 1 }};">
            {% if animal.image %}
            <img src="{{ animal.image }}" class="profile-card-photo" loading="lazy" alt="Imagem de {{ animal.name }}">
            {% else %}
            <div class="profile-card-placeholder profile-card-placeholder--icon" aria-hidden="true">üêæ</div>
            {% endif %}
          </div>
          <div class="card-body d-flex flex-column gap-3 p-4">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="card-title mb-1">
                  <span data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="{{ animal.description }}" data-bs-placement="top">
                    {{ animal.name }}
                  </span>
                </h5>
                {% if animal.date_added %}
                <p class="text-muted small mb-0">Adicionado em {{ animal.date_added.strftime('%d/%m/%Y') }}</p>
                {% endif %}
              </div>
              {% if animal.modo == 'adotado' %}
              <span class="badge bg-success">Adotado</span>
              {% elif animal.modo == 'vendido' %}
              <span class="badge bg-secondary">Vendido</span>
              {% elif animal.modo == 'venda' %}
              <span class="badge bg-warning text-dark">√Ä venda</span>
              {% elif animal.modo == 'perdido' %}
              <span class="badge bg-danger">Perdido</span>
              {% else %}
              <span class="badge bg-info text-dark">Para ado√ß√£o</span>
              {% endif %}
            </div>

            {% if animal.modo == 'perdido' %}
            <div class="alert alert-danger small mb-0">
              ‚ö†Ô∏è Este animal foi marcado como <strong>PERDIDO</strong>.
              Se voc√™ viu ou sabe algo, por favor entre em contato com o tutor.
            </div>
            {% endif %}

            <ul class="list-unstyled profile-card-details mb-0">
              <li>
                <i class="fa-solid fa-paw"></i>
                <span>{{ animal.species }}</span>
              </li>
              {% if animal.breed %}
              <li>
                <i class="fa-solid fa-dna"></i>
                <span>{{ animal.breed }}</span>
              </li>
              {% endif %}
              {% if animal.age_display %}
              <li>
                <i class="fa-solid fa-hourglass-half"></i>
                <span>{{ animal.age_display }}</span>
              </li>
              {% endif %}
              {% if animal.sex %}
              <li>
                <i class="fa-solid fa-venus-mars"></i>
                <span>{{ animal.sex }}</span>
              </li>
              {% endif %}
              <li>
                <i class="fa-solid fa-tag"></i>
                <span>{{ animal.modo|capitalize }}</span>
              </li>
              {% if animal.modo == 'venda' and animal.price is not none %}
              <li>
                <i class="fa-solid fa-coins"></i>
                <span>R$ {{ "%.2f"|format(animal.price) }}</span>
              </li>
              {% endif %}
            </ul>

            {% if animal.modo in ['perdido', 'venda', 'doa√ß√£o'] and animal.description %}
            <div class="profile-card-divider"></div>
            <p class="small text-muted mb-0">
              <strong>üìå Informa√ß√µes:</strong>
              {{ animal.description }}
            </p>
            {% endif %}

            <div class="d-flex flex-wrap gap-2 mt-auto">
              {% if animal.modo == 'perdido' and animal.owner != current_user %}
              <a href="https://wa.me/55{{ animal.owner.phone | replace('(', '') | replace(')', '') | replace('-', '') | replace(' ', '') }}"
                 target="_blank"
                 class="btn btn-outline-danger btn-sm rounded-pill">
                 üìç Vi esse animal
              </a>
              {% elif animal.owner != current_user %}
              <a href="{{ url_for('conversa', animal_id=animal.id, user_id=animal.owner.id) }}"
                class="btn btn-outline-primary btn-sm rounded-pill">
                üí¨ Tenho Interesse
              </a>
              {% endif %}

              {% if current_user.worker in ['veterinario', 'colaborador'] or animal.owner == current_user %}
              <button class="btn btn-outline-success btn-sm rounded-pill" data-bs-toggle="modal"
                data-bs-target="#modalFicha{{ animal.id }}">
                üìã Ver Ficha
              </button>
              {% endif %}

              {% if animal.owner == current_user %}
              <a href="{{ url_for('editar_animal', animal_id=animal.id) }}"
                class="btn btn-outline-secondary btn-sm rounded-pill">
                ‚úèÔ∏è Editar
              </a>
              {% endif %}

              {% if is_admin %}
              <form method="POST" action="{{ url_for('deletar_animal', animal_id=animal.id) }}"
                    class="btn btn-outline-secondary btn-sm rounded-pill delete-animal-form"
                    data-animal-id="{{ animal.id }}">
                <button type="submit" title="Excluir">‚ùå</button>
              </form>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Modal Ficha -->
        <div class="modal fade" id="modalFicha{{ animal.id }}" tabindex="-1"
          aria-labelledby="fichaLabel{{ animal.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">
              <div class="modal-header">
                <h5 class="modal-title" id="fichaLabel{{ animal.id }}">Ficha de {{ animal.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body text-start">
                {% if animal.image %}
                <img src="{{ animal.image }}" class="img-fluid rounded mb-3" loading="lazy" alt="Imagem de {{ animal.name }}">
                {% endif %}
                <p><strong>Esp√©cie:</strong> {{ animal.species }}</p>
                <p><strong>Ra√ßa:</strong> {{ animal.breed }}</p>
                <p><strong>Idade:</strong> {{ animal.age_display }}</p>
                <p><strong>Sexo:</strong> {{ animal.sex }}</p>
                <p><strong>Modo:</strong> {{ animal.modo|capitalize }}</p>
                {% if animal.modo == 'venda' %}
                <p><strong>Pre√ßo:</strong> R$ {{ "%.2f"|format(animal.price) }}</p>
                {% endif %}
                <p><strong>Descri√ß√£o:</strong><br>{{ animal.description }}</p>

                {% if current_user.worker in ['veterinario', 'colaborador'] %}
                <hr>
                <p class="mb-1"><strong>Tutor:</strong> {{ animal.owner.name }}</p>
                <p class="mb-1"><strong>Email:</strong> {{ animal.owner.email }}</p>
                <p class="mb-3"><strong>Telefone:</strong> {{ animal.owner.phone }}</p>
                <a href="{{ url_for('consulta_direct', animal_id=animal.id) }}"
                  class="btn btn-outline-success rounded-pill w-100">
                  ü©∫ Iniciar Consulta
                </a>
                <a href="{{ url_for('ficha_animal', animal_id=animal.id) }}"
                  class="btn btn-outline-primary rounded-pill w-100 mb-2">
                  üìÑ Ficha do Animal
                </a>
                <a href="{{ url_for('ficha_tutor', tutor_id=animal.owner.id) }}"
                  class="btn btn-outline-secondary rounded-pill w-100">
                  üë§ Ficha do Tutor
                </a>
                {% endif %}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Fechar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endfor %}
</div>

{% if total_pages > 1 %}
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('list_animals', modo=modo, page=page-1) }}" data-page="{{ page - 1 }}" aria-label="Anterior">
        <span aria-hidden="true">&laquo; Anterior</span>
      </a>
    </li>

    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('list_animals', modo=modo, page=p) }}" data-page="{{ p }}">{{ p }}</a>
    </li>
    {% endfor %}

    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('list_animals', modo=modo, page=page+1) }}" data-page="{{ page + 1 }}" aria-label="Pr√≥xima">
        <span aria-hidden="true">Pr√≥xima &raquo;</span>
      </a>
    </li>
  </ul>
</nav>
{% endif %}
{% else %}
<p class="mt-3 text-center">Nenhum animal encontrado com esse filtro.</p>
{% endif %}
