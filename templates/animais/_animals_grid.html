{% if animals %}
{% macro species_avatar_icon(token) %}
  {% if token == 'dog' %}
  <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
    <circle cx="18" cy="20" r="8" />
    <circle cx="46" cy="20" r="8" />
    <circle cx="18" cy="36" r="7" />
    <circle cx="46" cy="36" r="7" />
    <path d="M20 44c0-6.6 5.4-12 12-12s12 5.4 12 12v5c0 5-4 9-9 9h-6c-5 0-9-4-9-9z" />
  </svg>
  {% elif token == 'cat' %}
  <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
    <path d="M8 28v-14l12-8 6 16h12l6-16 12 8v14c0 12-9 22-22 22S8 40 8 28z" />
    <circle cx="26" cy="30" r="4" />
    <circle cx="38" cy="30" r="4" />
    <path d="M24 42c4 3 12 3 16 0" stroke-width="4" stroke-linecap="round" stroke="currentColor" fill="none" />
  </svg>
  {% elif token == 'bird' %}
  <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
    <path d="M8 44c8-10 12-24 32-24 4 0 10 2 16-4v20c0 12-10 20-22 20H18z" />
    <circle cx="46" cy="20" r="4" />
  </svg>
  {% elif token == 'rabbit' %}
  <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
    <path d="M20 8c6 0 10 10 10 18 0 8-4 18-10 18S10 34 10 26 14 8 20 8zm24 0c-6 0-10 10-10 18 0 8 4 18 10 18s10-10 10-18S50 8 44 8z" />
    <circle cx="24" cy="38" r="10" />
    <circle cx="40" cy="38" r="10" />
    <path d="M18 46c4 4 24 4 28 0" stroke-width="4" stroke-linecap="round" stroke="currentColor" fill="none" />
  </svg>
  {% elif token == 'reptile' %}
  <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
    <path d="M6 34c8-12 16-18 30-18 10 0 22 8 22 18s-12 18-22 18c-14 0-22-6-30-18z" />
    <circle cx="20" cy="30" r="4" />
    <circle cx="38" cy="30" r="4" />
    <path d="M12 42c6 6 34 6 40 0" stroke-width="4" stroke-linecap="round" stroke="currentColor" fill="none" />
  </svg>
  {% elif token == 'rodent' %}
  <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
    <path d="M12 40c0-12 10-22 20-22s20 10 20 22v4c0 6-6 12-12 12H24c-6 0-12-6-12-12z" />
    <circle cx="18" cy="24" r="6" />
    <circle cx="46" cy="24" r="6" />
    <path d="M8 32c4 8 0 14 12 20" stroke-width="4" stroke-linecap="round" stroke="currentColor" fill="none" />
  </svg>
  {% else %}
  <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
    <circle cx="18" cy="20" r="8" />
    <circle cx="46" cy="20" r="8" />
    <circle cx="18" cy="36" r="7" />
    <circle cx="46" cy="36" r="7" />
    <circle cx="32" cy="48" r="12" />
  </svg>
  {% endif %}
{% endmacro %}
{% set status_styles = {
  'adotado': {'label': 'Adotado', 'chip': 'success', 'bar': 'success'},
  'vendido': {'label': 'Vendido', 'chip': 'secondary', 'bar': 'secondary'},
  'venda':   {'label': '√Ä venda', 'chip': 'warning', 'bar': 'warning'},
  'perdido': {'label': 'Perdido', 'chip': 'danger', 'bar': 'danger'},
  'doa√ß√£o':  {'label': 'Para ado√ß√£o', 'chip': 'info', 'bar': 'info'},
  'doacao':  {'label': 'Para ado√ß√£o', 'chip': 'info', 'bar': 'info'}
}%}
{% set default_status = {'label': 'Para ado√ß√£o', 'chip': 'info', 'bar': 'info'} %}
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
  {% for animal in animals %}
    {% if modo != 'adotado' and animal.modo == 'adotado' and current_user.worker not in ['veterinario', 'colaborador'] %}
      {# pula esse animal #}
    {% else %}
      {# renderiza normalmente #}
      <div class="col" id="animal-card-{{ animal.id }}">
        {% set status_info = status_styles.get(animal.modo, default_status) %}
        {% set species_label = animal.species|species_display %}
        {% set species_visual_token = animal.species|species_visual_token %}
        {% set size_label = animal.peso|animal_size_label %}
        {% set size_token = animal.peso|animal_size_token %}
        <div class="card animal-card h-100 border-0 rounded-4 position-relative {% if animal.modo == 'perdido' %}border border-danger{% endif %} overflow-hidden">
          <div class="animal-card__status-bar animal-card__status-bar--{{ status_info['bar'] }}" aria-hidden="true"></div>
          <div class="animal-card__identity-badges" role="group" aria-label="Identificadores do animal">
            <span class="animal-card__identity-badge animal-card__identity-badge--species" title="Esp√©cie">{{ species_label }}</span>
            <span class="animal-card__identity-badge animal-card__identity-badge--size animal-card__identity-badge--size-{{ size_token }}" title="Porte">{{ size_label }}</span>
          </div>
          <div class="card-body d-flex flex-column gap-3 p-4">
            <div class="d-flex gap-3 align-items-center">
              <div class="animal-card__thumbnail {% if not animal.image %}animal-card__thumbnail--placeholder{% endif %}">
                {% if animal.image %}
                <img src="{{ animal.image }}" class="animal-card__photo" loading="lazy" alt="Imagem de {{ animal.name }}">
                {% else %}
                <div class="animal-card__species-avatar animal-card__species-avatar--{{ species_visual_token }}" role="img" aria-label="{{ species_label }}">
                  {{ species_avatar_icon(species_visual_token)|safe }}
                </div>
                {% endif %}
              </div>
              <div class="flex-grow-1 min-w-0">
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <div class="min-w-0">
                    <h5 class="card-title mb-1 text-truncate">
                      <span data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-content="{{ animal.description }}" data-bs-placement="top">
                        {{ animal.name }}
                      </span>
                    </h5>
                    {% if animal.date_added %}
                    <p class="text-muted small mb-0">Adicionado em {{ animal.date_added.strftime('%d/%m/%Y') }}</p>
                    {% endif %}
                  </div>
                  <span class="animal-card__status-chip animal-card__status-chip--{{ status_info['chip'] }}">{{ status_info['label'] }}</span>
                </div>
              </div>
            </div>

            {% if animal.modo == 'perdido' %}
            <div class="alert alert-danger small mb-0">
              ‚ö†Ô∏è Este animal foi marcado como <strong>PERDIDO</strong>.
              Se voc√™ viu ou sabe algo, por favor entre em contato com o tutor.
            </div>
            {% endif %}

            <ul class="list-unstyled profile-card-details mb-0">
              <li>
                <i class="fa-solid fa-paw"></i>
                <span>{{ species_label }}</span>
              </li>
              {% if animal.breed %}
              <li>
                <i class="fa-solid fa-dna"></i>
                <span>{{ animal.breed }}</span>
              </li>
              {% endif %}
              {% if animal.age_display %}
              <li>
                <i class="fa-solid fa-hourglass-half"></i>
                <span>{{ animal.age_display }}</span>
              </li>
              {% endif %}
              {% if animal.sex %}
              <li>
                <i class="fa-solid fa-venus-mars"></i>
                <span>{{ animal.sex }}</span>
              </li>
              {% endif %}
              <li>
                <i class="fa-solid fa-tag"></i>
                <span>{{ animal.modo|capitalize }}</span>
              </li>
              {% if animal.modo == 'venda' and animal.price is not none %}
              <li>
                <i class="fa-solid fa-coins"></i>
                <span>R$ {{ "%.2f"|format(animal.price) }}</span>
              </li>
              {% endif %}
            </ul>

            {% if animal.modo in ['perdido', 'venda', 'doa√ß√£o'] and animal.description %}
            <div class="profile-card-divider"></div>
            <p class="small text-muted mb-0">
              <strong>üìå Informa√ß√µes:</strong>
              {{ animal.description }}
            </p>
            {% endif %}

            <div class="d-flex flex-wrap gap-2 mt-auto">
              {% if animal.modo == 'perdido' and animal.owner != current_user %}
              <a href="https://wa.me/55{{ animal.owner.phone | replace('(', '') | replace(')', '') | replace('-', '') | replace(' ', '') }}"
                 target="_blank"
                 class="btn btn-outline-danger btn-sm rounded-pill">
                 üìç Vi esse animal
              </a>
              {% elif animal.owner != current_user %}
              <a href="{{ url_for('conversa', animal_id=animal.id, user_id=animal.owner.id) }}"
                class="btn btn-outline-primary btn-sm rounded-pill">
                üí¨ Tenho Interesse
              </a>
              {% endif %}

              {% if current_user.worker in ['veterinario', 'colaborador'] or animal.owner == current_user %}
              <button class="btn btn-outline-success btn-sm rounded-pill" data-bs-toggle="modal"
                data-bs-target="#modalFicha{{ animal.id }}">
                üìã Ver Ficha
              </button>
              {% endif %}

              {% if animal.owner == current_user %}
              <a href="{{ url_for('editar_animal', animal_id=animal.id) }}"
                class="btn btn-outline-secondary btn-sm rounded-pill">
                ‚úèÔ∏è Editar
              </a>
              {% endif %}

              {% if is_admin %}
              <form method="POST" action="{{ url_for('deletar_animal', animal_id=animal.id) }}"
                    class="btn btn-outline-secondary btn-sm rounded-pill delete-animal-form"
                    data-animal-id="{{ animal.id }}">
                <button type="submit" title="Excluir">‚ùå</button>
              </form>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Modal Ficha -->
        <div class="modal fade" id="modalFicha{{ animal.id }}" tabindex="-1"
          aria-labelledby="fichaLabel{{ animal.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">
              <div class="modal-header">
                <h5 class="modal-title" id="fichaLabel{{ animal.id }}">Ficha de {{ animal.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body text-start">
                {% if animal.image %}
                <img src="{{ animal.image }}" class="img-fluid rounded mb-3" loading="lazy" alt="Imagem de {{ animal.name }}">
                {% endif %}
                <p><strong>Esp√©cie:</strong> {{ animal.species }}</p>
                <p><strong>Ra√ßa:</strong> {{ animal.breed }}</p>
                <p><strong>Idade:</strong> {{ animal.age_display }}</p>
                <p><strong>Sexo:</strong> {{ animal.sex }}</p>
                <p><strong>Modo:</strong> {{ animal.modo|capitalize }}</p>
                {% if animal.modo == 'venda' %}
                <p><strong>Pre√ßo:</strong> R$ {{ "%.2f"|format(animal.price) }}</p>
                {% endif %}
                <p><strong>Descri√ß√£o:</strong><br>{{ animal.description }}</p>

                {% if current_user.worker in ['veterinario', 'colaborador'] %}
                <hr>
                <p class="mb-1"><strong>Tutor:</strong> {{ animal.owner.name }}</p>
                <p class="mb-1"><strong>Email:</strong> {{ animal.owner.email }}</p>
                <p class="mb-3"><strong>Telefone:</strong> {{ animal.owner.phone }}</p>
                <a href="{{ url_for('consulta_direct', animal_id=animal.id) }}"
                  class="btn btn-outline-success rounded-pill w-100">
                  ü©∫ Iniciar Consulta
                </a>
                <a href="{{ url_for('ficha_animal', animal_id=animal.id) }}"
                  class="btn btn-outline-primary rounded-pill w-100 mb-2">
                  üìÑ Ficha do Animal
                </a>
                <a href="{{ url_for('ficha_tutor', tutor_id=animal.owner.id) }}"
                  class="btn btn-outline-secondary rounded-pill w-100">
                  üë§ Ficha do Tutor
                </a>
                {% endif %}
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Fechar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endfor %}
</div>

{% if total_pages > 1 %}
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('list_animals', modo=modo, page=page-1) }}" data-page="{{ page - 1 }}" aria-label="Anterior">
        <span aria-hidden="true">&laquo; Anterior</span>
      </a>
    </li>

    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('list_animals', modo=modo, page=p) }}" data-page="{{ p }}">{{ p }}</a>
    </li>
    {% endfor %}

    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('list_animals', modo=modo, page=page+1) }}" data-page="{{ page + 1 }}" aria-label="Pr√≥xima">
        <span aria-hidden="true">Pr√≥xima &raquo;</span>
      </a>
    </li>
  </ul>
</nav>
{% endif %}
{% else %}
<div class="animal-empty-state mt-4 text-center">
  <div class="animal-empty-state__icon" aria-hidden="true">üêï</div>
  <h5 class="mb-2">Nenhum animal encontrado</h5>
  <p class="mb-4 text-muted">Ajuste os filtros ou seja o primeiro a cadastrar um novo pet na plataforma.</p>
  <a href="{{ url_for('novo_animal') }}" class="btn btn-primary rounded-pill">
    Cadastrar primeiro animal
  </a>
</div>
{% endif %}
