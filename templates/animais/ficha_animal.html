{% extends "layout.html" %}
{% block main %}

<div class="container py-4"
     data-animal-record
     data-events-url="{{ events_url }}"
     data-history-url="{{ history_url }}">

  {% if animal.removido_em %}
    <div class="alert alert-warning">
      Este animal foi removido do sistema em {{ animal.removido_em|format_datetime_brazil('%d/%m/%Y') }}. Hist√≥rico preservado.
    </div>
  {% endif %}

  <!-- CABE√áALHO -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="bi bi-clipboard-heart text-primary me-2"></i>
      Ficha de {{ animal.name }}
    </h2>
    <div class="d-flex gap-2">
      {% if current_user.worker == 'veterinario' %}
      <a href="{{ url_for('consulta_direct', animal_id=animal.id) }}" class="btn btn-outline-primary">
        ü©∫ Iniciar Nova Consulta
      </a>
      <a href="{{ url_for('editar_ficha_animal', animal_id=animal.id) }}" class="btn btn-outline-secondary">
        ‚úèÔ∏è Editar ficha
      </a>
      {% endif %}
      <a href="#" onclick="window.print()" class="btn btn-outline-secondary">üñ®Ô∏è Imprimir</a>
    </div>
  </div>




  <!-- DADOS DO ANIMAL -->
  <div class="card shadow-sm p-4 mb-4">
    <div class="row g-3 align-items-center">
      {% if animal.image %}
      <div class="col-md-3 text-center">
        <img src="{{ animal.image }}" class="img-fluid rounded shadow-sm card-img" height="200" loading="lazy" alt="Foto de {{ animal.name }}">
      </div>
      {% endif %}
      <div class="col-md">
        <div class="row g-3">
          {% if animal.species %}<div class="col-md-4"><strong>Esp√©cie:</strong> {{ animal.species }}</div>{% endif %}
          {% if animal.breed %}<div class="col-md-4"><strong>Ra√ßa:</strong> {{ animal.breed }}</div>{% endif %}
          {% if animal.sex %}<div class="col-md-4"><strong>Sexo:</strong> {{ animal.sex }}</div>{% endif %}
          {% if animal.date_of_birth %}<div class="col-md-4"><strong>Nascimento:</strong> {{ animal.date_of_birth.strftime('%d/%m/%Y') }}</div>{% endif %}
          {% if animal.age_display %}<div class="col-md-4"><strong>Idade:</strong> {{ animal.age_display }}</div>{% endif %}
        </div>
      </div>
    </div>
  </div>



    <!-- TABS -->
    <ul class="nav nav-tabs" id="animalTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="eventos-tab" data-bs-toggle="tab" data-bs-target="#eventos" type="button" role="tab" aria-controls="eventos" aria-selected="true">Pr√≥ximos eventos</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab" aria-controls="historico" aria-selected="false">Hist√≥rico M√©dico</button>
      </li>
    </ul>
    <div class="tab-content" id="animalTabsContent">
      <div class="tab-pane fade show active" id="eventos" role="tabpanel" aria-labelledby="eventos-tab">
        <!-- PR√ìXIMOS EVENTOS -->
        <div class="card shadow-sm p-4 mb-4" data-events-card>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="bi bi-calendar-event text-primary me-2"></i>Pr√≥ximos eventos</h4>
            <div class="spinner-border text-primary d-none" role="status" aria-hidden="true" data-events-loading></div>
          </div>
          <div data-events-container>
            <p class="text-muted mb-0">Carregando pr√≥ximos eventos...</p>
          </div>
        </div>
        <noscript>
          <div class="alert alert-warning">Ative o JavaScript para visualizar os eventos mais recentes.</div>
        </noscript>
      </div>
      <div class="tab-pane fade" id="historico" role="tabpanel" aria-labelledby="historico-tab">
        <!-- HIST√ìRICO M√âDICO -->
        <div class="card shadow-sm p-4 mb-4" data-history-card>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="bi bi-journal-medical text-success me-2"></i>Hist√≥rico M√©dico</h4>
            <div class="spinner-border text-success d-none" role="status" aria-hidden="true" data-history-loading></div>
          </div>
          <div data-history-container>
            <p class="text-muted mb-0">Selecione a aba para carregar o hist√≥rico completo.</p>
          </div>
        </div>
        <noscript>
          <div class="alert alert-warning">Ative o JavaScript para acessar o hist√≥rico m√©dico.</div>
        </noscript>
      </div>

    </div>
    <!-- DOCUMENTOS -->
    <div class="mt-4">
      {% include 'partials/documentos.html' %}
    </div>
  <!-- VOLTAR -->
  <h3>Ficha de {{ animal.name }}</h3>
  <p><strong>Tutor:</strong>
    <a href="{{ url_for('ficha_tutor', tutor_id=tutor.id) }}">{{ tutor.name }}</a>
  </p>

<!-- STATUS DE VIDA -->
{% if animal.is_alive and current_user.worker == 'veterinario' %}
  <div class="card border-dark p-3 mb-4">
    <div class="text-start">
      <button type="button" class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#falecimentoModal">
        ‚ùå Marcar como falecido
      </button>
    </div>
  </div>
{% elif not animal.is_alive %}
  <div class="alert alert-secondary d-flex justify-content-between align-items-center">
    <div>
      Este animal foi marcado como <strong>falecido</strong>.
      {% if animal.falecido_em %}
        Data do falecimento: {{ animal.falecido_em|format_datetime_brazil('%d/%m/%Y %H:%M') }}
      {% endif %}
    </div>

    {% if current_user.worker == 'veterinario' %}
      <form method="POST" action="{{ url_for('reverter_falecimento', animal_id=animal.id) }}" class="js-animal-status js-confirm" data-message="Deseja reverter o falecimento de {{ animal.name }}?">
        <button class="btn btn-sm btn-outline-success">‚Ü©Ô∏è Reverter Falecimento</button>
      </form>

      <!-- Bot√£o: Arquivar definitivamente -->
      <form method="POST" action="{{ url_for('arquivar_animal', animal_id=animal.id) }}" class="ms-2 js-animal-status js-confirm" data-message="Tem certeza que deseja excluir este animal permanentemente?">
        <button class="btn btn-outline-danger btn-sm" type="submit">
          üóëÔ∏è Deletar definitivamente
        </button>
      </form>
    {% endif %}
  </div>
{% endif %}



</div>

{% include 'partials/falecimento_modal.html' %}

{% endblock %}
{% block scripts %}
  {{ super() }}
  <script type="module" src="{{ url_for('static', filename='js/animal_record.js') }}"></script>
{% endblock %}
