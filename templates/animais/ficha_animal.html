{% extends "layout.html" %}
{% block main %}

<div class="container py-4"
     data-animal-record
     data-events-url="{{ events_url }}"
     data-history-url="{{ history_url }}">

  {% if animal.removido_em %}
    <div class="alert alert-warning">
      Este animal foi removido do sistema em {{ animal.removido_em|format_datetime_brazil('%d/%m/%Y') }}. Hist√≥rico preservado.
    </div>
  {% endif %}

  <!-- CABE√áALHO -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="bi bi-clipboard-heart text-primary me-2"></i>
      Ficha de {{ animal.name }}
    </h2>
    <div class="d-flex gap-2">
      {% if current_user.worker == 'veterinario' %}
      <a href="{{ url_for('consulta_direct', animal_id=animal.id) }}" class="btn btn-outline-primary">
        ü©∫ Iniciar Nova Consulta
      </a>
      <a href="{{ url_for('editar_ficha_animal', animal_id=animal.id) }}" class="btn btn-outline-secondary">
        ‚úèÔ∏è Editar ficha
      </a>
      {% endif %}
      <a href="#" onclick="window.print()" class="btn btn-outline-secondary">üñ®Ô∏è Imprimir</a>
    </div>
  </div>




  <!-- DADOS DO ANIMAL -->
  <div class="card shadow-sm p-4 mb-4">
    <div class="row g-3 align-items-center">
      {% if animal.image %}
      <div class="col-md-3 text-center">
        <img src="{{ animal.image }}" class="img-fluid rounded shadow-sm card-img" height="200" loading="lazy" alt="Foto de {{ animal.name }}">
      </div>
      {% endif %}
      <div class="col-md">
        <div class="row g-3">
          {% if animal.species %}<div class="col-md-4"><strong>Esp√©cie:</strong> {{ animal.species }}</div>{% endif %}
          {% if animal.breed %}<div class="col-md-4"><strong>Ra√ßa:</strong> {{ animal.breed }}</div>{% endif %}
          {% if animal.sex %}<div class="col-md-4"><strong>Sexo:</strong> {{ animal.sex }}</div>{% endif %}
          {% if animal.date_of_birth %}<div class="col-md-4"><strong>Nascimento:</strong> {{ animal.date_of_birth.strftime('%d/%m/%Y') }}</div>{% endif %}
          {% if animal.age_display %}<div class="col-md-4"><strong>Idade:</strong> {{ animal.age_display }}</div>{% endif %}
        </div>
      </div>
    </div>
  </div>



    <!-- TABS -->
    <ul class="nav nav-tabs" id="animalTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="eventos-tab" data-bs-toggle="tab" data-bs-target="#eventos" type="button" role="tab" aria-controls="eventos" aria-selected="true">Pr√≥ximos eventos</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab" aria-controls="historico" aria-selected="false">Hist√≥rico M√©dico</button>
      </li>
    </ul>
    <div class="tab-content" id="animalTabsContent">
      <div class="tab-pane fade show active" id="eventos" role="tabpanel" aria-labelledby="eventos-tab">
        <!-- PR√ìXIMOS EVENTOS -->
        <div class="card shadow-sm p-4 mb-4" data-events-card>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="bi bi-calendar-event text-primary me-2"></i>Pr√≥ximos eventos</h4>
            <div class="spinner-border text-primary d-none" role="status" aria-hidden="true" data-events-loading></div>
          </div>
          <div data-events-container>
            <p class="text-muted mb-0">Carregando pr√≥ximos eventos...</p>
          </div>
        </div>
        <noscript>
          <div class="alert alert-warning">Ative o JavaScript para visualizar os eventos mais recentes.</div>
        </noscript>
      </div>
      <div class="tab-pane fade" id="historico" role="tabpanel" aria-labelledby="historico-tab">
        <!-- HIST√ìRICO M√âDICO -->
        <div class="card shadow-sm p-4 mb-4" data-history-card>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="bi bi-journal-medical text-success me-2"></i>Hist√≥rico M√©dico</h4>
            <div class="spinner-border text-success d-none" role="status" aria-hidden="true" data-history-loading></div>
          </div>
          <div data-history-container>
            <p class="text-muted mb-0">Selecione a aba para carregar o hist√≥rico completo.</p>
          </div>
        </div>
        <noscript>
          <div class="alert alert-warning">Ative o JavaScript para acessar o hist√≥rico m√©dico.</div>
        </noscript>
      </div>

    </div>
    <!-- DOCUMENTOS -->
    <div class="mt-4">
      {% include 'partials/documentos.html' %}
    </div>
  <!-- VOLTAR -->
  <div class="card tutor-card shadow-sm border-0 mb-4">
    <div class="card-body">
      <div class="d-flex flex-column flex-md-row align-items-start gap-3">
        <div class="tutor-card__avatar">
          <i class="bi bi-people-fill"></i>
        </div>
        <div class="flex-fill">
          <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
            <span class="badge rounded-pill bg-primary-subtle text-primary fw-semibold">Tutor respons√°vel</span>
            <span class="badge rounded-pill bg-success-subtle text-success fw-semibold">
              <i class="bi bi-heart-fill me-1"></i>
              {{ tutor.animals|length if tutor.animals is not none else 0 }} animais vinculados
            </span>
          </div>
          <h4 class="mb-1">
            <a class="tutor-card__name" href="{{ url_for('ficha_tutor', tutor_id=tutor.id) }}">{{ tutor.name }}</a>
          </h4>
          <p class="text-muted mb-3">Acesse rapidamente os dados de contato e o hist√≥rico completo do tutor.</p>
          <div class="d-flex flex-wrap gap-3 small text-muted">
            <span class="d-inline-flex align-items-center gap-2">
              <i class="bi bi-telephone"></i>
              {{ tutor.phone or 'Telefone n√£o informado' }}
            </span>
            <span class="d-inline-flex align-items-center gap-2">
              <i class="bi bi-envelope"></i>
              {{ tutor.email or 'E-mail n√£o informado' }}
            </span>
            {% if tutor.endereco and tutor.endereco.logradouro %}
              <span class="d-inline-flex align-items-center gap-2">
                <i class="bi bi-geo-alt"></i>
                {{ tutor.endereco.logradouro }}
              </span>
            {% endif %}
          </div>
        </div>
        <div class="d-flex flex-column gap-2 w-100 w-md-auto">
          <a href="{{ url_for('ficha_tutor', tutor_id=tutor.id) }}" class="btn btn-primary w-100">
            <i class="bi bi-journal-richtext me-2"></i>Ver ficha do tutor
          </a>
          {% if current_user.worker == 'veterinario' %}
            <button type="button" class="btn btn-outline-dark w-100" data-bs-toggle="modal" data-bs-target="#falecimentoModal">
              <i class="bi bi-x-octagon me-2"></i>Marcar como falecido
            </button>
          {% endif %}
        </div>
      </div>

      {% if not animal.is_alive %}
        <div class="tutor-card__footer mt-3 pt-3">
          <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3">
            <div class="d-flex align-items-center gap-3">
              <span class="tutor-card__badge--muted">Animal falecido</span>
              <div class="text-muted">
                Este animal foi marcado como <strong>falecido</strong>.
                {% if animal.falecido_em %}
                  Data do falecimento: {{ animal.falecido_em|format_datetime_brazil('%d/%m/%Y %H:%M') }}
                {% endif %}
              </div>
            </div>
            {% if current_user.worker == 'veterinario' %}
              <div class="d-flex flex-wrap gap-2">
                <form method="POST" action="{{ url_for('reverter_falecimento', animal_id=animal.id) }}" class="js-animal-status js-confirm" data-message="Deseja reverter o falecimento de {{ animal.name }}?">
                  <button class="btn btn-sm btn-outline-success">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reverter Falecimento
                  </button>
                </form>
                <form method="POST" action="{{ url_for('arquivar_animal', animal_id=animal.id) }}" class="js-animal-status js-confirm" data-message="Tem certeza que deseja excluir este animal permanentemente?">
                  <button class="btn btn-outline-danger btn-sm" type="submit">
                    <i class="bi bi-trash3 me-1"></i>Deletar definitivamente
                  </button>
                </form>
              </div>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>



</div>

{% include 'partials/falecimento_modal.html' %}

{% endblock %}
{% block scripts %}
  {{ super() }}
  <script type="module" src="{{ url_for('static', filename='js/animal_record.js') }}"></script>
{% endblock %}
