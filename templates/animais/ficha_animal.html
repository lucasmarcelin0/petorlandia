{% extends "layout.html" %}
{% block main %}

<div class="container py-4">

  {% if animal.removido_em %}
    <div class="alert alert-warning">
      Este animal foi removido do sistema em {{ animal.removido_em|format_datetime_brazil('%d/%m/%Y') }}. Hist√≥rico preservado.
    </div>
  {% endif %}

  <!-- CABE√áALHO -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="bi bi-clipboard-heart text-primary me-2"></i>
      Ficha de {{ animal.name }}
    </h2>
    <div class="d-flex gap-2">
      {% if current_user.worker == 'veterinario' %}
      <a href="{{ url_for('consulta_direct', animal_id=animal.id) }}" class="btn btn-outline-primary">
        ü©∫ Iniciar Nova Consulta
      </a>
      <a href="{{ url_for('editar_ficha_animal', animal_id=animal.id) }}" class="btn btn-outline-secondary">
        ‚úèÔ∏è Editar ficha
      </a>
      {% endif %}
      <a href="#" onclick="window.print()" class="btn btn-outline-secondary">üñ®Ô∏è Imprimir</a>
    </div>
  </div>




  <!-- DADOS DO ANIMAL -->
  <div class="card shadow-sm p-4 mb-4">
    <div class="row g-3 align-items-center">
      {% if animal.image %}
      <div class="col-md-3 text-center">
        <img src="{{ animal.image }}" class="img-fluid rounded shadow-sm card-img" height="200" loading="lazy" alt="Foto de {{ animal.name }}">
      </div>
      {% endif %}
      <div class="col-md">
        <div class="row g-3">
          {% if animal.species %}<div class="col-md-4"><strong>Esp√©cie:</strong> {{ animal.species }}</div>{% endif %}
          {% if animal.breed %}<div class="col-md-4"><strong>Ra√ßa:</strong> {{ animal.breed }}</div>{% endif %}
          {% if animal.sex %}<div class="col-md-4"><strong>Sexo:</strong> {{ animal.sex }}</div>{% endif %}
          {% if animal.date_of_birth %}<div class="col-md-4"><strong>Nascimento:</strong> {{ animal.date_of_birth.strftime('%d/%m/%Y') }}</div>{% endif %}
          {% if animal.age_display %}<div class="col-md-4"><strong>Idade:</strong> {{ animal.age_display }}</div>{% endif %}
        </div>
      </div>
    </div>
  </div>



    <!-- TABS -->
    <ul class="nav nav-tabs" id="animalTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="eventos-tab" data-bs-toggle="tab" data-bs-target="#eventos" type="button" role="tab" aria-controls="eventos" aria-selected="true">Pr√≥ximos eventos</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab" aria-controls="historico" aria-selected="false">Hist√≥rico M√©dico</button>
      </li>
    </ul>
    <div class="tab-content" id="animalTabsContent">
      <div class="tab-pane fade show active" id="eventos" role="tabpanel" aria-labelledby="eventos-tab">
        <!-- PR√ìXIMOS EVENTOS -->
        <div class="card shadow-sm p-4 mb-4">
          <h4 class="mb-3"><i class="bi bi-calendar-event text-primary me-2"></i>Pr√≥ximos eventos</h4>

          <h6 class="text-muted">üîÅ Retornos</h6>
          {% if retornos %}
            <ul class="list-group mb-3">
              {% for r in retornos %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ r.scheduled_at|format_datetime_brazil('%d/%m/%Y %H:%M') }}</span>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">Nenhum retorno agendado.</p>
          {% endif %}

          <h6 class="mt-3 text-muted">üß™ Exames</h6>
          {% if exames_agendados %}
            <ul class="list-group mb-3">
              {% for ex in exames_agendados %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ ex.scheduled_at|format_datetime_brazil('%d/%m/%Y %H:%M') }}</span>
                <span class="text-muted small">{{ ex.specialist.user.name }}</span>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">Nenhum exame agendado.</p>
          {% endif %}
        </div>
      </div>
      <div class="tab-pane fade" id="historico" role="tabpanel" aria-labelledby="historico-tab">
        <!-- HIST√ìRICO M√âDICO -->
        <div class="card shadow-sm p-4 mb-4">
          <h4 class="mb-3"><i class="bi bi-journal-medical text-success me-2"></i>Hist√≥rico M√©dico</h4>

          <div class="accordion" id="historicoAccordion">

            <!-- PRESCRI√á√ïES -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingPrescricoes">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrescricoes" aria-expanded="false" aria-controls="collapsePrescricoes">
                  üíä Prescri√ß√µes
                </button>
              </h2>
              <div id="collapsePrescricoes" class="accordion-collapse collapse" aria-labelledby="headingPrescricoes" data-bs-parent="#historicoAccordion">
                <div class="accordion-body">
                  {% if blocos_prescricao %}
                    {% for bloco in blocos_prescricao[:3] %}
                    <div class="card mb-2 shadow-sm">
                      <div class="card-body d-flex justify-content-between align-items-center">
                        <span class="text-dark">
                          {{ bloco.data_criacao|format_datetime_brazil('%d/%m/%Y') }} ‚Äî {{ bloco.prescricoes | length }} medica√ß√£o(√µes)
                        </span>
                        {% if current_user.worker == 'veterinario' %}
                          <a href="{{ url_for('imprimir_bloco_prescricao', bloco_id=bloco.id) }}" class="btn btn-sm btn-outline-primary">üñ®Ô∏è Imprimir</a>
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                    {% if blocos_prescricao|length > 3 and 'historico_prescricoes' in current_app.view_functions %}
                      <a href="{{ url_for('historico_prescricoes', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark">üîç Ver todas</a>
                    {% endif %}
                  {% else %}
                    <p class="text-muted">Nenhuma prescri√ß√£o encontrada.</p>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- EXAMES -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingExames">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExames" aria-expanded="false" aria-controls="collapseExames">
                  üß™ Exames Solicitados
                </button>
              </h2>
              <div id="collapseExames" class="accordion-collapse collapse" aria-labelledby="headingExames" data-bs-parent="#historicoAccordion">
                <div class="accordion-body">
                  {% if blocos_exames %}
                    {% for bloco in blocos_exames[:3] %}
                    <div class="card mb-2 shadow-sm">
                      <div class="card-body d-flex justify-content-between align-items-center">
                        <span class="text-dark">
                          {{ bloco.data_criacao|format_datetime_brazil('%d/%m/%Y') }} ‚Äî {{ bloco.exames | length }} exame(s)
                        </span>
                        {% if current_user.worker == 'veterinario' %}
                          <a href="{{ url_for('imprimir_bloco_exames', bloco_id=bloco.id) }}" class="btn btn-sm btn-outline-primary">üñ®Ô∏è Imprimir</a>
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                    {% if blocos_exames|length > 3 and 'historico_exames' in current_app.view_functions %}
                      <a href="{{ url_for('historico_exames', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark">üîç Ver todas</a>
                    {% endif %}
                  {% else %}
                    <p class="text-muted">Nenhum exame solicitado.</p>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- CONSULTAS -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingConsultas">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConsultas" aria-expanded="false" aria-controls="collapseConsultas">
                  üìÖ Consultas Veterin√°rias
                </button>
              </h2>
              <div id="collapseConsultas" class="accordion-collapse collapse" aria-labelledby="headingConsultas" data-bs-parent="#historicoAccordion">
                <div class="accordion-body">
                  {% if consultas %}
                    <ul class="list-group mb-2">
                      {% for c in consultas[:3] %}
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>{{ c.created_at|format_datetime_brazil('%d/%m/%Y') }}</span>
                        <span class="text-muted small">{{ c.veterinario.name }}</span>
                      </li>
                      {% endfor %}
                    </ul>
                    {% if consultas|length > 3 and 'historico_consultas' in current_app.view_functions %}
                      <a href="{{ url_for('historico_consultas', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark">üîç Ver todas</a>
                    {% endif %}
                  {% else %}
                    <p class="text-muted">Nenhuma consulta registrada.</p>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- VACINAS -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingVacinas">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVacinas" aria-expanded="false" aria-controls="collapseVacinas">
                  üíâ Vacinas
                </button>
              </h2>
              <div id="collapseVacinas" class="accordion-collapse collapse" aria-labelledby="headingVacinas" data-bs-parent="#historicoAccordion">
                <div class="accordion-body">
                  <h6 class="text-muted">üíâ Doses Futuras</h6>
                  {% if doses_futuras %}
                    <ul class="list-group mb-2">
                      {% for v in doses_futuras[:3] %}
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                          <strong>{{ v.nome }}</strong>
                          {% if v.aplicada_em %} ‚Äî {{ v.aplicada_em|format_datetime_brazil('%d/%m/%Y') }}{% endif %}
                        </div>
                      </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-muted">Nenhuma dose futura agendada.</p>
                  {% endif %}

                  <h6 class="mt-3 text-muted">üíâ Doses Atrasadas</h6>
                  {% if doses_atrasadas %}
                    <ul class="list-group mb-2">
                      {% for v in doses_atrasadas[:3] %}
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                          <strong>{{ v.nome }}</strong>
                          {% if v.aplicada_em %} ‚Äî {{ v.aplicada_em|format_datetime_brazil('%d/%m/%Y') }}{% endif %}
                        </div>
                      </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-muted">Nenhuma dose atrasada.</p>
                  {% endif %}

                  <h6 class="mt-3 text-muted">üíâ Vacinas Aplicadas</h6>
                  {% if vacinas_aplicadas %}
                    <ul class="list-group mb-2">
                      {% for v in vacinas_aplicadas[:3] %}
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                          <strong>{{ v.nome }}</strong> ‚Äî {{ v.tipo or "Tipo n√£o informado" }} em {{ v.aplicada_em|format_datetime_brazil('%d/%m/%Y') if v.aplicada_em else 'Data n√£o registrada' }}
                          {% if v.observacoes %}
                            <br><em class="text-muted">Obs: {{ v.observacoes }}</em>
                          {% endif %}
                        </div>
                      </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-muted">Nenhuma vacina registrada.</p>
                  {% endif %}

                  {% if (doses_futuras|length > 3 or doses_atrasadas|length > 3 or vacinas_aplicadas|length > 3) and 'historico_vacinas' in current_app.view_functions %}
                    <a href="{{ url_for('historico_vacinas', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark">üîç Ver todas</a>
                  {% endif %}
                </div>
              </div>
            </div>

          </div>

          <!-- DOCUMENTOS -->
          <div class="mt-4">
            {% include 'partials/documentos.html' %}
          </div>
        </div>
      </div>
    </div>
  <!-- VOLTAR -->
  <h3>Ficha de {{ animal.name }}</h3>
  <p><strong>Tutor:</strong>
    <a href="{{ url_for('ficha_tutor', tutor_id=tutor.id) }}">{{ tutor.name }}</a>
  </p>

<!-- STATUS DE VIDA -->
{% if animal.is_alive and current_user.worker == 'veterinario' %}
  <div class="card border-dark p-3 mb-4">
    <div class="text-start">
      <button type="button" class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#falecimentoModal">
        ‚ùå Marcar como falecido
      </button>
    </div>
  </div>
{% elif not animal.is_alive %}
  <div class="alert alert-secondary d-flex justify-content-between align-items-center">
    <div>
      Este animal foi marcado como <strong>falecido</strong>.
      {% if animal.falecido_em %}
        Data do falecimento: {{ animal.falecido_em|format_datetime_brazil('%d/%m/%Y %H:%M') }}
      {% endif %}
    </div>

    {% if current_user.worker == 'veterinario' %}
      <form method="POST" action="{{ url_for('reverter_falecimento', animal_id=animal.id) }}" class="js-animal-status js-confirm" data-message="Deseja reverter o falecimento de {{ animal.name }}?">
        <button class="btn btn-sm btn-outline-success">‚Ü©Ô∏è Reverter Falecimento</button>
      </form>

      <!-- Bot√£o: Arquivar definitivamente -->
      <form method="POST" action="{{ url_for('arquivar_animal', animal_id=animal.id) }}" class="ms-2 js-animal-status js-confirm" data-message="Tem certeza que deseja excluir este animal permanentemente?">
        <button class="btn btn-outline-danger btn-sm" type="submit">
          üóëÔ∏è Deletar definitivamente
        </button>
      </form>
    {% endif %}
  </div>
{% endif %}



</div>

{% include 'partials/falecimento_modal.html' %}

{% endblock %}
{% block scripts %}
  <script src="{{ url_for('static', filename='appointments_table.js') }}"></script>
{% endblock %}
