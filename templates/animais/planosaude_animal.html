{% extends "layout.html" %}
{% block main %}
<div class="container mt-4">

    <!-- Cabe√ßalho simplificado -->
    <div class="text-center mb-5">
        {% if animal.image %}
            <img src="{{ animal.image }}" alt="Foto de {{ animal.name }}"
                 class="rounded-circle shadow-sm mb-3" loading="lazy"
                 style="width: 120px; height: 120px; object-fit: cover;">
        {% endif %}
        <h2 class="mb-2">{{ animal.name }} üêæ</h2>
        <p class="text-muted">{{ animal.species }} ‚Ä¢ {{ animal.breed }}</p>
    </div>

    <!-- Status do plano atual (se tiver) -->
    {% if subscription %}
        <div class="alert alert-success shadow-sm rounded-4 mb-4">
            <div class="d-flex align-items-center gap-2">
                <span style="font-size: 1.5rem;">‚úÖ</span>
                <div>
                    <strong>Plano ativo!</strong><br>
                    <span class="small">{{ subscription.plan.name }} desde {{ subscription.start_date.strftime('%d/%m/%Y') if subscription.start_date else 'N/D' }}</span>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Sele√ß√£o de plano simplificada -->
    <div class="card shadow-sm rounded-4 mb-5">
        <div class="card-body">
            <h4 class="mb-4">{{ 'Alterar' if subscription else 'Escolher' }} seu plano</h4>
            
            <form method="post" action="{{ url_for('contratar_plano', animal_id=animal.id) }}" class="row g-3">
                {{ form.hidden_tag() }}
                
                <!-- Seletor de plano -->
                <div class="col-12">
                    {{ form.plan_id.label(class="form-label fw-semibold") }}
                    {{ form.plan_id(class="form-select form-select-lg", id="plan_id") }}
                </div>

                <!-- Preview do plano selecionado -->
                <div class="col-12">
                    <div id="plan-preview" class="border-start border-4 border-success ps-3 py-2">
                        <p class="text-muted small">Selecione um plano para ver os detalhes</p>
                    </div>
                </div>

                <!-- Cobertura simplificada -->
                <div class="col-12">
                    <div id="plan-coverage"></div>
                </div>

                <!-- Campos obrigat√≥rios simplificados (removidos campos desnecess√°rios) -->
                <div class="col-md-6">
                    {{ form.tutor_document.label(class="form-label fw-semibold") }}
                    {{ form.tutor_document(class="form-control", placeholder="CPF/CNPJ", value=user_cpf or '') }}
                    {% if form.tutor_document.errors %}
                        <small class="text-danger d-block mt-1">{{ form.tutor_document.errors[0] }}</small>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    {{ form.animal_document.label(class="form-label fw-semibold") }}
                    {{ form.animal_document(class="form-control", placeholder="Microchip ou registro", value=animal_microchip or '') }}
                    {% if form.animal_document.errors %}
                        <small class="text-danger d-block mt-1">{{ form.animal_document.errors[0] }}</small>
                    {% endif %}
                </div>

                <!-- Consentimento -->
                <div class="col-12">
                    <div class="form-check">
                        {{ form.consent(class="form-check-input", id="consent-checkbox") }}
                        <label class="form-check-label small" for="consent-checkbox">
                            Concordo com os <a href="#" class="text-decoration-none">termos do plano</a> e autorizo o compartilhamento de documentos
                        </label>
                    </div>
                    {% if form.consent.errors %}
                        <small class="text-danger d-block mt-1">{{ form.consent.errors[0] }}</small>
                    {% endif %}
                </div>

                <!-- Bot√£o de a√ß√£o -->
                <div class="col-12">
                    {{ form.submit(class="btn btn-success btn-lg rounded-pill w-100", value="Contratar Plano") }}
                </div>
            </form>
        </div>
    </div>

    <!-- Benef√≠cios do plano (simplificado) -->
    {% if subscription and subscription.plan.coverages %}
    <div class="card shadow-sm rounded-4 mb-5">
        <div class="card-body">
            <h5 class="fw-semibold mb-4">‚ú® O que est√° coberto no seu plano</h5>
            <div class="row row-cols-1 row-cols-md-2 g-3">
                {% for coverage in subscription.plan.coverages|list|first(6) %}
                <div class="col">
                    <div class="d-flex gap-2">
                        <span class="text-success fw-bold">‚úì</span>
                        <div>
                            <strong class="small">{{ coverage.name }}</strong><br>
                            {% if coverage.waiting_period_days %}
                                <span class="text-muted small">Car√™ncia: {{ coverage.waiting_period_days }} dias</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if subscription.plan.coverages|length > 6 %}
                <p class="text-muted small mt-3 mb-0">+ {{ subscription.plan.coverages|length - 6 }} coberturas adicionais</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if show_schedule_button %}
    <div class="text-center mb-4">
        <a href="{{ url_for('appointments', animal_id=animal.id) }}" class="btn btn-outline-primary rounded-pill">
            ü©∫ Agendar Consulta
        </a>
    </div>
    {% endif %}
</div>

<script>
  const plans = {{ plans | tojson }};

  function formatCoveragePreview(coverages) {
    if (!coverages || !coverages.length) {
      return '<p class="text-muted small mb-0">Nenhuma cobertura cadastrada</p>';
    }
    const items = coverages.slice(0, 4).map(c => `
      <div class="d-flex gap-2 mb-2">
        <span class="text-success fw-bold">‚úì</span>
        <span class="small">${c.name}</span>
      </div>
    `).join('');
    const extra = coverages.length > 4 ? `<p class="text-muted small mb-0">+ ${coverages.length - 4} mais</p>` : '';
    return items + extra;
  }

  function updatePlanPreview() {
    const select = document.getElementById('plan_id');
    const previewDiv = document.getElementById('plan-preview');
    const coverageDiv = document.getElementById('plan-coverage');
    const plan = plans.find(p => p.id == select.value);
    
    if (plan) {
      previewDiv.innerHTML = `
        <h5 class="fw-semibold mb-2">${plan.name}</h5>
        <p class="mb-2">${plan.description || 'Plano completo para sa√∫de do seu pet'}</p>
        <p class="mb-0"><strong class="text-success" style="font-size: 1.2rem;">R$ ${plan.price.toFixed(2)}/m√™s</strong></p>
      `;
      coverageDiv.innerHTML = `<div class="mt-3">${formatCoveragePreview(plan.coverages)}</div>`;
    } else {
      previewDiv.innerHTML = '<p class="text-muted small">Selecione um plano para ver os detalhes</p>';
      coverageDiv.innerHTML = '';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('plan_id');
    if (select) {
      select.addEventListener('change', updatePlanPreview);
      updatePlanPreview();
    }
  });
</script>
{% endblock %}
