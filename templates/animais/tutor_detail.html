{% extends 'layout.html' %}
{% from 'components/photo_cropper.html' import photo_cropper %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tutor_detail.css') }}">
{% endblock %}

{% block main %}
{% set active_animals = animais | selectattr('removido_em', 'equalto', none) | list %}
{% set removed_animals = animais | selectattr('removido_em') | list %}

<div class="container py-4">
  <div class="card tutor-hero shadow-sm border-0 mb-4 overflow-hidden">
    <div class="tutor-hero__bg"></div>
    <div class="card-body position-relative">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-3">
        <div class="d-flex align-items-center gap-3 flex-grow-1">
          <a href="{{ url_for('tutores') }}" class="btn btn-link text-decoration-none px-0 text-primary fw-semibold d-flex align-items-center gap-2">
            <i class="fas fa-arrow-left"></i> Voltar aos tutores
          </a>
        </div>
        <form method="POST" action="{{ url_for('deletar_tutor', tutor_id=tutor.id) }}"
              onsubmit="return confirm('Tem certeza que deseja excluir este tutor e todos os seus dados permanentemente?');"
              class="ms-lg-auto">
          <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill px-3 d-flex align-items-center gap-2">
            <i class="fas fa-trash"></i> Excluir tutor
          </button>
        </form>
      </div>

      <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-4 mt-3">
        <div class="tutor-avatar">
          <img
            id="preview-tutor"
            src="{{ tutor.profile_photo or '' }}"
            alt="Foto do Tutor"
            class="avatar {% if not tutor.profile_photo %}d-none{% endif %}"
            style="--avatar-size:140px;"
            loading="lazy"
            data-offset-x="{{ tutor.photo_offset_x or 0 }}"
            data-offset-y="{{ tutor.photo_offset_y or 0 }}"
            data-rotation="{{ tutor.photo_rotation or 0 }}"
            data-zoom="{{ tutor.photo_zoom or 1 }}">
          <div class="avatar-ring"></div>
        </div>
        <div class="flex-grow-1">
          <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
            <h2 class="mb-0">{{ tutor.name }}</h2>
            {% if tutor.worker %}
              <span class="badge bg-light text-primary border">{{ tutor.worker|title }}</span>
            {% endif %}
            {% if tutor.worker|lower == 'veterinario' %}
              <span class="badge bg-secondary text-white">CRM: {{ tutor.veterinario.crm if tutor.veterinario else '‚Äî' }}</span>
            {% endif %}
          </div>
          <p class="text-muted mb-3">Dados completos, contatos e hist√≥rico de animais deste tutor.</p>
          <div class="d-flex flex-wrap gap-2 mb-3 tutor-chips">
            {% if tutor.email %}
              <span class="chip"><i class="fas fa-envelope"></i> {{ tutor.email }}</span>
            {% endif %}
            {% if tutor.phone %}
              <span class="chip"><i class="fas fa-phone"></i> {{ tutor.phone }}</span>
            {% endif %}
            {% if tutor.cpf %}
              <span class="chip"><i class="fas fa-id-card"></i> CPF {{ tutor.cpf }}</span>
            {% endif %}
          </div>
          <div class="d-flex flex-wrap gap-3">
            <div class="stat-card">
              <span class="label">Animais ativos</span>
              <strong>{{ active_animals|length }}</strong>
            </div>
            <div class="stat-card">
              <span class="label">Animais removidos</span>
              <strong>{{ removed_animals|length }}</strong>
            </div>
            <div class="stat-card">
              <span class="label">Cadastro</span>
              <strong>{{ tutor.created_at.strftime('%d/%m/%Y') if tutor.created_at else '‚Äî' }}</strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body pb-0">
      <ul class="nav nav-tabs custom-tabs" id="tutorTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="dados-tab" data-bs-toggle="tab" data-bs-target="#dados" type="button" role="tab" aria-controls="dados" aria-selected="true">
            <i class="fas fa-user"></i> Dados do Tutor
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="animais-tab" data-bs-toggle="tab" data-bs-target="#animais" type="button" role="tab" aria-controls="animais" aria-selected="false">
            <i class="fas fa-paw"></i> Lista de Animais
          </button>
        </li>
      </ul>
    </div>
    <div class="tab-content p-3">

      <div class="tab-pane fade show active" id="dados" role="tabpanel" aria-labelledby="dados-tab">
        <form id="tutor-form" action="{{ url_for('update_tutor', user_id=tutor.id) }}" method="POST" enctype="multipart/form-data" data-sync class="section-card">
          {{ tutor_form.hidden_tag() }}
          <div class="section-card__header">
            <div>
              <p class="section-eyebrow">Perfil</p>
              <h5 class="mb-1">Informa√ß√µes do tutor</h5>
              <p class="text-muted mb-0">Atualize contatos, documentos e a foto do tutor.</p>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nome</label>
              <input name="name" class="form-control" value="{{ tutor.name or '' }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">E‚Äëmail</label>
              <input name="email" type="email" class="form-control" value="{{ tutor.email or '' }}" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Telefone</label>
              <input name="phone" class="form-control" value="{{ tutor.phone or '' }}"
                     data-mask="(99) 99999-9999" pattern="\(\d{2}\) \d{5}-\d{4}">
            </div>
            <div class="col-md-4">
              <label class="form-label">CPF</label>
              <input name="cpf" class="form-control" value="{{ tutor.cpf or '' }}"
                     data-mask="999.999.999-99" pattern="\d{3}\.\d{3}\.\d{3}-\d{2}">
            </div>
            <div class="col-md-4">
              <label class="form-label">RG</label>
              <input name="rg" class="form-control" value="{{ tutor.rg or '' }}"
                     data-mask="99.999.999-9" pattern="\d{2}\.\d{3}\.\d{3}-\d">
            </div>
            <div class="col-md-4">
              <label class="form-label">Data de Nascimento</label>
              <input id="tutor_dob" name="date_of_birth" class="form-control" value="{{ tutor.date_of_birth.strftime('%Y-%m-%d') if tutor.date_of_birth else '' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Idade</label>
              <input id="tutor_age" type="number" class="form-control" min="0">
            </div>
            <div class="col-md-4">
              <label class="form-label">Foto do Tutor</label>
              <div class="photo-uploader">
                {{ photo_cropper(tutor_form.profile_photo, tutor_form.photo_rotation, tutor_form.photo_zoom, tutor_form.photo_offset_x, tutor_form.photo_offset_y, tutor.profile_photo, 150, 'profile_photo', 'user') }}
              </div>
            </div>
            {% if tutor.worker|lower == 'veterinario' and tutor.veterinario %}
            <div class="col-12">
              <label class="form-label">Especialidades</label>
              <div class="d-flex flex-wrap gap-2">
                {% for esp in tutor.veterinario.specialties %}
                  <span class="badge bg-secondary">{{ esp.nome }}</span>
                {% else %}
                  <span class="text-muted">Nenhuma</span>
                {% endfor %}
              </div>
              <a href="{{ url_for('edit_vet_specialties', veterinario_id=tutor.veterinario.id) }}" class="btn btn-sm btn-outline-primary mt-2">Editar Especialidades</a>
            </div>
            {% endif %}

            <div class="col-12">
              <div class="section-divider"></div>
              <p class="section-eyebrow">Endere√ßo</p>
            </div>

            {% include "partials/endereco_form.html" with context %}

            <div class="col-12">
              <div class="d-grid gap-2 d-sm-flex justify-content-sm-end">
                <button class="btn btn-primary px-4" data-loading-text="Salvando..." data-success-text="Altera√ß√µes salvas!">
                  <i class="fas fa-save me-2"></i>Salvar altera√ß√µes
                </button>
              </div>
              <div class="alert alert-success mt-3 d-none form-status-message" role="alert" aria-live="polite"></div>
            </div>
          </div>
        </form>
      </div>

      <div class="tab-pane fade" id="animais" role="tabpanel" aria-labelledby="animais-tab">
        <div class="section-card">
          <div class="section-card__header align-items-center flex-wrap gap-3">
            <div>
              <p class="section-eyebrow">Animais</p>
              <h5 class="mb-1" id="animais-heading">üêæ Animais de {{ tutor.name.split(' ')[0] }}</h5>
              <p class="text-muted mb-0">Visualize rapidamente os pacientes deste tutor e acesse suas fichas.</p>
            </div>
            <div class="ms-auto d-flex gap-2 flex-wrap">
              <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalNovoAnimal">
                <i class="fas fa-plus-circle me-2"></i>Novo Animal
              </button>
            </div>
          </div>

          <div class="search-box mb-3">
            <i class="fas fa-search"></i>
            <input id="animal-search" type="search" class="form-control" placeholder="Busque por nome do animal">
          </div>

          <div class="table-responsive">
            <table id="animals-table" class="table table-hover align-middle animals-table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Esp√©cie / Ra√ßa</th>
                  <th>Sexo</th>
                  <th class="text-end">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {% for a in active_animals %}
                <tr id="animal-row-{{ a.id }}">
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      {% if a.image %}
                        <img src="{{ a.image }}"
                             alt="Foto de {{ a.name }}"
                             class="avatar"
                             data-offset-x="{{ a.photo_offset_x or 0 }}"
                             data-offset-y="{{ a.photo_offset_y or 0 }}"
                             data-rotation="{{ a.photo_rotation or 0 }}"
                             data-zoom="{{ a.photo_zoom or 1 }}"
                             style="--avatar-size:36px;">
                      {% else %}
                        <div class="avatar placeholder" style="--avatar-size:36px;">
                          <i class="fas fa-paw"></i>
                        </div>
                      {% endif %}
                      <span class="animal-name fw-semibold">{{ a.name }}</span>
                    </div>
                  </td>
                  <td class="animal-species">
                    <span class="badge bg-light text-dark border me-2">{{ a.species }}</span>
                    <span class="text-muted">{{ a.breed }}</span>
                  </td>
                  <td class="animal-sex">
                    <span class="badge {% if a.sex == 'F√™mea' %}bg-pink{% elif a.sex == 'Macho' %}bg-info-subtle text-info{% else %}bg-light text-dark border{% endif %}">
                      {{ a.sex or '‚Äî' }}
                    </span>
                  </td>
                  <td class="text-end">
                    <div class="d-flex gap-2 justify-content-end flex-wrap">
                      <a href="{{ url_for('consulta_direct', animal_id=a.id) }}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-stethoscope me-1"></i> Consulta
                      </a>
                      <a href="{{ url_for('ficha_animal', animal_id=a.id) }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-file-lines me-1"></i> Ficha
                      </a>
                      <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditarAnimal{{ a.id }}">
                        <i class="fas fa-pen"></i> Editar
                      </button>
                      <form action="{{ url_for('deletar_animal', animal_id=a.id) }}"
                            method="POST"
                            class="js-animal-delete-form d-inline"
                            data-sync
                            data-confirm="Tem certeza que deseja remover este animal?"
                            data-animal-id="{{ a.id }}"
                            data-animal-name="{{ a.name }}"
                            data-animal-species="{{ a.species }}"
                            data-animal-breed="{{ a.breed }}">
                        <button type="submit" class="btn btn-outline-danger btn-sm">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
                {% if active_animals|length == 0 %}
                <tr data-empty-state>
                  <td colspan="4" class="text-muted text-center py-4">Nenhum animal cadastrado.</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          {% if removed_animals %}
          <div class="removed-animals mt-3">
            <button class="btn btn-link text-muted p-0" onclick="document.getElementById('removidos-wrapper').classList.toggle('d-none')">
              Mostrar/Esconder animais removidos
            </button>
            <div id="removidos-wrapper" class="d-none mt-2">
              <div class="border rounded p-3 bg-light-subtle">
                <h6 class="text-danger d-flex align-items-center gap-2 mb-3"><i class="fas fa-box-archive"></i> Animais Removidos</h6>
                <ul class="list-group list-group-flush">
                  {% for r in removed_animals %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><strong>{{ r.name }}</strong> ‚Äî {{ r.species }} / {{ r.breed }}</span>
                    <form action="{{ url_for('deletar_animal', animal_id=r.id) }}"
                          method="POST"
                          class="js-animal-delete-form d-inline"
                          data-sync
                          data-confirm="Excluir permanentemente {{ r.name }}?"
                          data-animal-id="{{ r.id }}"
                          data-animal-name="{{ r.name }}"
                          data-animal-species="{{ r.species }}"
                          data-animal-breed="{{ r.breed }}"
                          data-removed-item="true">
                      <button type="submit" class="btn btn-sm btn-danger">‚ùå Excluir Definitivamente</button>
                    </form>
                  </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- =========================  MODAIS DE EDI√á√ÉO  ========================= -->
{% for a in animais %}
<div class="modal fade" id="modalEditarAnimal{{ a.id }}" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <form id="animal-form-{{ a.id }}" action="{{ url_for('update_animal', animal_id=a.id) }}" method="POST" enctype="multipart/form-data" data-sync class="animal-update-form" data-animal-id="{{ a.id }}">
        {{ animal_forms[a.id].hidden_tag() }}
        <div class="modal-header">
          <h5 class="modal-title">‚úèÔ∏è Editar {{ a.name }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">

            <div class="col-12 text-center">
              {{ photo_cropper(animal_forms[a.id].image, animal_forms[a.id].photo_rotation, animal_forms[a.id].photo_zoom, animal_forms[a.id].photo_offset_x, animal_forms[a.id].photo_offset_y, a.image, 150, 'animal-image-' ~ a.id, 'animal') }}
            </div>

            <div class="col-md-6">
              <label class="form-label">Nome</label>
              <input name="name" class="form-control" value="{{ a.name or '' }}" required>
            </div>


          <div class="col-md-3">
            <label class="form-label">Esp√©cie</label>
            <select name="species_id" id="species-select-{{ a.id }}" class="form-select" required onchange="updateBreedOptions('{{ a.id }}')">
              <option value="">Selecione</option>
              {% for sp in species_list %}
                <option value="{{ sp.id }}" {% if a.species and a.species.id == sp.id %}selected{% endif %}>{{ sp.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Ra√ßa</label>
            <select name="breed_id" id="breed-select-{{ a.id }}" class="form-select">
              <option value="">Selecione</option>
              {% if a.breed %}
                <option value="{{ a.breed.id }}" selected>{{ a.breed.name }}</option>
              {% endif %}
            </select>
          </div>




            <div class="col-md-3">
              <label class="form-label">Sexo</label>
              <select name="sex" class="form-select">
                <option value="">‚Äî</option>
                <option value="Macho" {% if a.sex == 'Macho' %}selected{% endif %}>Macho</option>
                <option value="F√™mea" {% if a.sex == 'F√™mea' %}selected{% endif %}>F√™mea</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Data de Nascimento</label>
              <input type="date" name="date_of_birth" class="form-control"
                     value="{{ a.date_of_birth.strftime('%Y-%m-%d') if a.date_of_birth else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Microchip</label>
              <input name="microchip_number" class="form-control" value="{{ a.microchip_number or '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Peso (kg)</label>
              <input name="peso" type="number" step="0.01" class="form-control" value="{{ '' if a.peso is none else a.peso }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Plano de Sa√∫de</label>
              <input name="health_plan" class="form-control" value="{{ a.health_plan or '' }}">
            </div>
            <div class="col-12">
              <label class="form-label">Descri√ß√£o</label>
              <textarea name="description" class="form-control">{{ a.description or '' }}</textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Castrado?</label>
              <select name="neutered" class="form-select">
                <option value="">‚Äî</option>
                <option value="1" {% if a.neutered %}selected{% endif %}>Sim</option>
                <option value="0" {% if a.neutered == False %}selected{% endif %}>N√£o</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary rounded-pill px-4 shadow-sm" data-bs-dismiss="modal">
            ‚ùå Cancelar
          </button>
          <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">
            üíæ Salvar Altera√ß√µes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}







<!-- =========================  MODAL: NOVO ANIMAL  ========================= -->
<div class="modal fade" id="modalNovoAnimal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‚ûï Novo Animal para {{ tutor.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('novo_animal') }}" method="POST" enctype="multipart/form-data">
        {{ new_animal_form.hidden_tag() }}
        <div class="modal-body">
          <input type="hidden" name="tutor_id" value="{{ tutor.id }}">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nome</label>
              <input name="name" class="form-control" required>
            </div>

            <div class="col-md-3">
              <label class="form-label">Esp√©cie</label>
              <select name="species_id" id="species-select" class="form-select" required onchange="updateBreedOptions()">
                <option value="">Selecione</option>
                {% for sp in species_list %}
                  <option value="{{ sp.id }}">{{ sp.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label">Ra√ßa</label>
              <select name="breed_id" id="breed-select" class="form-select">
                <option value="">Selecione</option>
              </select>
            </div>



            <div class="col-md-3">
              <label class="form-label">Sexo</label>
              <select name="sex" class="form-select">
                <option value="">‚Äî</option>
                <option value="Macho">Macho</option>
                <option value="F√™mea">F√™mea</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Data de Nascimento</label>
              <input id="animal_dob" name="date_of_birth" type="text" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Idade</label>
              <input id="animal_age" type="number" class="form-control" min="0">
            </div>
            <div class="col-md-3">
              <label class="form-label">Microchip</label>
              <input name="microchip_number" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Peso (kg)</label>
              <input name="peso" type="number" step="0.01" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Plano de Sa√∫de</label>
              <input name="health_plan" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Foto do Animal</label>
              {{ photo_cropper(new_animal_form.image, new_animal_form.photo_rotation, new_animal_form.photo_zoom, new_animal_form.photo_offset_x, new_animal_form.photo_offset_y, '', 150, 'new-animal-image', 'animal') }}
            </div>
            <div class="col-12">
              <label class="form-label">Descri√ß√£o</label>
              <textarea name="description" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Castrado?</label>
              <select name="neutered" class="form-select">
                <option value="">‚Äî</option>
                <option value="1">Sim</option>
                <option value="0">N√£o</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary rounded-pill px-4 shadow-sm" data-bs-dismiss="modal">
            ‚ùå Cancelar
          </button>
          <button type="submit" class="btn btn-success rounded-pill px-4 shadow-sm">
            üíæ Salvar Animal
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Flatpickr CSS e JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<script src="{{ url_for('static', filename='js/date_mask.js') }}"></script>




<script>
  const breedMap = {{ breed_map | tojson }};

  function updateBreedOptions(animalId = null) {
    const speciesSelect = animalId
      ? document.getElementById(`species-select-${animalId}`)
      : document.getElementById("species-select");

    const breedSelect = animalId
      ? document.getElementById(`breed-select-${animalId}`)
      : document.getElementById("breed-select");

    if (!speciesSelect || !breedSelect) return;

    const selectedSpeciesId = speciesSelect.value.toString();
    const breeds = breedMap[selectedSpeciesId] || [];

    // Limpa op√ß√µes anteriores
    breedSelect.innerHTML = '<option value="">Selecione</option>';

    // Adiciona ra√ßas da esp√©cie
    breeds.forEach(b => {
      const option = document.createElement('option');
      option.value = b.id;
      option.textContent = b.name;
      breedSelect.appendChild(option);
    });
  }



  // ========== ANIMAL: Date <-> Age ==========
  const animalDob = document.getElementById("animal_dob");
  const animalAge = document.getElementById("animal_age");

  if (animalDob && animalAge) {
    const animalPicker = flatpickr(animalDob, {
      locale: "pt",
      dateFormat: "Y-m-d",
      altInput: true,
      altFormat: "d/m/Y",
      allowInput: false,
      onReady(selectedDates) {
        if (selectedDates.length) {
          updateAgeFromDob(animalAge, selectedDates[0]);
        } else {
          updateAgeFromDob(animalAge, null);
        }
      },
      onChange(selectedDates) {
        updateAgeFromDob(animalAge, selectedDates[0] || null);
      }
    });

    animalAge.addEventListener("input", () => {
      const age = parseInt(animalAge.value, 10);
      if (Number.isNaN(age)) {
        if (animalAge.value.trim() === "") {
          animalPicker.clear();
          updateAgeFromDob(animalAge, null);
        }
        return;
      }

      const estimatedDOB = getDobFromAge(age);
      animalPicker.setDate(estimatedDOB, true);
    });
  }

  // ========== TUTOR: Date <-> Age ==========
  const tutorDob = document.getElementById("tutor_dob");
  const tutorAge = document.getElementById("tutor_age");

  if (tutorDob && tutorAge) {
    const tutorPicker = flatpickr(tutorDob, {
      locale: "pt",
      dateFormat: "Y-m-d",
      altInput: true,
      altFormat: "d/m/Y",
      allowInput: true,
      onReady(selectedDates, dateStr, instance) {
        if (window.DateMaskUtils) {
          window.DateMaskUtils.syncMaskedInput(instance, {
            onDateSync: (date) => updateAgeFromDob(tutorAge, date),
            onClear: () => updateAgeFromDob(tutorAge, null),
          });
        }

        if (selectedDates.length) {
          updateAgeFromDob(tutorAge, selectedDates[0]);
        } else {
          updateAgeFromDob(tutorAge, null);
        }
      },
      onChange(selectedDates) {
        updateAgeFromDob(tutorAge, selectedDates[0] || null);
      }
    });

    tutorAge.addEventListener("input", () => {
      const age = parseInt(tutorAge.value, 10);
      if (Number.isNaN(age)) {
        if (tutorAge.value.trim() === "") {
          tutorPicker.clear();
          updateAgeFromDob(tutorAge, null);
        }
        return;
      }

      const estimatedDOB = getDobFromAge(age);
      tutorPicker.setDate(estimatedDOB, true);
    });
  }

  // ========== Auxiliares ==========
  function updateAgeFromDob(targetInput, dob) {
    if (!dob) {
      targetInput.value = "";
      return;
    }

    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
      age--;
    }
    targetInput.value = Math.max(age, 0);
  }

  function getDobFromAge(age) {
    const today = new Date();
    return new Date(today.getFullYear() - age, today.getMonth(), today.getDate());
  }

</script>

<script>
document.addEventListener('form-sync-success', function(ev) {
  const {form, data, response} = ev.detail || {};
  if (!form) return;

  const hadError = (data && data.success === false) || (response && !response.ok);
  if (hadError) {
    return;
  }

  if (form.id === 'tutor-form') {
    ev.preventDefault();
    const successMessage = (data && data.message) || 'Dados do tutor atualizados com sucesso!';
    if (window.FormFeedback && typeof window.FormFeedback.showStatus === 'function') {
      window.FormFeedback.showStatus(form, successMessage, 'success');
    } else {
      const statusEl = form.querySelector('.form-status-message');
      if (statusEl) {
        statusEl.textContent = successMessage;
        statusEl.classList.remove('d-none');
        statusEl.classList.add('alert', 'alert-success');
      }
    }

    const tutorPayload = data && data.tutor;
    if (tutorPayload) {
      const preview = document.getElementById('preview-tutor');
      if (preview) {
        if (tutorPayload.profile_photo) {
          preview.src = typeof cacheBust === 'function'
            ? cacheBust(tutorPayload.profile_photo)
            : tutorPayload.profile_photo;
          preview.classList.remove('d-none');
        }
        if (typeof tutorPayload.photo_offset_x !== 'undefined') preview.dataset.offsetX = tutorPayload.photo_offset_x;
        if (typeof tutorPayload.photo_offset_y !== 'undefined') preview.dataset.offsetY = tutorPayload.photo_offset_y;
        if (typeof tutorPayload.photo_rotation !== 'undefined') preview.dataset.rotation = tutorPayload.photo_rotation;
        if (typeof tutorPayload.photo_zoom !== 'undefined') preview.dataset.zoom = tutorPayload.photo_zoom;
        if (typeof updateAvatarTransform === 'function') {
          const offsetX = parseFloat(preview.dataset.offsetX) || 0;
          const offsetY = parseFloat(preview.dataset.offsetY) || 0;
          const rotation = parseFloat(preview.dataset.rotation) || 0;
          const zoom = parseFloat(preview.dataset.zoom) || 1;
          updateAvatarTransform(preview, offsetX, offsetY, rotation, zoom);
        }
      }

      const cropperPreview = document.querySelector('#profile_photo-preview img');
      if (cropperPreview && tutorPayload.profile_photo) {
        cropperPreview.src = typeof cacheBust === 'function'
          ? cacheBust(tutorPayload.profile_photo)
          : tutorPayload.profile_photo;
      }
    }
    if (data && data.tutor_name) {
      const heading = document.getElementById('animais-heading');
      if (heading) {
        heading.textContent = `üêæ Animais de ${data.tutor_name.split(' ')[0]}`;
      }
    }
  } else if (form.classList.contains('animal-update-form')) {
    ev.preventDefault();
    const id = form.dataset.animalId;
    if (id) {
      const row = document.getElementById(`animal-row-${id}`);
      if (row) {
        const nameCell = row.querySelector('.animal-name');
        const speciesCell = row.querySelector('.animal-species');
        const sexCell = row.querySelector('.animal-sex');
        if (nameCell && data && data.animal_name) nameCell.textContent = data.animal_name;
        if (speciesCell) {
          const speciesSel = form.querySelector('select[name="species_id"]');
          const breedSel = form.querySelector('select[name="breed_id"]');
          const speciesText = speciesSel ? speciesSel.options[speciesSel.selectedIndex].textContent : '';
          const breedText = breedSel ? breedSel.options[breedSel.selectedIndex].textContent : '';
          speciesCell.textContent = `${speciesText} / ${breedText}`;
        }
        if (sexCell) {
          const sexSel = form.querySelector('select[name="sex"]');
          sexCell.textContent = sexSel ? (sexSel.value || '‚Äî') : '‚Äî';
        }
      }
    }
    const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
    modal?.hide();
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/tutor_detail.js') }}"></script>
{% endblock %}
