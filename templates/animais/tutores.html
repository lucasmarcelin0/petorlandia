{% extends 'layout.html' %}
{% block main %}
<div class="container py-4">

  <h2 class="mb-4">üë• Tutores</h2>

  <!-- üîç Busca de tutor -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">üîç Buscar Tutor</h5>
      {% with
        id_prefix='tutor-list',
        label='Buscar Tutor',
        placeholder='Digite nome, e-mail, CPF ou telefone',
        redirect_template='/ficha_tutor/{id}'
      %}
        {% include 'components/tutor_search.html' %}
      {% endwith %}
    </div>
  </div>

  <hr>

  <!-- ‚ûï Cadastro de novo tutor -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title mb-3">‚ûï Cadastrar Novo Tutor</h5>

      <form id="novo-tutor-form" method="POST" action="{{ url_for('tutores') }}" class="js-tutor-form" data-sync="true">
        <div class="row">
          <div class="mb-3 col-md-6">
            <label class="form-label">Nome</label>
            <input name="name" class="form-control" required>
          </div>
          <div class="mb-3 col-md-6">
            <label class="form-label">E‚Äëmail</label>
            <input name="email" type="email" class="form-control" required>
          </div>
          <div class="mb-3 col-md-6">
            <label class="form-label">Telefone</label>
            <input name="phone" class="form-control">
          </div>


          <div class="mb-3 col-md-6">
            <label class="form-label">CPF</label>
            <input name="cpf" class="form-control">
          </div>
          <div class="mb-3 col-md-6">
            <label class="form-label">RG</label>
            <input name="rg" class="form-control">
          </div>

          <!-- Data e idade -->
          <div class="mb-3 col-md-6">
            <label class="form-label">Data de Nascimento</label>
            <input id="date_of_birth" name="date_of_birth" type="text" class="form-control">
          </div>
          <div class="mb-3 col-md-6">
            <label class="form-label">Idade</label>
            <input id="age" type="number" class="form-control" min="0">
          </div>
        </div>

                  
          <!-- Novo endere√ßo com CEP -->
          <div class="col-12">
            {% include "partials/endereco_form.html" %}
          </div>

        <button class="btn btn-primary btn-lg" data-original="üíæ Salvar e abrir ficha">üíæ Salvar e abrir ficha</button>
      </form>
    </div>
  </div>

</div>

<div id="tutores-adicionados">
{% include 'partials/tutores_adicionados.html' %}
</div>



<!-- ‚ú® Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

<!-- Script geral -->
<script>
  if (document.readyState !== 'loading') {
    window.TutorSearch?.initAll();
  } else {
    document.addEventListener('DOMContentLoaded', () => window.TutorSearch?.initAll());
  }

  // Flatpickr + Sincroniza√ß√£o idade
  const dobInput = document.getElementById("date_of_birth");
  const ageInput = document.getElementById("age");

  flatpickr(dobInput, {
    locale: "pt",
    dateFormat: "Y-m-d",       // valor REAL enviado ao backend
    altInput: true,
    altFormat: "d/m/Y",        // valor VISUAL ao usu√°rio
    allowInput: true,
    onChange: function(selectedDates) {
      if (selectedDates.length) {
        const dob = selectedDates[0];
        const today = new Date();
        let age = today.getFullYear() - dob.getFullYear();
        const m = today.getMonth() - dob.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
          age--;
        }
        ageInput.value = age;
      }
    }
  });

  ageInput.addEventListener("input", () => {
    const age = parseInt(ageInput.value);
    if (!isNaN(age)) {
      const today = new Date();
      const estimatedDOB = new Date(today.getFullYear() - age, today.getMonth(), today.getDate());
      dobInput._flatpickr.setDate(estimatedDOB);  // sincroniza no flatpickr
    }
  });
</script>
{% endblock %}
