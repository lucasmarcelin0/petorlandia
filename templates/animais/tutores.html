{% extends 'layout.html' %}
{% block main %}
<div class="container py-4">

  <h2 class="mb-4">üë• Tutores</h2>

  <!-- üîç Busca de tutor -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">üîç Buscar Tutor</h5>
      <input id="busca-tutor" class="form-control" placeholder="Digite nome, e‚Äëmail, CPF ou telefone" aria-controls="lista-tutores">
      <ul id="lista-tutores" class="list-group mt-2 d-none" role="listbox"></ul>
      <span id="lista-tutores-status" class="visually-hidden" aria-live="polite" aria-atomic="true"></span>
    </div>
  </div>

  <hr>

  <!-- ‚ûï Cadastro de novo tutor -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title mb-3">‚ûï Cadastrar Novo Tutor</h5>

      <form id="novo-tutor-form" method="POST" action="{{ url_for('tutores') }}" class="js-tutor-form" data-sync="true">
        <div class="row">
          <div class="mb-3 col-md-6">
            <label class="form-label">Nome</label>
            <input name="name" class="form-control" required>
          </div>
          <div class="mb-3 col-md-6">
            <label class="form-label">E‚Äëmail</label>
            <input name="email" type="email" class="form-control" required>
          </div>
          <div class="mb-3 col-md-6">
            <label class="form-label">Telefone</label>
            <input name="phone" class="form-control">
          </div>


          <div class="mb-3 col-md-6">
            <label class="form-label">CPF</label>
            <input name="cpf" class="form-control">
          </div>
          <div class="mb-3 col-md-6">
            <label class="form-label">RG</label>
            <input name="rg" class="form-control">
          </div>

          <!-- Data e idade -->
          <div class="mb-3 col-md-6">
            <label class="form-label">Data de Nascimento</label>
            <input id="date_of_birth" name="date_of_birth" type="text" class="form-control">
          </div>
          <div class="mb-3 col-md-6">
            <label class="form-label">Idade</label>
            <input id="age" type="number" class="form-control" min="0">
          </div>
        </div>

                  
          <!-- Novo endere√ßo com CEP -->
          <div class="col-12">
            {% include "partials/endereco_form.html" %}
          </div>

        <button class="btn btn-primary btn-lg" data-original="üíæ Salvar e abrir ficha">üíæ Salvar e abrir ficha</button>
      </form>
    </div>
  </div>

</div>

<div id="tutores-adicionados">
{% include 'partials/tutores_adicionados.html' %}
</div>



<!-- ‚ú® Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

<!-- Script geral -->
<script type="module">
  import { setupTutorSearch } from "{{ url_for('static', filename='js/tutor_search.js') }}";

  const inputTutor = document.getElementById('busca-tutor');
  const listaTutor = document.getElementById('lista-tutores');
  const listaStatus = document.getElementById('lista-tutores-status');

  if (inputTutor && listaTutor) {
    const search = setupTutorSearch({
      input: inputTutor,
      resultsList: listaTutor,
      statusElement: listaStatus,
      formatTutor: (tutor) => {
        let texto = tutor.name || '';
        if (tutor.email) {
          texto += ` (${tutor.email})`;
        }
        if (tutor.specialties) {
          texto += ` ‚Äì ${tutor.specialties}`;
        }
        return texto;
      },
      onTutorSelected: (tutor) => {
        window.location = `/ficha_tutor/${tutor.id}`;
      },
    });

    document.addEventListener('click', (event) => {
      if (!inputTutor.contains(event.target) && !listaTutor.contains(event.target)) {
        search.hideResults();
      }
    });
  }

  // Flatpickr + Sincroniza√ß√£o idade
  const dobInput = document.getElementById("date_of_birth");
  const ageInput = document.getElementById("age");

  flatpickr(dobInput, {
    locale: "pt",
    dateFormat: "Y-m-d",       // valor REAL enviado ao backend
    altInput: true,
    altFormat: "d/m/Y",        // valor VISUAL ao usu√°rio
    allowInput: true,
    onChange: function(selectedDates) {
      if (selectedDates.length) {
        const dob = selectedDates[0];
        const today = new Date();
        let age = today.getFullYear() - dob.getFullYear();
        const m = today.getMonth() - dob.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
          age--;
        }
        ageInput.value = age;
      }
    }
  });

  ageInput.addEventListener("input", () => {
    const age = parseInt(ageInput.value);
    if (!isNaN(age)) {
      const today = new Date();
      const estimatedDOB = new Date(today.getFullYear() - age, today.getMonth(), today.getDate());
      dobInput._flatpickr.setDate(estimatedDOB);  // sincroniza no flatpickr
    }
  });
</script>
{% endblock %}
