{% extends "layout.html" %}

{% block main %}
<div class="container mt-4">
  <h2>Agenda de Consultas</h2>

  <div id="appointments-calendar" class="mb-4"></div>

  {% if form %}
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Agendar Consulta</h5>
      <form method="POST">
        {{ form.hidden_tag() }}
        <div class="mb-3">
          {{ form.animal_id.label(class="form-label") }}
          {{ form.animal_id(class="form-select") }}
        </div>
        <div class="mb-3">
          {{ form.veterinario_id.label(class="form-label") }}
          {{ form.veterinario_id(class="form-select") }}
        </div>
        <div class="mb-3">
          {{ form.date.label(class="form-label") }}
          {{ form.date(class="form-control", type="date") }}
        </div>
        <div class="mb-3">
          {{ form.time.label(class="form-label") }}
          {{ form.time(class="form-control", type="time") }}
        </div>
        <div class="mb-3">
          {{ form.reason.label(class="form-label") }}
          {{ form.reason(class="form-control", rows=3) }}
        </div>
        {{ form.submit(class="btn btn-primary") }}
      </form>
    </div>
  </div>
  {% endif %}

  {% include 'partials/appointments_table.html' %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('appointments-calendar');
  if (calendarEl) {
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      selectable: true,
      editable: true,
      events: '/api/events',
      eventClick: function(info) {
        if (confirm('Remover este evento?')) {
          fetch('/api/events/' + info.event.id, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token() if csrf_token is defined else '' }}'
            }
          })
          .then(function(response) {
            if (!response.ok) throw new Error('Erro ao remover evento');
            calendar.refetchEvents();
          })
          .catch(function(error) {
            console.error(error);
          });
        }
      },
      select: function(info) {
        var eventData = {
          title: 'Novo Evento',
          start: info.startStr,
          end: info.endStr
        };
        fetch('/api/events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() if csrf_token is defined else '' }}'
          },
          body: JSON.stringify(eventData)
        })
        .then(function(response) {
          if (!response.ok) throw new Error('Erro ao criar evento');
          return response.json();
        })
        .then(function(data) {
          calendar.refetchEvents();
        })
        .catch(function(error) {
          console.error(error);
        });
      },
      eventDrop: function(info) {
        var updatedData = {
          start: info.event.startStr,
          end: info.event.endStr
        };
        fetch('/api/events/' + info.event.id, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() if csrf_token is defined else '' }}'
          },
          body: JSON.stringify(updatedData)
        })
        .then(function(response) {
          if (!response.ok) throw new Error('Erro ao atualizar evento');
          calendar.refetchEvents();
        })
        .catch(function(error) {
          console.error(error);
        });
      }
    });
    calendar.render();
  }
});
</script>
{% endblock %}
