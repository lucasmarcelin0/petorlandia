{% extends "layout.html" %}
{% import 'macros/ui.html' as ui %}
{% block main %}
<div class="ui-chat">
  <h2>Chat sobre {{ animal.name }}</h2>
  <div id="messages" class="ui-chat__messages ui-scrollable ui-scrollable--md"></div>
  <form id="chat-form" class="d-flex gap-2 align-items-start">
    {{ ui.ui_input(id='content', placeholder='Digite sua mensagem...', wrapper_classes='flex-grow-1', input_attrs={'name': 'content', 'required': True}) }}
    {{ ui.ui_button('Enviar', type='submit', variant='primary', extra_classes='align-self-stretch') }}
  </form>
</div>
<script>
const animalId = {{ animal.id }};
const currentUserId = {{ current_user.id }};
const receiverId = {{ animal.owner.id }};
async function loadMessages() {
    const resp = await fetch(`/chat/${animalId}`);
    const msgs = await resp.json();
    const container = document.getElementById('messages');
    container.innerHTML = '';
    msgs.forEach(m => {
        const outgoing = m.sender_id === currentUserId;
        const wrapper = document.createElement('div');
        wrapper.className = 'd-flex flex-column mb-2 ' + (outgoing ? 'align-items-end' : 'align-items-start');
        wrapper.innerHTML = `<div class="ui-chat__bubble ${outgoing ? 'ui-chat__bubble--outgoing text-end' : 'ui-chat__bubble--incoming'}">
            <small>${outgoing ? 'VocÃª' : 'Eles'}:</small><br>
            ${m.content}
            <div class="ui-text-muted small mt-1">${new Date(m.timestamp).toLocaleString()}</div>
        </div>`;
        container.appendChild(wrapper);
    });
    container.scrollTop = container.scrollHeight;
}
document.getElementById('chat-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = document.getElementById('content').value.trim();
    if (!content) return;
    await fetch(`/chat/${animalId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sender_id: currentUserId, receiver_id: receiverId, content})
    });
    document.getElementById('content').value = '';
    loadMessages();
});
loadMessages();
setInterval(loadMessages, 3000);
</script>
{% endblock %}
