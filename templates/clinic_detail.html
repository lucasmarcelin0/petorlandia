{% extends "layout.html" %}
{% from 'components/photo_cropper.html' import photo_cropper %}

{% block main %}
<div class="container mt-4">
  <h2>{{ clinica.nome }}</h2>
  {% if clinica.logotipo %}
  <img src="{{ clinica.logotipo }}" alt="Imagem da Cl√≠nica" class="img-fluid mb-3" style="max-height: 200px; object-fit: cover; transform: translate({{ clinica.photo_offset_x or 0 }}px, {{ clinica.photo_offset_y or 0 }}px) rotate({{ clinica.photo_rotation or 0 }}deg) scale({{ clinica.photo_zoom or 1 }});">
  {% endif %}
  {% if clinica.endereco %}<p><strong>Endere√ßo:</strong> {{ clinica.endereco }}</p>{% endif %}
  {% if clinica.telefone %}<p><strong>Telefone:</strong> {{ clinica.telefone }}</p>{% endif %}
  {% if clinica.email %}<p><strong>Email:</strong> {{ clinica.email }}</p>{% endif %}

  {% if pode_editar %}
  <button class="btn btn-secondary mt-3" onclick="toggleEditInfo()">Editar Informa√ß√µes</button>
  <div id="edit-info" class="mt-4" style="display: none;">
    <form method="post" class="mb-4" enctype="multipart/form-data">
      {{ clinic_form.hidden_tag() }}
      <div class="mb-3">
        {{ clinic_form.nome.label }}
        {{ clinic_form.nome(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ clinic_form.cnpj.label }}
        {{ clinic_form.cnpj(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ clinic_form.endereco.label }}
        {{ clinic_form.endereco(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ clinic_form.telefone.label }}
        {{ clinic_form.telefone(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ clinic_form.email.label }}
        {{ clinic_form.email(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ clinic_form.logotipo.label }}
        {{ photo_cropper(clinic_form.logotipo, clinic_form.photo_rotation, clinic_form.photo_zoom, clinic_form.photo_offset_x, clinic_form.photo_offset_y, clinica.logotipo, 150, 'clinic_logo', 'user') }}
      </div>
      {{ clinic_form.submit(class="btn btn-primary") }}
    </form>
  </div>
  {% endif %}

  <h3>Hor√°rios de Atendimento</h3>
  <table class="table">
    <thead>
      <tr><th>Dia</th><th>Abre</th><th>Fecha</th>{% if pode_editar %}<th>A√ß√µes</th>{% endif %}</tr>
    </thead>
    <tbody>
      {% for h in horarios %}
        <tr>
          <td>{{ h.dia_semana }}</td>
          <td>{{ h.hora_abertura.strftime('%H:%M') }}</td>
          <td>{{ h.hora_fechamento.strftime('%H:%M') }}</td>
          {% if pode_editar %}
          <td>
            <form method="post" action="{{ url_for('delete_clinic_hour', clinica_id=clinica.id, horario_id=h.id) }}" class="d-inline">
              {{ form.csrf_token }}
              <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Excluir este hor√°rio?');">Excluir</button>
            </form>
          </td>
          {% endif %}
        </tr>
      {% else %}
        <tr><td colspan="{% if pode_editar %}4{% else %}3{% endif %}">Nenhum hor√°rio cadastrado.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  {% if pode_editar %}
    <button class="btn btn-secondary mt-3" onclick="toggleEditHours()">Editar Hor√°rios</button>
    <div id="edit-hours" class="mt-4" style="display: none;">
      <form method="post" class="mb-4">
        {{ form.hidden_tag() }}
      <div class="mb-3">
        {{ form.clinica_id.label }}
        {{ form.clinica_id(class="form-select") }}
      </div>
      <div class="mb-3">
        {{ form.dias_semana.label }}
        {{ form.dias_semana(class="form-select", multiple=True, size=7) }}
        <div class="mt-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('all')">Todos</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('weekday')">Dias √öteis</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('weekend')">Fins de Semana</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('clear')">Limpar</button>
        </div>
      </div>
      <div class="mb-3">
        {{ form.hora_abertura.label }}
        {{ form.hora_abertura(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ form.hora_fechamento.label }}
        {{ form.hora_fechamento(class="form-control") }}
      </div>
      {{ form.submit(class="btn btn-primary") }}
    </form>
  </div>
  {% endif %}

  <h3>Veterin√°rios</h3>
  <ul class="list-unstyled">
    {% for v in veterinarios %}
      <li>
        {{ v.user.name }} (CRMV: {{ v.crmv }})
        <ul class="ms-3">
          {% for h in v.horarios %}
            <li>{{ h.dia_semana }}: {{ h.hora_inicio.strftime('%H:%M') }} - {{ h.hora_fim.strftime('%H:%M') }}</li>
          {% else %}
            <li>Sem hor√°rios cadastrados.</li>
          {% endfor %}
        </ul>
      </li>
    {% else %}
      <li>Nenhum veterin√°rio associado.</li>
    {% endfor %}
  </ul>
  {% if pode_editar and vets_form.veterinario_id.choices %}
  <form method="post" class="mb-4">
    {{ vets_form.hidden_tag() }}
    <div class="mb-3">
      {{ vets_form.veterinario_id.label }}
      {{ vets_form.veterinario_id(class="form-select") }}
    </div>
    {{ vets_form.submit(class="btn btn-primary") }}
  </form>
  {% endif %}

  <h3>Agendamentos</h3>
  <div id="clinic-calendar" class="mb-4"></div>
  <table class="table">
    <thead>
      <tr>
        <th>Data</th>
        <th>Animal</th>
        <th>Veterin√°rio</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      {% for a in appointments %}
        <tr>
          <td>{{ a.scheduled_at|format_datetime_brazil }}</td>
          <td>{{ a.animal.name }}</td>
          <td>{{ a.veterinario.user.name }}</td>
          <td>
            <div class="btn-group">
              <a href="{{ url_for('ficha_animal', animal_id=a.animal_id) }}" class="btn btn-sm btn-outline-primary">üìã Ficha Animal</a>
              <a href="{{ url_for('ficha_tutor', tutor_id=a.tutor_id) }}" class="btn btn-sm btn-outline-secondary">üë§ Ficha Tutor</a>
              {% if current_user.worker in ['veterinario', 'colaborador'] %}
              <a href="{{ url_for('consulta_direct', animal_id=a.animal_id) }}" class="btn btn-sm btn-outline-success">ü©∫ Iniciar Consulta</a>
              {% endif %}
            </div>
          </td>
        </tr>
      {% else %}
        <tr><td colspan="4">Nenhum agendamento encontrado.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modais da agenda -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar Evento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p>Formul√°rio de edi√ß√£o aqui.</p>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="newEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Novo Evento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p>Formul√°rio de cria√ß√£o aqui.</p>
      </div>
    </div>
  </div>
</div>

<script>
function toggleEditInfo() {
  const section = document.getElementById('edit-info');
  section.style.display = section.style.display === 'none' ? 'block' : 'none';
}
function toggleEditHours() {
  const section = document.getElementById('edit-hours');
  section.style.display = section.style.display === 'none' ? 'block' : 'none';
}
function selectDays(mode) {
  const select = document.getElementById('dias_semana');
  const weekdays = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta'];
  const weekend = ['S√°bado','Domingo'];
  for (const opt of select.options) {
    if (mode === 'all') opt.selected = true;
    else if (mode === 'weekday') opt.selected = weekdays.includes(opt.value);
    else if (mode === 'weekend') opt.selected = weekend.includes(opt.value);
    else if (mode === 'clear') opt.selected = false;
  }
}

</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('clinic-calendar');
  if (calendarEl) {
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      selectable: true,
      events: '/api/events',
      eventClick: function(info) {
        var modal = new bootstrap.Modal(document.getElementById('eventModal'));
        modal.show();
      },
      select: function(info) {
        var modal = new bootstrap.Modal(document.getElementById('newEventModal'));
        modal.show();
      }
    });
    calendar.render();
  }
});
</script>
{% endblock %}
