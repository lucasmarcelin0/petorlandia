{% extends "layout.html" %}
{% from 'components/photo_cropper.html' import photo_cropper %}

{% block main %}
<div class="container mt-4">
  <ul class="nav nav-tabs mb-4 rounded shadow-sm bg-white pet-nav" id="clinicTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active d-flex align-items-center gap-2" id="clinica-tab" data-bs-toggle="tab" data-bs-target="#clinica" type="button" role="tab">
        <span class="icon-circle bg-secondary text-white"><i class="fa-solid fa-building"></i></span>
        <span class="fw-semibold">Clínica</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link d-flex align-items-center gap-2" id="veterinarios-tab" data-bs-toggle="tab" data-bs-target="#veterinarios" type="button" role="tab">
        <span class="icon-circle bg-primary text-white"><i class="fa-solid fa-users"></i></span>
        <span class="fw-semibold">Funcionários</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link d-flex align-items-center gap-2" id="agendamentos-tab" data-bs-toggle="tab" data-bs-target="#agendamentos" type="button" role="tab">
        <span class="icon-circle bg-success text-white"><i class="fa-solid fa-calendar"></i></span>
        <span class="fw-semibold">Agenda</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link d-flex align-items-center gap-2" id="animais-tab" data-bs-toggle="tab" data-bs-target="#animais" type="button" role="tab">
        <span class="icon-circle bg-danger text-white"><i class="fa-solid fa-paw"></i></span>
        <span class="fw-semibold">Animais</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link d-flex align-items-center gap-2" id="tutores-tab" data-bs-toggle="tab" data-bs-target="#tutores" type="button" role="tab">
        <span class="icon-circle bg-info text-white"><i class="fa-solid fa-user"></i></span>
        <span class="fw-semibold">Tutores</span>
      </button>
    </li>
    {% if show_inventory %}
    <li class="nav-item" role="presentation">
      <button class="nav-link d-flex align-items-center gap-2" id="estoque-tab" data-bs-toggle="tab" data-bs-target="#estoque" type="button" role="tab">
        <span class="icon-circle bg-warning text-dark"><i class="fa-solid fa-boxes"></i></span>
        <span class="fw-semibold">Estoque</span>
      </button>
    </li>
    {% endif %}
    <li class="nav-item" role="presentation">
      <button class="nav-link d-flex align-items-center gap-2" id="orcamento-tab" data-bs-toggle="tab" data-bs-target="#orcamento" type="button" role="tab">
        <span class="icon-circle bg-dark text-white"><i class="fa-solid fa-file-invoice-dollar"></i></span>
        <span class="fw-semibold">Orçamento</span>
      </button>
    </li>
  </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="clinica" role="tabpanel">
        {% include 'partials/clinic_info.html' %}
      </div>
      <div class="tab-pane fade" id="veterinarios" role="tabpanel">
        {% include 'partials/clinic_veterinarios_tab.html' %}
      </div>

      <div class="tab-pane fade" id="agendamentos" role="tabpanel">
        {% include 'partials/clinic_agendamentos_tab.html' %}
      </div>
      <div class="tab-pane fade" id="animais" role="tabpanel">
        {% include 'partials/clinic_animais_tab.html' %}
      </div>
      <div class="tab-pane fade" id="tutores" role="tabpanel">
        {% include 'partials/clinic_tutores_tab.html' %}
      </div>
    {% if show_inventory %}
      <div class="tab-pane fade" id="estoque" role="tabpanel">
        {% include 'partials/clinic_estoque_tab.html' %}
      </div>
    {% endif %}
      <div class="tab-pane fade" id="orcamento" role="tabpanel">
        {% include 'partials/clinic_orcamento_tab.html' %}
      </div>
  </div>
</div>

<!-- Modais da agenda -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar Evento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p>Formulário de edição aqui.</p>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="newEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Novo Evento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p>Formulário de criação aqui.</p>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="appointmentEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar Consulta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body"></div>
    </div>
  </div>
</div>

<script>
  function toggleEditInfo() {
    const section = document.getElementById('edit-info');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
  }
  function toggleEditHours() {
    const section = document.getElementById('edit-hours');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
  }
  function toggleVetOptions(id) {
    const section = document.getElementById(`vet-options-${id}`);
    if (section) {
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }
  }
  function toggleStaffPerm(id) {
    const section = document.getElementById(`staff-perms-${id}`);
    if (section) {
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }
  }
  function toggleVetPerm(id) {
    const section = document.getElementById(`vet-perms-${id}`);
    if (section) {
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }
  }
  function toggleAddVet() {
    const section = document.getElementById('add-vet');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
  }
  function selectDays(mode) {
    const select = document.getElementById('dias_semana');
    const weekdays = ['Segunda','Terça','Quarta','Quinta','Sexta'];
    const weekend = ['Sábado','Domingo'];
    for (const opt of select.options) {
    if (mode === 'all') opt.selected = true;
    else if (mode === 'weekday') opt.selected = weekdays.includes(opt.value);
    else if (mode === 'weekend') opt.selected = weekend.includes(opt.value);
    else if (mode === 'clear') opt.selected = false;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const filterInput = document.getElementById('staff-filter');
  const sortSelect = document.getElementById('staff-sort');
  const roleSelect = document.getElementById('staff-role');
  const list = document.getElementById('staff-list');
  if (!filterInput || !sortSelect || !list) return;
  const items = Array.from(list.querySelectorAll('li[data-name]'));

  function applyFilter() {
    const term = filterInput.value.toLowerCase();
    const role = roleSelect ? roleSelect.value : '';
    items.forEach(item => {
      const text = item.textContent.toLowerCase();
      const matchesRole = !role || item.dataset.role === role;
      item.style.display = (text.includes(term) && matchesRole) ? '' : 'none';
    });
  }

  function applySort() {
    const value = sortSelect.value;
    const visible = items.filter(item => item.style.display !== 'none');
    const hidden = items.filter(item => item.style.display === 'none');
    visible.sort((a, b) => {
      switch (value) {
        case 'name_desc':
          return b.dataset.name.localeCompare(a.dataset.name);
        case 'role_asc':
          return (a.dataset.role || '').localeCompare(b.dataset.role || '');
        case 'role_desc':
          return (b.dataset.role || '').localeCompare(a.dataset.role || '');
        case 'name_asc':
        default:
          return a.dataset.name.localeCompare(b.dataset.name);
      }
    });
    visible.forEach(item => list.appendChild(item));
    hidden.forEach(item => list.appendChild(item));
  }

  filterInput.addEventListener('input', () => { applyFilter(); applySort(); });
  sortSelect.addEventListener('change', applySort);
  if (roleSelect) roleSelect.addEventListener('change', () => { applyFilter(); applySort(); });
  applySort();
});

document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('appointment-filter-form');
  const container = document.getElementById('appointments-table-container');
  if (!form || !container) return;

  function updateTable(url, pushState = true) {
    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(response => response.text())
      .then(html => {
        container.innerHTML = html;
        if (typeof bindAppointmentRowClicks === 'function') {
          bindAppointmentRowClicks();
        }
        if (pushState) {
          window.history.replaceState({}, '', url);
        }
      })
      .catch(err => console.error(err));
  }

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const params = new URLSearchParams(new FormData(form));
    const url = `${form.action}?${params.toString()}`;
    updateTable(url);
  });

  const quickLinks = form.querySelectorAll('a[href]');
  quickLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.href;
      const u = new URL(url);
      updateTable(url);
      const startInput = document.getElementById('start');
      const endInput = document.getElementById('end');
      if (u.searchParams.get('start')) startInput.value = u.searchParams.get('start');
      if (u.searchParams.get('end')) endInput.value = u.searchParams.get('end');
    });
  });
});

</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='appointments_table.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const storageKey = 'clinicActiveTab_{{ clinica.id }}';
    const hash = window.location.hash;
    if (hash) {
      const hashTab = document.querySelector(`#clinicTabs button[data-bs-target="${hash}"]`);
      if (hashTab) {
        const tab = new bootstrap.Tab(hashTab);
        tab.show();
      }
    } else {
      const activeTab = localStorage.getItem(storageKey);
      if (activeTab) {
        const tabEl = document.querySelector(`#clinicTabs button[data-bs-target="${activeTab}"]`);
        if (tabEl) {
          const tab = new bootstrap.Tab(tabEl);
          tab.show();
        }
      }
    }
    const tabs = document.querySelectorAll('#clinicTabs button[data-bs-toggle="tab"]');
    tabs.forEach(tabEl => {
      tabEl.addEventListener('shown.bs.tab', event => {
        localStorage.setItem(storageKey, event.target.getAttribute('data-bs-target'));
      });
    });
  });
</script>
{% endblock %}
