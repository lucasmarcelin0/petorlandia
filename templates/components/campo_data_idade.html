<div class="row g-3 align-items-end data-idade" data-prefixo="{{ prefixo }}">
  <div class="col-12 col-sm-6 col-lg-4">
    <label class="form-label" for="{{ prefixo }}_dob">Data de Nascimento</label>
    <input type="hidden"
           name="{{ nome_data or 'date_of_birth' }}"
           id="{{ prefixo }}_dob_iso"
           value="{{ valor_data_iso or '' }}"
           data-dob-iso>
    <input
      type="text"
      class="form-control"
      id="{{ prefixo }}_dob"
      value="{{ valor_data or '' }}"
      placeholder="dd/mm/aaaa"
      autocomplete="off"
      data-dob
    >
  </div>
  <div class="col-12 col-sm-6 col-lg-2">
    <label class="form-label" for="{{ prefixo }}_age">Idade</label>
    <div class="input-group shadow-sm">
      <input
        type="number"
        min="0"
        class="form-control text-center"
        id="{{ prefixo }}_age"
        name="{{ nome_idade or 'age' }}"
        value="{{ valor_idade or '' }}"
        data-age
      >
      <span class="input-group-text bg-body-tertiary fw-semibold"
            id="{{ prefixo }}_age_unit"
            data-age-unit>{{ valor_unidade or 'anos' }}</span>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const wrapper = document.querySelector('.data-idade[data-prefixo="{{ prefixo }}"]');
    if (!wrapper) return;

    const dobInput = wrapper.querySelector('[data-dob]');
    const ageInput = wrapper.querySelector('[data-age]');
    const ageUnit = wrapper.querySelector('[data-age-unit]');
    const hiddenInput = wrapper.querySelector('[data-dob-iso]');
    if (!dobInput || !ageInput) return;

    // MÃ¡scara de input dd/mm/yyyy (ignora se Inputmask nÃ£o estiver carregado)
    if (typeof Inputmask !== 'undefined') {
      Inputmask("99/99/9999").mask(dobInput);
    }

    // FunÃ§Ã£o utilitÃ¡ria para formatar datas no padrÃ£o YYYY-MM-DD
    const formatISO = (d) => {
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    };

    // Inicializa flatpickr diretamente no campo visÃ­vel
    const fp = flatpickr(dobInput, {
      locale: "pt",
      dateFormat: "d/m/Y", // mesmo formato que o usuÃ¡rio vÃª
      allowInput: true,
      maxDate: "today",
      defaultDate: dobInput.value || null,

      onReady: function () {
        const parsed = parseData(dobInput.value);
        if (parsed) atualizarIdade(parsed);
        if (parsed && hiddenInput) hiddenInput.value = formatISO(parsed);
      },

      onChange: function (selectedDates) {
        if (selectedDates.length) {
          atualizarIdade(selectedDates[0]);
        }
      }
    });

    function atualizarIdade(dataNascimento) {
      const hoje = new Date();
      let anos = hoje.getFullYear() - dataNascimento.getFullYear();
      let meses = hoje.getMonth() - dataNascimento.getMonth();
      if (hoje.getDate() < dataNascimento.getDate()) {
        meses--;
      }
      if (meses < 0) {
        anos--;
        meses += 12;
      }
      ageInput.value = anos > 0 ? anos : meses;
      if (ageUnit) {
        if (anos > 0) {
          ageUnit.textContent = anos === 1 ? 'ano' : 'anos';
        } else {
          ageUnit.textContent = meses === 1 ? 'mÃªs' : 'meses';
        }
      }
      if (hiddenInput) hiddenInput.value = formatISO(dataNascimento);
    }

    // Quando o usuÃ¡rio digita a idade
    ageInput.addEventListener("input", () => {
      const idade = parseInt(ageInput.value);
      if (!isNaN(idade) && idade > 0 && idade < 120) {
        const hoje = new Date();
        const estimada = new Date(hoje.getFullYear() - idade, hoje.getMonth(), hoje.getDate());
        fp.setDate(estimada, true);
        if (hiddenInput) hiddenInput.value = formatISO(estimada);
        if (ageUnit) ageUnit.textContent = 'anos';
      }
    });

    // Quando o usuÃ¡rio termina de digitar a data
    dobInput.addEventListener("blur", () => {
      const parsed = parseData(dobInput.value);
      if (parsed) {
        fp.setDate(parsed, true);
        if (hiddenInput) hiddenInput.value = formatISO(parsed);
      }
    });

    function parseData(str) {
      const match = str.trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (!match) return null;
      const [_, d, m, y] = match;
      const date = new Date(Number(y), Number(m) - 1, Number(d)); // ðŸ’¡ forma segura!
      return isNaN(date) ? null : date;
    }

  });
</script>
