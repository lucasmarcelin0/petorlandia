<div class="row g-3 align-items-end data-idade" data-prefixo="{{ prefixo }}">
  <div class="col-12 col-sm-6 col-lg-4">
    <label class="form-label" for="{{ prefixo }}_dob">Data de Nascimento</label>
    <input type="hidden"
           name="{{ nome_data or 'date_of_birth' }}"
           id="{{ prefixo }}_dob_iso"
           value="{{ valor_data_iso or '' }}"
           data-dob-iso>
    <input
      type="text"
      class="form-control"
      id="{{ prefixo }}_dob"
      value="{{ valor_data or '' }}"
      placeholder="dd/mm/aaaa"
      autocomplete="off"
      data-dob
    >
  </div>
  <div class="col-12 col-sm-6 col-lg-3 col-xl-2">
    <label class="form-label" for="{{ prefixo }}_age">Idade</label>
    <div class="input-group shadow-sm flex-nowrap">
      <input
        type="number"
        min="0"
        class="form-control text-center"
        id="{{ prefixo }}_age"
        name="{{ nome_idade or 'age' }}"
        value="{{ valor_idade if valor_idade is defined and valor_idade is not none else '' }}"
        data-age
      >
      {% set unidade_atual = valor_unidade|lower if valor_unidade else 'anos' %}
      <select class="form-select bg-body-tertiary fw-semibold"
              id="{{ prefixo }}_age_unit"
              name="{{ nome_unidade or 'age_unit' }}"
              data-age-unit>
        <option value="anos"
                {% if unidade_atual in ['anos', 'ano'] %}selected{% endif %}>anos</option>
        <option value="meses"
                {% if unidade_atual in ['meses', 'mes', 'mÃªs'] %}selected{% endif %}>meses</option>
      </select>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const wrapper = document.querySelector('.data-idade[data-prefixo="{{ prefixo }}"]');
    if (!wrapper) return;

    const dobInput = wrapper.querySelector('[data-dob]');
    const ageInput = wrapper.querySelector('[data-age]');
    const ageUnit = wrapper.querySelector('[data-age-unit]');
    const hiddenInput = wrapper.querySelector('[data-dob-iso]');
    if (!dobInput || !ageInput) return;

    // MÃ¡scara de input dd/mm/yyyy (ignora se Inputmask nÃ£o estiver carregado)
    if (typeof Inputmask !== 'undefined') {
      Inputmask("99/99/9999").mask(dobInput);
    }

    const normalizarUnidade = (valor) => {
      const texto = (valor || '').toString().trim().toLowerCase();
      if (texto.startsWith('mes')) return 'meses';
      if (texto.startsWith('ano')) return 'anos';
      return 'anos';
    };

    const obterUnidadeAtual = () => {
      if (!ageUnit) return 'anos';
      if (ageUnit.tagName === 'SELECT') {
        return normalizarUnidade(ageUnit.value);
      }
      return normalizarUnidade(ageUnit.dataset.unit || ageUnit.textContent);
    };

    const definirUnidade = (unidade, quantidade = null) => {
      if (!ageUnit) return;
      const valorNormalizado = normalizarUnidade(unidade);
      if (ageUnit.tagName === 'SELECT') {
        ageUnit.value = valorNormalizado;
      } else {
        ageUnit.dataset.unit = valorNormalizado;
        if (valorNormalizado === 'meses') {
          ageUnit.textContent = quantidade === 1 ? 'mÃªs' : 'meses';
        } else {
          ageUnit.textContent = quantidade === 1 ? 'ano' : 'anos';
        }
      }
    };

    // FunÃ§Ã£o utilitÃ¡ria para formatar datas no padrÃ£o YYYY-MM-DD
    const formatISO = (d) => {
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    };

    // Inicializa flatpickr diretamente no campo visÃ­vel
    const fp = flatpickr(dobInput, {
      locale: "pt",
      dateFormat: "d/m/Y", // mesmo formato que o usuÃ¡rio vÃª
      allowInput: true,
      maxDate: "today",
      defaultDate: dobInput.value || null,

      onReady: function () {
        const parsed = parseData(dobInput.value);
        if (parsed) atualizarIdade(parsed);
        if (parsed && hiddenInput) hiddenInput.value = formatISO(parsed);
      },

      onChange: function (selectedDates) {
        if (selectedDates.length) {
          atualizarIdade(selectedDates[0]);
        }
      }
    });

    function atualizarIdade(dataNascimento, preferenciaUnidade = null) {
      const hoje = new Date();
      let anos = hoje.getFullYear() - dataNascimento.getFullYear();
      let meses = hoje.getMonth() - dataNascimento.getMonth();
      if (hoje.getDate() < dataNascimento.getDate()) {
        meses--;
      }
      if (meses < 0) {
        anos--;
        meses += 12;
      }
      const totalMeses = Math.max(anos * 12 + meses, 0);
      const unidadePreferida = preferenciaUnidade ? normalizarUnidade(preferenciaUnidade) : obterUnidadeAtual();

      if (unidadePreferida === 'meses' && totalMeses > 0) {
        ageInput.value = totalMeses;
        definirUnidade('meses', totalMeses);
      } else if (anos > 0) {
        ageInput.value = anos;
        definirUnidade('anos', anos);
      } else {
        ageInput.value = totalMeses;
        definirUnidade('meses', totalMeses);
      }
      if (hiddenInput) hiddenInput.value = formatISO(dataNascimento);
    }

    // Quando o usuÃ¡rio digita a idade
    ageInput.addEventListener("input", () => {
      const idade = parseInt(ageInput.value);
      if (isNaN(idade) || idade < 0) return;

      const unidade = obterUnidadeAtual();
      const agora = new Date();

      if (unidade === 'anos' && idade <= 120) {
        const estimada = new Date(agora.getFullYear() - idade, agora.getMonth(), agora.getDate());
        fp.setDate(estimada, true);
        if (hiddenInput) hiddenInput.value = formatISO(estimada);
        definirUnidade('anos', idade);
      } else if (unidade === 'meses' && idade <= 1440) {
        const estimada = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
        estimada.setMonth(estimada.getMonth() - idade);
        fp.setDate(estimada, true);
        if (hiddenInput) hiddenInput.value = formatISO(estimada);
        definirUnidade('meses', idade);
      }
    });

    // Quando o usuÃ¡rio termina de digitar a data
    dobInput.addEventListener("blur", () => {
      const parsed = parseData(dobInput.value);
      if (parsed) {
        fp.setDate(parsed, true);
        if (hiddenInput) hiddenInput.value = formatISO(parsed);
      }
    });

    if (ageUnit && ageUnit.tagName === 'SELECT') {
      ageUnit.addEventListener('change', () => {
        const unidade = obterUnidadeAtual();
        const parsed = parseData(dobInput.value);
        if (parsed) {
          atualizarIdade(parsed, unidade);
        } else {
          ageInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
      });
    }

    definirUnidade(obterUnidadeAtual());

    function parseData(str) {
      const match = str.trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (!match) return null;
      const [_, d, m, y] = match;
      const date = new Date(Number(y), Number(m) - 1, Number(d)); // ðŸ’¡ forma segura!
      return isNaN(date) ? null : date;
    }

  });
</script>
