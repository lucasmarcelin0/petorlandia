{% extends 'layout.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='consulta_qr.css') }}">
{% endblock %}

{% block main %}
<div class="container py-4 consulta-qr-page">
  <div class="consulta-hero mb-4">
    {% if animal %}
      {% if animal.photo %}
        <img src="{{ animal.photo.url }}" alt="{{ animal.name }}" class="animal-photo rounded-circle">
      {% else %}
        <div class="animal-photo rounded-circle bg-light d-flex align-items-center justify-content-center">游</div>
      {% endif %}
    {% endif %}

    <img src="{{ url_for('static', filename='logo_pet.png') }}" alt="Logo PetOrl칙ndia" class="consulta-logo mb-2">

    {% if animal %}
      <h2 class="mb-1">Prontu치rio de <span class="text-primary" id="animal-name">{{ animal.name }}</span></h2>
    {% elif tutor %}
      <h2 class="mb-1">Novo Atendimento para <span class="text-primary" id="tutor-name">{{ tutor.name }}</span></h2>
    {% else %}
      <h2 class="mb-1">Novo Atendimento Veterin치rio</h2>
    {% endif %}

    <p class="text-muted mb-0">Cuidando com carinho do seu melhor amigo</p>
  </div>

<!-- Substitua a se칞칚o de abas pelo seguinte c칩digo: -->
<ul class="nav nav-tabs mb-4" id="consultaTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tutor-tab" data-bs-toggle="tab" data-bs-target="#tutor-info" type="button">
      <i class="bi bi-person-fill me-1 text-primary"></i> Tutor
    </button>
  </li>
<li class="nav-item" role="presentation">
  <button class="nav-link" id="animal-tab" data-bs-toggle="tab" data-bs-target="#animal-info" type="button">
    <i class="bi bi-heart-pulse-fill me-1 text-danger"></i> Animal
  </button>
</li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="racao-tab" data-bs-toggle="tab" data-bs-target="#racoes" type="button"
            {% if not animal %}disabled title="Cadastre um animal primeiro"{% endif %}>
      <i class="bi bi-basket-fill me-1 text-success"></i> Ra칞칚o
    </button>
  </li>
  
  {% if animal and worker == 'veterinario' %}
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="consulta-tab" data-bs-toggle="tab" data-bs-target="#consulta-info" type="button">
        <i class="bi bi-clipboard2-pulse-fill me-1 text-info"></i> Consulta
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="medicamentos-tab" data-bs-toggle="tab" data-bs-target="#medicamentos" type="button">
        <i class="bi bi-capsule-pill me-1 text-warning"></i> Medicamentos
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="exames-tab" data-bs-toggle="tab" data-bs-target="#exames" type="button">
        <i class="bi bi-droplet-fill me-1" style="color: #6f42c1;"></i> Exames
      </button>
    </li>
<li class="nav-item" role="presentation">
  <button class="nav-link" id="vacinas-tab" data-bs-toggle="tab" data-bs-target="#vacinas" type="button">
    <i class="bi bi-shield-plus me-1" style="color: #20c997;"></i> Vacinas
  </button>
  </li>
  {% endif %}
</ul>





  <!-- Conte칰do das abas -->
  <div class="tab-content">
    <div class="tab-pane fade show active" id="tutor-info" role="tabpanel">
      <div class="card shadow-sm">
        <div class="card-body">
          {% include 'partials/tutor_form.html' with context %}
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="animal-info" role="tabpanel">
      <div class="card shadow-sm">
        <div class="card-body">
          {% if animal or tutor %}
            {% include 'partials/animal_form.html' with context %}
          {% else %}
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              Cadastre um tutor antes de registrar o animal.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="racoes" role="tabpanel">
      <div class="card shadow-sm">
        <div class="card-body">
          {% if animal %}
            {% include 'partials/food_form.html' with context %}
          {% else %}
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              Cadastre um tutor e um animal antes de registrar a ra칞칚o.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    {% if animal and worker == 'veterinario' %}
      <div class="tab-pane fade" id="consulta-info" role="tabpanel">
        <div class="card shadow-sm">
          <div class="card-body">
            {% include 'partials/consulta_form.html' %}
            <div id="historico-consultas">
              {% include 'partials/historico_consultas.html' %}
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="medicamentos" role="tabpanel">
        <div class="card shadow-sm">
          <div class="card-body">
            {% include 'partials/prescricao_form.html' %}
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="exames" role="tabpanel">
        <div class="card shadow-sm">
          <div class="card-body">
            {% include 'partials/exames_form.html' %}
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="vacinas" role="tabpanel">
        <div class="card shadow-sm">
          <div class="card-body">
            {% include 'partials/vacinas_form.html' %}
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Info extra se s칩 houver tutor -->
  {% if tutor and not animal %}
    <div class="alert alert-info mt-4 d-flex align-items-center">
      <i class="bi bi-info-circle-fill me-2 fs-5"></i>
      <div>
        Nenhum animal cadastrado ainda para <strong>{{ tutor.name }}</strong>. 
        <a href="#" class="alert-link" onclick="document.getElementById('animal-tab').click()">
          Clique aqui para adicionar um animal.
        </a>
      </div>
    </div>
  {% endif %}
</div>



<style>
  /* Cores customizadas para 칤cones */
.bi-heart-fill.text-danger { color: #e83e8c !important; } /* Rosa mais vivo para o cora칞칚o */
.bi-syringe-fill { color: #20c997 !important; } /* Verde 치gua para vacinas */
.bi-droplet-fill { color: #6f42c1 !important; } /* Roxo para exames */
.bi-capsule-pill.text-warning { color: #fd7e14 !important; } /* Laranja para medicamentos */

/* Efeito hover nos 칤cones */
.nav-link:hover i {
  transform: scale(1.1);
  transition: transform 0.2s ease;
}

/* Destaque tempor치rio para a aba salva */
.nav-link.tab-saved-highlight {
  animation: tabHighlight 2s ease-in-out;
}

@keyframes tabHighlight {
  from { background-color: #d1e7dd; }
  to { background-color: transparent; }
}
</style>




<script>
function bindSyncForms(root) {
  root.querySelectorAll('.tab-pane form[data-sync]').forEach(form => {
    if (form.dataset.syncBound) return;
    form.dataset.syncBound = '1';
    form.addEventListener('submit', async ev => {
      ev.preventDefault();

      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      const validateFn = form.dataset.validate && window[form.dataset.validate];
      if (validateFn && typeof validateFn === 'function' && !validateFn(form)) {
        return;
      }

      const pane = form.closest('.tab-pane');
      if (pane && pane.id) {
        localStorage.setItem('tabSavedHighlight', pane.id);
      }

      const btn = form.querySelector('button[type="submit"]');
      if (btn && !btn.querySelector('.spinner-border')) {
        btn.disabled = true;
        const sp = document.createElement('span');
        sp.className = 'spinner-border spinner-border-sm ms-2';
        sp.setAttribute('role', 'status');
        btn.appendChild(sp);
      }

      let data = null;
      let ok = false;
      try {
        const resp = await fetch(form.action, {
          method: 'POST',
          headers: {'Accept': 'application/json'},
          body: new FormData(form)
        });
        ok = resp.ok;
        try { data = await resp.json(); } catch(e) {}
      } catch(err) {}

      if (btn) {
        btn.querySelector('.spinner-border')?.remove();
        btn.disabled = false;
      }

      if (ok && data) {
        if (form.dataset.target && data.html) {
          const sel = form.dataset.target;
          const container = sel.startsWith('#') ? document.querySelector(sel) : document.getElementById(sel);
          if (container) {
            container.innerHTML = data.html;
            bindSyncForms(container);
          }
        }
        if (data.tutor_name) {
          const el = document.getElementById('tutor-name');
          if (el) el.textContent = data.tutor_name;
        }
        if (data.animal_name) {
          const el = document.getElementById('animal-name');
          if (el) el.textContent = data.animal_name;
        }
      }

      const toastEl = document.getElementById('actionToast');
      if (toastEl) {
        const msg = (data && (data.message || data.error)) || (ok ? 'Salvo com sucesso!' : 'Falha ao salvar');
        toastEl.querySelector('.toast-body').textContent = msg;
        toastEl.classList.remove('bg-danger', 'bg-info', 'bg-success');
        toastEl.classList.add(ok ? 'bg-success' : 'bg-danger');
        bootstrap.Toast.getOrCreateInstance(toastEl).show();
      }

      if (ok && pane && pane.id) {
        const link = document.querySelector(`[data-bs-target="#${pane.id}"]`);
        if (link) {
          link.classList.add('tab-saved-highlight');
          setTimeout(() => link.classList.remove('tab-saved-highlight'), 2000);
        }
      }
    });
  });
}

document.addEventListener('DOMContentLoaded', function() {
  // Ativar a aba salva ou a primeira dispon칤vel
  const abaSalva = localStorage.getItem('abaAtivaConsulta');
  if (abaSalva) {
    const tab = document.querySelector(`[data-bs-target="#${abaSalva}"]`);
    if (tab) new bootstrap.Tab(tab).show();
  }

  // Exibe destaque se a aba foi salva anteriormente (ap칩s recarregar)
  const highlight = localStorage.getItem('tabSavedHighlight');
  if (highlight) {
    const link = document.querySelector(`[data-bs-target="#${highlight}"]`);
    if (link) {
      link.classList.add('tab-saved-highlight');
      setTimeout(() => link.classList.remove('tab-saved-highlight'), 2000);
    }
    localStorage.removeItem('tabSavedHighlight');
  }

  bindSyncForms(document);

  // Salvar aba ativa quando muda
  document.getElementById('consultaTabs').addEventListener('shown.bs.tab', function(event) {
    const target = event.target.getAttribute('data-bs-target').replace('#', '');
    localStorage.setItem('abaAtivaConsulta', target);

    // L칩gica espec칤fica para medicamentos
    if (target === 'medicamentos') {
      setTimeout(() => ativarAutocomplete(), 100);
      const medInput = document.getElementById('medicamento');
      if (medInput) medInput.dispatchEvent(new Event('input'));
    }
  });

});


document.addEventListener('form-sync-success', function(ev) {
  const {form, data, response} = ev.detail || {};
  if (!form) return;

  const btn = form.querySelector('button[type="submit"]');
  if (btn) {
    clearTimeout(btn.spinnerTimer);
    btn.spinnerTimer = null;
    btn.querySelector('.spinner-border')?.remove();
    btn.disabled = false;
  }

  const success = !(data && data.success === false) && (!response || response.ok);

  const pane = form.closest('.tab-pane');
  if (success && pane && pane.id) {
    const link = document.querySelector(`[data-bs-target="#${pane.id}"]`);
    if (link) {
      link.classList.add('tab-saved-highlight');
      setTimeout(() => link.classList.remove('tab-saved-highlight'), 2000);
    }
  }

  if (form.classList.contains('delete-history-form')) {
    ev.preventDefault();
    if (data && data.html && form.dataset.target) {
      const container = document.getElementById(form.dataset.target);
      if (container) {
        container.innerHTML = data.html;
        bindSyncForms(container);
      }
    }
    const toastEl = document.getElementById('actionToast');
    if (toastEl) {
      const msg = (data && (data.message || data.error)) || (success ? 'Item removido!' : 'Erro ao remover item');
      toastEl.querySelector('.toast-body').textContent = msg;
      toastEl.classList.remove('bg-danger', 'bg-info', 'bg-success');
      toastEl.classList.add(success ? 'bg-info' : 'bg-danger');
      bootstrap.Toast.getOrCreateInstance(toastEl).show();
    }
    return;
  }

  if (form.id === 'consulta-form') {
    ev.preventDefault();
    if (data && data.html) {
      const container = document.getElementById('historico-consultas');
      if (container) {
        container.innerHTML = data.html;
        bindSyncForms(container);
      }
    }
    const toastEl = document.getElementById('actionToast');
    if (toastEl) {
      const msg = (data && (data.message || data.error)) || 'Consulta salva com sucesso!';
      toastEl.querySelector('.toast-body').textContent = msg;
      toastEl.classList.remove('bg-danger', 'bg-info', 'bg-success');
      toastEl.classList.add(success ? 'bg-success' : 'bg-danger');
      bootstrap.Toast.getOrCreateInstance(toastEl).show();
    }
  }
});

</script>


<style>
/* Ensure dropdown appears above consulta content */
.dropdown-menu {
  position: absolute !important;
  z-index: 3000 !important;
}
.nav-item.dropdown {
  position: relative !important;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Rebind dropdown after all tab JS is attached
  const dropdownTriggers = document.querySelectorAll('.dropdown-toggle[data-bs-toggle="dropdown"]');
  dropdownTriggers.forEach(trigger => {
    bootstrap.Dropdown.getOrCreateInstance(trigger); // Ensures instance exists
    trigger.addEventListener('click', function (e) {
      e.preventDefault(); // Let Bootstrap handle toggle
      e.stopImmediatePropagation(); // Prevent tab handlers from swallowing event
      bootstrap.Dropdown.getOrCreateInstance(trigger).toggle();
    });
  });
});
</script>



{% endblock %}
