{% extends "layout.html" %}
{% set titulo = "NFS-e" %}
{% set subtitulo = "Emissões e acompanhamento" %}

{% block main %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/nfse_flow.css') }}">
<div class="container mt-4">
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
    <div>
      <h2 class="mb-1">{{ titulo }}</h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="/contabilidade">Contabilidade</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{ titulo }}</li>
        </ol>
      </nav>
    </div>
    {% if clinics %}
    <form method="get" class="ms-lg-auto">
      {% if origin_id and origin_param %}
        <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
      {% endif %}
      <label class="form-label small text-muted mb-1" for="clinica-select">Clínica</label>
      <select id="clinica-select" name="clinica_id" class="form-select" onchange="this.form.submit()">
        {% for clinic in clinics %}
          <option value="{{ clinic.id }}" {% if selected_clinic and clinic.id == selected_clinic.id %}selected{% endif %}>
            {{ clinic.nome or 'Clínica' }}
          </option>
        {% endfor %}
      </select>
    </form>
    {% endif %}
  </div>

  {# --- Flow Stepper --- #}
  <ol class="nfse-stepper" aria-label="Etapas do fluxo fiscal">
    <li class="nfse-stepper__step nfse-stepper__step--done">Consulta</li>
    <li class="nfse-stepper__connector nfse-stepper__connector--done" aria-hidden="true"></li>
    <li class="nfse-stepper__step nfse-stepper__step--done">Orçamento</li>
    <li class="nfse-stepper__connector nfse-stepper__connector--active" aria-hidden="true"></li>
    <li class="nfse-stepper__step nfse-stepper__step--active">Emissão NFS-e</li>
    <li class="nfse-stepper__connector" aria-hidden="true"></li>
    <li class="nfse-stepper__step">Acompanhamento</li>
  </ol>

  {# --- Proactive Fiscal Config Validation --- #}
  {% if selected_clinic %}
    {% if nfse_missing_fields %}
    <div class="nfse-config-check nfse-config-check--error d-flex align-items-start gap-3 mb-3">
      <div class="nfse-config-check__icon">
        <i class="fas fa-exclamation-triangle fa-sm"></i>
      </div>
      <div class="flex-grow-1">
        <div class="fw-semibold">Configuração fiscal incompleta</div>
        <div class="text-muted small">
          Faltam dados obrigatórios: <strong>{{ nfse_missing_fields | join(', ') }}</strong>.
          A emissão de NFS-e ficará bloqueada até que sejam preenchidos.
        </div>
        <button class="btn btn-sm btn-outline-danger mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#nfse-config-section">
          <i class="fas fa-cog me-1"></i>Abrir configurações
        </button>
      </div>
    </div>
    {% else %}
    <div class="nfse-config-check nfse-config-check--ok d-flex align-items-center gap-3 mb-3">
      <div class="nfse-config-check__icon">
        <i class="fas fa-check fa-sm"></i>
      </div>
      <div class="flex-grow-1">
        <div class="fw-semibold">Configuração fiscal completa</div>
        <div class="text-muted small">{{ selected_clinic.nome or 'Clínica' }} pode emitir NFS-e.</div>
      </div>
      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#nfse-config-section">
        <i class="fas fa-cog me-1"></i>Configurações
      </button>
    </div>
    {% endif %}
  {% endif %}

  {# --- Collapsible Config Section --- #}
  {% if selected_clinic %}
  <div class="collapse {% if nfse_missing_fields %}show{% endif %}" id="nfse-config-section">
    <div class="card shadow-sm p-4 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Configurações essenciais da NFS-e</h5>
        <span class="badge bg-light text-dark border">{{ selected_clinic.nome or 'Clínica' }}</span>
      </div>
      <form method="post" action="{{ url_for('contabilidade_nfse_configurar') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="clinica_id" value="{{ selected_clinic.id }}">
        {% if origin_id and origin_param %}
          <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
        {% endif %}
        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label small text-muted" for="municipio_nfse">Município (NFS-e)</label>
            <select id="municipio_nfse" name="municipio_nfse" class="form-select">
              {% for option in municipio_options %}
                <option value="{{ option.value }}" {% if nfse_settings.municipio_nfse == option.value %}selected{% endif %}>
                  {{ option.label }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small text-muted" for="inscricao_municipal">Inscrição municipal</label>
            <input id="inscricao_municipal" name="inscricao_municipal" type="text" class="form-control" value="{{ nfse_settings.inscricao_municipal }}">
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small text-muted" for="regime_tributario">Regime tributário</label>
            <select id="regime_tributario" name="regime_tributario" class="form-select">
              <option value="">Selecione o regime</option>
              <option value="simples_nacional" {% if nfse_settings.regime_tributario == 'simples_nacional' %}selected{% endif %}>Simples Nacional</option>
              <option value="lucro_presumido" {% if nfse_settings.regime_tributario == 'lucro_presumido' %}selected{% endif %}>Lucro Presumido</option>
              <option value="lucro_real" {% if nfse_settings.regime_tributario == 'lucro_real' %}selected{% endif %}>Lucro Real</option>
            </select>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small text-muted" for="cnae">CNAE</label>
            <input id="cnae" name="cnae" type="text" class="form-control" value="{{ nfse_settings.cnae }}" placeholder="0000-0/00">
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small text-muted" for="codigo_servico">Código de serviço</label>
            <input id="codigo_servico" name="codigo_servico" type="text" class="form-control" value="{{ nfse_settings.codigo_servico }}">
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small text-muted" for="aliquota_iss">Alíquota ISS (%)</label>
            <input id="aliquota_iss" name="aliquota_iss" type="number" class="form-control" step="0.01" min="0" value="{{ nfse_settings.aliquota_iss }}">
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small text-muted" for="nfse_username">Usuário NFS-e</label>
            <input id="nfse_username" name="nfse_username" type="text" class="form-control" value="{{ nfse_settings.nfse_username }}">
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small text-muted" for="nfse_password">Senha NFS-e</label>
            <input id="nfse_password" name="nfse_password" type="password" class="form-control" placeholder="Deixe em branco para manter">
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small text-muted" for="nfse_token">Token/Chave NFS-e</label>
            <input id="nfse_token" name="nfse_token" type="text" class="form-control" value="{{ nfse_settings.nfse_token }}">
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label small text-muted" for="nfse_cert_path">Caminho do certificado</label>
            <input id="nfse_cert_path" name="nfse_cert_path" type="text" class="form-control" value="{{ nfse_settings.nfse_cert_path }}" placeholder="/caminho/arquivo.pfx">
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label small text-muted" for="nfse_cert_password">Senha do certificado</label>
            <input id="nfse_cert_password" name="nfse_cert_password" type="password" class="form-control" placeholder="Deixe em branco para manter">
          </div>
        </div>
        <div class="d-flex flex-column flex-sm-row gap-2 mt-3">
          <button class="btn btn-primary" type="submit">Salvar configurações</button>
          <span class="text-muted small align-self-center">
            Mantenha esses dados atualizados para evitar falhas no processamento automático.
          </span>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  {# --- Two-Column: Queue + Manual Emission --- #}
  <div class="nfse-emission-grid mb-4">
    {# LEFT COLUMN: Queue Management + Budget Data (read-only) #}
    <div>
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex flex-column flex-md-row justify-content-between gap-2 mb-3">
            <div>
              <h6 class="mb-1"><i class="fas fa-layer-group me-1 text-primary"></i>Fila de emissão</h6>
              <p class="text-muted mb-0 small">
                {% if selected_clinic %}
                  <span class="fw-semibold text-dark">{{ queue_count }}</span> emissão(ões) aguardando{% if async_enabled %} (modo assíncrono){% endif %}.
                {% else %}
                  Selecione uma clínica para visualizar a fila.
                {% endif %}
              </p>
            </div>
            {% if selected_clinic %}
            <form method="post" action="{{ url_for('contabilidade_nfse_processar_fila') }}" class="d-flex gap-2 align-items-end flex-shrink-0">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="clinica_id" value="{{ selected_clinic.id }}">
              {% if origin_id and origin_param %}
                <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
              {% endif %}
              <div>
                <label class="form-label small text-muted mb-1" for="limit">Limite</label>
                <input id="limit" name="limit" type="number" min="1" max="100" value="10" class="form-control form-control-sm" style="width:5rem;">
              </div>
              <button class="btn btn-primary btn-sm nfse-emit-btn" type="submit" {% if not selected_clinic or nfse_missing_fields %}disabled{% endif %}>
                <i class="fas fa-play me-1"></i>Processar fila
              </button>
            </form>
            {% endif %}
          </div>
          {% if selected_clinic and nfse_missing_fields %}
            <div class="alert alert-warning small mb-0 d-flex align-items-center gap-2">
              <i class="fas fa-lock"></i>
              <span>Processamento bloqueado: preencha as <strong>configurações fiscais</strong> acima para habilitar.</span>
            </div>
          {% elif selected_clinic %}
            <div class="alert alert-info small mb-0">
              Ao finalizar uma consulta com orçamento <strong>Particular</strong>, a NFS-e entra automaticamente na fila.
              Se ficar em <strong>erro</strong>, use <strong>Reprocessar</strong> na tabela abaixo.
            </div>
          {% endif %}
        </div>
      </div>

      {# Budget data preview (read-only) -- shown when orcamento is loaded #}
      <div class="card shadow-sm" id="nfse-budget-preview" hidden>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0"><i class="fas fa-file-invoice me-1 text-muted"></i>Dados do Orçamento</h6>
            <span class="nfse-eligible-badge" data-nfse-badge>
              <i class="fas fa-receipt"></i>Elegível para NFS-e
            </span>
          </div>
          <div class="nfse-readonly-section mb-3">
            <div class="row g-2">
              <div class="col-sm-4">
                <span class="nfse-readonly-label">Orçamento</span>
                <span class="nfse-readonly-value" data-nfse-ro="orcamento_id">--</span>
              </div>
              <div class="col-sm-4">
                <span class="nfse-readonly-label">Consulta</span>
                <span class="nfse-readonly-value" data-nfse-ro="consulta_id">--</span>
              </div>
              <div class="col-sm-4">
                <span class="nfse-readonly-label">Paciente</span>
                <span class="nfse-readonly-value" data-nfse-ro="paciente_nome">--</span>
              </div>
            </div>
          </div>
          <div class="nfse-readonly-section mb-3">
            <span class="nfse-readonly-label">Tomador (Tutor)</span>
            <div class="row g-2 mt-1">
              <div class="col-sm-6">
                <span class="nfse-readonly-value" data-nfse-ro="tomador_nome">--</span>
              </div>
              <div class="col-sm-6">
                <span class="text-muted small" data-nfse-ro="tomador_documento">--</span>
              </div>
            </div>
          </div>
          <div class="nfse-summary-card">
            <div class="d-flex align-items-center gap-2 mb-2">
              <i class="fas fa-list-ul text-primary"></i>
              <span class="nfse-summary-card__label mb-0">Serviços do orçamento</span>
            </div>
            <p class="text-muted small mb-0" data-nfse-ro-items-empty>Carregue um orçamento para ver os serviços.</p>
            <ul class="nfse-item-list" data-nfse-ro-items></ul>
            <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-2">
              <strong>Total do orçamento</strong>
              <span class="nfse-summary-card__total" data-nfse-ro-total>R$ 0,00</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# RIGHT COLUMN: NFS-e Controls & Manual Emission #}
    <div>
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="mb-1"><i class="fas fa-file-invoice-dollar me-1 text-primary"></i>Emissão de NFS-e</h6>
          <p class="text-muted small mb-3">
            Informe o orçamento para preencher automaticamente. Dados obrigatórios do tomador podem ser ajustados.
          </p>
          <form method="post" action="{{ url_for('contabilidade_nfse_emitir') }}" data-nfse-orcamento-form data-orcamento-endpoint="{{ url_for('contabilidade_nfse_orcamento', orcamento_id=0) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% if origin_id and origin_param and origin_param != 'orcamento_id' %}
              <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
            {% endif %}

            {# Orçamento ID with auto-load #}
            <div class="mb-3">
              <label class="form-label small text-muted fw-semibold" for="orcamento_id">
                <i class="fas fa-search me-1"></i>Orçamento
              </label>
              <div class="input-group">
                <input
                  id="orcamento_id"
                  name="orcamento_id"
                  type="number"
                  class="form-control"
                  placeholder="ID do orçamento"
                  value="{% if origin_param == 'orcamento_id' %}{{ origin_id }}{% endif %}"
                  data-nfse-field="orcamento_id"
                >
                <button class="btn btn-outline-secondary" type="button" data-nfse-load-btn title="Carregar dados do orçamento">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
              <div class="form-text" data-nfse-load-status></div>
            </div>

            {# Hidden consulta_id #}
            <input type="hidden" name="consulta_id" data-nfse-field="consulta_id">

            {# Tomador Fields (editable) #}
            <div class="border rounded p-3 mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold small text-uppercase text-muted">Dados do Tomador</span>
                <span class="badge bg-light text-muted small" data-nfse-autofill-badge hidden>Preenchido automaticamente</span>
              </div>
              <div class="row g-2">
                <div class="col-sm-8">
                  <label class="form-label small text-muted" for="nfse-tomador">Nome</label>
                  <input id="nfse-tomador" name="tomador_nome" type="text" class="form-control form-control-sm" placeholder="Nome do tomador" data-nfse-field="tomador_nome">
                  <div class="invalid-feedback">Informe o nome do tomador.</div>
                </div>
                <div class="col-sm-4">
                  <label class="form-label small text-muted" for="nfse-tomador-documento">CPF/CNPJ</label>
                  <input id="nfse-tomador-documento" name="tomador_documento" type="text" class="form-control form-control-sm" placeholder="Documento" data-nfse-field="tomador_documento">
                  <div class="invalid-feedback">CPF/CNPJ inválido.</div>
                </div>
                <div class="col-sm-6">
                  <label class="form-label small text-muted" for="nfse-tomador-email">E-mail</label>
                  <input id="nfse-tomador-email" name="tomador_email" type="email" class="form-control form-control-sm" placeholder="E-mail" data-nfse-field="tomador_email">
                  <div class="invalid-feedback">E-mail inválido.</div>
                </div>
                <div class="col-sm-6">
                  <label class="form-label small text-muted" for="nfse-tomador-telefone">Telefone</label>
                  <input id="nfse-tomador-telefone" name="tomador_telefone" type="text" class="form-control form-control-sm" placeholder="Telefone" data-nfse-field="tomador_telefone">
                </div>
              </div>
            </div>

            {# Address (collapsible) #}
            <div class="mb-3">
              <button class="btn btn-sm btn-link text-muted px-0 nfse-config-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#nfse-address-section" aria-expanded="false">
                <i class="fas fa-chevron-down me-1"></i>Endereço do tomador
              </button>
              <div class="collapse" id="nfse-address-section">
                <div class="border rounded p-3 mt-2">
                  <div class="row g-2">
                    <div class="col-sm-4">
                      <label class="form-label small text-muted" for="nfse-tomador-cep">CEP</label>
                      <input id="nfse-tomador-cep" name="tomador_cep" type="text" class="form-control form-control-sm" placeholder="00000-000" data-nfse-field="tomador_cep">
                      <div class="invalid-feedback">CEP inválido.</div>
                    </div>
                    <div class="col-sm-5">
                      <label class="form-label small text-muted" for="nfse-tomador-municipio">Município</label>
                      <input id="nfse-tomador-municipio" name="tomador_municipio" type="text" class="form-control form-control-sm" placeholder="Cidade" data-nfse-field="tomador_municipio">
                      <div class="invalid-feedback">Informe o município.</div>
                    </div>
                    <div class="col-sm-3">
                      <label class="form-label small text-muted" for="nfse-tomador-uf">UF</label>
                      <input id="nfse-tomador-uf" name="tomador_uf" type="text" class="form-control form-control-sm" maxlength="2" placeholder="UF" data-nfse-field="tomador_uf">
                      <div class="invalid-feedback">UF inválida.</div>
                    </div>
                    <div class="col-12">
                      <label class="form-label small text-muted" for="nfse-tomador-logradouro">Logradouro</label>
                      <input id="nfse-tomador-logradouro" name="tomador_logradouro" type="text" class="form-control form-control-sm" placeholder="Rua/Av." data-nfse-field="tomador_logradouro">
                    </div>
                    <div class="col-sm-4">
                      <label class="form-label small text-muted" for="nfse-tomador-numero">Número</label>
                      <input id="nfse-tomador-numero" name="tomador_numero" type="text" class="form-control form-control-sm" placeholder="Nº" data-nfse-field="tomador_numero">
                    </div>
                    <div class="col-sm-8">
                      <label class="form-label small text-muted" for="nfse-tomador-bairro">Bairro</label>
                      <input id="nfse-tomador-bairro" name="tomador_bairro" type="text" class="form-control form-control-sm" placeholder="Bairro" data-nfse-field="tomador_bairro">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {# Hidden paciente_nome #}
            <input type="hidden" name="paciente_nome" data-nfse-field="paciente_nome">

            {# Summary + Action Buttons #}
            <div class="nfse-summary-card mb-3" data-nfse-summary>
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="fas fa-receipt text-primary"></i>
                <span class="nfse-summary-card__label mb-0">Resumo da Nota</span>
              </div>
              <p class="text-muted small mb-2" data-nfse-summary-empty>
                Informe um orçamento para visualizar os serviços e valores.
              </p>
              <div data-nfse-summary-content hidden>
                <div class="small fw-semibold text-muted text-uppercase mb-1">Serviços</div>
                <ul class="nfse-item-list" data-nfse-items></ul>
                <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-2">
                  <span class="fw-semibold">Total da nota</span>
                  <span class="nfse-summary-card__total" data-nfse-total>R$ 0,00</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-1" data-nfse-particular-row hidden>
                  <span class="small text-muted">Somente particular (NFS-e)</span>
                  <span class="small fw-semibold text-success" data-nfse-particular-total>R$ 0,00</span>
                </div>
              </div>
            </div>

            <div class="d-grid gap-2">
              <a class="btn btn-outline-primary disabled" data-nfse-preview href="#">
                <i class="fas fa-eye me-1"></i>Pré-visualizar NFS-e
              </a>
              <button class="btn btn-primary nfse-emit-btn" type="submit" {% if nfse_missing_fields %}disabled{% endif %}>
                <i class="fas fa-paper-plane me-1"></i>Confirmar e Emitir NFS-e
              </button>
            </div>
            <p class="text-muted small mt-2 mb-0 text-center">
              Sem o ID? Finalize a consulta para entrar na fila automaticamente.
            </p>
          </form>
        </div>
      </div>
    </div>
  </div>

  {# --- Unified Tracking Table --- #}
  <div class="card shadow-sm" id="nfse-tracking">
    <div class="card-body">
      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
        <div>
          <h5 class="mb-1"><i class="fas fa-list-check me-1 text-primary"></i>Acompanhamento das emissões</h5>
          <p class="text-muted mb-0 small">
            Lista unificada de todas as NFS-e. Filtre por status para encontrar rapidamente.
          </p>
        </div>
        {# Pill Filters #}
        <form method="get" class="nfse-tracking-filters" id="nfse-filter-form">
          {% if selected_clinic %}
            <input type="hidden" name="clinica_id" value="{{ selected_clinic.id }}">
          {% endif %}
          {% if origin_id and origin_param %}
            <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
          {% endif %}
          <input type="hidden" name="status" id="nfse-status-input" value="{{ status_filter }}">
          {% set filter_labels = {
            '': 'Todos',
            'fila': 'Na fila',
            'processando': 'Processando',
            'autorizado': 'Autorizado',
            'erro': 'Erro',
            'cancelada': 'Cancelada'
          } %}
          {% for value, label in filter_labels.items() %}
            {% set filter_style = {
              '': 'btn-outline-dark',
              'fila': 'btn-outline-secondary',
              'processando': 'btn-outline-warning',
              'autorizado': 'btn-outline-success',
              'erro': 'btn-outline-danger',
              'cancelada': 'btn-outline-dark'
            }.get(value, 'btn-outline-secondary') %}
            <button type="button"
              class="btn {{ filter_style }} {% if status_filter == value %}active{% endif %}"
              data-nfse-filter="{{ value }}">
              {{ label }}
            </button>
          {% endfor %}
        </form>
      </div>

      {% if selected_clinic and cancel_rules %}
        <div class="alert alert-light border small mb-3 d-flex align-items-center gap-2">
          <i class="fas fa-info-circle text-muted"></i>
          <span>
            <strong>Regras do município:</strong>
            {% if cancel_rules.deadline_days %}
              Prazo de cancelamento: {{ cancel_rules.deadline_days }} dia(s).
            {% endif %}
            {% if cancel_rules.require_reason %}Motivo obrigatório.{% endif %}
          </span>
        </div>
      {% endif %}

      {% if selected_clinic %}
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="small text-uppercase text-muted">Emissão</th>
              <th class="small text-uppercase text-muted">Origem</th>
              <th class="small text-uppercase text-muted">Tutor / Paciente</th>
              <th class="small text-uppercase text-muted text-end">Valor</th>
              <th class="small text-uppercase text-muted">Status</th>
              <th class="small text-uppercase text-muted">Protocolo / Nº</th>
              <th class="small text-uppercase text-muted text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for issue in issues %}
            {% set status_value = issue.status or 'pendente' %}
            {% set tomador_payload = issue.tomador_payload %}
            {% set tutor_nome = issue.tutor_display_name %}
            {% set animal_nome = issue.animal_display_name %}
            <tr class="nfse-tracking-row {% if status_value == 'processando' %}nfse-tracking-row--processing{% elif status_value == 'erro' %}nfse-tracking-row--error{% endif %}">
              <td>
                <div class="fw-semibold">#{{ issue.id }}</div>
                <div class="text-muted small">{{ issue.created_at.strftime('%d/%m/%Y %H:%M') if issue.created_at else '—' }}</div>
              </td>
              <td>
                <div class="fw-semibold small">{{ issue.internal_identifier or '—' }}</div>
                <div class="text-muted small">RPS: {{ issue.rps or '—' }}</div>
              </td>
              <td>
                <div class="fw-semibold">{{ tutor_nome or 'Tutor não informado' }}</div>
                <div class="text-muted small">{{ animal_nome or 'Paciente não informado' }}</div>
                {% if not tutor_nome or not animal_nome %}
                  <span class="badge bg-warning bg-opacity-10 text-warning small">Dados incompletos</span>
                {% endif %}
              </td>
              <td class="text-end">
                {% if issue.valor_total %}
                  <span class="fw-semibold">R$ {{ '%.2f'|format(issue.valor_total) }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                <span class="nfse-status-badge nfse-status-badge--{{ status_value }}">
                  {% if status_value == 'processando' %}<i class="fas fa-spinner fa-spin"></i>{% endif %}
                  {% if status_value == 'autorizado' %}<i class="fas fa-check-circle"></i>{% endif %}
                  {% if status_value == 'erro' %}<i class="fas fa-times-circle"></i>{% endif %}
                  {% if status_value == 'fila' %}<i class="fas fa-clock"></i>{% endif %}
                  {% if status_value == 'cancelada' %}<i class="fas fa-ban"></i>{% endif %}
                  {{ status_value.replace('_', ' ').title() }}
                </span>
                {% if issue.erro_mensagem or issue.erro_codigo %}
                  <div class="nfse-error-detail">
                    <strong>{{ issue.erro_mensagem or 'Falha ao processar a NFS-e.' }}</strong>
                    {% if issue.erro_codigo %}
                      <div class="small">Código: {{ issue.erro_codigo }}</div>
                    {% endif %}
                    {% if issue.erro_detalhes %}
                      <details class="mt-1">
                        <summary class="small">Detalhes técnicos</summary>
                        <div class="text-muted small mt-1">{{ issue.erro_detalhes }}</div>
                      </details>
                    {% endif %}
                  </div>
                {% endif %}
              </td>
              <td>
                {% if issue.protocolo %}
                  <div class="small"><span class="text-muted">Prot.:</span> {{ issue.protocolo }}</div>
                {% endif %}
                {% if issue.numero_nfse %}
                  <div class="fw-semibold"><span class="text-muted small">Nº:</span> {{ issue.numero_nfse }}</div>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                <div class="nfse-actions justify-content-end">
                  {# Reprocess button (always visible for non-final) #}
                  {% if status_value in ['fila', 'erro', 'processando', 'pendente'] %}
                  <form method="post" action="{{ url_for('contabilidade_nfse_reprocessar', issue_id=issue.id) }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% if origin_id and origin_param %}
                      <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
                    {% endif %}
                    <button class="btn btn-outline-primary btn-sm" type="submit" title="Reprocessar">
                      <i class="fas fa-redo me-1"></i>Reprocessar
                    </button>
                  </form>
                  {% endif %}

                  {# Downloads #}
                  <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('contabilidade_nfse_download', issue_id=issue.id, kind='xml') }}" title="Baixar XML">
                    <i class="fas fa-file-code me-1"></i>XML
                  </a>
                  {% if issue.id in pdf_issue_ids %}
                    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('contabilidade_nfse_download', issue_id=issue.id, kind='pdf') }}" title="Baixar PDF">
                      <i class="fas fa-file-pdf me-1"></i>PDF
                    </a>
                  {% endif %}

                  {# Expand details button #}
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#nfse-detail-{{ issue.id }}" title="Detalhes">
                    <i class="fas fa-ellipsis-h"></i>
                  </button>
                </div>

                {# Collapsible details row #}
                <div class="collapse mt-2" id="nfse-detail-{{ issue.id }}">
                  {# Complete data form #}
                  <div class="border rounded p-2 mb-2">
                    <div class="fw-semibold small mb-1">Completar dados</div>
                    <form method="post" action="{{ url_for('contabilidade_nfse_contexto', issue_id=issue.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      {% if origin_id and origin_param %}
                        <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
                      {% endif %}
                      <div class="row g-1 mb-1">
                        <div class="col-12">
                          <input name="tutor_nome" class="form-control form-control-sm" value="{{ tutor_nome or '' }}" placeholder="Tutor">
                        </div>
                        <div class="col-sm-6">
                          <input name="tutor_documento" class="form-control form-control-sm" value="{{ issue.tutor_documento or '' }}" placeholder="CPF/CNPJ">
                        </div>
                        <div class="col-sm-6">
                          <input name="animal_nome" class="form-control form-control-sm" value="{{ animal_nome or '' }}" placeholder="Paciente">
                        </div>
                      </div>
                      <button class="btn btn-outline-secondary btn-sm w-100" type="submit">Salvar dados</button>
                    </form>
                  </div>

                  {# Cancel/Replace forms #}
                  {% set can_cancel = issue.numero_nfse and status_value not in ['cancelada', 'cancelamento_solicitado', 'substituicao_solicitada'] %}
                  {% if can_cancel %}
                  <div class="border rounded p-2">
                    <div class="fw-semibold small mb-1">Cancelar / Substituir</div>
                    <form method="post" action="{{ url_for('contabilidade_nfse_cancelar', issue_id=issue.id) }}" class="mb-2">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      {% if origin_id and origin_param %}
                        <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
                      {% endif %}
                      <div class="row g-1 mb-1">
                        <div class="col-sm-6">
                          {% if cancel_rules and cancel_rules.allowed_reasons %}
                            <select name="reason_code" class="form-select form-select-sm">
                              <option value="">Motivo</option>
                              {% for reason in cancel_rules.allowed_reasons %}
                                <option value="{{ reason.code }}">{{ reason.label }}</option>
                              {% endfor %}
                            </select>
                          {% else %}
                            <input name="reason_code" class="form-control form-control-sm" placeholder="Motivo">
                          {% endif %}
                        </div>
                        <div class="col-sm-6">
                          <input name="reason_description" class="form-control form-control-sm" placeholder="Descrição">
                        </div>
                      </div>
                      <button class="btn btn-outline-danger btn-sm w-100" type="submit">Cancelar NFS-e</button>
                    </form>
                    <form method="post" action="{{ url_for('contabilidade_nfse_substituir', issue_id=issue.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      {% if origin_id and origin_param %}
                        <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
                      {% endif %}
                      <div class="row g-1 mb-1">
                        <div class="col-sm-4">
                          {% if cancel_rules and cancel_rules.allowed_reasons %}
                            <select name="reason_code" class="form-select form-select-sm">
                              <option value="">Motivo</option>
                              {% for reason in cancel_rules.allowed_reasons %}
                                <option value="{{ reason.code }}">{{ reason.label }}</option>
                              {% endfor %}
                            </select>
                          {% else %}
                            <input name="reason_code" class="form-control form-control-sm" placeholder="Motivo">
                          {% endif %}
                        </div>
                        <div class="col-sm-4">
                          <input name="reason_description" class="form-control form-control-sm" placeholder="Descrição">
                        </div>
                        <div class="col-sm-4">
                          <input name="substituida_por_nfse" class="form-control form-control-sm" placeholder="Nº substituta">
                        </div>
                      </div>
                      <button class="btn btn-outline-warning btn-sm w-100" type="submit">Substituir</button>
                    </form>
                  </div>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7">
                <div class="nfse-empty-state">
                  <div class="nfse-empty-state__icon"><i class="fas fa-file-invoice"></i></div>
                  <p class="text-muted mb-0">Nenhuma emissão encontrada{% if status_filter %} com o filtro "{{ status_filter }}"{% endif %}.</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="nfse-empty-state">
          <div class="nfse-empty-state__icon"><i class="fas fa-building"></i></div>
          <p class="text-muted">Selecione uma clínica para visualizar emissões e processar a fila.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* --- Pill Filter Navigation --- */
  document.querySelectorAll('[data-nfse-filter]').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = document.getElementById('nfse-status-input');
      if (input) input.value = btn.dataset.nfseFilter;
      const form = document.getElementById('nfse-filter-form');
      if (form) form.submit();
    });
  });

  /* --- Emission Form Logic --- */
  const form = document.querySelector('[data-nfse-orcamento-form]');
  if (!form) return;

  const endpointTemplate = form.dataset.orcamentoEndpoint;
  const budgetPreview = document.getElementById('nfse-budget-preview');
  const summaryEmpty = form.querySelector('[data-nfse-summary-empty]');
  const itemsList = form.querySelector('[data-nfse-items]');
  const totalField = form.querySelector('[data-nfse-total]');
  const previewButton = form.querySelector('[data-nfse-preview]');
  const loadBtn = form.querySelector('[data-nfse-load-btn]');
  const loadStatus = form.querySelector('[data-nfse-load-status]');
  const autofillBadge = form.querySelector('[data-nfse-autofill-badge]');

  const fields = {
    orcamento_id: form.querySelector('[data-nfse-field="orcamento_id"]'),
    consulta_id: form.querySelector('[data-nfse-field="consulta_id"]'),
    paciente_nome: form.querySelector('[data-nfse-field="paciente_nome"]'),
    tomador_nome: form.querySelector('[data-nfse-field="tomador_nome"]'),
    tomador_documento: form.querySelector('[data-nfse-field="tomador_documento"]'),
    tomador_email: form.querySelector('[data-nfse-field="tomador_email"]'),
    tomador_telefone: form.querySelector('[data-nfse-field="tomador_telefone"]'),
    tomador_cep: form.querySelector('[data-nfse-field="tomador_cep"]'),
    tomador_municipio: form.querySelector('[data-nfse-field="tomador_municipio"]'),
    tomador_uf: form.querySelector('[data-nfse-field="tomador_uf"]'),
    tomador_logradouro: form.querySelector('[data-nfse-field="tomador_logradouro"]'),
    tomador_numero: form.querySelector('[data-nfse-field="tomador_numero"]'),
    tomador_bairro: form.querySelector('[data-nfse-field="tomador_bairro"]'),
  };

  let lastOrcamentoId = null;
  const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

  const setStatus = (msg, type) => {
    if (loadStatus) {
      loadStatus.textContent = msg;
      loadStatus.className = `form-text text-${type || 'muted'}`;
    }
  };

  const summaryContent = form.querySelector('[data-nfse-summary-content]');
  const particularRow = form.querySelector('[data-nfse-particular-row]');
  const particularTotal = form.querySelector('[data-nfse-particular-total]');

  const setSummaryMessage = (msg) => {
    if (summaryEmpty) { summaryEmpty.textContent = msg; summaryEmpty.hidden = !msg; }
    if (summaryContent && msg) summaryContent.hidden = true;
  };

  const renderItems = (items) => {
    if (!itemsList) return;
    itemsList.innerHTML = '';
    if (!items || !items.length) { itemsList.hidden = true; return; }
    itemsList.hidden = false;
    items.forEach(item => {
      const li = document.createElement('li');
      li.className = 'nfse-item-list__item';
      const payerBadge = item.payer_type === 'plan'
        ? '<span class="badge bg-info text-dark me-1" style="font-size:0.65rem">Plano</span>'
        : '<span class="badge bg-secondary me-1" style="font-size:0.65rem">Particular</span>';
      li.innerHTML = `<span>${payerBadge}${item.descricao || 'Item'}</span><span class="fw-semibold">${fmt.format(item.valor || 0)}</span>`;
      itemsList.appendChild(li);
    });
  };

  const updateReadonly = (payload) => {
    if (!budgetPreview) return;
    budgetPreview.hidden = false;
    const set = (key, val) => {
      const el = budgetPreview.querySelector(`[data-nfse-ro="${key}"]`);
      if (el) el.textContent = val || '--';
    };
    set('orcamento_id', '#' + (payload.id || ''));
    set('consulta_id', payload.consulta_id ? '#' + payload.consulta_id : '--');
    set('paciente_nome', payload.paciente?.nome);
    set('tomador_nome', payload.tomador?.nome);
    set('tomador_documento', payload.tomador?.cpf_cnpj);

    const roItems = budgetPreview.querySelector('[data-nfse-ro-items]');
    const roItemsEmpty = budgetPreview.querySelector('[data-nfse-ro-items-empty]');
    if (roItems) {
      roItems.innerHTML = '';
      const items = payload.itens || [];
      if (items.length) {
        if (roItemsEmpty) roItemsEmpty.hidden = true;
        items.forEach(item => {
          const li = document.createElement('li');
          li.className = 'nfse-item-list__item';
          const payerBadge = item.payer_type === 'plan'
            ? '<span class="badge bg-info text-dark me-1" style="font-size:0.65rem">Plano</span>'
            : '<span class="badge bg-secondary me-1" style="font-size:0.65rem">Particular</span>';
          li.innerHTML = `<span>${payerBadge}${item.descricao || 'Item'}</span><span class="fw-semibold">${fmt.format(item.valor || 0)}</span>`;
          roItems.appendChild(li);
        });
      } else {
        if (roItemsEmpty) roItemsEmpty.hidden = false;
      }
    }
    const roTotal = budgetPreview.querySelector('[data-nfse-ro-total]');
    if (roTotal) roTotal.textContent = fmt.format(payload.valor_total || 0);
  };

  const updateSummary = (payload) => {
    if (totalField) totalField.textContent = fmt.format(payload.valor_total || 0);
    renderItems(payload.itens || []);
    if (summaryContent) summaryContent.hidden = false;
    // Show particular-only total when there are mixed payer types
    const items = payload.itens || [];
    const hasMixed = items.some(i => i.payer_type === 'plan') && items.some(i => i.payer_type !== 'plan');
    const partTotal = payload.valor_particular != null ? payload.valor_particular : items.filter(i => i.payer_type !== 'plan').reduce((s,i) => s + (i.valor||0), 0);
    if (particularRow) particularRow.hidden = !hasMixed;
    if (particularTotal) particularTotal.textContent = fmt.format(partTotal);
  };

  const updatePreviewLink = () => {
    if (!previewButton || !fields.orcamento_id) return;
    const value = (fields.orcamento_id.value || '').trim();
    if (!value) {
      previewButton.classList.add('disabled');
      previewButton.setAttribute('aria-disabled', 'true');
      previewButton.href = '#';
      return;
    }
    previewButton.classList.remove('disabled');
    previewButton.removeAttribute('aria-disabled');
    previewButton.href = `/contabilidade/nfse/preview?orcamento_id=${encodeURIComponent(value)}`;
  };

  const setFieldValue = (field, value, opts) => {
    if (!field) return;
    if (!(opts && opts.force) && field.dataset.nfseDirty === 'true') return;
    field.value = value || '';
  };

  const populateFields = (payload) => {
    setFieldValue(fields.consulta_id, payload.consulta_id);
    setFieldValue(fields.paciente_nome, payload.paciente?.nome);
    setFieldValue(fields.tomador_nome, payload.tomador?.nome);
    setFieldValue(fields.tomador_documento, payload.tomador?.cpf_cnpj);
    setFieldValue(fields.tomador_email, payload.tomador?.email);
    setFieldValue(fields.tomador_telefone, payload.tomador?.telefone);
    const endereco = payload.tomador?.endereco;
    const enderecoTexto = payload.tomador?.endereco_texto || '';
    setFieldValue(fields.tomador_cep, endereco?.cep);
    setFieldValue(fields.tomador_municipio, endereco?.cidade);
    setFieldValue(fields.tomador_uf, endereco?.estado);
    setFieldValue(fields.tomador_logradouro, endereco?.logradouro || endereco?.rua || enderecoTexto);
    setFieldValue(fields.tomador_numero, endereco?.numero);
    setFieldValue(fields.tomador_bairro, endereco?.bairro);

    if (autofillBadge) autofillBadge.hidden = false;

    // Auto-expand address if we have data
    if (endereco && (endereco.cep || endereco.logradouro)) {
      const addrSection = document.getElementById('nfse-address-section');
      if (addrSection && !addrSection.classList.contains('show')) {
        new bootstrap.Collapse(addrSection, { toggle: true });
      }
    }
  };

  const clearFields = () => {
    ['consulta_id','paciente_nome','tomador_nome','tomador_documento','tomador_email',
     'tomador_telefone','tomador_cep','tomador_municipio','tomador_uf',
     'tomador_logradouro','tomador_numero','tomador_bairro'].forEach(key => {
      if (fields[key]) fields[key].value = '';
    });
    if (totalField) totalField.textContent = fmt.format(0);
    renderItems([]);
    if (budgetPreview) budgetPreview.hidden = true;
    if (autofillBadge) autofillBadge.hidden = true;
    if (summaryContent) summaryContent.hidden = true;
    if (particularRow) particularRow.hidden = true;
  };

  if (fields.orcamento_id) {
    fields.orcamento_id.addEventListener('input', updatePreviewLink);
  }
  updatePreviewLink();

  /* --- Validation --- */
  const onlyDigits = v => (v || '').replace(/\D/g, '');

  const validateCpf = v => {
    const d = onlyDigits(v);
    if (d.length !== 11 || /^(\d)\1{10}$/.test(d)) return false;
    const calc = (base, factor) => { let t = 0; for (let i = 0; i < base.length; i++) t += +base[i] * (factor - i); const r = (t * 10) % 11; return r === 10 ? 0 : r; };
    return calc(d.slice(0,9),10) === +d[9] && calc(d.slice(0,10),11) === +d[10];
  };
  const validateCnpj = v => {
    const d = onlyDigits(v);
    if (d.length !== 14 || /^(\d)\1{13}$/.test(d)) return false;
    const calc = (base, f) => { let t = 0; for (let i = 0; i < f.length; i++) t += +base[i] * f[i]; const r = t % 11; return r < 2 ? 0 : 11 - r; };
    return calc(d.slice(0,12),[5,4,3,2,9,8,7,6,5,4,3,2]) === +d[12] && calc(d.slice(0,13),[6,5,4,3,2,9,8,7,6,5,4,3,2]) === +d[13];
  };
  const validateCpfCnpj = v => { if (!v) return true; const d = onlyDigits(v); return d.length === 11 ? validateCpf(v) : d.length === 14 ? validateCnpj(v) : false; };
  const validateEmail = v => !v || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
  const validateCep = v => !v || onlyDigits(v).length === 8;
  const validateMunicipio = v => v && v.trim().length >= 2;
  const validateUf = v => v && /^[A-Za-z]{2}$/.test(v.trim());
  const hasAnyValue = v => (v || '').trim().length > 0;
  const hasAddressDetails = () => [fields.tomador_cep, fields.tomador_logradouro, fields.tomador_numero, fields.tomador_bairro].some(f => f && hasAnyValue(f.value));

  const setFieldValidity = (field, isValid, opts) => {
    if (!field) return true;
    const required = opts && opts.required;
    if (!required && !hasAnyValue(field.value)) { field.classList.remove('is-invalid','is-valid'); return true; }
    field.classList.toggle('is-invalid', !isValid);
    field.classList.toggle('is-valid', isValid);
    return isValid;
  };
  const validateField = (field, validator, opts) => {
    if (!field) return true;
    const required = opts && opts.required;
    if (!required && !hasAnyValue(field.value)) return setFieldValidity(field, true, opts);
    return setFieldValidity(field, validator(field.value), opts);
  };
  const validateAll = () => {
    const addrReq = hasAddressDetails();
    return [
      validateField(fields.tomador_nome, validateMunicipio, {required: true}),
      validateField(fields.tomador_documento, validateCpfCnpj, {required: true}),
      validateField(fields.tomador_email, validateEmail),
      validateField(fields.tomador_cep, validateCep, {required: addrReq}),
      validateField(fields.tomador_municipio, validateMunicipio, {required: addrReq}),
      validateField(fields.tomador_uf, validateUf, {required: addrReq}),
    ].every(Boolean);
  };

  /* --- Load Budget --- */
  const loadOrcamento = async (orcamentoId) => {
    if (!orcamentoId) {
      setSummaryMessage('Informe um orçamento para visualizar o resumo.');
      clearFields();
      lastOrcamentoId = null;
      setStatus('', 'muted');
      return;
    }
    if (!endpointTemplate) return;
    setStatus('Carregando...', 'primary');
    setSummaryMessage('Carregando orçamento...');
    try {
      if (lastOrcamentoId !== String(orcamentoId)) {
        Object.values(fields).forEach(f => { if (f) delete f.dataset.nfseDirty; });
        lastOrcamentoId = String(orcamentoId);
      }
      const endpoint = endpointTemplate.replace(/0$/, String(orcamentoId));
      const response = await fetch(endpoint, { headers: { 'Accept': 'application/json' } });
      const payload = await response.json();
      if (!response.ok) throw new Error(payload.error || 'Não foi possível carregar.');
      populateFields(payload);
      updateSummary(payload);
      updateReadonly(payload);
      validateAll();
      setSummaryMessage('');
      setStatus('Orçamento carregado com sucesso.', 'success');
    } catch (error) {
      console.error(error);
      setSummaryMessage('Não foi possível carregar o orçamento informado.');
      clearFields();
      setStatus(error.message || 'Erro ao carregar.', 'danger');
    }
  };

  if (fields.orcamento_id && fields.orcamento_id.value) {
    loadOrcamento(fields.orcamento_id.value);
  }
  if (fields.orcamento_id) {
    fields.orcamento_id.addEventListener('change', e => loadOrcamento(e.target.value));
  }
  if (loadBtn && fields.orcamento_id) {
    loadBtn.addEventListener('click', () => loadOrcamento(fields.orcamento_id.value));
  }

  /* --- Field validation bindings --- */
  [
    [fields.tomador_nome, validateMunicipio, {required: true}],
    [fields.tomador_documento, validateCpfCnpj, {required: true}],
    [fields.tomador_email, validateEmail, {required: false}],
    [fields.tomador_cep, validateCep, {required: () => hasAddressDetails()}],
    [fields.tomador_municipio, validateMunicipio, {required: () => hasAddressDetails()}],
    [fields.tomador_uf, validateUf, {required: () => hasAddressDetails()}],
  ].forEach(([field, validator, options]) => {
    if (!field) return;
    const getRequired = () => typeof options.required === 'function' ? options.required() : options.required;
    field.addEventListener('input', () => { field.dataset.nfseDirty = 'true'; validateField(field, validator, {required: getRequired()}); });
    field.addEventListener('blur', () => validateField(field, validator, {required: getRequired()}));
  });

  Object.values(fields).forEach(field => {
    if (!field) return;
    field.addEventListener('input', () => { field.dataset.nfseDirty = 'true'; });
  });

  form.addEventListener('submit', event => {
    if (!validateAll()) { event.preventDefault(); event.stopPropagation(); }
  });
});
</script>
{% endblock %}
