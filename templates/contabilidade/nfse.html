{% extends "layout.html" %}
{% set titulo = "NFS-e" %}
{% set subtitulo = "Emissões e acompanhamento" %}

{% block main %}
<div class="container mt-4">
  <h2 class="mb-3">{{ titulo }}</h2>

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/contabilidade">Contabilidade</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ titulo }}</li>
    </ol>
  </nav>

  <div class="card shadow-sm p-4 mt-3">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
      <div>
        <h5 class="mb-1">{{ subtitulo }}</h5>
        <p class="text-muted mb-0">
          Evento de negócio: <strong>finalização da consulta</strong> cria uma emissão na fila de NFS-e.
        </p>
        <div class="mt-3">
          <h6 class="mb-2">Como emitir (passo a passo)</h6>
          <ol class="text-muted small mb-0">
            <li>Selecione a clínica para carregar a fila.</li>
            <li>Confira se a emissão está na fila e clique em <strong>Processar fila</strong>.</li>
            <li>Após processar, acompanhe o status e faça o download do PDF/XML.</li>
          </ol>
        </div>
      </div>
      {% if clinics %}
      <form method="get" class="ms-lg-auto">
        {% if origin_id and origin_param %}
          <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
        {% endif %}
        <label class="form-label small text-muted mb-1" for="clinica-select">Clínica</label>
        <select id="clinica-select" name="clinica_id" class="form-select" onchange="this.form.submit()">
          {% for clinic in clinics %}
            <option value="{{ clinic.id }}" {% if selected_clinic and clinic.id == selected_clinic.id %}selected{% endif %}>
              {{ clinic.nome or 'Clínica' }}
            </option>
          {% endfor %}
        </select>
      </form>
      {% endif %}
    </div>
  </div>

  {% if selected_clinic %}
  <div class="card shadow-sm p-4 mt-3">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
      <div>
        <h5 class="mb-1">Configurações essenciais da NFS-e</h5>
        <p class="text-muted mb-0">
          Complete os dados fiscais da clínica para evitar erros na emissão automática.
        </p>
        {% if nfse_missing_fields %}
          <div class="alert alert-warning small mt-3 mb-0">
            Ainda faltam informações obrigatórias: {{ nfse_missing_fields | join(', ') }}.
          </div>
        {% endif %}
      </div>
      <span class="badge bg-light text-dark border align-self-start align-self-lg-center">
        Clínica selecionada: {{ selected_clinic.nome or 'Clínica' }}
      </span>
    </div>
    <form method="post" action="{{ url_for('contabilidade_nfse_configurar') }}" class="mt-4">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="clinica_id" value="{{ selected_clinic.id }}">
      {% if origin_id and origin_param %}
        <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
      {% endif %}
      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted" for="municipio_nfse">Município (NFS-e)</label>
          <select id="municipio_nfse" name="municipio_nfse" class="form-select">
            {% for option in municipio_options %}
              <option value="{{ option.value }}" {% if nfse_settings.municipio_nfse == option.value %}selected{% endif %}>
                {{ option.label }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted" for="inscricao_municipal">Inscrição municipal</label>
          <input
            id="inscricao_municipal"
            name="inscricao_municipal"
            type="text"
            class="form-control"
            value="{{ nfse_settings.inscricao_municipal }}"
          >
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted" for="regime_tributario">Regime tributário</label>
          <select id="regime_tributario" name="regime_tributario" class="form-select">
            <option value="">Selecione o regime</option>
            <option value="simples_nacional" {% if nfse_settings.regime_tributario == 'simples_nacional' %}selected{% endif %}>Simples Nacional</option>
            <option value="lucro_presumido" {% if nfse_settings.regime_tributario == 'lucro_presumido' %}selected{% endif %}>Lucro Presumido</option>
            <option value="lucro_real" {% if nfse_settings.regime_tributario == 'lucro_real' %}selected{% endif %}>Lucro Real</option>
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted" for="cnae">CNAE</label>
          <input
            id="cnae"
            name="cnae"
            type="text"
            class="form-control"
            value="{{ nfse_settings.cnae }}"
            placeholder="0000-0/00"
          >
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted" for="codigo_servico">Código de serviço</label>
          <input
            id="codigo_servico"
            name="codigo_servico"
            type="text"
            class="form-control"
            value="{{ nfse_settings.codigo_servico }}"
          >
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted" for="aliquota_iss">Alíquota ISS (%)</label>
          <input
            id="aliquota_iss"
            name="aliquota_iss"
            type="number"
            class="form-control"
            step="0.01"
            min="0"
            value="{{ nfse_settings.aliquota_iss }}"
          >
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted" for="nfse_username">Usuário NFS-e</label>
          <input
            id="nfse_username"
            name="nfse_username"
            type="text"
            class="form-control"
            value="{{ nfse_settings.nfse_username }}"
          >
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted" for="nfse_password">Senha NFS-e</label>
          <input
            id="nfse_password"
            name="nfse_password"
            type="password"
            class="form-control"
            placeholder="Deixe em branco para manter"
          >
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted" for="nfse_token">Token/Chave NFS-e</label>
          <input
            id="nfse_token"
            name="nfse_token"
            type="text"
            class="form-control"
            value="{{ nfse_settings.nfse_token }}"
          >
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label small text-muted" for="nfse_cert_path">Caminho do certificado</label>
          <input
            id="nfse_cert_path"
            name="nfse_cert_path"
            type="text"
            class="form-control"
            value="{{ nfse_settings.nfse_cert_path }}"
            placeholder="/caminho/arquivo.pfx"
          >
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label small text-muted" for="nfse_cert_password">Senha do certificado</label>
          <input
            id="nfse_cert_password"
            name="nfse_cert_password"
            type="password"
            class="form-control"
            placeholder="Deixe em branco para manter"
          >
        </div>
      </div>
      <div class="d-flex flex-column flex-sm-row gap-2 mt-3">
        <button class="btn btn-primary" type="submit">Salvar configurações</button>
        <span class="text-muted small align-self-center">
          Dica: mantenha esses dados atualizados para evitar falhas no processamento automático.
        </span>
      </div>
    </form>
  </div>
  {% endif %}

  <div class="row g-3 mt-2">
    <div class="col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
            <div>
              <h6 class="mb-1">Fila de emissão</h6>
              <p class="text-muted mb-0 small">
                {% if selected_clinic %}
                  {{ queue_count }} emissão(ões) aguardando processamento{% if async_enabled %} (modo assíncrono){% endif %}.
                {% else %}
                  Selecione uma clínica para visualizar a fila.
                {% endif %}
              </p>
            </div>
            {% if selected_clinic %}
            <form method="post" action="{{ url_for('contabilidade_nfse_processar_fila') }}" class="d-flex gap-2 align-items-end">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="clinica_id" value="{{ selected_clinic.id }}">
              {% if origin_id and origin_param %}
                <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
              {% endif %}
              <div>
                <label class="form-label small text-muted mb-1" for="limit">Limite</label>
                <input id="limit" name="limit" type="number" min="1" max="100" value="10" class="form-control form-control-sm">
              </div>
              <button class="btn btn-outline-primary btn-sm" type="submit">
                Processar fila
              </button>
            </form>
            {% endif %}
          </div>
          {% if selected_clinic %}
            <div class="alert alert-info small mt-3 mb-0">
              Dica: se uma emissão ficar em <strong>erro</strong>, clique em <strong>Reprocessar</strong> para tentar novamente.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="mb-2">Emissão manual (casos pontuais)</h6>
          <p class="text-muted small mb-3">
            Use quando precisar emitir uma NFS-e retroativa para uma consulta já finalizada.
          </p>
          <form method="post" action="{{ url_for('contabilidade_nfse_emitir') }}" data-nfse-orcamento-form data-orcamento-endpoint="{{ url_for('contabilidade_nfse_orcamento', orcamento_id=0) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% if origin_id and origin_param and origin_param != 'orcamento_id' %}
              <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
            {% endif %}
            <div class="mb-2">
              <label class="form-label small text-muted" for="orcamento_id">Orçamento</label>
              <input
                id="orcamento_id"
                name="orcamento_id"
                type="number"
                class="form-control"
                placeholder="ID do orçamento"
                value="{% if origin_param == 'orcamento_id' %}{{ origin_id }}{% endif %}"
                data-nfse-field="orcamento_id"
              >
            </div>
            <div class="mb-2">
              <label class="form-label small text-muted" for="consulta_id">Consulta</label>
              <input
                id="consulta_id"
                name="consulta_id"
                type="number"
                class="form-control"
                placeholder="ID da consulta"
                data-nfse-field="consulta_id"
              >
            </div>
            <div class="mb-2">
              <label class="form-label small text-muted" for="nfse-paciente">Paciente</label>
              <input
                id="nfse-paciente"
                name="paciente_nome"
                type="text"
                class="form-control"
                placeholder="Nome do paciente"
                data-nfse-field="paciente_nome"
              >
            </div>
            <div class="mb-2">
              <label class="form-label small text-muted" for="nfse-tomador">Tomador</label>
              <input
                id="nfse-tomador"
                name="tomador_nome"
                type="text"
                class="form-control"
                placeholder="Nome do tomador"
                data-nfse-field="tomador_nome"
              >
              <div class="invalid-feedback">
                Informe o nome do tomador.
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label small text-muted" for="nfse-tomador-documento">CPF/CNPJ</label>
              <input
                id="nfse-tomador-documento"
                name="tomador_documento"
                type="text"
                class="form-control"
                placeholder="Documento do tomador"
                data-nfse-field="tomador_documento"
              >
              <div class="invalid-feedback">
                CPF/CNPJ inválido.
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label small text-muted" for="nfse-tomador-email">E-mail</label>
              <input
                id="nfse-tomador-email"
                name="tomador_email"
                type="email"
                class="form-control"
                placeholder="E-mail do tomador"
                data-nfse-field="tomador_email"
              >
              <div class="invalid-feedback">
                Informe um e-mail válido.
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label small text-muted" for="nfse-tomador-telefone">Telefone</label>
              <input
                id="nfse-tomador-telefone"
                name="tomador_telefone"
                type="text"
                class="form-control"
                placeholder="Telefone do tomador"
                data-nfse-field="tomador_telefone"
              >
            </div>
            <div class="row g-2 mb-2">
              <div class="col-sm-5">
                <label class="form-label small text-muted" for="nfse-tomador-cep">CEP</label>
                <input
                  id="nfse-tomador-cep"
                  name="tomador_cep"
                  type="text"
                  class="form-control"
                  placeholder="00000-000"
                  data-nfse-field="tomador_cep"
                >
                <div class="invalid-feedback">
                  CEP inválido.
                </div>
              </div>
              <div class="col-sm-5">
                <label class="form-label small text-muted" for="nfse-tomador-municipio">Município</label>
                <input
                  id="nfse-tomador-municipio"
                  name="tomador_municipio"
                  type="text"
                  class="form-control"
                  placeholder="Cidade"
                  data-nfse-field="tomador_municipio"
                >
                <div class="invalid-feedback">
                  Informe o município.
                </div>
              </div>
              <div class="col-sm-2">
                <label class="form-label small text-muted" for="nfse-tomador-uf">UF</label>
                <input
                  id="nfse-tomador-uf"
                  name="tomador_uf"
                  type="text"
                  class="form-control"
                  maxlength="2"
                  placeholder="UF"
                  data-nfse-field="tomador_uf"
                >
                <div class="invalid-feedback">
                  UF inválida.
                </div>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label small text-muted" for="nfse-tomador-logradouro">Logradouro</label>
              <input
                id="nfse-tomador-logradouro"
                name="tomador_logradouro"
                type="text"
                class="form-control"
                placeholder="Rua/Av."
                data-nfse-field="tomador_logradouro"
              >
            </div>
            <div class="row g-2 mb-3">
              <div class="col-sm-6">
                <label class="form-label small text-muted" for="nfse-tomador-numero">Número</label>
                <input
                  id="nfse-tomador-numero"
                  name="tomador_numero"
                  type="text"
                  class="form-control"
                  placeholder="Número"
                  data-nfse-field="tomador_numero"
                >
              </div>
              <div class="col-sm-6">
                <label class="form-label small text-muted" for="nfse-tomador-bairro">Bairro</label>
                <input
                  id="nfse-tomador-bairro"
                  name="tomador_bairro"
                  type="text"
                  class="form-control"
                  placeholder="Bairro"
                  data-nfse-field="tomador_bairro"
                >
              </div>
            </div>
            <div class="card border-0 bg-light mb-3" data-nfse-summary>
              <div class="card-body p-3">
                <h6 class="mb-2">Resumo da Nota</h6>
                <p class="text-muted small mb-2" data-nfse-summary-empty>
                  Informe um orçamento para visualizar o resumo antes de enviar.
                </p>
                <ul class="list-group list-group-flush mb-2" data-nfse-items hidden></ul>
                <div class="d-flex justify-content-between align-items-center border-top pt-2">
                  <strong>Total do orçamento</strong>
                  <strong data-nfse-total>R$ 0,00</strong>
                </div>
              </div>
            </div>
            <button class="btn btn-primary w-100" type="submit">Emitir NFS-e</button>
            <p class="text-muted small mt-2 mb-0">
              Se não souber o ID, finalize a consulta normalmente para entrar na fila automaticamente.
            </p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
        <div>
          <h6 class="mb-1">Acompanhamento das emissões</h6>
          <p class="text-muted mb-0 small">
            Status, protocolo e número retornados pela prefeitura/operadora.
          </p>
        </div>
        <form method="get" class="d-flex flex-wrap gap-2 align-items-center">
          {% if selected_clinic %}
            <input type="hidden" name="clinica_id" value="{{ selected_clinic.id }}">
          {% endif %}
          {% if origin_id and origin_param %}
            <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
          {% endif %}
          <label class="form-label small text-muted mb-0" for="status">Status</label>
          <select id="status" name="status" class="form-select form-select-sm">
            <option value="">Todos</option>
            {% for status in statuses %}
              <option value="{{ status }}" {% if status_filter == status %}selected{% endif %}>
                {{ status.replace('_', ' ').title() }}
              </option>
            {% endfor %}
          </select>
          <button class="btn btn-outline-secondary btn-sm" type="submit">Filtrar</button>
        </form>
      </div>
      {% if selected_clinic and cancel_rules %}
        <div class="alert alert-light border small mb-3">
          <strong>Regras do município:</strong>
          {% if cancel_rules.deadline_days %}
            Prazo de cancelamento/substituição: {{ cancel_rules.deadline_days }} dia(s).
          {% else %}
            Prazo de cancelamento/substituição: a definir.
          {% endif %}
          {% if cancel_rules.require_reason %}
            Motivo obrigatório.
          {% else %}
            Motivo opcional.
          {% endif %}
        </div>
      {% endif %}

      {% if selected_clinic %}
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>Emissão</th>
              <th>Evento</th>
              <th>Status</th>
              <th>Protocolo</th>
              <th>Nº NFS-e</th>
              <th>Downloads</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for issue in issues %}
            {% set status_value = issue.status or 'pendente' %}
            {% set status_class = {
              'fila': 'bg-secondary',
              'processando': 'bg-warning text-dark',
              'pendente': 'bg-info',
              'autorizado': 'bg-success',
              'erro': 'bg-danger',
              'cancelada': 'bg-dark',
              'cancelamento_solicitado': 'bg-warning text-dark',
              'substituicao_solicitada': 'bg-info text-dark'
            }.get(status_value, 'bg-light text-dark') %}
            <tr>
              <td>
                <div class="fw-semibold">#{{ issue.id }}</div>
                <div class="text-muted small">{{ issue.created_at.strftime('%d/%m/%Y %H:%M') if issue.created_at else '—' }}</div>
              </td>
              <td>
                <div class="fw-semibold">{{ issue.internal_identifier or '—' }}</div>
                <div class="text-muted small">RPS: {{ issue.rps or '—' }}</div>
              </td>
              <td>
                <span class="badge {{ status_class }}">{{ status_value }}</span>
                {% if issue.erro_mensagem or issue.erro_codigo or issue.erro_detalhes %}
                  <div class="small text-danger mt-1">
                    {% if issue.erro_mensagem %}
                      <div><strong>Erro:</strong> {{ issue.erro_mensagem }}</div>
                    {% else %}
                      <div><strong>Erro:</strong> Falha ao processar a NFS-e.</div>
                    {% endif %}
                    {% if issue.erro_codigo %}
                      <div>Código: {{ issue.erro_codigo }}</div>
                    {% endif %}
                    {% if issue.erro_detalhes %}
                      <details class="mt-1">
                        <summary class="small">Detalhes técnicos</summary>
                        <div class="text-muted">{{ issue.erro_detalhes }}</div>
                      </details>
                    {% endif %}
                  </div>
                {% endif %}
              </td>
              <td>{{ issue.protocolo or '—' }}</td>
              <td>{{ issue.numero_nfse or '—' }}</td>
              <td class="d-flex flex-column gap-2">
                <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('contabilidade_nfse_download', issue_id=issue.id, kind='xml') }}">
                  XML
                </a>
                {% if issue.id in pdf_issue_ids %}
                  <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('contabilidade_nfse_download', issue_id=issue.id, kind='pdf') }}">
                    PDF
                  </a>
                {% else %}
                  <button class="btn btn-outline-secondary btn-sm" type="button" disabled>PDF</button>
                {% endif %}
              </td>
              <td>
                <form method="post" action="{{ url_for('contabilidade_nfse_reprocessar', issue_id=issue.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  {% if origin_id and origin_param %}
                    <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
                  {% endif %}
                  <button class="btn btn-outline-primary btn-sm" type="submit">Reprocessar</button>
                </form>
                {% set can_cancel = issue.numero_nfse and status_value not in ['cancelada', 'cancelamento_solicitado', 'substituicao_solicitada'] %}
                {% if can_cancel %}
                <details class="mt-2">
                  <summary class="small text-primary">Cancelar/Substituir</summary>
                  <form method="post" action="{{ url_for('contabilidade_nfse_cancelar', issue_id=issue.id) }}" class="mt-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% if origin_id and origin_param %}
                      <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
                    {% endif %}
                    <div class="mb-2">
                      <label class="form-label small text-muted mb-1" for="reason_code_{{ issue.id }}">Motivo</label>
                      {% if cancel_rules and cancel_rules.allowed_reasons %}
                        <select id="reason_code_{{ issue.id }}" name="reason_code" class="form-select form-select-sm">
                          <option value="">Selecione</option>
                          {% for reason in cancel_rules.allowed_reasons %}
                            <option value="{{ reason.code }}">{{ reason.label }}</option>
                          {% endfor %}
                        </select>
                      {% else %}
                        <input id="reason_code_{{ issue.id }}" name="reason_code" class="form-control form-control-sm" placeholder="Código do motivo">
                      {% endif %}
                    </div>
                    <div class="mb-2">
                      <label class="form-label small text-muted mb-1" for="reason_desc_{{ issue.id }}">Descrição</label>
                      <input id="reason_desc_{{ issue.id }}" name="reason_description" class="form-control form-control-sm" placeholder="Descrição do motivo">
                    </div>
                    <button class="btn btn-outline-danger btn-sm w-100" type="submit">Solicitar cancelamento</button>
                  </form>
                  <form method="post" action="{{ url_for('contabilidade_nfse_substituir', issue_id=issue.id) }}" class="mt-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% if origin_id and origin_param %}
                      <input type="hidden" name="{{ origin_param }}" value="{{ origin_id }}">
                    {% endif %}
                    <div class="mb-2">
                      <label class="form-label small text-muted mb-1" for="reason_code_sub_{{ issue.id }}">Motivo</label>
                      {% if cancel_rules and cancel_rules.allowed_reasons %}
                        <select id="reason_code_sub_{{ issue.id }}" name="reason_code" class="form-select form-select-sm">
                          <option value="">Selecione</option>
                          {% for reason in cancel_rules.allowed_reasons %}
                            <option value="{{ reason.code }}">{{ reason.label }}</option>
                          {% endfor %}
                        </select>
                      {% else %}
                        <input id="reason_code_sub_{{ issue.id }}" name="reason_code" class="form-control form-control-sm" placeholder="Código do motivo">
                      {% endif %}
                    </div>
                    <div class="mb-2">
                      <label class="form-label small text-muted mb-1" for="reason_desc_sub_{{ issue.id }}">Descrição</label>
                      <input id="reason_desc_sub_{{ issue.id }}" name="reason_description" class="form-control form-control-sm" placeholder="Descrição do motivo">
                    </div>
                    <div class="mb-2">
                      <label class="form-label small text-muted mb-1" for="substituta_{{ issue.id }}">NFS-e substituta</label>
                      <input id="substituta_{{ issue.id }}" name="substituida_por_nfse" class="form-control form-control-sm" placeholder="Número da nota substituta">
                    </div>
                    <button class="btn btn-outline-warning btn-sm w-100" type="submit">Solicitar substituição</button>
                  </form>
                </details>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="text-muted">Nenhuma emissão encontrada.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="alert alert-warning mb-0">
          Selecione uma clínica para visualizar emissões e processar a fila.
        </div>
      {% endif %}
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('[data-nfse-orcamento-form]');
  if (!form) {
    return;
  }
  const endpointTemplate = form.dataset.orcamentoEndpoint;
  const summary = form.querySelector('[data-nfse-summary]');
  const summaryEmpty = form.querySelector('[data-nfse-summary-empty]');
  const itemsList = form.querySelector('[data-nfse-items]');
  const totalField = form.querySelector('[data-nfse-total]');
  const fields = {
    orcamento_id: form.querySelector('[data-nfse-field="orcamento_id"]'),
    consulta_id: form.querySelector('[data-nfse-field="consulta_id"]'),
    paciente_nome: form.querySelector('[data-nfse-field="paciente_nome"]'),
    tomador_nome: form.querySelector('[data-nfse-field="tomador_nome"]'),
    tomador_documento: form.querySelector('[data-nfse-field="tomador_documento"]'),
    tomador_email: form.querySelector('[data-nfse-field="tomador_email"]'),
    tomador_telefone: form.querySelector('[data-nfse-field="tomador_telefone"]'),
    tomador_cep: form.querySelector('[data-nfse-field="tomador_cep"]'),
    tomador_municipio: form.querySelector('[data-nfse-field="tomador_municipio"]'),
    tomador_uf: form.querySelector('[data-nfse-field="tomador_uf"]'),
    tomador_logradouro: form.querySelector('[data-nfse-field="tomador_logradouro"]'),
    tomador_numero: form.querySelector('[data-nfse-field="tomador_numero"]'),
    tomador_bairro: form.querySelector('[data-nfse-field="tomador_bairro"]'),
  };
  let lastOrcamentoId = null;

  const currencyFormatter = new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  });

  const setSummaryMessage = (message) => {
    if (summaryEmpty) {
      summaryEmpty.textContent = message;
      summaryEmpty.hidden = !message;
    }
  };

  const renderItems = (items = []) => {
    if (!itemsList) {
      return;
    }
    itemsList.innerHTML = '';
    if (!items.length) {
      itemsList.hidden = true;
      return;
    }
    itemsList.hidden = false;
    items.forEach((item) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `
        <span>${item.descricao || 'Item'}</span>
        <span>${currencyFormatter.format(item.valor || 0)}</span>
      `;
      itemsList.appendChild(li);
    });
  };

  const updateSummary = (payload) => {
    if (totalField) {
      totalField.textContent = currencyFormatter.format(payload.valor_total || 0);
    }
    renderItems(payload.itens || []);
  };

  const setFieldValue = (field, value, {force = false} = {}) => {
    if (!field) {
      return;
    }
    if (!force && field.dataset.nfseDirty === 'true') {
      return;
    }
    field.value = value || '';
  };

  const populateFields = (payload) => {
    if (fields.consulta_id) {
      setFieldValue(fields.consulta_id, payload.consulta_id);
    }
    if (fields.paciente_nome) {
      setFieldValue(fields.paciente_nome, payload.paciente?.nome);
    }
    if (fields.tomador_nome) {
      setFieldValue(fields.tomador_nome, payload.tomador?.nome);
    }
    if (fields.tomador_documento) {
      setFieldValue(fields.tomador_documento, payload.tomador?.cpf_cnpj);
    }
    if (fields.tomador_email) {
      setFieldValue(fields.tomador_email, payload.tomador?.email);
    }
    if (fields.tomador_telefone) {
      setFieldValue(fields.tomador_telefone, payload.tomador?.telefone);
    }
    const endereco = payload.tomador?.endereco;
    const enderecoTexto = payload.tomador?.endereco_texto || payload.tomador?.endereco || '';
    if (fields.tomador_cep) {
      setFieldValue(fields.tomador_cep, endereco?.cep);
    }
    if (fields.tomador_municipio) {
      setFieldValue(fields.tomador_municipio, endereco?.cidade);
    }
    if (fields.tomador_uf) {
      setFieldValue(fields.tomador_uf, endereco?.estado);
    }
    if (fields.tomador_logradouro) {
      setFieldValue(
        fields.tomador_logradouro,
        endereco?.logradouro || endereco?.rua || enderecoTexto,
      );
    }
    if (fields.tomador_numero) {
      setFieldValue(fields.tomador_numero, endereco?.numero);
    }
    if (fields.tomador_bairro) {
      setFieldValue(fields.tomador_bairro, endereco?.bairro);
    }
  };

  const clearFields = () => {
    if (fields.consulta_id) {
      fields.consulta_id.value = '';
    }
    if (fields.paciente_nome) {
      fields.paciente_nome.value = '';
    }
    if (fields.tomador_nome) {
      fields.tomador_nome.value = '';
    }
    if (fields.tomador_documento) {
      fields.tomador_documento.value = '';
    }
    if (fields.tomador_email) {
      fields.tomador_email.value = '';
    }
    if (fields.tomador_telefone) {
      fields.tomador_telefone.value = '';
    }
    if (fields.tomador_cep) {
      fields.tomador_cep.value = '';
    }
    if (fields.tomador_municipio) {
      fields.tomador_municipio.value = '';
    }
    if (fields.tomador_uf) {
      fields.tomador_uf.value = '';
    }
    if (fields.tomador_logradouro) {
      fields.tomador_logradouro.value = '';
    }
    if (fields.tomador_numero) {
      fields.tomador_numero.value = '';
    }
    if (fields.tomador_bairro) {
      fields.tomador_bairro.value = '';
    }
    if (totalField) {
      totalField.textContent = currencyFormatter.format(0);
    }
    renderItems([]);
  };

  const onlyDigits = (value) => (value || '').replace(/\D/g, '');

  const validateCpf = (value) => {
    const digits = onlyDigits(value);
    if (digits.length !== 11 || /^(\d)\1{10}$/.test(digits)) {
      return false;
    }
    const calcDigit = (base, factor) => {
      let total = 0;
      for (let i = 0; i < base.length; i += 1) {
        total += Number(base[i]) * (factor - i);
      }
      const remainder = (total * 10) % 11;
      return remainder === 10 ? 0 : remainder;
    };
    const digit1 = calcDigit(digits.slice(0, 9), 10);
    const digit2 = calcDigit(digits.slice(0, 10), 11);
    return digit1 === Number(digits[9]) && digit2 === Number(digits[10]);
  };

  const validateCnpj = (value) => {
    const digits = onlyDigits(value);
    if (digits.length !== 14 || /^(\d)\1{13}$/.test(digits)) {
      return false;
    }
    const calcDigit = (base, factors) => {
      let total = 0;
      for (let i = 0; i < factors.length; i += 1) {
        total += Number(base[i]) * factors[i];
      }
      const remainder = total % 11;
      return remainder < 2 ? 0 : 11 - remainder;
    };
    const digit1 = calcDigit(digits.slice(0, 12), [5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2]);
    const digit2 = calcDigit(digits.slice(0, 13), [6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2]);
    return digit1 === Number(digits[12]) && digit2 === Number(digits[13]);
  };

  const validateCpfCnpj = (value) => {
    if (!value) {
      return true;
    }
    const digits = onlyDigits(value);
    if (digits.length === 11) {
      return validateCpf(value);
    }
    if (digits.length === 14) {
      return validateCnpj(value);
    }
    return false;
  };

  const validateEmail = (value) => {
    if (!value) {
      return true;
    }
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  };

  const validateCep = (value) => {
    if (!value) {
      return true;
    }
    return onlyDigits(value).length === 8;
  };

  const validateMunicipio = (value) => {
    if (!value) {
      return false;
    }
    return value.trim().length >= 2;
  };

  const validateUf = (value) => {
    if (!value) {
      return false;
    }
    return /^[A-Za-z]{2}$/.test(value.trim());
  };

  const hasAnyValue = (value) => (value || '').trim().length > 0;

  const hasAddressDetails = () => [fields.tomador_cep, fields.tomador_logradouro, fields.tomador_numero, fields.tomador_bairro]
    .some((field) => field && hasAnyValue(field.value));

  const setFieldValidity = (field, isValid, {required = false} = {}) => {
    if (!field) {
      return true;
    }
    if (!required && !hasAnyValue(field.value)) {
      field.classList.remove('is-invalid', 'is-valid');
      return true;
    }
    if (isValid) {
      field.classList.remove('is-invalid');
      field.classList.add('is-valid');
    } else {
      field.classList.add('is-invalid');
      field.classList.remove('is-valid');
    }
    return isValid;
  };

  const validateField = (field, validator, {required = false} = {}) => {
    if (!field) {
      return true;
    }
    if (!required && !hasAnyValue(field.value)) {
      return setFieldValidity(field, true, {required});
    }
    return setFieldValidity(field, validator(field.value), {required});
  };

  const validateAll = () => {
    const addressRequired = hasAddressDetails();
    const validations = [
      validateField(fields.tomador_nome, validateMunicipio, {required: true}),
      validateField(fields.tomador_documento, validateCpfCnpj, {required: true}),
      validateField(fields.tomador_email, validateEmail),
      validateField(fields.tomador_cep, validateCep, {required: addressRequired}),
      validateField(fields.tomador_municipio, validateMunicipio, {required: addressRequired}),
      validateField(fields.tomador_uf, validateUf, {required: addressRequired}),
    ];
    return validations.every(Boolean);
  };

  const loadOrcamento = async (orcamentoId) => {
    if (!orcamentoId) {
      setSummaryMessage('Informe um orçamento para visualizar o resumo antes de enviar.');
      clearFields();
      lastOrcamentoId = null;
      return;
    }
    if (!endpointTemplate) {
      return;
    }
    setSummaryMessage('Carregando orçamento...');
    try {
      if (lastOrcamentoId !== String(orcamentoId)) {
        Object.values(fields).forEach((field) => {
          if (field) {
            delete field.dataset.nfseDirty;
          }
        });
        lastOrcamentoId = String(orcamentoId);
      }
      const endpoint = endpointTemplate.replace(/0$/, String(orcamentoId));
      const response = await fetch(endpoint, {headers: {'Accept': 'application/json'}});
      const payload = await response.json();
      if (!response.ok) {
        throw new Error(payload.error || 'Não foi possível carregar o orçamento.');
      }
      populateFields(payload);
      updateSummary(payload);
      validateAll();
      setSummaryMessage('');
    } catch (error) {
      console.error(error);
      setSummaryMessage('Não foi possível carregar o orçamento informado.');
      clearFields();
    }
  };

  if (fields.orcamento_id && fields.orcamento_id.value) {
    loadOrcamento(fields.orcamento_id.value);
  }
  if (fields.orcamento_id) {
    fields.orcamento_id.addEventListener('change', (event) => {
      loadOrcamento(event.target.value);
    });
  }

  [
    [fields.tomador_nome, validateMunicipio, {required: true}],
    [fields.tomador_documento, validateCpfCnpj, {required: true}],
    [fields.tomador_email, validateEmail, {required: false}],
    [fields.tomador_cep, validateCep, {required: () => hasAddressDetails()}],
    [fields.tomador_municipio, validateMunicipio, {required: () => hasAddressDetails()}],
    [fields.tomador_uf, validateUf, {required: () => hasAddressDetails()}],
  ].forEach(([field, validator, options]) => {
    if (!field) {
      return;
    }
    field.addEventListener('input', () => {
      field.dataset.nfseDirty = 'true';
      const required = typeof options.required === 'function' ? options.required() : options.required;
      validateField(field, validator, {required});
    });
    field.addEventListener('blur', () => {
      const required = typeof options.required === 'function' ? options.required() : options.required;
      validateField(field, validator, {required});
    });
  });

  Object.values(fields).forEach((field) => {
    if (!field) {
      return;
    }
    field.addEventListener('input', () => {
      field.dataset.nfseDirty = 'true';
    });
  });

  form.addEventListener('submit', (event) => {
    if (!validateAll()) {
      event.preventDefault();
      event.stopPropagation();
    }
  });
});
</script>
{% endblock %}
