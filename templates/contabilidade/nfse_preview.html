{% extends "layout.html" %}
{% set titulo = "Pr√©-visualiza√ß√£o Fiscal do Or√ßamento" %}

{% block main %}
<div class="container mt-4">
  <h2 class="mb-3">{{ titulo }}</h2>

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/contabilidade">Contabilidade</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('contabilidade_nfse') }}">NFS-e</a></li>
      <li class="breadcrumb-item active" aria-current="page">Pr√©-visualiza√ß√£o</li>
    </ol>
  </nav>

  {% if emission_result %}
    {% set alert_class = {
      'success': 'alert-success',
      'error': 'alert-danger',
      'info': 'alert-info'
    }.get(emission_result.status, 'alert-info') %}
    <div class="alert {{ alert_class }} d-flex flex-column gap-1">
      <strong>
        {% if emission_result.status == 'success' %}‚úî{% endif %}
        {% if emission_result.status == 'error' %}‚ùå{% endif %}
        {{ emission_result.title }}
      </strong>
      <span>{{ emission_result.subtitle }}</span>
      <span class="small text-muted">{{ emission_result.suggestion }}</span>
    </div>
  {% endif %}

  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="mb-3">Resumo fiscal</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="text-muted small">Tipo de nota</div>
              <div class="fw-semibold">NFS-e</div>
            </div>
            <div class="col-md-6">
              <div class="text-muted small">Valor total</div>
              <div class="fw-semibold">{{ orcamento.total | currency_br }}</div>
            </div>
            <div class="col-md-6">
              <div class="text-muted small">Munic√≠pio</div>
              <div class="fw-semibold">{{ municipio_label }}</div>
            </div>
            <div class="col-md-6">
              <div class="text-muted small">N¬∫ do or√ßamento</div>
              <div class="fw-semibold">#{{ orcamento.id }}</div>
            </div>
            <div class="col-md-6">
              <div class="text-muted small">üê∂ Animal</div>
              <div class="fw-semibold">{{ animal.name if animal else 'N√£o informado' }}</div>
            </div>
            <div class="col-md-6">
              <div class="text-muted small">üë§ Tutor</div>
              <div class="fw-semibold">{{ tutor.name if tutor else 'N√£o informado' }}</div>
            </div>
          </div>

          <hr class="my-4">

          <h6 class="mb-2">Status fiscal</h6>
          <ul class="list-group list-group-flush">
            {% for check in checks %}
              <li class="list-group-item d-flex justify-content-between align-items-start gap-3">
                <div>
                  <div class="fw-semibold">{{ check.label }}</div>
                  <div class="text-muted small">{{ check.detail }}</div>
                </div>
                {% if check.ok %}
                  <span class="badge bg-success">OK</span>
                {% else %}
                  <span class="badge bg-danger">Pendente</span>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">Aceite antes de emitir</h5>
          {% if blocking_errors %}
            <div class="alert alert-warning">
              <strong>Antes de emitir, corrija:</strong>
              <ul class="mb-0 mt-2">
                {% for error in blocking_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <div class="alert alert-success">
              Tudo certo! Voc√™ pode emitir a NFS-e com seguran√ßa.
            </div>
          {% endif %}

          <form method="post" action="{{ url_for('contabilidade_nfse_emitir') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="orcamento_id" value="{{ orcamento.id }}">
            {% if consulta %}
              <input type="hidden" name="consulta_id" value="{{ consulta.id }}">
            {% endif %}
            <button class="btn btn-primary w-100" type="submit" {% if not can_emit %}disabled{% endif %}>
              Emitir NFS-e
            </button>
          </form>

          <div class="small text-muted mt-3">
            O bot√£o √© habilitado somente quando todos os status fiscais est√£o OK.
          </div>

          <a class="btn btn-link mt-3 px-0" href="{{ url_for('contabilidade_nfse') }}">
            Voltar para NFS-e
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
