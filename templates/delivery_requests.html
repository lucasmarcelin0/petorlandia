{% extends "layout.html" %}
{% block main %}
<div class="container my-4">

  <!-- KPIs -->
  <div class="row g-3 mb-4 text-center">
    <div class="col-6 col-lg-2">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="card-title mb-0">{{ kpis.produtos }}</h5>
          <small class="text-muted">Produtos</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-2">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="card-title mb-0">{{ kpis.pendentes }}</h5>
          <small class="text-warning">Pendentes</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-2">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="card-title mb-0">{{ kpis.andamento }}</h5>
          <small class="text-info">Em andamento</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-2">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="card-title mb-0">{{ kpis.concluidos }}</h5>
          <small class="text-success">ConcluÃ­dos</small>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="card-title mb-0">R$ {{ kpis.faturado|round(2) }}</h5>
          <small class="text-muted">Faturado em entregas</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Produtos -->
  <h4 class="mb-3">ðŸ“¦ Produtos em Estoque</h4>
  <ul class="list-group shadow-sm mb-5">
    {% for p in products %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        {{ p.name }}
        <span class="badge bg-secondary rounded-pill">{{ p.stock }}</span>
      </li>
    {% else %}
      <li class="list-group-item text-muted">Nenhum produto cadastrado.</li>
    {% endfor %}
  </ul>

  <!-- Helper macro para listar entregas -->
  {% macro bloco_entregas(lista, titulo, cor_badge, label_badge) %}
    <h4 class="mt-4 {{ cor_badge }}">{{ titulo }}</h4>
    <ul class="list-group shadow-sm mb-5">
      {% for r in lista %}
        {% set pedido = r.order %}
        {% set comprador = pedido.user if pedido else None %}
        <li class="list-group-item d-flex justify-content-between flex-column flex-md-row align-items-start align-items-md-center">
          <div class="me-3">
            <div class="fw-semibold">
              PedidoÂ #{{ r.order_id }}
              <span class="badge {{ cor_badge }} ms-2">{{ label_badge }}</span>
            </div>
            <div class="small text-muted">
              <div>Cliente: {{ comprador.name if comprador else "â€”" }}</div>
              <div>Valor: R$ {{ pedido.total_value()|round(2) if pedido else "â€”" }}</div>
              {% if r.status == 'pendente' %}
                <div>Solicitado em {{ r.requested_at.strftime('%d/%m/%YÂ %H:%M') }}</div>
              {% elif r.status == 'em_andamento' %}
                <div>Aceito por {{ r.worker.name if r.worker else "â€”" }} em {{ r.accepted_at.strftime('%d/%m/%YÂ %H:%M') if r.accepted_at else "â€”" }}</div>
              {% elif r.status == 'concluida' %}
                <div>ConcluÃ­do em {{ r.completed_at.strftime('%d/%m/%YÂ %H:%M') if r.completed_at else "â€”" }}</div>
              {% endif %}
            </div>
          </div>
          <a class="btn btn-sm btn-outline-primary mt-2 mt-md-0"
             href="{{ url_for('admin_delivery_detail', req_id=r.id) }}">
             Ver detalhes
          </a>
        </li>
      {% else %}
        <li class="list-group-item text-muted">NÃ£o hÃ¡ registros.</li>
      {% endfor %}
    </ul>
  {% endmacro %}

  {{ bloco_entregas(open_requests,  "ðŸŸ¡Â SolicitaÃ§ÃµesÂ Abertas",  "bg-warning text-dark", "Pendente") }}
  {{ bloco_entregas(in_progress,    "ðŸ”µÂ EmÂ Andamento",          "bg-info text-dark",   "Em andamento") }}
  {{ bloco_entregas(completed,      "âœ…Â ConcluÃ­dos",            "bg-success",          "ConcluÃ­do") }}

</div>
{% endblock %}
