{# templates/delivery_requests.html #}
{% extends "layout.html" %}

{% block main %}
<div class="container py-4">

  <h2 class="fw-bold mb-4">üöö Minhas Entregas</h2>

  {# ========== helper macro p/ cart√£o ========== #}
  {% macro card(req, color) -%}
    {% set ord = req.order %}
    <div class="card mb-3 border-0 shadow-sm bg-{{ color }} bg-opacity-10">
      <div class="card-body d-flex justify-content-between flex-column flex-md-row align-items-start align-items-md-center">

        <div class="me-3">
          <h6 class="mb-1 fw-semibold">
            Pedido¬†#{{ req.order_id }}
            {% if req.status == 'pendente'      %}<span class="badge bg-warning text-dark ms-2">Pendente</span>{% endif %}
            {% if req.status == 'em_andamento'  %}<span class="badge bg-info  text-dark ms-2">Em andamento</span>{% endif %}
            {% if req.status == 'concluida'     %}<span class="badge bg-success         ms-2">Conclu√≠do</span>{% endif %}
            {% if req.status == 'cancelada'     %}<span class="badge bg-danger          ms-2">Cancelado</span>{% endif %}
          </h6>

          <div class="small text-muted">
            {% if ord and ord.user %}Cliente: {{ ord.user.name }}<br>{% endif %}
            {% if ord %}Valor: R$ {{ ((ord.payment.__dict__.get('amount') if ord.payment else None) or ord.total_value()) | round(2) }}<br>{% endif %}

            {% if req.status == 'pendente'      %}
              Solicitado {{ req.requested_at|format_datetime_brazil('%d/%m/%Y %H:%M') }}
            {% elif req.status == 'em_andamento' %}
              Aceito {{ req.accepted_at|format_datetime_brazil('%d/%m/%Y %H:%M') if req.accepted_at else '' }}
            {% elif req.status == 'concluida'    %}
              Conclu√≠do {{ req.completed_at|format_datetime_brazil('%d/%m/%Y %H:%M') if req.completed_at else '' }}
            {% elif req.status == 'cancelada'    %}
              Cancelado {{ req.canceled_at|format_datetime_brazil('%d/%m/%Y %H:%M') if req.canceled_at else '' }}
            {% endif %}
          </div>
        </div>

        {# -------- Bot√µes s√≥ para entregador -------- #}
        {% if current_user.worker == 'delivery' %}
          {% if req.status == 'pendente' %}
            <form action="{{ url_for('accept_delivery', req_id=req.id) }}" method="post">
              <button class="btn btn-sm btn-primary">Aceitar</button>
            </form>

          {% elif req.status == 'em_andamento' and req.worker_id == current_user.id %}
            <div class="d-flex">
<a href="{{ url_for('delivery_detail', req_id=req.id) }}"
                 class="btn btn-sm btn-outline-primary me-2">
                 Detalhes
              </a>
              <button class="btn btn-sm btn-success me-2" data-bs-toggle="modal" data-bs-target="#completeModal{{ req.id }}">Concluir</button>
              <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal{{ req.id }}">Cancelar</button>

              <!-- Modal Concluir -->
              <div class="modal fade" id="completeModal{{ req.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Concluir entrega</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <form action="{{ url_for('complete_delivery', req_id=req.id) }}" method="post">
                      <div class="modal-body">
                        Tem certeza que deseja concluir esta entrega?
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                        <button class="btn btn-success">Concluir</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Modal Cancelar -->
              <div class="modal fade" id="cancelModal{{ req.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Cancelar entrega</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <form action="{{ url_for('cancel_delivery', req_id=req.id) }}" method="post">
                      <div class="modal-body">
                        <p class="mb-2">Tem certeza que deseja cancelar esta entrega?</p>
                        <div class="mb-2">
                          <label class="form-label">Motivo</label>
                          <textarea name="reason" class="form-control" rows="3"></textarea>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                        <button class="btn btn-danger">Cancelar</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% endif %}

      </div>
    </div>
  {%- endmacro %}

  {# ========== ACCORDIONS ========== #}
  <div class="accordion" id="accordionEntregas">

    {% if current_user.worker == 'delivery' %}
      {# ---------- Pendentes ---------- #}
      <div class="accordion-item">
        <h2 class="accordion-header" id="headPend">
          <button class="accordion-button" type="button"
                  data-bs-toggle="collapse" data-bs-target="#panePend">
            üü°¬†Dispon√≠veis¬†({{ available_total }})
          </button>
        </h2>
        <div id="panePend" class="accordion-collapse collapse show"
             data-bs-parent="#accordionEntregas">
          <div class="accordion-body p-1">
            {% if available %}
              {% for r in available %}{{ card(r, 'warning') }}{% endfor %}
            {% else %}
              <p class="text-muted px-2">Nenhuma tarefa dispon√≠vel.</p>
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}

    {# ---------- Em andamento ---------- #}
    <div class="accordion-item">
      <h2 class="accordion-header" id="headDoing">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#paneDoing">
          üîµ¬†Em¬†Andamento¬†({{ doing|length }})
        </button>
      </h2>
      <div id="paneDoing" class="accordion-collapse collapse"
           data-bs-parent="#accordionEntregas">
        <div class="accordion-body p-1">
          {% if doing %}
            {% for r in doing %}{{ card(r, 'info') }}{% endfor %}
          {% else %}
            <p class="text-muted px-2">Nenhum pedido em andamento.</p>
          {% endif %}
        </div>
      </div>
    </div>

    {# ---------- Conclu√≠dos ---------- #}
    <div class="accordion-item">
      <h2 class="accordion-header" id="headDone">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#paneDone">
          ‚úÖ¬†Conclu√≠dos¬†({{ done|length }})
        </button>
      </h2>
      <div id="paneDone" class="accordion-collapse collapse"
           data-bs-parent="#accordionEntregas">
        <div class="accordion-body p-1">
          {% if done %}
            {% for r in done %}{{ card(r, 'success') }}{% endfor %}
          {% else %}
            <p class="text-muted px-2">Nada conclu√≠do ainda.</p>
          {% endif %}
        </div>
      </div>
    </div>

    {# ---------- Cancelados ---------- #}
    <div class="accordion-item">
      <h2 class="accordion-header" id="headCancel">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#paneCancel">
          ‚ùå¬†Cancelados¬†({{ canceled|length }})
        </button>
      </h2>
      <div id="paneCancel" class="accordion-collapse collapse"
           data-bs-parent="#accordionEntregas">
        <div class="accordion-body p-1">
          {% if canceled %}
            {% for r in canceled %}{{ card(r, 'danger') }}{% endfor %}
          {% else %}
            <p class="text-muted px-2">Nenhum cancelamento registrado.</p>
          {% endif %}
        </div>
      </div>
    </div>

  </div><!-- /accordion -->
</div>
{% endblock %}
