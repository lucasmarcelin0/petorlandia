{% extends "layout.html" %}

{% block main %}
<div class="container mt-4">
  <h2>Agenda ‚Äì {{ veterinario.user.name }}</h2>

  <button class="btn btn-primary mb-3" onclick="toggleScheduleForm()">Adicionar Hor√°rio</button>
  <button class="btn btn-secondary mb-3 ms-2" onclick="toggleAppointmentForm()">Agendar Consulta</button>

  <div id="schedule-form-container" class="card mb-4 d-none">
    <div class="card-body">
      <h5 id="schedule-form-title" class="card-title">Adicionar Hor√°rio</h5>
      <form method="post" id="schedule-form">
        {{ schedule_form.hidden_tag() }}
        <div class="mb-3">
          {{ schedule_form.veterinario_id.label }}
          {{ schedule_form.veterinario_id(class="form-select") }}
        </div>
        <div class="mb-3">
          {{ schedule_form.dias_semana.label }}
          {{ schedule_form.dias_semana(class="form-select", multiple=True, size=7) }}
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('all')">Todos</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('weekday')">Dias √öteis</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('weekend')">Fins de Semana</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('clear')">Limpar</button>
          </div>
        </div>
        <div class="mb-3">
          {{ schedule_form.hora_inicio.label }}
          {{ schedule_form.hora_inicio(class="form-control") }}
        </div>
        <div class="mb-3">
          {{ schedule_form.hora_fim.label }}
          {{ schedule_form.hora_fim(class="form-control") }}
        </div>
        <div class="mb-3">
          {{ schedule_form.intervalo_inicio.label }}
          {{ schedule_form.intervalo_inicio(class="form-control") }}
        </div>
        <div class="mb-3">
          {{ schedule_form.intervalo_fim.label }}
          {{ schedule_form.intervalo_fim(class="form-control") }}
        </div>
        {{ schedule_form.submit(class="btn btn-primary") }}
        <button type="button" class="btn btn-secondary ms-2" onclick="hideForm('schedule-form-container')">Cancelar</button>
      </form>
    </div>
  </div>

  <div id="appointment-form-container" class="card mb-4 d-none">
    <div class="card-body">
      <h5 class="card-title">Agendar Consulta</h5>
      <form method="post">
        {{ appointment_form.hidden_tag() }}
        <div class="mb-3">
          {{ appointment_form.animal_id.label(class="form-label") }}
          {{ appointment_form.animal_id(class="form-select") }}
        </div>
        <div class="mb-3 d-none">
          {{ appointment_form.veterinario_id.label(class="form-label") }}
          {{ appointment_form.veterinario_id(class="form-select") }}
        </div>
        <div class="mb-3">
          {{ appointment_form.date.label(class="form-label") }}
          {{ appointment_form.date(class="form-control", type="date") }}
        </div>
        <div class="mb-3">
          {{ appointment_form.time.label(class="form-label") }}
          {{ appointment_form.time(class="form-control", type="time") }}
        </div>
        <div class="mb-3">
          {{ appointment_form.reason.label(class="form-label") }}
          {{ appointment_form.reason(class="form-control", rows=3) }}
        </div>
        {{ appointment_form.submit(class="btn btn-primary") }}
        <button type="button" class="btn btn-secondary ms-2" onclick="hideForm('appointment-form-container')">Cancelar</button>
      </form>
    </div>
  </div>

  <h3>Hor√°rios Cadastrados</h3>
  <ul class="list-unstyled">
    {% for h in horarios %}
      <li>
        {{ h.dia_semana }}: {{ h.hora_inicio.strftime('%H:%M') }} - {{ h.hora_fim.strftime('%H:%M') }}
        {% if h.intervalo_inicio and h.intervalo_fim %}
          (Intervalo: {{ h.intervalo_inicio.strftime('%H:%M') }} - {{ h.intervalo_fim.strftime('%H:%M') }})
        {% endif %}
        <button type="button" class="btn btn-sm btn-outline-primary ms-2 edit-btn"
                data-id="{{ h.id }}"
                data-dia="{{ h.dia_semana }}"
                data-hora-inicio="{{ h.hora_inicio.strftime('%H:%M') }}"
                data-hora-fim="{{ h.hora_fim.strftime('%H:%M') }}"
                data-intervalo-inicio="{{ h.intervalo_inicio.strftime('%H:%M') if h.intervalo_inicio else '' }}"
                data-intervalo-fim="{{ h.intervalo_fim.strftime('%H:%M') if h.intervalo_fim else '' }}">
          Editar
        </button>
        <form method="post" action="{{ url_for('delete_vet_schedule', veterinario_id=veterinario.id, horario_id=h.id) }}" class="d-inline">
          {{ schedule_form.csrf_token }}
          <button type="submit" class="btn btn-sm btn-outline-danger ms-2" onclick="return confirm('Excluir este hor√°rio?');">Excluir</button>
        </form>
      </li>
    {% else %}
      <li>Nenhum hor√°rio cadastrado.</li>
    {% endfor %}
  </ul>

  <h3>Consultas Agendadas</h3>
  <ul class="list-group">
    {% for appt in appointments %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>{{ appt.scheduled_at.strftime('%d/%m/%Y %H:%M') }} - {{ appt.animal.name }} ({{ appt.tutor.name }})</span>
        <div class="btn-group">
          <a href="{{ url_for('ficha_animal', animal_id=appt.animal_id) }}" class="btn btn-sm btn-outline-primary">üìã Ficha Animal</a>
          <a href="{{ url_for('ficha_tutor', tutor_id=appt.tutor_id) }}" class="btn btn-sm btn-outline-secondary">üë§ Ficha Tutor</a>
          <a href="{{ url_for('consulta_direct', animal_id=appt.animal_id) }}" class="btn btn-sm btn-outline-success">ü©∫ Iniciar Consulta</a>
          <a href="{{ url_for('edit_appointment', appointment_id=appt.id) }}" class="btn btn-sm btn-outline-warning">‚úèÔ∏è Editar</a>
        </div>
      </li>
    {% else %}
      <li class="list-group-item">Nenhuma consulta agendada.</li>
    {% endfor %}
  </ul>

  {% if colleague_schedules %}
  <h3 class="mt-4">Agendas da Equipe</h3>
  {% for item in colleague_schedules %}
    <h5>{{ item.veterinario.user.name }}</h5>
    <ul class="list-unstyled">
      {% for h in item.horarios %}
        <li>{{ h.dia_semana }}: {{ h.hora_inicio.strftime('%H:%M') }} - {{ h.hora_fim.strftime('%H:%M') }}</li>
      {% else %}
        <li>Sem hor√°rios cadastrados.</li>
      {% endfor %}
    </ul>
  {% endfor %}
  {% endif %}
</div>
<script>
  function selectDays(mode) {
    const select = document.getElementById('schedule-dias_semana');
    const weekdays = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta'];
    const weekend = ['S√°bado','Domingo'];
    for (const opt of select.options) {
      if (mode === 'all') opt.selected = true;
      else if (mode === 'weekday') opt.selected = weekdays.includes(opt.value);
      else if (mode === 'weekend') opt.selected = weekend.includes(opt.value);
      else if (mode === 'clear') opt.selected = false;
    }
  }

  function toggleScheduleForm() {
    const container = document.getElementById('schedule-form-container');
    if (container.classList.contains('d-none')) {
      showScheduleForm(false);
    } else {
      hideForm('schedule-form-container');
    }
  }

  function showScheduleForm(isEdit, data) {
    const container = document.getElementById('schedule-form-container');
    const title = document.getElementById('schedule-form-title');
    const form = document.getElementById('schedule-form');
    const select = document.getElementById('schedule-dias_semana');
    const horaInicio = document.getElementById('schedule-hora_inicio');
    const horaFim = document.getElementById('schedule-hora_fim');
    const intervaloInicio = document.getElementById('schedule-intervalo_inicio');
    const intervaloFim = document.getElementById('schedule-intervalo_fim');

    form.reset();
    document.getElementById('schedule-veterinario_id').value = '{{ veterinario.id }}';

    if (isEdit) {
      title.textContent = 'Editar Hor√°rio';
      form.action = `/appointments/{{ veterinario.id }}/schedule/${data.id}/edit`;
      select.multiple = false;
      [...select.options].forEach(opt => opt.selected = opt.value === data.dia);
      horaInicio.value = data.horaInicio;
      horaFim.value = data.horaFim;
      intervaloInicio.value = data.intervaloInicio;
      intervaloFim.value = data.intervaloFim;
    } else {
      title.textContent = 'Adicionar Hor√°rio';
      form.action = `{{ url_for('appointments') }}`;
      select.multiple = true;
    }
    container.classList.remove('d-none');
  }

  function editSchedule(data) {
    showScheduleForm(true, data);
  }

  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      editSchedule(this.dataset);
    });
  });

  function toggleAppointmentForm() {
    document.getElementById('appointment-form-container').classList.toggle('d-none');
  }

  function hideForm(id) {
    document.getElementById(id).classList.add('d-none');
  }
</script>
{% endblock %}
