<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Exames de {{ animal.name }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='print.css') }}">
  <style>
    .top-info {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 20px;
    }

    .info-box {
      flex: 1;
      border: 1px solid #000;
      padding: 10px;
      font-size: 11pt;
      line-height: 1.4;
    }

    .exames {
      border: 1px dashed #666;
      padding: 15px;
      background-color: #fdfdfd;
      font-size: 12pt;
      line-height: 1.6;
      margin-bottom: 1.5em;
    }

    .exame-item {
      margin-bottom: 12px;
    }

    .exame-item:last-child {
      margin-bottom: 0;
    }

    .exame-item strong {
      font-size: 13pt;
    }
  </style>

</head>
<body>

  <!-- Bot√µes -->
  <div class="no-print" style="margin-bottom: 1em;">
    <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
    <button onclick="abrirAssinatura()" style="margin-left: 5px;">üîè Assinar</button>
    <button onclick="enviarWhatsApp()" id="btn-whatsapp" style="margin-left: 5px;">üì± WhatsApp</button>
    <a href="{{ url_for('consulta_direct', animal_id=animal.id) }}"
       style="margin-left: 15px;">‚Üê Voltar</a>
  </div>

  <div class="document">
    {% if clinica.logotipo %}
      {% set logo_src = clinica.logotipo if clinica.logotipo.startswith('http')
                         else url_for('static', filename='uploads/clinicas/' + clinica.logotipo) %}
      <div class="header">
        <img src="{{ logo_src }}" alt="Logotipo da cl√≠nica">
        <div class="clinica-nome">{{ clinica.nome }}</div>
        <img src="{{ logo_src }}" alt="Logotipo da cl√≠nica">
      </div>
    {% endif %}

    <h2>Solicita√ß√£o de Exames</h2>

    <div class="top-info">
      {% if current_user.name or (current_user.veterinario and current_user.veterinario.crmv) %}
        <div class="info-box">
          <strong>Veterin√°rio:</strong><br>
          {% if current_user.name %}
            {{ current_user.name }}<br>
          {% endif %}
          {% if current_user.veterinario and current_user.veterinario.crmv %}
            CRMV: {{ current_user.veterinario.crmv }}
          {% endif %}
        </div>
      {% endif %}

      {% if animal.name or animal.species or animal.breed or animal.sex or animal.microchip_number %}
        <div class="info-box">
          <strong>Animal:</strong><br>
          {% if animal.name %}
            Nome: {{ animal.name }}<br>
          {% endif %}
          {% if animal.species %}
            Esp√©cie: {{ animal.species }}<br>
          {% endif %}
          {% if animal.breed %}
            Ra√ßa: {{ animal.breed }}<br>
          {% endif %}
          {% if animal.sex %}
            Sexo: {{ animal.sex }}<br>
          {% endif %}
          {% if animal.microchip_number %}
            Microchip: {{ animal.microchip_number }}
          {% endif %}
        </div>
      {% endif %}

      {% if tutor.name or tutor.cpf or tutor.address %}
        <div class="info-box">
          <strong>Tutor:</strong><br>
          {% if tutor.name %}
            Nome: {{ tutor.name }}<br>
          {% endif %}
          {% if tutor.cpf %}
            CPF: {{ tutor.cpf }}<br>
          {% endif %}
          {% if tutor.address %}
            Endere√ßo: {{ tutor.address }}
          {% endif %}
        </div>
      {% endif %}
    </div>

    <div class="section-title">Exames Solicitados:</div>
    <div class="exames">
      {% for exame in bloco.exames %}
        <div class="exame-item">
          üß™ <strong>{{ exame.nome }}</strong><br>
          <em>{{ exame.justificativa }}</em>
        </div>
      {% endfor %}
    </div>

    {% if bloco.observacoes_gerais %}
      <div class="section-title">Observa√ß√µes Gerais:</div>
      <p>{{ bloco.observacoes_gerais }}</p>
    {% endif %}

    <div class="assinatura">
      ___________________________________________<br>
      <span>{{ current_user.name }}<br>CRMV: {{ current_user.veterinario.crmv if current_user.veterinario else '‚Äî' }}</span>
    </div>

    <footer>
      {{ clinica.nome }} ‚Äì {{ clinica.endereco }}<br>
      Telefone: {{ clinica.telefone }} ‚Äì Email: {{ clinica.email }} ‚Äì CNPJ: {{ clinica.cnpj }}
    </footer>
  </div>

<script>
  const numeroWhatsApp = "{{ tutor.phone | digits_only if tutor and tutor.phone else '' }}";
  const btnWhats = document.getElementById('btn-whatsapp');
  if (!numeroWhatsApp && btnWhats) {
    btnWhats.style.display = 'none';
  }

  function abrirAssinatura() {
    if (confirm('Abrir p√°gina de assinatura agora?')) {
      window.open('https://assinador.iti.br/assinatura/index.xhtml', '_blank');
    }
  }

  function enviarWhatsApp() {
    if (!numeroWhatsApp) {
      alert('N√∫mero de telefone do tutor n√£o informado.');
      return;
    }
    const mensagem = encodeURIComponent('Ol√° {{ tutor.name }}! Segue a solicita√ß√£o de exames de {{ animal.name }}: ' + window.location.href + ' Qualquer d√∫vida, estamos √† disposi√ß√£o. Equipe PetOrl√¢ndia.');
    const url = `https://api.whatsapp.com/send?phone=${numeroWhatsApp}&text=${mensagem}`;
    try {
      const wpp = window.open(url, '_blank');
      if (!wpp) {
        alert('N√£o foi poss√≠vel abrir o WhatsApp. Verifique o bloqueador de pop-ups.');
      }
    } catch (err) {
      console.error('Erro ao abrir WhatsApp:', err);
      alert('Ocorreu um erro ao abrir o WhatsApp. Tente novamente.');
    }
  }
</script>

</body>

</html>
