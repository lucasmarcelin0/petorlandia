{% from 'components/logo.html' import clinic_logo %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
  {% block head %}
  {% endblock %}
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='pastorgato.png') }}">

  <meta charset="UTF-8">
  <title>PetOrl√¢ndia üê∂</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="#4e73df">
  <meta name="csrf-token" content="{{ csrf_token() if csrf_token is defined else '' }}">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 -->
  <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>

  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <link href="{{ url_for('static', filename='images.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/clinic.css') }}" rel="stylesheet">

</head>

{% set flash_messages = get_flashed_messages(with_categories=true) %}

<!-- Bootstrap Tooltip e Popover -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (el) {
      new bootstrap.Tooltip(el);
    });

    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.forEach(function (el) {
      new bootstrap.Popover(el);
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const navbar = document.querySelector('.navbar');
    const updateNavbarHeight = () => {
      if (navbar) {
        document.documentElement.style.setProperty('--topbar-height', navbar.offsetHeight + 'px');
      }
    };
    updateNavbarHeight();
    window.addEventListener('resize', updateNavbarHeight);
  });
</script>

<body>
  <nav class="navbar navbar-expand-lg fixed-top navbar-light">
    <div class="container-fluid">
      {% if current_user.is_authenticated and current_user.role == "admin" %}
      <a href="{{ url_for('painel_admin.index') }}" class="navbar-brand">

        <img src="{{ url_for('static', filename='pastorgato.png') }}" alt="Logo" class="logo-img">
        <span>PetOrl√¢ndia</span>
      </a>
      {% else %}
      <a href="{{ url_for('index') }}" class="navbar-brand">
        <img src="{{ url_for('static', filename='pastorgato.png') }}" alt="Logo" class="logo-img">
        <span>PetOrl√¢ndia</span>

      </a>
      {% endif %}

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav align-items-center gap-2">
          {% if current_user.is_authenticated and current_user.role == "admin" %}
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('delivery_overview') }}">
              <i class="fas fa-chart-line me-1 text-primary"></i> Entregas
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('planos_dashboard') }}">
              <i class="fas fa-chart-pie me-1 text-success"></i> Planos
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('admin_tutor_map') }}">
              <i class="fas fa-map-marked-alt me-1 text-info"></i> Mapa
            </a>
          </li>
          {% endif %}

          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('index') }}">
              <i class="fas fa-home me-1 text-primary"></i> In√≠cio
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('loja') }}">
              <i class="fas fa-shopping-bag me-1 text-warning"></i> Loja
            </a>
          </li>
          {% if current_user.is_authenticated %}
          {% if current_user.worker == 'delivery' %}
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('list_delivery_requests') }}">
              <i class="fas fa-truck me-1 text-warning"></i> Solicita√ß√µes
            </a>
          </li>
          {% endif %}

          {% if is_active_veterinarian %}
          <li class="nav-item position-relative">
            <a class="nav-link" href="{{ url_for('appointments') }}">
              <i class="fas fa-calendar-alt me-1 text-success"></i> Agenda
              {% set total_pending = pending_exam_count + pending_appointment_count + clinic_pending_appointment_count
              %}
              {% if total_pending > 0 %}
              <span class="badge rounded-pill bg-danger position-absolute top-0 start-100 translate-middle">{{
                total_pending }}</span>
              {% endif %}
            </a>
          </li>
          {% endif %}

          <li class="nav-item position-relative">
            {% if current_user.role == 'admin' %}
            <a class="nav-link" href="{{ url_for('mensagens_admin') }}">
              {% else %}
              <a class="nav-link" href="{{ url_for('mensagens') }}">
                {% endif %}
                <i class="fas fa-comments me-1 text-info"></i> Mensagens
                {% if unread_messages > 0 %}
                <span class="badge rounded-pill bg-danger position-absolute top-0 start-100 translate-middle">
                  {{ unread_messages }}
                </span>
                {% endif %}
              </a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-user-circle me-1 text-primary"></i> {{ current_user.name.split(' ')[0] }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="{{ url_for('profile') }}"><i class="fas fa-user me-2 text-primary"></i>
                  Meu Perfil</a></li>
              <li><a class="dropdown-item" href="{{ url_for('minhas_compras') }}"><i
                    class="fas fa-box me-2 text-warning"></i> Minhas Compras</a></li>
              {% if current_user.veterinario or (current_user.clinica and current_user.worker == 'colaborador') %}
              <li><a class="dropdown-item" href="{{ url_for('minha_clinica') }}"><i
                    class="fas fa-clinic-medical me-2 text-info"></i> Minha Cl√≠nica</a></li>
              {% endif %}
              {% if has_veterinarian_profile_flag %}
              <li><a class="dropdown-item" href="{{ url_for('veterinarian_membership') }}"><i
                    class="fas fa-credit-card me-2 text-success"></i> Assinatura de Veterin√°rio</a></li>
              {% endif %}

              <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i
                    class="fas fa-sign-out-alt me-2 text-danger"></i> Sair</a></li>
            </ul>
          </li>
          {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('register') }}">
              <i class="fas fa-user-plus me-1 text-success"></i> Registrar
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('login_view') }}">
              <i class="fas fa-sign-in-alt me-1 text-primary"></i> Entrar
            </a>
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  {% if flash_messages %}
  {% for category, message in flash_messages %}
  <div class="alert-container">
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  </div>
  {% endfor %}
  {% endif %}

  <!-- Main Content -->
  <main class="container">
    {% block main %}
    {% endblock %}
  </main>

  <!-- Footer -->
  <footer>
    &copy; Lucas Marcelino ‚Ä¢ PetOrl√¢ndia 2025
    <a href="{{ url_for('secret_game') }}" target="_blank" rel="noopener" class="ms-1 text-decoration-none text-primary"
      title="Surpresa!">
      <i class="fas fa-paw text-primary"></i>
      <span class="visually-hidden">Abrir o easter egg</span>
    </a>
  </footer>
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirma√ß√£o</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="confirmModalOk">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  {% block messages %}
  <div class="position-fixed bottom-0 end-0 p-3 toast-stack" aria-live="polite" aria-atomic="true">
    <div id="actionToast" class="toast text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Fechar"></button>
      </div>
    </div>
  </div>
  {% endblock %}

  <!-- Script para desaparecer com transi√ß√£o suave -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const alertContainers = document.querySelectorAll('.alert-container');

      setTimeout(() => {
        alertContainers.forEach(container => {
          container.classList.add('shrink');
          setTimeout(() => {
            container.remove();
          }, 600); // tempo igual ao CSS
        });
      }, 3000); // aparece por 3 segundos
    });
  </script>

  <script>
    const TOAST_BG_CLASSES = ['bg-danger', 'bg-info', 'bg-success', 'bg-warning', 'bg-primary', 'bg-secondary', 'bg-dark', 'bg-light'];

    function normalizeToastCategory(category) {
      if (!category) {
        return 'success';
      }
      const normalized = String(category).toLowerCase();
      if (normalized === 'error') {
        return 'danger';
      }
      const allowed = ['success', 'danger', 'warning', 'info', 'primary', 'secondary', 'dark', 'light'];
      return allowed.includes(normalized) ? normalized : 'info';
    }

    function applyToastTone(toastEl, category) {
      if (!toastEl) {
        return;
      }
      TOAST_BG_CLASSES.forEach(cls => toastEl.classList.remove(cls));
      toastEl.classList.add('bg-' + normalizeToastCategory(category));
    }

    function setToastMessage(toastEl, message, category) {
      if (!toastEl) {
        return { toneCategory: normalizeToastCategory(category) };
      }

      const body = toastEl.querySelector('.toast-body');
      if (!body) {
        return { toneCategory: normalizeToastCategory(category) };
      }

      const normalized = normalizeToastCategory(category);
      const isObject = message && typeof message === 'object';
      const isEmpty = message === undefined || message === null || message === '';

      body.classList.remove('toast-success-only');

      if ((isObject || isEmpty) && normalized === 'success') {
        body.innerHTML = '<span class="toast-success-icon" aria-hidden="true">‚úÖ</span><span class="visually-hidden">Sucesso</span>';
        body.classList.add('toast-success-only');
        return { toneCategory: normalized };
      }

      if (typeof message === 'string') {
        body.textContent = message;
        return { toneCategory: normalized };
      }

      if (isObject) {
        body.textContent = message.message || 'Erro ao processar a√ß√£o';
        return { toneCategory: normalized };
      }

      body.textContent = String(message || '');
      return { toneCategory: normalized };
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const flashMessages = {{ flash_messages| tojson
    }};
    flashMessages.forEach(([category, message], idx) => {
      setTimeout(() => {
        const toastEl = document.getElementById('actionToast');
        const { toneCategory } = setToastMessage(toastEl, message, category || 'success');
        applyToastTone(toastEl, toneCategory);
        new bootstrap.Toast(toastEl).show();
      }, idx * 1000);
    });

    const confirmModalEl = document.getElementById('confirmModal');
    const confirmModal = new bootstrap.Modal(confirmModalEl);
    const confirmBtn = document.getElementById('confirmModalOk');
    let confirmTarget = null;

    document.querySelectorAll('form.js-confirm').forEach(form => {
      form.addEventListener('submit', ev => {
        if (form.dataset.confirmed) { return; }
        ev.preventDefault();
        confirmTarget = form;
        const msg = form.dataset.message || 'Tem certeza?';
        confirmModalEl.querySelector('.modal-body').textContent = msg;
        confirmModal.show();
      });
    });

    confirmBtn.addEventListener('click', () => {
      if (confirmTarget) {
        confirmTarget.dataset.confirmed = 'true';
        confirmTarget.submit();
      }
      confirmModal.hide();
    });
        });
  </script>

  {% if MERCADOPAGO_PUBLIC_KEY %}
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script>
    const mp = new MercadoPago("{{ MERCADOPAGO_PUBLIC_KEY }}", { locale: 'pt-BR' });
  </script>
  {% endif %}
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('{{ url_for('service_worker') }}');
    }
  </script>
  <script src="{{ url_for('static', filename='offline.js') }}"></script>
  <script src="{{ url_for('static', filename='js/form_feedback.js') }}" defer></script>
  <script src="{{ url_for('static', filename='photo_cropper.js') }}"></script>
  <script src="{{ url_for('static', filename='js/listing_panels.js') }}"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const normalizeFetchResult = (result) => ({
        response: result && result.response ? result.response : null,
        queued: Boolean(result && result.queued),
      });

      const parseJsonSafe = async (response) => {
        if (!response) return null;
        const contentType = response.headers.get('Content-Type') || '';
        if (!contentType.includes('application/json')) return null;
        try {
          const clone = response.clone();
          return await clone.json();
        } catch (err) {
          return null;
        }
      };

      const isLikelySuccess = (response) => {
        if (!response) return false;
        if (response.ok) return true;
        if (response.type === 'opaqueredirect') return true;
        const status = Number(response.status) || 0;
        return status >= 200 && status < 400;
      };

      const applyDeliveryCounts = (counts) => {
        if (!counts) return;
        const mapping = {
          'available-count': counts.available_total,
          'doing-count': counts.doing,
          'done-count': counts.done,
          'canceled-count': counts.canceled,
        };
        Object.entries(mapping).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) {
            el.textContent = value;
          }
        });
      };

      const getCsrfToken = (form) => {
        const formInput = form?.querySelector('input[name="csrf_token"]');
        if (formInput?.value) return formInput.value;
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta?.content) return meta.content;
        return '';
      };

      // attachDeliveryFormListeners ser√° definido mais adiante,
      // ent√£o usamos uma refer√™ncia que ser√° populada posteriormente
      let attachDeliveryFormListenersRef = () => { };

      const applyDeliveryPayload = (data) => {
        const container = document.getElementById('delivery-sections');
        if (data?.html && container) {
          container.innerHTML = data.html;
        }
        if (data?.counts) {
          applyDeliveryCounts(data.counts);
        }
        if (data?.html) {
          attachDeliveryFormListenersRef();
        }
      };

      const refreshDeliverySections = async () => {
        const container = document.getElementById('delivery-sections');
        if (!container) return;
        try {
          const resp = await fetch('/delivery_requests', {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          if (!resp.ok) return;

          let data = await parseJsonSafe(resp);
          if (!data) {
            const html = await resp.clone().text();
            data = html ? { html } : null;
          }

          applyDeliveryPayload(data);
        } catch (err) {
          console.error('Erro ao atualizar entregas', err);
        }
      };

      // Torna o atualizador acess√≠vel para outros scripts (ex: a√ß√µes do admin)
      window.refreshDeliverySections = refreshDeliverySections;

      const ensureMessageCategory = (payload, fallbackMessage, fallbackCategory) => ({
        ...(payload || {}),
        message: (payload && (payload.message || payload.error)) || fallbackMessage,
        category: (payload && payload.category) || fallbackCategory,
      });

      const emitSyncEvent = (detail) => {
        const event = new CustomEvent('form-sync-success', { detail, cancelable: true });
        document.dispatchEvent(event);
        return event;
      };

      const parseErrorMessage = async (response, fallback = 'Erro ao processar a√ß√£o') => {
        if (!response) return fallback;
        const data = await parseJsonSafe(response);
        if (data?.message) return data.message;
        try {
          const text = await response.clone().text();
          const cleaned = text.trim();
          if (cleaned) {
            return cleaned.length > 180 ? `${cleaned.slice(0, 180)}‚Ä¶` : cleaned;
          }
        } catch (err) { /* ignore */ }
        return fallback;
      };

      const showToast = (message, category = 'info') => {
        const toastEl = document.getElementById('actionToast');
        if (!toastEl) return;
        const { toneCategory } = setToastMessage(toastEl, message || '', category);
        applyToastTone(toastEl, toneCategory);
        bootstrap.Toast.getOrCreateInstance(toastEl).show();
      };

      const attachDeliveryFormListeners = () => {
        document.querySelectorAll('.js-delivery-form').forEach(form => {
          if (form.dataset.deliveryListenerAttached === 'true') return;
          form.dataset.deliveryListenerAttached = 'true';
          form.addEventListener('submit', async ev => {
            const canHandle = typeof fetchOrQueue === 'function';
            if (!canHandle) return;

            ev.preventDefault();
            const url = form.action;
            const handle = async () => {
              try {
                const formData = new FormData(form);
                const headers = {
                  'Accept': 'application/json',
                  'X-Requested-With': 'XMLHttpRequest',
                };
                const csrfToken = getCsrfToken(form);
                if (csrfToken) headers['X-CSRFToken'] = csrfToken;

                const { response, queued } = normalizeFetchResult(await fetchOrQueue(url, {
                  method: 'POST',
                  body: formData,
                  headers,
                  credentials: 'same-origin',
                }));

                if (queued) {
                  const queuedDetail = { form, data: { message: 'Aguardando conex√£o para concluir o envio.', category: 'info' }, response: null, offlineQueued: true, success: true };
                  emitSyncEvent(queuedDetail);
                  showToast('A√ß√£o salva para sincroniza√ß√£o quando estiver online.', 'info');
                  return { success: true, message: queuedDetail.data.message, level: queuedDetail.data.category, successText: 'Sincronizando‚Ä¶', resetDelay: 2500, offlineQueued: true };
                }

                const data = await parseJsonSafe(response);
                const hasDeliverySections = Boolean(document.getElementById('delivery-sections'));
                const successLike = isLikelySuccess(response);

                if (successLike) {
                  const successData = ensureMessageCategory(
                    data,
                    (data && (data.message || data.error)) || 'Sucesso',
                    (data && data.category) || 'success',
                  );

                  if (hasDeliverySections && data) {
                    applyDeliveryPayload(data);
                  }

                  if (data?.redirect && !form.dataset.forceRedirect && hasDeliverySections) {
                    if (!data?.html) {
                      await refreshDeliverySections();
                    }
                    const eventDetail = {
                      form,
                      data: successData,
                      response,
                      responseOk: successLike,
                      offlineQueued: false,
                      success: true,
                    };
                    emitSyncEvent(eventDetail);
                    showToast(successData.message, successData.category);
                    return { success: true, message: successData.message, level: successData.category };
                  }

                  if (data?.redirect) {
                    window.location.href = data.redirect;
                    return { success: true, keepButton: true };
                  }

                  if (response?.redirected && response.url) {
                    window.location.href = response.url;
                    return { success: true, keepButton: true };
                  }

                  showToast(successData.message, successData.category);
                  await refreshDeliverySections();
                  emitSyncEvent({
                    form,
                    data: successData,
                    response,
                    responseOk: successLike,
                    offlineQueued: false,
                    success: true,
                  });
                  return { success: true, message: successData.message, level: successData.category };
                }

                const errorMessage = (data && (data.message || data.error)) || await parseErrorMessage(response);
                const errorCategory = (data && data.category) || 'danger';
                const errorData = ensureMessageCategory(data, errorMessage, errorCategory);
                if (hasDeliverySections) {
                  if (data?.html) {
                    applyDeliveryPayload(data);
                  } else {
                    await refreshDeliverySections();
                  }
                }
                emitSyncEvent({
                  form,
                  data: errorData,
                  response,
                  responseOk: false,
                  offlineQueued: false,
                  success: false,
                });
                showToast(errorData.message, errorData.category);
                if (window.FormFeedback?.showStatus) {
                  window.FormFeedback.showStatus(form, errorData.message, errorData.category);
                }
                if (window.FormFeedback?.setMessage) {
                  const btn = window.FormFeedback.getButton?.(form);
                  if (btn) window.FormFeedback.setMessage(btn, errorData.message, errorData.category);
                }
                return { success: false, message: errorData.message, level: errorData.category };
              } catch (error) {
                console.error('Erro ao enviar formul√°rio de entrega', error);
                emitSyncEvent({
                  form,
                  data: { message: error.message, category: 'danger' },
                  response: null,
                  responseOk: false,
                  offlineQueued: false,
                  success: false,
                });
                const fallback = error?.name === 'FetchTimeoutError'
                  ? 'Tempo limite ao enviar a requisi√ß√£o. Tente novamente.'
                  : 'Erro ao processar a√ß√£o';
                showToast(fallback, 'danger');
                const restoreButton = () => {
                  const button = window.FormFeedback?.getButton?.(form)
                    || form.querySelector('button[type="submit"], button:not([type])');
                  if (!button) return;
                  if (window.FormFeedback?.setIdle) {
                    window.FormFeedback.setIdle(button);
                  } else {
                    button.disabled = false;
                  }
                };
                restoreButton();
                try {
                  form.submit();
                } catch (submitError) {
                  console.error('Fallback submit falhou', submitError);
                }
                return { success: false, message: fallback, level: 'danger', keepButton: true };
              }
            };

            if (window.FormFeedback && typeof window.FormFeedback.withSavingState === 'function') {
              await window.FormFeedback.withSavingState(form, handle, { loadingText: form.dataset.loadingText || 'Processando...' });
            } else {
              await handle();
            }
          });
        });
      };

      // Atribuir a fun√ß√£o real √† refer√™ncia usada em applyDeliveryPayload
      attachDeliveryFormListenersRef = attachDeliveryFormListeners;

      attachDeliveryFormListeners();

      document.querySelectorAll('.js-cart-form').forEach(form => {
        if (form.dataset.skipGlobalHandler === 'true') return;
        form.addEventListener('submit', async ev => {
          ev.preventDefault();
          const handle = async () => {
            const { response, queued } = normalizeFetchResult(await fetchOrQueue(form.action, {
              method: form.method,
              body: new FormData(form),
              headers: { 'Accept': 'application/json' }
            }));
            if (queued) {
              const toastEl = document.getElementById('actionToast');
              const { toneCategory } = setToastMessage(toastEl, 'A√ß√£o salva para sincroniza√ß√£o quando estiver online.', 'info');
              applyToastTone(toastEl, toneCategory);
              new bootstrap.Toast(toastEl).show();
              return { success: true, message: 'Aguardando conex√£o para concluir o envio.', level: 'info', successText: 'Sincronizando‚Ä¶', resetDelay: 2500, offlineQueued: true };
            }
            if (response && response.ok) {
              let data;
              try {
                data = await response.json();
              } catch (err) {
                window.location.reload();
                return { success: false, message: 'Erro ao processar resposta', level: 'danger', keepButton: true };
              }
              if (data.redirect) {
                window.location.href = data.redirect;
                return { success: true, keepButton: true };
              }
              const span = form.parentElement.querySelector('span');
              if (span && data.item_quantity !== undefined) {
                span.textContent = data.item_quantity;
              }
              if (data.item_quantity === 0) {
                const li = form.closest('li');
                li?.remove();
              }
              if (data.order_quantity !== undefined) {
                document.querySelectorAll('[data-cart-count]').forEach(el => {
                  el.textContent = data.order_quantity;
                });
              }
              const totalEl = document.getElementById('cartTotal');
              if (totalEl && data.order_total_formatted) {
                totalEl.textContent = 'Total:\u00A0' + data.order_total_formatted;
              }
              const toastEl = document.getElementById('actionToast');
              const { toneCategory } = setToastMessage(toastEl, data.message || '', data.category || 'success');
              applyToastTone(toastEl, toneCategory);
              new bootstrap.Toast(toastEl).show();

              if (typeof window.refreshDeliverySections === 'function') {
                await window.refreshDeliverySections();
              }

              return { success: true, message: data.message, level: data.category };
            }
            const toastEl = document.getElementById('actionToast');
            const { toneCategory } = setToastMessage(toastEl, 'Erro ao processar a√ß√£o', 'danger');
            applyToastTone(toastEl, toneCategory);
            new bootstrap.Toast(toastEl).show();
            return { success: false, message: 'Erro ao processar a√ß√£o', level: 'danger' };
          };

          if (window.FormFeedback && typeof window.FormFeedback.withSavingState === 'function') {
            await window.FormFeedback.withSavingState(form, handle, { loadingText: form.dataset.loadingText || 'Processando...' });
          } else {
            await handle();
          }
        });
      });
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const getCsrfToken = (form) => {
        const formInput = form?.querySelector('input[name="csrf_token"]');
        if (formInput?.value) return formInput.value;
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta?.content) return meta.content;
        return '';
      };

      const statusConfig = {
        pendente: { badgeClass: 'bg-warning text-dark', label: 'Pendente' },
        em_andamento: { badgeClass: 'bg-info text-dark', label: 'Em andamento' },
        concluida: { badgeClass: 'bg-success', label: 'Conclu√≠da' },
        cancelada: { badgeClass: 'bg-danger', label: 'Cancelada' },
      };

      const ensurePlaceholderState = (listEl) => {
        if (!listEl) return;
        const hasItems = listEl.querySelectorAll('li.list-group-item:not(.js-empty-placeholder)').length > 0;
        const placeholder = listEl.querySelector('.js-empty-placeholder');
        if (hasItems) {
          placeholder?.remove();
        } else if (!placeholder) {
          const li = document.createElement('li');
          li.className = 'list-group-item text-muted js-empty-placeholder';
          li.textContent = 'N√£o h√° registros.';
          listEl.appendChild(li);
        }
      };

      const moveDeliveryCard = (li, status) => {
        if (!li || !statusConfig[status]) return;
        const originList = li.closest('ul');
        const targetList = document.querySelector(`ul[data-delivery-list="${status}"]`);
        if (!targetList) return;

        const badge = li.querySelector('.badge');
        if (badge) {
          badge.className = `badge ${statusConfig[status].badgeClass} ms-2`;
          badge.textContent = statusConfig[status].label;
        }

        li.dataset.deliveryStatus = status;
        targetList.prepend(li);

        ensurePlaceholderState(originList);
        ensurePlaceholderState(targetList);
      };

      document.querySelectorAll('.js-admin-delivery-form').forEach(form => {
        form.addEventListener('submit', async ev => {
          ev.preventDefault();
          const li = form.closest('li');
          const handle = async () => {
            const headers = { 'Accept': 'application/json' };
            const csrfToken = getCsrfToken(form);
            if (csrfToken) headers['X-CSRFToken'] = csrfToken;

            const response = await fetch(form.action, {
              method: 'POST',
              headers,
              body: new FormData(form),
              credentials: 'same-origin',
            });

            if (response && response.ok) {
              let data = {};
              try {
                data = await response.json();
              } catch (err) {
                console.warn('N√£o foi poss√≠vel interpretar a resposta como JSON.', err);
              }

              if (data.deleted || data.archived) {
                if (li) {
                  const originList = li.closest('ul');
                  li.remove();
                  ensurePlaceholderState(originList);
                }
              } else if (data.status && li) {
                moveDeliveryCard(li, data.status);
              }

              const toastEl = document.getElementById('actionToast');
              const { toneCategory } = setToastMessage(toastEl, data.message || '', data.category || 'success');
              applyToastTone(toastEl, toneCategory);
              new bootstrap.Toast(toastEl).show();

              if (typeof window.refreshDeliverySections === 'function') {
                await window.refreshDeliverySections();
              }

              return { success: true, message: data.message, level: data.category };
            }

            let data = {};
            try { data = response ? await response.json() : {}; } catch (err) { }
            const toastEl = document.getElementById('actionToast');
            const { toneCategory } = setToastMessage(toastEl, data.message || 'Erro ao processar a√ß√£o', 'danger');
            applyToastTone(toastEl, toneCategory);
            new bootstrap.Toast(toastEl).show();
            return { success: false, message: data.message || 'Erro ao processar a√ß√£o', level: 'danger' };
          };

          if (window.FormFeedback && typeof window.FormFeedback.withSavingState === 'function') {
            await window.FormFeedback.withSavingState(form, handle, { loadingText: form.dataset.loadingText || 'Processando...' });
          } else {
            await handle();
          }
        });
      });
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.js-animal-status').forEach(form => {
        form.addEventListener('submit', async ev => {
          ev.preventDefault();
          const handle = async () => {
            const response = await fetch(form.action, {
              method: 'POST',
              headers: { 'Accept': 'application/json' },
              body: new FormData(form),
              credentials: 'same-origin',
            });

            if (response && response.ok) {
              const data = await response.json();
              if (data.redirect) {
                window.location.href = data.redirect;
                return { success: true, keepButton: true };
              }
              const toastEl = document.getElementById('actionToast');
              const { toneCategory } = setToastMessage(toastEl, data.message || '', data.category || 'success');
              applyToastTone(toastEl, toneCategory);
              new bootstrap.Toast(toastEl).show();
              return { success: true, message: data.message, level: data.category };
            }
            let data = {};
            try { data = response ? await response.json() : {}; } catch (err) { }
            const toastEl = document.getElementById('actionToast');
            const { toneCategory } = setToastMessage(toastEl, data.message || 'Erro ao processar a√ß√£o', 'danger');
            applyToastTone(toastEl, toneCategory);
            new bootstrap.Toast(toastEl).show();
            return { success: false, message: data.message || 'Erro ao processar a√ß√£o', level: 'danger' };
          };

          if (window.FormFeedback && typeof window.FormFeedback.withSavingState === 'function') {
            await window.FormFeedback.withSavingState(form, handle, { loadingText: form.dataset.loadingText || 'Processando...' });
          } else {
            await handle();
          }
        });
      });
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.js-auth-form').forEach(form => {
        form.addEventListener('submit', async ev => {
          ev.preventDefault();
          const handle = async () => {
            form.querySelectorAll('.text-danger').forEach(el => el.remove());
            try {
              // Requisi√ß√µes de autentica√ß√£o usam fetch direto (n√£o offline queue)
              // pois dependem de CSRF tokens que expiram
              const response = await fetch(form.action, {
                method: form.method || 'POST',
                body: new FormData(form),
                headers: { 'Accept': 'application/json' }
              });

              if (response && response.ok) {
                const data = await response.json().catch(() => null);
                if (data && data.redirect) {
                  // Redireciona para a p√°gina indicada ap√≥s login/registro bem-sucedido
                  window.location.href = data.redirect;
                  return { success: true, keepButton: true };
                }
                // Se n√£o houver redirecionamento expl√≠cito, recarrega a p√°gina
                window.location.reload();
                return { success: true, keepButton: true };
              }

              // Tenta parsear JSON de erro
              let errorData = null;
              if (response) {
                try {
                  errorData = await response.json();
                } catch (jsonError) {
                  console.error('Erro ao parsear JSON:', jsonError);
                }
              }

              console.log('Form error data:', errorData);

              if (errorData && errorData.errors) {
                for (const [field, messages] of Object.entries(errorData.errors)) {
                  const input = form.querySelector(`[name="${field}"]`);
                  if (input) {
                    const div = document.createElement('div');
                    div.className = 'text-danger';
                    div.textContent = Array.isArray(messages) ? messages.join(', ') : messages;
                    input.insertAdjacentElement('afterend', div);
                  }
                }
              }

              const message = (errorData && (errorData.message || errorData.error)) || 'N√£o foi poss√≠vel concluir o acesso.';
              return { success: false, message, level: 'danger' };
            } catch (error) {
              console.error('Form submission error:', error);
              return { success: false, message: 'Erro de conex√£o. Verifique sua internet e tente novamente.', level: 'danger' };
            }
          };

          if (window.FormFeedback && typeof window.FormFeedback.withSavingState === 'function') {
            await window.FormFeedback.withSavingState(form, handle, { loadingText: form.dataset.loadingText || 'Enviando...', errorMessage: 'N√£o foi poss√≠vel concluir o acesso.' });
          } else {
            await handle();
          }
        });
      });
    });
  </script>
  <script>
    const escapeHtml = (str) => {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    };

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.js-msg-form').forEach(form => {
        form.addEventListener('submit', async ev => {
          ev.preventDefault();
          const textarea = form.querySelector('textarea');
          const rawContent = textarea ? textarea.value : '';
          const content = rawContent.trim();
          if (!content) {
            return;
          }

          const api = form.dataset.api || form.action;
          const formData = new FormData(form);
          if (textarea && textarea.name) {
            formData.set(textarea.name, content);
          }

          let placeholder = null;
          const container = document.getElementById('mensagens-container');
          if (container) {
            placeholder = document.createElement('div');
            placeholder.className = 'mb-2 text-end js-msg-placeholder';
            placeholder.innerHTML = `
              <div class="p-2 rounded bg-info-subtle position-relative">
                <small>Voc√™:</small><br>
                ${escapeHtml(content).replace(/\n/g, '<br>')}
                <div class="text-muted small js-status">Enviando...</div>
              </div>`;
            container.insertAdjacentElement('beforeend', placeholder);
            container.scrollTop = container.scrollHeight;
          }

          if (textarea) {
            textarea.value = '';
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            textarea.focus();
          }

          const handle = async () => {
            let response;
            let queued = false;
            const timeoutAttr = form.dataset.requestTimeout || form.dataset.fetchTimeout || form.dataset.syncTimeout;
            const timeout = Number.isFinite(Number(timeoutAttr)) ? Number(timeoutAttr) : undefined;

            try {
              ({ response, queued } = normalizeFetchResult(await fetchOrQueue(api, {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'text/html' },
                timeout
              })));
            } catch (err) {
              console.error('Erro ao enviar mensagem:', err);
              if (placeholder) {
                const status = placeholder.querySelector('.js-status');
                if (status) {
                  status.textContent = 'Falha ao enviar. Tente novamente.';
                }
                placeholder.dataset.status = 'error';
              }
              return { success: false, message: 'Falha ao enviar a mensagem.', level: 'danger' };
            }

            const isSuccessful = response && (response.ok || (response.status >= 300 && response.status < 400));

            if (isSuccessful) {
              const html = await response.text();
              if (placeholder) {
                placeholder.insertAdjacentHTML('afterend', html);
                placeholder.remove();
              } else if (container) {
                container.insertAdjacentHTML('beforeend', html);
                container.scrollTop = container.scrollHeight;
              }
              return { success: true, message: 'Mensagem enviada com sucesso.', level: 'success', successText: 'Enviado!', resetDelay: 1800 };
            }

            if (queued) {
              if (placeholder) {
                const status = placeholder.querySelector('.js-status');
                if (status) {
                  status.textContent = 'Mensagem aguardando conex√£o...';
                }
                placeholder.dataset.status = 'queued';
              }
              return {
                success: true,
                message: 'Mensagem ser√° enviada assim que a conex√£o voltar.',
                level: 'info',
                successText: 'Sincronizando‚Ä¶',
                resetDelay: 2500,
                offlineQueued: true,
              };
            }

            if (placeholder) {
              const status = placeholder.querySelector('.js-status');
              if (status) {
                status.textContent = 'Falha ao enviar. Tente novamente.';
              }
              placeholder.dataset.status = 'error';
            }
            return { success: false, message: 'Falha ao enviar a mensagem.', level: 'danger' };
          };

          if (window.FormFeedback && typeof window.FormFeedback.withSavingState === 'function') {
            await window.FormFeedback.withSavingState(form, handle, { loadingText: form.dataset.loadingText || 'Enviando...' });
          } else {
            await handle();
          }
        });
      });
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.js-staff-form').forEach(form => {
        form.addEventListener('submit', async ev => {
          ev.preventDefault();
          const handle = async () => {
            const { response, queued } = normalizeFetchResult(await fetchOrQueue(form.action, {
              method: 'POST',
              headers: { 'Accept': 'application/json' },
              body: new FormData(form)
            }));

            if (queued) {
              if (window.FormFeedback?.setQueued) {
                const btn = window.FormFeedback.getButton?.(form);
                if (btn) {
                  window.FormFeedback.setQueued(btn);
                }
              }
              return { success: true, keepButton: true, offlineQueued: true };
            }

            if (response && response.ok) {
              const data = await response.json();
              if (data.redirect) {
                window.location.href = data.redirect;
                return { success: true, keepButton: true, offlineQueued: queued };
              }
              if (data.html) {
                const target = form.dataset.target;
                if (target) {
                  const el = document.querySelector(target);
                  if (el) {
                    el.innerHTML = data.html;
                  }
                }
              }
              if (data.message) {
                const toastEl = document.getElementById('actionToast');
                const { toneCategory } = setToastMessage(toastEl, data.message, data.category || 'success');
                applyToastTone(toastEl, toneCategory);
                new bootstrap.Toast(toastEl).show();
              }
              return { success: true, message: data.message, level: data.category };
            }

            let data = {};
            try { data = response ? await response.json() : {}; } catch (e) { }
            const toastEl = document.getElementById('actionToast');
            const { toneCategory } = setToastMessage(toastEl, data.message || 'Erro ao processar a√ß√£o', 'danger');
            applyToastTone(toastEl, toneCategory);
            new bootstrap.Toast(toastEl).show();
            return { success: false, message: data.message || 'Erro ao processar a√ß√£o', level: 'danger' };
          };

          if (window.FormFeedback && typeof window.FormFeedback.withSavingState === 'function') {
            await window.FormFeedback.withSavingState(form, handle, { loadingText: form.dataset.loadingText || 'Processando...' });
          } else {
            await handle();
          }
        });
      });
    });
  </script>
  <script>
    (() => {
      const originalAlert = window.alert?.bind(window);
      const suppressedPatterns = [
        /a√ß√£o\s+salva\s+offline/i,
        /salva\s+offline.*sincronizada/i,
        /sincronizada\s+quando\s+poss√≠vel/i,
      ];

      window.alert = message => {
        const text = typeof message === 'string' ? message : String(message);
        const shouldSuppress = suppressedPatterns.some(pattern => pattern.test(text));

        if (shouldSuppress) {
          const toastEl = document.getElementById('actionToast');
          if (toastEl) {
            const { toneCategory } = setToastMessage(toastEl, text || 'A√ß√£o salva para sincroniza√ß√£o quando estiver online.', 'info');
            applyToastTone(toastEl, toneCategory);
            bootstrap.Toast.getOrCreateInstance(toastEl).show();
          } else {
            console.info('Alerta suprimido:', text);
          }
          return;
        }

        if (originalAlert) {
          return originalAlert(text);
        }
      };
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.8/dist/inputmask.min.js"></script>
  <script src="{{ url_for('static', filename='masks.js') }}"></script>
  <script src="{{ url_for('static', filename='avatar_helper.js') }}"></script>
  <script src="{{ url_for('static', filename='js/mobile.js') }}"></script>
  <script src="{{ url_for('static', filename='js/search_filters.js') }}"></script>
  <script src="{{ url_for('static', filename='js/navbar-dropdown.js') }}"></script>
  <!-- Page specific scripts -->
  {% block scripts %}{% endblock %}
</body>

</html>
