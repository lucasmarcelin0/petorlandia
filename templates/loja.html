{% extends "layout.html" %}
{% block main %}

<!-- Cabeçalho -->
<section class="pb-2 pb-lg-4">
  <div class="text-center">
    <h1 class="fw-bold mb-2 text-primary">
      <i class="fa-solid fa-shop me-2"></i> Loja PetOrlândia
    </h1>
    <p class="text-muted mx-auto" style="max-width: 780px;">
      Os melhores produtos para o seu pet com entrega rápida e atendimento especializado!
    </p>

    <!-- Ações principais -->
    <div class="d-flex flex-wrap justify-content-center gap-2 gap-md-3 mt-3">
      {% if has_orders %}
      <a href="{{ url_for('minhas_compras') }}"
         class="btn btn-outline-primary btn-lg d-flex align-items-center">
        <i class="fa-solid fa-box-open me-2"></i> Minhas Compras
      </a>
      {% endif %}

      <a href="{{ url_for('ver_carrinho') }}"
         class="btn btn-success btn-lg d-flex align-items-center position-relative">
        <i class="fa-solid fa-cart-shopping me-2"></i> Ver Carrinho
        {% if cart_count and cart_count > 0 %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger shadow">
          {{ cart_count }}
        </span>
        {% endif %}
      </a>
    </div>
  </div>
</section>

<!-- Categorias -->
{% set cat_list = categories if categories is defined else
  (products | map(attribute='category') | select | unique | list) %}
{% if cat_list and cat_list|length > 0 %}
<section class="mb-3">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="h5 m-0 text-secondary">
      <i class="fa-solid fa-filter me-2"></i> Categorias
    </h2>
    <button class="btn btn-sm btn-outline-secondary d-none d-md-inline-flex js-clear-category">
      Limpar
    </button>
  </div>

  <div class="chips-scroll py-1" id="chipsScroll">
    {% set current_cat = request.args.get('category') %}
    {% for cat in cat_list %}
      {% if cat %}
      <button class="chip {% if current_cat == cat %}chip-active{% endif %}"
              data-category="{{ cat|e }}">
        <i class="fa-solid fa-tag me-1"></i>{{ cat }}
      </button>
      {% endif %}
    {% endfor %}
  </div>

  <button class="btn btn-sm btn-outline-secondary w-100 mt-2 d-md-none js-clear-category">
    Limpar categoria
  </button>
</section>
{% endif %}

<!-- Busca + Filtros -->
<form method="get" id="search-form" class="row g-2 align-items-stretch mb-3">
  {% if request.args.get('category') %}
  <input type="hidden" name="category" value="{{ request.args.get('category') }}">
  {% endif %}

  <div class="col-12 col-lg-7">
    <div class="input-group input-elevated">
      <span class="input-group-text">
        <i class="fa-solid fa-magnifying-glass"></i>
      </span>
      <input type="text" name="q" value="{{ search_term }}"
             class="form-control" placeholder="Buscar produtos...">
      <button class="btn btn-primary" type="submit">Buscar</button>
    </div>
  </div>

  <div class="col-12 col-sm-6 col-lg-3">
    <select class="form-select" name="filter" onchange="this.form.submit()">
      <option value="all"       {% if selected_filter=='all' %}selected{% endif %}>Todos os produtos</option>
      <option value="new"       {% if selected_filter=='new' %}selected{% endif %}>Novos produtos</option>
      <option value="priceLow"  {% if selected_filter=='priceLow' %}selected{% endif %}>Preço: menor → maior</option>
      <option value="priceHigh" {% if selected_filter=='priceHigh' %}selected{% endif %}>Preço: maior → menor</option>
    </select>
  </div>

  <div class="col-12 col-sm-6 col-lg-2">
    <a href="{{ url_for('loja') }}" class="btn btn-outline-secondary w-100">
      <i class="fa-solid fa-rotate me-1"></i> Limpar
    </a>
  </div>
</form>

<!-- Grid de Produtos -->
<div id="products-container">
  {% include 'partials/_product_grid.html' %}
</div>

<!-- Carrinho flutuante (mobile) -->
<div class="d-lg-none fixed-bottom p-3">
  <a href="{{ url_for('ver_carrinho') }}"
     class="btn btn-success btn-lg w-100 btn-cart-floating position-relative">
    <i class="fa-solid fa-cart-shopping me-2"></i> Ver Carrinho
    {% if cart_count and cart_count > 0 %}
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger shadow">
      {{ cart_count }}
    </span>
    {% endif %}
  </a>
</div>

<!-- Styles -->
<style>
  :root {
    --primary-color: #4e73df;
    --primary-dark: #3d5bd6;
  }

  /* Chips */
  .chips-scroll { display:flex; gap:.5rem; overflow-x:auto; }
  .chip { border:1px solid rgba(0,0,0,.1); background:#fff; border-radius:999px;
          padding:.45rem .9rem; font-weight:600; font-size:.9rem; color:#5a5c69; }
  .chip-active { color:#fff; background: linear-gradient(90deg, var(--primary-color), var(--primary-dark)); }

  /* Busca */
  .input-elevated { box-shadow:0 4px 14px rgba(0,0,0,.06); border-radius:10px; overflow:hidden; }

  /* Card */
  .product-card { border:none; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.06); background:#fff; }
  .product-card:hover { transform:translateY(-4px); box-shadow:0 10px 22px rgba(0,0,0,.12); }
  .product-image { width:100%; height:100%; object-fit:cover; }

  /* Quantidade */
  .quantity-selector { display:flex; align-items:center; border:1px solid rgba(0,0,0,.15);
                       border-radius:6px; background:#fff; }
  .quantity-btn { width:32px; height:40px; background:#f3f5f9; border:0; font-weight:700;
                  color:var(--primary-color); cursor:pointer; }
  .quantity-input { width:48px; height:40px; text-align:center; border:0; font-weight:600; }

  /* Botão adicionar */
  .add-to-cart-btn { flex:1 1 auto; border:none; border-radius:6px; padding:.65rem 1rem;
                     font-weight:600; font-size:.95rem; color:#fff;
                     background:linear-gradient(90deg,var(--primary-color),var(--primary-dark)); }
  .add-to-cart-btn:hover { filter:brightness(1.05); transform:translateY(-2px); }

  /* Carrinho mobile */
  .btn-cart-floating { border-radius:20px; box-shadow:0 12px 26px rgba(0,0,0,.22); }
</style>

<!-- Script para quantidade -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".quantity-selector").forEach(selector => {
    const minusBtn = selector.querySelector(".minus");
    const plusBtn = selector.querySelector(".plus");
    const input = selector.querySelector("input");

    minusBtn.addEventListener("click", () => {
      let val = parseInt(input.value) || 1;
      if (val > 1) input.value = val - 1;
    });

    plusBtn.addEventListener("click", () => {
      let val = parseInt(input.value) || 1;
      input.value = val + 1;
    });
  });
});
</script>

{% endblock %}
