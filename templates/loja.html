{% extends "layout.html" %}
{% block main %}
<div class="container py-4 py-lg-5">
  <!-- Header Section -->
  <div class="text-center mb-4 mb-lg-5">
    <h1 class="display-5 fw-bold mb-3 text-primary">
      <i class="bi bi-shop-window me-2"></i>Loja PetOrlândia
    </h1>
    <p class="lead text-muted max-w-800 mx-auto">
      Os melhores produtos para o seu pet com entrega rápida e atendimento especializado!
    </p>
    
    <div class="d-flex flex-row flex-wrap justify-content-center gap-3 mt-4">
      {% if has_orders %}
      <a href="{{ url_for('minhas_compras') }}"
         class="btn btn-outline-primary btn-lg d-flex align-items-center flex-fill flex-sm-grow-0">
        <i class="bi bi-box-seam me-2"></i> Minhas Compras
      </a>
      {% endif %}

      <a href="{{ url_for('ver_carrinho') }}"
         class="btn btn-success btn-lg d-flex align-items-center position-relative flex-fill flex-sm-grow-0">
        <i class="bi bi-cart3 me-2"></i> Ver Carrinho
        {% if cart_count and cart_count > 0 %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
          {{ cart_count }}
        </span>
        {% endif %}
      </a>
    </div>
  </div>

  <!-- Search & Filter Section (Nova adição) -->
  <form method="get" class="row mb-4 mb-lg-5 align-items-stretch g-2">
    <div class="col-12 col-md-6 d-flex">
      <div class="input-group flex-grow-1">
        <input type="text" name="q" value="{{ search_term }}" class="form-control js-search-input" placeholder="Buscar produtos..." aria-label="Buscar produtos">
        <button class="btn btn-primary btn-sm" type="submit" aria-label="Pesquisar">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>
    <div class="col-12 col-md-6 d-flex">
      <div class="dropdown w-100 d-md-none">
        <button class="btn btn-outline-secondary w-100 dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          Filtrar
        </button>
        <ul class="dropdown-menu w-100" aria-labelledby="filterDropdown">
          <li><button class="dropdown-item" type="submit" name="filter" value="all">Todos os produtos</button></li>
          <li><button class="dropdown-item" type="submit" name="filter" value="lowStock">Estoque baixo</button></li>
          <li><button class="dropdown-item" type="submit" name="filter" value="new">Novos produtos</button></li>
          <li><button class="dropdown-item" type="submit" name="filter" value="priceLow">Preço: menor para maior</button></li>
          <li><button class="dropdown-item" type="submit" name="filter" value="priceHigh">Preço: maior para menor</button></li>
        </ul>
      </div>
      <select class="form-select d-none d-md-block" name="filter" aria-label="Filtrar produtos" onchange="this.form.submit()">
        <option value="all" {% if selected_filter=='all' %}selected{% endif %}>Todos os produtos</option>
        <option value="lowStock" {% if selected_filter=='lowStock' %}selected{% endif %}>Estoque baixo</option>
        <option value="new" {% if selected_filter=='new' %}selected{% endif %}>Novos produtos</option>
        <option value="priceLow" {% if selected_filter=='priceLow' %}selected{% endif %}>Preço: menor para maior</option>
        <option value="priceHigh" {% if selected_filter=='priceHigh' %}selected{% endif %}>Preço: maior para menor</option>
      </select>
    </div>
  </form>

  <!-- Products Grid -->
  {% if products %}
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4 js-products-container">
    {% for product in products %}
    <div class="col">
      <div class="card h-100 border-0 product-card d-flex flex-column">
        <!-- Product Image -->
        <a href="{{ url_for('produto_detail', product_id=product.id) }}" class="position-relative overflow-hidden d-block product-image-link">
          {% if product.image_url %}
            {% if 'http' in product.image_url %}
              <img src="{{ product.image_url }}"
                   class="img-fluid w-100 h-100 object-fit-cover"
                   alt="{{ product.name }}"
                   loading="lazy">
            {% else %}
              <img src="{{ url_for('static', filename=product.image_url) }}"
                   class="img-fluid w-100 h-100 object-fit-cover"
                   alt="{{ product.name }}"
                   loading="lazy">
            {% endif %}
          {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center w-100 h-100">
              <i class="bi bi-image text-muted fs-1"></i>
            </div>
          {% endif %}
          {% if product.stock is not none and product.stock < 5 %}
          <div class="product-badge position-absolute top-0 end-0 bg-warning text-dark p-2 small">
            <i class="bi bi-exclamation-triangle"></i> Estoque baixo
          </div>
          {% else %}
          <div class="product-badge position-absolute top-0 end-0 bg-danger text-white p-2 small">
            <i class="bi bi-tag"></i> Novo
          </div>
          {% endif %}
        </a>
        
        <!-- Product Info -->
        <div class="card-body d-flex flex-column pb-0">
          <h3 class="h5 card-title fw-bold mb-2 product-name" title="{{ product.name }}">{{ product.name }}</h3>
          <p class="card-text text-muted small flex-grow-1 product-description">
            {{ product.description|truncate(100) }}
          </p>

          <div class="mt-auto">
            <span class="h5 text-success fw-bold mb-3 d-block product-price">
              R$ {{ '%.2f'|format(product.price)|replace('.', ',') }}
            </span>

            <form action="{{ url_for('adicionar_carrinho', product_id=product.id) }}"
                  method="post" class="js-cart-form">
              {{ form.hidden_tag() }}
              <div class="d-flex align-items-center">
                <div class="quantity-selector me-2">
                  <button type="button" class="quantity-btn minus">-</button>
{{ form.quantity(class="form-control quantity-input", min="1", value="1", **{'aria-label': 'Quantidade'}) }}                  <button type="button" class="quantity-btn plus">+</button>
                </div>
                <button type="submit" class="btn add-to-cart-btn d-flex align-items-center gap-2 shadow-sm flex-grow-1 js-add-to-cart">
                  <i class="bi bi-cart-plus fs-5"></i>
                  <span class="fw-semibold">Adicionar +</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Pagination (Nova adição) -->
  <nav aria-label="Navegação de página" class="mt-5">
    <ul class="pagination justify-content-center">
      <li class="page-item disabled">
        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Anterior</a>
      </li>
      <li class="page-item active" aria-current="page">
        <a class="page-link" href="#">1</a>
      </li>
      <li class="page-item"><a class="page-link" href="#">2</a></li>
      <li class="page-item"><a class="page-link" href="#">3</a></li>
      <li class="page-item">
        <a class="page-link" href="#">Próximo</a>
      </li>
    </ul>
  </nav>
  
  {% else %}
  <!-- Empty State -->
  <div class="text-center py-5 my-5">
    <div class="mb-4">
      <i class="bi bi-emoji-frown display-1 text-muted"></i>
    </div>
    <h2 class="h4 text-muted">Nenhum produto disponível</h2>
    <p class="text-muted">Volte em breve para novas ofertas!</p>
  </div>
  {% endif %}

  <!-- Floating Cart Button (Mobile Only) -->
  <div class="d-lg-none fixed-bottom p-3">
    <a href="{{ url_for('ver_carrinho') }}"
       class="btn btn-success btn-lg w-100 shadow-lg d-flex justify-content-center align-items-center position-relative">
      <i class="bi bi-cart3 me-2"></i> Ver Carrinho
      {% if cart_count and cart_count > 0 %}
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
        {{ cart_count }}
      </span>
      {% endif %}
    </a>
  </div>
</div>

<script src="{{ url_for('static', filename='loja_search.js') }}"></script>
<style>
  /* Custom Styles */
  :root {
    --primary: #4e54c8;
    --primary-dark: #3f43b5;
    --success: #28a745;
  }
  
  .max-w-800 { max-width: 800px; }
  .object-fit-cover { object-fit: cover; }
  
  .product-card {
    transition: all 0.3s ease;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.12);
  }

  .product-price {
    white-space: nowrap;
    flex-shrink: 0;
  }

  .product-badge {
    border-bottom-left-radius: 8px;
  }
  
  .quantity-selector {
    display: flex;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    height: 38px;
  }
  
  .quantity-btn {
    width: 32px;
    background: #f8f9fa;
    border: none;
    font-size: 1rem;
    color: var(--primary);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .quantity-btn:hover {
    background: #e9ecef;
  }
  
  .quantity-input {
    width: 40px;
    text-align: center;
    border: none;
    font-weight: 600;
    padding: 0;
    background: white;
  }
  
  .quantity-input:focus {
    outline: 2px solid var(--primary);
    box-shadow: none;
  }
  
  .add-to-cart-btn {
    background: linear-gradient(90deg, var(--primary), var(--primary-dark));
    border: none;
    border-radius: 8px;
    height: 38px;
    padding: 0 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: .5rem;
    color: #fff;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 3px 8px rgba(78, 84, 200, 0.3);
  }

  .add-to-cart-btn:focus {
    outline: 2px solid var(--primary-dark);
    outline-offset: 2px;
  }
  
  .add-to-cart-btn:hover {
    filter: brightness(1.05);
    transform: scale(1.05);
  }
  
  .add-to-cart-btn:active {
    transform: scale(0.95);
  }
  
  /* Novos estilos para melhorias de UX/UI */
  .product-image-link {
    height: 220px;
  }
  
  .product-description {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product-name {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Melhorias para telas menores */
  @media (max-width: 768px) {
    .fixed-bottom {
      z-index: 1020;
      padding-bottom: 70px !important;
    }
    
    .quantity-selector {
      height: 42px;
    }
    
    .quantity-btn {
      width: 36px;
    }
    
    .add-to-cart-btn {
      height: 42px;
      padding: 0 1.25rem;
    }
    
    .product-image-link {
      height: 180px;
    }
    
    .display-5 {
      font-size: 2rem;
    }
  }
  
  /* Melhorias para telas maiores */
  @media (min-width: 1400px) {
    .container {
      max-width: 1320px;
    }
    
    .product-image-link {
      height: 250px;
    }
  }
  
  /* Animações para feedback visual */
  @keyframes addedToCart {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }
  
  .added-to-cart {
    animation: addedToCart 0.5s ease;
  }
  
  /* Estilos para busca e filtro */
  .input-group-text {
    transition: all 0.3s ease;
  }
  
  .input-group:focus-within .input-group-text {
    color: var(--primary);
    border-color: var(--primary);
  }
</style>

<script>
  // Quantity selector functionality
  document.querySelectorAll('.quantity-btn').forEach(button => {
    button.addEventListener('click', function() {
      const input = this.parentElement.querySelector('.quantity-input');
      let value = parseInt(input.value) || 1;
      
      if (this.classList.contains('minus') && value > 1) {
        input.value = value - 1;
      } else if (this.classList.contains('plus')) {
        input.value = value + 1;
      }
    });
  });
  
  // Add to cart animation
  document.querySelectorAll('.js-add-to-cart').forEach(button => {
    button.addEventListener('click', function(e) {
      // Prevenir comportamento padrão para demonstrar a funcionalidade
      e.preventDefault();
      
      // Animation effect
      this.classList.add('added-to-cart');
      setTimeout(() => {
        this.classList.remove('added-to-cart');
      }, 500);
      
      // Save original HTML
      const originalHTML = this.innerHTML;
      
      // Show feedback
      this.innerHTML = '<i class="bi bi-check"></i> Adicionado!';
      this.classList.add('btn-success');
      this.classList.remove('btn-primary');
      
      // Restore after 1.5 seconds
      setTimeout(() => {
        this.innerHTML = originalHTML;
        this.classList.remove('btn-success');
        this.classList.add('btn-primary');
      }, 1500);
      
      // Aqui você enviaria o formulário em uma implementação real
      // this.closest('form').submit();
    });
  });

</script>
{% endblock %}
