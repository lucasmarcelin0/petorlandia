{% extends "layout.html" %}
{% block main %}

<!-- Header -->
<section class="pb-2 pb-lg-4">
  <div class="text-center">
    <h1 class="fw-bold mb-2 text-primary">
      <i class="fa-solid fa-shop me-2"></i> Loja PetOrlândia
    </h1>
    <p class="text-muted mx-auto" style="max-width: 780px;">
      Os melhores produtos para o seu pet com entrega rápida e atendimento especializado!
    </p>

    <div class="d-flex flex-wrap justify-content-center gap-2 gap-md-3 mt-3">
      {% if has_orders %}
      <a href="{{ url_for('minhas_compras') }}"
         class="btn btn-outline-primary btn-lg d-flex align-items-center">
        <i class="fa-solid fa-box-open me-2"></i> Minhas Compras
      </a>
      {% endif %}
      <a href="{{ url_for('ver_carrinho') }}"
         class="btn btn-success btn-lg d-flex align-items-center position-relative">
        <i class="fa-solid fa-cart-shopping me-2"></i> Ver Carrinho
        {% if cart_count and cart_count > 0 %}
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger shadow">
            {{ cart_count }}
          </span>
        {% endif %}
      </a>
    </div>
  </div>
</section>

<!-- Categorias (chips) - opcional -->
{% set cat_list = categories if categories is defined else
  (products | map(attribute='category') | select | unique | list) %}
{% if cat_list and cat_list|length > 0 %}
<section class="mb-3">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="h5 m-0 text-secondary"><i class="fa-solid fa-filter me-2"></i>Categorias</h2>
    <button class="btn btn-sm btn-outline-secondary d-none d-md-inline-flex js-clear-category">
      Limpar
    </button>
  </div>
  <div class="chips-scroll py-1" id="chipsScroll" role="tablist" aria-label="Categorias">
    {% set current_cat = request.args.get('category') %}
    {% for cat in cat_list %}
      {% if cat %}
      <button
        class="chip {% if current_cat == cat %}chip-active{% endif %}"
        data-category="{{ cat|e }}" type="button" role="tab"
        aria-selected="{{ 'true' if current_cat == cat else 'false' }}"
        title="{{ cat }}">
        <i class="fa-solid fa-tag me-1"></i>{{ cat }}
      </button>
      {% endif %}
    {% endfor %}
  </div>
  <button class="btn btn-sm btn-outline-secondary w-100 mt-2 d-md-none js-clear-category">
    Limpar categoria
  </button>
</section>
{% endif %}

<!-- Busca + Filtros -->
<form method="get" class="row g-2 align-items-stretch mb-3">
  <!-- preserva categoria ao buscar -->
  {% if request.args.get('category') %}
    <input type="hidden" name="category" value="{{ request.args.get('category') }}">
  {% endif %}

  <div class="col-12 col-lg-7">
    <div class="input-group input-elevated">
      <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
      <input
        type="text"
        name="q"
        value="{{ search_term }}"
        class="form-control"
        placeholder="Buscar produtos..."
        aria-label="Buscar produtos">
      <button class="btn btn-primary" type="submit">Buscar</button>
    </div>
  </div>

  <div class="col-12 col-sm-6 col-lg-3">
    <select class="form-select" name="filter" aria-label="Filtrar produtos" onchange="this.form.submit()">
      <option value="all"       {% if selected_filter=='all' %}selected{% endif %}>Todos os produtos</option>
      <option value="new"       {% if selected_filter=='new' %}selected{% endif %}>Novos produtos</option>
      <option value="priceLow"  {% if selected_filter=='priceLow' %}selected{% endif %}>Preço: menor → maior</option>
      <option value="priceHigh" {% if selected_filter=='priceHigh' %}selected{% endif %}>Preço: maior → menor</option>
    </select>
  </div>

  <div class="col-12 col-sm-6 col-lg-2">
    <a href="{{ url_for('loja') }}" class="btn btn-outline-secondary w-100">
      <i class="fa-solid fa-rotate me-1"></i> Limpar
    </a>
  </div>
</form>

<!-- Grid de Produtos -->
{% if products %}
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 g-md-4">
  {% for product in products %}
  <div class="col">
    <article class="card product-card h-100 d-flex flex-column overflow-hidden">
      <!-- Imagem -->
      <a href="{{ url_for('produto_detail', product_id=product.id) }}"
         class="ratio ratio-4x3 product-image-wrap d-block position-relative" aria-label="Abrir {{ product.name }}">
        {% if product.image_url %}
          {% if 'http' in product.image_url %}
            <img src="{{ product.image_url }}" class="product-image" alt="{{ product.name }}" loading="lazy">
          {% else %}
            <img src="{{ url_for('static', filename=product.image_url) }}" class="product-image" alt="{{ product.name }}" loading="lazy">
          {% endif %}
        {% else %}
          <div class="product-image-placeholder">
            <i class="fa-regular fa-image"></i>
          </div>
        {% endif %}
      </a>

      <!-- Info -->
      <div class="card-body d-flex flex-column">
        <h3 class="h6 fw-semibold product-name mb-1" title="{{ product.name }}">{{ product.name }}</h3>
        {% if product.description %}
          <p class="text-muted small product-description mb-2" data-bs-toggle="tooltip"
             data-bs-placement="top" title="{{ product.description }}">
            {{ product.description|truncate(110) }}
          </p>
        {% endif %}

        <div class="mt-auto">
          <div class="d-flex align-items-center justify-content-between mb-1">
            <span class="h5 m-0 text-success fw-bold">R$ {{ '%.2f'|format(product.price)|replace('.', ',') }}</span>
          </div>
          <div class="text-muted small mb-2">
            <i class="fa-solid fa-truck-fast ms-1 me-1"></i>entrega rápida
          </div>

          <form action="{{ url_for('adicionar_carrinho', product_id=product.id) }}"
                method="post" class="js-cart-form">
            {{ form.hidden_tag() }}
            <div class="d-flex align-items-stretch gap-2">
              <!-- Seletor de quantidade -->
              <div class="quantity-selector" aria-label="Selecionar quantidade">
                <button type="button" class="quantity-btn minus" aria-label="Diminuir">–</button>
                {{ form.quantity(class="form-control quantity-input", min="1", value="1", **{'aria-label': 'Quantidade'}) }}
                <button type="button" class="quantity-btn plus" aria-label="Aumentar">+</button>
              </div>

              <!-- Botão adicionar -->
              <button type="submit" class="btn btn-primary add-to-cart-btn flex-grow-1 js-add-to-cart"
                      aria-label="Adicionar {{ product.name }} ao carrinho">
                <i class="fa-solid fa-cart-plus me-2"></i>
                Adicionar ao carrinho
              </button>
            </div>
          </form>
        </div>
      </div>
    </article>
  </div>
  {% endfor %}
</div>

<!-- Paginação (exemplo estático; troque pela sua paginação real) -->
{% if pagination is defined %}
<nav aria-label="Paginação" class="mt-4">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if not pagination.prev %}disabled{% endif %}">
      <a class="page-link" href="{{ pagination.prev or '#' }}">Anterior</a>
    </li>
    {% for p in pagination.pages %}
      <li class="page-item {% if p.active %}active{% endif %}">
        <a class="page-link" href="{{ p.url }}">{{ p.number }}</a>
      </li>
    {% endfor %}
    <li class="page-item {% if not pagination.next %}disabled{% endif %}">
      <a class="page-link" href="{{ pagination.next or '#' }}">Próximo</a>
    </li>
  </ul>
</nav>
{% endif %}

{% else %}
<!-- Empty state -->
<section class="text-center py-5 my-5">
  <div class="mb-3"><i class="fa-regular fa-face-frown-open display-4 text-muted"></i></div>
  <h2 class="h5 text-muted">Nenhum produto disponível</h2>
  <p class="text-muted">Volte em breve para novas ofertas!</p>
</section>
{% endif %}

<!-- Floating Cart (mobile) -->
<div class="d-lg-none fixed-bottom p-3">
  <a href="{{ url_for('ver_carrinho') }}"
     class="btn btn-success btn-lg w-100 btn-cart-floating position-relative">
    <i class="fa-solid fa-cart-shopping me-2"></i> Ver Carrinho
    {% if cart_count and cart_count > 0 %}
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger shadow">
      {{ cart_count }}
    </span>
    {% endif %}
  </a>
</div>

<!-- Styles específicos da loja -->
<style>
  :root{
    --primary-color: #4e73df; /* herdado do layout */
    --primary-dark: #3d5bd6;
    --success-color: #1cc88a;
  }

  /* Chips de categoria */
  .chips-scroll{
    display:flex; gap:.5rem; overflow-x:auto; padding:.25rem .25rem;
    -webkit-overflow-scrolling: touch;
  }
  .chips-scroll::-webkit-scrollbar{ height:8px; }
  .chips-scroll::-webkit-scrollbar-thumb{ background:rgba(0,0,0,.15); border-radius:8px; }

  .chip{
    border:1px solid rgba(0,0,0,.1);
    background:#fff;
    border-radius:999px;
    padding:.45rem .9rem;
    font-weight:600;
    font-size:.9rem;
    color:#5a5c69;
    box-shadow:0 1px 3px rgba(0,0,0,.06);
    transition:all .2s ease;
    white-space:nowrap;
  }
  .chip:hover{ transform:translateY(-1px); box-shadow:0 3px 10px rgba(0,0,0,.08); }
  .chip-active{
    color:#fff; background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
    border-color:transparent;
  }

  /* Busca elevada */
  .input-elevated .input-group-text{ background:#fff; border-right:0; }
  .input-elevated .form-control{ border-left:0; }
  .input-elevated .form-control,
  .input-elevated .input-group-text,
  .input-elevated .btn{
    height:46px;
  }
  .input-elevated{
    box-shadow:0 4px 14px rgba(0,0,0,.06);
    border-radius:10px; overflow:hidden;
  }

  /* Card do produto */
  .product-card{
    border:none; border-radius:14px;
    box-shadow:0 2px 10px rgba(0,0,0,.06);
    transition:transform .25s ease, box-shadow .25s ease;
    background:#fff;
  }
  .product-card:hover{
    transform:translateY(-4px);
    box-shadow:0 10px 22px rgba(0,0,0,.12);
  }

  .product-image-wrap{ background:#f8f9fb; }
  .product-image{ width:100%; height:100%; object-fit:cover; transition:transform .4s ease; }
  .product-card:hover .product-image{ transform:scale(1.04); }

  .product-image-placeholder{
    width:100%; height:100%; display:flex; align-items:center; justify-content:center;
    color:#c8cbd3; font-size:2rem;
  }

  .product-badge{
    position:absolute; top:.6rem; right:.6rem;
    font-size:.75rem; font-weight:700;
    border-radius:10px;
    padding:.35rem .6rem;
    box-shadow:0 2px 8px rgba(0,0,0,.12);
  }
  .badge-lowstock{ background:#ffe08a; color:#6b4e00; }
  .badge-new{ background:#c7f9cc; color:#116530; }

  .product-name{
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }
  .product-description{
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }

  /* Quantidade + botão */
  .quantity-selector{
    display:flex; border:1px solid rgba(0,0,0,.1); border-radius:10px; overflow:hidden; background:#fff;
  }
  .quantity-btn{
    width:40px; border:0; background:#f3f5f9; font-weight:700; font-size:1.1rem; color:var(--primary-color);
  }
  .quantity-btn:active{ transform:scale(.98); }
  .quantity-input{
    width:52px; text-align:center; border:0; font-weight:700; padding:0 .25rem;
  }
  .quantity-input:focus{ outline:2px solid var(--primary-color); }

  .add-to-cart-btn{
    border:none; border-radius:10px;
    box-shadow:0 4px 12px rgba(78,115,223,.25);
    background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
  }
  .add-to-cart-btn:hover{ filter:brightness(1.04); transform:translateY(-1px); }

  /* Botão flutuante do carrinho (mobile) */
  .btn-cart-floating{
    border-radius:20px;
    box-shadow:0 12px 26px rgba(0,0,0,.22);
  }

  @media (max-width: 768px){
    .add-to-cart-btn, .quantity-btn{ height:46px; }
    .quantity-input{ height:46px; }
  }
</style>

<!-- JS específico da loja -->
<script>
  // Chips de categoria -> aplicam/limpam query param
  (function(){
    const setParam = (key,val)=>{
      const url = new URL(window.location.href);
      if (val) url.searchParams.set(key,val); else url.searchParams.delete(key);
      url.searchParams.delete('page'); // reset de paginação ao filtrar
      window.location.href = url.toString();
    };

    document.querySelectorAll('.chip[data-category]').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        setParam('category', chip.dataset.category);
      });
    });

    document.querySelectorAll('.js-clear-category').forEach(btn=>{
      btn.addEventListener('click', ()=> setParam('category',''));
    });
  })();

  // Seletor de quantidade
  (function(){
    document.querySelectorAll('.quantity-selector').forEach(box=>{
      const input = box.querySelector('.quantity-input');
      box.querySelector('.minus')?.addEventListener('click', ()=>{
        const v = parseInt(input.value||'1',10);
        input.value = Math.max(1, v-1);
      });
      box.querySelector('.plus')?.addEventListener('click', ()=>{
        const v = parseInt(input.value||'1',10);
        input.value = v+1;
      });
    });
  })();

  // Feedback visual no botão "Adicionar"
  (function(){
    document.querySelectorAll('.js-add-to-cart').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const original = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adicionando...';
        // A submissão real é tratada pelo listener global .js-cart-form do layout via fetch/AJAX.
        // Após um breve tempo, voltamos o estado (o toast global confirmará).
        setTimeout(()=>{
          btn.disabled = false;
          btn.innerHTML = '<i class="fa-solid fa-cart-plus me-2"></i>Adicionar ao carrinho';
        }, 1200);
      }, { once:false });
    });
  })();

  // Scroll suave horizontal (mouse wheel) nas chips
  (function(){
    const sc = document.getElementById('chipsScroll');
    if (!sc) return;
    sc.addEventListener('wheel', (e)=>{
      if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
        sc.scrollLeft += e.deltaY;
        e.preventDefault();
      }
    }, { passive:false });
  })();
</script>

{% endblock %}
