{% extends "layout.html" %}
{% block main %}
<div class="container py-4">
  <h2 class="text-center mb-4">Confirmar Compra</h2>
  <ul class="list-group mb-3">
    {% for item in order.items %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span>{{ item.item_name }}</span>
      <span>{{ item.quantity }} x R$ {{ '%.2f'|format(item.product.price or 0) }}</span>
    </li>
    {% endfor %}
  </ul>
  <div class="d-flex justify-content-end mb-3">
    <strong>Total:&nbsp;R$ {{ '%.2f'|format(order.total_value()) }}</strong>
  </div>

  <div class="mb-4">
    <h5 class="fw-bold">Endereço de Entrega</h5>
    {% if selected_address %}
      <p class="mb-1">{{ selected_address }}</p>
    {% elif current_user.endereco and current_user.endereco.full %}
      <p class="mb-1">{{ current_user.endereco.full }}</p>
    {% else %}
      <p class="text-danger mb-1">Nenhum endereço cadastrado.</p>
      <a href="{{ url_for('profile') }}" class="btn btn-outline-primary btn-sm">Atualizar Endereço</a>
    {% endif %}

    <div id="alt-address" class="mt-3 d-none">
      {{ form.shipping_address(class="form-control", rows="3", placeholder="Digite o endereço completo") }}
      <div class="invalid-feedback d-none" data-field-error="shipping_address"></div>
    </div>
  </div>
  <div id="checkoutErrors" class="alert alert-danger d-none" role="alert"></div>
  <form id="checkoutConfirmForm" action="{{ url_for('checkout') }}" method="post" class="text-end">
    {{ form.csrf_token }}
    <input type="hidden" name="address_id" value="{{ '' if form.address_id.data is none else form.address_id.data }}">
    <button type="submit" class="btn btn-success">
      Continuar para Pagamento
    </button>
  </form>
  <div class="mt-3 text-start">
    <a href="{{ url_for('ver_carrinho') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left-circle"></i> Voltar ao carrinho
    </a>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('checkoutConfirmForm');
      const errorBox = document.getElementById('checkoutErrors');
      const altAddress = document.getElementById('alt-address');

      const clearErrors = () => {
        errorBox?.classList.add('d-none');
        if (errorBox) {
          errorBox.textContent = '';
        }
        form?.querySelectorAll('[data-field-error]').forEach(el => {
          el.textContent = '';
          el.classList.add('d-none');
        });
        form?.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
      };

      const showFieldError = (field, message) => {
        const target = form?.querySelector(`[data-field-error="${field}"]`);
        const input = form?.querySelector(`[name="${field}"]`);
        if (target) {
          target.textContent = message;
          target.classList.remove('d-none');
        }
        if (input) {
          input.classList.add('is-invalid');
        }
        if (field === 'shipping_address' && altAddress?.classList.contains('d-none')) {
          altAddress.classList.remove('d-none');
        }
      };

      const showAlertError = (message) => {
        if (!errorBox) return;
        errorBox.textContent = message || 'Não foi possível concluir o envio.';
        errorBox.classList.remove('d-none');
      };

      form?.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const submitBtn = form.querySelector('button[type="submit"]');

        const handle = async () => {
          clearErrors();
          let response;
          try {
            response = await fetch(form.action, {
              method: 'POST',
              body: new FormData(form),
              headers: {'Accept': 'application/json'}
            });
          } catch (err) {
            showAlertError('Não foi possível enviar os dados. Verifique sua conexão.');
            return { success: false, message: 'Falha de rede' };
          }

          let data = {};
          try { data = await response.json(); } catch (err) {}

          if (response.ok && data.redirect) {
            window.location.href = data.redirect;
            return { success: true, keepButton: true };
          }

          if (data.errors) {
            Object.entries(data.errors).forEach(([field, messages]) => {
              const msg = Array.isArray(messages) ? messages[0] : messages;
              showFieldError(field, msg);
            });
          }

          if (data.message) {
            showAlertError(data.message);
          } else {
            showAlertError('Não foi possível concluir o envio.');
          }

          return { success: false, message: data.message, level: 'danger' };
        };

        if (window.FormFeedback && typeof window.FormFeedback.withSavingState === 'function') {
          await window.FormFeedback.withSavingState(submitBtn || form, handle, { loadingText: 'Enviando...' });
        } else {
          await handle();
        }
      });
    });
  </script>
</div>
{% endblock %}
