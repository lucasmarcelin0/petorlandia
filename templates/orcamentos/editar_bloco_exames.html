{% extends 'base.html' %}
{% import 'macros/ui.html' as ui %}

{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='consulta_layout.css') }}">
{% endblock %}

{% block body_classes %}consulta-layout{% endblock %}

{% block page_toolbar %}
  <a href="{{ url_for('index') }}" class="btn-back">
    <i class="fas fa-arrow-left"></i>
    In√≠cio
  </a>
{% endblock %}

{% block main_container_classes %}container mt-4{% endblock %}

{% block main %}
<div class="container py-4">
  <h2 class="mb-4">üß™ Editar Bloco de Exames</h2>

  <div id="exames-container">
    {% for exame in bloco.exames %}
    {% call ui.ui_card(extra_classes='mb-3 exame-card', body_classes='d-grid gap-2') %}
      <div class="ui-field position-relative">
        <label class="ui-label">Nome do Exame</label>
        <input type="text" class="ui-input exame-nome" value="{{ exame.nome or '' }}" oninput="sugerirExames(this)">
        <ul class="autocomplete-sugestoes list-group position-absolute w-100 ui-overlay"></ul>
      </div>
      <div class="ui-field">
        <label class="ui-label">Justificativa</label>
        <textarea class="ui-input exame-justificativa" rows="2">{{ exame.justificativa or '' }}</textarea>
      </div>
      <div class="ui-field">
        <label class="ui-label">Status</label>
        <select class="ui-input exame-status">
          <option value="pendente" {% if exame.status == 'pendente' %}selected{% endif %}>Pendente</option>
          <option value="concluido" {% if exame.status == 'concluido' %}selected{% endif %}>Conclu√≠do</option>
          <option value="cancelado" {% if exame.status == 'cancelado' %}selected{% endif %}>Cancelado</option>
        </select>
      </div>
      <div class="ui-field">
        <label class="ui-label">Resultado</label>
        <textarea class="ui-input exame-resultado" rows="2">{{ exame.resultado or '' }}</textarea>
      </div>
      <div class="ui-field">
        <label class="ui-label">Data de Realiza√ß√£o</label>
        <input type="date" class="ui-input exame-performed_at" value="{{ exame.performed_at.date() if exame.performed_at else '' }}">
      </div>
      {{ ui.ui_button('üóëÔ∏è Remover', variant='danger', size='sm', type='button', extra_classes='btn-remover align-self-start') }}
    {% endcall %}
    {% endfor %}
  </div>

  {{ ui.ui_button('‚ûï Adicionar Exame', variant='primary', type='button', extra_classes='mb-3', attributes={'id': 'btn-adicionar'}) }}

  <div class="ui-field">
    <label class="ui-label">Observa√ß√µes Gerais</label>
    <textarea id="observacoes_gerais" class="ui-input" rows="3">{{ bloco.observacoes_gerais or '' }}</textarea>
  </div>

  {{ ui.ui_button('üíæ Salvar altera√ß√µes', variant='secondary', attributes={'id': 'btn-salvar', 'data-bloco-id': bloco.id, 'data-consulta-id': bloco.consulta_id}) }}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log("üß™ P√°gina de edi√ß√£o carregada.");

  // Bot√£o Adicionar
  document.getElementById('btn-adicionar')?.addEventListener('click', adicionarExame);

  // Delega√ß√£o para remover (funciona para elementos futuros tamb√©m)
  document.getElementById('exames-container')?.addEventListener('click', (e) => {
    if (e.target && e.target.classList.contains('btn-remover')) {
      if (confirm("Tem certeza que deseja remover este exame?")) {
        console.log("üî¥ Removendo exame...");
        e.target.closest('.exame-card')?.remove();
      }
    }
  });

  // Bot√£o Salvar
  document.getElementById('btn-salvar')?.addEventListener('click', () => {
    const blocoId = document.getElementById('btn-salvar').dataset.blocoId;
    const consultaId = document.getElementById('btn-salvar').dataset.consultaId;
    salvarBlocoExames(blocoId, consultaId);
  });
});

function adicionarExame() {
  console.log("‚ûï Adicionando novo exame...");
  const container = document.getElementById('exames-container');
  const novo = document.createElement('div');
  novo.classList.add('ui-card', 'ui-card--surface', 'mb-3', 'exame-card');
  novo.innerHTML = `
    <div class="d-grid gap-2">
      <div class="ui-field position-relative">
        <label class="ui-label">Nome do Exame</label>
        <input type="text" class="ui-input exame-nome" oninput="sugerirExames(this)">
        <ul class="autocomplete-sugestoes list-group position-absolute w-100 ui-overlay"></ul>
      </div>
      <div class="ui-field">
        <label class="ui-label">Justificativa</label>
        <textarea class="ui-input exame-justificativa" rows="2"></textarea>
      </div>
      <div class="ui-field">
        <label class="ui-label">Status</label>
        <select class="ui-input exame-status">
          <option value="pendente" selected>Pendente</option>
          <option value="concluido">Conclu√≠do</option>
          <option value="cancelado">Cancelado</option>
        </select>
      </div>
      <div class="ui-field">
        <label class="ui-label">Resultado</label>
        <textarea class="ui-input exame-resultado" rows="2"></textarea>
      </div>
      <div class="ui-field">
        <label class="ui-label">Data de Realiza√ß√£o</label>
        <input type="date" class="ui-input exame-performed_at">
      </div>
      <button type="button" class="ui-button ui-button--danger ui-button--sm btn-remover align-self-start">üóëÔ∏è Remover</button>
    </div>
  `;
  container.appendChild(novo);
}

function sugerirExames(input) {
  const lista = input.nextElementSibling;
  const q = input.value.trim();
  if (q.length < 2) {
    lista.innerHTML = '';
    return;
  }

  console.log("üîé Sugerindo exames para:", q);
  fetch(`/buscar_exames?q=${encodeURIComponent(q)}`)
    .then(r => r.json())
    .then(data => {
      lista.innerHTML = '';
      data.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.textContent = item.nome;
        li.onclick = () => {
          input.value = item.nome;
          const card = input.closest('.exame-card');
          card.querySelector('.exame-justificativa').value = item.justificativa || '';
          lista.innerHTML = '';
        };
        lista.appendChild(li);
      });
    });
}

function salvarBlocoExames(blocoId, consultaId) {
  console.log("üíæ Salvando bloco:", blocoId);
  const exames = [];
  document.querySelectorAll('.exame-card').forEach(card => {
    const nome = card.querySelector('.exame-nome')?.value.trim();
    const justificativa = card.querySelector('.exame-justificativa')?.value.trim();
    const status = card.querySelector('.exame-status')?.value || 'pendente';
    const resultado = card.querySelector('.exame-resultado')?.value.trim();
    const performed_at = card.querySelector('.exame-performed_at')?.value;
    if (nome && justificativa) {
      exames.push({ nome, justificativa, status, resultado, performed_at });
    }
  });

  const observacoes_gerais = document.getElementById('observacoes_gerais').value;

  if (exames.length === 0) {
    alert('Adicione ao menos um exame.');
    console.warn("‚ö†Ô∏è Nenhum exame v√°lido para salvar.");
    return;
  }

  fetch(`/bloco_exames/${blocoId}/atualizar`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ exames, observacoes_gerais })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      console.log("‚úÖ Bloco de exames salvo.");
      alert('Bloco de exames salvo com sucesso!');
      fetch(`/consulta/${consultaId}/historico_exames`)
        .then(r => r.text())
        .then(html => {
          const historico = document.getElementById('historico-exames');
          if (historico) {
            historico.innerHTML = html;
            const modal = bootstrap.Modal.getInstance(document.getElementById('modal-editar'));
            if (modal) modal.hide();
          } else {
            location.reload();
          }
        });
    } else {
      console.error("‚ùå Erro ao salvar:", data);
      alert('Erro ao salvar.');
    }
  })
  .catch(err => {
    console.error("üö® Erro na requisi√ß√£o:", err);
    alert('Erro na requisi√ß√£o.');
  });
}
</script>
{% endblock %}
