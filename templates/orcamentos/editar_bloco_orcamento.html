{% extends 'layout.html' %}
{% block main %}
<div class="container py-4">
  <h2 class="mb-4">âœï¸ Editar OrÃ§amento</h2>
  <div id="itens-container">
    {% for item in bloco.itens %}
    <div class="row g-2 mb-2 item-row">
      <div class="col-md-8">
        <input type="text" class="form-control descricao" value="{{ item.descricao }}">
      </div>
      <div class="col-md-3">
        <input type="number" step="0.01" class="form-control valor" value="{{ '%.2f'|format(item.valor) }}">
      </div>
      <div class="col-md-1">
        <button type="button" class="btn btn-danger w-100 remover-item">ğŸ—‘ï¸</button>
      </div>
    </div>
    {% endfor %}
  </div>
  <button type="button" class="btn btn-outline-primary mb-3" onclick="adicionarItem()">â• Adicionar item</button>
  <div class="d-flex gap-2">
    <button class="btn btn-success" onclick="salvar({{ bloco.id }}, {{ bloco.animal_id }})">ğŸ’¾ Salvar alteraÃ§Ãµes</button>
    <a class="btn btn-secondary" href="javascript:history.back()">â†©ï¸ Cancelar</a>
  </div>
</div>

<script>
function adicionarItem() {
  const container = document.getElementById('itens-container');
  const row = document.createElement('div');
  row.className = 'row g-2 mb-2 item-row';
  row.innerHTML = `
    <div class="col-md-8">
      <input type="text" class="form-control descricao" placeholder="DescriÃ§Ã£o">
    </div>
    <div class="col-md-3">
      <input type="number" step="0.01" class="form-control valor" placeholder="0.00">
    </div>
    <div class="col-md-1">
      <button type="button" class="btn btn-danger w-100 remover-item">ğŸ—‘ï¸</button>
    </div>`;
  container.appendChild(row);
}

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('remover-item')) {
    e.target.closest('.item-row').remove();
  }
});

function salvar(blocoId, animalId) {
  const itens = [];
  document.querySelectorAll('#itens-container .item-row').forEach(row => {
    const descricao = row.querySelector('.descricao').value.trim();
    const valor = parseFloat(row.querySelector('.valor').value);
    if (descricao && !isNaN(valor)) {
      itens.push({descricao, valor});
    }
  });
  fetch(`/bloco_orcamento/${blocoId}/atualizar`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
    body: JSON.stringify({ itens })
  }).then(r => r.json()).then(data => {
    if (data.success) {
      window.location.href = `/consulta/${animalId}`;
    } else {
      alert(data.message || 'Erro ao salvar.');
    }
  });
}
</script>
{% endblock %}
