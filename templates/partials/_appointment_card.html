{% set day_key = appt.scheduled_at|format_datetime_brazil('%Y-%m-%d') %}
{% set scheduled_key = appt.scheduled_at|format_datetime_brazil('%Y-%m-%dT%H:%M') %}
{% set day_label = appt.scheduled_at|format_datetime_brazil('%A, %d/%m/%Y') %}
{% set tutor_name = appt.tutor.name if appt.tutor else (appt.animal.owner.name if appt.animal and appt.animal.owner else 'Tutor não informado') %}
{% set vet_name = appt.veterinario.user.name if appt.veterinario and appt.veterinario.user else 'Profissional não definido' %}
{% set status_labels = {'scheduled': 'A fazer', 'completed': 'Realizada', 'canceled': 'Cancelada', 'accepted': 'Aceita'} %}
{% set status_label = status_labels.get(appt.status, 'Atualizado') %}
{% set card_classes = 'appointment-card appointment-row ' + (appt.status or '') %}
{% set can_start_consulta = current_user.worker in ['veterinario', 'colaborador'] %}
{% set nfse_doc = nfse_documents_by_appointment.get(appt.id) if nfse_documents_by_appointment is defined else None %}
{% set nfse_status = nfse_doc.status.value if nfse_doc and nfse_doc.status else (nfse_doc.status if nfse_doc else None) %}
{% set can_emit_nfse = current_user.worker in ['veterinario', 'colaborador'] or (current_user.role or '') == 'admin' %}
<div
  class="{{ card_classes.strip() }}"
  data-appointment-id="{{ appt.id }}"
  data-href="{{ url_for('edit_appointment', appointment_id=appt.id) }}"
  data-day="{{ day_key }}"
  data-day-label="{{ day_label }}"
  data-scheduled="{{ scheduled_key }}"
>
  <div class="appointment-card__body">
    <div class="appointment-card__top">
      <div class="appointment-card__main-info">
        <div class="appointment-card__time" aria-label="Horário do agendamento">
          <span class="appointment-card__icon is-time"><i class="fa-regular fa-clock"></i></span>
          <div class="appointment-card__time-text">
            <span class="appointment-card__time-label">Horário</span>
            <span class="appointment-card__time-value">{{ appt.scheduled_at|format_datetime_brazil('%H:%M') }}</span>
          </div>
        </div>
        <div class="appointment-card__patient" aria-label="Paciente">
          <span class="appointment-card__icon is-pet"><i class="fa-solid fa-paw"></i></span>
          <div class="appointment-card__patient-text">
            <span class="appointment-card__patient-label">Paciente</span>
            <span class="appointment-card__patient-name">{{ appt.animal.name }}</span>
            <span class="appointment-card__tutor">Tutor: {{ tutor_name }}</span>
          </div>
        </div>
      </div>
      <div class="appointment-card__status-actions">
        <span class="status-badge status-{{ appt.status }}">{{ status_label }}</span>
        <div class="appointment-card__primary-actions" aria-label="Ações principais">
          <a
            href="{{ url_for('ficha_animal', animal_id=appt.animal_id) }}"
            class="btn btn-sm btn-primary"
            title="Ficha do Animal"
          >
            <i class="fa-solid fa-file-medical me-1"></i>
            Ficha do Animal
          </a>
          {% if can_start_consulta %}
            <a
              href="{{ url_for('consulta_direct', animal_id=appt.animal_id, appointment_id=appt.id) }}"
              class="btn btn-sm btn-outline-success"
              title="Iniciar Consulta"
            >
              <i class="fa-solid fa-stethoscope me-1"></i>
              Iniciar Consulta
            </a>
          {% else %}
            <a
              href="{{ url_for('edit_appointment', appointment_id=appt.id) }}"
              class="btn btn-sm btn-outline-info"
              title="Propor novo horário"
            >
              <i class="fa-solid fa-arrows-rotate me-1"></i>
              Propor novo horário
            </a>
          {% endif %}
          <div class="dropdown appointment-card__more-actions">
            <button
              class="btn btn-sm btn-light appointment-card__more-btn"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
              aria-label="Mais ações"
            >
              <i class="fa-solid fa-ellipsis"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              {% if can_emit_nfse %}
              <li>
                <form method="POST" action="{{ url_for('appointment_emit_nfse', appointment_id=appt.id) }}">
                  {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
                  <button class="dropdown-item d-flex align-items-center gap-2" title="Emitir NFS-e">
                    <i class="fa-solid fa-file-invoice"></i>
                    Emitir NFS-e
                  </button>
                </form>
              </li>
              <li><hr class="dropdown-divider"></li>
              {% endif %}
              <li>
                <a class="dropdown-item d-flex align-items-center gap-2" href="{{ url_for('ficha_tutor', tutor_id=appt.tutor_id) }}">
                  <i class="fa-solid fa-user"></i>
                  Ficha do Tutor
                </a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center gap-2" href="{{ url_for('appointment_close', appointment_id=appt.id) }}">
                  <i class="fa-solid fa-file-invoice"></i>
                  Fechar atendimento
                </a>
              </li>
              {% if can_start_consulta %}
                <li>
                  <a class="dropdown-item d-flex align-items-center gap-2" href="{{ url_for('edit_appointment', appointment_id=appt.id) }}">
                    <i class="fa-solid fa-arrows-rotate"></i>
                    Propor novo horário
                  </a>
                </li>
              {% endif %}
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-header text-uppercase small text-muted">Atualizar status</li>
              <li>
                <form method="POST" action="{{ url_for('update_appointment_status', appointment_id=appt.id) }}" class="form-confirm">
                  {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
                  <input type="hidden" name="status" value="completed">
                  <button class="dropdown-item d-flex align-items-center gap-2" title="Marcar como realizada">
                    <i class="fa-solid fa-check text-success"></i>
                    Realizada
                  </button>
                </form>
              </li>
              <li>
                <form method="POST" action="{{ url_for('update_appointment_status', appointment_id=appt.id) }}" class="form-confirm">
                  {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
                  <input type="hidden" name="status" value="canceled">
                  <button class="dropdown-item d-flex align-items-center gap-2" title="Cancelar">
                    <i class="fa-solid fa-xmark text-warning"></i>
                    Cancelar
                  </button>
                </form>
              </li>
              <li>
                <form method="POST" action="{{ url_for('update_appointment_status', appointment_id=appt.id) }}" class="form-confirm">
                  {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
                  <input type="hidden" name="status" value="scheduled">
                  <button class="dropdown-item d-flex align-items-center gap-2" title="Marcar como a fazer">
                    <i class="fa-regular fa-clock text-info"></i>
                    A fazer
                  </button>
                </form>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <form
                  method="POST"
                  action="{{ url_for('delete_appointment', appointment_id=appt.id) }}"
                  class="form-confirm"
                  data-confirm="Excluir este agendamento?"
                >
                  {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
                  <button class="dropdown-item d-flex align-items-center gap-2 text-danger" title="Excluir">
                    <i class="fa-solid fa-trash"></i>
                    Excluir agendamento
                  </button>
                </form>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="appointment-card__meta">
      <div class="appointment-card__meta-item">
        <span class="appointment-card__icon is-vet"><i class="fa-solid fa-user-doctor"></i></span>
        <div>
          <span class="appointment-card__meta-label">Profissional</span>
          <span class="appointment-card__meta-value">{{ vet_name }}</span>
        </div>
      </div>
      <div class="appointment-card__meta-item">
        <span class="appointment-card__icon is-kind"><i class="fa-solid fa-notes-medical"></i></span>
        <div>
          <span class="appointment-card__meta-label">Tipo</span>
          <span class="appointment-card__meta-value">{{ appt.kind_display or appt.kind|capitalize }}</span>
        </div>
      </div>
      {% if nfse_doc %}
      <div class="appointment-card__meta-item">
        <span class="appointment-card__icon is-kind"><i class="fa-solid fa-file-invoice"></i></span>
        <div>
          <span class="appointment-card__meta-label">NFS-e</span>
          <span class="appointment-card__meta-value">
            <a
              href="{{ url_for('fiscal_document_detail', document_id=nfse_doc.id) }}"
              data-nfse-status
              data-document-id="{{ nfse_doc.id }}"
              data-status="{{ nfse_status }}"
            >
              {{ nfse_status or '—' }}
            </a>
          </span>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
