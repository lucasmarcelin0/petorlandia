{% set day_key = appt.scheduled_at|format_datetime_brazil('%Y-%m-%d') %}
{% set scheduled_key = appt.scheduled_at|format_datetime_brazil('%Y-%m-%dT%H:%M') %}
{% set day_label = appt.scheduled_at|format_datetime_brazil('%A, %d/%m/%Y') %}
{% set status_labels = {
  'scheduled': 'A fazer',
  'completed': 'Realizada',
  'canceled': 'Cancelada',
  'accepted': 'Aceita'
} %}
{% set status_label = status_labels.get(appt.status, 'Sem status') %}
{% set card_classes = 'appointment-card appointment-row ' + (appt.status or '') %}
{% set is_staff = current_user.worker in ['veterinario', 'colaborador'] %}
<div
  class="{{ card_classes.strip() }}"
  data-appointment-id="{{ appt.id }}"
  data-href="{{ url_for('edit_appointment', appointment_id=appt.id) }}"
  data-day="{{ day_key }}"
  data-day-label="{{ day_label }}"
  data-scheduled="{{ scheduled_key }}"
>
  <div class="card-body">
    <div class="appointment-card-top">
      <div class="appointment-card-main">
        <div class="appointment-time-block">
          <span class="appointment-icon"><i class="fa-regular fa-clock"></i></span>
          <div class="appointment-time-text">
            <span class="appointment-time-label">Horário</span>
            <span class="appointment-time-value">{{ appt.scheduled_at|format_datetime_brazil('%H:%M') }}</span>
          </div>
        </div>
        <div class="appointment-patient-block">
          <span class="appointment-icon is-patient"><i class="fa-solid fa-paw"></i></span>
          <div class="appointment-patient-text">
            <span class="appointment-patient-label">Paciente</span>
            <span class="appointment-patient-name">{{ appt.animal.name }}</span>
            <span class="appointment-patient-vet">com {{ appt.veterinario.user.name }}</span>
          </div>
        </div>
      </div>
      <div class="appointment-status">
        <span class="status-badge status-{{ appt.status }}">{{ status_label }}</span>
      </div>
    </div>
    <div class="appointment-card-bottom">
      <div class="appointment-primary-actions">
        <a
          href="{{ url_for('ficha_animal', animal_id=appt.animal_id) }}"
          class="btn btn-sm btn-primary"
          title="Ficha do Animal"
        >
          <i class="fa-solid fa-file-medical me-1"></i>Ficha do Animal
        </a>
        {% if is_staff %}
        <a
          href="{{ url_for('consulta_direct', animal_id=appt.animal_id, appointment_id=appt.id) }}"
          class="btn btn-sm btn-outline-primary appointment-primary-alt"
          title="Iniciar Consulta"
        >
          <i class="fa-solid fa-stethoscope me-1"></i>Iniciar Consulta
        </a>
        {% else %}
        <a
          href="{{ url_for('ficha_tutor', tutor_id=appt.tutor_id) }}"
          class="btn btn-sm btn-outline-primary appointment-primary-alt"
          title="Ficha do Tutor"
        >
          <i class="fa-solid fa-user me-1"></i>Ficha do Tutor
        </a>
        {% endif %}
      </div>
      <div class="dropdown appointment-actions-menu">
        <button
          class="btn btn-sm btn-outline-secondary dropdown-toggle"
          type="button"
          id="appointment-actions-{{ appt.id }}"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          ⋯
        </button>
        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="appointment-actions-{{ appt.id }}">
          {% if is_staff == False %}
          <a href="{{ url_for('consulta_direct', animal_id=appt.animal_id, appointment_id=appt.id) }}" class="dropdown-item">
            <i class="fa-solid fa-stethoscope me-2"></i>Iniciar Consulta
          </a>
          {% endif %}
          <a href="{{ url_for('ficha_tutor', tutor_id=appt.tutor_id) }}" class="dropdown-item">
            <i class="fa-solid fa-user me-2"></i>Ficha do Tutor
          </a>
          <a href="{{ url_for('edit_appointment', appointment_id=appt.id) }}" class="dropdown-item">
            <i class="fa-solid fa-arrows-rotate me-2"></i>Propor novo horário
          </a>
          <div class="dropdown-divider"></div>
          <form method="POST" action="{{ url_for('update_appointment_status', appointment_id=appt.id) }}" class="dropdown-action-form form-confirm">
            {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
            <input type="hidden" name="status" value="completed">
            <button type="submit" class="dropdown-item text-success">
              <i class="fa-solid fa-check me-2"></i>Marcar como realizada
            </button>
          </form>
          <form method="POST" action="{{ url_for('update_appointment_status', appointment_id=appt.id) }}" class="dropdown-action-form form-confirm">
            {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
            <input type="hidden" name="status" value="canceled">
            <button type="submit" class="dropdown-item text-warning">
              <i class="fa-solid fa-xmark me-2"></i>Cancelar
            </button>
          </form>
          <form method="POST" action="{{ url_for('update_appointment_status', appointment_id=appt.id) }}" class="dropdown-action-form form-confirm">
            {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
            <input type="hidden" name="status" value="scheduled">
            <button type="submit" class="dropdown-item text-secondary">
              <i class="fa-solid fa-clock me-2"></i>Marcar como a fazer
            </button>
          </form>
          <div class="dropdown-divider"></div>
          <form
            method="POST"
            action="{{ url_for('delete_appointment', appointment_id=appt.id) }}"
            class="dropdown-action-form form-confirm"
            data-confirm="Excluir este agendamento?"
          >
            {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
            <button type="submit" class="dropdown-item text-danger">
              <i class="fa-solid fa-trash me-2"></i>Excluir
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
