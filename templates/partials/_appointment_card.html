{% from 'macros/ui.html' import ui_button %}
{% set day_key = appt.scheduled_at|format_datetime_brazil('%Y-%m-%d') %}
{% set scheduled_key = appt.scheduled_at|format_datetime_brazil('%Y-%m-%dT%H:%M') %}
{% set day_label = appt.scheduled_at|format_datetime_brazil('%A, %d/%m/%Y') %}
{% set card_classes = 'appointment-card appointment-row ' + (appt.status or '') %}
<div
  class="{{ card_classes.strip() }}"
  data-appointment-id="{{ appt.id }}"
  data-href="{{ url_for('edit_appointment', appointment_id=appt.id) }}"
  data-day="{{ day_key }}"
  data-day-label="{{ day_label }}"
  data-scheduled="{{ scheduled_key }}"
>
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-md-2">
        <div class="time-display d-flex align-items-center gap-1">
          <span class="icon-circle bg-secondary text-white"><i class="fa-regular fa-clock"></i></span>
          {{ appt.scheduled_at|format_datetime_brazil('%H:%M') }}
        </div>
      </div>
      <div class="col-md-3">
        <div class="animal-name d-flex align-items-center gap-2">
          <span class="icon-circle bg-danger text-white"><i class="fa-solid fa-paw"></i></span>{{ appt.animal.name }}
        </div>
      </div>
      <div class="col-md-2">
        <div class="vet-name d-flex align-items-center gap-2">
          <span class="icon-circle bg-info text-white"><i class="fa-solid fa-user-doctor"></i></span>{{ appt.veterinario.user.name }}
        </div>
      </div>
      <div class="col-md-2">
        <span class="status-badge status-{{ appt.status }}">
          {% if appt.status == 'scheduled' %}A fazer{% endif %}
          {% if appt.status == 'completed' %}Realizada{% endif %}
          {% if appt.status == 'canceled' %}Cancelada{% endif %}
          {% if appt.status == 'accepted' %}Aceita{% endif %}
        </span>
      </div>
      <div class="col-md-3">
        <div class="actions-container">
          {{ ui_button('Ficha do Animal', href=url_for('ficha_animal', animal_id=appt.animal_id), variant='primary', outline=True, size='sm', icon='fa-solid fa-file-medical', attrs={'title': 'Ficha do Animal'}) }}
          {{ ui_button('Ficha do Tutor', href=url_for('ficha_tutor', tutor_id=appt.tutor_id), variant='secondary', outline=True, size='sm', icon='fa-solid fa-user', attrs={'title': 'Ficha do Tutor'}) }}
          {% if current_user.worker in ['veterinario', 'colaborador'] %}
          {{ ui_button('Iniciar Consulta', href=url_for('consulta_direct', animal_id=appt.animal_id, appointment_id=appt.id), variant='success', outline=True, size='sm', icon='fa-solid fa-stethoscope', attrs={'title': 'Iniciar Consulta'}) }}
          {% endif %}
          {{ ui_button('Propor novo horário', href=url_for('edit_appointment', appointment_id=appt.id), variant='info', outline=True, size='sm', icon='fa-solid fa-arrows-rotate', attrs={'title': 'Propor novo horário'}) }}
          <form method="POST" action="{{ url_for('update_appointment_status', appointment_id=appt.id) }}" class="form-confirm">
            {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
            <input type="hidden" name="status" value="completed">
            {{ ui_button('Realizada', type='submit', variant='success', outline=True, size='sm', icon='fa-solid fa-check', attrs={'title': 'Marcar como realizada'}) }}
          </form>
          <form method="POST" action="{{ url_for('update_appointment_status', appointment_id=appt.id) }}" class="form-confirm">
            {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
            <input type="hidden" name="status" value="canceled">
            {{ ui_button('Cancelar', type='submit', variant='warning', outline=True, size='sm', icon='fa-solid fa-xmark', attrs={'title': 'Cancelar'}) }}
          </form>
          <form method="POST" action="{{ url_for('update_appointment_status', appointment_id=appt.id) }}" class="form-confirm">
            {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
            <input type="hidden" name="status" value="scheduled">
            {{ ui_button('A fazer', type='submit', variant='secondary', outline=True, size='sm', icon='fa-solid fa-clock', attrs={'title': 'Marcar como a fazer'}) }}
          </form>
          <form method="POST" action="{{ url_for('delete_appointment', appointment_id=appt.id) }}" class="form-confirm" data-confirm="Excluir este agendamento?">
            {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
            {{ ui_button('Excluir', type='submit', variant='danger', outline=True, size='sm', icon='fa-solid fa-trash', attrs={'title': 'Excluir'}) }}
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
