{% set _agenda_veterinarios = agenda_veterinarios|default([]) %}
{% set _agenda_colaboradores = agenda_colaboradores|default([]) %}
{% if current_user.role == 'admin' and (_agenda_veterinarios or _agenda_colaboradores) %}
  {% set _form_classes = switcher_form_classes|default('d-flex align-items-center justify-content-end gap-2 mb-2 flex-wrap') %}
  {% set _select_classes = switcher_select_classes|default('form-select') %}
  {% set _select_style = switcher_select_style|default('') %}
  {% set _label_text = switcher_label_text|default('Pesquisar agenda') %}
  {% set _default_option_label = switcher_default_option_label|default('Minha agenda (admin)') %}
  {% set _select_id = switcher_select_id|default('admin-agenda-picker') %}
  {% set _preserve_params = preserve_params|default([]) %}
  {% set _default_selection_value = admin_default_selection_value|default('') %}
  {% set _current_user_id = current_user.id if current_user.is_authenticated else '' %}
  <form action="{{ url_for('appointments') }}" method="get" class="{{ _form_classes }}" data-admin-agenda-switcher data-admin-user-id="{{ _current_user_id }}"{% if _default_selection_value %} data-admin-default-selection="{{ _default_selection_value }}"{% endif %}>
    {% for param in _preserve_params %}
      {% set value = request.args.get(param) %}
      {% if value %}
      <input type="hidden" name="{{ param }}" value="{{ value }}">
      {% endif %}
    {% endfor %}
    <input type="hidden" name="view_as" value="{{ admin_selected_view if admin_selected_view in ['veterinario', 'colaborador', 'tutor'] else '' }}" data-switcher-view>
    <input type="hidden" name="veterinario_id" value="{{ admin_selected_veterinario_id or '' }}" data-switcher-vet>
    <input type="hidden" name="colaborador_id" value="{{ admin_selected_colaborador_id or '' }}" data-switcher-colab>
    <label for="{{ _select_id }}" class="form-label fw-semibold small mb-0">{{ _label_text }}</label>
    <select id="{{ _select_id }}" class="{{ _select_classes }}" data-switcher-select {% if _select_style %}style="{{ _select_style }}"{% endif %}>
      <option value="">{{ _default_option_label }}</option>
      {% if _agenda_veterinarios %}
      <optgroup label="Veterinários">
        {% for vet in _agenda_veterinarios %}
        {% set option_value = 'veterinario:' ~ vet.id %}
        <option value="{{ option_value }}"{% if admin_selected_view == 'veterinario' and admin_selected_veterinario_id == vet.id %} selected{% endif %}>
          {{ vet.user.name }}{% if vet.user.email %} – {{ vet.user.email }}{% endif %}
        </option>
        {% endfor %}
      </optgroup>
      {% endif %}
      {% if _agenda_colaboradores %}
      <optgroup label="Colaboradores">
        {% for colab in _agenda_colaboradores %}
        {% set option_value = 'colaborador:' ~ colab.id %}
        <option value="{{ option_value }}"{% if admin_selected_view == 'colaborador' and admin_selected_colaborador_id == colab.id %} selected{% endif %}>
          {{ colab.name }}{% if colab.email %} – {{ colab.email }}{% endif %}
        </option>
        {% endfor %}
      </optgroup>
      {% endif %}
    </select>
  </form>
  <script>
    (function() {
      const forms = document.querySelectorAll('[data-admin-agenda-switcher]');
      if (!forms.length) {
        return;
      }
      forms.forEach(function(form) {
        const select = form.querySelector('[data-switcher-select]');
        const viewInput = form.querySelector('[data-switcher-view]');
        const vetInput = form.querySelector('[data-switcher-vet]');
        const colabInput = form.querySelector('[data-switcher-colab]');
        if (!select || !viewInput || !vetInput || !colabInput) {
          return;
        }
        function updateHiddenInputs(rawValue) {
          viewInput.value = '';
          vetInput.value = '';
          colabInput.value = '';
          if (!rawValue) {
            return;
          }
          const parts = String(rawValue).split(':');
          if (parts.length !== 2) {
            return;
          }
          const kind = parts[0];
          const id = parts[1];
          if (kind === 'veterinario') {
            viewInput.value = 'veterinario';
            vetInput.value = id || '';
          } else if (kind === 'colaborador') {
            viewInput.value = 'colaborador';
            colabInput.value = id || '';
          }
        }
        const formDataset = form.dataset || {};
        const storageKey = (function() {
          if (typeof window === 'undefined') {
            return null;
          }
          const rawUserId = formDataset.adminUserId || '';
          if (!rawUserId) {
            return null;
          }
          return 'adminAgendaSelection:' + String(rawUserId);
        })();
        const defaultSelection = formDataset.adminDefaultSelection || '';

        function findOptionByValue(value) {
          if (value === undefined || value === null) {
            return null;
          }
          const stringValue = String(value);
          return Array.from(select.options || []).find(function(option) {
            return option.value === stringValue;
          }) || null;
        }

        function readStoredSelection() {
          if (!storageKey || typeof window === 'undefined' || !window.localStorage) {
            return null;
          }
          try {
            return window.localStorage.getItem(storageKey);
          } catch (error) {
            return null;
          }
        }

        function persistSelection(value) {
          if (!storageKey || typeof window === 'undefined' || !window.localStorage) {
            return;
          }
          try {
            if (value) {
              window.localStorage.setItem(storageKey, value);
            } else {
              window.localStorage.removeItem(storageKey);
            }
          } catch (error) {
            /* Ignore storage errors. */
          }
        }

        function applyInitialSelection() {
          let storedValue = readStoredSelection();
          const hasDefault = !!(defaultSelection && findOptionByValue(defaultSelection));
          if (!storedValue && hasDefault) {
            storedValue = defaultSelection;
          } else if (storedValue && !findOptionByValue(storedValue)) {
            storedValue = hasDefault ? defaultSelection : '';
            persistSelection(storedValue);
          }
          if (storedValue && storedValue !== select.value && findOptionByValue(storedValue)) {
            let hasQuerySelection = false;
            let paramView = '';
            let paramVet = '';
            let paramColab = '';
            if (typeof window !== 'undefined') {
              const params = new URLSearchParams(window.location.search || '');
              paramView = params.get('view_as') || '';
              paramVet = params.get('veterinario_id') || '';
              paramColab = params.get('colaborador_id') || '';
              hasQuerySelection = Boolean(paramView || paramVet || paramColab);
            }
            if (!hasQuerySelection) {
              persistSelection(storedValue);
              return;
            }
            select.value = storedValue;
            updateHiddenInputs(storedValue);
            if (typeof window !== 'undefined') {
              const targetView = viewInput.value || '';
              const targetVet = vetInput.value || '';
              const targetColab = colabInput.value || '';
              if (paramView !== targetView || paramVet !== targetVet || paramColab !== targetColab) {
                persistSelection(storedValue);
                form.submit();
                return;
              }
            }
            persistSelection(storedValue);
          } else if (hasDefault && storedValue !== defaultSelection) {
            persistSelection(defaultSelection);
          }
        }

        updateHiddenInputs(select.value);
        applyInitialSelection();
        select.addEventListener('change', function() {
          updateHiddenInputs(this.value);
          persistSelection(this.value);
          if (window.handleVetChange) {
            window.handleVetChange();
          }
          form.submit();
        });
      });
    })();
  </script>
{% endif %}
