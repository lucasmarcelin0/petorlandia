<!-- partials/animais_adicionados.html -->
{% set compact = compact|default(False) %}
{% set card_block %}
<div class="card shadow-sm border-0 rounded-4 h-100 d-flex flex-column">
  <div class="card-header bg-white border-0 pb-0">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <h4 class="mb-1">üêæ Animais</h4>
        <p class="text-muted small mb-0">Visualize, filtre e organize rapidamente os pets cadastrados.</p>
      </div>
      {% if scope is defined %}
      <div class="btn-group btn-group-sm">
        <a href="{{ url_for('novo_animal', scope='all') }}" class="btn btn-outline-primary {% if scope != 'mine' %}active{% endif %}">Todos</a>
        <a href="{{ url_for('novo_animal', scope='mine') }}" class="btn btn-outline-primary {% if scope == 'mine' %}active{% endif %}">Meus</a>
      </div>
      {% endif %}
    </div>
  </div>
  <div class="card-body p-4 flex-grow-1 d-flex flex-column">
    <div class="row g-3 align-items-end mb-4">
      <div class="col-12 col-lg-7">
        <label for="animal-filter" class="form-label small text-muted mb-1">Buscar</label>
        <input type="text" id="animal-filter" class="form-control" placeholder="Buscar por nome, esp√©cie...">
      </div>
      <div class="col-12 col-lg-5">
        <label for="animal-sort" class="form-label small text-muted mb-1">Ordenar por</label>
        <select id="animal-sort" class="form-select">
          <option value="date_desc">Data (recentes)</option>
          <option value="date_asc">Data (antigos)</option>
          <option value="name_asc">Nome (A-Z)</option>
          <option value="name_desc">Nome (Z-A)</option>
          <option value="age_desc">Idade (maior)</option>
          <option value="age_asc">Idade (menor)</option>
        </select>
      </div>
    </div>

    <div id="animal-cards" class="row g-3 flex-grow-1">
      {% if animais_adicionados %}
        {% for animal in animais_adicionados %}
        <div class="col-md-6 d-flex" data-name="{{ animal.name|lower }}" data-date="{{ animal.date_added.isoformat() if animal.date_added else '' }}" data-age="{{ animal.age_years or 0 }}">
          <div class="card shadow-sm rounded-4 h-100 flex-fill border-0">
            {% if animal.image %}
            <img src="{{ animal.image }}" class="card-img card-img-top rounded-top-4" height="180" loading="lazy" alt="Foto de {{ animal.name }}">
            {% else %}
            <div class="d-flex align-items-center justify-content-center bg-light rounded-top-4" style="height: 180px;">
              <span class="text-muted" style="font-size: 2rem;">üêæ</span>
            </div>
            {% endif %}
            <div class="card-body d-flex flex-column justify-content-between">
              <div class="mb-3">
                <h5 class="card-title mb-1">{{ animal.name }}</h5>
                <p class="mb-1"><strong>Esp√©cie:</strong> {{ animal.species }}</p>
                <p class="mb-0"><strong>Adicionado em:</strong> {{ animal.date_added|format_datetime_brazil('%d/%m/%Y') }}</p>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <a href="{{ url_for('consulta_direct', animal_id=animal.id) }}" class="btn btn-sm btn-outline-primary flex-fill">ü©∫ Consulta</a>
                <a href="{{ url_for('ficha_animal', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark flex-fill">üìã Ficha</a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
      <div class="col-12">
        <div class="text-center text-muted py-5 border rounded-4" style="border-style: dashed;">
          Nenhum animal cadastrado para esta cl√≠nica ainda.
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% if pagination and pagination.pages > 1 %}
  <div class="card-footer bg-white border-0 pt-0">
    <div class="d-flex justify-content-center">
      <nav aria-label="Navega√ß√£o de p√°ginas">
        <ul class="pagination mb-0">
          {% if pagination.has_prev %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('novo_animal', page=pagination.prev_num, scope=scope) }}">Anterior</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Anterior</span>
            </li>
          {% endif %}

          {% for p in range(1, pagination.pages + 1) %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('novo_animal', page=p, scope=scope) }}">{{ p }}</a>
            </li>
          {% endfor %}

          {% if pagination.has_next %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('novo_animal', page=pagination.next_num, scope=scope) }}">Pr√≥xima</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Pr√≥xima</span>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
  {% endif %}
</div>
{% endset %}

{% if compact %}
  {{ card_block }}
{% else %}
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
      {{ card_block }}
    </div>
  </div>
</div>
{% endif %}

<script>
(function() {
  const filterInput = document.getElementById('animal-filter');
  const sortSelect = document.getElementById('animal-sort');
  const container = document.getElementById('animal-cards');

  if (!filterInput || !sortSelect || !container) {
    return;
  }

  const cards = Array.from(container.querySelectorAll('[data-name]'));
  const sortStorageKey = 'animalSortPreference';
  const filterStorageKey = 'animalFilterPreference';

  const savedFilter = localStorage.getItem(filterStorageKey);
  if (savedFilter !== null) {
    filterInput.value = savedFilter;
  }

  const savedSort = localStorage.getItem(sortStorageKey);
  if (savedSort && Array.from(sortSelect.options).some(option => option.value === savedSort)) {
    sortSelect.value = savedSort;
  }

  function getAge(card) {
    return parseInt(card.dataset.age) || 0;
  }

  function applyFilter() {
    const term = filterInput.value.toLowerCase();
    cards.forEach(card => {
      const text = card.textContent.toLowerCase();
      card.style.display = text.includes(term) ? '' : 'none';
    });
  }

  function applySort() {
    const value = sortSelect.value;
    const visible = cards.filter(card => card.style.display !== 'none');
    const hidden = cards.filter(card => card.style.display === 'none');
    visible.sort((a, b) => {
      switch (value) {
        case 'name_asc':
          return a.dataset.name.localeCompare(b.dataset.name);
        case 'name_desc':
          return b.dataset.name.localeCompare(a.dataset.name);
        case 'date_asc':
          return new Date(a.dataset.date) - new Date(b.dataset.date);
        case 'age_asc':
          return getAge(a) - getAge(b);
        case 'age_desc':
          return getAge(b) - getAge(a);
        case 'date_desc':
        default:
          return new Date(b.dataset.date) - new Date(a.dataset.date);
      }
    });
    visible.forEach(card => container.appendChild(card));
    hidden.forEach(card => container.appendChild(card));
  }

  filterInput.addEventListener('input', () => {
    localStorage.setItem(filterStorageKey, filterInput.value);
    applyFilter();
    applySort();
  });

  sortSelect.addEventListener('change', () => {
    localStorage.setItem(sortStorageKey, sortSelect.value);
    applySort();
  });

  applyFilter();
  applySort();
})();
</script>
