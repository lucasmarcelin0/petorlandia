{% from 'components/photo_cropper.html' import photo_cropper %}
<form method="POST" action="{{ url_for('update_animal', animal_id=animal.id) }}"
      enctype="multipart/form-data"
      class="needs-validation" novalidate data-sync data-validate="validarCadastroAnimal">

  <h5 class="mb-3">üêæ Cadastro do Animal</h5>

  <div class="row g-4">
    <!-- Foto e Nome -->
    <div class="col-md-6">
      <label for="animal-name" class="form-label">Foto e Nome do Animal</label>
        <div class="d-flex align-items-center gap-3">
          {{ photo_cropper(form.image, form.photo_rotation, form.photo_zoom, form.photo_offset_x, form.photo_offset_y, animal.image, 120, 'animal-image', 'animal') }}
          <input id="animal-name" type="text" name="name" class="form-control"
                 placeholder="Nome do animal" value="{{ animal.name or '' }}" required
                 minlength="2" maxlength="50">
          <div class="invalid-feedback">Por favor, insira um nome v√°lido (2-50 caracteres).</div>
        </div>
    </div>

    <!-- Esp√©cie -->
    <div class="col-md-6">
      <label for="animal-species" class="form-label">Esp√©cie</label>
      <select id="animal-species" name="species_id" class="form-select" required>
        <option value="">Selecionar</option>
        {% for s in species_list %}
          <option value="{{ s.id }}" {% if animal.species_id == s.id %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
      <div class="invalid-feedback">Por favor, selecione uma esp√©cie.</div>
    </div>

    <!-- Ra√ßa -->
    <div class="col-md-6">
      <label for="animal-breed" class="form-label">Ra√ßa</label>
      <select id="animal-breed" name="breed_id" class="form-select">
        <option value="">Selecionar</option>
        {% for b in breed_list %}
          <option value="{{ b.id }}" {% if animal.breed_id == b.id %}selected{% endif %}>{{ b.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Sexo -->
    <div class="col-md-6">
      <label for="animal-sex" class="form-label">Sexo</label>
      <select id="animal-sex" name="sex" class="form-select" required>
        <option value="">Selecionar</option>
        <option value="Macho" {% if animal.sex == 'Macho' %}selected{% endif %}>Macho</option>
        <option value="F√™mea" {% if animal.sex == 'F√™mea' %}selected{% endif %}>F√™mea</option>
      </select>
      <div class="invalid-feedback">Por favor, selecione o sexo.</div>
    </div>

    <!-- Data de nascimento / idade -->
    {% set prefixo = 'animal' %}
    {% set nome_data = 'date_of_birth' %}
    {% set nome_idade = 'age' %}
    {% set nome_unidade = 'age_unit' %}
    {% set valor_data = animal.date_of_birth.strftime('%d/%m/%Y') if animal.date_of_birth else '' %}
    {% set valor_data_iso = animal.date_of_birth.strftime('%Y-%m-%d') if animal.date_of_birth else '' %}
    {% set valor_idade = animal_idade if animal_idade else '' %}
    {% set valor_unidade = animal_idade_unidade if animal_idade_unidade else '' %}
    {% include 'components/campo_data_idade.html' %}

    <!-- Microchip -->
    <div class="col-md-6">
      <label for="animal-microchip" class="form-label">Microchip</label>
      <input id="animal-microchip" type="text" name="microchip_number" class="form-control" 
             value="{{ animal.microchip_number or '' }}" pattern="[0-9]{15}" 
             title="N√∫mero do microchip deve conter 15 d√≠gitos">
      <div class="invalid-feedback">Por favor, insira um n√∫mero de microchip v√°lido (15 d√≠gitos).</div>
    </div>

    <!-- Peso -->
    <div class="col-md-6">
      <label for="animal-peso" class="form-label">Peso (kg)</label>
      <input id="animal-peso" type="number" name="peso" class="form-control" 
             step="0.01" min="0.1" max="200" value="{{ '' if animal.peso is none else animal.peso }}">
      <div class="invalid-feedback">Por favor, insira um peso v√°lido (0.1-200 kg).</div>
    </div>

    <!-- Plano de Sa√∫de -->
    <div class="col-md-6">
      <label for="animal-health-plan" class="form-label">Plano de Sa√∫de</label>
      <input id="animal-health-plan" type="text" name="health_plan" class="form-control" 
             value="{{ animal.health_plan or '' }}" maxlength="100">
    </div>

    <!-- Descri√ß√£o -->
    <div class="col-md-12">
      <label for="animal-description" class="form-label">Descri√ß√£o</label>
      <textarea id="animal-description" name="description" class="form-control" 
                rows="2" maxlength="500">{{ animal.description or '' }}</textarea>
    </div>

    <!-- Castrado -->
    <div class="col-md-6">
      <label for="animal-neutered" class="form-label">Castrado?</label>
      <select id="animal-neutered" name="neutered" class="form-select" required>
        <option value="">Selecionar</option>
        <option value="1" {% if animal.neutered %}selected{% endif %}>Sim</option>
        <option value="0" {% if animal.neutered == False %}selected{% endif %}>N√£o</option>
      </select>
      <div class="invalid-feedback">Por favor, informe se o animal √© castrado.</div>
    </div>
  </div>

  <div class="mt-4 d-flex justify-content-between">
    <button type="submit" class="btn btn-success">
      <i class="bi bi-save me-1"></i> Salvar
    </button>
  </div>
</form>

<!-- Bot√£o de deletar -->
<form method="POST" action="{{ url_for('deletar_animal', animal_id=animal.id) }}"
      onsubmit="return confirm('Tem certeza que deseja remover permanentemente este animal? Esta a√ß√£o n√£o pode ser desfeita.');" 
      class="mt-2">
  <button type="submit" class="btn btn-outline-danger">
    <i class="bi bi-trash me-1"></i> Remover Animal
  </button>
</form>

<!-- Scripts -->
{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Valida√ß√£o do formul√°rio
    const forms = document.querySelectorAll('.needs-validation');
    
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });


    // Valida√ß√£o customizada
    window.validarCadastroAnimal = function () {
      const tutorIdField = document.getElementById('tutor_id');
      if (tutorIdField && !tutorIdField.value) {
        alert('Selecione um tutor antes de salvar o animal.');
        return false;
      }
      return true;
    };
  });
</script>
{% endblock %}