<!-- templates/partials/animal_register_form.html -->
<form method="POST" action="{{ url_for('novo_animal') }}" onsubmit="return handleSubmit(this);" data-sync="true" class="js-animal-form">
    <h5 class="mb-3">üêæ Cadastro do Animal</h5>

    {% if not tutor %}
    <!-- üîé Tutor -->
    <div class="mb-3 position-relative">
      <label for="autocomplete-tutor" class="form-label">üë§ Tutor</label>
      <div class="input-group shadow-sm rounded-3">
        <span class="input-group-text bg-white text-muted border-end-0">
          <i class="bi bi-search"></i>
        </span>
        <input type="text"
               id="autocomplete-tutor"
               class="form-control border-start-0"
               placeholder="Digite nome ou e-mail do tutor"
               autocomplete="off"
               aria-label="Buscar tutor pelo nome ou e-mail"
               aria-describedby="tutor-search-help"
               aria-controls="tutor-results"
               aria-expanded="false">
        <button class="btn btn-outline-secondary" type="button" id="clear-tutor-search" aria-label="Limpar busca">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div id="tutor-search-help" class="form-text">Digite pelo menos 2 caracteres para iniciar a busca.</div>
      <div id="tutor-search-status" class="mt-2 small text-muted d-none" aria-live="polite"></div>
      <input type="hidden" name="tutor_id" id="tutor_id">
      <ul class="list-group position-absolute w-100 mt-1 d-none shadow"
          id="tutor-results"
          role="listbox"
          style="z-index: 1000; max-height: 240px; overflow-y: auto;"></ul>
      <div class="text-end mt-2">
        <a href="{{ url_for('tutores') }}" class="btn btn-sm btn-outline-secondary">
          ‚ûï Cadastrar novo tutor
        </a>
      </div>
    </div>
    {% endif %}

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Nome</label>
        <input type="text" name="name" class="form-control input-focus" required>
      </div>
      <!-- Esp√©cie -->
      <div class="col-md-6">
        <label class="form-label">Esp√©cie</label>
        <select name="species_id" class="form-select" required>
          <option value="">Selecionar</option>
          {% for especie in species_list %}
            <option value="{{ especie.id }}">{{ especie.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Ra√ßa -->
      <div class="col-md-6">
        <label class="form-label">Ra√ßa</label>
        <select name="breed_id" class="form-select">
          <option value="">Selecionar</option>
          {% for raca in breed_list %}
            <option value="{{ raca.id }}">{{ raca.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Sexo</label>
        <select name="sex" class="form-select">
          <option value="">Selecionar</option>
          <option value="Macho">Macho</option>
          <option value="F√™mea">F√™mea</option>
        </select>
      </div>
      {% set prefixo = 'animal_reg' %}
      {% set nome_data = 'date_of_birth' %}
      {% set nome_idade = 'age' %}
      {% include 'components/campo_data_idade.html' %}
      <div class="col-md-6">
        <label class="form-label">Microchip</label>
        <input type="text" name="microchip_number" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label">Peso (kg)</label>
        <input type="number" name="peso" class="form-control" step="0.01">
      </div>
      <div class="col-md-6">
        <label class="form-label">Plano de Sa√∫de</label>
        <input type="text" name="health_plan" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label">Castrado?</label>
        <select name="neutered" class="form-select">
          <option value="">Selecionar</option>
          <option value="1">Sim</option>
          <option value="0">N√£o</option>
        </select>
      </div>
    </div>

    <div class="mt-4 text-end">
      <button type="submit" class="btn btn-outline-success">
        üìÇ Salvar Animal
      </button>
    </div>
    </form>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.8/dist/inputmask.min.js"></script>

    <script>
    function validarTutor() {
      {% if not tutor %}
      if (!document.getElementById('tutor_id').value) {
        alert('Por favor, selecione um tutor antes de salvar o animal.');
        return false;
      }
      {% endif %}
      return true;
    }

    function handleSubmit(form) {
      if (!validarTutor()) {
        return false;
      }
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.dataset.original = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Salvando...';
      }
      return true;
    }

    const tutorInput = document.getElementById('autocomplete-tutor');
    const tutorResults = document.getElementById('tutor-results');
    const tutorIdField = document.getElementById('tutor_id');

    if (tutorInput && tutorResults && tutorIdField) {
      const tutorStatus = document.getElementById('tutor-search-status');
      const clearTutorSearch = document.getElementById('clear-tutor-search');

      let tutorResultsData = [];
      let activeResultIndex = -1;
      let searchTimeout;

      const setStatusMessage = (message = '', state = 'idle') => {
        if (!tutorStatus) return;
        tutorStatus.textContent = message;
        tutorStatus.classList.toggle('d-none', !message);
        tutorStatus.dataset.state = state;
      };

      const resetResults = () => {
        tutorResults.innerHTML = '';
        tutorResults.classList.add('d-none');
        tutorInput.setAttribute('aria-expanded', 'false');
        tutorInput.removeAttribute('aria-activedescendant');
        tutorResultsData = [];
        activeResultIndex = -1;
      };

      const highlightResult = (index) => {
        const items = tutorResults.querySelectorAll('[data-result-index]');
        items.forEach(item => item.classList.remove('active'));
        if (index >= 0 && items[index]) {
          items[index].classList.add('active');
          tutorInput.setAttribute('aria-activedescendant', items[index].id);
          items[index].scrollIntoView({ block: 'nearest' });
        } else {
          tutorInput.removeAttribute('aria-activedescendant');
        }
      };

      const selectTutor = (tutor) => {
        tutorInput.value = tutor.name;
        tutorIdField.value = tutor.id;
        resetResults();
        setStatusMessage(`${tutor.name} selecionado(a).`);
      };

      const renderResults = (data) => {
        resetResults();
        if (!data.length) {
          setStatusMessage('Nenhum tutor encontrado.', 'empty');
          return;
        }

        tutorResultsData = data;
        const fragment = document.createDocumentFragment();
        data.forEach((tutor, index) => {
          const li = document.createElement('li');
          li.className = 'list-group-item list-group-item-action';
          li.id = `tutor-option-${tutor.id}`;
          li.role = 'option';
          li.dataset.resultIndex = index;
          li.innerHTML = `
            <div class="fw-semibold">${tutor.name}</div>
            <div class="small text-muted">${tutor.email || 'Sem e-mail cadastrado'}</div>
          `;
          li.addEventListener('mousedown', (event) => {
            // Prevent input blur before click handler runs
            event.preventDefault();
          });
          li.addEventListener('click', () => selectTutor(tutor));
          fragment.appendChild(li);
        });

        tutorResults.appendChild(fragment);
        tutorResults.classList.remove('d-none');
        tutorInput.setAttribute('aria-expanded', 'true');
        highlightResult(-1);
        setStatusMessage(`${data.length} tutor(es) encontrado(s).`);
      };

      const fetchTutors = async (query) => {
        if (!query || query.length < 2) {
          resetResults();
          setStatusMessage('Digite pelo menos 2 caracteres para buscar.');
          return;
        }

        setStatusMessage('Buscando tutores...', 'loading');

        try {
          const response = await fetch(`/buscar_tutores?q=${encodeURIComponent(query)}`);
          if (!response.ok) {
            throw new Error('Falha na busca');
          }
          const data = await response.json();
          renderResults(data);
        } catch (error) {
          console.error('Erro ao buscar tutores:', error);
          resetResults();
          setStatusMessage('N√£o foi poss√≠vel buscar tutores. Tente novamente.', 'error');
        }
      };

      const handleInputChange = (event) => {
        const query = event.target.value.trim();
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => fetchTutors(query), 250);
      };

      const handleKeyNavigation = (event) => {
        if (!tutorResultsData.length) return;

        if (event.key === 'ArrowDown') {
          event.preventDefault();
          activeResultIndex = (activeResultIndex + 1) % tutorResultsData.length;
          highlightResult(activeResultIndex);
        } else if (event.key === 'ArrowUp') {
          event.preventDefault();
          activeResultIndex = (activeResultIndex - 1 + tutorResultsData.length) % tutorResultsData.length;
          highlightResult(activeResultIndex);
        } else if (event.key === 'Enter') {
          if (activeResultIndex >= 0) {
            event.preventDefault();
            selectTutor(tutorResultsData[activeResultIndex]);
          }
        } else if (event.key === 'Escape') {
          resetResults();
          setStatusMessage('Busca cancelada.');
        }
      };

      tutorInput.addEventListener('input', handleInputChange);
      tutorInput.addEventListener('keydown', handleKeyNavigation);
      tutorInput.addEventListener('focus', () => {
        if (tutorResultsData.length) {
          tutorResults.classList.remove('d-none');
          tutorInput.setAttribute('aria-expanded', 'true');
        }
      });
      tutorInput.addEventListener('blur', () => {
        setTimeout(() => {
          tutorResults.classList.add('d-none');
          tutorInput.setAttribute('aria-expanded', 'false');
        }, 150);
      });

      clearTutorSearch?.addEventListener('click', () => {
        tutorInput.value = '';
        tutorIdField.value = '';
        tutorInput.focus();
        resetResults();
        setStatusMessage('Busca limpa.');
      });

      document.addEventListener('click', (event) => {
        if (!tutorResults.contains(event.target) && event.target !== tutorInput) {
          tutorResults.classList.add('d-none');
          tutorInput.setAttribute('aria-expanded', 'false');
        }
      });

      setStatusMessage('Digite pelo menos 2 caracteres para buscar.');
    }
  </script>

  <style>
    .input-focus:focus {
      border-color: #198754;
      box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
      transition: all 0.3s ease;
    }

    #tutor-results .list-group-item {
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    #tutor-results .list-group-item.active,
    #tutor-results .list-group-item:hover,
    #tutor-results .list-group-item:focus {
      background-color: #e9f5ef;
      color: #0f5132;
    }
  </style>
