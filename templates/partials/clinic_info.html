<!-- partials/clinic_info.html -->
{% from 'components/logo.html' import clinic_logo %}
<section class="clinic-hero mb-4">
  <div class="clinic-hero__inner row g-4 align-items-center">
    <div class="col-lg-7">
      <p class="clinic-hero__eyebrow text-white-50 mb-1">Clínica parceira</p>
      <h1 class="clinic-hero__title text-white mb-3">{{ clinica.nome }}</h1>
      <p class="clinic-hero__subtitle text-white-75 mb-4">Cuidando de cada pet com carinho e tecnologia.</p>
      <div class="clinic-hero__chips mb-4">
        {% if clinica.endereco %}
          <span class="clinic-hero__chip"><i class="fa-solid fa-location-dot"></i>{{ clinica.endereco }}</span>
        {% endif %}
        {% if clinica.telefone %}
          <span class="clinic-hero__chip"><i class="fa-solid fa-phone"></i>{{ clinica.telefone }}</span>
        {% endif %}
        {% if clinica.email %}
          <span class="clinic-hero__chip"><i class="fa-solid fa-envelope"></i>{{ clinica.email }}</span>
        {% endif %}
      </div>
      <div class="clinic-hero__actions d-flex flex-wrap gap-2">
        {% if pode_editar %}
          <button type="button" class="btn btn-light btn-lg d-inline-flex align-items-center gap-2"
                  onclick="toggleEditInfo(); document.getElementById('edit-info').scrollIntoView({behavior: 'smooth'});">
            <i class="fa-solid fa-pen-to-square"></i>
            Editar dados
          </button>
        {% endif %}
        <a href="/nova_consulta" class="btn btn-outline-light btn-lg d-inline-flex align-items-center gap-2">
          <i class="fa-solid fa-stethoscope"></i>
          Nova consulta
        </a>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="clinic-hero__photo shadow-lg">
        {% if clinica.logotipo %}
          {{ clinic_logo(clinica, alt_text='Mascote da clínica') }}
        {% else %}
          <img src="{{ url_for('static', filename='pastorgado.jpg') }}" alt="Mascote PetOrlândia" class="clinic-hero__fallback">
        {% endif %}
      </div>
    </div>
  </div>
</section>

{% if pode_editar %}
  <div id="edit-info" class="card shadow-lg border-0 rounded-3 mb-4" style="display:none;">
    <div class="card-body">
      <h5 class="fw-semibold mb-3">Atualizar informações da clínica</h5>
      <form method="post" enctype="multipart/form-data" class="row g-3">
        {{ clinic_form.hidden_tag() }}
        <div class="col-md-6">{{ clinic_form.nome.label }} {{ clinic_form.nome(class="form-control") }}</div>
        <div class="col-md-6">{{ clinic_form.cnpj.label }} {{ clinic_form.cnpj(class="form-control") }}</div>
        <div class="col-md-12">{{ clinic_form.endereco.label }} {{ clinic_form.endereco(class="form-control") }}</div>
        <div class="col-md-6">{{ clinic_form.telefone.label }} {{ clinic_form.telefone(class="form-control") }}</div>
        <div class="col-md-6">{{ clinic_form.email.label }} {{ clinic_form.email(class="form-control") }}</div>
        <div class="col-md-12">
          {{ clinic_form.logotipo.label }}
          {{ photo_cropper(clinic_form.logotipo, clinic_form.photo_rotation, clinic_form.photo_zoom, clinic_form.photo_offset_x, clinic_form.photo_offset_y, clinica.logotipo, 150, 'clinic_logo', 'user') }}
        </div>
        <div class="col-12">
          {{ clinic_form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
{% endif %}

{% if show_clinic_metrics %}
  {% set prescricao_url = None %}
  {% if animais_adicionados %}
    {% set prescricao_url = url_for('consulta_direct', animal_id=animais_adicionados[0].id) + '#historico-prescricoes' %}
  {% endif %}
  <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-3 mb-4">
    <div class="col">
      <div class="card h-100 border-0 shadow-sm position-relative">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <span class="rounded-circle bg-danger text-white d-inline-flex align-items-center justify-content-center" style="width:3rem; height:3rem;">
              <i class="fa-solid fa-paw"></i>
            </span>
            <small class="text-muted text-uppercase fw-semibold">Animais</small>
          </div>
          <h3 class="fw-bold mb-1">{{ clinic_metrics.animals or 0 }}</h3>
          <p class="text-muted small mb-3">cadastrados</p>
          <a class="small fw-semibold text-decoration-none text-primary mt-auto" href="{{ url_for('clinic_detail', clinica_id=clinica.id) }}#animais">
            Ver animais <i class="fa-solid fa-arrow-right-long ms-1"></i>
          </a>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100 border-0 shadow-sm position-relative">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <span class="rounded-circle bg-info text-white d-inline-flex align-items-center justify-content-center" style="width:3rem; height:3rem;">
              <i class="fa-solid fa-user-group"></i>
            </span>
            <small class="text-muted text-uppercase fw-semibold">Tutores</small>
          </div>
          <h3 class="fw-bold mb-1">{{ clinic_metrics.tutors or 0 }}</h3>
          <p class="text-muted small mb-3">ativos</p>
          <a class="small fw-semibold text-decoration-none text-primary mt-auto" href="{{ url_for('clinic_detail', clinica_id=clinica.id) }}#tutores">
            Ver tutores <i class="fa-solid fa-arrow-right-long ms-1"></i>
          </a>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100 border-0 shadow-sm position-relative">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <span class="rounded-circle bg-success text-white d-inline-flex align-items-center justify-content-center" style="width:3rem; height:3rem;">
              <i class="fa-solid fa-calendar-check"></i>
            </span>
            <small class="text-muted text-uppercase fw-semibold">Consultas</small>
          </div>
          <h3 class="fw-bold mb-1">{{ clinic_metrics.future_appointments or 0 }}</h3>
          <p class="text-muted small mb-3">próximas</p>
          <a class="small fw-semibold text-decoration-none text-primary mt-auto" href="{{ url_for('clinic_detail', clinica_id=clinica.id) }}#agendamentos">
            Ver agenda <i class="fa-solid fa-arrow-right-long ms-1"></i>
          </a>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card h-100 border-0 shadow-sm position-relative">
        <div class="card-body d-flex flex-column">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <span class="rounded-circle bg-warning text-dark d-inline-flex align-items-center justify-content-center" style="width:3rem; height:3rem;">
              <i class="fa-solid fa-prescription-bottle-medical"></i>
            </span>
            <small class="text-muted text-uppercase fw-semibold">Receitas</small>
          </div>
          <h3 class="fw-bold mb-1">{{ clinic_metrics.open_prescriptions or 0 }}</h3>
          <p class="text-muted small mb-3">abertas</p>
          {% if prescricao_url %}
            <a class="small fw-semibold text-decoration-none text-primary mt-auto" href="{{ prescricao_url }}">
              Ver prescrições <i class="fa-solid fa-arrow-right-long ms-1"></i>
            </a>
          {% else %}
            <span class="small text-muted mt-auto" aria-disabled="true">Cadastre um animal para acessar</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endif %}

<!-- Horários -->
<div class="card shadow-sm border-0 rounded-3 mb-4">
  <div class="card-header bg-transparent border-0 pb-0">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="d-flex align-items-center gap-2">
        <span class="clinic-hours-chip"><i class="far fa-clock"></i></span>
        <div>
          <h5 class="mb-0">Horários de Atendimento</h5>
          <small class="text-muted">Visualize rapidamente quando a clínica está disponível.</small>
        </div>
      </div>
      {% if pode_editar %}
        <button class="btn btn-outline-primary d-inline-flex align-items-center gap-2"
                onclick="toggleEditHours(); document.getElementById('edit-hours').scrollIntoView({behavior: 'smooth'});">
          <i class="fa-solid fa-calendar-plus"></i> Gerenciar horários
        </button>
      {% endif %}
    </div>
  </div>
  <div class="card-body">
    {% if horarios %}
      <div class="clinic-hours-timeline">
        {% for h in horarios %}
          {% set is_night = h.hora_abertura.hour >= 18 or h.hora_fechamento.hour < 6 %}
          <article class="clinic-hour-card d-flex align-items-start gap-3">
            <div class="clinic-hour-icon {{ 'clinic-hour-icon--night' if is_night else 'clinic-hour-icon--day' }}">
              <i class="fa-solid {{ 'fa-moon' if is_night else 'fa-sun' }}"></i>
            </div>
            <div class="flex-grow-1">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <h6 class="mb-0 fw-semibold">{{ h.dia_semana }}</h6>
                <span class="badge {{ 'bg-dark text-white' if is_night else 'bg-success' }}">{{ 'Turno noturno' if is_night else 'Turno diurno' }}</span>
              </div>
              <div class="clinic-hour-status d-flex flex-wrap gap-2 mt-2">
                <span class="clinic-hour-badge clinic-hour-badge--open">
                  <i class="fa-solid fa-door-open"></i>
                  Aberto {{ h.hora_abertura.strftime('%H:%M') }}
                </span>
                <span class="clinic-hour-badge clinic-hour-badge--closed">
                  <i class="fa-solid fa-door-closed"></i>
                  Fecha {{ h.hora_fechamento.strftime('%H:%M') }}
                </span>
              </div>
            </div>
            {% if pode_editar %}
              <div class="clinic-hour-actions">
                <form method="post" action="{{ url_for('delete_clinic_hour', clinica_id=clinica.id, horario_id=h.id) }}">
                  {{ form.csrf_token }}
                  <button type="submit" class="btn btn-sm btn-link text-danger p-0"
                          onclick="return confirm('Excluir este horário?');" title="Excluir horário">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </form>
              </div>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="clinic-hours-empty text-center py-5">
        <img src="{{ url_for('static', filename='pastorgato.png') }}" alt="Ilustração de agenda" class="clinic-hours-empty__image mb-3">
        <h6 class="fw-semibold mb-1">Ainda sem horários cadastrados</h6>
        <p class="text-muted mb-0">Adicione os períodos de atendimento para facilitar novos agendamentos.</p>
      </div>
    {% endif %}

    {% if pode_editar %}
      <div id="edit-hours" class="mt-4" style="display:none;">
        <div class="border rounded-3 p-3 bg-light-subtle">
          <h6 class="fw-semibold mb-3">Adicionar/editar faixa de atendimento</h6>
          <form method="post" class="row g-3">
            {{ form.hidden_tag() }}
            <div class="col-md-12">
              {{ form.clinica_id.label }} {{ form.clinica_id(class="form-select") }}
            </div>
            <div class="col-md-12">
              {{ form.dias_semana.label }} {{ form.dias_semana(class="form-select", multiple=True, size=7) }}
              <div class="mt-2 d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('all')">Todos</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('weekday')">Dias Úteis</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('weekend')">Fins de Semana</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDays('clear')">Limpar</button>
              </div>
            </div>
            <div class="col-md-6">
              {{ form.hora_abertura.label }} {{ form.hora_abertura(class="form-control") }}
            </div>
            <div class="col-md-6">
              {{ form.hora_fechamento.label }} {{ form.hora_fechamento(class="form-control") }}
            </div>
            <div class="col-12">
              {{ form.submit(class="btn btn-primary") }}
            </div>
          </form>
        </div>
      </div>
    {% endif %}
  </div>
</div>
