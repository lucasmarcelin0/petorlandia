{% set endereco = tutor.endereco if tutor else None %}


<div class="card shadow-sm rounded-4 p-4 mb-4 border-0">
  <h5 class="mb-3 text-primary-emphasis">üìç Endere√ßo</h5>
  <div class="row g-3">

    <!-- CEP -->
    <div class="col-md-4">
      <label for="cep" class="form-label">CEP</label>
      <input type="text" class="form-control" name="cep" id="cep" value="{{ endereco.cep if endereco else '' }}" maxlength="9" placeholder="00000-000" onblur="buscarCep()">
      <div id="cep-loading" class="form-text text-muted d-none">
        <i class="bi bi-arrow-repeat me-1"></i> Buscando informa√ß√µes do CEP...
      </div>
    </div>

    <!-- Rua -->
    <div class="col-md-8">
      <label for="rua" class="form-label">Rua <span class="text-danger">*</span></label>
      <input type="text" class="form-control" name="rua" id="rua" value="{{ endereco.rua if endereco else '' }}">
    </div>

    <!-- N√∫mero -->
    <div class="col-md-3">
      <label for="numero" class="form-label">N√∫mero</label>
      <input type="text" class="form-control" name="numero" id="numero" value="{{ endereco.numero if endereco else '' }}">
    </div>

    <!-- Complemento -->
    <div class="col-md-3">
      <label for="complemento" class="form-label">Complemento</label>
      <input type="text" class="form-control" name="complemento" id="complemento" value="{{ endereco.complemento if endereco else '' }}">
    </div>

    <!-- Bairro -->
    <div class="col-md-3">
      <label for="bairro" class="form-label">Bairro</label>
      <input type="text" class="form-control" name="bairro" id="bairro" value="{{ endereco.bairro if endereco else '' }}">
    </div>

    <!-- Cidade -->
    <div class="col-md-3">
      <label for="cidade" class="form-label">Cidade <span class="text-danger">*</span></label>
      <input type="text" class="form-control" name="cidade" id="cidade" value="{{ endereco.cidade if endereco else '' }}">
    </div>

    <!-- Estado -->
    <div class="col-md-2">
      <label for="estado" class="form-label">UF <span class="text-danger">*</span></label>
      <input type="text" class="form-control" name="estado" id="estado" value="{{ endereco.estado if endereco else '' }}">
    </div>

  </div>
</div>

<script>
function buscarCep() {
  const cep = document.getElementById("cep").value.replace(/\D/g, '');
  const loading = document.getElementById("cep-loading");
  if (cep.length !== 8) return;

  loading.classList.remove("d-none");

  fetch(`https://viacep.com.br/ws/${cep}/json/`)
    .then(res => res.json())
    .then(data => {
      if (data.erro) {
        alert("CEP n√£o encontrado.");
        return;
      }

      document.getElementById("rua").value = data.logradouro || "";
      document.getElementById("complemento").value = data.complemento || "";
      document.getElementById("bairro").value = data.bairro || "";
      document.getElementById("cidade").value = data.localidade || "";
      document.getElementById("estado").value = data.uf || "";
    })
    .catch(() => alert("Erro ao buscar o CEP."))
    .finally(() => loading.classList.add("d-none"));
}

// Valida√ß√£o visual
document.addEventListener("DOMContentLoaded", function () {
  document.querySelector("form")?.addEventListener("submit", function (e) {
    const rua = document.getElementById("rua");
    const cidade = document.getElementById("cidade");
    const estado = document.getElementById("estado");

    [rua, cidade, estado].forEach(field => field.classList.remove("is-invalid"));

    if (!rua.value || !cidade.value || !estado.value) {
      e.preventDefault();
      [rua, cidade, estado].forEach(field => {
        if (!field.value) field.classList.add("is-invalid");
      });
      alert("Por favor, preencha os campos obrigat√≥rios: rua, cidade e estado.");
    }
  });
});
</script>

<style>
.is-invalid {
  border-color: #dc3545 !important;
  box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}
</style>
