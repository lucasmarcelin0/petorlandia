<form>
  <div id="feedback-exames" class="alert d-none position-fixed" style="top: 20px; right: 20px; z-index: 1000;"></div>
  <h5 class="mb-3">Solicita√ß√£o de Exames</h5>

  <!-- Campo com autocomplete -->
  <div class="mb-3 position-relative">
    <label for="nome-exame" class="form-label">Tipo de Exame</label>
    <input type="text" id="nome-exame" class="form-control" placeholder="Ex: Hemograma, Raio-X, Ultrassom...">
    <ul id="sugestoes-exames" class="list-group position-absolute w-100" style="z-index: 10;"></ul>
  </div>

  <!-- Justificativa -->
  <div class="mb-3">
    <label for="justificativa-exame" class="form-label">Justificativa</label>
    <textarea id="justificativa-exame" class="form-control" rows="2" placeholder="Por que o exame √© necess√°rio?"></textarea>
  </div>

  <!-- Bot√£o para adicionar √† lista -->
  <button type="button" class="btn btn-success mb-4" onclick="adicionarExame()">‚ûï Adicionar Exame</button>

  <!-- Lista de exames tempor√°ria -->
  <div id="exames-lista" class="mb-4"></div>

  <!-- Observa√ß√µes gerais -->
  <div class="mb-3">
    <label for="observacoes-exames" class="form-label">Observa√ß√µes Gerais</label>
    <textarea id="observacoes-exames" class="form-control" rows="3" placeholder="Ex: Jejum de 12h, trazer hist√≥rico cl√≠nico anterior..."></textarea>
  </div>

  <!-- Bot√£o para finalizar -->
  <button type="button" class="btn btn-primary mt-2" id="btn-finalizar-exames" onclick="finalizarBlocoExames()">üíæ Finalizar Solicita√ß√£o</button>
</form>

<!-- Agendamento de exame -->
<button type="button" class="btn btn-outline-primary mt-4" id="toggle-agendar-exame">Agendar Exame</button>
<div id="agendar-exame" class="mt-5 d-none">
  <h5 class="mb-3">Agendar Exame</h5>
  <div class="mb-3">
    <label for="exam-specialty" class="form-label">Especialidade</label>
    <select id="exam-specialty" class="form-select"></select>
  </div>
  <div class="mb-3">
    <label for="exam-specialist" class="form-label">Especialista</label>
    <select id="exam-specialist" class="form-select"></select>
  </div>
  <div class="mb-3">
    <label for="exam-date" class="form-label">Data</label>
    <input type="date" id="exam-date" class="form-control">
  </div>
  <div class="mb-3">
    <label for="exam-time" class="form-label">Hor√°rio</label>
    <select id="exam-time" class="form-select"><option value="">Selecione...</option></select>
  </div>
  <button type="button" class="btn btn-outline-primary" onclick="agendarExame()">üìÖ Agendar Exame</button>
</div>

<!-- Exames agendados -->
<div id="historico-agendamentos" class="mt-5">
  {% set appointments = animal.exam_appointments %}
  {% include 'partials/historico_exam_appointments.html' %}
</div>

<!-- Hist√≥rico de exames -->
<div id="historico-exames" class="mt-5">
  {% include 'partials/historico_exames.html' %}
</div>






<script>
  let exames = [];
  let inputExame, sugestoes;
  function mostrarFeedback(msg, tipo = 'success') {
    const fb = document.getElementById('feedback-exames');
    fb.textContent = msg;
    fb.className = `alert alert-${tipo} d-block`;
    setTimeout(() => fb.classList.add('d-none'), 3000);
  }

  document.addEventListener('DOMContentLoaded', function () {
    inputExame = document.getElementById('nome-exame');
    sugestoes = document.getElementById('sugestoes-exames');

    const toggleAgendarBtn = document.getElementById('toggle-agendar-exame');
    const agendarDiv = document.getElementById('agendar-exame');
    if (toggleAgendarBtn && agendarDiv) {
      toggleAgendarBtn.addEventListener('click', function () {
        agendarDiv.classList.toggle('d-none');
      });
    }

    inputExame.addEventListener('input', function () {
      const query = this.value;
      if (query.length < 2) {
        sugestoes.innerHTML = '';
        return;
      }

      fetch(`/buscar_exames?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          sugestoes.innerHTML = '';
          if (data.length) {
            data.forEach(item => {
              const li = document.createElement('li');
              li.className = 'list-group-item list-group-item-action';
              li.textContent = item.nome;
              li.onclick = () => {
                inputExame.value = item.nome;
                document.getElementById('justificativa-exame').value = item.justificativa || '';
                sugestoes.innerHTML = '';
              };
              sugestoes.appendChild(li);
            });
          } else {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `
              <div class="input-group">
                <input type="text" id="novo-exame-nome" class="form-control" placeholder="Novo exame">
                <button class="btn btn-outline-primary" type="button" id="btn-criar-exame">Criar</button>
              </div>`;
            sugestoes.appendChild(li);
            const novoInput = document.getElementById('novo-exame-nome');
            novoInput.value = query;
            document.getElementById('btn-criar-exame').onclick = criarExameModelo;
          }
        });
  });

    const specialtySelect = document.getElementById('exam-specialty');
    const specialistSelect = document.getElementById('exam-specialist');
    if (specialtySelect && specialistSelect) {
      fetch('/api/specialties')
        .then(r => r.json())
        .then(data => {
          specialtySelect.innerHTML = '<option value="">Selecione...</option>';
          data.forEach(sp => {
            const opt = document.createElement('option');
            opt.value = sp.id;
            opt.textContent = sp.nome;
            specialtySelect.appendChild(opt);
          });
        });

      specialtySelect.addEventListener('change', () => {
        const specId = specialtySelect.value;
        specialistSelect.innerHTML = '<option value="">Selecione...</option>';
        if (!specId) return;
        fetch(`/api/specialists?specialty_id=${specId}`)
          .then(r => r.json())
          .then(data => {
            data.forEach(sp => {
              const opt = document.createElement('option');
              const esp = sp.especialidades.join(', ');
              opt.value = sp.id;
              opt.textContent = esp ? `${sp.nome} - ${esp}` : sp.nome;
              specialistSelect.appendChild(opt);
            });
          });
      });
      specialistSelect.addEventListener('change', atualizarHorarios);
      document.getElementById('exam-date').addEventListener('change', atualizarHorarios);
    }

  renderExamesTemp(); // Inicializa a lista se j√° houver dados
  });

  async function criarExameModelo() {
    const nome = document.getElementById('novo-exame-nome')?.value.trim();
    if (!nome) {
      mostrarFeedback('Informe o nome do exame.', 'danger');
      return;
    }
    try {
      const resp = await fetch('/exame_modelo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ nome })
      });
      if (!resp.ok) throw new Error();
      const data = await resp.json();
      mostrarFeedback('Exame criado com sucesso!');
      const li = document.createElement('li');
      li.className = 'list-group-item list-group-item-action';
      li.textContent = data.nome;
      li.onclick = () => {
        inputExame.value = data.nome;
        document.getElementById('justificativa-exame').value = '';
        sugestoes.innerHTML = '';
      };
      sugestoes.innerHTML = '';
      sugestoes.appendChild(li);
      li.click();
    } catch (e) {
      mostrarFeedback('Erro ao criar exame.', 'danger');
    }
  }

  function adicionarExame() {
    const nome = document.getElementById('nome-exame').value.trim();
    const justificativa = document.getElementById('justificativa-exame').value.trim();

    if (!nome || !justificativa) {
      alert('Preencha o nome do exame e a justificativa.');
      return;
    }

    exames.push({ nome, justificativa });
    renderExamesTemp();

    document.getElementById('nome-exame').value = '';
    document.getElementById('justificativa-exame').value = '';
  }

  function removerExame(index) {
    exames.splice(index, 1);
    renderExamesTemp();
  }

  function editarExame(index) {
    const div = document.getElementById(`exame-${index}`);
    const exame = exames[index];

    div.innerHTML = `
      <div class="mb-2">
        <label class="form-label">Nome do Exame</label>
        <input type="text" class="form-control" id="edit-nome-${index}" value="${exame.nome}">
      </div>
      <div class="mb-2">
        <label class="form-label">Justificativa</label>
        <textarea class="form-control" id="edit-just-${index}">${exame.justificativa}</textarea>
      </div>
      <button class="btn btn-sm btn-success me-2" onclick="salvarEdicaoExame(${index})">üíæ Salvar</button>
      <button class="btn btn-sm btn-secondary" onclick="renderExamesTemp()">Cancelar</button>
    `;
  }

  function salvarEdicaoExame(index) {
    const nome = document.getElementById(`edit-nome-${index}`).value.trim();
    const justificativa = document.getElementById(`edit-just-${index}`).value.trim();

    if (!nome || !justificativa) {
      alert('Preencha os dois campos.');
      return;
    }

    exames[index] = { nome, justificativa };
    renderExamesTemp();
  }

  function renderExamesTemp() {
    const lista = document.getElementById('exames-lista');
    lista.innerHTML = '';

    exames.forEach((exame, i) => {
      const div = document.createElement('div');
      div.className = 'border p-2 mb-2';
      div.id = `exame-${i}`;
      div.innerHTML = `
        üß™ <strong>${exame.nome}</strong><br>
        <em>${exame.justificativa}</em><br>
        <button class="btn btn-sm btn-warning me-2" onclick="editarExame(${i})">‚úèÔ∏è Editar</button>
        <button class="btn btn-sm btn-danger" onclick="removerExame(${i})">üóëÔ∏è Remover</button>
      `;
      lista.appendChild(div);
    });
  }

  async function atualizarHorarios() {
    const vetId = document.getElementById('exam-specialist').value;
    const date = document.getElementById('exam-date').value;
    if (!vetId || !date) return;
    const resp = await fetch(`/api/specialist/${vetId}/available_times?date=${date}`);
    const horarios = await resp.json();
    const select = document.getElementById('exam-time');
    select.innerHTML = '<option value="">Selecione...</option>';
    horarios.forEach(h => {
      const opt = document.createElement('option');
      opt.value = h;
      opt.textContent = h;
      select.appendChild(opt);
    });
  }

  async function agendarExame() {
    const vetId = document.getElementById('exam-specialist').value;
    const date = document.getElementById('exam-date').value;
    const time = document.getElementById('exam-time').value;
    if (!vetId || !date || !time) {
      alert('Selecione especialista, data e hor√°rio.');
      return;
    }
    const resp = await fetch(`/animal/{{ animal.id }}/schedule_exam`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ specialist_id: vetId, date, time })
    });
    if (resp.ok) {
      const data = await resp.json();
      mostrarFeedback('Exame agendado! Aguarde confirma√ß√£o do especialista.');
      document.getElementById('exam-time').innerHTML = '<option value="">Selecione...</option>';
      if (data.html) {
        const hist = document.getElementById('historico-agendamentos');
        hist.innerHTML = data.html;
      }
      atualizarHorarios();
    } else {
      mostrarFeedback('Erro ao agendar exame.', 'danger');
    }
  }

  async function deletarAgendamentoExame(id) {
    if (!confirm('Excluir este agendamento?')) return;
    const resp = await fetch(`/exam_appointment/${id}/delete`, {
      method: 'POST',
      headers: { 'Accept': 'application/json' }
    });
    if (resp.ok) {
      const data = await resp.json();
      if (data.html) {
        document.getElementById('historico-agendamentos').innerHTML = data.html;
      }
      mostrarFeedback('Agendamento exclu√≠do.');
    } else {
      mostrarFeedback('Erro ao excluir agendamento.', 'danger');
    }
  }

  function editarAgendamentoExame(id) {
    const li = document.getElementById(`exam-appt-${id}`);
    if (!li) return;
    li.querySelector('.exam-view')?.classList.add('d-none');
    li.querySelector('.exam-edit-form')?.classList.remove('d-none');
  }

  function cancelarEdicaoExame(id) {
    const li = document.getElementById(`exam-appt-${id}`);
    if (!li) return;
    li.querySelector('.exam-edit-form')?.classList.add('d-none');
    li.querySelector('.exam-view')?.classList.remove('d-none');
  }

  async function salvarAgendamentoExame(ev, id) {
    ev.preventDefault();
    const form = ev.target;
    const date = form.querySelector('[name="date"]').value;
    const time = form.querySelector('[name="time"]').value;
    const specialistId = form.querySelector('[name="specialist_id"]').value;
    const resp = await fetch(`/exam_appointment/${id}/update`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ date, time, specialist_id: specialistId })
    });
    if (resp.ok) {
      const data = await resp.json();
      if (data.html) {
        document.getElementById('historico-agendamentos').innerHTML = data.html;
      }
      mostrarFeedback('Agendamento atualizado!');
      atualizarHorarios();
    } else {
      mostrarFeedback('Erro ao atualizar agendamento.', 'danger');
    }
  }

  async function finalizarBlocoExames() {
    if (exames.length === 0) {
      mostrarFeedback('Adicione pelo menos um exame antes de finalizar.', 'warning');
      return;
    }

    const btn = document.getElementById('btn-finalizar-exames');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Salvando...';

    const obsGerais = document.getElementById('observacoes-exames')?.value || '';

    const resp = await fetchOrQueue(`/animal/{{ animal.id }}/bloco_exames`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({
        exames: exames,
        observacoes_gerais: obsGerais
      })
    });
    if (resp) {
      const data = await resp.json();
      if (data.success) {
        mostrarFeedback('Solicita√ß√£o de exames salva com sucesso!');
        if (data.html) {
          const container = document.getElementById('historico-exames');
          container.innerHTML = data.html;
          if (typeof bindSyncForms === 'function') {
            bindSyncForms(container);
          }
        }
        exames = [];
        renderExamesTemp();
      } else {
        mostrarFeedback('Erro ao salvar exames.', 'danger');
      }
    } else {
      // Offline: mant√©m exames na fila sem mostrar notifica√ß√£o
      exames = [];
      renderExamesTemp();
    }

    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }
</script>

