<!-- Bot√µes de A√ß√£o -->
<div class="d-flex gap-2 mb-3">
  <button class="btn btn-outline-primary" type="button" onclick="toggleFormTipoRacao()">‚ûï Nova Ra√ß√£o (Cadastro Geral)</button>
  <button class="btn btn-outline-success" type="button" onclick="toggleFormRacaoAnimal()">üì¶ Atribuir Ra√ß√£o ao Animal</button>
</div>

<!-- Formul√°rio de Cadastro de Novo Tipo de Ra√ß√£o -->
<div id="form-tipo-racao-container" style="display: none;">
  <form id="form-tipo-racao" class="border rounded p-3 mb-4 bg-light">
    <h6 class="text-primary">Cadastrar nova ra√ß√£o no sistema</h6>

    <div class="mb-2">
      <label for="buscar-racao-nova" class="form-label">Buscar ra√ß√£o existente</label>
      <input type="text" id="buscar-racao-nova" class="form-control" placeholder="Digite para buscar..." autocomplete="off">
      <ul id="sugestoes-busca-racao" class="list-group position-absolute" style="z-index: 1000;"></ul>
    </div>

    <!-- Marca com autocomplete -->
    <div class="mb-2">
      <label for="marca" class="form-label">Marca</label>
      <input type="text" class="form-control" id="marca" list="lista-marcas" required>
      <datalist id="lista-marcas">
        {% for marca in marcas_existentes %}
          <option value="{{ marca }}">
        {% endfor %}
      </datalist>
    </div>

    <!-- Linha com autocomplete -->
    <div class="mb-2">
      <label for="linha" class="form-label">Linha / F√≥rmula</label>
      <input type="text" class="form-control" id="linha" placeholder="Ex: Premium Filhotes" list="lista-linhas">
      <datalist id="lista-linhas">
        {% for linha in linhas_existentes %}
          <option value="{{ linha }}">
        {% endfor %}
      </datalist>
    </div>

    <!-- Recomenda√ß√£o padr√£o -->
    <div class="mb-2">
      <label for="recomendacao" class="form-label">Recomenda√ß√£o padr√£o (g/kg/dia)</label>
      <input type="number" step="0.1" class="form-control" id="recomendacao">
    </div>

    <!-- Peso padr√£o do pacote -->
    <div class="mb-2">
      <label for="peso_pacote_kg" class="form-label">Peso do pacote padr√£o (kg)</label>
      <input type="number" step="0.1" class="form-control" id="peso_pacote_kg" value="15">
    </div>

    <!-- Observa√ß√µes -->
    <div class="mb-2">
      <label for="obs_tipo_racao" class="form-label">Observa√ß√µes</label>
      <textarea class="form-control" id="obs_tipo_racao" rows="2"></textarea>
    </div>

    <!-- Bot√µes de a√ß√£o -->
    <button type="button" id="btn-salvar-tipo-racao" class="btn btn-primary me-2" onclick="salvarTipoRacao()">üíæ Salvar Tipo de Ra√ß√£o</button>
    <button type="button" id="btn-excluir-tipo-racao" class="btn btn-outline-danger d-none" onclick="excluirTipoRacao()">üóëÔ∏è Excluir</button>
  </form>
</div>


<!-- Formul√°rio de Atribui√ß√£o ao Animal -->
<div id="form-racao-animal-container" style="display: none;">
  <form id="form-racao-animal" class="border rounded p-3 mb-4 bg-light">
    <h6 class="text-success">Atribuir ra√ß√£o ao animal <strong>{{ animal.name }}</strong></h6>

    <div class="mb-2">
      <label for="tipo_racao_id" class="form-label">Escolha a ra√ß√£o</label>
      <select id="tipo_racao_id" class="form-select" required>
        <option value="">-- Selecione --</option>
        {% for tipo in tipos_racao %}
          <option value="{{ tipo.id }}" data-recomendacao="{{ tipo.recomendacao or '' }}">
            {{ tipo.marca }} - {{ tipo.linha or '' }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-2">
      <label class="form-label">Recomenda√ß√£o autom√°tica (baseada em {{ animal.peso }} kg)</label>
      <div class="input-group">
        <input type="text" class="form-control" id="recomendacao_calculada" disabled>
        <span class="input-group-text">g/dia</span>
      </div>
    </div>

    <div class="mb-2">
      <label for="recomendacao_custom" class="form-label">Recomenda√ß√£o personalizada (g/dia)</label>
      <input type="number" step="0.1" class="form-control" id="recomendacao_custom"
             placeholder="Deixe em branco para usar o valor autom√°tico">
    </div>

    <div class="mb-2">
      <label for="preco_pago" class="form-label">Pre√ßo pago (R$)</label>
      <input type="number" step="0.01" class="form-control" id="preco_pago" placeholder="Ex: 89.90">
    </div>

    <!-- Removido o campo de tamanho da embalagem -->

    <div class="mb-2">
      <label for="observacoes_racao" class="form-label">Observa√ß√µes</label>
      <textarea class="form-control" id="observacoes_racao" rows="2" placeholder="Ex: dividir em 2 por√ß√µes"></textarea>
    </div>

    <button type="button" class="btn btn-success" onclick="salvarRacaoAnimal()">‚úÖ Registrar Ra√ß√£o</button>
  </form>
</div>





<!-- Modal para editar Ra√ß√£o -->
<div class="modal fade" id="modalEditarRacao" tabindex="-1" aria-labelledby="editarRacaoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title" id="editarRacaoLabel">‚úèÔ∏è Editar Ra√ß√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="formEditarRacao">
          <input type="hidden" id="edit-racao-id">
          <div class="mb-2">
            <label for="edit-observacoes" class="form-label">Observa√ß√µes</label>
            <textarea id="edit-observacoes" class="form-control"></textarea>
          </div>
          <div class="mb-2">
            <label for="edit-recomendacao" class="form-label">Recomenda√ß√£o (g/dia)</label>
            <input type="number" step="0.1" id="edit-recomendacao" class="form-control">
          </div>
          <div class="mb-2">
            <label for="edit-preco" class="form-label">Pre√ßo pago (R$)</label>
            <input type="number" step="0.01" id="edit-preco" class="form-control">
          </div>
          <div class="mb-2">
            <label for="edit-tamanho" class="form-label">Tamanho da embalagem (kg)</label>
            <input type="number" step="0.1" id="edit-tamanho" class="form-control">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarEdicaoRacao()">Salvar</button>
      </div>
    </div>
  </div>
</div>




<!-- Hist√≥rico de Ra√ß√µes -->
<hr class="my-4">
<h5>üìã Hist√≥rico de Ra√ß√µes</h5>
{% if animal.racoes %}
  <ul class="list-group">
    {% for racao in animal.racoes %}
      <li class="list-group-item">
        <strong>Marca:</strong> {{ racao.tipo_racao.marca }}<br>
        <strong>Linha:</strong> {{ racao.tipo_racao.linha or 'N√£o informada' }}<br>

        <strong>Recomenda√ß√£o:</strong>
        {% if racao.recomendacao_custom %}
          {{ racao.recomendacao_custom }} g/dia<br>
        {% elif animal.peso and racao.tipo_racao.recomendacao %}
          {{ (animal.peso * racao.tipo_racao.recomendacao)|round(1) }} g/dia<br>
        {% else %}
          N√£o informado<br>
        {% endif %}

        <strong>Pre√ßo pago:</strong> R$ {{ racao.preco_pago or 'N√£o informado' }}<br>

        <strong>Peso do pacote:</strong>
        {{ racao.tipo_racao.peso_pacote_kg or 'N√£o informado' }} kg<br>

        <strong>Observa√ß√µes:</strong>
        {{ racao.observacoes_racao or racao.tipo_racao.observacoes or 'Nenhuma' }}<br>

        <small class="text-muted">Registrado em {{ racao.data_cadastro|format_datetime_brazil('%d/%m/%Y') }}</small>

        <div class="mt-2">
          <button
            type="button"
            class="btn btn-sm btn-outline-primary me-2"
            onclick="editarRacao({{ racao.id }})"
          >
            ‚úèÔ∏è Editar
          </button>
          <button
            type="button"
            class="btn btn-sm btn-outline-danger"
            onclick="excluirRacao({{ racao.id }})"
          >
            üóëÔ∏è Excluir
          </button>
        </div>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="text-muted">Nenhuma ra√ß√£o cadastrada ainda para este animal.</p>
{% endif %}


<!-- Scripts JS -->
<script>
let tipoRacaoSelecionada = null;
let modalEditarRacaoInstancia = null;
const buscaRacaoInput = document.getElementById('buscar-racao-nova');
const sugestoesBuscaRacao = document.getElementById('sugestoes-busca-racao');

function obterModalEditarRacao() {
  if (!modalEditarRacaoInstancia) {
    modalEditarRacaoInstancia = new bootstrap.Modal(document.getElementById('modalEditarRacao'));
  }
  return modalEditarRacaoInstancia;
}

function toggleFormTipoRacao() {
  const container = document.getElementById('form-tipo-racao-container');
  container.style.display = container.style.display === 'none' ? 'block' : 'none';
  if (container.style.display === 'block') {
    tipoRacaoSelecionada = null;
    document.getElementById('btn-excluir-tipo-racao').classList.add('d-none');
    document.getElementById('form-tipo-racao').reset();
    buscaRacaoInput.value = '';
    sugestoesBuscaRacao.innerHTML = '';
    sugestoesBuscaRacao.style.display = 'none';
  }
}

buscaRacaoInput.addEventListener('input', () => {
  const q = buscaRacaoInput.value.trim();
  if (q.length < 2) {
    sugestoesBuscaRacao.innerHTML = '';
    sugestoesBuscaRacao.style.display = 'none';
    return;
  }

  fetch(`/buscar_racoes?q=${encodeURIComponent(q)}`)
    .then(resp => resp.json())
    .then(data => {
      sugestoesBuscaRacao.innerHTML = '';
      if (!data.length) {
        sugestoesBuscaRacao.innerHTML = '<li class="list-group-item text-muted">Nenhuma ra√ß√£o encontrada</li>';
      } else {
        data.forEach(item => {
          const li = document.createElement('li');
          li.className = 'list-group-item list-group-item-action';
          li.textContent = item.marca + (item.linha ? ' - ' + item.linha : '');
          li.onclick = () => {
            tipoRacaoSelecionada = item;
            document.getElementById('marca').value = item.marca;
            document.getElementById('linha').value = item.linha || '';
            document.getElementById('recomendacao').value = item.recomendacao || '';
            document.getElementById('peso_pacote_kg').value = item.peso_pacote_kg || 15;
            document.getElementById('obs_tipo_racao').value = item.observacoes || '';
            document.getElementById('btn-excluir-tipo-racao').classList.remove('d-none');
            sugestoesBuscaRacao.innerHTML = '';
            sugestoesBuscaRacao.style.display = 'none';
          };
          sugestoesBuscaRacao.appendChild(li);
        });
      }
      sugestoesBuscaRacao.style.display = 'block';
    })
    .catch(() => {
      sugestoesBuscaRacao.innerHTML = '<li class="list-group-item text-danger">Erro ao buscar</li>';
      sugestoesBuscaRacao.style.display = 'block';
    });
});

document.addEventListener('click', (e) => {
  if (!sugestoesBuscaRacao.contains(e.target) && e.target !== buscaRacaoInput) {
    sugestoesBuscaRacao.innerHTML = '';
    sugestoesBuscaRacao.style.display = 'none';
  }
});

function toggleFormRacaoAnimal() {
  const container = document.getElementById('form-racao-animal-container');
  container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

function atualizarListaTiposRacao() {
  fetch('/api/tipos_racao')
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        const select = document.getElementById('tipo_racao_id');
        const opcaoAtual = select.value;
        select.innerHTML = '<option value="">-- Selecione uma ra√ß√£o --</option>';
        data.tipos.forEach(tipo => {
          const option = document.createElement('option');
          option.value = tipo.id;
          option.textContent = `${tipo.marca}${tipo.linha ? ' ‚Äî ' + tipo.linha : ''}`;
          select.appendChild(option);
        });
        if (opcaoAtual) select.value = opcaoAtual;
      }
    })
    .catch(err => console.error('Erro ao atualizar lista:', err));
}

function salvarTipoRacao() {
  const payload = {
    marca: document.getElementById('marca').value,
    linha: document.getElementById('linha').value,
    recomendacao: parseFloat(document.getElementById('recomendacao').value) || null,
    peso_pacote_kg: parseFloat(document.getElementById('peso_pacote_kg').value) || 15,
    observacoes: document.getElementById('obs_tipo_racao').value
  };

  const url = tipoRacaoSelecionada ? `/tipo_racao/${tipoRacaoSelecionada.id}` : '/tipo_racao';
  const method = tipoRacaoSelecionada ? 'PUT' : 'POST';

  fetch(url, {
    method: method,
    headers: { 
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify(payload)
  })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        alert(tipoRacaoSelecionada ? 'Tipo de ra√ß√£o atualizado!' : 'Tipo de ra√ß√£o cadastrado com sucesso!');
        // Atualizar lista dinamicamente
        atualizarListaTiposRacao();
        // Limpar formul√°rio
        document.getElementById('marca').value = '';
        document.getElementById('linha').value = '';
        document.getElementById('recomendacao').value = '';
        document.getElementById('peso_pacote_kg').value = '15';
        document.getElementById('obs_tipo_racao').value = '';
        tipoRacaoSelecionada = null;
        // Fechar formul√°rio
        document.getElementById('form-tipo-racao-container').style.display = 'none';
      } else {
        alert('Erro: ' + (data.error || 'Falha ao salvar'));
      }
    })
    .catch(error => {
      alert('Erro t√©cnico ao salvar tipo de ra√ß√£o.');
      console.error('Erro:', error);
    });
}

function excluirTipoRacao() {
  if (!tipoRacaoSelecionada || !confirm('Tem certeza que deseja excluir esta ra√ß√£o?')) return;
  fetch(`/tipo_racao/${tipoRacaoSelecionada.id}`, { 
    method: 'DELETE',
    headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
  })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        alert('Ra√ß√£o exclu√≠da.');
        location.reload();
      } else {
        alert(data.error || 'Erro ao excluir ra√ß√£o.');
      }
    });
}


function salvarRacaoAnimal() {
  const animalId = {{ animal.id }};
  const payload = {
    tipo_racao_id: parseInt(document.getElementById('tipo_racao_id').value),
    recomendacao_custom: parseFloat(document.getElementById('recomendacao_custom').value) || null,
    observacoes_racao: document.getElementById('observacoes_racao').value,
    preco_pago: parseFloat(document.getElementById('preco_pago').value) || null
    // Removido: tamanho_embalagem
  };

  fetch(`/animal/${animalId}/racoes`, {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify(payload)
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      alert('Ra√ß√£o registrada para o animal!');
      location.reload();
    } else {
      alert('Erro: ' + (data.error || 'Falha ao salvar'));
    }
  })
  .catch(error => {
    alert('Erro t√©cnico ao salvar ra√ß√£o.');
    console.error('Erro:', error);
  });
}







function preencherModalRacao(racao) {
  document.getElementById('edit-observacoes').value = racao.observacoes_racao || '';
  document.getElementById('edit-recomendacao').value = racao.recomendacao_custom || '';
  document.getElementById('edit-preco').value = racao.preco_pago || '';
  document.getElementById('edit-tamanho').value = racao.tamanho_embalagem || '';
}

function editarRacao(racaoId) {
  document.getElementById('edit-racao-id').value = racaoId;

  fetch(`/racao/${racaoId}`)
    .then(resp => resp.json())
    .then(data => {
      if (!data.success) {
        alert(data.error || 'N√£o foi poss√≠vel carregar as informa√ß√µes da ra√ß√£o.');
        return;
      }

      preencherModalRacao(data.racao || {});
      obterModalEditarRacao().show();
    })
    .catch(() => {
      alert('Erro ao buscar dados da ra√ß√£o.');
    });
}

function confirmarEdicaoRacao() {
  const racaoId = document.getElementById('edit-racao-id').value;
  const observacoes = document.getElementById('edit-observacoes').value;
  const recomendacao = parseFloat(document.getElementById('edit-recomendacao').value) || null;
  const preco = parseFloat(document.getElementById('edit-preco').value) || null;

  fetch(`/racao/${racaoId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      observacoes_racao: observacoes,
      recomendacao_custom: recomendacao,
      preco_pago: preco
      // Removido: tamanho_embalagem
    })
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      alert('Ra√ß√£o atualizada!');
      location.reload();
    } else {
      alert(data.error || 'Erro ao editar ra√ß√£o.');
    }
  });
}




function excluirRacao(racaoId) {
  if (!confirm('Tem certeza que deseja excluir esta ra√ß√£o?')) return;

  fetch(`/racao/${racaoId}`, {
    method: 'DELETE'
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      alert('Ra√ß√£o removida!');
      location.reload();
    } else {
      alert(data.error || 'Erro ao excluir ra√ß√£o.');
    }
  });
}



// C√°lculo autom√°tico de recomenda√ß√£o (g/dia) ao selecionar a ra√ß√£o
document.getElementById('tipo_racao_id').addEventListener('change', function () {
  const pesoAnimal = {{ animal.peso or 'null' }};
  const select = this;
  const selectedOption = select.options[select.selectedIndex];
  const recomendacaoPorKg = parseFloat(selectedOption.getAttribute('data-recomendacao'));

  if (pesoAnimal && recomendacaoPorKg) {
    const total = pesoAnimal * recomendacaoPorKg;
    document.getElementById('recomendacao_calculada').value = total.toFixed(1);
  } else {
    document.getElementById('recomendacao_calculada').value = '';
  }
});

</script>
