<!-- Bot√µes de A√ß√£o -->
<div class="d-flex gap-2 mb-3">
  <button class="btn btn-outline-primary" type="button" onclick="toggleFormTipoRacao()">‚ûï Nova Ra√ß√£o (Cadastro Geral)</button>
  <button class="btn btn-outline-success" type="button" onclick="toggleFormRacaoAnimal()">üì¶ Atribuir Ra√ß√£o ao Animal</button>
</div>

<!-- Formul√°rio de Cadastro de Novo Tipo de Ra√ß√£o -->
<div id="form-tipo-racao-container" style="display: none;">
  <form id="form-tipo-racao" class="border rounded p-3 mb-4 bg-light">
    <h6 class="text-primary">Cadastrar nova ra√ß√£o no sistema</h6>

    <!-- Marca com autocomplete -->
    <div class="mb-2">
      <label for="marca" class="form-label">Marca</label>
      <input type="text" class="form-control" id="marca" list="lista-marcas" required>
      <datalist id="lista-marcas">
        {% for marca in marcas_existentes %}
          <option value="{{ marca }}">
        {% endfor %}
      </datalist>
    </div>

    <!-- Linha com autocomplete -->
    <div class="mb-2">
      <label for="linha" class="form-label">Linha / F√≥rmula</label>
      <input type="text" class="form-control" id="linha" placeholder="Ex: Premium Filhotes" list="lista-linhas">
      <datalist id="lista-linhas">
        {% for linha in linhas_existentes %}
          <option value="{{ linha }}">
        {% endfor %}
      </datalist>
    </div>

    <!-- Recomenda√ß√£o padr√£o -->
    <div class="mb-2">
      <label for="recomendacao" class="form-label">Recomenda√ß√£o padr√£o (g/kg/dia)</label>
      <input type="number" step="0.1" class="form-control" id="recomendacao">
    </div>

    <!-- Observa√ß√µes -->
    <div class="mb-2">
      <label for="obs_tipo_racao" class="form-label">Observa√ß√µes</label>
      <textarea class="form-control" id="obs_tipo_racao" rows="2"></textarea>
    </div>

    <!-- Bot√£o de envio -->
    <button type="button" class="btn btn-primary" onclick="salvarTipoRacao()">üíæ Salvar Tipo de Ra√ß√£o</button>
  </form>
</div>


<!-- Formul√°rio de Atribui√ß√£o ao Animal -->
<div id="form-racao-animal-container" style="display: none;">
  <form id="form-racao-animal" class="border rounded p-3 mb-4 bg-light">
    <h6 class="text-success">Atribuir ra√ß√£o ao animal <strong>{{ animal.name }}</strong></h6>

    <div class="mb-2">
      <label for="tipo_racao_id" class="form-label">Escolha a ra√ß√£o</label>
      <select id="tipo_racao_id" class="form-select" required>
        <option value="">-- Selecione --</option>
        {% for tipo in tipos_racao %}
          <option value="{{ tipo.id }}" data-recomendacao="{{ tipo.recomendacao or '' }}">
            {{ tipo.marca }} - {{ tipo.linha or '' }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-2">
      <label class="form-label">Recomenda√ß√£o autom√°tica (baseada em {{ animal.peso }} kg)</label>
      <div class="input-group">
        <input type="text" class="form-control" id="recomendacao_calculada" disabled>
        <span class="input-group-text">g/dia</span>
      </div>
    </div>

    <div class="mb-2">
      <label for="recomendacao_custom" class="form-label">Recomenda√ß√£o personalizada (g/dia)</label>
      <input type="number" step="0.1" class="form-control" id="recomendacao_custom"
             placeholder="Deixe em branco para usar o valor autom√°tico">
    </div>

    <div class="mb-2">
      <label for="observacoes_racao" class="form-label">Observa√ß√µes</label>
      <textarea class="form-control" id="observacoes_racao" rows="2" placeholder="Ex: dividir em 2 por√ß√µes"></textarea>
    </div>

    <button type="button" class="btn btn-success" onclick="salvarRacaoAnimal()">‚úÖ Registrar Ra√ß√£o</button>
  </form>
</div>

<!-- Hist√≥rico de Ra√ß√µes -->
<hr class="my-4">
<h5>üìã Hist√≥rico de Ra√ß√µes</h5>
{% if animal.racoes %}
  <ul class="list-group">
    {% for racao in animal.racoes %}
      <li class="list-group-item">
        <strong>Marca:</strong> {{ racao.tipo_racao.marca }}<br>
        <strong>Linha:</strong> {{ racao.tipo_racao.linha or 'N√£o informada' }}<br>
        <strong>Recomenda√ß√£o:</strong>
        {{ racao.recomendacao_custom or (animal.peso * racao.tipo_racao.recomendacao)|round(1) }} g/dia<br>
        <strong>Observa√ß√µes:</strong>
        {{ racao.observacoes_racao or racao.tipo_racao.observacoes or 'Nenhuma' }}<br>
        <small class="text-muted">Registrado em {{ racao.data_cadastro.strftime('%d/%m/%Y') }}</small>

        <div class="mt-2">
          <button class="btn btn-sm btn-outline-primary me-2" onclick="editarRacao({{ racao.id }})">‚úèÔ∏è Editar</button>
          <button class="btn btn-sm btn-outline-danger" onclick="excluirRacao({{ racao.id }})">üóëÔ∏è Excluir</button>
        </div>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="text-muted">Nenhuma ra√ß√£o cadastrada ainda para este animal.</p>
{% endif %}

<!-- Scripts JS -->
<script>
function toggleFormTipoRacao() {
  const container = document.getElementById('form-tipo-racao-container');
  container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

function toggleFormRacaoAnimal() {
  const container = document.getElementById('form-racao-animal-container');
  container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

function salvarTipoRacao() {
  const payload = {
    marca: document.getElementById('marca').value,
    linha: document.getElementById('linha').value,
    recomendacao: parseFloat(document.getElementById('recomendacao').value) || null,
    observacoes: document.getElementById('obs_tipo_racao').value
  };

  fetch('/tipo_racao', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      alert('Tipo de ra√ß√£o cadastrado com sucesso!');
      location.reload();
    } else {
      alert('Erro: ' + (data.error || 'Falha ao cadastrar'));
    }
  })
  .catch(error => {
    alert('Erro t√©cnico ao salvar tipo de ra√ß√£o.');
    console.error(error);
  });
}

function salvarRacaoAnimal() {
  const animalId = {{ animal.id }};
  const payload = {
    tipo_racao_id: parseInt(document.getElementById('tipo_racao_id').value),
    recomendacao_custom: parseFloat(document.getElementById('recomendacao_custom').value) || null,
    observacoes_racao: document.getElementById('observacoes_racao').value
  };

  fetch(`/animal/${animalId}/racoes`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      alert('Ra√ß√£o registrada para o animal!');
      location.reload();
    } else {
      alert('Erro: ' + (data.error || 'Falha ao salvar'));
    }
  })
  .catch(error => {
    alert('Erro t√©cnico ao salvar ra√ß√£o.');
    console.error(error);
  });
}

document.getElementById('tipo_racao_id').addEventListener('change', function () {
  const selected = this.options[this.selectedIndex];
  const recomendacaoKg = parseFloat(selected.dataset.recomendacao);
  const pesoAnimal = {{ animal.peso or 0 }};
  const recomendacaoCalculada = recomendacaoKg ? (recomendacaoKg * pesoAnimal).toFixed(1) : '';
  document.getElementById('recomendacao_calculada').value = recomendacaoCalculada;
});








function editarRacao(racaoId) {
  const novaObs = prompt("Digite as novas observa√ß√µes:");
  const novaRecomendacao = prompt("Digite a nova recomenda√ß√£o (g/dia), ou deixe em branco:");

  if (novaObs === null && novaRecomendacao === null) return; // Cancelado

  fetch(`/racao/${racaoId}/editar`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      recomendacao_custom: novaRecomendacao ? parseFloat(novaRecomendacao) : null,
      observacoes_racao: novaObs || ''
    })
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      alert('Ra√ß√£o atualizada!');
      location.reload();
    } else {
      alert(data.error || 'Erro ao editar ra√ß√£o.');
    }
  });
}

function excluirRacao(racaoId) {
  if (!confirm('Tem certeza que deseja excluir esta ra√ß√£o?')) return;

  fetch(`/racao/${racaoId}/excluir`, {
    method: 'DELETE'
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success) {
      alert('Ra√ß√£o removida!');
      location.reload();
    } else {
      alert(data.error || 'Erro ao excluir ra√ß√£o.');
    }
  });
}
</script>
