{% if animal.blocos_prescricao %}
<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title">üìú Hist√≥rico de Prescri√ß√µes</h5>

    {% for bloco in animal.blocos_prescricao|reverse %}
    <div class="border rounded p-3 mb-3" id="bloco-prescricao-{{ bloco.id }}">
      <h6 class="text-muted">Prescri√ß√£o feita em {{ bloco.data_criacao|format_datetime_brazil('%d/%m/%Y %H:%M') }}</h6>

      <ul class="list-group list-group-flush mb-2">
        {% for item in bloco.prescricoes %}
        <li class="list-group-item">
          <strong>{{ item.medicamento }}</strong> ‚Äî
          {% if item.dosagem or item.frequencia or item.duracao %}
            {{ item.dosagem or '‚Äì' }}, {{ item.frequencia or '‚Äì' }}, por {{ item.duracao or '‚Äì' }}
            {% if item.observacoes %}
              <br><em>Obs:</em> {{ item.observacoes }}
            {% endif %}
          {% else %}
            <em>{{ item.observacoes or '‚Äì' }}</em>
          {% endif %}
        </li>
        {% endfor %}
      </ul>

      <!-- Bot√µes de a√ß√£o -->
      <div class="d-flex flex-wrap gap-2">
        <form method="POST"
              action="{{ url_for('deletar_bloco_prescricao', bloco_id=bloco.id) }}"
              class="d-inline"
              data-sync="true" data-no-reload="true" data-remove-target="#bloco-prescricao-{{ bloco.id }}"
              onsubmit="return confirm('Deseja mesmo excluir este bloco de prescri√ß√µes?');">
          <button class="btn btn-danger btn-sm">üóë Excluir</button>
        </form>

        <a href="{{ url_for('imprimir_bloco_prescricao', bloco_id=bloco.id) }}"
           class="btn btn-outline-secondary btn-sm" target="_blank">
          üñ® Imprimir
        </a>

        <a href="{{ url_for('editar_bloco_prescricao', bloco_id=bloco.id) }}"
           class="btn btn-outline-primary btn-sm">
          ‚úèÔ∏è Editar
        </a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% else %}
<p class="text-muted">Nenhuma prescri√ß√£o registrada ainda para esta consulta.</p>
{% endif %}

<script>
const PRESC_KEY = 'pending_prescricoes_{{ animal.id }}';

function loadPendingPrescricoes(){
  try { return JSON.parse(localStorage.getItem(PRESC_KEY)) || []; } catch(e){ return []; }
}

function renderPendingPrescricoes(){
  const pend = loadPendingPrescricoes();
  if(!pend.length) return;
  const container = document.querySelector('#historico-prescricoes .card-body');
  if(!container) return;
  pend.forEach(b => {
    const div = document.createElement('div');
    div.className = 'border rounded p-3 mb-3 text-muted';
    let items = '<ul class="list-group list-group-flush mb-2">';
    b.prescricoes.forEach(p => {
      items += `<li class="list-group-item"><strong>${p.medicamento}</strong></li>`;
    });
    items += '</ul>';
    div.innerHTML = `<h6 class="text-muted">Prescri√ß√£o pendente</h6>${items}<span class="badge bg-secondary">Pendente</span>`;
    container.prepend(div);
  });
}

document.addEventListener('DOMContentLoaded', renderPendingPrescricoes);

document.addEventListener('queueSynced', async () => {
  const resp = await fetch(`/consulta/{{ consulta.id }}/historico_prescricoes`);
  if(resp.ok){
    const html = await resp.text();
    document.getElementById('historico-prescricoes').innerHTML = html;
  }
  localStorage.removeItem(PRESC_KEY);
});
</script>
