{% if animal.vacinas %}
<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title">üíâ Hist√≥rico de Vacinas</h5>

    <ul class="list-group list-group-flush mb-2">
      {% for vacina in animal.vacinas_ordenadas %}
      <li class="list-group-item" data-vacina-id="{{ vacina.id }}">
        <div class="vacina-info">
          <strong class="vacina-nome">{{ vacina.nome }}</strong>
          {% if vacina.tipo %} ‚Äî <span class="vacina-tipo">{{ vacina.tipo }}</span>{% endif %}
          {% if vacina.fabricante %} ‚Äî <span class="vacina-fabricante">{{ vacina.fabricante }}</span>{% endif %}
          {% if vacina.data %}
            em <span class="vacina-data" data-date="{{ vacina.data.strftime('%Y-%m-%d') }}">
              {{ vacina.data.strftime('%d/%m/%Y') }}
            </span>
          {% endif %}
          {% if vacina.proxima_dose %}
            <br><small>Pr√≥xima dose: <span class="vacina-proxima" data-date="{{ vacina.proxima_dose.strftime('%Y-%m-%d') }}">{{ vacina.proxima_dose.strftime('%d/%m/%Y') }}</span></small>
          {% endif %}
          {% if vacina.frequencia or vacina.doses_totais or vacina.intervalo_dias %}
            <br><small>
              {% if vacina.frequencia %}<span class="vacina-frequencia">{{ vacina.frequencia }}</span>{% endif %}
              {% if vacina.doses_totais %}<span class="vacina-doses">Doses: {{ vacina.doses_totais }}</span>{% endif %}
              {% if vacina.intervalo_dias %}<span class="vacina-intervalo">Intervalo: {{ vacina.intervalo_dias }} dias</span>{% endif %}
            </small>
          {% endif %}
          {% if vacina.observacoes %}
            <br><em class="vacina-obs">{{ vacina.observacoes }}</em>
          {% endif %}
        </div>

      <div class="mt-2 d-flex gap-2">
        <button class="btn btn-sm btn-danger" onclick="excluirVacina({{ vacina.id }})">üóëÔ∏è Remover</button>
        <button class="btn btn-sm btn-outline-primary" onclick="editarVacina({{ vacina.id }})">‚úèÔ∏è Editar</button>
        <a href="{{ url_for('imprimir_vacinas', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark" target="_blank">üñ®Ô∏è Imprimir</a>
      </div>
      </li>
      {% endfor %}
    </ul>
  </div>
</div>
{% else %}
<p class="text-muted">Nenhuma vacina registrada ainda para este animal.</p>
{% endif %}

<script>
function editarVacina(id) {
  const li = document.querySelector(`[data-vacina-id='${id}']`);
  const nome = li.querySelector('.vacina-nome')?.textContent.trim() || '';
  const tipo = li.querySelector('.vacina-tipo')?.textContent.trim() || '';
  const data = li.querySelector('.vacina-data')?.dataset.date || '';
  const obs = li.querySelector('.vacina-obs')?.textContent.trim() || '';
  const fabricante = li.querySelector('.vacina-fabricante')?.textContent.trim() || '';
  const frequencia = li.querySelector('.vacina-frequencia')?.textContent.trim() || '';
  const doses = li.querySelector('.vacina-doses')?.textContent.replace('Doses:','').trim() || '';
  const intervalo = li.querySelector('.vacina-intervalo')?.textContent.replace('Intervalo:','').replace(' dias','').trim() || '';
  const proxima = li.querySelector('.vacina-proxima')?.dataset.date || '';

  li.innerHTML = `
    <div class="mb-2">
      <label class="form-label">Nome</label>
      <input class="form-control" id="edit-nome-${id}" value="${nome}">
    </div>
    <div class="mb-2">
      <label class="form-label">Tipo</label>
      <input class="form-control" id="edit-tipo-${id}" value="${tipo}">
    </div>
    <div class="mb-2">
      <label class="form-label">Data</label>
      <input type="date" class="form-control" id="edit-data-${id}" value="${data}">
    </div>
    <div class="mb-2">
      <label class="form-label">Fabricante</label>
      <input class="form-control" id="edit-fabricante-${id}" value="${fabricante}">
    </div>
    <div class="mb-2">
      <label class="form-label">Frequ√™ncia</label>
      <input class="form-control" id="edit-frequencia-${id}" value="${frequencia}">
    </div>
    <div class="row">
      <div class="col mb-2">
        <label class="form-label">Doses Totais</label>
        <input type="number" class="form-control" id="edit-doses-${id}" value="${doses}">
      </div>
      <div class="col mb-2">
        <label class="form-label">Intervalo (dias)</label>
        <input type="number" class="form-control" id="edit-intervalo-${id}" value="${intervalo}">
      </div>
    </div>
    <div class="mb-2">
      <label class="form-label">Pr√≥xima dose</label>
      <input type="date" class="form-control" id="edit-proxima-${id}" value="${proxima}">
    </div>
    <div class="mb-2">
      <label class="form-label">Observa√ß√µes</label>
      <textarea class="form-control" id="edit-obs-${id}">${obs}</textarea>
    </div>
    <button class="btn btn-sm btn-success" onclick="salvarEdicaoVacina(${id})">üíæ Salvar</button>
    <button class="btn btn-sm btn-secondary" onclick="location.reload()">Cancelar</button>
  `;
}

function salvarEdicaoVacina(id) {
  const nome = document.getElementById(`edit-nome-${id}`).value.trim();
  const tipo = document.getElementById(`edit-tipo-${id}`).value.trim();
  const data = document.getElementById(`edit-data-${id}`).value.trim();
  const observacoes = document.getElementById(`edit-obs-${id}`).value.trim();
  const fabricante = document.getElementById(`edit-fabricante-${id}`).value.trim();
  const frequencia = document.getElementById(`edit-frequencia-${id}`).value.trim();
  const doses_totais = parseInt(document.getElementById(`edit-doses-${id}`).value) || null;
  const intervalo_dias = parseInt(document.getElementById(`edit-intervalo-${id}`).value) || null;
  const proxima_dose = document.getElementById(`edit-proxima-${id}`).value.trim();

  fetch(`/vacina/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ nome, tipo, data, observacoes, fabricante, frequencia, doses_totais, intervalo_dias, proxima_dose })
  })
  .then(res => res.json())
  .then(d => {
    if (d.success) {
      alert('Vacina atualizada!');
      location.reload();
    } else {
      alert('Erro ao salvar.');
    }
  })
  .catch(err => {
    console.error('Erro:', err);
    alert('Erro na requisi√ß√£o.');
  });
}

function excluirVacina(id) {
  if (!confirm('Deseja mesmo remover esta vacina?')) return;
  fetch(`/vacina/${id}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(d => {
      if (d.success) {
        const li = document.querySelector(`[data-vacina-id='${id}']`);
        li?.remove();
      } else {
        alert(d.error || 'Erro ao excluir vacina.');
      }
    })
    .catch(err => {
      console.error('Erro ao excluir vacina:', err);
      alert('Erro ao excluir vacina.');
    });
}
</script>
