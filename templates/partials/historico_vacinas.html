{% if animal.vacinas %}
<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title">💉 Histórico de Vacinas</h5>

    <ul class="list-group list-group-flush mb-2">
      {% for vacina in animal.vacinas_ordenadas %}
      <li class="list-group-item" data-vacina-id="{{ vacina.id }}"
          data-nome="{{ vacina.nome }}" data-tipo="{{ vacina.tipo or '' }}"
          data-fabricante="{{ vacina.fabricante or '' }}" data-doses="{{ vacina.doses_totais or '' }}"
          data-intervalo="{{ vacina.intervalo_dias or '' }}" data-frequencia="{{ vacina.frequencia or '' }}"
          data-aplicada="{{ '1' if vacina.aplicada else '0' }}"
          data-aplicada_em="{% if vacina.aplicada_em %}{{ vacina.aplicada_em.strftime('%Y-%m-%d') }}{% endif %}"
          data-obs="{{ vacina.observacoes or '' }}">
        <div class="vacina-info">
          <strong class="vacina-nome">{{ vacina.nome }}</strong>
          {% if vacina.tipo %} — <span class="vacina-tipo">{{ vacina.tipo }}</span>{% endif %}
          {% if vacina.fabricante %} — <span class="vacina-fabricante">{{ vacina.fabricante }}</span>{% endif %}
          {% if vacina.doses_totais %} — <span class="vacina-doses">{{ vacina.doses_totais }} doses</span>{% endif %}
          {% if vacina.intervalo_dias %} — <span class="vacina-intervalo">{{ vacina.intervalo_dias }} dias</span>{% endif %}
          {% if vacina.frequencia %} — <span class="vacina-frequencia">{{ vacina.frequencia }}</span>{% endif %}
          {% if vacina.aplicada %}
            em <span class="vacina-data" data-date="{{ vacina.aplicada_em.strftime('%Y-%m-%d') if vacina.aplicada_em else '' }}">
              {{ vacina.aplicada_em.strftime('%d/%m/%Y') if vacina.aplicada_em else '' }}
            </span>
          {% else %}
            <span class="text-muted">Não aplicada</span>
          {% endif %}
          {% if vacina.observacoes %}
            <br><em class="vacina-obs">{{ vacina.observacoes }}</em>
          {% endif %}
        </div>

      <div class="mt-2 d-flex gap-2">
        <button class="btn btn-sm btn-danger" onclick="excluirVacina({{ vacina.id }})">🗑️ Remover</button>
        <button class="btn btn-sm btn-outline-primary" onclick="editarVacina({{ vacina.id }})">✏️ Editar</button>
        <a href="{{ url_for('imprimir_vacinas', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark" target="_blank">🖨️ Imprimir</a>
      </div>
      </li>
      {% endfor %}
    </ul>
  </div>
</div>
{% else %}
<p class="text-muted">Nenhuma vacina registrada ainda para este animal.</p>
{% endif %}

<script>
function editarVacina(id) {
  const li = document.querySelector(`[data-vacina-id='${id}']`);
  const {
    nome = '',
    tipo = '',
    fabricante = '',
    doses = '',
    intervalo = '',
    frequencia = '',
    aplicada = '0',
    aplicada_em = '',
    obs = ''
  } = li.dataset;

  li.innerHTML = `
    <div class="mb-2">
      <label class="form-label">Nome</label>
      <input class="form-control" id="edit-nome-${id}" value="${nome}">
    </div>
    <div class="mb-2">
      <label class="form-label">Tipo</label>
      <input class="form-control" id="edit-tipo-${id}" value="${tipo}">
    </div>
    <div class="mb-2">
      <label class="form-label">Fabricante</label>
      <input class="form-control" id="edit-fabricante-${id}" value="${fabricante}">
    </div>
    <div class="row">
      <div class="col-md-4 mb-2">
        <label class="form-label">Doses Totais</label>
        <input type="number" class="form-control" id="edit-doses-${id}" value="${doses}">
      </div>
      <div class="col-md-4 mb-2">
        <label class="form-label">Intervalo (dias)</label>
        <input type="number" class="form-control" id="edit-intervalo-${id}" value="${intervalo}">
      </div>
      <div class="col-md-4 mb-2">
        <label class="form-label">Frequência</label>
        <input class="form-control" id="edit-frequencia-${id}" value="${frequencia}">
      </div>
    </div>
    <div class="form-check mb-2">
      <input class="form-check-input" type="checkbox" id="edit-aplicada-${id}" ${aplicada === '1' ? 'checked' : ''}>
      <label class="form-check-label" for="edit-aplicada-${id}">Aplicada?</label>
    </div>
    <div class="mb-2">
      <label class="form-label">Data</label>
      <input type="date" class="form-control" id="edit-aplicada-em-${id}" value="${aplicada_em}" ${aplicada === '1' ? '' : 'disabled'}>
    </div>
    <div class="mb-2">
      <label class="form-label">Observações</label>
      <textarea class="form-control" id="edit-obs-${id}">${obs}</textarea>
    </div>
    <button class="btn btn-sm btn-success" onclick="salvarEdicaoVacina(${id})">💾 Salvar</button>
    <button class="btn btn-sm btn-secondary" onclick="location.reload()">Cancelar</button>
  `;

  const chk = document.getElementById(`edit-aplicada-${id}`);
  const dt = document.getElementById(`edit-aplicada-em-${id}`);
  chk.addEventListener('change', () => {
    dt.disabled = !chk.checked;
    if (!chk.checked) dt.value = '';
  });
}

function salvarEdicaoVacina(id) {
  const nome = document.getElementById(`edit-nome-${id}`).value.trim();
  const tipo = document.getElementById(`edit-tipo-${id}`).value.trim();
  const fabricante = document.getElementById(`edit-fabricante-${id}`).value.trim();
  const doses_totais = document.getElementById(`edit-doses-${id}`).value;
  const intervalo_dias = document.getElementById(`edit-intervalo-${id}`).value;
  const frequencia = document.getElementById(`edit-frequencia-${id}`).value.trim();
  const aplicada = document.getElementById(`edit-aplicada-${id}`).checked;
  const aplicada_em = document.getElementById(`edit-aplicada-em-${id}`).value.trim();
  const observacoes = document.getElementById(`edit-obs-${id}`).value.trim();

  fetch(`/vacina/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ nome, tipo, fabricante, doses_totais, intervalo_dias, frequencia, aplicada, aplicada_em, observacoes })
  })
  .then(res => res.json())
  .then(d => {
    if (d.success) {
      alert('Vacina atualizada!');
      location.reload();
    } else {
      alert('Erro ao salvar.');
    }
  })
  .catch(err => {
    console.error('Erro:', err);
    alert('Erro na requisição.');
  });
}

function excluirVacina(id) {
  if (!confirm('Deseja mesmo remover esta vacina?')) return;
  fetch(`/vacina/${id}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(d => {
      if (d.success) {
        const li = document.querySelector(`[data-vacina-id='${id}']`);
        li?.remove();
      } else {
        alert(d.error || 'Erro ao excluir vacina.');
      }
    })
    .catch(err => {
      console.error('Erro ao excluir vacina:', err);
      alert('Erro ao excluir vacina.');
    });
}
</script>
