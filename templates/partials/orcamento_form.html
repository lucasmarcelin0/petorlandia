{% set default_payer_type = 'plan' if consulta.health_subscription_id else 'particular' %}

<h5 class="mb-3">Or√ßamento da Consulta</h5>

<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3 gap-2">
  <div class="btn-group" role="group" aria-label="Tipo de pagador">
    <input type="radio" class="btn-check" name="payer-toggle" id="payer-plan" autocomplete="off" value="plan" {% if default_payer_type == 'plan' %}checked{% endif %}>
    <label class="btn btn-outline-primary" for="payer-plan">Plano</label>

    <input type="radio" class="btn-check" name="payer-toggle" id="payer-particular" autocomplete="off" value="particular" {% if default_payer_type == 'particular' %}checked{% endif %}>
    <label class="btn btn-outline-primary" for="payer-particular">Particular</label>
  </div>
  <small class="text-muted">Selecione se o item pertence ao plano de sa√∫de ou a um pagamento particular.</small>
</div>

<div class="border rounded p-3 mb-4 bg-light">
<div class="d-flex justify-content-end mb-2">
  <button id="toggle-novo-servico-btn" type="button" class="btn btn-outline-primary btn-sm" onclick="toggleNovoServico()">
    ‚ûï Novo item de tabela
  </button>
</div>
<div id="novo-servico-container" class="border rounded p-3 mb-4 bg-light d-none">
  <form id="form-servico" class="row g-2 align-items-end" onsubmit="event.preventDefault(); criarServico();">
    <div class="col-md-5">
      <label for="descricao-servico" class="form-label">Descri√ß√£o do item</label>
      <input type="text" id="descricao-servico" class="form-control" placeholder="Ex: Consulta" required>
    </div>
    <div class="col-md-3">
      <label for="valor-servico" class="form-label">Valor (R$)</label>
      <input type="number" step="0.01" id="valor-servico" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label for="codigo-servico" class="form-label">C√≥digo (TUSS/FHIR)</label>
      <input type="text" id="codigo-servico" class="form-control" placeholder="Opcional">
    </div>
    <div class="col-md-1">
      <button type="submit" class="btn btn-primary w-100">Cadastrar item</button>
    </div>
  </form>
</div>

<div class="border rounded p-3 mb-4 bg-light">
  <form id="form-orcamento" class="row g-2 align-items-end" onsubmit="event.preventDefault(); adicionarItemOrcamento();">
    <div class="col-md-8">
      <label for="servico-id" class="form-label">Escolha o item</label>
      <select id="servico-id" class="form-select" required>
        <option value="">Selecione...</option>
        {% for s in servicos %}
          <option value="{{ s.id }}">{{ s.descricao }}{% if s.procedure_code %} ({{ s.procedure_code }}){% endif %} ‚Äì R$ {{ '%.2f'|format(s.valor) }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="valor-personalizado" class="form-label">Valor (R$)</label>
      <input type="number" step="0.01" id="valor-personalizado" class="form-control" placeholder="usar padr√£o">
    </div>
    <div class="col-md-1">
      <button type="submit" class="btn btn-success w-100">+</button>
    </div>
  </form>
</div>

{% set visible_total = namespace(value=0) %}
{% for item in consulta.orcamento_items %}
  {% set payer_type = item.payer_type or default_payer_type %}
  {% if payer_type == default_payer_type %}
    {% set visible_total.value = visible_total.value + item.valor %}
  {% endif %}
{% endfor %}

<table class="table" id="orcamento-tabela">
  <thead>
    <tr>
      <th>Descri√ß√£o</th>
      <th class="text-end">Valor (R$)</th>
      <th class="text-center">Cobertura</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for item in consulta.orcamento_items %}
    {% set payer_type = item.payer_type or default_payer_type %}
    <tr data-id="{{ item.id }}" data-payer="{{ payer_type }}" data-value="{{ '%.2f'|format(item.valor) }}" class="{% if payer_type != default_payer_type %}d-none{% endif %}">
      <td>
        <span class="badge {% if payer_type == 'plan' %}bg-info text-dark{% else %}bg-secondary{% endif %} me-2">{{ payer_type|payer_label }}</span>
        <span>{{ item.descricao }}</span>
      </td>
      <td class="text-end">{{ '%.2f'|format(item.valor) }}</td>
      <td class="text-center">
        <span class="badge bg-{{ item.coverage_status|coverage_badge }}">
          {{ item.coverage_status|coverage_label }}
        </span>
        {% if item.coverage_message %}
          <small class="d-block text-muted">{{ item.coverage_message }}</small>
        {% endif %}
      </td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="removerItemOrcamento({{ item.id }})">üóëÔ∏è</button></td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th>Total</th>
      <th class="text-end" id="orcamento-total">{{ '%.2f'|format(visible_total.value) }}</th>
      <th colspan="2"></th>
    </tr>
  </tfoot>
</table>
<div id="particular-extra-fields" class="border rounded p-3 mb-3 bg-white d-none">
  <div class="row g-3">
    <div class="col-md-4">
      <label for="desconto-percentual" class="form-label">Desconto (%)</label>
      <input type="number" step="0.01" min="0" max="100" class="form-control" id="desconto-percentual" placeholder="Ex: 10">
    </div>
    <div class="col-md-4">
      <label for="desconto-valor" class="form-label">Desconto (R$)</label>
      <input type="number" step="0.01" min="0" class="form-control" id="desconto-valor" placeholder="Ex: 50,00">
    </div>
    <div class="col-md-4">
      <label class="form-label">Totais</label>
      <div class="border rounded p-2 bg-light">
        <div class="d-flex justify-content-between">
          <small class="text-muted">Total bruto</small>
          <strong id="resumo-total-bruto">R$ 0,00</strong>
        </div>
        <div class="d-flex justify-content-between mt-1">
          <small class="text-muted">Total com desconto</small>
          <strong id="resumo-total-com-desconto">R$ 0,00</strong>
        </div>
      </div>
    </div>
    <div class="col-12">
      <label for="observacoes-tutor" class="form-label">Observa√ß√µes para o tutor</label>
      <textarea id="observacoes-tutor" class="form-control" rows="2" placeholder="Mensagem que aparecer√° para o tutor"></textarea>
      <small class="text-muted">Essas informa√ß√µes ser√£o enviadas apenas para o or√ßamento particular.</small>
    </div>
  </div>
</div>
<div class="text-end mt-3">
  <button type="button" class="btn btn-success" onclick="finalizarBlocoOrcamento()">üíæ Salvar or√ßamento</button>
</div>
{% if consulta %}
<div class="d-flex flex-wrap justify-content-end gap-2 mt-3">
  <form method="POST" action="{{ url_for('finalizar_consulta_e_fechar', consulta_id=consulta.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-success">
      <i class="bi bi-check2-circle"></i>
      Finalizar e fechar atendimento
    </button>
  </form>
  {% if consulta.appointment %}
  <a href="{{ url_for('appointment_close', appointment_id=consulta.appointment.id) }}" class="btn btn-outline-primary">
    <i class="bi bi-receipt"></i>
    Abrir fechamento fiscal
  </a>
  {% endif %}
</div>
{% endif %}

<div id="historico-orcamentos" class="mt-5">
  {% include 'partials/historico_orcamentos.html' %}
</div>

<script src="{{ url_for('static', filename='js/unified-history-sync.js') }}"></script>
<script>
const consultaId = {{ consulta.id }};
const clinicId = {{ (consulta.clinica_id or current_user.clinica_id) | tojson }};
const payerTypeLabels = { plan: 'Plano', particular: 'Particular' };
let currentPayerType = '{{ default_payer_type }}';
const discountContainer = document.getElementById('particular-extra-fields');
const discountPercentInput = document.getElementById('desconto-percentual');
const discountValueInput = document.getElementById('desconto-valor');
const totalSummaryValue = document.getElementById('resumo-total-bruto');
const totalWithDiscountSummary = document.getElementById('resumo-total-com-desconto');
let isSyncingDiscounts = false;

function toggleNovoServico() {
  const container = document.getElementById('novo-servico-container');
  const button = document.getElementById('toggle-novo-servico-btn');
  container.classList.toggle('d-none');
  if (button) {
    button.textContent = container.classList.contains('d-none')
      ? '‚ûï Novo item de tabela'
      : '‚ûñ Fechar cadastro';
  }
}

async function criarServico() {
  const descricao = document.getElementById('descricao-servico').value.trim();
  const valor = parseFloat(document.getElementById('valor-servico').value);
  const codigo = document.getElementById('codigo-servico').value.trim();
  if (!descricao || isNaN(valor)) return;
  const resp = await fetch('/servico', {
    method: 'POST',
    headers: {'Content-Type':'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
    body: JSON.stringify({descricao, valor, procedure_code: codigo || null})
  });
  if (resp.ok) {
    const data = await resp.json();
    const select = document.getElementById('servico-id');
    const opt = document.createElement('option');
    opt.value = data.id;
    const codePart = data.procedure_code ? ` (${data.procedure_code})` : '';
    opt.textContent = `${data.descricao}${codePart} ‚Äì R$ ${data.valor.toFixed(2)}`;
    select.appendChild(opt);
    select.value = data.id;
    document.getElementById('descricao-servico').value = '';
    document.getElementById('valor-servico').value = '';
    document.getElementById('codigo-servico').value = '';
  }
}

function payerBadge(type) {
  const label = payerTypeLabels[type] || payerTypeLabels.particular;
  const badgeClass = type === 'plan' ? 'bg-info text-dark' : 'bg-secondary';
  return `<span class="badge ${badgeClass} me-2">${label}</span>`;
}

function applyPayerFilter() {
  const rows = document.querySelectorAll('#orcamento-tabela tbody tr');
  rows.forEach(row => {
    const rowType = row.dataset.payer || 'particular';
    const shouldShow = rowType === currentPayerType;
    row.classList.toggle('d-none', !shouldShow);
  });
  updateOrcamentoTotal();
  toggleDiscountFields();
}

function updateOrcamentoTotal() {
  const rows = document.querySelectorAll('#orcamento-tabela tbody tr');
  let total = 0;
  rows.forEach(row => {
    if (row.classList.contains('d-none')) return;
    total += parseFloat(row.dataset.value || '0');
  });
  document.getElementById('orcamento-total').textContent = total.toFixed(2);
  recalculateDiscountsAfterTotalChange();
  updateTotalsSummary();
}

function bindPayerToggle() {
  document.querySelectorAll('input[name="payer-toggle"]').forEach(input => {
    input.addEventListener('change', (event) => {
      if (event.target.checked) {
        currentPayerType = event.target.value;
        applyPayerFilter();
      }
    });
  });
}

function initPayerControls() {
  bindPayerToggle();
  applyPayerFilter();
}

function getOrcamentoTotal() {
  const totalText = document.getElementById('orcamento-total')?.textContent || '0';
  const parsed = parseFloat(totalText.replace(',', '.'));
  return isNaN(parsed) ? 0 : parsed;
}

function formatCurrency(value) {
  return `R$ ${value.toFixed(2)}`;
}

function updateTotalsSummary() {
  if (!totalSummaryValue || !totalWithDiscountSummary) return;
  const total = getOrcamentoTotal();
  const discountRaw = parseFloat(discountValueInput?.value);
  const discount = !isNaN(discountRaw) ? Math.min(discountRaw, total) : 0;
  const totalComDesconto = Math.max(total - discount, 0);
  totalSummaryValue.textContent = formatCurrency(total);
  totalWithDiscountSummary.textContent = formatCurrency(totalComDesconto);
}

function updateDiscountFromPercent() {
  if (!discountPercentInput || !discountValueInput) return;
  const percent = parseFloat(discountPercentInput.value);
  const total = getOrcamentoTotal();
  if (isNaN(percent)) {
    discountValueInput.value = '';
    return;
  }
  const value = total * (percent / 100);
  discountValueInput.value = value.toFixed(2);
}

function updateDiscountFromValue() {
  if (!discountPercentInput || !discountValueInput) return;
  const value = parseFloat(discountValueInput.value);
  const total = getOrcamentoTotal();
  if (isNaN(value) || total <= 0) {
    discountPercentInput.value = '';
    return;
  }
  const percent = (value / total) * 100;
  discountPercentInput.value = percent.toFixed(2);
}

function handleDiscountInput(source) {
  if (isSyncingDiscounts) return;
  isSyncingDiscounts = true;
  if (source === 'percent') {
    updateDiscountFromPercent();
  } else {
    updateDiscountFromValue();
  }
  isSyncingDiscounts = false;
  updateTotalsSummary();
}

function recalculateDiscountsAfterTotalChange() {
  if (!discountPercentInput || !discountValueInput) return;
  if (discountPercentInput.value) {
    handleDiscountInput('percent');
  } else if (discountValueInput.value) {
    handleDiscountInput('value');
  }
  updateTotalsSummary();
}

function initDiscountControls() {
  if (!discountPercentInput || !discountValueInput) return;
  discountPercentInput.addEventListener('input', () => handleDiscountInput('percent'));
  discountValueInput.addEventListener('input', () => handleDiscountInput('value'));
}

function toggleDiscountFields() {
  if (!discountContainer) return;
  const show = currentPayerType === 'particular';
  discountContainer.classList.toggle('d-none', !show);
  discountContainer.querySelectorAll('input, textarea').forEach(el => {
    el.disabled = !show;
  });
}

function coletarDadosDesconto() {
  if (!discountContainer || discountContainer.classList.contains('d-none')) {
    return {};
  }
  const percent = parseFloat(document.getElementById('desconto-percentual').value);
  const valor = parseFloat(document.getElementById('desconto-valor').value);
  const observacoes = document.getElementById('observacoes-tutor').value.trim();
  const payload = {};
  if (!isNaN(percent)) payload.discount_percent = percent;
  if (!isNaN(valor)) payload.discount_value = valor;
  if (observacoes) payload.tutor_notes = observacoes;
  return payload;
}

function limparCamposDesconto() {
  if (!discountContainer) return;
  document.getElementById('desconto-percentual').value = '';
  document.getElementById('desconto-valor').value = '';
  document.getElementById('observacoes-tutor').value = '';
  updateTotalsSummary();
}

function initFormControls() {
  initPayerControls();
  initDiscountControls();
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initFormControls);
} else {
  initFormControls();
}

async function adicionarItemOrcamento() {
  const servicoId = parseInt(document.getElementById('servico-id').value);
  const valor = parseFloat(document.getElementById('valor-personalizado').value);
  if (!servicoId) return;
  if (!clinicId) {
    alert('Cl√≠nica n√£o definida para o or√ßamento.');
    return;
  }
  const payload = {servico_id: servicoId, payer_type: currentPayerType, clinica_id: clinicId};
  if (!isNaN(valor)) payload.valor = valor;
  const resp = await fetch(`/consulta/${consultaId}/orcamento_item`, {
    method: 'POST',
    headers: {'Content-Type':'application/json', 'X-CSRFToken': '{{ csrf_token() }}'},
    body: JSON.stringify(payload)
  });
  if (resp.ok) {
    const data = await resp.json();
    const tbody = document.querySelector('#orcamento-tabela tbody');
    const tr = document.createElement('tr');
    tr.dataset.id = data.id;
    const payerType = data.payer_type || currentPayerType;
    tr.dataset.payer = payerType;
    tr.dataset.value = data.valor;
    if (payerType !== currentPayerType) {
      tr.classList.add('d-none');
    }
    const badgeClass = data.coverage_badge || 'secondary';
    const badgeLabel = data.coverage_label || 'Pendente';
    const coverageMessage = data.coverage_message ? `<small class="d-block text-muted">${data.coverage_message}</small>` : '';
    tr.innerHTML = `<td>${payerBadge(payerType)}<span>${data.descricao}</span></td>` +
                   `<td class="text-end">${data.valor.toFixed(2)}</td>` +
                   `<td class="text-center"><span class="badge bg-${badgeClass}">${badgeLabel}</span>${coverageMessage}</td>` +
                   `<td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="removerItemOrcamento(${data.id})">üóëÔ∏è</button></td>`;
    tbody.appendChild(tr);
    document.getElementById('servico-id').value = '';
    document.getElementById('valor-personalizado').value = '';
    applyPayerFilter();
  }
}

async function removerItemOrcamento(id) {
  const resp = await fetch(`/consulta/orcamento_item/${id}`, {method:'DELETE', headers: {'X-CSRFToken': '{{ csrf_token() }}'}});
  if (resp.ok) {
    document.querySelector(`#orcamento-tabela tr[data-id='${id}']`).remove();
    await resp.json();
    updateOrcamentoTotal();
  }
}

/**
 * SIMPLIFIED & UNIFIED: Save budget and update history
 * Uses the centralized HistorySyncManager for guaranteed reliability
 */
async function finalizarBlocoOrcamento() {
  const tbody = document.querySelector('#orcamento-tabela tbody');
  if (!tbody.children.length) {
    if (typeof showToast === 'function') {
      showToast('Adicione itens ao or√ßamento', 'warning');
    }
    return;
  }

  if (!clinicId) {
    if (typeof showToast === 'function') {
      showToast('Cl√≠nica n√£o definida para o or√ßamento.', 'danger');
    }
    return;
  }

  const btn = document.querySelector('button[onclick="finalizarBlocoOrcamento()"]');
  if (!btn) {
    console.error('Bot√£o de finalizar n√£o encontrado');
    if (typeof showToast === 'function') {
      showToast('Erro: bot√£o n√£o encontrado', 'danger');
    }
    return;
  }

  // Prepare data
  const extra = coletarDadosDesconto();
  extra.clinica_id = clinicId;

  // Use unified system to save and update history
  const result = await window.HistorySyncManager.saveAndUpdateHistory(
    `/consulta/${consultaId}/bloco_orcamento`,
    extra,
    'historico-orcamentos',
    btn,
    {
      successMessage: 'Or√ßamento salvo com sucesso! ‚úÖ',
      errorMessage: 'Erro ao salvar or√ßamento',
      timeoutMs: 10000,
      disableFormAfterSuccess: false,
      onSuccess: (result) => {
        // Reset the form state
        tbody.innerHTML = '';
        document.getElementById('orcamento-total').textContent = '0.00';
        limparCamposDesconto();
      },
      onError: (error) => {
        console.error('Falha ao salvar or√ßamento:', error);
      }
    }
  );

  return result;
}
</script>
