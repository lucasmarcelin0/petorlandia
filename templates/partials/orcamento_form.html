<h5 class="mb-3">Or√ßamento da Consulta</h5>

<div class="border rounded p-3 mb-4 bg-light">
  <form id="form-servico" class="row g-2 align-items-end" onsubmit="event.preventDefault(); criarServico();">
    <div class="col-md-5">
      <label for="descricao-servico" class="form-label">Descri√ß√£o do item</label>
      <input type="text" id="descricao-servico" class="form-control" placeholder="Ex: Consulta" required>
    </div>
    <div class="col-md-3">
      <label for="valor-servico" class="form-label">Valor (R$)</label>
      <input type="number" step="0.01" id="valor-servico" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label for="codigo-servico" class="form-label">C√≥digo (TUSS/FHIR)</label>
      <input type="text" id="codigo-servico" class="form-control" placeholder="Opcional">
    </div>
    <div class="col-md-1">
      <button type="submit" class="btn btn-primary w-100">Cadastrar item</button>
    </div>
  </form>
</div>

<div class="border rounded p-3 mb-4 bg-light">
  <form id="form-orcamento" class="row g-2 align-items-end" onsubmit="event.preventDefault(); adicionarItemOrcamento();">
    <div class="col-md-8">
      <label for="servico-id" class="form-label">Escolha o item</label>
      <select id="servico-id" class="form-select" required>
        <option value="">Selecione...</option>
        {% for s in servicos %}
          <option value="{{ s.id }}">{{ s.descricao }}{% if s.procedure_code %} ({{ s.procedure_code }}){% endif %} ‚Äì R$ {{ '%.2f'|format(s.valor) }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="valor-personalizado" class="form-label">Valor (R$)</label>
      <input type="number" step="0.01" id="valor-personalizado" class="form-control" placeholder="usar padr√£o">
    </div>
    <div class="col-md-1">
      <button type="submit" class="btn btn-success w-100">+</button>
    </div>
  </form>
</div>

<table class="table" id="orcamento-tabela">
  <thead>
    <tr>
      <th>Descri√ß√£o</th>
      <th class="text-end">Valor (R$)</th>
      <th class="text-center">Cobertura</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for item in consulta.orcamento_items %}
    <tr data-id="{{ item.id }}">
      <td>{{ item.descricao }}</td>
      <td class="text-end">{{ '%.2f'|format(item.valor) }}</td>
      <td class="text-center">
        <span class="badge bg-{{ item.coverage_status|coverage_badge }}">
          {{ item.coverage_status|coverage_label }}
        </span>
        {% if item.coverage_message %}
          <small class="d-block text-muted">{{ item.coverage_message }}</small>
        {% endif %}
      </td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="removerItemOrcamento({{ item.id }})">üóëÔ∏è</button></td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th>Total</th>
      <th class="text-end" id="orcamento-total">{{ '%.2f'|format(consulta.total_orcamento) }}</th>
      <th colspan="2"></th>
    </tr>
  </tfoot>
</table>
<div class="border rounded p-3 mb-3 bg-white">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
    <div>
      <label class="form-label mb-2">Forma de cobran√ßa</label>
      <div class="btn-group" role="group" aria-label="Modo de cobran√ßa">
        <input type="radio" class="btn-check" name="modo-cobranca" id="modo-cobranca-plano" value="plano" checked>
        <label class="btn btn-outline-secondary" for="modo-cobranca-plano">Plano</label>
        <input type="radio" class="btn-check" name="modo-cobranca" id="modo-cobranca-particular" value="particular">
        <label class="btn btn-outline-secondary" for="modo-cobranca-particular">Particular</label>
      </div>
    </div>
    <div class="text-muted small">
      Configure descontos e observa√ß√µes apenas para cobran√ßas particulares.
    </div>
  </div>
  <div id="campos-particular" class="row g-3 mt-2 d-none">
    <div class="col-md-4">
      <label for="desconto-percentual" class="form-label">Desconto (%)</label>
      <input type="number" step="0.01" min="0" max="100" id="desconto-percentual" class="form-control" placeholder="0,00">
    </div>
    <div class="col-md-4">
      <label for="desconto-valor" class="form-label">Desconto (R$)</label>
      <input type="number" step="0.01" min="0" id="desconto-valor" class="form-control" placeholder="0,00">
    </div>
    <div class="col-12">
      <label for="observacoes-tutor" class="form-label">Observa√ß√µes para o tutor</label>
      <textarea id="observacoes-tutor" class="form-control" rows="2" maxlength="500" placeholder="Mensagem opcional"></textarea>
      <small class="text-muted">Essas observa√ß√µes aparecer√£o no hist√≥rico e no envio para pagamento.</small>
    </div>
  </div>
</div>
<div class="d-flex flex-column flex-md-row justify-content-end gap-2 mt-3">
  <button type="button" class="btn btn-outline-primary" onclick="enviarBlocoParaPagamento()">üí∏ Enviar para pagamento</button>
  <button type="button" class="btn btn-success" onclick="finalizarBlocoOrcamento()">üíæ Salvar or√ßamento</button>
</div>

<div id="historico-orcamentos" class="mt-5">
  {% include 'partials/historico_orcamentos.html' %}
</div>

<script>
const consultaId = {{ consulta.id }};
let ultimoBlocoId = null;

async function criarServico() {
  const descricao = document.getElementById('descricao-servico').value.trim();
  const valor = parseFloat(document.getElementById('valor-servico').value);
  const codigo = document.getElementById('codigo-servico').value.trim();
  if (!descricao || isNaN(valor)) return;
  const resp = await fetch('/servico', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({descricao, valor, procedure_code: codigo || null})
  });
  if (resp.ok) {
    const data = await resp.json();
    const select = document.getElementById('servico-id');
    const opt = document.createElement('option');
    opt.value = data.id;
    const codePart = data.procedure_code ? ` (${data.procedure_code})` : '';
    opt.textContent = `${data.descricao}${codePart} ‚Äì R$ ${data.valor.toFixed(2)}`;
    select.appendChild(opt);
    select.value = data.id;
    document.getElementById('descricao-servico').value = '';
    document.getElementById('valor-servico').value = '';
    document.getElementById('codigo-servico').value = '';
  }
}

async function adicionarItemOrcamento() {
  const servicoId = parseInt(document.getElementById('servico-id').value);
  const valor = parseFloat(document.getElementById('valor-personalizado').value);
  if (!servicoId) return;
  const payload = {servico_id: servicoId};
  if (!isNaN(valor)) payload.valor = valor;
  const resp = await fetch(`/consulta/${consultaId}/orcamento_item`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if (resp.ok) {
    const data = await resp.json();
    const tbody = document.querySelector('#orcamento-tabela tbody');
    const tr = document.createElement('tr');
    tr.dataset.id = data.id;
    const badgeClass = data.coverage_badge || 'secondary';
    const badgeLabel = data.coverage_label || 'Pendente';
    const coverageMessage = data.coverage_message ? `<small class="d-block text-muted">${data.coverage_message}</small>` : '';
    tr.innerHTML = `<td>${data.descricao}</td>` +
                   `<td class="text-end">${data.valor.toFixed(2)}</td>` +
                   `<td class="text-center"><span class="badge bg-${badgeClass}">${badgeLabel}</span>${coverageMessage}</td>` +
                   `<td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="removerItemOrcamento(${data.id})">üóëÔ∏è</button></td>`;
    tbody.appendChild(tr);
    document.getElementById('servico-id').value = '';
    document.getElementById('valor-personalizado').value = '';
    document.getElementById('orcamento-total').textContent = data.total.toFixed(2);
  }
}

async function removerItemOrcamento(id) {
  const resp = await fetch(`/consulta/orcamento_item/${id}`, {method:'DELETE'});
  if (resp.ok) {
    document.querySelector(`#orcamento-tabela tr[data-id='${id}']`).remove();
    const data = await resp.json();
    document.getElementById('orcamento-total').textContent = data.total.toFixed(2);
  }
}

async function finalizarBlocoOrcamento() {
  const tbody = document.querySelector('#orcamento-tabela tbody');
  if (!tbody.children.length) return;
  const payload = coletarDadosBloco();
  const resp = await fetch(`/consulta/${consultaId}/bloco_orcamento`, {
    method: 'POST',
    headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });
  if (resp.ok) {
    const data = await resp.json();
    if (data.success) {
      tbody.innerHTML = '';
      document.getElementById('orcamento-total').textContent = '0.00';
      limparCamposParticular();
      const historico = document.getElementById('historico-orcamentos');
      if (data.html) {
        historico.innerHTML = data.html;
        if (typeof bindSyncForms === 'function') { bindSyncForms(historico); }
        bindOrcamentoHistoryActions();
        refreshUltimoBlocoId();
      }
      if (data.bloco_id) {
        ultimoBlocoId = data.bloco_id;
      }
      notifyBudget('Or√ßamento salvo com sucesso.', 'success');
    } else if (data.message) {
      notifyBudget(data.message, 'danger');
    }
  } else {
    notifyBudget('N√£o foi poss√≠vel salvar o or√ßamento.', 'danger');
  }
}

function coletarDadosBloco() {
  const modo = getModoCobranca();
  const observacoes = document.getElementById('observacoes-tutor').value.trim();
  const data = {cobranca_tipo: modo};
  if (modo === 'particular') {
    const percentual = parseFloat(document.getElementById('desconto-percentual').value);
    const valor = parseFloat(document.getElementById('desconto-valor').value);
    if (!isNaN(percentual)) data.desconto_percentual = percentual;
    if (!isNaN(valor)) data.desconto_valor = valor;
    if (observacoes) data.observacoes_tutor = observacoes;
  } else if (observacoes) {
    data.observacoes_tutor = observacoes;
  }
  return data;
}

function limparCamposParticular() {
  document.getElementById('desconto-percentual').value = '';
  document.getElementById('desconto-valor').value = '';
  document.getElementById('observacoes-tutor').value = '';
  const planoRadio = document.getElementById('modo-cobranca-plano');
  if (planoRadio) planoRadio.checked = true;
  atualizarCamposParticular();
}

function getModoCobranca() {
  const selecionado = document.querySelector('input[name="modo-cobranca"]:checked');
  return selecionado ? selecionado.value : 'plano';
}

function atualizarCamposParticular() {
  const container = document.getElementById('campos-particular');
  const modo = getModoCobranca();
  container?.classList.toggle('d-none', modo !== 'particular');
}

function bindModoCobrancaToggle() {
  document.querySelectorAll('input[name="modo-cobranca"]').forEach(radio => {
    radio.addEventListener('change', atualizarCamposParticular);
  });
  atualizarCamposParticular();
}

function notifyBudget(message, category='info') {
  if (typeof showToast === 'function') {
    showToast(message, category);
  } else {
    console.log(`[${category}]`, message);
  }
}

function bindOrcamentoHistoryActions() {
  document.querySelectorAll('#historico-orcamentos .btn-enviar-pagamento').forEach(btn => {
    if (btn.dataset.bound) return;
    btn.dataset.bound = 'true';
    btn.addEventListener('click', () => {
      const blocoId = parseInt(btn.dataset.blocoId, 10);
      enviarBlocoParaPagamento(blocoId);
    });
  });
}

function refreshUltimoBlocoId() {
  const cards = document.querySelectorAll('#historico-orcamentos [data-bloco-id]');
  let maior = null;
  cards.forEach(card => {
    const id = parseInt(card.dataset.blocoId, 10);
    if (!isNaN(id)) {
      maior = maior === null ? id : Math.max(maior, id);
    }
  });
  ultimoBlocoId = maior;
}

async function enviarBlocoParaPagamento(blocoId = null) {
  const targetId = blocoId || ultimoBlocoId;
  if (!targetId) {
    notifyBudget('Salve um or√ßamento antes de enviar para pagamento.', 'warning');
    return;
  }
  const resp = await fetch(`/consulta/${consultaId}/pagar_orcamento?bloco_id=${targetId}`, {
    method: 'POST',
    headers: {'Accept': 'application/json'}
  });
  const historico = document.getElementById('historico-orcamentos');
  if (resp.ok) {
    const data = await resp.json();
    if (data.success) {
      notifyBudget('Link de pagamento gerado. Abrindo em nova aba...', 'success');
      if (data.pagamento_url) {
        window.open(data.pagamento_url, '_blank');
      }
      if (data.html) {
        historico.innerHTML = data.html;
        if (typeof bindSyncForms === 'function') { bindSyncForms(historico); }
        bindOrcamentoHistoryActions();
        refreshUltimoBlocoId();
      }
      return;
    }
    notifyBudget(data.message || 'N√£o foi poss√≠vel enviar para pagamento.', 'danger');
  } else {
    notifyBudget('Falha ao iniciar o pagamento.', 'danger');
  }
}

bindModoCobrancaToggle();
bindOrcamentoHistoryActions();
refreshUltimoBlocoId();
</script>
