<h5 class="mb-3">Or√ßamento da Consulta</h5>

<div class="border rounded p-3 mb-4 bg-light">
  <form id="form-servico" class="row g-2 align-items-end" onsubmit="event.preventDefault(); criarServico();">
    <div class="col-md-7">
      <label for="descricao-servico" class="form-label">Descri√ß√£o do item</label>
      <input type="text" id="descricao-servico" class="form-control" placeholder="Ex: Consulta" required>
    </div>
    <div class="col-md-3">
      <label for="valor-servico" class="form-label">Valor (R$)</label>
      <input type="number" step="0.01" id="valor-servico" class="form-control" required>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Cadastrar item</button>
    </div>
  </form>
</div>

<div class="border rounded p-3 mb-4 bg-light">
  <form id="form-orcamento" class="row g-2 align-items-end" onsubmit="event.preventDefault(); adicionarItemOrcamento();">
    <div class="col-md-8">
      <label for="servico-id" class="form-label">Escolha o item</label>
      <select id="servico-id" class="form-select" required>
        <option value="">Selecione...</option>
        {% for s in servicos %}
          <option value="{{ s.id }}">{{ s.descricao }} ‚Äì R$ {{ '%.2f'|format(s.valor) }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="valor-personalizado" class="form-label">Valor (R$)</label>
      <input type="number" step="0.01" id="valor-personalizado" class="form-control" placeholder="usar padr√£o">
    </div>
    <div class="col-md-1">
      <button type="submit" class="btn btn-success w-100">+</button>
    </div>
  </form>
</div>

<table class="table" id="orcamento-tabela">
  <thead>
    <tr>
      <th>Descri√ß√£o</th>
      <th class="text-end">Valor (R$)</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for item in consulta.orcamento_items %}
    <tr data-id="{{ item.id }}">
      <td>{{ item.descricao }}</td>
      <td class="text-end">{{ '%.2f'|format(item.valor) }}</td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="removerItemOrcamento({{ item.id }})">üóëÔ∏è</button></td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th>Total</th>
      <th class="text-end" id="orcamento-total">{{ '%.2f'|format(consulta.total_orcamento) }}</th>
      <th></th>
    </tr>
  </tfoot>
</table>

<script>
const consultaId = {{ consulta.id }};

async function criarServico() {
  const descricao = document.getElementById('descricao-servico').value.trim();
  const valor = parseFloat(document.getElementById('valor-servico').value);
  if (!descricao || isNaN(valor)) return;
  const resp = await fetch('/servico', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({descricao, valor})
  });
  if (resp.ok) {
    const data = await resp.json();
    const select = document.getElementById('servico-id');
    const opt = document.createElement('option');
    opt.value = data.id;
    opt.textContent = `${data.descricao} ‚Äì R$ ${data.valor.toFixed(2)}`;
    select.appendChild(opt);
    select.value = data.id;
    document.getElementById('descricao-servico').value = '';
    document.getElementById('valor-servico').value = '';
  }
}

async function adicionarItemOrcamento() {
  const servicoId = parseInt(document.getElementById('servico-id').value);
  const valor = parseFloat(document.getElementById('valor-personalizado').value);
  if (!servicoId) return;
  const payload = {servico_id: servicoId};
  if (!isNaN(valor)) payload.valor = valor;
  const resp = await fetch(`/consulta/${consultaId}/orcamento_item`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if (resp.ok) {
    const data = await resp.json();
    const tbody = document.querySelector('#orcamento-tabela tbody');
    const tr = document.createElement('tr');
    tr.dataset.id = data.id;
    tr.innerHTML = `<td>${data.descricao}</td>` +
                   `<td class="text-end">${data.valor.toFixed(2)}</td>` +
                   `<td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="removerItemOrcamento(${data.id})">üóëÔ∏è</button></td>`;
    tbody.appendChild(tr);
    document.getElementById('servico-id').value = '';
    document.getElementById('valor-personalizado').value = '';
    document.getElementById('orcamento-total').textContent = data.total.toFixed(2);
  }
}

async function removerItemOrcamento(id) {
  const resp = await fetch(`/consulta/orcamento_item/${id}`, {method:'DELETE'});
  if (resp.ok) {
    document.querySelector(`#orcamento-tabela tr[data-id='${id}']`).remove();
    const data = await resp.json();
    document.getElementById('orcamento-total').textContent = data.total.toFixed(2);
  }
}
</script>
