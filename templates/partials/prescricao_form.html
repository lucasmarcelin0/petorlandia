<form>
  <!-- Feedback visual para o usu√°rio -->
  <div id="feedback-message" class="alert d-none position-fixed" style="top: 20px; right: 20px; z-index: 1000;"></div>

  <h5 class="mb-3">Prescri√ß√£o de Medicamentos</h5>
   <!-- Bot√£o para cadastrar nova medica√ß√£o -->
   <button type="button" class="btn btn-outline-primary mb-3" onclick="toggleNovaMedicacao()">‚ûï Nova medica√ß√£o</button>
   <div id="nova-medicacao-container" class="border rounded p-3 mb-3 bg-light d-none">
     <div class="mb-2 position-relative">
       <label for="buscar-medicamento-nova" class="form-label">Pesquisar medicamento existente</label>
       <input type="text" id="buscar-medicamento-nova" class="form-control" placeholder="Digite para buscar...">
       <ul id="sugestoes-busca-nova" class="list-group position-absolute w-100" style="z-index: 10; max-height: 300px; overflow-y: auto; display: none;"></ul>
     </div>
     <div class="mb-2">
       <label for="nova-medicacao-nome" class="form-label">Nome do medicamento*</label>
       <input type="text" id="nova-medicacao-nome" class="form-control">
     </div>
     <div class="mb-2">
       <label for="nova-medicacao-principio" class="form-label">Princ√≠pio ativo</label>
       <input type="text" id="nova-medicacao-principio" class="form-control">
     </div>
     <div class="mb-2">
       <label for="nova-medicacao-classificacao" class="form-label">Classifica√ß√£o</label>
       <input type="text" id="nova-medicacao-classificacao" class="form-control">
     </div>
     <div class="mb-2">
       <label for="nova-medicacao-via" class="form-label">Via de administra√ß√£o</label>
       <input type="text" id="nova-medicacao-via" class="form-control">
     </div>
     <div class="mb-2">
       <label for="nova-medicacao-dosagem" class="form-label">Dosagem recomendada</label>
       <input type="text" id="nova-medicacao-dosagem" class="form-control">
     </div>
     <div class="mb-2">
       <label for="nova-medicacao-frequencia" class="form-label">Frequ√™ncia</label>
       <input type="text" id="nova-medicacao-frequencia" class="form-control">
     </div>
     <div class="mb-2">
       <label for="nova-medicacao-duracao" class="form-label">Dura√ß√£o do tratamento</label>
       <input type="text" id="nova-medicacao-duracao" class="form-control">
     </div>
     <div class="mb-2">
       <label for="nova-medicacao-observacoes" class="form-label">Observa√ß√µes</label>
       <textarea id="nova-medicacao-observacoes" class="form-control" rows="2"></textarea>
     </div>
     <div class="mb-2">
       <label for="nova-medicacao-bula" class="form-label">Bula</label>
       <textarea id="nova-medicacao-bula" class="form-control" rows="2"></textarea>
     </div>
     <div class="mt-3">
       <button type="button" id="btn-salvar-medicacao" class="btn btn-primary me-2" onclick="salvarMedicamento()">üíæ Salvar Medicamento</button>
       <button type="button" id="btn-editar-medicacao" class="btn btn-success me-2 d-none" onclick="salvarMedicamento()">‚úèÔ∏è Editar</button>
       <button type="button" id="btn-excluir-medicacao" class="btn btn-outline-danger d-none" onclick="excluirMedicamento()">üóëÔ∏è Excluir</button>
     </div>
   </div>

   <!-- Campo com autocomplete -->
   <div class="mb-3 position-relative">
    <label for="nome-medicamento" class="form-label">Nome do Medicamento</label>
    <input type="text" id="nome-medicamento" class="form-control" placeholder="Ex: Dipirona, Doxiciclina...">
    <ul id="sugestoes-medicamentos" class="list-group position-absolute w-100" style="z-index: 10; max-height: 300px; overflow-y: auto; display: none;"></ul>
  </div>

   <!-- Formul√°rio para adicionar novo medicamento removido e substitu√≠do pelo container acima -->

  <!-- Card de informa√ß√µes do medicamento -->
  <div id="info-medicamento" class="card border-success mb-3 d-none">
    <div class="card-header bg-success text-white">
      <h5 class="card-title mb-0" id="med-nome-card"></h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Classifica√ß√£o:</strong> <span id="med-classificacao" class="text-muted">‚Äì</span></p>
          <p><strong>Princ√≠pio ativo:</strong> <span id="med-principio" class="text-muted">‚Äì</span></p>
          <p><strong>Via:</strong> <span id="med-via" class="text-muted">‚Äì</span></p>
        </div>
        <div class="col-md-6">
          <p><strong>Dosagem:</strong> <span id="med-dosagem" class="text-muted">‚Äì</span></p>
          <p><strong>Frequ√™ncia:</strong> <span id="med-frequencia" class="text-muted">‚Äì</span></p>
          <p><strong>Dura√ß√£o:</strong> <span id="med-duracao" class="text-muted">‚Äì</span></p>
        </div>
      </div>
      <hr>
      <p><strong>Observa√ß√µes:</strong> <span id="med-observacoes" class="text-muted">‚Äì</span></p>
      <p><strong>Bula:</strong> <a id="med-bula" href="#" target="_blank" class="text-decoration-none">‚Äì</a></p>
    </div>
    <div class="text-end mt-2">
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editarMedicamentoSelecionado()">Editar medicamento</button>
    </div>
  </div>

  <!-- Alternador de modo -->
  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" id="modo-personalizado">
    <label class="form-check-label" for="modo-personalizado">Usar campo √∫nico de prescri√ß√£o personalizada</label>
  </div>

  <!-- Modo detalhado -->
  <div id="modo-detalhado">
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="dose" class="form-label">Dose</label>
        <input type="text" id="dose" class="form-control" placeholder="Ex: 25mg/kg">
      </div>
      <div class="col-md-4">
        <label for="frequencia" class="form-label">Frequ√™ncia</label>
        <input type="text" id="frequencia" class="form-control" placeholder="Ex: 2x ao dia">
      </div>
      <div class="col-md-4">
        <label for="duracao" class="form-label">Dura√ß√£o</label>
        <input type="text" id="duracao" class="form-control" placeholder="Ex: 5 dias">
      </div>
    </div>
  </div>

  <!-- Modo personalizado -->
  <div id="modo-simplificado" class="mb-3 d-none">
    <label for="instrucao-unica" class="form-label">Prescri√ß√£o personalizada</label>
    <textarea id="instrucao-unica" class="form-control" rows="2" placeholder="Ex: Administrar 25mg/kg de 12/12h por 3 dias."></textarea>
  </div>

  <!-- Bot√£o para adicionar √† lista -->
  <button type="button" class="btn btn-success mb-4" id="btn-adicionar">‚ûï Adicionar Prescri√ß√£o</button>

  <!-- Lista tempor√°ria -->
  <div id="medicamentos-lista" class="mb-4">
    <div class="text-center py-4 text-muted">
      <i class="bi bi-prescription2 fs-1"></i>
      <p class="mt-2">Nenhuma prescri√ß√£o adicionada</p>
    </div>
  </div>

  <!-- Instru√ß√µes gerais -->
  <div class="mb-3">
    <label for="instrucoes-medicamentos" class="form-label">Instru√ß√µes Gerais</label>
    <textarea id="instrucoes-medicamentos" class="form-control" rows="3"></textarea>
  </div>

  <!-- Bot√£o para finalizar -->
  <button type="button" class="btn btn-primary mt-2" id="btn-finalizar">üíæ Finalizar Prescri√ß√£o</button>
</form>

<!-- Hist√≥rico -->
<div id="historico-prescricoes" class="mt-5">
  {% include 'partials/historico_prescricoes.html' %}
</div>

<script src="{{ url_for('static', filename='admin/modelos.js') }}"></script>
<style>
  .prescricao-item {
    cursor: grab;
  }

  .prescricao-item.dragging {
    opacity: 0.6;
  }

  .prescricao-item.drop-target {
    border: 2px dashed #198754;
  }

  .drag-handle {
    cursor: grab;
  }

  .historico-recarga-alert {
    border-style: dashed;
  }
</style>
<script src="{{ url_for('static', filename='js/unified-history-sync.js') }}"></script>
<script>
    let medicamentoSelecionado = null;
    let prescricoes = [];
    let prescricaoArrastando = null;

  function aplicarHistoricoPrescricoes(html) {
    const container = document.getElementById('historico-prescricoes');
    if (!container || !html) return false;

    container.innerHTML = html;

    if (typeof bindSyncForms === 'function') {
      bindSyncForms(container);
    }

    const alerta = container.querySelector('.historico-recarga-alert');
    if (alerta) {
      alerta.remove();
    }

    return true;
  }

  function sinalizarHistoricoDesatualizado(message) {
    const container = document.getElementById('historico-prescricoes');
    if (!container) return;

    let alerta = container.querySelector('.historico-recarga-alert');
    if (!alerta) {
      alerta = document.createElement('div');
      alerta.className = 'alert alert-warning d-flex align-items-center gap-2 historico-recarga-alert';
      container.prepend(alerta);
    }

    alerta.innerHTML = `<i class="bi bi-exclamation-triangle"></i><span>${message}</span>`;
  }

  async function recarregarHistoricoPrescricoes(options = {}) {
    const { showFailureNotice = true } = options;
    const container = document.getElementById('historico-prescricoes');
    if (!container) return false;

    const loading = document.createElement('div');
    loading.className = 'alert alert-info d-flex align-items-center gap-2 py-2 historico-recarga-alert';
    loading.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div><span>Atualizando hist√≥rico...</span>';
    container.prepend(loading);

    try {
      const resp = await fetch(`/consulta/{{ consulta.id }}/historico_prescricoes`, {
        headers: { 'Accept': 'application/json' }
      });

      if (!resp.ok) {
        throw new Error('Erro ao buscar hist√≥rico');
      }

      const data = await resp.json();
      if (!data?.success || !data.html) {
        throw new Error(data?.message || 'Hist√≥rico indispon√≠vel');
      }

      aplicarHistoricoPrescricoes(data.html);
      return true;
    } catch (error) {
      console.error('Erro ao recarregar hist√≥rico de prescri√ß√µes:', error);
      if (showFailureNotice) {
        mostrarFeedback('Prescri√ß√£o salva, mas n√£o foi poss√≠vel atualizar o hist√≥rico automaticamente.', 'warning');
        sinalizarHistoricoDesatualizado('Hist√≥rico n√£o p√¥de ser recarregado automaticamente. Atualize a p√°gina quando poss√≠vel.');
      }
      return false;
    } finally {
      if (loading?.parentNode) {
        loading.remove();
      }
    }
  }

  function toggleNovaMedicacao() {
    const container = document.getElementById('nova-medicacao-container');
    if (container.classList.contains('d-none')) {
      openMedicacaoCard(null);
    } else {
      container.classList.add('d-none');
    }

  }

  function openMedicacaoCard(med) {
    const container = document.getElementById('nova-medicacao-container');
    container.classList.remove('d-none');

    const sugestoesNova = document.getElementById('sugestoes-busca-nova');
    if (sugestoesNova) {
      sugestoesNova.innerHTML = '';
      sugestoesNova.style.display = 'none';
    }

    document.getElementById('buscar-medicamento-nova').value = med?.nome || '';
    document.getElementById('nova-medicacao-nome').value = med?.nome || '';
    document.getElementById('nova-medicacao-principio').value = med?.principio_ativo || '';
    document.getElementById('nova-medicacao-classificacao').value = med?.classificacao || '';
    document.getElementById('nova-medicacao-via').value = med?.via_administracao || '';
    document.getElementById('nova-medicacao-dosagem').value = med?.dosagem_recomendada || '';
    document.getElementById('nova-medicacao-frequencia').value = med?.frequencia || '';
    document.getElementById('nova-medicacao-duracao').value = med?.duracao_tratamento || '';
    document.getElementById('nova-medicacao-observacoes').value = med?.observacoes || '';
    document.getElementById('nova-medicacao-bula').value = med?.bula || '';

    medicamentoSelecionado = med?.id ? med : null;

    document.getElementById('btn-salvar-medicacao').classList.toggle('d-none', !!med?.id);
    document.getElementById('btn-editar-medicacao').classList.toggle('d-none', !med?.id);
    document.getElementById('btn-excluir-medicacao').classList.toggle('d-none', !med?.id);
  }

  function limparFormularioMedicamento() {
    document.getElementById('buscar-medicamento-nova').value = '';
    document.getElementById('nova-medicacao-nome').value = '';
    document.getElementById('nova-medicacao-principio').value = '';
    document.getElementById('nova-medicacao-classificacao').value = '';
    document.getElementById('nova-medicacao-via').value = '';
    document.getElementById('nova-medicacao-dosagem').value = '';
    document.getElementById('nova-medicacao-frequencia').value = '';
    document.getElementById('nova-medicacao-duracao').value = '';
    document.getElementById('nova-medicacao-observacoes').value = '';
    document.getElementById('nova-medicacao-bula').value = '';
  }

  async function salvarMedicamento() {
    const nome = document.getElementById('nova-medicacao-nome').value.trim();
    const principio = document.getElementById('nova-medicacao-principio').value.trim();
    const classificacao = document.getElementById('nova-medicacao-classificacao').value.trim();
    const via = document.getElementById('nova-medicacao-via').value.trim();
    const dosagem = document.getElementById('nova-medicacao-dosagem').value.trim();
    const frequencia = document.getElementById('nova-medicacao-frequencia').value.trim();
    const duracao = document.getElementById('nova-medicacao-duracao').value.trim();
    const observacoes = document.getElementById('nova-medicacao-observacoes').value.trim();
    const bula = document.getElementById('nova-medicacao-bula').value.trim();

    if (!nome) {
      mostrarFeedback('Informe o nome do medicamento.', 'warning');
      return;
    }

    const payload = {
      nome,
      principio_ativo: principio || null,
      classificacao: classificacao || null,
      via_administracao: via || null,
      dosagem_recomendada: dosagem || null,
      frequencia: frequencia || null,
      duracao_tratamento: duracao || null,
      observacoes: observacoes || null,
      bula: bula || null
    };

    const id = medicamentoSelecionado?.id;
    const url = id ? `/medicamento/${id}` : '/medicamento';
    const method = id ? 'PUT' : 'POST';

    try {
      const resp = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (!resp.ok || data.success === false) throw new Error(data.message || 'Erro');

      mostrarFeedback(id ? 'Medica√ß√£o atualizada!' : 'Medica√ß√£o cadastrada com sucesso!');

      document.getElementById('nova-medicacao-container').classList.add('d-none');
      limparFormularioMedicamento();

      if (id) {
        medicamentoSelecionado = { ...medicamentoSelecionado, ...payload };
        preencherCardMedicamento(medicamentoSelecionado);
      } else {
        medicamentoSelecionado = data;
        document.getElementById('nome-medicamento').value = data.nome;
        preencherCardMedicamento(data);
      }

      document.getElementById('dose').value = payload.dosagem_recomendada || '';
      document.getElementById('frequencia').value = payload.frequencia || '';
      document.getElementById('duracao').value = payload.duracao_tratamento || '';
    } catch (e) {
      mostrarFeedback('Erro ao salvar medica√ß√£o.', 'danger');
    }
  }

  async function excluirMedicamento() {
    if (!medicamentoSelecionado?.id) return;
    if (!confirm('Deseja realmente excluir este medicamento?')) return;
    try {
      const resp = await fetch(`/medicamento/${medicamentoSelecionado.id}`, { method: 'DELETE', headers: { 'X-CSRFToken': '{{ csrf_token() }}' } });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || data.success === false) throw new Error(data.message || 'Erro');

      mostrarFeedback('Medica√ß√£o exclu√≠da.');
      medicamentoSelecionado = null;
      document.getElementById('info-medicamento').classList.add('d-none');
      document.getElementById('nome-medicamento').value = '';
      limparFormularioMedicamento();
      document.getElementById('nova-medicacao-container').classList.add('d-none');
    } catch (e) {
      mostrarFeedback('Erro ao excluir medica√ß√£o.', 'danger');
    }
  }

  function editarMedicamentoSelecionado() {
    if (medicamentoSelecionado) {
      openMedicacaoCard(medicamentoSelecionado);
    }
  }

  // Fun√ß√£o para mostrar feedback ao usu√°rio
  function mostrarFeedback(mensagem, tipo = 'success') {
    const feedback = document.getElementById('feedback-message');
    feedback.textContent = mensagem;
    feedback.className = `alert alert-${tipo} d-block`;
    setTimeout(() => feedback.classList.add('d-none'), 3000);
  }

  // Debounce para evitar m√∫ltiplas requisi√ß√µes
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Preencher card de informa√ß√µes do medicamento
  function preencherCardMedicamento(m) {
    document.getElementById('med-nome-card').textContent = m.nome;
    document.getElementById('med-classificacao').textContent = m.classificacao || '‚Äì';
    document.getElementById('med-principio').textContent = m.principio_ativo || '‚Äì';
    document.getElementById('med-via').textContent = m.via_administracao || '‚Äì';
    document.getElementById('med-dosagem').textContent = m.dosagem_recomendada || '‚Äì';
    document.getElementById('med-frequencia').textContent = m.frequencia || '‚Äì';
    document.getElementById('med-duracao').textContent = m.duracao_tratamento || '‚Äì';
    document.getElementById('med-observacoes').textContent = m.observacoes || '‚Äì';
    
    const bulaLink = document.getElementById('med-bula');
    bulaLink.textContent = m.bula ? 'Ver bula' : '‚Äì';
    bulaLink.href = m.bula || '#';
    bulaLink.classList.toggle('text-decoration-none', !m.bula);
    bulaLink.classList.toggle('text-primary', m.bula);

    document.getElementById('info-medicamento').classList.remove('d-none');
  }

    

  // Alternar entre modos de prescri√ß√£o
  function alternarModo() {
    const custom = document.getElementById('modo-personalizado').checked;
    document.getElementById('modo-detalhado').classList.toggle('d-none', custom);
    document.getElementById('modo-simplificado').classList.toggle('d-none', !custom);
  }

  // Renderizar lista de prescri√ß√µes tempor√°rias
  function renderPrescricoesTemp() {
    const lista = document.getElementById('medicamentos-lista');
    
    if (prescricoes.length === 0) {
      lista.innerHTML = `
        <div class="text-center py-4 text-muted">
          <i class="bi bi-prescription2 fs-1"></i>
          <p class="mt-2">Nenhuma prescri√ß√£o adicionada</p>
        </div>
      `;
      return;
    }
    
    lista.innerHTML = prescricoes.map((p, i) => `
      <div class="card mb-2 prescricao-item" id="prescricao-${i}" draggable="true" data-index="${i}">
        <div class="card-body d-flex align-items-start">
          <div class="drag-handle text-muted me-3" aria-label="Reordenar prescri√ß√£o">
            <i class="bi bi-grip-vertical fs-4"></i>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title text-primary mb-1">${p.medicamento}</h6>
                <p class="card-text mb-2">${p.texto}</p>
              </div>
              <div class="text-end">
                <button class="btn btn-sm btn-warning me-2" onclick="editarPrescricao(${i})">‚úèÔ∏è Editar</button>
                <button class="btn btn-sm btn-outline-danger" onclick="removerPrescricao(${i})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `).join('');

    document.querySelectorAll('.prescricao-item').forEach((card) => {
      card.addEventListener('dragstart', iniciarArrastoPrescricao);
      card.addEventListener('dragover', permitirSoltarPrescricao);
      card.addEventListener('drop', soltarPrescricao);
      card.addEventListener('dragenter', destacarAlvoDrop);
      card.addEventListener('dragleave', removerDestaqueDrop);
      card.addEventListener('dragend', removerDestaqueDrop);
    });
  }

  function iniciarArrastoPrescricao(event) {
    prescricaoArrastando = Number(event.currentTarget.dataset.index);
    event.currentTarget.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', prescricaoArrastando);
  }

  function permitirSoltarPrescricao(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
  }

  function destacarAlvoDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drop-target');
  }

  function removerDestaqueDrop(event) {
    event.currentTarget.classList.remove('drop-target', 'dragging');
  }

  function soltarPrescricao(event) {
    event.preventDefault();
    const origem = prescricaoArrastando ?? Number(event.dataTransfer.getData('text/plain'));
    const destino = Number(event.currentTarget.dataset.index);

    if (Number.isNaN(origem) || Number.isNaN(destino) || origem === destino) {
      renderPrescricoesTemp();
      return;
    }

    const [itemMovido] = prescricoes.splice(origem, 1);
    prescricoes.splice(destino, 0, itemMovido);
    prescricaoArrastando = null;
    renderPrescricoesTemp();
  }

  // Validar campos antes de adicionar
  function validarCampos() {
    const nome = document.getElementById('nome-medicamento').value.trim();
    if (!nome) {
      mostrarFeedback('Informe o nome do medicamento.', 'danger');
      return false;
    }
    
    const modoPersonalizado = document.getElementById('modo-personalizado').checked;
    if (modoPersonalizado) {
      const texto = document.getElementById('instrucao-unica').value.trim();
      if (!texto) {
        mostrarFeedback('Escreva a prescri√ß√£o personalizada.', 'danger');
        return false;
      }
    } else {
      const frequencia = document.getElementById('frequencia').value.trim();
      const dose = document.getElementById('dose').value.trim();
      const duracao = document.getElementById('duracao').value.trim();
      
      if (!frequencia || !dose || !duracao) {
        mostrarFeedback('Preencha todos os campos obrigat√≥rios.', 'danger');
        return false;
      }
    }
    
    return true;
  }

  // Adicionar medicamento √† lista
  function adicionarMedicamento() {
    if (!validarCampos()) return;

    const nome = document.getElementById('nome-medicamento').value.trim();
    const modoPersonalizado = document.getElementById('modo-personalizado').checked;

    let observacoes = '';
    let texto = '';
    let dose = '';
    let frequencia = '';
    let duracao = '';

    if (modoPersonalizado) {
      observacoes = document.getElementById('instrucao-unica').value.trim();
      texto = observacoes;
    } else {
      frequencia = document.getElementById('frequencia').value.trim();
      dose = document.getElementById('dose').value.trim();
      duracao = document.getElementById('duracao').value.trim();
      texto = `${dose}, ${frequencia}, por ${duracao}`;
    }

    prescricoes.push({
      medicamento: nome,
      texto: texto,
      dosagem: dose || '',
      frequencia: frequencia || '',
      duracao: duracao || '',
      observacoes: observacoes || ''
    });

    renderPrescricoesTemp();
    mostrarFeedback('Prescri√ß√£o adicionada com sucesso!');

    // Limpar campos
    document.getElementById('nome-medicamento').value = '';
    document.getElementById('instrucao-unica').value = '';
    document.getElementById('frequencia').value = '';
    document.getElementById('dose').value = '';
    document.getElementById('duracao').value = '';
    document.getElementById('info-medicamento').classList.add('d-none');
    medicamentoSelecionado = null;
  }

  // Remover prescri√ß√£o da lista
  function removerPrescricao(i) {
    prescricoes.splice(i, 1);
    renderPrescricoesTemp();
    mostrarFeedback('Prescri√ß√£o removida.', 'warning');
  }

  function editarPrescricao(i) {
    const card = document.getElementById(`prescricao-${i}`);
    const p = prescricoes[i];
    if (!card || !p) return;
    card.innerHTML = `
      <div class="card-body">
        <div class="mb-2">
          <label class="form-label">Nome do Medicamento</label>
          <input type="text" class="form-control" id="edit-med-${i}" value="${p.medicamento}">
        </div>
        <div class="mb-2">
          <label class="form-label">Prescri√ß√£o</label>
          <textarea class="form-control" id="edit-texto-${i}">${p.texto}</textarea>
        </div>
        <button class="btn btn-sm btn-success me-2" onclick="salvarEdicaoPrescricao(${i})">üíæ Salvar</button>
        <button class="btn btn-sm btn-secondary" onclick="renderPrescricoesTemp()">Cancelar</button>
      </div>`;
  }

  function salvarEdicaoPrescricao(i) {
    const medicamento = document.getElementById(`edit-med-${i}`)?.value.trim();
    const texto = document.getElementById(`edit-texto-${i}`)?.value.trim();
    if (!medicamento || !texto) {
      mostrarFeedback('Preencha nome e prescri√ß√£o.', 'danger');
      return;
    }
    const original = prescricoes[i] || {};
    prescricoes[i] = {
      ...original,
      medicamento,
      texto,
      observacoes: original.observacoes ? texto : original.observacoes
    };
    renderPrescricoesTemp();
  }

  // Finalizar e salvar todas as prescri√ß√µes
  /**
   * SIMPLIFIED & UNIFIED: Save prescriptions and update history
   * Uses the centralized HistorySyncManager for guaranteed reliability
   */
  async function finalizarBlocoPrescricoes() {
    const btn = document.getElementById('btn-finalizar');
    if (!btn) {
      console.error('Bot√£o de finalizar n√£o encontrado');
      mostrarFeedback('Erro: bot√£o n√£o encontrado', 'danger');
      return;
    }

    // Prepare data
    const instrucoes = document.getElementById('instrucoes-medicamentos')?.value || '';
    if (prescricoes.length === 0 && !instrucoes.trim()) {
      mostrarFeedback('Adicione pelo menos um medicamento ou instru√ß√µes gerais.', 'warning');
      return;
    }
    const data = {
      prescricoes,
      instrucoes_gerais: instrucoes
    };

    // Use unified system to save and update history
    const result = await window.HistorySyncManager.saveAndUpdateHistory(
      `/consulta/{{ consulta.id }}/bloco_prescricao`,
      data,
      'historico-prescricoes',
      btn,
      {
        successMessage: 'Prescri√ß√£o salva com sucesso! ‚úÖ',
        errorMessage: 'Erro ao salvar prescri√ß√£o',
        timeoutMs: 10000,
        disableFormAfterSuccess: false,
        onSuccess: (result) => {
          // Reset the form state
          prescricoes = [];
          renderPrescricoesTemp();
        },
        onError: (error) => {
          console.error('Falha ao salvar prescri√ß√£o:', error);
        }
      }
    );

    return result;
  }

  // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      const input = document.getElementById('nome-medicamento');
      const sugestoes = document.getElementById('sugestoes-medicamentos');
      const buscarNova = document.getElementById('buscar-medicamento-nova');
      const sugestoesNova = document.getElementById('sugestoes-busca-nova');

    // Busca de medicamentos com debounce
    input.addEventListener('input', debounce(function() {
      const q = this.value.trim();
      if (q.length < 2) {
        sugestoes.innerHTML = '';
        sugestoes.style.display = 'none';
        return;
      }

      sugestoes.innerHTML = '<li class="list-group-item text-muted">Buscando...</li>';
      sugestoes.style.display = 'block';

      fetch(`/buscar_medicamentos?q=${encodeURIComponent(q)}`)
        .then(res => {
          if (!res.ok) throw new Error('Erro na busca');
          return res.json();
        })
        .then(data => {
          sugestoes.innerHTML = '';

          if (data.length === 0) {
            const none = document.createElement('li');
            none.className = 'list-group-item text-muted';
            none.textContent = 'Nenhum medicamento encontrado';
            sugestoes.appendChild(none);
          } else {
            data.forEach(item => {
              const li = document.createElement('li');
              li.className = 'list-group-item list-group-item-action';
              li.textContent = item.nome;
              li.onclick = () => {
                medicamentoSelecionado = item;
                preencherCardMedicamento(item);
                input.value = item.nome;
                document.getElementById('dose').value = item.dosagem_recomendada || '';
                document.getElementById('frequencia').value = item.frequencia || '';
                document.getElementById('duracao').value = item.duracao_tratamento || '';
                sugestoes.innerHTML = '';
                sugestoes.style.display = 'none';
              };
              sugestoes.appendChild(li);
            });
          }

            const addLi = document.createElement('li');
            addLi.className = 'list-group-item list-group-item-action text-primary';
            addLi.textContent = 'Adicionar medica√ß√£o';
            addLi.onclick = () => {
              openMedicacaoCard({ nome: input.value.trim() });
              sugestoes.style.display = 'none';
            };
            sugestoes.appendChild(addLi);
        })
        .catch(err => {
          sugestoes.innerHTML = '<li class="list-group-item text-danger">Erro ao buscar medicamentos</li>';
          console.error("Erro ao buscar medicamentos:", err);
        });
    }, 300));

    // Busca dentro do card de nova medica√ß√£o
    buscarNova.addEventListener('input', debounce(function() {
      const q = this.value.trim();
      if (q.length < 2) {
        sugestoesNova.innerHTML = '';
        sugestoesNova.style.display = 'none';
        return;
      }

      sugestoesNova.innerHTML = '<li class="list-group-item text-muted">Buscando...</li>';
      sugestoesNova.style.display = 'block';

      fetch(`/buscar_medicamentos?q=${encodeURIComponent(q)}`)
        .then(res => {
          if (!res.ok) throw new Error('Erro na busca');
          return res.json();
        })
        .then(data => {
          sugestoesNova.innerHTML = '';
          if (data.length === 0) {
            const none = document.createElement('li');
            none.className = 'list-group-item text-muted';
            none.textContent = 'Nenhum medicamento encontrado';
            sugestoesNova.appendChild(none);
          } else {
            data.forEach(item => {
              const li = document.createElement('li');
              li.className = 'list-group-item list-group-item-action';
              li.textContent = item.nome;
              li.onclick = () => {
                openMedicacaoCard(item);
                sugestoesNova.innerHTML = '';
                sugestoesNova.style.display = 'none';
              };
              sugestoesNova.appendChild(li);
            });
          }
        })
        .catch(err => {
          sugestoesNova.innerHTML = '<li class="list-group-item text-danger">Erro ao buscar medicamentos</li>';
          console.error('Erro ao buscar medicamentos:', err);
        });
    }, 300));

    // Fechar sugest√µes ao clicar fora
    document.addEventListener('click', function(e) {
      if (e.target !== input) {
        sugestoes.style.display = 'none';
      }
      if (e.target !== buscarNova) {
        sugestoesNova.style.display = 'none';
      }
    });

    // Alternador de modo
    document.getElementById('modo-personalizado').addEventListener('change', alternarModo);
    
    // Bot√µes
      document.getElementById('btn-adicionar').addEventListener('click', adicionarMedicamento);
      document.getElementById('btn-finalizar').addEventListener('click', finalizarBlocoPrescricoes);
    });
</script>

<style>
  /* Melhorias visuais */
  #sugestoes-medicamentos,
  #sugestoes-busca-nova {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-radius: 0.25rem;
  }

  #sugestoes-medicamentos .list-group-item:hover,
  #sugestoes-busca-nova .list-group-item:hover {
    background-color: #f8f9fa;
    cursor: pointer;
  }
  
  #modo-detalhado, #modo-simplificado {
    transition: opacity 0.3s ease;
  }
  
  .card-title.text-primary {
    font-weight: 600;
  }
</style>
