<form>
  <h5 class="mb-3">Prescri√ß√£o de Medicamentos</h5>

  <!-- Campo com autocomplete -->
  <div class="mb-3 position-relative">
    <label for="nome-medicamento" class="form-label">Nome do Medicamento</label>
    <input type="text" id="nome-medicamento" class="form-control" placeholder="Ex: Dipirona, Doxiciclina...">
    <ul id="sugestoes-medicamentos" class="list-group position-absolute w-100" style="z-index: 10;"></ul>
  </div>

  <!-- Card de informa√ß√µes do medicamento -->
  <div id="info-medicamento" class="card border-success mb-3 d-none">
    <div class="card-body">
      <h5 class="card-title" id="med-nome-card"></h5>
      <p><strong>Classifica√ß√£o:</strong> <span id="med-classificacao"></span></p>
      <p><strong>Via:</strong> <span id="med-via"></span></p>
      <p><strong>Dosagem Recomendada:</strong> <span id="med-dosagem"></span></p>
      <p><strong>Dura√ß√£o Recomendada:</strong> <span id="med-duracao"></span></p>
      <p><strong>Observa√ß√µes:</strong> <span id="med-observacoes"></span></p>
      <p><strong>Bula:</strong> <a id="med-bula" href="#" target="_blank"></a></p>
    </div>
  </div>

  <!-- Alternador de modo -->
  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" id="modo-personalizado" onchange="alternarModo()">
    <label class="form-check-label" for="modo-personalizado">Usar campo √∫nico de prescri√ß√£o personalizada</label>
  </div>

  <!-- Modo detalhado -->
  <div id="modo-detalhado">
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="dose" class="form-label">Dose</label>
        <input type="text" id="dose" class="form-control" placeholder="Ex: 25mg/kg">
      </div>
      <div class="col-md-4">
        <label for="frequencia" class="form-label">Frequ√™ncia</label>
        <input type="text" id="frequencia" class="form-control" placeholder="Ex: 2x ao dia">
      </div>
      <div class="col-md-4">
        <label for="duracao" class="form-label">Dura√ß√£o</label>
        <input type="text" id="duracao" class="form-control" placeholder="Ex: 5 dias">
      </div>
    </div>
  </div>

  <!-- Modo personalizado -->
  <div id="modo-simplificado" class="mb-3 d-none">
    <label for="instrucao-unica" class="form-label">Prescri√ß√£o personalizada</label>
    <textarea id="instrucao-unica" class="form-control" rows="2" placeholder="Ex: Administrar 25mg/kg de 12/12h por 3 dias."></textarea>
  </div>

  <!-- Bot√£o para adicionar √† lista -->
  <button type="button" class="btn btn-success mb-4" onclick="adicionarMedicamento()">‚ûï Adicionar Prescri√ß√£o</button>

  <!-- Lista tempor√°ria -->
  <div id="medicamentos-lista" class="mb-4"></div>

  <!-- Instru√ß√µes gerais -->
  <div class="mb-3">
    <label for="instrucoes-medicamentos" class="form-label">Instru√ß√µes Gerais</label>
    <textarea id="instrucoes-medicamentos" class="form-control" rows="3"></textarea>
  </div>

  <!-- Bot√£o para finalizar -->
  <button type="button" class="btn btn-primary mt-2" onclick="finalizarBlocoPrescricoes()">üíæ Finalizar Prescri√ß√£o</button>
</form>

<!-- Hist√≥rico -->
<div id="historico-prescricoes" class="mt-5">
  {% include 'partials/historico_prescricoes.html' %}
</div>

<script>
  let medicamentoSelecionado = null;
  let prescricoes = [];

  document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('nome-medicamento');
    const sugestoes = document.getElementById('sugestoes-medicamentos');

    input.addEventListener('input', function () {
      const q = this.value.trim();
      if (q.length < 2) {
        sugestoes.innerHTML = '';
        return;
      }

      fetch(`/buscar_medicamentos?q=${encodeURIComponent(q)}`)
        .then(res => res.json())
        .then(data => {
          sugestoes.innerHTML = '';
          data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action';
            li.textContent = item.nome;
            li.onclick = () => {
              medicamentoSelecionado = item;
              preencherCardMedicamento(medicamentoSelecionado);
              input.value = item.nome;
              document.getElementById('dose').value = item.dosagem_recomendada || '';
              document.getElementById('duracao').value = item.duracao_tratamento || '';
              sugestoes.innerHTML = '';
            };
            sugestoes.appendChild(li);
          });
        })
        .catch(err => console.error("Erro ao buscar medicamentos:", err));
    });
  });

  renderPrescricoesTemp();

  function preencherCardMedicamento(m) {
    document.getElementById('med-nome-card').textContent = m.nome;
    document.getElementById('med-classificacao').textContent = m.classificacao || '‚Äì';
    document.getElementById('med-via').textContent = m.via_administracao || '‚Äì';
    document.getElementById('med-dosagem').textContent = m.dosagem_recomendada || '‚Äì';
    document.getElementById('med-duracao').textContent = m.duracao_tratamento || '‚Äì';
    document.getElementById('med-observacoes').textContent = m.observacoes || '‚Äì';
    document.getElementById('med-bula').textContent = m.bula ? 'Ver bula' : '‚Äì';
    document.getElementById('med-bula').href = m.bula || '#';

    // Mostrar card de informa√ß√µes
    document.getElementById('info-medicamento').classList.remove('d-none');
  }

  function alternarModo() {
    const custom = document.getElementById('modo-personalizado').checked;
    document.getElementById('modo-detalhado').classList.toggle('d-none', custom);
    document.getElementById('modo-simplificado').classList.toggle('d-none', !custom);
  }

  function renderPrescricoesTemp() {
    const lista = document.getElementById('medicamentos-lista');
    lista.innerHTML = '';

    prescricoes.forEach((p, i) => {
      const div = document.createElement('div');
      div.className = 'border p-2 mb-2';
      div.innerHTML = `
        üíä <strong>${p.medicamento}</strong><br>
        <em>${p.texto}</em><br>
        <button class="btn btn-sm btn-danger mt-1" onclick="removerPrescricao(${i})">üóëÔ∏è Remover</button>
      `;
      lista.appendChild(div);
    });
  }

  function adicionarMedicamento() {
    const nome = document.getElementById('nome-medicamento').value.trim();
    const modoPersonalizado = document.getElementById('modo-personalizado').checked;

    if (!nome) {
      alert('Informe o nome do medicamento.');
      return;
    }

    const observacoes = document.getElementById('instrucao-unica').value.trim();
    let texto = '';
    let dose = '';
    let frequencia = '';
    let duracao = '';

    if (modoPersonalizado) {
      texto = observacoes;
      if (!texto) return alert('Escreva a prescri√ß√£o personalizada.');
    } else {
      frequencia = document.getElementById('frequencia').value.trim();
      dose = document.getElementById('dose').value.trim();
      duracao = document.getElementById('duracao').value.trim();
      if (!frequencia || !dose || !duracao) return alert('Preencha frequ√™ncia, dose e dura√ß√£o.');
      texto = `${dose}, ${frequencia}, por ${duracao}`;
    }

    prescricoes.push({
      medicamento: nome,
      texto: texto,
      dosagem: dose || '',
      frequencia: frequencia || '',
      duracao: duracao || '',
      observacoes: observacoes || ''
    });

    renderPrescricoesTemp();

    // Limpar campos
    document.getElementById('nome-medicamento').value = '';
    document.getElementById('instrucao-unica').value = '';
    document.getElementById('frequencia').value = '';
    document.getElementById('dose').value = '';
    document.getElementById('duracao').value = '';
    document.getElementById('info-medicamento').classList.add('d-none');
  }

  function removerPrescricao(i) {
    prescricoes.splice(i, 1);
    renderPrescricoesTemp();
  }

  function finalizarBlocoPrescricoes() {
    const instrucoes = document.getElementById('instrucoes-medicamentos')?.value || '';

    if (prescricoes.length === 0) {
      alert('Adicione pelo menos um medicamento.');
      return;
    }

    fetch(`/consulta/{{ consulta.id }}/bloco_prescricao`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prescricoes,
        instrucoes_gerais: instrucoes
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('Prescri√ß√£o salva com sucesso!');
        location.reload();
      } else {
        alert('Erro ao salvar prescri√ß√£o.');
      }
    })
    .catch(err => {
      console.error('Erro na requisi√ß√£o:', err);
      alert('Erro ao salvar prescri√ß√£o.');
    });
  }
</script>
