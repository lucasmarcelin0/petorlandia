<div id="retorno-container">
{% if consulta and consulta.appointment %}
  <div id="retorno-card" class="card mt-4" data-appointment-id="{{ consulta.appointment.id }}">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <i class="bi bi-calendar-event"></i>
        Retorno marcado para {{ consulta.appointment.scheduled_at|format_datetime_brazil('%d/%m/%Y %H:%M') }}.
      </div>
      <div class="d-flex gap-2">
        <a href="#" class="card-link editar-retorno">Editar</a>
        <form method="POST"
              action="{{ url_for('delete_appointment', appointment_id=consulta.appointment.id) }}"
              class="d-inline delete-appointment-form" data-sync data-target="retorno-container">
          <button type="submit" class="btn btn-link p-0 card-link">Excluir</button>
        </form>
        <a href="{{ url_for('consulta_direct', animal_id=animal.id) }}" class="card-link start-return-link">Iniciar retorno</a>
      </div>
    </div>
  </div>
  <form id="edit-return-form" class="row g-3 mt-3 d-none" data-appointment-id="{{ consulta.appointment.id }}">
    <div class="col-md-6">
      {{ appointment_form.veterinario_id.label(class='form-label') }}
      {{ appointment_form.veterinario_id(class='form-select', value=consulta.appointment.veterinario_id) }}
    </div>
    <div class="col-md-3">
      {{ appointment_form.date.label(class='form-label') }}
      {{ appointment_form.date(class='form-control', type='date', value=consulta.appointment.scheduled_at|format_datetime_brazil('%Y-%m-%d')) }}
    </div>
    <div class="col-md-3">
      {{ appointment_form.time.label(class='form-label') }}
      {{ appointment_form.time(class='form-control', type='time', value=consulta.appointment.scheduled_at|format_datetime_brazil('%H:%M')) }}
    </div>
    <div class="col-12">
      {{ appointment_form.kind.label(class='form-label') }}
      {{ appointment_form.kind(class='form-select', value=consulta.appointment.kind) }}
    </div>
    <div class="col-12">
      {{ appointment_form.reason.label(class='form-label') }}
      {{ appointment_form.reason(class='form-control', rows=3, value=consulta.appointment.notes or '') }}
    </div>
    <div class="col-12 d-flex gap-2">
      <button type="submit" class="btn btn-primary">Salvar</button>
      <button type="button" class="btn btn-outline-secondary cancelar-retorno">Cancelar</button>
    </div>
  </form>
{% elif consulta and appointment_form %}
  <hr class="my-4">
  <button type="button" class="btn btn-outline-primary mb-3" id="toggle-retorno-form">Agendar Retorno</button>
  <form id="agendar-retorno-form" method="POST" action="{{ url_for('agendar_retorno', consulta_id=consulta.id) }}" class="row g-3 d-none">
    <h5 class="mb-3">Agendar Retorno</h5>
    {{ appointment_form.hidden_tag() }}
    <input type="hidden" name="animal_id" value="{{ animal.id }}">
    <div class="col-md-6">
      {{ appointment_form.veterinario_id.label(class='form-label') }}
      {{ appointment_form.veterinario_id(class='form-select') }}
    </div>
    <div class="col-md-6">
      {{ appointment_form.date.label(class='form-label') }}
      {{ appointment_form.date(class='form-control', type='date') }}
    </div>
    <div class="col-md-6">
      {{ appointment_form.time.label(class='form-label') }}
      {{ appointment_form.time(class='form-control', type='time') }}
    </div>
    <div class="col-12">
      {{ appointment_form.kind.label(class='form-label') }}
      {{ appointment_form.kind(class='form-select') }}
    </div>
    <div class="col-12">
      {{ appointment_form.reason.label(class='form-label') }}
      {{ appointment_form.reason(class='form-control', rows=3) }}
    </div>
    <div class="col-12">
      {{ appointment_form.submit(class='btn btn-primary') }}
    </div>
  </form>
{% endif %}
</div>
