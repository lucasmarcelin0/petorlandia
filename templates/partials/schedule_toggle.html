<div class="card mb-4">
  <div class="card-header d-flex justify-content-center">
    {% set default_source = 'clinic' if clinic_id else 'user' %}
    <div class="btn-group" id="agenda-toggle">
      <button class="btn btn-outline-primary {% if default_source == 'user' %}active{% endif %}" data-source="user">Minha Agenda</button>
      {% if clinic_id %}
      <button class="btn btn-outline-primary {% if default_source == 'clinic' %}active{% endif %}" data-source="clinic">Agenda da Cl√≠nica</button>
      {% endif %}
    </div>
  </div>
  <div class="card-body p-0">
    <div id="shared-calendar"></div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('shared-calendar');
  const toggle = document.getElementById('agenda-toggle');
  let source = '{{ default_source }}';

  function eventUrl() {
    if (source === 'clinic') {
      return '/api/clinic_appointments/{{ clinic_id }}';
    }
    return '/api/my_appointments';
  }

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    events: eventUrl(),
  });

  window.sharedCalendar = calendar;
  calendar.render();

  if (toggle) {
    toggle.querySelectorAll('button').forEach(function(btn) {
      btn.addEventListener('click', function() {
        toggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        source = this.dataset.source;
        calendar.setOption('events', eventUrl());
        calendar.refetchEvents();
      });
    });
  }
});
</script>
