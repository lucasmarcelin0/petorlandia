{% set calendar_id = calendar_id|default('shared-calendar') %}
{% set toggle_id = toggle_id|default('agenda-toggle') %}
{% set vet_select_id = toggle_id ~ '-vet-selector' %}
{% set available_vets = vets|default([]) %}
{% set initial_source = 'clinic' if clinic_id else 'user' %}
{% set current_role = current_user.role if current_user.is_authenticated else None %}
{% set current_worker = current_user.worker if current_user.is_authenticated else None %}
{% set view_as_param = request.args.get('view_as') if request else None %}
{% set show_vet_selector = (current_worker == 'colaborador') or (current_role == 'admin' and view_as_param == 'colaborador') %}

<div class="card mb-4">
  <div class="card-header d-flex flex-wrap align-items-center justify-content-center gap-2">
    <div class="btn-group" id="{{ toggle_id }}">
      <button class="btn btn-outline-primary{% if not clinic_id %} active{% endif %}" data-source="user">Minha Agenda</button>
      {% if clinic_id %}
      <button class="btn btn-outline-primary{% if clinic_id %} active{% endif %}" data-source="clinic">Agenda da Cl√≠nica</button>
      {% endif %}
    </div>
    {% if show_vet_selector %}
    <div class="d-flex align-items-center gap-2 ms-lg-auto" data-collaborator-schedule-picker>
      <label for="{{ vet_select_id }}" class="visually-hidden">Selecionar agenda</label>
      <select id="{{ vet_select_id }}" class="form-select form-select-sm w-auto" aria-label="Selecionar agenda">
        <option value="user"{% if initial_source == 'user' %} selected{% endif %}>Minha agenda</option>
        <option value="clinic"{% if not clinic_id %} disabled{% endif %}{% if initial_source == 'clinic' %} selected{% endif %}>Agenda da cl√≠nica</option>
        {% for vet in available_vets %}
        <option value="vet:{{ vet.id }}">{{ vet.user.name if vet.user else 'Veterin√°rio #' ~ vet.id }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
  </div>
  <div class="card-body p-0">
    <div id="{{ calendar_id }}" data-calendar-redirect-url="{{ calendar_redirect_url|default('') }}"></div>
  </div>
  <div class="card-footer bg-light small text-muted text-center">
    üí° Clique em um dia do calend√°rio para iniciar um novo agendamento.
  </div>
</div>

{% if include_assets|default(True) %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('{{ calendar_id }}');
  const toggle = document.getElementById('{{ toggle_id }}');
  const vetSelect = document.getElementById('{{ vet_select_id }}');
  const userPicker = document.getElementById('admin-agenda-user-picker');
  const hiddenVetInput = (function() {
    if (userPicker && typeof userPicker.closest === 'function') {
      const form = userPicker.closest('[data-admin-agenda-switcher]');
      if (form) {
        return form.querySelector('[data-switcher-vet]');
      }
    }
    return document.querySelector('[data-switcher-vet]');
  })();
  const hiddenColabInput = (function() {
    if (userPicker && typeof userPicker.closest === 'function') {
      const form = userPicker.closest('[data-admin-agenda-switcher]');
      if (form) {
        return form.querySelector('[data-switcher-colab]');
      }
    }
    return document.querySelector('[data-switcher-colab]');
  })();
  const csrfToken = '{{ csrf_token() if csrf_token is defined else '' }}';
  const defaultSource = '{{ 'clinic' if clinic_id else 'user' }}';
  let source = defaultSource;
  let selectedUserId = resolveInitialUserId();
  let selectedVetId = resolveInitialVetId();
  updateSelectedVetContext(selectedVetId);
  let calendar;

  if (typeof window !== 'undefined') {
    window.sharedCalendarEvents = window.sharedCalendarEvents || [];
  }

  if (!calendarEl) {
    return;
  }

  function extractNumericUserId(rawValue) {
    if (rawValue === undefined || rawValue === null) {
      return null;
    }
    const normalized = String(rawValue).trim();
    if (!normalized) {
      return null;
    }
    const parts = normalized.split(':');
    const numericPart = parts.length > 1 ? parts[1] : parts[0];
    const parsed = parseInt(numericPart, 10);
    if (Number.isNaN(parsed)) {
      return null;
    }
    return parsed;
  }

  function resolveInitialUserId() {
    const pickerValue = userPicker ? extractNumericUserId(userPicker.value) : null;
    if (pickerValue !== null) {
      return pickerValue;
    }
    if (!vetSelect && hiddenVetInput) {
      const vetValue = extractNumericUserId(hiddenVetInput.value);
      if (vetValue !== null) {
        return vetValue;
      }
    }
    if (hiddenColabInput) {
      const colabValue = extractNumericUserId(hiddenColabInput.value);
      if (colabValue !== null) {
        return colabValue;
      }
    }
    return null;
  }

  function resolveInitialVetId() {
    if (vetSelect) {
      const selectValue = String(vetSelect.value || '').trim();
      if (selectValue.toLowerCase().startsWith('vet:')) {
        const vetValue = extractNumericUserId(selectValue);
        if (vetValue !== null) {
          return vetValue;
        }
      }
    }
    if (hiddenVetInput) {
      const vetValue = extractNumericUserId(hiddenVetInput.value);
      if (vetValue !== null) {
        return vetValue;
      }
    }
    return null;
  }

  function updateSelectedVetContext(vetId) {
    if (!calendarEl) {
      return;
    }
    if (vetId === null || vetId === undefined || vetId === '') {
      delete calendarEl.dataset.veterinarioId;
      return;
    }
    calendarEl.dataset.veterinarioId = vetId;
  }

  function eventUrl() {
    if (source === 'clinic') {
      return '/api/clinic_appointments/{{ clinic_id }}';
    }
    if (source === 'vet') {
      const vetId = extractNumericUserId(selectedVetId);
      if (vetId !== null) {
        return `/api/vet_appointments/${vetId}`;
      }
    }
    const userId = extractNumericUserId(selectedUserId);
    if (userId !== null) {
      return `/api/user_appointments/${userId}`;
    }
    return '/api/my_appointments';
  }

  function addEvents() {
    calendar.removeAllEventSources();
    calendar.addEventSource(eventUrl());
  }

  function setActiveButton(targetSource, options) {
    if (toggle) {
      toggle.querySelectorAll('button').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.source === targetSource);
      });
    }
    if (!vetSelect) {
      return;
    }
    const selectOptions = Array.from(vetSelect.options || []);
    if (targetSource === 'user' || targetSource === 'clinic') {
      const matchingOption = selectOptions.find(function(option) {
        return option.value === targetSource;
      });
      if (matchingOption) {
        vetSelect.value = matchingOption.value;
      }
      return;
    }
    if (targetSource === 'vet') {
      const vetIdValue = options && Object.prototype.hasOwnProperty.call(options, 'vetId')
        ? options.vetId
        : selectedVetId;
      if (vetIdValue !== null && vetIdValue !== undefined) {
        const targetValue = `vet:${vetIdValue}`;
        const matchingVetOption = selectOptions.find(function(option) {
          return option.value === targetValue;
        });
        if (matchingVetOption) {
          vetSelect.value = matchingVetOption.value;
          return;
        }
      }
    }
    const fallbackOption = selectOptions.find(function(option) {
      return option.value === defaultSource;
    }) || selectOptions.find(function(option) {
      return option.value === 'user';
    });
    if (fallbackOption) {
      vetSelect.value = fallbackOption.value;
    }
  }

  function pad(value) {
    return String(value).padStart(2, '0');
  }

  function formatLocalDate(dateObj) {
    return [
      dateObj.getFullYear(),
      pad(dateObj.getMonth() + 1),
      pad(dateObj.getDate())
    ].join('-');
  }

  function getEventType(event) {
    if (!event) {
      return null;
    }
    const type = event.extendedProps && event.extendedProps.eventType;
    if (type) {
      return type;
    }
    if (typeof event.id === 'string') {
      const prefix = event.id.split('-')[0];
      return prefix || null;
    }
    return 'appointment';
  }

  function getAppointmentId(event) {
    if (!event) {
      return null;
    }
    if (event.extendedProps && event.extendedProps.recordId) {
      return event.extendedProps.recordId;
    }
    if (typeof event.id === 'string') {
      const match = event.id.match(/^(?:appointment-)?(\d+)$/);
      if (match) {
        return parseInt(match[1], 10);
      }
    }
    if (typeof event.id === 'number') {
      return event.id;
    }
    return null;
  }

  function inferApproximateTime(dateObj, isAllDay) {
    if (isAllDay) {
      return '09:00';
    }
    return `${pad(dateObj.getHours())}:${pad(dateObj.getMinutes())}`;
  }

  function emitSlotChosen(dateObj, isAllDay) {
    if (!dateObj) {
      return;
    }
    const detail = {
      date: formatLocalDate(dateObj),
      time: inferApproximateTime(dateObj, isAllDay),
      allDay: !!isAllDay,
      source,
    };
    if (source === 'vet' && selectedVetId !== null && selectedVetId !== undefined) {
      detail.vetId = selectedVetId;
    }
    const customEvent = new CustomEvent('calendarSlotChosen', {
      detail,
      bubbles: true,
    });
    calendarEl.dispatchEvent(customEvent);
  }

  function toSharedEventObject(eventApi) {
    if (!eventApi) {
      return null;
    }
    const extended = Object.assign({}, eventApi.extendedProps || {});
    const eventType = extended.eventType || extended.type || eventApi.type || null;
    return {
      id: eventApi.id || null,
      title: eventApi.title || '',
      start: eventApi.start ? eventApi.start.toISOString() : (eventApi.startStr || null),
      end: eventApi.end ? eventApi.end.toISOString() : (eventApi.endStr || null),
      allDay: !!eventApi.allDay,
      type: eventType,
      extendedProps: extended,
    };
  }

  function dispatchSharedCalendarEvents(events) {
    const normalized = (events || []).map(function(item) {
      if (item && typeof item.start === 'string') {
        const plain = Object.assign({
          id: item.id || null,
          title: item.title || '',
          start: item.start || null,
          end: item.end || null,
          allDay: !!item.allDay,
        }, item);
        const extended = Object.assign({}, plain.extendedProps || {});
        if (!plain.type) {
          const derivedType = extended.eventType || extended.type;
          if (derivedType) {
            plain.type = derivedType;
          }
        }
        plain.extendedProps = extended;
        return plain;
      }
      return toSharedEventObject(item);
    }).filter(Boolean);

    if (typeof window !== 'undefined') {
      window.sharedCalendarEvents = normalized;
    }
    document.dispatchEvent(new CustomEvent('sharedCalendarEvents', {
      detail: { events: normalized },
    }));
  }

  function announceSharedCalendarReady(instance) {
    document.dispatchEvent(new CustomEvent('sharedCalendarReady', {
      detail: { calendar: instance },
    }));
  }

  async function persistEventChange(info) {
    if (!calendar) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      return;
    }

    const event = info.event;
    if (!event || !event.start) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      return;
    }

    const payload = {
      start: event.start ? event.start.toISOString() : null,
      end: event.end ? event.end.toISOString() : null,
    };

    const eventType = getEventType(event);
    const appointmentId = getAppointmentId(event);
    if (eventType !== 'appointment' || !appointmentId) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      return;
    }

    try {
      const response = await fetch(`/api/appointments/${appointmentId}/reschedule`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok || !data.success) {
        const message = data && data.message ? data.message : 'N√£o foi poss√≠vel reagendar este compromisso.';
        throw new Error(message);
      }
      calendar.refetchEvents();
    } catch (error) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      const message = (error && error.message) ? error.message : 'Ocorreu um erro ao reagendar este compromisso.';
      window.alert(message);
    }
  }

  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: true,
    selectMirror: true,
    editable: true,
    eventDurationEditable: true,
    select: function(info) {
      emitSlotChosen(info.start, info.allDay);
      calendar.unselect();
    },
    dateClick: function(info) {
      emitSlotChosen(info.date, info.allDay);
    },
    eventDrop: persistEventChange,
    eventResize: persistEventChange,
    eventAllow: function(dropInfo, draggedEvent) {
      return getEventType(draggedEvent) === 'appointment';
    },
    eventsSet: function(eventList) {
      dispatchSharedCalendarEvents(eventList);
    },
    eventDidMount: function(info) {
      const type = getEventType(info.event);
      if (info.el && type) {
        info.el.dataset.eventType = type;
      }
      if (!info.el || !type || type === 'appointment') {
        return;
      }
      const icon = type === 'exam' ? 'üß™' : type === 'vaccine' ? 'üíâ' : null;
      if (!icon) {
        return;
      }
      const titleEl = info.el.querySelector('.fc-event-title');
      if (titleEl && !titleEl.textContent.trim().startsWith(icon)) {
        titleEl.textContent = `${icon} ${titleEl.textContent}`;
      }
    },
  });

  window.sharedCalendar = calendar;
  addEvents();
  calendar.render();
  dispatchSharedCalendarEvents(calendar.getEvents());
  announceSharedCalendarReady(calendar);

  if (toggle) {
    toggle.querySelectorAll('button').forEach(function(btn) {
      btn.addEventListener('click', function() {
        source = this.dataset.source;
        selectedVetId = null;
        updateSelectedVetContext(null);
        setActiveButton(source);
        addEvents();
      });
    });
  }

  if (userPicker) {
    userPicker.addEventListener('change', function() {
      selectedUserId = extractNumericUserId(this.value);
      if (selectedUserId !== null) {
        source = 'user';
        selectedVetId = null;
        updateSelectedVetContext(null);
        setActiveButton('user');
      }
      addEvents();
    });
  }

  if (vetSelect) {
    vetSelect.addEventListener('change', function() {
      const rawValue = String(this.value || '').trim();
      if (rawValue === 'user') {
        source = 'user';
        selectedVetId = null;
        selectedUserId = null;
        updateSelectedVetContext(null);
        setActiveButton('user');
      } else if (rawValue === 'clinic') {
        source = 'clinic';
        selectedVetId = null;
        selectedUserId = null;
        updateSelectedVetContext(null);
        setActiveButton('clinic');
      } else {
        const vetId = extractNumericUserId(rawValue);
        if (vetId !== null) {
          selectedVetId = vetId;
          selectedUserId = null;
          source = 'vet';
          updateSelectedVetContext(selectedVetId);
          setActiveButton('vet', { vetId: selectedVetId });
        } else {
          selectedVetId = null;
          selectedUserId = null;
          source = defaultSource;
          updateSelectedVetContext(null);
          setActiveButton(source);
        }
      }
      addEvents();
    });
  }

  setActiveButton(source, { vetId: selectedVetId });
});
</script>

