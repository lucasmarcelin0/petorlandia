{% set calendar_id = calendar_id|default('shared-calendar') %}
{% set toggle_id = toggle_id|default('agenda-toggle') %}

<div class="card mb-4">
  <div class="card-header d-flex justify-content-center">
    <div class="btn-group" id="{{ toggle_id }}">
      <button class="btn btn-outline-primary{% if not clinic_id %} active{% endif %}" data-source="user">Minha Agenda</button>
      {% if clinic_id %}
      <button class="btn btn-outline-primary{% if clinic_id %} active{% endif %}" data-source="clinic">Agenda da ClÃ­nica</button>
      {% endif %}
    </div>
  </div>
  <div class="card-body p-0">
    <div id="{{ calendar_id }}" data-calendar-redirect-url="{{ calendar_redirect_url|default('') }}"></div>
  </div>
  <div class="card-footer bg-light small text-muted text-center">
    ðŸ’¡ Clique em um dia do calendÃ¡rio para iniciar um novo agendamento.
  </div>
</div>

{% if include_assets|default(True) %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('{{ calendar_id }}');
  const toggle = document.getElementById('{{ toggle_id }}');
  const userPicker = document.getElementById('admin-agenda-user-picker');
  const hiddenVetInput = (function() {
    if (userPicker && typeof userPicker.closest === 'function') {
      const form = userPicker.closest('[data-admin-agenda-switcher]');
      if (form) {
        return form.querySelector('[data-switcher-vet]');
      }
    }
    return document.querySelector('[data-switcher-vet]');
  })();
  const hiddenColabInput = (function() {
    if (userPicker && typeof userPicker.closest === 'function') {
      const form = userPicker.closest('[data-admin-agenda-switcher]');
      if (form) {
        return form.querySelector('[data-switcher-colab]');
      }
    }
    return document.querySelector('[data-switcher-colab]');
  })();
  const csrfToken = '{{ csrf_token() if csrf_token is defined else '' }}';
  let source = '{{ 'clinic' if clinic_id else 'user' }}';
  let selectedUserId = resolveInitialUserId();
  let calendar;

  if (typeof window !== 'undefined') {
    window.sharedCalendarEvents = window.sharedCalendarEvents || [];
  }

  if (!calendarEl) {
    return;
  }

  function extractNumericUserId(rawValue) {
    if (rawValue === undefined || rawValue === null) {
      return null;
    }
    const normalized = String(rawValue).trim();
    if (!normalized) {
      return null;
    }
    const parts = normalized.split(':');
    const numericPart = parts.length > 1 ? parts[1] : parts[0];
    const parsed = parseInt(numericPart, 10);
    if (Number.isNaN(parsed)) {
      return null;
    }
    return parsed;
  }

  function resolveInitialUserId() {
    const pickerValue = userPicker ? extractNumericUserId(userPicker.value) : null;
    if (pickerValue !== null) {
      return pickerValue;
    }
    if (hiddenVetInput) {
      const vetValue = extractNumericUserId(hiddenVetInput.value);
      if (vetValue !== null) {
        return vetValue;
      }
    }
    if (hiddenColabInput) {
      const colabValue = extractNumericUserId(hiddenColabInput.value);
      if (colabValue !== null) {
        return colabValue;
      }
    }
    return null;
  }

  function eventUrl() {
    if (source === 'clinic') {
      return '/api/clinic_appointments/{{ clinic_id }}';
    }
    const userId = extractNumericUserId(selectedUserId);
    if (userId !== null) {
      return `/api/user_appointments/${userId}`;
    }
    return '/api/my_appointments';
  }

  function addEvents() {
    calendar.removeAllEventSources();
    calendar.addEventSource(eventUrl());
  }

  function setActiveButton(targetSource) {
    if (!toggle) {
      return;
    }
    toggle.querySelectorAll('button').forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.source === targetSource);
    });
  }

  function pad(value) {
    return String(value).padStart(2, '0');
  }

  function formatLocalDate(dateObj) {
    return [
      dateObj.getFullYear(),
      pad(dateObj.getMonth() + 1),
      pad(dateObj.getDate())
    ].join('-');
  }

  function getEventType(event) {
    if (!event) {
      return null;
    }
    const type = event.extendedProps && event.extendedProps.eventType;
    if (type) {
      return type;
    }
    if (typeof event.id === 'string') {
      const prefix = event.id.split('-')[0];
      return prefix || null;
    }
    return 'appointment';
  }

  function getAppointmentId(event) {
    if (!event) {
      return null;
    }
    if (event.extendedProps && event.extendedProps.recordId) {
      return event.extendedProps.recordId;
    }
    if (typeof event.id === 'string') {
      const match = event.id.match(/^(?:appointment-)?(\d+)$/);
      if (match) {
        return parseInt(match[1], 10);
      }
    }
    if (typeof event.id === 'number') {
      return event.id;
    }
    return null;
  }

  function inferApproximateTime(dateObj, isAllDay) {
    if (isAllDay) {
      return '09:00';
    }
    return `${pad(dateObj.getHours())}:${pad(dateObj.getMinutes())}`;
  }

  function emitSlotChosen(dateObj, isAllDay) {
    if (!dateObj) {
      return;
    }
    const detail = {
      date: formatLocalDate(dateObj),
      time: inferApproximateTime(dateObj, isAllDay),
      allDay: !!isAllDay,
      source,
    };
    const customEvent = new CustomEvent('calendarSlotChosen', {
      detail,
      bubbles: true,
    });
    calendarEl.dispatchEvent(customEvent);
  }

  function toSharedEventObject(eventApi) {
    if (!eventApi) {
      return null;
    }
    const extended = Object.assign({}, eventApi.extendedProps || {});
    const eventType = extended.eventType || extended.type || eventApi.type || null;
    return {
      id: eventApi.id || null,
      title: eventApi.title || '',
      start: eventApi.start ? eventApi.start.toISOString() : (eventApi.startStr || null),
      end: eventApi.end ? eventApi.end.toISOString() : (eventApi.endStr || null),
      allDay: !!eventApi.allDay,
      type: eventType,
      extendedProps: extended,
    };
  }

  function dispatchSharedCalendarEvents(events) {
    const normalized = (events || []).map(function(item) {
      if (item && typeof item.start === 'string') {
        const plain = Object.assign({
          id: item.id || null,
          title: item.title || '',
          start: item.start || null,
          end: item.end || null,
          allDay: !!item.allDay,
        }, item);
        const extended = Object.assign({}, plain.extendedProps || {});
        if (!plain.type) {
          const derivedType = extended.eventType || extended.type;
          if (derivedType) {
            plain.type = derivedType;
          }
        }
        plain.extendedProps = extended;
        return plain;
      }
      return toSharedEventObject(item);
    }).filter(Boolean);

    if (typeof window !== 'undefined') {
      window.sharedCalendarEvents = normalized;
    }
    document.dispatchEvent(new CustomEvent('sharedCalendarEvents', {
      detail: { events: normalized },
    }));
  }

  function announceSharedCalendarReady(instance) {
    document.dispatchEvent(new CustomEvent('sharedCalendarReady', {
      detail: { calendar: instance },
    }));
  }

  async function persistEventChange(info) {
    if (!calendar) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      return;
    }

    const event = info.event;
    if (!event || !event.start) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      return;
    }

    const payload = {
      start: event.start ? event.start.toISOString() : null,
      end: event.end ? event.end.toISOString() : null,
    };

    const eventType = getEventType(event);
    const appointmentId = getAppointmentId(event);
    if (eventType !== 'appointment' || !appointmentId) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      return;
    }

    try {
      const response = await fetch(`/api/appointments/${appointmentId}/reschedule`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok || !data.success) {
        const message = data && data.message ? data.message : 'NÃ£o foi possÃ­vel reagendar este compromisso.';
        throw new Error(message);
      }
      calendar.refetchEvents();
    } catch (error) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      const message = (error && error.message) ? error.message : 'Ocorreu um erro ao reagendar este compromisso.';
      window.alert(message);
    }
  }

  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: true,
    selectMirror: true,
    editable: true,
    eventDurationEditable: true,
    select: function(info) {
      emitSlotChosen(info.start, info.allDay);
      calendar.unselect();
    },
    dateClick: function(info) {
      emitSlotChosen(info.date, info.allDay);
    },
    eventDrop: persistEventChange,
    eventResize: persistEventChange,
    eventAllow: function(dropInfo, draggedEvent) {
      return getEventType(draggedEvent) === 'appointment';
    },
    eventsSet: function(eventList) {
      dispatchSharedCalendarEvents(eventList);
    },
    eventDidMount: function(info) {
      const type = getEventType(info.event);
      if (info.el && type) {
        info.el.dataset.eventType = type;
      }
      if (!info.el || !type || type === 'appointment') {
        return;
      }
      const icon = type === 'exam' ? 'ðŸ§ª' : type === 'vaccine' ? 'ðŸ’‰' : null;
      if (!icon) {
        return;
      }
      const titleEl = info.el.querySelector('.fc-event-title');
      if (titleEl && !titleEl.textContent.trim().startsWith(icon)) {
        titleEl.textContent = `${icon} ${titleEl.textContent}`;
      }
    },
  });

  window.sharedCalendar = calendar;
  addEvents();
  calendar.render();
  dispatchSharedCalendarEvents(calendar.getEvents());
  announceSharedCalendarReady(calendar);

  if (toggle) {
    toggle.querySelectorAll('button').forEach(function(btn) {
      btn.addEventListener('click', function() {
        source = this.dataset.source;
        setActiveButton(source);
        addEvents();
      });
    });
  }

  if (userPicker) {
    userPicker.addEventListener('change', function() {
      selectedUserId = extractNumericUserId(this.value);
      if (selectedUserId !== null) {
        source = 'user';
        setActiveButton('user');
      }
      addEvents();
    });
  }

  setActiveButton(source);
});
</script>

