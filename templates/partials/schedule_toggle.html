{% set calendar_id = calendar_id|default('shared-calendar') %}
{% set toggle_id = toggle_id|default('agenda-toggle') %}

<div class="card mb-4">
  <div class="card-header d-flex justify-content-center">
    <div class="btn-group" id="{{ toggle_id }}">
      <button class="btn btn-outline-primary{% if not clinic_id %} active{% endif %}" data-source="user">Minha Agenda</button>
      {% if clinic_id %}
      <button class="btn btn-outline-primary{% if clinic_id %} active{% endif %}" data-source="clinic">Agenda da Cl√≠nica</button>
      {% endif %}
    </div>
  </div>
  <div class="card-body p-0">
    <div id="{{ calendar_id }}" data-calendar-redirect-url="{{ calendar_redirect_url|default('') }}"></div>
  </div>
  <div class="card-footer bg-light small text-muted text-center">
    üí° Clique em um dia do calend√°rio para iniciar um novo agendamento.
  </div>
</div>

{% if include_assets|default(True) %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('{{ calendar_id }}');
  const toggle = document.getElementById('{{ toggle_id }}');
  const userPicker = document.getElementById('admin-agenda-user-picker');
  const csrfToken = '{{ csrf_token() if csrf_token is defined else '' }}';
  let source = '{{ 'clinic' if clinic_id else 'user' }}';
  let selectedUserId = userPicker && userPicker.value ? userPicker.value : null;
  let calendar;

  if (!calendarEl) {
    return;
  }

  function eventUrl() {
    if (source === 'clinic') {
      return '/api/clinic_appointments/{{ clinic_id }}';
    }
    if (selectedUserId) {
      return `/api/user_appointments/${selectedUserId}`;
    }
    return '/api/my_appointments';
  }

  function addEvents() {
    calendar.removeAllEventSources();
    calendar.addEventSource(eventUrl());
  }

  function setActiveButton(targetSource) {
    if (!toggle) {
      return;
    }
    toggle.querySelectorAll('button').forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.source === targetSource);
    });
  }

  function pad(value) {
    return String(value).padStart(2, '0');
  }

  function formatLocalDate(dateObj) {
    return [
      dateObj.getFullYear(),
      pad(dateObj.getMonth() + 1),
      pad(dateObj.getDate())
    ].join('-');
  }

  function inferApproximateTime(dateObj, isAllDay) {
    if (isAllDay) {
      return '09:00';
    }
    return `${pad(dateObj.getHours())}:${pad(dateObj.getMinutes())}`;
  }

  function emitSlotChosen(dateObj, isAllDay) {
    if (!dateObj) {
      return;
    }
    const detail = {
      date: formatLocalDate(dateObj),
      time: inferApproximateTime(dateObj, isAllDay),
      allDay: !!isAllDay,
      source,
    };
    const customEvent = new CustomEvent('calendarSlotChosen', {
      detail,
      bubbles: true,
    });
    calendarEl.dispatchEvent(customEvent);
  }

  async function persistEventChange(info) {
    if (!calendar) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      return;
    }

    const event = info.event;
    if (!event || !event.start) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      return;
    }

    const payload = {
      start: event.start ? event.start.toISOString() : null,
      end: event.end ? event.end.toISOString() : null,
    };

    try {
      const response = await fetch(`/api/appointments/${event.id}/reschedule`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok || !data.success) {
        const message = data && data.message ? data.message : 'N√£o foi poss√≠vel reagendar este compromisso.';
        throw new Error(message);
      }
      calendar.refetchEvents();
    } catch (error) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      const message = (error && error.message) ? error.message : 'Ocorreu um erro ao reagendar este compromisso.';
      window.alert(message);
    }
  }

  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: true,
    selectMirror: true,
    editable: true,
    eventDurationEditable: true,
    select: function(info) {
      emitSlotChosen(info.start, info.allDay);
      calendar.unselect();
    },
    dateClick: function(info) {
      emitSlotChosen(info.date, info.allDay);
    },
    eventDrop: persistEventChange,
    eventResize: persistEventChange,
  });

  window.sharedCalendar = calendar;
  addEvents();
  calendar.render();

  if (toggle) {
    toggle.querySelectorAll('button').forEach(function(btn) {
      btn.addEventListener('click', function() {
        source = this.dataset.source;
        setActiveButton(source);
        addEvents();
      });
    });
  }

  if (userPicker) {
    userPicker.addEventListener('change', function() {
      selectedUserId = this.value || null;
      if (selectedUserId) {
        source = 'user';
        setActiveButton('user');
      }
      addEvents();
    });
  }

  setActiveButton(source);
});
</script>

