{% set calendar_id = calendar_id|default('shared-calendar') %}
{% set toggle_id = toggle_id|default('agenda-toggle') %}
{% set admin_view_mode = admin_selected_view|default('') %}
{% set vet_options = vets|default([]) %}
{% set is_collaborator_view = current_user.is_authenticated and (
  current_user.worker == 'colaborador'
  or (current_user.role == 'admin' and admin_view_mode == 'colaborador')
) %}
{% set collaborator_select_default = 'clinic' if clinic_id else 'user' %}

<div class="card mb-4">
  <div class="card-header">
    <div class="d-flex flex-column flex-md-row align-items-center justify-content-center gap-2">
      <div class="btn-group" id="{{ toggle_id }}">
        <button class="btn btn-outline-primary{% if not clinic_id %} active{% endif %}" data-source="user">Minha Agenda</button>
        {% if clinic_id %}
        <button class="btn btn-outline-primary{% if clinic_id %} active{% endif %}" data-source="clinic">Agenda da Cl√≠nica</button>
        {% endif %}
      </div>
      {% if is_collaborator_view %}
      <div class="w-100 w-md-auto">
        <select
          id="collaborator-schedule-picker"
          class="form-select form-select-sm"
          aria-label="Selecionar agenda"
        >
          <option value="user"{% if collaborator_select_default == 'user' %} selected{% endif %}>Minha agenda</option>
          {% if clinic_id %}
          <option value="clinic"{% if collaborator_select_default == 'clinic' %} selected{% endif %}>Agenda da cl√≠nica</option>
          {% endif %}
          {% if vet_options %}
          {% for vet in vet_options %}
          {% set vet_name = vet.user.name if vet.user else (vet.name if vet.name is defined else 'Veterin√°rio #' ~ vet.id) %}
          <option value="veterinario:{{ vet.id }}">{{ vet_name }}</option>
          {% endfor %}
          {% elif form is defined and form and form.veterinario_id is defined %}
          {% for value, label in form.veterinario_id.choices %}
          {% if value is not none and value != '' %}
          <option value="veterinario:{{ value }}">{{ label }}</option>
          {% endif %}
          {% endfor %}
          {% endif %}
        </select>
      </div>
      {% endif %}
    </div>
  </div>
  <div class="card-body p-0">
    <div id="{{ calendar_id }}" data-calendar-redirect-url="{{ calendar_redirect_url|default('') }}"></div>
  </div>
  <div class="card-footer bg-light small text-muted text-center">
    üí° Clique em um dia do calend√°rio para iniciar um novo agendamento.
  </div>
</div>

{% if include_assets|default(True) %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('{{ calendar_id }}');
  const toggle = document.getElementById('{{ toggle_id }}');
  const collaboratorPicker = document.getElementById('collaborator-schedule-picker');
  const userPicker = document.getElementById('admin-agenda-user-picker');
  const hiddenVetInput = (function() {
    if (userPicker && typeof userPicker.closest === 'function') {
      const form = userPicker.closest('[data-admin-agenda-switcher]');
      if (form) {
        return form.querySelector('[data-switcher-vet]');
      }
    }
    return document.querySelector('[data-switcher-vet]');
  })();
  const hiddenColabInput = (function() {
    if (userPicker && typeof userPicker.closest === 'function') {
      const form = userPicker.closest('[data-admin-agenda-switcher]');
      if (form) {
        return form.querySelector('[data-switcher-colab]');
      }
    }
    return document.querySelector('[data-switcher-colab]');
  })();
  const csrfToken = '{{ csrf_token() if csrf_token is defined else '' }}';
  const clinicId = {{ clinic_id|tojson }};
  const adminInitialView = {{ (admin_selected_view or '')|tojson }};
  const defaultSource = {{ ('clinic' if clinic_id else 'user')|tojson }};
  const clinicFilters = (function() {
    if (typeof window === 'undefined') {
      return [];
    }
    const params = new URLSearchParams(window.location.search);
    const ids = [];
    params.getAll('clinica_id').forEach(function(value) {
      const parsed = toNumericId(value);
      if (parsed !== null && !ids.includes(parsed)) {
        ids.push(parsed);
      }
    });
    return ids;
  })();

  const vetColorPalette = [
    'calendar-vet-color-0',
    'calendar-vet-color-1',
    'calendar-vet-color-2',
    'calendar-vet-color-3',
    'calendar-vet-color-4',
    'calendar-vet-color-5',
    'calendar-vet-color-6',
    'calendar-vet-color-7',
  ];
  const vetColorAssignments = new Map();

  if (typeof window !== 'undefined' && window.calendarVetColorAssignments) {
    Object.keys(window.calendarVetColorAssignments).forEach(function(key) {
      const className = window.calendarVetColorAssignments[key];
      if (className) {
        vetColorAssignments.set(key, className);
      }
    });
  }

  function normalizeVetColorKey(value) {
    if (value === undefined || value === null) {
      return null;
    }
    if (typeof value === 'number' && Number.isFinite(value)) {
      return String(value);
    }
    const normalized = String(value).trim();
    return normalized || null;
  }

  function readGlobalVetColorAssignment(key) {
    if (typeof window === 'undefined' || !window.calendarVetColorAssignments) {
      return null;
    }
    return window.calendarVetColorAssignments[key] || null;
  }

  function storeGlobalVetColorAssignment(key, className) {
    if (typeof window === 'undefined') {
      return;
    }
    window.calendarVetColorAssignments = window.calendarVetColorAssignments || {};
    window.calendarVetColorAssignments[key] = className;
  }

  function resolveVetColorClass(vetId) {
    const key = normalizeVetColorKey(vetId);
    if (!key) {
      return null;
    }
    if (vetColorAssignments.has(key)) {
      return vetColorAssignments.get(key);
    }
    const existing = readGlobalVetColorAssignment(key);
    if (existing) {
      vetColorAssignments.set(key, existing);
      return existing;
    }
    const paletteIndex = vetColorAssignments.size % vetColorPalette.length;
    const className = vetColorPalette[paletteIndex];
    vetColorAssignments.set(key, className);
    storeGlobalVetColorAssignment(key, className);
    return className;
  }

  function applyVetColorClasses(element, vetId, options = {}) {
    if (!element || !element.classList) {
      return null;
    }
    const normalizedVetId = normalizeVetColorKey(vetId);
    if (!normalizedVetId) {
      if (options.clearWhenInvalid) {
        const classesToRemove = Array.from(element.classList).filter(function(cls) {
          return cls.startsWith('calendar-vet-color-') || cls.startsWith('calendar-vet-');
        });
        classesToRemove.forEach(function(cls) {
          element.classList.remove(cls);
        });
        if (element.dataset) {
          delete element.dataset.veterinarioId;
          delete element.dataset.vetId;
        }
        element.removeAttribute('data-veterinario-id');
      }
      return null;
    }

    const classesToRemove = Array.from(element.classList).filter(function(cls) {
      return cls.startsWith('calendar-vet-color-') || cls.startsWith('calendar-vet-');
    });
    classesToRemove.forEach(function(cls) {
      element.classList.remove(cls);
    });

    const assignedClass = options.assignedClass === undefined ? 'calendar-vet-assigned' : options.assignedClass;
    if (assignedClass) {
      element.classList.add(assignedClass);
    }

    if (options.includeIdClass !== false) {
      element.classList.add(`calendar-vet-${normalizedVetId}`);
    }

    const colorClass = resolveVetColorClass(normalizedVetId);
    if (colorClass) {
      element.classList.add(colorClass);
    }

    if (element.dataset) {
      element.dataset.veterinarioId = normalizedVetId;
      element.dataset.vetId = normalizedVetId;
    }
    element.setAttribute('data-veterinario-id', normalizedVetId);

    return colorClass;
  }

  if (typeof window !== 'undefined') {
    window.calendarVetColorManager = window.calendarVetColorManager || {};
    window.calendarVetColorManager.getClass = resolveVetColorClass;
    window.calendarVetColorManager.normalize = normalizeVetColorKey;
    window.calendarVetColorManager.palette = vetColorPalette.slice();
    window.calendarVetColorManager.applyClasses = function(element, vetId, options) {
      return applyVetColorClasses(element, vetId, options || {});
    };
  }

  if (typeof window !== 'undefined') {
    window.sharedCalendarEvents = window.sharedCalendarEvents || [];
  }

  if (!calendarEl) {
    return;
  }

  function toNumericId(rawValue) {
    if (rawValue === undefined || rawValue === null) {
      return null;
    }
    if (typeof rawValue === 'number') {
      return Number.isNaN(rawValue) ? null : rawValue;
    }
    const normalized = String(rawValue).trim();
    if (!normalized) {
      return null;
    }
    const colonIndex = normalized.indexOf(':');
    const numericPart = colonIndex >= 0 ? normalized.slice(colonIndex + 1) : normalized;
    const parsed = parseInt(numericPart, 10);
    return Number.isNaN(parsed) ? null : parsed;
  }

  function parseSelectionValue(rawValue) {
    if (rawValue === undefined || rawValue === null) {
      return null;
    }
    const normalized = String(rawValue).trim();
    if (!normalized) {
      return null;
    }
    const parts = normalized.split(':', 2);
    if (parts.length === 2) {
      const id = toNumericId(parts[1]);
      if (id === null) {
        return null;
      }
      return { kind: parts[0] || null, id };
    }
    const id = toNumericId(normalized);
    return id === null ? null : { kind: null, id };
  }

  function updateCollaboratorPickerValue(currentSource = source) {
    if (!collaboratorPicker) {
      return;
    }
    let value = '';
    if (currentSource === 'vet') {
      const vetId = toNumericId(selectedVetId);
      if (vetId !== null) {
        value = `veterinario:${vetId}`;
      }
    } else if (currentSource === 'clinic') {
      value = 'clinic';
    } else {
      value = 'user';
    }
    if (collaboratorPicker.value !== value) {
      collaboratorPicker.value = value;
    }
    collaboratorPicker.classList.toggle('is-vet-mode', currentSource === 'vet');
  }

  function resolveInitialUserId() {
    const selection = parseSelectionValue(userPicker ? userPicker.value : null);
    if (selection && selection.id !== null && selection.kind !== 'veterinario') {
      return selection.id;
    }
    if (hiddenColabInput) {
      const hiddenColabId = toNumericId(hiddenColabInput.value);
      if (hiddenColabId !== null) {
        return hiddenColabId;
      }
    }
    return null;
  }

  function resolveInitialVetId() {
    const selection = parseSelectionValue(userPicker ? userPicker.value : null);
    if (selection && selection.kind === 'veterinario' && selection.id !== null) {
      return selection.id;
    }
    if (hiddenVetInput) {
      const hiddenVetId = toNumericId(hiddenVetInput.value);
      if (hiddenVetId !== null) {
        return hiddenVetId;
      }
    }
    return null;
  }

  let source = defaultSource;
  let selectedUserId = resolveInitialUserId();
  let selectedVetId = resolveInitialVetId();
  let calendar;

  if (adminInitialView === 'veterinario') {
    source = 'vet';
  } else if (adminInitialView === 'colaborador') {
    source = 'clinic';
  } else if (adminInitialView === 'tutor') {
    source = 'user';
  }
  if (source === 'user' && selectedVetId !== null) {
    source = 'vet';
  }

  function eventUrl() {
    if (source === 'clinic') {
      const clinicNumeric = toNumericId(clinicId);
      if (clinicNumeric !== null) {
        return `/api/clinic_appointments/${clinicNumeric}`;
      }
      return null;
    }
    if (source === 'vet') {
      const vetId = toNumericId(selectedVetId);
      if (vetId === null) {
        return null;
      }
      let url = `/api/vet_appointments/${vetId}`;
      if (clinicFilters.length) {
        const query = clinicFilters.map(function(id) {
          return `clinica_id=${encodeURIComponent(id)}`;
        }).join('&');
        url += `?${query}`;
      }
      return url;
    }
    const userId = toNumericId(selectedUserId);
    if (userId !== null) {
      return `/api/user_appointments/${userId}`;
    }
    return '/api/my_appointments';
  }

  function addEvents(options = {}) {
    if (!calendar) {
      return;
    }
    calendar.removeAllEventSources();
    const url = eventUrl();
    if (url) {
      calendar.addEventSource(url);
    }
    if (options.refetch && typeof calendar.refetchEvents === 'function') {
      calendar.refetchEvents();
    }
  }

  function setActiveButton(targetSource) {
    if (toggle) {
      toggle.querySelectorAll('button').forEach(function(btn) {
        const isActive = targetSource !== 'vet' && btn.dataset.source === targetSource;
        btn.classList.toggle('active', isActive);
      });
    }
    updateCollaboratorPickerValue(targetSource);
  }

  function pad(value) {
    return String(value).padStart(2, '0');
  }

  function formatLocalDate(dateObj) {
    return [
      dateObj.getFullYear(),
      pad(dateObj.getMonth() + 1),
      pad(dateObj.getDate())
    ].join('-');
  }

  function getEventType(event) {
    if (!event) {
      return null;
    }
    const type = event.extendedProps && event.extendedProps.eventType;
    if (type) {
      return type;
    }
    if (typeof event.id === 'string') {
      const prefix = event.id.split('-')[0];
      return prefix || null;
    }
    return 'appointment';
  }

  function getAppointmentId(event) {
    if (!event) {
      return null;
    }
    if (event.extendedProps && event.extendedProps.recordId) {
      return event.extendedProps.recordId;
    }
    if (typeof event.id === 'string') {
      const match = event.id.match(/^(?:appointment-)?(\d+)$/);
      if (match) {
        return parseInt(match[1], 10);
      }
    }
    if (typeof event.id === 'number') {
      return event.id;
    }
    return null;
  }

  function inferApproximateTime(dateObj, isAllDay) {
    if (isAllDay) {
      return '09:00';
    }
    return `${pad(dateObj.getHours())}:${pad(dateObj.getMinutes())}`;
  }

  function emitSlotChosen(dateObj, isAllDay) {
    if (!dateObj) {
      return;
    }
    const detail = {
      date: formatLocalDate(dateObj),
      time: inferApproximateTime(dateObj, isAllDay),
      allDay: !!isAllDay,
      source,
    };
    const customEvent = new CustomEvent('calendarSlotChosen', {
      detail,
      bubbles: true,
    });
    calendarEl.dispatchEvent(customEvent);
  }

  function toSharedEventObject(eventApi) {
    if (!eventApi) {
      return null;
    }
    const extended = Object.assign({}, eventApi.extendedProps || {});
    const eventType = extended.eventType || extended.type || eventApi.type || null;
    return {
      id: eventApi.id || null,
      title: eventApi.title || '',
      start: eventApi.start ? eventApi.start.toISOString() : (eventApi.startStr || null),
      end: eventApi.end ? eventApi.end.toISOString() : (eventApi.endStr || null),
      allDay: !!eventApi.allDay,
      type: eventType,
      extendedProps: extended,
    };
  }

  function dispatchSharedCalendarEvents(events) {
    const normalized = (events || []).map(function(item) {
      if (item && typeof item.start === 'string') {
        const plain = Object.assign({
          id: item.id || null,
          title: item.title || '',
          start: item.start || null,
          end: item.end || null,
          allDay: !!item.allDay,
        }, item);
        const extended = Object.assign({}, plain.extendedProps || {});
        if (!plain.type) {
          const derivedType = extended.eventType || extended.type;
          if (derivedType) {
            plain.type = derivedType;
          }
        }
        plain.extendedProps = extended;
        return plain;
      }
      return toSharedEventObject(item);
    }).filter(Boolean);

    if (typeof window !== 'undefined') {
      window.sharedCalendarEvents = normalized;
    }
    document.dispatchEvent(new CustomEvent('sharedCalendarEvents', {
      detail: { events: normalized },
    }));
  }

  function announceSharedCalendarReady(instance) {
    document.dispatchEvent(new CustomEvent('sharedCalendarReady', {
      detail: { calendar: instance },
    }));
  }

  function updateCalendarVetSelection(vetId, options = {}) {
    const shouldActivate = options.activate !== false;
    const shouldRefetch = options.refetch !== false;
    const numericVetId = toNumericId(vetId);
    const previousVetId = selectedVetId;
    selectedVetId = numericVetId;
    if (shouldActivate) {
      source = numericVetId !== null ? 'vet' : defaultSource;
      if (numericVetId !== null) {
        selectedUserId = null;
      }
      setActiveButton(source);
    } else {
      updateCollaboratorPickerValue(source);
    }
    const vetChanged = previousVetId !== numericVetId;
    if (vetChanged && (shouldActivate || source === 'vet')) {
      addEvents({ refetch: false });
      if (shouldRefetch && calendar && typeof calendar.refetchEvents === 'function') {
        calendar.refetchEvents();
      }
      return true;
    }
    if (shouldRefetch && calendar && typeof calendar.refetchEvents === 'function') {
      calendar.refetchEvents();
    }
    return false;
  }

  window.updateCalendarVetSelection = updateCalendarVetSelection;

  async function persistEventChange(info) {
    if (!calendar) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      return;
    }

    const event = info.event;
    if (!event || !event.start) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      return;
    }

    const payload = {
      start: event.start ? event.start.toISOString() : null,
      end: event.end ? event.end.toISOString() : null,
    };

    const eventType = getEventType(event);
    const appointmentId = getAppointmentId(event);
    if (eventType !== 'appointment' || !appointmentId) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      return;
    }

    try {
      const response = await fetch(`/api/appointments/${appointmentId}/reschedule`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok || !data.success) {
        const message = data && data.message ? data.message : 'N√£o foi poss√≠vel reagendar este compromisso.';
        throw new Error(message);
      }
      calendar.refetchEvents();
    } catch (error) {
      if (typeof info.revert === 'function') {
        info.revert();
      }
      const message = (error && error.message) ? error.message : 'Ocorreu um erro ao reagendar este compromisso.';
      window.alert(message);
    }
  }

  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: true,
    selectMirror: true,
    editable: true,
    eventDurationEditable: true,
    select: function(info) {
      emitSlotChosen(info.start, info.allDay);
      calendar.unselect();
    },
    dateClick: function(info) {
      emitSlotChosen(info.date, info.allDay);
    },
    eventDrop: persistEventChange,
    eventResize: persistEventChange,
    eventAllow: function(dropInfo, draggedEvent) {
      return getEventType(draggedEvent) === 'appointment';
    },
    eventsSet: function(eventList) {
      dispatchSharedCalendarEvents(eventList);
    },
    eventDidMount: function(info) {
      const type = getEventType(info.event);
      if (info.el) {
        if (type) {
          info.el.dataset.eventType = type;
        }
        const rawVetId = info.event && info.event.extendedProps
          ? (info.event.extendedProps.veterinarioId
            || info.event.extendedProps.vetId
            || info.event.extendedProps.veterinarianId)
          : null;
        applyVetColorClasses(info.el, rawVetId, {
          assignedClass: 'calendar-vet-assigned',
          clearWhenInvalid: true,
        });
      }
      if (!info.el || !type || type === 'appointment') {
        return;
      }
      const icon = type === 'exam' ? 'üß™' : type === 'vaccine' ? 'üíâ' : null;
      if (!icon) {
        return;
      }
      const titleEl = info.el.querySelector('.fc-event-title');
      if (titleEl && !titleEl.textContent.trim().startsWith(icon)) {
        titleEl.textContent = `${icon} ${titleEl.textContent}`;
      }
    },
  });

  window.sharedCalendar = calendar;
  addEvents();
  calendar.render();
  dispatchSharedCalendarEvents(calendar.getEvents());
  announceSharedCalendarReady(calendar);

  if (toggle) {
    toggle.querySelectorAll('button').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const target = this.dataset.source;
        if (target === 'user') {
          source = 'user';
          selectedVetId = null;
        } else if (target === 'clinic') {
          source = 'clinic';
          selectedVetId = null;
        } else {
          source = target;
        }
        setActiveButton(source);
        addEvents({ refetch: true });
      });
    });
  }

  if (collaboratorPicker) {
    collaboratorPicker.addEventListener('change', function() {
      const rawValue = this.value;
      if (rawValue === 'clinic') {
        selectedVetId = null;
        source = 'clinic';
        setActiveButton(source);
        addEvents({ refetch: true });
        return;
      }
      if (rawValue === 'user' || rawValue === '') {
        selectedVetId = null;
        source = 'user';
        setActiveButton(source);
        addEvents({ refetch: true });
        return;
      }
      const selection = parseSelectionValue(rawValue);
      if (selection && selection.kind === 'veterinario' && selection.id !== null) {
        selectedUserId = null;
        updateCalendarVetSelection(selection.id, { activate: true, refetch: true });
        return;
      }
      source = defaultSource;
      selectedVetId = null;
      setActiveButton(source);
      addEvents({ refetch: true });
    });
  }

  if (userPicker) {
    userPicker.addEventListener('change', function() {
      const selection = parseSelectionValue(this.value);
      if (selection && selection.kind === 'veterinario' && selection.id !== null) {
        selectedUserId = null;
        updateCalendarVetSelection(selection.id, { activate: true, refetch: true });
        return;
      }
      selectedVetId = null;
      if (selection && selection.id !== null) {
        selectedUserId = selection.id;
      } else {
        selectedUserId = null;
      }
      source = 'user';
      setActiveButton(source);
      addEvents({ refetch: true });
    });
  }

  setActiveButton(source);
});
</script>

