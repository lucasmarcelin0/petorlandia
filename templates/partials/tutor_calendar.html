{% set component_id = component_id|default('tutor-calendar-component') %}
{% set events_url = events_url|default(url_for('api_my_appointments')) %}
{% set pets_url = pets_url|default(url_for('api_my_pets')) %}
{% set new_pet_url = new_pet_url|default(url_for('novo_animal')) %}
{% set calendar_summary_toggle_show_label = calendar_summary_toggle_show_label|default('Mostrar resumo por profissional') %}
{% set calendar_summary_toggle_hide_label = calendar_summary_toggle_hide_label|default('Ocultar resumo por profissional') %}

<section
  id="{{ component_id }}"
  class="tutor-calendar"
  data-events-url="{{ events_url }}"
  data-pets-url="{{ pets_url }}"
  data-csrf-token="{{ csrf_token() if csrf_token is defined else '' }}"
  data-url-animal-profile="{{ url_for('ficha_animal', animal_id=0) }}"
  data-url-tutor-profile="{{ url_for('ficha_tutor', tutor_id=0) }}"
  data-url-consulta="{{ url_for('consulta_direct', animal_id=0) }}"
  data-url-edit-appointment="{{ url_for('edit_appointment', appointment_id=0) }}"
  data-url-status="{{ url_for('update_appointment_status', appointment_id=0) }}"
  data-url-delete-appointment="{{ url_for('delete_appointment', appointment_id=0) }}"
  data-url-print-consulta="{{ url_for('imprimir_consulta', consulta_id=0) }}"
  data-can-start-consulta="{{ 'true' if current_user.worker in ['veterinario', 'colaborador'] else 'false' }}"
  data-can-manage-status="{{ 'true' if (current_user.worker in ['veterinario', 'colaborador']) or current_user.role == 'admin' else 'false' }}"
>
  <div class="row g-4 align-items-start">
    <div class="col-12">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <button type="button" class="btn btn-outline-primary btn-sm" data-prev-month aria-label="Mês anterior">
                <i class="bi bi-chevron-left"></i>
              </button>
              <div>
                <div class="fw-bold text-capitalize" data-month-label></div>
                <div class="text-muted small" data-year-label></div>
              </div>
              <button type="button" class="btn btn-primary btn-sm" data-next-month aria-label="Próximo mês">
                <i class="bi bi-chevron-right"></i>
              </button>
              <div class="btn-group btn-group-sm tutor-calendar__view-toggle ms-2 w-100" role="group" aria-label="Alternar visualização">
                <button type="button" class="btn btn-outline-secondary active" data-view-mode="month" aria-pressed="true">
                  Mensal
                </button>
                <button type="button" class="btn btn-outline-secondary" data-view-mode="week" aria-pressed="false">
                  Semanal
                </button>
                <button type="button" class="btn btn-outline-secondary" data-today>
                  Hoje
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary d-flex align-items-center gap-1"
                  data-calendar-summary-toggle
                  data-show-label="{{ calendar_summary_toggle_show_label }}"
                  data-hide-label="{{ calendar_summary_toggle_hide_label }}"
                  aria-pressed="false"
                >
                  <i class="bi bi-layout-sidebar-inset" data-calendar-summary-toggle-icon aria-hidden="true"></i>
                  <span class="fw-semibold" aria-hidden="true">Profissional</span>
                  <span class="visually-hidden" data-calendar-summary-toggle-label>{{ calendar_summary_toggle_hide_label }}</span>
                </button>
              </div>
            </div>
          </div>
          <h3 class="h6 mb-3 mt-4">Filtros rápidos</h3>
          <div class="tutor-calendar__filters d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm active" data-filter="all">Todos</button>
            <button type="button" class="btn btn-outline-primary btn-sm" data-filter="appointment">Consultas</button>
            <button type="button" class="btn btn-outline-primary btn-sm" data-filter="exam">Exames</button>
            <button type="button" class="btn btn-outline-primary btn-sm" data-filter="vaccine">Vacinas</button>
            <button type="button" class="btn btn-outline-primary btn-sm" data-filter="grooming">Banho e Tosa</button>
          </div>
          <p class="text-muted small mb-4 mt-3">
            Eventos sincronizados automaticamente com o FullCalendar. Escolha um dia para iniciar um novo agendamento.
          </p>
          <div class="tutor-calendar__layout">
            <div class="tutor-calendar__schedule">
              <div class="tutor-calendar__weekdays" data-weekdays></div>
              <div class="tutor-calendar__days" data-calendar-grid></div>
              <div class="tutor-calendar__week d-none" data-week-view></div>
            </div>
            <div class="tutor-calendar__day-detail-layer" data-day-detail-layer>
              <div class="tutor-calendar__day-detail-backdrop" data-day-detail-backdrop></div>
              <aside
                class="tutor-calendar__day-detail"
                data-day-detail
                role="dialog"
                aria-modal="true"
                aria-labelledby="{{ component_id }}-day-detail-heading"
                aria-live="polite"
                aria-label="Detalhes do dia selecionado"
                tabindex="-1"
                aria-busy="false"
                aria-hidden="true"
              >
                <h2
                  class="visually-hidden"
                  id="{{ component_id }}-day-detail-heading"
                  data-day-detail-heading
                >
                  Detalhes do dia selecionado
                </h2>
                <div class="tutor-calendar__day-detail-controls" data-day-detail-controls>
                  <button
                    type="button"
                    class="tutor-calendar__day-detail-back"
                    data-back-to-day
                    hidden
                    aria-hidden="true"
                    aria-label="Voltar para os agendamentos do dia"
                  >
                    <i class="bi bi-arrow-left-circle" aria-hidden="true"></i>
                    <span class="tutor-calendar__day-detail-back-text">Agendamentos do dia</span>
                  </button>
                  <button
                    type="button"
                    class="tutor-calendar__day-detail-close"
                    data-close-day-detail
                    aria-label="Fechar detalhes do dia"
                  >
                    <span class="visually-hidden">Fechar detalhes do dia</span>
                    <span class="tutor-calendar__day-detail-close-icon" aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="tutor-calendar__day-detail-content" data-day-detail-content>
                  <div class="tutor-calendar__day-detail-placeholder text-muted small">
                    Selecione um dia para ver os compromissos.
                  </div>
                </div>
              </aside>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <section
        class="tutor-calendar__quick-tutor"
        aria-labelledby="{{ component_id }}-quick-tutor-heading"
      >
        <header class="tutor-calendar__quick-tutor-hero">
          <div class="tutor-calendar__quick-tutor-icon" aria-hidden="true">
            <i class="bi bi-person-hearts"></i>
          </div>
          <div class="tutor-calendar__quick-tutor-copy">
            <p class="tutor-calendar__quick-tutor-eyebrow">Cadastro rápido de tutor</p>
            <h3 id="{{ component_id }}-quick-tutor-heading" class="tutor-calendar__quick-tutor-title">
              Registre um responsável sem sair da agenda
            </h3>
            <p class="tutor-calendar__quick-tutor-description">
              Simplifique o atendimento preenchendo os dados essenciais do tutor e sincronizando o endereço completo em segundos.
            </p>
            <div class="tutor-calendar__quick-tutor-actions">
              <a class="btn btn-light btn-sm text-primary" href="{{ url_for('tutores') }}" target="_blank" rel="noopener">
                <i class="bi bi-box-arrow-up-right me-1"></i> Ver todos os tutores
              </a>
            </div>
          </div>
          <ul class="tutor-calendar__quick-tutor-highlights" aria-label="Diferenciais do cadastro rápido">
            <li>
              <i class="bi bi-magic"></i>
              <span>Preenchimento guiado com validação em tempo real.</span>
            </li>
            <li>
              <i class="bi bi-geo"></i>
              <span>Busca automática de endereço via CEP integrado.</span>
            </li>
            <li>
              <i class="bi bi-link-45deg"></i>
              <span>Cadastro sincronizado com o perfil completo do tutor.</span>
            </li>
          </ul>
        </header>
        <div class="tutor-calendar__quick-tutor-body">
          <div class="tutor-calendar__quick-tutor-form">
            {% with
              form_id=component_id ~ '-quick-tutor-form',
              show_intro=False,
              include_address=True,
              address_prefix=component_id ~ '-quick-tutor-address'
            %}
              {% include 'partials/calendar_quick_tutor_form.html' %}
            {% endwith %}
          </div>
          <aside class="tutor-calendar__quick-tutor-support" aria-label="Resumo do fluxo de cadastro">
            <div class="tutor-calendar__quick-tutor-support-card">
              <h4 class="tutor-calendar__quick-tutor-support-title">Fluxo em três passos</h4>
              <ol class="tutor-calendar__quick-tutor-steps">
                <li>Identifique o tutor com nome e contato.</li>
                <li>Adicione documentos e dados adicionais relevantes.</li>
                <li>Confirme o endereço completo com busca inteligente de CEP.</li>
              </ol>
            </div>
            <div class="tutor-calendar__quick-tutor-support-card">
              <h4 class="tutor-calendar__quick-tutor-support-title">Dicas de atendimento</h4>
              <ul class="tutor-calendar__quick-tutor-tips">
                <li><i class="bi bi-chat-dots"></i> Reforce as preferências de contato para comunicação eficiente.</li>
                <li><i class="bi bi-people"></i> Vincule o tutor aos pets diretamente após o cadastro.</li>
                <li><i class="bi bi-shield-check"></i> Garanta que CPF e data de nascimento estejam corretos para prontuários.</li>
              </ul>
            </div>
          </aside>
        </div>
      </section>
    </div>
  </div>
</section>

<style>
#{{ component_id }}.tutor-calendar {
  --tutor-calendar-card-bg: var(--bs-body-bg, #fff);
}

#{{ component_id }} .tutor-calendar__hero {
  background: linear-gradient(90deg, #0ea5e9 0%, #6366f1 100%);
}

#{{ component_id }} .tutor-calendar__hero-icon {
  width: 48px;
  height: 48px;
  border-radius: 1rem;
  background: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
}

#{{ component_id }} .tutor-calendar__pet-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

#{{ component_id }} .tutor-calendar__pet-filter-control {
  flex: 1 1 220px;
  min-width: 200px;
}

#{{ component_id }} .tutor-calendar__pet-filter-control--search {
  flex: 2 1 300px;
  min-width: 240px;
}

#{{ component_id }} .tutor-calendar__pet-filter-control .input-group-text {
  background: rgba(99, 102, 241, 0.12);
  border-color: rgba(99, 102, 241, 0.25);
  color: #4338ca;
}

#{{ component_id }} .tutor-calendar__pet-filter-control .form-control,
#{{ component_id }} .tutor-calendar__pet-filter-control .form-select {
  border-radius: 0.75rem;
}

#{{ component_id }} .tutor-calendar__pet-filter-actions {
  flex: 0 0 auto;
  min-width: 160px;
}

#{{ component_id }} .tutor-calendar__pet-filter-actions .btn {
  border-radius: 999px;
}

#{{ component_id }} .tutor-calendar__quick-tutor {
  border-radius: 1.75rem;
  box-shadow: 0 28px 45px -30px rgba(15, 23, 42, 0.35);
  overflow: hidden;
  background: var(--bs-body-bg, #fff);
}

#{{ component_id }} .tutor-calendar__quick-tutor-hero {
  display: grid;
  gap: 1.75rem;
  align-items: center;
  padding: clamp(1.5rem, 2vw + 1rem, 2.75rem);
  background: linear-gradient(125deg, rgba(14, 165, 233, 0.9) 0%, rgba(79, 70, 229, 0.9) 100%);
  color: #f8fafc;
}

#{{ component_id }} .tutor-calendar__quick-tutor-icon {
  width: 72px;
  height: 72px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 24px;
  background: rgba(255, 255, 255, 0.18);
  font-size: 2rem;
}

#{{ component_id }} .tutor-calendar__quick-tutor-eyebrow {
  letter-spacing: 0.12em;
  text-transform: uppercase;
  font-size: 0.75rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
  color: rgba(248, 250, 252, 0.85);
}

#{{ component_id }} .tutor-calendar__quick-tutor-title {
  font-size: clamp(1.25rem, 2vw + 1rem, 1.75rem);
  font-weight: 700;
  margin-bottom: 0.75rem;
}

#{{ component_id }} .tutor-calendar__quick-tutor-description {
  margin-bottom: 1.25rem;
  max-width: 46ch;
  color: rgba(241, 245, 249, 0.9);
}

#{{ component_id }} .tutor-calendar__quick-tutor-actions .btn {
  border-radius: 999px;
  box-shadow: 0 12px 24px -18px rgba(15, 23, 42, 0.7);
  font-weight: 600;
}

#{{ component_id }} .tutor-calendar__quick-tutor-highlights {
  list-style: none;
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin: 0;
  padding: 0;
}

#{{ component_id }} .tutor-calendar__quick-tutor-highlights li {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.25);
  backdrop-filter: blur(4px);
  font-size: 0.875rem;
}

#{{ component_id }} .tutor-calendar__quick-tutor-highlights i {
  font-size: 1rem;
}

#{{ component_id }} .tutor-calendar__quick-tutor-body {
  display: grid;
  gap: clamp(1.5rem, 2vw, 2.5rem);
  padding: clamp(1.5rem, 2vw + 1rem, 2.75rem);
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
  grid-template-columns: minmax(0, 1.8fr) minmax(0, 1fr);
}

#{{ component_id }} .tutor-calendar__quick-tutor-form {
  background: var(--bs-body-bg, #fff);
  border-radius: 1.25rem;
  padding: clamp(1.25rem, 1.5vw + 1rem, 2rem);
  box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.05), 0 24px 40px -32px rgba(15, 23, 42, 0.35);
}

#{{ component_id }} .tutor-calendar__quick-tutor-support {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

#{{ component_id }} .tutor-calendar__quick-tutor-support-card {
  background: rgba(255, 255, 255, 0.92);
  border-radius: 1.25rem;
  padding: 1.5rem;
  box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.35);
  border: 1px solid rgba(148, 163, 184, 0.25);
}

#{{ component_id }} .tutor-calendar__quick-tutor-support-title {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: #0f172a;
}

#{{ component_id }} .tutor-calendar__quick-tutor-steps {
  counter-reset: quick-tutor-step;
  margin: 0;
  padding: 0;
  list-style: none;
  display: grid;
  gap: 0.75rem;
}

#{{ component_id }} .tutor-calendar__quick-tutor-steps li {
  position: relative;
  padding-left: 2.75rem;
  font-size: 0.95rem;
  color: #1f2937;
}

#{{ component_id }} .tutor-calendar__quick-tutor-steps li::before {
  counter-increment: quick-tutor-step;
  content: counter(quick-tutor-step);
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 2rem;
  height: 2rem;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, rgba(14, 165, 233, 0.9), rgba(79, 70, 229, 0.9));
  color: #fff;
  font-weight: 600;
  box-shadow: 0 12px 24px -16px rgba(79, 70, 229, 0.6);
}

#{{ component_id }} .tutor-calendar__quick-tutor-tips {
  list-style: none;
  margin: 0;
  padding: 0;
  display: grid;
  gap: 0.75rem;
  font-size: 0.95rem;
  color: #1f2937;
}

#{{ component_id }} .tutor-calendar__quick-tutor-tips li {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
}

#{{ component_id }} .tutor-calendar__quick-tutor-tips i {
  color: #4f46e5;
  font-size: 1rem;
  margin-top: 0.2rem;
}

@media (max-width: 992px) {
  #{{ component_id }} .tutor-calendar__quick-tutor-body {
    grid-template-columns: 1fr;
  }

  #{{ component_id }} .tutor-calendar__quick-tutor-support {
    order: -1;
  }
}

@media (max-width: 768px) {
  #{{ component_id }} .tutor-calendar__quick-tutor-hero {
    text-align: center;
    justify-items: center;
  }

  #{{ component_id }} .tutor-calendar__quick-tutor-highlights {
    justify-content: center;
  }

  #{{ component_id }} .tutor-calendar__quick-tutor-actions .btn {
    width: 100%;
  }

  #{{ component_id }} .tutor-calendar__quick-tutor-form {
    padding: 1.25rem;
  }
}

#{{ component_id }} .tutor-calendar__pet-filter-actions .btn:disabled {
  opacity: 0.6;
}

@media (max-width: 576px) {
  #{{ component_id }} .tutor-calendar__pet-filter-control,
  #{{ component_id }} .tutor-calendar__pet-filter-actions {
    min-width: 100%;
  }

  #{{ component_id }} .tutor-calendar__pet-filter-actions .btn {
    width: 100%;
  }
}

#{{ component_id }} .tutor-calendar__pet-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 0.75rem;
  max-height: 320px;
  overflow-y: auto;
  padding-right: 0.25rem;
  align-content: start;
  transition: max-height 0.3s ease;
}

#{{ component_id }} .tutor-calendar__pet-list.is-expanded {
  max-height: none;
  overflow: visible;
  padding-right: 0;
}

@media (max-width: 575.98px) {
  #{{ component_id }} .tutor-calendar__pet-list {
    max-height: none;
    overflow-y: visible;
    padding-right: 0;
  }

  #{{ component_id }} [data-toggle-pets] {
    display: none !important;
  }
}

#{{ component_id }} .tutor-calendar__pet {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 0.9rem;
  border-radius: 0.9rem;
  border: 1px solid rgba(99, 102, 241, 0.15);
  background: var(--tutor-calendar-card-bg);
  box-shadow: 0 4px 16px rgba(15, 23, 42, 0.04);
  color: inherit;
  text-decoration: none;
  transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
}

#{{ component_id }} .tutor-calendar__pet.tutor-calendar__pet--link {
  cursor: pointer;
}

#{{ component_id }} .tutor-calendar__pet.tutor-calendar__pet--link:hover {
  border-color: rgba(99, 102, 241, 0.35);
  box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
  text-decoration: none;
  transform: translateY(-1px);
}

#{{ component_id }} .tutor-calendar__pet.tutor-calendar__pet--link:focus-visible {
  border-color: rgba(99, 102, 241, 0.5);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25), 0 8px 22px rgba(15, 23, 42, 0.08);
  outline: 0;
  text-decoration: none;
  transform: translateY(-1px);
}

#{{ component_id }} .tutor-calendar__pet-avatar {
  width: 48px;
  height: 48px;
  border-radius: 0.75rem;
  background: rgba(99, 102, 241, 0.12);
  color: #4338ca;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1rem;
  overflow: hidden;
}

#{{ component_id }} .tutor-calendar__pet-avatar.has-image {
  background: rgba(15, 23, 42, 0.08);
  padding: 0;
}

#{{ component_id }} .tutor-calendar__pet-avatar.has-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: inherit;
}

#{{ component_id }} .tutor-calendar__pet-content {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}

#{{ component_id }} .tutor-calendar__pet-heading {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}

#{{ component_id }} .tutor-calendar__pet-name {
  font-size: 0.95rem;
  color: var(--bs-body-color);
}

#{{ component_id }} .tutor-calendar__pet-detail {
  color: var(--bs-secondary-color, #64748b);
}

#{{ component_id }} .tutor-calendar__pet-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem 1rem;
  color: var(--bs-secondary-color, #64748b);
}

#{{ component_id }} .tutor-calendar__pet-meta-item {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
}

#{{ component_id }} .tutor-calendar__pet-meta-item i {
  font-size: 0.85rem;
  opacity: 0.7;
}

#{{ component_id }} .tutor-calendar__filters .btn {
  border-radius: 999px;
}

#{{ component_id }} .tutor-calendar__filters .btn.active {
  background: var(--bs-primary);
  color: #fff;
  border-color: var(--bs-primary);
}

#{{ component_id }} .tutor-calendar__view-toggle .btn {
  min-width: 88px;
}

#{{ component_id }} .tutor-calendar__view-toggle .btn.active {
  background: var(--bs-primary);
  color: #fff;
  border-color: var(--bs-primary);
}

@media (max-width: 575.98px) {
  #{{ component_id }} .tutor-calendar__view-toggle {
    display: flex;
    flex-wrap: wrap;
    width: 100%;
  }

  #{{ component_id }} .tutor-calendar__view-toggle .btn {
    flex: 1 1 48%;
    min-width: 0;
    text-align: center;
  }
}

#{{ component_id }} .tutor-calendar__weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
  font-weight: 600;
  color: var(--bs-gray-600);
  gap: 0.5rem;
  margin-bottom: 0.25rem;
}

#{{ component_id }} .tutor-calendar__weekdays > div {
  padding: 0.25rem;
  text-transform: uppercase;
  font-size: 0.8rem;
}

#{{ component_id }} .tutor-calendar__days {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 0.75rem;
}

#{{ component_id }} .tutor-calendar__week {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
}

#{{ component_id }} .tutor-calendar__week-day-card {
  flex: 1 1 220px;
  min-width: 200px;
  border-radius: 1rem;
  padding: 0.75rem;
  background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
  border: 1px solid rgba(148, 163, 184, 0.3);
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
  cursor: pointer;
}

#{{ component_id }} .tutor-calendar__week-day-card:hover {
  border-color: rgba(99, 102, 241, 0.55);
  box-shadow: 0 14px 30px rgba(99, 102, 241, 0.15);
  transform: translateY(-1px);
}

#{{ component_id }} .tutor-calendar__week-day-card.is-outside {
  opacity: 0.65;
}

#{{ component_id }} .tutor-calendar__week-day-card.is-today {
  border-color: var(--bs-primary);
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
}

#{{ component_id }} .tutor-calendar__week-day-card .tutor-calendar__event-list {
  flex-grow: 1;
  overflow: visible;
  max-height: none;
  padding-right: 0;
}

#{{ component_id }} .tutor-calendar__day {
  min-height: 160px;
  max-height: 220px;
  border-radius: 1rem;
  padding: 0.75rem;
  background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
  border: 1px solid rgba(148, 163, 184, 0.3);
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
  cursor: pointer;
  overflow: hidden;
}

#{{ component_id }} .tutor-calendar__day:hover {
  border-color: rgba(99, 102, 241, 0.55);
  box-shadow: 0 14px 30px rgba(99, 102, 241, 0.15);
  transform: translateY(-1px);
}

#{{ component_id }} .tutor-calendar__day.is-outside {
  opacity: 0.45;
}

#{{ component_id }} .tutor-calendar__day.is-today {
  border-color: var(--bs-primary);
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
}

#{{ component_id }} .tutor-calendar__date {
  font-weight: 700;
  font-size: 1rem;
  color: var(--bs-gray-900);
}

#{{ component_id }} .tutor-calendar__day-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}

#{{ component_id }} .tutor-calendar__date-count {
  margin-left: auto;
  background: var(--bs-primary);
  color: #fff;
  border-radius: 999px;
  font-size: 0.7rem;
  font-weight: 600;
  padding: 0.1rem 0.45rem;
  line-height: 1.2;
  min-width: 1.5rem;
  text-align: center;
}

#{{ component_id }} .tutor-calendar__event-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

#{{ component_id }} .tutor-calendar__day .tutor-calendar__event-list {
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
  padding-right: 0.25rem;
  scrollbar-width: thin;
}

#{{ component_id }} .tutor-calendar__day .tutor-calendar__event-list::-webkit-scrollbar {
  width: 4px;
}

#{{ component_id }} .tutor-calendar__day .tutor-calendar__event-list::-webkit-scrollbar-thumb {
  background: rgba(148, 163, 184, 0.4);
  border-radius: 999px;
}

#{{ component_id }} .tutor-calendar__layout {
  position: relative;
  min-height: 420px;
}

#{{ component_id }} .tutor-calendar__schedule {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  min-width: 0;
}

#{{ component_id }} .tutor-calendar__day-detail-layer {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  pointer-events: none;
  visibility: hidden;
  transition: visibility 0s linear 0.2s;
  z-index: 5;
  padding: 0.5rem;
}

#{{ component_id }} .tutor-calendar__day-detail-layer.is-open {
  pointer-events: auto;
  visibility: visible;
  transition-delay: 0s;
}

#{{ component_id }} .tutor-calendar__day-detail-backdrop {
  position: absolute;
  inset: 0;
  border-radius: 1rem;
  background: rgba(15, 23, 42, 0.25);
  opacity: 0;
  transition: opacity 0.2s ease;
}

#{{ component_id }} .tutor-calendar__day-detail-layer.is-open .tutor-calendar__day-detail-backdrop {
  opacity: 1;
}

#{{ component_id }} .tutor-calendar__day-detail {
  position: relative;
  margin: 1rem auto;
  width: min(80%, 1040px);
  max-height: min(85vh, 680px);
  overflow-y: auto;
  border-radius: 1.25rem;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
  box-shadow: 0 24px 48px rgba(15, 23, 42, 0.2);
  padding: 1.75rem 2rem;
  opacity: 0;
  transform: translateY(1rem) scale(0.98);
  transition: transform 0.25s ease, opacity 0.25s ease, border-color 0.2s ease, box-shadow 0.2s ease;
  outline: none;
}

#{{ component_id }} .tutor-calendar__day-detail-layer.is-open .tutor-calendar__day-detail {
  opacity: 1;
  transform: translateY(0) scale(1);
}

#{{ component_id }} .tutor-calendar__day-detail:hover {
  border-color: rgba(99, 102, 241, 0.45);
  box-shadow: 0 22px 40px rgba(99, 102, 241, 0.2);
}

#{{ component_id }} .tutor-calendar__day-detail-controls {
  position: absolute;
  top: 1rem;
  right: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  z-index: 2;
}

#{{ component_id }} .tutor-calendar__day-detail-back {
  border: none;
  background: rgba(99, 102, 241, 0.12);
  color: #4338ca;
  border-radius: 999px;
  padding: 0.35rem 0.85rem;
  font-size: 0.75rem;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
}

#{{ component_id }} .tutor-calendar__day-detail-back i {
  font-size: 1rem;
}

#{{ component_id }} .tutor-calendar__day-detail-back:hover,
#{{ component_id }} .tutor-calendar__day-detail-back:focus {
  background: rgba(79, 70, 229, 0.18);
  color: #312e81;
  transform: translateY(-1px);
}

#{{ component_id }} .tutor-calendar__day-detail-back:focus {
  outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
}

#{{ component_id }} .tutor-calendar__day-detail-close {
  border: none;
  background: rgba(15, 23, 42, 0.05);
  color: var(--bs-gray-700);
  border-radius: 50%;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
}

#{{ component_id }} .tutor-calendar__day-detail-close-icon {
  display: block;
  font-size: 1.15rem;
  font-weight: 700;
  line-height: 1;
}

#{{ component_id }} .tutor-calendar__day-detail-close:hover,
#{{ component_id }} .tutor-calendar__day-detail-close:focus {
  background: rgba(99, 102, 241, 0.16);
  color: #4338ca;
  transform: scale(1.05);
}

#{{ component_id }} .tutor-calendar__day-detail-close:focus {
  outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
}

#{{ component_id }} .tutor-calendar__day-detail-back {
  max-width: min(220px, 60vw);
}

#{{ component_id }} .tutor-calendar__day-detail-back-text {
  display: inline-block;
  white-space: normal;
  line-height: 1.2;
  text-align: left;
}

#{{ component_id }} .tutor-calendar__day-detail-content {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

#{{ component_id }} .tutor-calendar__day-detail-placeholder {
  text-align: center;
  padding: 1.5rem 0.5rem;
}

#{{ component_id }} .tutor-calendar__day-detail-header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
  padding-right: clamp(2.5rem, 6vw, 9rem);
}

#{{ component_id }} .tutor-calendar__day-detail-actions {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

#{{ component_id }} .tutor-calendar__day-detail-actions-text {
  font-size: 0.85rem;
  color: var(--bs-gray-600);
  flex: 1 1 auto;
}

#{{ component_id }} .tutor-calendar__day-detail-date {
  font-weight: 700;
  font-size: 1rem;
  text-transform: capitalize;
  color: var(--bs-gray-900);
}

#{{ component_id }} .tutor-calendar__day-detail-count {
  background: rgba(99, 102, 241, 0.12);
  color: #4338ca;
  border-radius: 999px;
  padding: 0.25rem 0.75rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

#{{ component_id }} .tutor-calendar__day-detail-empty {
  padding: 1rem;
  text-align: center;
  border-radius: 0.75rem;
  background: rgba(226, 232, 240, 0.45);
  color: var(--bs-gray-600);
}

#{{ component_id }} .tutor-calendar__day-detail-card {
  border-radius: 1rem;
  border: 1px solid rgba(99, 102, 241, 0.2);
  background: var(--tutor-calendar-card-bg);
  box-shadow: 0 16px 36px rgba(15, 23, 42, 0.12);
  padding: 0.9rem 1.1rem;
  display: flex;
  flex-direction: column;
  gap: 0.85rem;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
}

#{{ component_id }} .tutor-calendar__day-detail-card + .tutor-calendar__day-detail-card {
  margin-top: 0.75rem;
}

#{{ component_id }} .tutor-calendar__day-detail-card:hover {
  transform: translateY(-1px);
  border-color: rgba(99, 102, 241, 0.35);
  box-shadow: 0 20px 44px rgba(15, 23, 42, 0.14);
}

#{{ component_id }} .tutor-calendar__day-detail-card:focus-visible {
  outline: 3px solid rgba(59, 130, 246, 0.35);
  outline-offset: 4px;
}

#{{ component_id }} .tutor-calendar__day-detail-card.is-active {
  border-color: var(--bs-primary);
  box-shadow: 0 22px 54px rgba(37, 99, 235, 0.25);
}

#{{ component_id }} .tutor-calendar__appointment-card {
  position: relative;
  border-radius: 1.25rem;
  border: 1px solid rgba(148, 163, 184, 0.28);
  background: linear-gradient(180deg, rgba(248, 250, 252, 0.9) 0%, #ffffff 100%);
  box-shadow: 0 18px 48px rgba(15, 23, 42, 0.14);
  padding: 1.75rem;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

#{{ component_id }} .tutor-calendar__appointment-card--exam {
  background: linear-gradient(180deg, rgba(237, 233, 254, 0.85) 0%, #ffffff 100%);
}

#{{ component_id }} .tutor-calendar__appointment-card--vaccine {
  background: linear-gradient(180deg, rgba(254, 240, 138, 0.65) 0%, #ffffff 100%);
}

#{{ component_id }} .tutor-calendar__appointment-card--grooming {
  background: linear-gradient(180deg, rgba(252, 231, 243, 0.75) 0%, #ffffff 100%);
}

#{{ component_id }} .tutor-calendar__appointment-top {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 1rem 1.5rem;
}

#{{ component_id }} .tutor-calendar__appointment-time {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex: 1 1 220px;
}

#{{ component_id }} .tutor-calendar__appointment-time-text {
  display: flex;
  flex-direction: column;
  gap: 0.15rem;
  line-height: 1.1;
}

#{{ component_id }} .tutor-calendar__appointment-subtitle {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--bs-gray-500);
}

#{{ component_id }} .tutor-calendar__appointment-time-value {
  font-size: 1.35rem;
  font-weight: 700;
  color: var(--bs-gray-900);
}

#{{ component_id }} .tutor-calendar__appointment-pill {
  border-radius: 999px;
  padding: 0.35rem 0.9rem;
  font-size: 0.72rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  background: rgba(99, 102, 241, 0.15);
  color: #4338ca;
}

#{{ component_id }} .tutor-calendar__appointment-card--exam .tutor-calendar__appointment-pill {
  background: rgba(139, 92, 246, 0.18);
  color: #5b21b6;
}

#{{ component_id }} .tutor-calendar__appointment-card--vaccine .tutor-calendar__appointment-pill {
  background: rgba(250, 204, 21, 0.2);
  color: #a16207;
}

#{{ component_id }} .tutor-calendar__appointment-card--grooming .tutor-calendar__appointment-pill {
  background: rgba(236, 72, 153, 0.18);
  color: #be185d;
}

#{{ component_id }} .tutor-calendar__appointment-status {
  margin-left: auto;
  font-size: 0.8rem;
}

#{{ component_id }} .tutor-calendar__appointment-icon {
  width: 46px;
  height: 46px;
  border-radius: 1rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  background: rgba(59, 130, 246, 0.18);
  color: #1d4ed8;
}

#{{ component_id }} .tutor-calendar__appointment-icon.is-time {
  background: rgba(59, 130, 246, 0.18);
  color: #1d4ed8;
}

#{{ component_id }} .tutor-calendar__appointment-icon.is-pet {
  background: rgba(248, 113, 113, 0.16);
  color: #b91c1c;
}

#{{ component_id }} .tutor-calendar__appointment-icon.is-tutor {
  background: rgba(250, 204, 21, 0.22);
  color: #92400e;
}

#{{ component_id }} .tutor-calendar__appointment-icon.is-vet {
  background: rgba(45, 212, 191, 0.2);
  color: #0f766e;
}

#{{ component_id }} .tutor-calendar__appointment-icon.is-note {
  background: rgba(99, 102, 241, 0.18);
  color: #4338ca;
}

#{{ component_id }} .tutor-calendar__appointment-people {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1rem;
}

#{{ component_id }} .tutor-calendar__appointment-person {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 0.9rem 1rem;
  border-radius: 1rem;
  border: 1px solid rgba(148, 163, 184, 0.25);
  background: rgba(248, 250, 252, 0.85);
}

#{{ component_id }} .tutor-calendar__appointment-person-text {
  display: flex;
  flex-direction: column;
  gap: 0.15rem;
}

#{{ component_id }} .tutor-calendar__appointment-person-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--bs-gray-500);
}

#{{ component_id }} .tutor-calendar__appointment-person-value {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--bs-gray-900);
  word-break: break-word;
}

#{{ component_id }} .tutor-calendar__appointment-meta {
  padding-top: 0.75rem;
  border-top: 1px dashed rgba(148, 163, 184, 0.4);
  gap: 0.5rem;
}

#{{ component_id }} .tutor-calendar__appointment-meta dt {
  color: var(--bs-gray-500);
}

#{{ component_id }} .tutor-calendar__appointment-meta dd {
  font-weight: 500;
}

#{{ component_id }} .tutor-calendar__appointment-notes {
  display: flex;
  gap: 0.9rem;
  align-items: flex-start;
  border-radius: 1rem;
  border: 1px solid rgba(59, 130, 246, 0.2);
  background: rgba(219, 234, 254, 0.6);
  padding: 1rem 1.25rem;
}

#{{ component_id }} .tutor-calendar__appointment-notes-body {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}

#{{ component_id }} .tutor-calendar__appointment-notes-title {
  font-weight: 600;
  font-size: 0.85rem;
  color: #1d4ed8;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

#{{ component_id }} .tutor-calendar__appointment-notes-text {
  margin: 0;
  font-size: 0.85rem;
  color: var(--bs-gray-800);
  white-space: pre-line;
}

#{{ component_id }} .tutor-calendar__appointment-actions {
  border-radius: 1rem;
  border: 1px solid rgba(99, 102, 241, 0.16);
  background: linear-gradient(180deg, rgba(99, 102, 241, 0.08) 0%, rgba(248, 250, 252, 0.95) 100%);
  padding: 1.25rem 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.9rem;
}

#{{ component_id }} .tutor-calendar__appointment-actions-title {
  margin: 0;
  font-size: 0.78rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: #4338ca;
}

#{{ component_id }} .tutor-calendar__appointment-actions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 0.75rem;
}

#{{ component_id }} .tutor-calendar__appointment-action {
  width: 100%;
}

#{{ component_id }} .tutor-calendar__appointment-action.btn {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.35rem;
}

#{{ component_id }} .tutor-calendar__appointment-action .btn {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.35rem;
}

#{{ component_id }} .tutor-calendar__appointment-actions-grid > form {
  margin: 0;
}

#{{ component_id }} .tutor-calendar__appointment-actions-grid > form .btn {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.35rem;
}

#{{ component_id }} .tutor-calendar__appointment-status-detail {
  margin-top: 0.75rem;
}

#{{ component_id }} .tutor-calendar__appointment-status-detail .badge {
  font-size: 0.7rem;
  letter-spacing: 0.03em;
  text-transform: uppercase;
}

#{{ component_id }} .tutor-calendar__appointment-return-info {
  margin-top: 0.5rem;
  color: var(--bs-secondary-color, #6c757d);
  font-size: 0.85rem;
}

#{{ component_id }} .tutor-calendar__appointment-actions .btn.is-loading {
  opacity: 0.65;
  pointer-events: none;
  cursor: wait;
}

#{{ component_id }} .tutor-calendar__day-detail-meta {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: flex-start;
  gap: 0.5rem;
}

#{{ component_id }} .tutor-calendar__day-detail-time {
  font-weight: 700;
  color: var(--bs-primary);
  font-size: 0.92rem;
  letter-spacing: 0.02em;
}

#{{ component_id }} .tutor-calendar__day-detail-type {
  border-radius: 999px;
  padding: 0.25rem 0.6rem;
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  background: rgba(59, 130, 246, 0.16);
  color: #1d4ed8;
}

#{{ component_id }} .tutor-calendar__day-detail-status {
  border-radius: 999px;
  padding: 0.25rem 0.7rem;
  font-size: 0.72rem;
  font-weight: 600;
  letter-spacing: 0.03em;
  background: rgba(59, 130, 246, 0.16);
  color: #1d4ed8;
}

#{{ component_id }} .tutor-calendar__day-detail-status.status-completed {
  background: rgba(22, 163, 74, 0.15);
  color: #15803d;
}

#{{ component_id }} .tutor-calendar__day-detail-status.status-canceled {
  background: rgba(239, 68, 68, 0.16);
  color: #b91c1c;
}

#{{ component_id }} .tutor-calendar__day-detail-status.status-accepted {
  background: rgba(14, 165, 233, 0.16);
  color: #0369a1;
}

#{{ component_id }} .tutor-calendar__day-detail-card--exam .tutor-calendar__day-detail-type {
  background: rgba(139, 92, 246, 0.18);
  color: #5b21b6;
}

#{{ component_id }} .tutor-calendar__day-detail-card--vaccine .tutor-calendar__day-detail-type {
  background: rgba(250, 204, 21, 0.24);
  color: #a16207;
}

#{{ component_id }} .tutor-calendar__day-detail-card--grooming .tutor-calendar__day-detail-type {
  background: rgba(236, 72, 153, 0.2);
  color: #be185d;
}

#{{ component_id }} .tutor-calendar__day-detail-title {
  font-size: 1rem;
  margin: 0;
  font-weight: 600;
  color: var(--bs-gray-900);
}

#{{ component_id }} .tutor-calendar__day-detail-pet {
  font-size: 0.85rem;
  color: var(--bs-gray-600);
}

#{{ component_id }} .tutor-calendar__day-detail-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 0.75rem;
  margin: 0;
  padding: 0;
}

#{{ component_id }} .tutor-calendar__day-detail-info-item {
  background: rgba(241, 245, 249, 0.7);
  border-radius: 0.9rem;
  padding: 0.75rem 0.9rem;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

#{{ component_id }} .tutor-calendar__day-detail-info dt {
  margin: 0;
  font-size: 0.68rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--bs-gray-600);
}

#{{ component_id }} .tutor-calendar__day-detail-info dd {
  margin: 0;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--bs-gray-900);
  word-break: break-word;
}

#{{ component_id }} .tutor-calendar__day-detail-info-item--compact {
  background: transparent;
  padding: 0;
  border-radius: 0;
  gap: 0.2rem;
}

#{{ component_id }} .tutor-calendar__day-detail-info-item--compact dt {
  color: var(--bs-gray-500);
}

#{{ component_id }} .tutor-calendar__day-detail-info-item--compact dd {
  font-weight: 500;
  color: var(--bs-gray-800);
}

#{{ component_id }} .tutor-calendar__day.is-selected,
#{{ component_id }} .tutor-calendar__week-day-card.is-selected {
  border-color: rgba(99, 102, 241, 0.75);
  box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.12);
  background: linear-gradient(180deg, #eef2ff 0%, #ffffff 100%);
}

@media (max-width: 767.98px) {
  #{{ component_id }} .tutor-calendar__day-detail-layer {
    justify-content: center;
    padding: 0.75rem;
  }

  #{{ component_id }} .tutor-calendar__day-detail {
    margin: 0.5rem auto;
    width: min(100%, 560px);
    max-height: min(90vh, 620px);
    padding: 1.25rem 1.35rem;
  }
}

@media (min-width: 768px) {
  #{{ component_id }} .tutor-calendar__day-detail-layer {
    justify-content: center;
    padding: 2rem 1.5rem;
  }

  #{{ component_id }} .tutor-calendar__day-detail {
    margin: 0 auto;
  }
}

#{{ component_id }} .tutor-calendar__event {
  border-radius: 0.85rem;
  padding: 0.5rem 0.75rem;
  background: rgba(226, 232, 240, 0.6);
  border: 1px solid transparent;
  border-left-width: 4px;
  border-left-style: solid;
  border-left-color: transparent;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  font-size: 0.85rem;
  transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, border-left-color 0.2s ease;
}

#{{ component_id }} .tutor-calendar__event:hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
  border-color: rgba(99, 102, 241, 0.25);
}

#{{ component_id }} .tutor-calendar__event.is-active {
  border-color: var(--bs-primary) !important;
  box-shadow: 0 10px 22px rgba(37, 99, 235, 0.25);
  transform: translateY(-2px);
}

#{{ component_id }} .tutor-calendar__event-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}

#{{ component_id }} .tutor-calendar__event-status {
  margin-left: auto;
  border-radius: 999px;
  padding: 0.2rem 0.6rem;
  font-size: 0.65rem;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  background: rgba(59, 130, 246, 0.16);
  color: #1d4ed8;
}

#{{ component_id }} .tutor-calendar__event-status.status-completed {
  background: rgba(22, 163, 74, 0.15);
  color: #15803d;
}

#{{ component_id }} .tutor-calendar__event-status.status-canceled {
  background: rgba(239, 68, 68, 0.16);
  color: #b91c1c;
}

#{{ component_id }} .tutor-calendar__event-status.status-accepted {
  background: rgba(14, 165, 233, 0.16);
  color: #0369a1;
}

#{{ component_id }} .tutor-calendar__event--appointment {
  background: rgba(59, 130, 246, 0.14);
  border-color: rgba(59, 130, 246, 0.35);
  border-left-color: rgba(59, 130, 246, 0.55);
}

#{{ component_id }} .tutor-calendar__event--appointment.status-completed {
  background: rgba(22, 163, 74, 0.14);
  border-color: rgba(22, 163, 74, 0.35);
  border-left-color: rgba(22, 163, 74, 0.6);
}

#{{ component_id }} .tutor-calendar__event--appointment.status-canceled {
  background: rgba(248, 113, 113, 0.16);
  border-color: rgba(239, 68, 68, 0.35);
  border-left-color: rgba(239, 68, 68, 0.6);
}

#{{ component_id }} .tutor-calendar__event--appointment.status-accepted {
  background: rgba(14, 165, 233, 0.14);
  border-color: rgba(14, 165, 233, 0.35);
  border-left-color: rgba(14, 165, 233, 0.6);
}

#{{ component_id }} .tutor-calendar__event--appointment.status-completed .tutor-calendar__event-title {
  color: #14532d;
}

#{{ component_id }} .tutor-calendar__event--appointment.status-completed .tutor-calendar__event-pet {
  color: #166534;
}

#{{ component_id }} .tutor-calendar__event--appointment.status-canceled .tutor-calendar__event-title {
  color: #b91c1c;
}

#{{ component_id }} .tutor-calendar__event--appointment.status-canceled .tutor-calendar__event-pet {
  color: #dc2626;
}

#{{ component_id }} .tutor-calendar__event--appointment.status-accepted .tutor-calendar__event-title {
  color: #0e7490;
}

#{{ component_id }} .tutor-calendar__event--appointment.status-accepted .tutor-calendar__event-pet {
  color: #0e7490;
}

#{{ component_id }} .tutor-calendar__event--exam {
  background: rgba(139, 92, 246, 0.14);
  border-color: rgba(139, 92, 246, 0.35);
}

#{{ component_id }} .tutor-calendar__event--vaccine {
  background: rgba(250, 204, 21, 0.18);
  border-color: rgba(250, 204, 21, 0.45);
}

#{{ component_id }} .tutor-calendar__event--grooming {
  background: rgba(244, 114, 182, 0.18);
  border-color: rgba(236, 72, 153, 0.45);
  border-left-color: rgba(236, 72, 153, 0.65);
}

#{{ component_id }} .tutor-calendar__event--grooming.status-completed {
  background: rgba(22, 163, 74, 0.14);
  border-color: rgba(22, 163, 74, 0.35);
  border-left-color: rgba(22, 163, 74, 0.6);
}

#{{ component_id }} .tutor-calendar__event--grooming.status-canceled {
  background: rgba(248, 113, 113, 0.16);
  border-color: rgba(239, 68, 68, 0.35);
  border-left-color: rgba(239, 68, 68, 0.6);
}

#{{ component_id }} .tutor-calendar__event--grooming.status-accepted {
  background: rgba(14, 165, 233, 0.14);
  border-color: rgba(14, 165, 233, 0.35);
  border-left-color: rgba(14, 165, 233, 0.6);
}

#{{ component_id }} .tutor-calendar__event-time {
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--bs-gray-700);
  font-size: 0.75rem;
}

#{{ component_id }} .tutor-calendar__event-title {
  font-weight: 600;
  color: var(--bs-gray-900);
}

#{{ component_id }} .tutor-calendar__event-pet {
  font-size: 0.75rem;
  color: var(--bs-gray-600);
}

#{{ component_id }} .appointments-day-block--calendar {
  margin: 1rem 0 0;
}

#{{ component_id }} .appointments-day-block--calendar .day-header {
  margin: 0 0 0.75rem 0;
  border-radius: 0.85rem;
}

#{{ component_id }} .appointments-day-block--calendar .appointment-card {
  margin-bottom: 0;
}

#{{ component_id }} .appointments-day-block--calendar .actions-container {
  justify-content: flex-start;
}

#{{ component_id }} .tutor-calendar__empty {
  padding: 0.75rem 0;
}

@media (max-width: 991.98px) {
  #{{ component_id }} .tutor-calendar__days {
    gap: 0.5rem;
  }

  #{{ component_id }} .tutor-calendar__day {
    min-height: 140px;
    max-height: 200px;
    padding: 0.65rem;
  }

  #{{ component_id }} .tutor-calendar__week {
    gap: 0.5rem;
  }

  #{{ component_id }} .tutor-calendar__week-day-card {
    min-width: 160px;
    padding: 0.6rem;
  }

  #{{ component_id }} .tutor-calendar__pet-list {
    max-height: none;
  }

  #{{ component_id }} .tutor-calendar__layout {
    gap: 1rem;
  }

  #{{ component_id }} .tutor-calendar__day-detail-info {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const root = document.getElementById('{{ component_id }}');
  if (!root) {
    return;
  }

  const eventsUrl = root.dataset.eventsUrl || '/api/my_appointments';
  const petsUrl = root.dataset.petsUrl || '/api/my_pets';
  const petListEl = root.querySelector('[data-pet-list]');
  const calendarGrid = root.querySelector('[data-calendar-grid]');
  const weekViewEl = root.querySelector('[data-week-view]');
  const weekdaysEl = root.querySelector('[data-weekdays]');
  const dayDetailContainer = root.querySelector('[data-day-detail]');
  const dayDetailLayer = root.querySelector('[data-day-detail-layer]');
  const dayDetailBackdrop = root.querySelector('[data-day-detail-backdrop]');
  const dayDetailControls = root.querySelector('[data-day-detail-controls]');
  const dayDetailBackBtn = root.querySelector('[data-back-to-day]');
  const dayDetailCloseBtn = root.querySelector('[data-close-day-detail]');
  const dayDetailContent = root.querySelector('[data-day-detail-content]');
  const dayDetailHeading = root.querySelector('[data-day-detail-heading]');
  const monthLabelEl = root.querySelector('[data-month-label]');
  const yearLabelEl = root.querySelector('[data-year-label]');
  const prevBtn = root.querySelector('[data-prev-month]');
  const nextBtn = root.querySelector('[data-next-month]');
  const todayBtn = root.querySelector('[data-today]');
  const newEventBtn = root.querySelector('[data-new-event]');
  const refreshPetsBtn = root.querySelector('[data-refresh-pets]');
  const togglePetsBtn = root.querySelector('[data-toggle-pets]');
  const petSubtitleEl = root.querySelector('[data-pet-subtitle]');
  const petFilterSearchInput = root.querySelector('[data-pet-filter-search]');
  const petFilterSpeciesSelect = root.querySelector('[data-pet-filter-species]');
  const petFilterBreedSelect = root.querySelector('[data-pet-filter-breed]');
  const petFilterClearBtn = root.querySelector('[data-pet-filter-clear]');
  const filterButtons = Array.prototype.slice.call(root.querySelectorAll('[data-filter]'));
  const viewModeButtons = Array.prototype.slice.call(root.querySelectorAll('[data-view-mode]'));
  const csrfToken = root.dataset.csrfToken || '';
  const urlTemplates = {
    animalProfile: root.dataset.urlAnimalProfile || '',
    tutorProfile: root.dataset.urlTutorProfile || '',
    consulta: root.dataset.urlConsulta || '',
    editAppointment: root.dataset.urlEditAppointment || '',
    status: root.dataset.urlStatus || '',
    deleteAppointment: root.dataset.urlDeleteAppointment || '',
    printConsulta: root.dataset.urlPrintConsulta || '',
  };
  const permissions = {
    canStartConsulta: root.dataset.canStartConsulta === 'true',
    canManageStatus: root.dataset.canManageStatus === 'true',
  };

  const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
  const typeLabels = {
    appointment: 'Consulta',
    consulta: 'Consulta',
    exam: 'Exame',
    vaccine: 'Vacina',
    grooming: 'Banho e Tosa',
  };
  const statusLabels = {
    scheduled: 'A fazer',
    completed: 'Realizada',
    canceled: 'Cancelada',
    accepted: 'Aceita',
  };
  const knownStatusKeys = Object.keys(statusLabels);
  const consultaStatusLabels = {
    finalizada: 'Finalizada',
    in_progress: 'Em andamento',
    draft: 'Rascunho',
  };
  const statusActionConfig = [
    {
      status: 'completed',
      label: 'Realizada',
      buttonClass: 'btn btn-sm btn-outline-success',
      icon: 'fa-solid fa-check me-1',
    },
    {
      status: 'canceled',
      label: 'Cancelar',
      buttonClass: 'btn btn-sm btn-outline-warning',
      icon: 'fa-solid fa-xmark me-1',
    },
    {
      status: 'scheduled',
      label: 'A fazer',
      buttonClass: 'btn btn-sm btn-outline-secondary',
      icon: 'fa-solid fa-clock me-1',
    },
  ];

  const petsInitialLimit = 3;
  const petsPageSize = 9;
  const sharedCalendarSourceId = 'tutor-calendar';

  const defaultDayDetailHeadingText = 'Detalhes do dia selecionado';

  let pets = [];
  let events = [];
  let allEvents = [];
  let activeVetFilterId = null;
  let viewDate = new Date();
  let currentViewMode = 'month';
  let currentFilter = 'all';
  let selectedDate = formatDateKey(new Date());
  let usingSharedCalendar = false;
  let isFetchingLocalEvents = false;
  let isDayDetailOpen = false;
  let lastDetailTrigger = null;
  let dayDetailMode = 'day';
  let focusedEventId = null;
  let hasLoadedPets = false;
  let petListHasError = false;
  let currentPetLimit = petsInitialLimit;
  let filteredPetsCache = [];
  const petFilterState = {
    search: '',
    species: '',
    breed: '',
  };

  function openDayDetail(options) {
    if (!dayDetailLayer || !dayDetailContainer) {
      return;
    }
    const opts = options && typeof options === 'object' ? options : {};
    const trigger = opts.trigger;
    if (trigger && typeof trigger.focus === 'function') {
      lastDetailTrigger = trigger;
    }
    isDayDetailOpen = true;
    dayDetailLayer.classList.add('is-open');
    dayDetailContainer.classList.add('is-open');
    dayDetailContainer.setAttribute('aria-hidden', 'false');
    if (opts.focus !== false && typeof dayDetailContainer.focus === 'function') {
      try {
        dayDetailContainer.focus({ preventScroll: true });
      } catch (error) {
        dayDetailContainer.focus();
      }
    }
  }

  function closeDayDetail(options) {
    if (!dayDetailLayer || !dayDetailContainer) {
      return;
    }
    const opts = options && typeof options === 'object' ? options : {};
    isDayDetailOpen = false;
    focusedEventId = null;
    dayDetailMode = 'day';
    updateEventFocusHighlight();
    dayDetailLayer.classList.remove('is-open');
    dayDetailContainer.classList.remove('is-open');
    dayDetailContainer.setAttribute('aria-hidden', 'true');
    const focusTarget = opts.trigger || lastDetailTrigger;
    if (opts.restoreFocus !== false && focusTarget && typeof focusTarget.focus === 'function') {
      try {
        focusTarget.focus({ preventScroll: true });
      } catch (error) {
        focusTarget.focus();
      }
    }
    updateDayDetailControls();
    updateDayDetailHeading();
  }

  function updateDayDetailHeading(text) {
    if (!dayDetailHeading) {
      return;
    }
    const value = typeof text === 'string' && text.trim() ? text : defaultDayDetailHeadingText;
    dayDetailHeading.textContent = value;
  }

  function updateDayDetailControls() {
    if (!dayDetailBackBtn) {
      return;
    }
    const shouldShowBack = dayDetailMode === 'event';
    if (shouldShowBack) {
      dayDetailBackBtn.removeAttribute('hidden');
      dayDetailBackBtn.setAttribute('aria-hidden', 'false');
    } else {
      dayDetailBackBtn.setAttribute('hidden', 'hidden');
      dayDetailBackBtn.setAttribute('aria-hidden', 'true');
    }
    if (dayDetailControls) {
      dayDetailControls.classList.toggle('has-back', shouldShowBack);
    }
  }

  function parseDate(value) {
    if (!value) {
      return null;
    }
    if (value instanceof Date) {
      return new Date(value.getTime());
    }
    if (typeof value === 'string') {
      const normalized = value.replace(/\s+/g, 'T');
      const parsed = new Date(normalized);
      if (!Number.isNaN(parsed.getTime())) {
        return parsed;
      }
    }
    return null;
  }

  function formatDateKey(date) {
    if (!(date instanceof Date)) {
      return '';
    }
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function parseDateKey(dateKey) {
    if (!dateKey || typeof dateKey !== 'string') {
      return null;
    }
    const parts = dateKey.split('-');
    if (parts.length !== 3) {
      return null;
    }
    const year = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1;
    const day = parseInt(parts[2], 10);
    if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) {
      return null;
    }
    const parsed = new Date(year, month, day);
    if (Number.isNaN(parsed.getTime())) {
      return null;
    }
    return parsed;
  }

  function buildScheduleButton(dateKey) {
    if (!dateKey) {
      return null;
    }
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'btn btn-primary btn-sm';
    button.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Agendar compromisso';
    button.addEventListener('click', function() {
      const parsed = parseDateKey(dateKey) || parseDate(dateKey);
      const slotDate = parsed instanceof Date ? parsed : dateKey;
      dispatchSlot(slotDate, '09:00');
    });
    return button;
  }

  function buildDayScheduleActions(dateKey) {
    const button = buildScheduleButton(dateKey);
    if (!button) {
      return null;
    }
    const wrapper = document.createElement('div');
    wrapper.className = 'tutor-calendar__day-detail-actions';
    const hintText = document.createElement('span');
    hintText.className = 'tutor-calendar__day-detail-actions-text';
    hintText.textContent = 'Precisa adicionar outro compromisso neste dia?';
    wrapper.appendChild(hintText);
    wrapper.appendChild(button);
    return wrapper;
  }

  function formatTime(date) {
    if (!(date instanceof Date)) {
      return '';
    }
    return date.toLocaleTimeString('pt-BR', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false,
    });
  }

  function formatDisplayDate(value) {
    let date = null;
    if (value instanceof Date) {
      date = value;
    } else if (typeof value === 'string') {
      date = parseDate(value) || parseDateKey(value);
    }
    if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
      return '';
    }
    return date.toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    });
  }

  function formatDuration(startDate, endDate) {
    if (!(startDate instanceof Date) || !(endDate instanceof Date)) {
      return '';
    }
    const diffMs = endDate.getTime() - startDate.getTime();
    if (!Number.isFinite(diffMs) || diffMs <= 0) {
      return '';
    }
    const totalMinutes = Math.round(diffMs / 60000);
    if (totalMinutes <= 0) {
      return '';
    }
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    const parts = [];
    if (hours > 0) {
      parts.push(`${hours}h`);
    }
    if (minutes > 0) {
      parts.push(`${minutes}min`);
    }
    if (!parts.length) {
      parts.push(`${totalMinutes}min`);
    }
    return parts.join(' ');
  }

  function humanizeLabel(value) {
    if (value === null || value === undefined) {
      return '';
    }
    const text = String(value).replace(/[_\-]+/g, ' ').trim();
    if (!text) {
      return '';
    }
    return text.charAt(0).toUpperCase() + text.slice(1);
  }

  function normalizeStatusKey(value) {
    if (value === null || value === undefined) {
      return '';
    }
    return String(value).trim().toLowerCase();
  }

  function isKnownStatus(key) {
    if (!key) {
      return false;
    }
    return knownStatusKeys.indexOf(key) !== -1;
  }

  function resolveStatusKey(value, typeKey) {
    const normalized = normalizeStatusKey(value);
    if (normalized) {
      return normalized;
    }
    return typeKey === 'appointment' ? 'scheduled' : '';
  }

  function getStartOfWeek(date) {
    const base = date instanceof Date ? new Date(date.getTime()) : parseDate(date);
    const target = base || new Date();
    const start = new Date(target.getFullYear(), target.getMonth(), target.getDate());
    const weekDay = start.getDay();
    start.setDate(start.getDate() - weekDay);
    return start;
  }

  function isSameDay(a, b) {
    if (!(a instanceof Date) || !(b instanceof Date)) {
      return false;
    }
    return a.getFullYear() === b.getFullYear() &&
      a.getMonth() === b.getMonth() &&
      a.getDate() === b.getDate();
  }

  function getPetName(animalId) {
    if (!animalId && animalId !== 0) {
      return null;
    }
    const target = String(animalId);
    const pet = pets.find(function(item) {
      return String(item.id) === target;
    });
    return pet ? pet.name : null;
  }

  function derivePetNameFromTitle(title) {
    if (!title) {
      return null;
    }
    const parts = String(title).split('-');
    if (!parts.length) {
      return title.trim() || null;
    }
    const candidate = parts[0].trim();
    return candidate || null;
  }

  function deriveVetNameFromTitle(title) {
    if (!title) {
      return null;
    }
    const parts = String(title).split('-');
    if (parts.length < 2) {
      return null;
    }
    const candidate = parts.slice(1).join('-').trim();
    return candidate || null;
  }

  function getEventKey(eventData) {
    if (!eventData) {
      return null;
    }
    if (eventData.id !== undefined && eventData.id !== null) {
      return String(eventData.id);
    }
    const raw = eventData.raw || {};
    if (raw.id !== undefined && raw.id !== null) {
      return String(raw.id);
    }
    const ext = raw.extendedProps || {};
    if (ext.recordId !== undefined && ext.recordId !== null) {
      return `appointment-${ext.recordId}`;
    }
    return null;
  }

  function findEventByRecordId(recordId) {
    if (recordId === undefined || recordId === null) {
      return null;
    }
    const target = String(recordId);
    if (!target) {
      return null;
    }
    const match = events.find(function(eventItem) {
      if (!eventItem) {
        return false;
      }
      if (eventItem.recordId !== undefined && eventItem.recordId !== null && String(eventItem.recordId) === target) {
        return true;
      }
      const ext = eventItem.raw && eventItem.raw.extendedProps ? eventItem.raw.extendedProps : null;
      return Boolean(ext && ext.recordId !== undefined && ext.recordId !== null && String(ext.recordId) === target);
    });
    return match || null;
  }

  function findEventByKey(eventKey) {
    if (eventKey === undefined || eventKey === null) {
      return null;
    }
    const target = String(eventKey);
    if (!target) {
      return null;
    }
    const directMatch = events.find(function(eventItem) {
      const key = getEventKey(eventItem);
      return Boolean(key && String(key) === target);
    });
    if (directMatch) {
      return directMatch;
    }
    if (target.indexOf('appointment-') === 0) {
      return findEventByRecordId(target.substring('appointment-'.length));
    }
    return null;
  }

  function findEventFromElement(element) {
    if (!element) {
      return null;
    }
    const dataset = element.dataset || {};
    if (dataset.eventId) {
      const byKey = findEventByKey(dataset.eventId);
      if (byKey) {
        return byKey;
      }
    }
    if (dataset.recordId) {
      return findEventByRecordId(dataset.recordId);
    }
    return null;
  }

  function fillUrlWithId(template, id) {
    if (!template || id === undefined || id === null) {
      return null;
    }
    const idStr = String(id);
    if (!idStr) {
      return null;
    }
    const pattern = /\/0(\/|$)/;
    if (pattern.test(template)) {
      return template.replace(pattern, `/${idStr}$1`);
    }
    return template.replace('0', idStr);
  }

  function appendQueryParam(url, key, value) {
    if (!url) {
      return null;
    }
    if (value === undefined || value === null) {
      return url;
    }
    try {
      const parsed = new URL(url, window.location.origin);
      parsed.searchParams.set(key, value);
      if (parsed.origin === window.location.origin) {
        return parsed.pathname + parsed.search + parsed.hash;
      }
      return parsed.toString();
    } catch (error) {
      const hasQuery = url.indexOf('?') !== -1;
      const separator = hasQuery ? '&' : '?';
      return `${url}${separator}${encodeURIComponent(key)}=${encodeURIComponent(value)}`;
    }
  }

  function buildConsultaUrl(animalId, appointmentId) {
    const base = fillUrlWithId(urlTemplates.consulta, animalId);
    if (!base) {
      return null;
    }
    return appendQueryParam(base, 'appointment_id', appointmentId);
  }

  function buildConsultaDetailUrl(animalId, consultaId) {
    const base = fillUrlWithId(urlTemplates.consulta, animalId);
    if (!base) {
      return null;
    }
    return consultaId ? appendQueryParam(base, 'c', consultaId) : base;
  }

  function buildConsultaPrintUrl(consultaId) {
    return fillUrlWithId(urlTemplates.printConsulta, consultaId);
  }

  function deriveAppointmentStatusDetail(statusKey, consultaStatus) {
    const status = statusKey ? String(statusKey) : '';
    const consulta = consultaStatus ? String(consultaStatus) : '';
    if (consulta === 'finalizada') {
      if (status === 'accepted') {
        return { label: 'Consulta finalizada e aceita', badgeClass: 'bg-success' };
      }
      return { label: 'Consulta finalizada', badgeClass: 'bg-success' };
    }
    if (status === 'accepted') {
      return { label: 'Consulta aceita e não finalizada', badgeClass: 'bg-secondary' };
    }
    if (status === 'completed') {
      return { label: 'Consulta finalizada', badgeClass: 'bg-success' };
    }
    if (status === 'canceled') {
      return { label: 'Consulta cancelada', badgeClass: 'bg-danger' };
    }
    if (status === 'scheduled') {
      return { label: 'Consulta agendada', badgeClass: 'bg-info text-dark' };
    }
    return null;
  }

  function updateEventFocusHighlight() {
    const activeKey = focusedEventId ? String(focusedEventId) : null;
    const nodes = root.querySelectorAll('[data-event-id]');
    nodes.forEach(function(node) {
      const key = node.dataset.eventId || (node.dataset.recordId ? `appointment-${node.dataset.recordId}` : null);
      node.classList.toggle('is-active', Boolean(activeKey && key === activeKey));
    });
  }

  function attachConfirmHandler(form) {
    if (!form || form.dataset.confirmBound === 'true') {
      return;
    }
    const message = form.getAttribute('data-confirm');
    form.dataset.confirmBound = 'true';
    if (!message) {
      return;
    }
    form.addEventListener('submit', function(event) {
      if (!window.confirm(message)) {
        event.preventDefault();
      }
    });
  }

  function updateEventStatusLocally(recordId, statusValue) {
    if (recordId === undefined || recordId === null) {
      return;
    }
    const targetId = String(recordId);
    const applyStatusUpdate = function(list) {
      let listMatched = false;
      (Array.isArray(list) ? list : []).forEach(function(eventItem) {
        if (!eventItem) {
          return;
        }
        const ext = eventItem.raw && eventItem.raw.extendedProps ? eventItem.raw.extendedProps : null;
        const eventRecordId = eventItem.recordId !== undefined && eventItem.recordId !== null
          ? String(eventItem.recordId)
          : (ext && ext.recordId !== undefined && ext.recordId !== null ? String(ext.recordId) : null);
        if (!eventRecordId || eventRecordId !== targetId) {
          return;
        }
        listMatched = true;
        const typeKey = getEventBaseType(eventItem) || 'appointment';
        const nextStatus = resolveStatusKey(statusValue, typeKey);
        eventItem.status = nextStatus;
        if (ext) {
          ext.status = nextStatus;
        }
      });
      return listMatched;
    };

    const matchedInEvents = applyStatusUpdate(events);
    const matchedInAllEvents = applyStatusUpdate(allEvents);
    if (matchedInEvents || matchedInAllEvents) {
      refreshEventsView();
    }
  }

  function attachStatusFormHandler(form, options) {
    if (!form || form.dataset.statusHandlerBound === 'true') {
      return;
    }
    const opts = options && typeof options === 'object' ? options : {};
    const targetStatus = opts.status;
    const providedRecordId = opts.recordId;
    form.dataset.statusHandlerBound = 'true';
    form.addEventListener('submit', function(event) {
      if (form.dataset.skipAjax === 'true') {
        return;
      }
      if (event.defaultPrevented) {
        return;
      }
      event.preventDefault();

      const submitButton = form.querySelector('button[type="submit"]');
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.classList.add('is-loading');
        submitButton.setAttribute('aria-busy', 'true');
      }

      const formData = new FormData(form);
      if (targetStatus && !formData.get('status')) {
        formData.append('status', targetStatus);
      }
      const requestedStatus = formData.get('status');

      const requestConfig = {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json',
        },
        credentials: 'same-origin',
        body: formData,
      };

      fetch(form.action, requestConfig)
        .then(function(response) {
          const parseJson = function() {
            return response.json().catch(function() {
              const error = new Error('Não foi possível interpretar a resposta do servidor.');
              error.isParseError = true;
              throw error;
            });
          };
          if (!response.ok) {
            return parseJson().then(function(data) {
              const error = new Error(data && data.message ? data.message : 'Não foi possível atualizar o status.');
              error.data = data;
              throw error;
            });
          }
          return parseJson();
        })
        .then(function(data) {
          if (!data || data.success !== true) {
            const error = new Error(data && data.message ? data.message : 'Não foi possível atualizar o status.');
            error.data = data;
            throw error;
          }
          const returnedStatus = data.status || requestedStatus;
          const responseRecordId = data.appointment_id !== undefined && data.appointment_id !== null
            ? data.appointment_id
            : null;
          const effectiveRecordId = providedRecordId !== undefined && providedRecordId !== null
            ? providedRecordId
            : (form.dataset.recordId || responseRecordId);
          if (effectiveRecordId !== undefined && effectiveRecordId !== null) {
            updateEventStatusLocally(effectiveRecordId, returnedStatus);
          }
        })
        .catch(function(error) {
          if (error && error.data) {
            const message = error.message || (error.data && error.data.message) || 'Não foi possível atualizar o status.';
            window.alert(message);
            return;
          }
          console.error('Falha ao atualizar status do compromisso.', error);
          form.dataset.skipAjax = 'true';
          setTimeout(function() {
            form.submit();
          }, 0);
        })
        .finally(function() {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.classList.remove('is-loading');
            submitButton.removeAttribute('aria-busy');
          }
        });
    });
  }

  function normalizeEvent(raw) {
    if (!raw) {
      return null;
    }
    const extended = raw.extendedProps || {};
    const rawTypeValue = raw.type || raw.eventType || raw.event_type || extended.eventType || extended.type || extended.event_type || '';
    const rawKindValue = extended.kind || raw.kind || raw.eventKind || raw.event_kind || '';
    const canonicalType = canonicalizeEventTypeKey(rawTypeValue);
    const normalizedRawType = normalizeFilterValue(rawTypeValue);
    const normalizedKind = normalizeFilterValue(rawKindValue);
    let baseType = canonicalType && canonicalType !== 'all' ? canonicalType : '';
    if (!baseType) {
      baseType = 'appointment';
    }
    if (isVaccineKind(normalizedKind)) {
      baseType = 'vaccine';
    } else if (baseType === 'grooming') {
      baseType = 'appointment';
    }
    let category = canonicalType && canonicalType !== 'all' ? canonicalType : baseType;
    if (isVaccineKind(normalizedKind)) {
      category = 'vaccine';
    } else if (baseType === 'appointment' && (category === 'grooming' || isGroomingKind(normalizedKind))) {
      category = 'grooming';
    }
    if (normalizedRawType === 'consulta' && baseType === 'appointment' && category === 'appointment') {
      category = 'consulta';
    }
    if (!category || category === 'all') {
      category = baseType || 'appointment';
    }

    const startValue = raw.start || raw.startStr || extended.start;
    const startDate = parseDate(startValue);
    const dateKey = startDate ? formatDateKey(startDate) : (raw.date || null);
    const timeText = startDate ? formatTime(startDate) : (raw.time || '');
    const animalId = raw.animalId || extended.animalId || extended.animal_id || null;
    const title = raw.title || extended.title || 'Evento';
    const recordIdValue = extended.recordId !== undefined && extended.recordId !== null
      ? extended.recordId
      : (raw.recordId !== undefined && raw.recordId !== null ? raw.recordId : null);
    const statusKey = resolveStatusKey(extended.status || raw.status, baseType);
    if (extended && statusKey) {
      extended.status = statusKey;
    }
    const recordId = recordIdValue !== undefined && recordIdValue !== null ? String(recordIdValue) : null;

    return {
      id: raw.id || (extended && extended.recordId) || null,
      recordId: recordId,
      status: statusKey,
      type: baseType,
      category: category,
      kind: normalizedKind,
      rawKind: rawKindValue,
      title: title,
      date: dateKey,
      time: timeText,
      start: startDate,
      animalId: animalId,
      raw: raw,
    };
  }

  function isConsultaEvent(eventData) {
    if (!eventData) {
      return false;
    }
    const raw = eventData.raw || {};
    const extended = raw.extendedProps || {};
    const rawTypeValue = raw.type || raw.eventType || raw.event_type || extended.eventType || extended.type || extended.event_type || '';
    const normalized = normalizeFilterValue(rawTypeValue);
    return normalized === 'consulta';
  }

  function sortEventsByStart(a, b) {
    if (a && b && a.start instanceof Date && b.start instanceof Date) {
      return a.start - b.start;
    }
    if (a && b && typeof a.time === 'string' && typeof b.time === 'string') {
      return a.time.localeCompare(b.time);
    }
    return 0;
  }

  function updateFilterButtons() {
    filterButtons.forEach(function(btn) {
      const btnFilter = canonicalizeEventTypeKey(btn.dataset.filter || '');
      const normalizedButtonFilter = btnFilter || 'all';
      const isActive = normalizedButtonFilter === currentFilter;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  }

  function updateViewModeButtons() {
    viewModeButtons.forEach(function(btn) {
      const mode = btn.dataset.viewMode === 'week' ? 'week' : 'month';
      const isActive = mode === currentViewMode;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
  }

  function normalizeFilterValue(value) {
    if (value === undefined || value === null) {
      return '';
    }
    let normalized = String(value).trim().toLowerCase();
    if (typeof normalized.normalize === 'function') {
      normalized = normalized.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }
    return normalized;
  }

  function normalizeVetFilterId(value) {
    if (typeof window !== 'undefined'
      && window.calendarVetColorManager
      && typeof window.calendarVetColorManager.normalize === 'function') {
      return window.calendarVetColorManager.normalize(value);
    }
    if (value === undefined || value === null) {
      return null;
    }
    if (typeof value === 'number' && Number.isFinite(value)) {
      return String(value);
    }
    const normalized = String(value).trim();
    return normalized || null;
  }

  function getEventVetId(eventData) {
    if (!eventData) {
      return null;
    }
    const raw = eventData.raw || {};
    const ext = raw.extendedProps || {};
    const candidate = ext.veterinarioId
      || ext.veterinario_id
      || ext.vetId
      || ext.vet_id
      || ext.veterinarianId
      || ext.veterinarian_id
      || ext.specialistId
      || ext.specialist_id
      || raw.veterinarioId
      || raw.veterinario_id
      || raw.vetId
      || raw.vet_id
      || raw.veterinarianId
      || raw.veterinarian_id
      || eventData.vetId
      || eventData.veterinarioId
      || eventData.veterinario_id
      || null;
    return normalizeVetFilterId(candidate);
  }

  function filterEventsByVet(list, vetId) {
    const collection = Array.isArray(list) ? list : [];
    const normalizedVetId = normalizeVetFilterId(vetId);
    if (!normalizedVetId) {
      return collection.slice();
    }
    return collection.filter(function(item) {
      return getEventVetId(item) === normalizedVetId;
    });
  }

  function canonicalizeEventTypeKey(value) {
    const normalized = normalizeFilterValue(value);
    switch (normalized) {
      case 'appointment':
      case 'appointments':
      case 'agenda':
      case 'agendamento':
      case 'consulta':
      case 'consultas':
      case 'consultation':
        return 'appointment';
      case 'exam':
      case 'exame':
      case 'exames':
        return 'exam';
      case 'vaccine':
      case 'vacina':
      case 'vacinas':
      case 'vacinacao':
      case 'imunizacao':
        return 'vaccine';
      case 'grooming':
      case 'banho':
      case 'tosa':
      case 'banho_tosa':
      case 'banho e tosa':
        return 'grooming';
      case 'all':
        return 'all';
      default:
        return normalized;
    }
  }

  function isGroomingKind(value) {
    const normalized = normalizeFilterValue(value);
    return normalized === 'banho_tosa' || normalized === 'banho e tosa' || normalized === 'grooming';
  }

  function isVaccineKind(value) {
    const normalized = normalizeFilterValue(value);
    return normalized === 'vacina'
      || normalized === 'vacinas'
      || normalized === 'vacinacao'
      || normalized === 'imunizacao'
      || normalized === 'vaccine';
  }

  function getEventKindKey(eventData) {
    if (!eventData) {
      return '';
    }
    if (eventData.kind) {
      return normalizeFilterValue(eventData.kind);
    }
    const raw = eventData.raw || {};
    const ext = raw.extendedProps || {};
    if (ext.kind) {
      return normalizeFilterValue(ext.kind);
    }
    if (raw.kind) {
      return normalizeFilterValue(raw.kind);
    }
    if (raw.eventKind) {
      return normalizeFilterValue(raw.eventKind);
    }
    if (raw.event_kind) {
      return normalizeFilterValue(raw.event_kind);
    }
    return '';
  }

  function getEventBaseType(eventData) {
    const typeKey = eventData && eventData.type ? normalizeFilterValue(eventData.type) : '';
    const kindKey = getEventKindKey(eventData);
    if (typeKey) {
      if (typeKey === 'appointment' && isVaccineKind(kindKey)) {
        return 'vaccine';
      }
      return typeKey;
    }
    if (eventData && eventData.category) {
      const categoryKey = normalizeFilterValue(eventData.category);
      if (categoryKey && categoryKey !== 'grooming') {
        return categoryKey;
      }
    }
    if (isVaccineKind(kindKey)) {
      return 'vaccine';
    }
    if (isGroomingKind(kindKey)) {
      return 'appointment';
    }
    return 'appointment';
  }

  function getEventCategoryKey(eventData) {
    if (!eventData) {
      return 'appointment';
    }
    if (eventData.category) {
      const normalized = normalizeFilterValue(eventData.category);
      if (normalized) {
        return normalized;
      }
    }
    const baseType = getEventBaseType(eventData);
    const kindKey = getEventKindKey(eventData);
    if (isVaccineKind(kindKey)) {
      return 'vaccine';
    }
    if (baseType === 'appointment' && isGroomingKind(kindKey)) {
      return 'grooming';
    }
    return baseType || 'appointment';
  }

  function eventMatchesFilter(eventData, filterKey) {
    if (!eventData) {
      return false;
    }
    const activeFilter = canonicalizeEventTypeKey(filterKey || currentFilter || 'all') || 'all';
    if (activeFilter === 'all') {
      return true;
    }
    const categoryKey = getEventCategoryKey(eventData);
    const baseType = getEventBaseType(eventData);
    if (activeFilter === 'grooming') {
      if (categoryKey === 'grooming') {
        return true;
      }
      return isGroomingKind(getEventKindKey(eventData));
    }
    if (activeFilter === 'appointment') {
      if (categoryKey === 'grooming') {
        return false;
      }
      return baseType === 'appointment' || categoryKey === 'appointment';
    }
    return categoryKey === activeFilter || baseType === activeFilter;
  }

  function normalizeTextForSearch(text) {
    if (text === undefined || text === null) {
      return '';
    }
    let normalized = String(text);
    if (typeof normalized.normalize === 'function') {
      normalized = normalized.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }
    return normalized.toLowerCase();
  }

  function getPetSearchIndex(pet) {
    if (!pet) {
      return '';
    }
    if (typeof pet._searchIndex === 'string') {
      return pet._searchIndex;
    }
    const parts = [];
    if (pet.name) {
      parts.push(pet.name);
    }
    if (pet.tutor_name) {
      parts.push(pet.tutor_name);
    }
    if (pet.species) {
      parts.push(pet.species);
    }
    if (pet.breed) {
      parts.push(pet.breed);
    }
    pet._searchIndex = normalizeTextForSearch(parts.join(' '));
    return pet._searchIndex;
  }

  function hasActivePetFilters() {
    if (petFilterState.search && petFilterState.search.trim() !== '') {
      return true;
    }
    if (petFilterState.species) {
      return true;
    }
    if (petFilterState.breed) {
      return true;
    }
    return false;
  }

  function applyPetFilters(list) {
    if (!Array.isArray(list) || !list.length) {
      return [];
    }
    const searchTerm = normalizeTextForSearch(petFilterState.search || '').trim();
    return list.filter(function(pet) {
      if (!pet) {
        return false;
      }
      if (petFilterState.species && pet._speciesKey !== petFilterState.species) {
        return false;
      }
      if (petFilterState.breed && pet._breedKey !== petFilterState.breed) {
        return false;
      }
      if (searchTerm) {
        const target = getPetSearchIndex(pet);
        if (!target || target.indexOf(searchTerm) === -1) {
          return false;
        }
      }
      return true;
    });
  }

  function collectPetSpeciesOptions(list) {
    const map = new Map();
    (list || []).forEach(function(pet) {
      if (!pet) {
        return;
      }
      const value = pet._speciesKey || normalizeFilterValue(pet.species);
      if (!value) {
        return;
      }
      if (!map.has(value)) {
        const label = pet.species ? String(pet.species).trim() : 'Outra';
        map.set(value, label);
      }
    });
    return Array.from(map.entries()).map(function(entry) {
      return { value: entry[0], label: entry[1] };
    });
  }

  function collectPetBreedOptions(list, speciesKey) {
    const normalizedSpecies = normalizeFilterValue(speciesKey);
    const map = new Map();
    (list || []).forEach(function(pet) {
      if (!pet) {
        return;
      }
      const petSpecies = pet._speciesKey || normalizeFilterValue(pet.species);
      if (normalizedSpecies && petSpecies !== normalizedSpecies) {
        return;
      }
      const value = pet._breedKey || normalizeFilterValue(pet.breed);
      if (!value) {
        return;
      }
      if (!map.has(value)) {
        const label = pet.breed ? String(pet.breed).trim() : 'Outra';
        map.set(value, label);
      }
    });
    return Array.from(map.entries()).map(function(entry) {
      return { value: entry[0], label: entry[1] };
    });
  }

  function fillSelectOptions(selectEl, options, placeholder) {
    if (!selectEl) {
      return;
    }
    const previousValue = selectEl.value;
    selectEl.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = placeholder || '';
    selectEl.appendChild(defaultOption);

    const sorted = options.slice().sort(function(a, b) {
      return a.label.localeCompare(b.label, 'pt-BR', { sensitivity: 'base' });
    });

    sorted.forEach(function(option) {
      const opt = document.createElement('option');
      opt.value = option.value;
      opt.textContent = option.label;
      selectEl.appendChild(opt);
    });

    if (previousValue && sorted.some(function(option) { return option.value === previousValue; })) {
      selectEl.value = previousValue;
    } else {
      selectEl.value = '';
    }
  }

  function refreshPetSpeciesOptions() {
    if (!petFilterSpeciesSelect) {
      return;
    }
    const options = collectPetSpeciesOptions(pets);
    fillSelectOptions(petFilterSpeciesSelect, options, 'Todas as espécies');
    if (petFilterState.species && !options.some(function(option) { return option.value === petFilterState.species; })) {
      petFilterState.species = '';
    }
    petFilterSpeciesSelect.disabled = options.length === 0;
    petFilterSpeciesSelect.value = petFilterState.species;
  }

  function refreshPetBreedOptions() {
    if (!petFilterBreedSelect) {
      return;
    }
    const options = collectPetBreedOptions(pets, petFilterState.species);
    fillSelectOptions(petFilterBreedSelect, options, 'Todas as raças');
    if (petFilterState.breed && !options.some(function(option) { return option.value === petFilterState.breed; })) {
      petFilterState.breed = '';
    }
    const hasOptions = options.length > 0;
    petFilterBreedSelect.disabled = !hasOptions;
    petFilterBreedSelect.value = petFilterState.breed;
  }

  function refreshPetFilterOptions() {
    refreshPetSpeciesOptions();
    refreshPetBreedOptions();
    if (petFilterSearchInput) {
      petFilterSearchInput.value = petFilterState.search || '';
    }
  }

  function resetPetPagination() {
    currentPetLimit = petsInitialLimit;
  }

  function updatePetFilterClearState() {
    if (!petFilterClearBtn) {
      return;
    }
    petFilterClearBtn.disabled = !hasActivePetFilters();
  }

  function countEventsForPet(petId) {
    if (petId === undefined || petId === null) {
      return 0;
    }
    const idStr = String(petId);
    return events.filter(function(event) {
      if (event.animalId === undefined || event.animalId === null) {
        return false;
      }
      return String(event.animalId) === idStr;
    }).length;
  }

  function formatPetDate(value) {
    if (!value) {
      return '';
    }
    const parsed = new Date(value);
    if (Number.isNaN(parsed.getTime())) {
      return '';
    }
    return parsed.toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    });
  }

  function updatePetSubtitle(total, visible, filtered) {
    if (!petSubtitleEl) {
      return;
    }
    const baseLabel = 'Dados reais da clínica';
    const totalCount = Number(total) || 0;
    const visibleCount = Number(visible) || 0;
    const filteredCount = filtered === undefined ? totalCount : (Number(filtered) || 0);

    if (!totalCount) {
      petSubtitleEl.textContent = `${baseLabel} • Nenhum pet cadastrado ainda.`;
      return;
    }

    if (!filteredCount) {
      const totalLabel = totalCount === 1 ? '1 pet no total' : `${totalCount} pets no total`;
      petSubtitleEl.textContent = `${baseLabel} • Nenhum pet encontrado com os filtros selecionados (${totalLabel}).`;
      return;
    }

    const totalLabel = totalCount === 1 ? '1 pet no total' : `${totalCount} pets no total`;
    const pluralVisible = visibleCount === 1 ? 'pet' : 'pets';
    const pluralFiltered = filteredCount === 1 ? 'pet' : 'pets';

    if (!hasActivePetFilters()) {
      if (visibleCount >= filteredCount) {
        petSubtitleEl.textContent = `${baseLabel} • Exibindo ${filteredCount} ${pluralFiltered} da clínica.`;
      } else {
        petSubtitleEl.textContent = `${baseLabel} • Últimos ${visibleCount} ${pluralVisible} cadastrados (${totalLabel}).`;
      }
      return;
    }

    if (visibleCount < filteredCount) {
      petSubtitleEl.textContent = `${baseLabel} • ${filteredCount} ${pluralFiltered} encontrados (${totalLabel}), exibindo ${visibleCount}.`;
    } else {
      petSubtitleEl.textContent = `${baseLabel} • ${filteredCount} ${pluralFiltered} encontrados (${totalLabel}).`;
    }
  }

  function updateToggleButton(filteredCount) {
    if (!togglePetsBtn) {
      return;
    }
    const totalFiltered = Number(filteredCount) || 0;
    const minimumLimit = Math.min(petsInitialLimit, totalFiltered || petsInitialLimit);
    const hasMore = totalFiltered > currentPetLimit;
    const canCollapse = totalFiltered > minimumLimit && currentPetLimit > minimumLimit;

    if (!hasMore && !canCollapse) {
      togglePetsBtn.classList.add('d-none');
      togglePetsBtn.setAttribute('aria-hidden', 'true');
      togglePetsBtn.setAttribute('aria-expanded', 'false');
      togglePetsBtn.removeAttribute('data-action');
      return;
    }

    togglePetsBtn.classList.remove('d-none');
    togglePetsBtn.setAttribute('aria-hidden', 'false');
    togglePetsBtn.disabled = false;

    if (hasMore) {
      const remaining = totalFiltered - currentPetLimit;
      const nextBatch = Math.min(remaining, petsPageSize);
      togglePetsBtn.dataset.action = 'more';
      togglePetsBtn.setAttribute('aria-expanded', 'false');
      togglePetsBtn.innerHTML = `<i class="bi bi-plus-circle me-1"></i> Ver mais ${nextBatch} ${nextBatch === 1 ? 'pet' : 'pets'}`;
      return;
    }

    togglePetsBtn.dataset.action = 'collapse';
    togglePetsBtn.setAttribute('aria-expanded', 'true');
    togglePetsBtn.innerHTML = '<i class="bi bi-chevron-up me-1"></i> Mostrar menos';
  }

  function renderPetList() {
    if (!petListEl || petListHasError || !hasLoadedPets) {
      return;
    }

    const totalPets = pets.length;

    if (!totalPets) {
      petListEl.innerHTML = '<div class="text-muted small tutor-calendar__empty">Nenhum pet cadastrado até o momento.</div>';
      petListEl.classList.remove('is-expanded');
      filteredPetsCache = [];
      updatePetSubtitle(totalPets, 0, 0);
      updateToggleButton(0);
      updatePetFilterClearState();
      return;
    }

    const filteredPets = applyPetFilters(pets);
    filteredPetsCache = filteredPets;
    const filteredCount = filteredPets.length;

    if (!filteredCount) {
      const message = hasActivePetFilters()
        ? 'Nenhum pet encontrado com os filtros selecionados.'
        : 'Nenhum pet cadastrado até o momento.';
      petListEl.innerHTML = `<div class="text-muted small tutor-calendar__empty">${message}</div>`;
      petListEl.classList.remove('is-expanded');
      updatePetSubtitle(totalPets, 0, filteredCount);
      updateToggleButton(filteredCount);
      updatePetFilterClearState();
      return;
    }

    const minimumLimit = Math.min(petsInitialLimit, filteredCount);
    if (!currentPetLimit || currentPetLimit < minimumLimit) {
      currentPetLimit = minimumLimit;
    }
    if (currentPetLimit > filteredCount) {
      currentPetLimit = filteredCount;
    }

    const visiblePets = filteredPets.slice(0, currentPetLimit);

    const fragment = document.createDocumentFragment();
    visiblePets.forEach(function(pet) {
      const petId = pet && pet.id !== undefined && pet.id !== null ? pet.id : null;
      const profileUrl = petId ? fillUrlWithId(urlTemplates.animalProfile, petId) : null;
      const elementTag = profileUrl ? 'a' : 'div';
      const item = document.createElement(elementTag);
      item.className = 'tutor-calendar__pet';
      if (petId !== null) {
        item.dataset.petId = String(petId);
      }
      if (profileUrl) {
        item.href = profileUrl;
        item.classList.add('tutor-calendar__pet--link');
        item.dataset.profileUrl = profileUrl;
        const labelName = pet && pet.name ? `Abrir ficha do pet ${pet.name}` : 'Abrir ficha do pet';
        item.setAttribute('aria-label', labelName);
        item.title = pet && pet.name ? `Abrir ficha de ${pet.name}` : 'Abrir ficha do pet';
      }

      const avatar = document.createElement('div');
      avatar.className = 'tutor-calendar__pet-avatar';
      const imageUrl = pet.image;
      if (imageUrl) {
        const img = document.createElement('img');
        img.src = imageUrl;
        img.loading = 'lazy';
        img.alt = pet.name ? `Foto de ${pet.name}` : 'Foto do pet';
        avatar.classList.add('has-image');
        avatar.appendChild(img);
      } else {
        const nameValue = (pet.name || 'Pet').trim();
        const initial = nameValue ? nameValue.charAt(0).toUpperCase() : 'P';
        avatar.textContent = initial;
      }

      const content = document.createElement('div');
      content.className = 'tutor-calendar__pet-content';

      const heading = document.createElement('div');
      heading.className = 'tutor-calendar__pet-heading';

      const nameEl = document.createElement('div');
      nameEl.className = 'tutor-calendar__pet-name fw-semibold text-truncate';
      nameEl.textContent = pet.name || 'Pet sem nome';
      heading.appendChild(nameEl);

      const totalEvents = countEventsForPet(pet.id);
      if (totalEvents > 0) {
        const badge = document.createElement('span');
        badge.className = 'badge rounded-pill bg-primary-subtle text-primary-emphasis';
        badge.textContent = totalEvents === 1 ? '1 evento' : `${totalEvents} eventos`;
        heading.appendChild(badge);
      }

      const detailEl = document.createElement('div');
      detailEl.className = 'tutor-calendar__pet-detail text-muted small';
      const species = pet.species || '';
      const breed = pet.breed || '';
      const details = [species, breed].filter(Boolean).join(' • ');
      detailEl.textContent = details || 'Sem detalhes adicionais';

      content.appendChild(heading);
      content.appendChild(detailEl);

      const metaParts = [];
      if (pet.tutor_name) {
        metaParts.push({ icon: 'bi-person-heart', text: `Tutor: ${pet.tutor_name}` });
      }
      if (pet.age_display) {
        metaParts.push({ icon: 'bi-hourglass', text: pet.age_display });
      }
      const formattedDate = formatPetDate(pet.dateAdded || pet.date_added);
      if (formattedDate) {
        metaParts.push({ icon: 'bi-calendar-plus', text: `Adicionado em ${formattedDate}` });
      }

      if (metaParts.length) {
        const metaEl = document.createElement('div');
        metaEl.className = 'tutor-calendar__pet-meta text-muted small';
        metaParts.forEach(function(part) {
          const span = document.createElement('span');
          span.className = 'tutor-calendar__pet-meta-item';
          if (part.icon) {
            const iconEl = document.createElement('i');
            iconEl.className = `bi ${part.icon}`;
            iconEl.setAttribute('aria-hidden', 'true');
            span.appendChild(iconEl);
          }
          span.appendChild(document.createTextNode(part.text));
          metaEl.appendChild(span);
        });
        content.appendChild(metaEl);
      }

      item.appendChild(avatar);
      item.appendChild(content);

      fragment.appendChild(item);
    });

    petListEl.innerHTML = '';
    petListEl.appendChild(fragment);
    const shouldExpand = currentPetLimit >= filteredCount && filteredCount > petsInitialLimit;
    petListEl.classList.toggle('is-expanded', shouldExpand);
    updatePetSubtitle(totalPets, visiblePets.length, filteredCount);
    updateToggleButton(filteredCount);
    updatePetFilterClearState();
  }

  function renderWeekdays() {
    if (!weekdaysEl) {
      return;
    }
    weekdaysEl.innerHTML = '';
    weekdays.forEach(function(label) {
      const div = document.createElement('div');
      div.textContent = label;
      weekdaysEl.appendChild(div);
    });
  }

  function buildEventElement(eventData) {
    const typeKey = getEventCategoryKey(eventData);
    const baseType = getEventBaseType(eventData) || 'appointment';
    const el = document.createElement('div');
    const eventClasses = ['tutor-calendar__event', 'tutor-calendar__event--' + typeKey];
    if (baseType && baseType !== typeKey) {
      eventClasses.push('tutor-calendar__event--' + baseType);
    }
    el.className = eventClasses.join(' ');
    const raw = eventData && eventData.raw ? eventData.raw : {};
    const ext = raw.extendedProps || {};
    const eventKey = getEventKey(eventData);
    if (eventKey) {
      el.dataset.eventId = String(eventKey);
      if (focusedEventId && String(focusedEventId) === String(eventKey)) {
        el.classList.add('is-active');
      }
    }
    const recordId = eventData && eventData.recordId !== undefined && eventData.recordId !== null
      ? eventData.recordId
      : (ext.recordId !== undefined && ext.recordId !== null ? ext.recordId : null);
    if (recordId !== undefined && recordId !== null) {
      el.dataset.recordId = String(recordId);
    }

    el.dataset.type = typeKey;
    el.dataset.baseType = baseType;

    const statusKey = resolveStatusKey(eventData.status || ext.status, baseType);
    const statusLabel = statusLabels[statusKey] || humanizeLabel(statusKey);
    const statusClassName = isKnownStatus(statusKey) ? statusKey : (baseType === 'appointment' ? 'scheduled' : '');
    if (statusClassName) {
      el.classList.add(`status-${statusClassName}`);
    }
    el.dataset.status = statusKey || '';

    const headerEl = document.createElement('div');
    headerEl.className = 'tutor-calendar__event-header';

    const timeEl = document.createElement('div');
    timeEl.className = 'tutor-calendar__event-time';
    timeEl.textContent = eventData.time || '--:--';
    headerEl.appendChild(timeEl);

    if (statusLabel) {
      const statusEl = document.createElement('span');
      const badgeClasses = ['tutor-calendar__event-status'];
      if (statusClassName) {
        badgeClasses.push(`status-${statusClassName}`);
      }
      statusEl.className = badgeClasses.join(' ');
      statusEl.textContent = statusLabel;
      headerEl.appendChild(statusEl);
    }

    el.appendChild(headerEl);

    const titleEl = document.createElement('div');
    titleEl.className = 'tutor-calendar__event-title';
    titleEl.textContent = eventData.title;
    el.appendChild(titleEl);

    const petName = getPetName(eventData.animalId) || derivePetNameFromTitle(eventData.title);
    if (petName) {
      const petEl = document.createElement('div');
      petEl.className = 'tutor-calendar__event-pet';
      petEl.textContent = petName;
      el.appendChild(petEl);
    }

    el.addEventListener('click', function(evt) {
      evt.stopPropagation();
      const dateKey = eventData.date || (eventData.start ? formatDateKey(eventData.start) : null);
      if (dateKey) {
        selectedDate = dateKey;
      }
      lastDetailTrigger = el;
      showEventDetails(eventData, { trigger: el });
    });

    return el;
  }

  function appendDetailRow(list, label, value) {
    if (!list || !label) {
      return;
    }
    const normalized = value === null || value === undefined || value === '' ? '—' : String(value);
    const item = document.createElement('div');
    item.className = 'tutor-calendar__day-detail-info-item';
    if (list.classList && list.classList.contains('tutor-calendar__appointment-meta')) {
      item.classList.add('tutor-calendar__day-detail-info-item--compact');
    }
    const dt = document.createElement('dt');
    dt.textContent = String(label);
    const dd = document.createElement('dd');
    dd.textContent = normalized;
    item.appendChild(dt);
    item.appendChild(dd);
    list.appendChild(item);
  }

  function buildDayDetailCard(eventData) {
    const card = document.createElement('article');
    const typeKey = getEventCategoryKey(eventData);
    const baseType = getEventBaseType(eventData) || 'appointment';
    const raw = eventData && eventData.raw ? eventData.raw : {};
    const ext = raw.extendedProps || {};
    const typeLabel = typeLabels[typeKey] || typeLabels[baseType] || 'Evento';
    const kindKey = getEventKindKey(eventData);
    let kindLabel = humanizeLabel(ext.kind || eventData.rawKind || eventData.kind) || typeLabel;
    if (isGroomingKind(kindKey)) {
      kindLabel = 'Banho e Tosa';
    }
    const tutorName = ext.tutorName || null;
    const vetName = ext.vetName || ext.veterinarioName || null;
    const statusKey = resolveStatusKey(ext.status || eventData.status, baseType);
    const statusLabel = statusLabels[statusKey] || humanizeLabel(statusKey);
    const statusClassName = isKnownStatus(statusKey) ? statusKey : (baseType === 'appointment' ? 'scheduled' : '');
    const recordId = ext.recordId !== undefined && ext.recordId !== null ? ext.recordId : null;
    const startDate = eventData.start instanceof Date ? eventData.start : parseDate(raw.start || raw.startStr || ext.start);
    const endDate = parseDate(raw.end || raw.endStr || ext.end);
    const startTime = eventData.time || (startDate ? formatTime(startDate) : '--:--');
    const endTime = endDate ? formatTime(endDate) : '';
    const timeRange = endTime ? `${startTime} - ${endTime}` : (startTime || '--:--');
    const displayDate = formatDisplayDate(startDate || eventData.date || raw.date);
    const durationText = formatDuration(startDate, endDate);
    const appointmentCode = recordId !== null ? `#${recordId}` : null;

    card.className = 'tutor-calendar__day-detail-card tutor-calendar__day-detail-card--' + typeKey;
    card.dataset.type = typeKey;
    card.dataset.baseType = baseType;

    const eventKey = getEventKey(eventData);
    if (eventKey) {
      card.dataset.eventId = String(eventKey);
      if (focusedEventId && String(focusedEventId) === String(eventKey)) {
        card.classList.add('is-active');
      }
    }

    if (recordId !== null) {
      card.dataset.recordId = String(recordId);
    }

    card.setAttribute('role', 'button');
    card.setAttribute('tabindex', '0');

    const meta = document.createElement('div');
    meta.className = 'tutor-calendar__day-detail-meta';

    const timeEl = document.createElement('div');
    timeEl.className = 'tutor-calendar__day-detail-time';
    timeEl.textContent = timeRange || '--:--';

    const typeEl = document.createElement('div');
    typeEl.className = 'tutor-calendar__day-detail-type';
    typeEl.textContent = typeLabel;

    meta.appendChild(timeEl);
    meta.appendChild(typeEl);

    if (statusLabel) {
      const statusEl = document.createElement('span');
      const statusClasses = ['tutor-calendar__day-detail-status'];
      if (statusClassName) {
        statusClasses.push(`status-${statusClassName}`);
      }
      statusEl.className = statusClasses.join(' ');
      statusEl.textContent = statusLabel;
      meta.appendChild(statusEl);
    }

    card.appendChild(meta);

    const titleEl = document.createElement('h4');
    titleEl.className = 'tutor-calendar__day-detail-title';
    titleEl.textContent = eventData.title || typeLabel;
    card.appendChild(titleEl);

    const petName = getPetName(eventData.animalId) || derivePetNameFromTitle(eventData.title);
    const petEl = document.createElement('div');
    petEl.className = 'tutor-calendar__day-detail-pet';
    petEl.textContent = petName ? `Paciente: ${petName}` : 'Paciente não informado';
    card.appendChild(petEl);

    const infoList = document.createElement('dl');
    infoList.className = 'tutor-calendar__day-detail-info';

    if (displayDate) {
      appendDetailRow(infoList, 'Data', displayDate);
    }
    appendDetailRow(infoList, 'Tipo de atendimento', kindLabel);
    if (statusLabel) {
      appendDetailRow(infoList, 'Situação', statusLabel);
    }
    appendDetailRow(infoList, 'Tutor responsável', tutorName);
    appendDetailRow(infoList, 'Veterinário responsável', vetName);
    if (durationText) {
      appendDetailRow(infoList, 'Duração prevista', durationText);
    }
    if (appointmentCode) {
      appendDetailRow(infoList, 'Código do agendamento', appointmentCode);
    }

    card.appendChild(infoList);

    function openDetailView() {
      const dateKey = eventData.date || (eventData.start ? formatDateKey(eventData.start) : null);
      if (dateKey) {
        selectedDate = dateKey;
      }
      lastDetailTrigger = card;
      showEventDetails(eventData, { trigger: card });
    }

    card.addEventListener('click', function(evt) {
      if (evt) {
        const interactiveSelector = 'a, button, input, textarea, select, [data-ignore-card-click], [role="button"]:not(.tutor-calendar__day-detail-card)';
        if (evt.target && evt.target.closest(interactiveSelector)) {
          return;
        }
        evt.preventDefault();
        evt.stopPropagation();
      }
      openDetailView();
    });

    card.addEventListener('keydown', function(evt) {
      if (!evt || evt.target !== card) {
        return;
      }
      const isEnter = evt.key === 'Enter';
      const isSpace = evt.key === ' ' || evt.key === 'Spacebar';
      if (!isEnter && !isSpace) {
        return;
      }
      evt.preventDefault();
      evt.stopPropagation();
      openDetailView();
    });

    return card;
  }

  function buildAppointmentDetailBlock(eventData, displayLabel, dateKey) {
    if (!eventData) {
      return null;
    }
    const raw = eventData.raw || {};
    const ext = raw.extendedProps || {};
    const recordId = ext.recordId !== undefined && ext.recordId !== null ? ext.recordId : null;
    if (recordId === null) {
      return null;
    }

    const fragment = document.createDocumentFragment();
    const typeKey = getEventCategoryKey(eventData);
    const baseType = getEventBaseType(eventData) || 'appointment';
    const statusKey = resolveStatusKey(ext.status || eventData.status, baseType);
    const statusClass = isKnownStatus(statusKey) ? statusKey : 'scheduled';
    const statusLabel = statusLabels[statusKey] || humanizeLabel(statusKey) || '—';
    const typeLabel = typeLabels[typeKey] || typeLabels[baseType] || 'Evento';
    const kindKey = getEventKindKey(eventData);
    let kindLabel = ext.kind || eventData.rawKind || eventData.kind || '';
    if (isGroomingKind(kindKey)) {
      kindLabel = 'Banho e Tosa';
    } else if (kindLabel) {
      kindLabel = humanizeLabel(kindLabel);
    }
    const consultaId = ext.consultaId !== undefined && ext.consultaId !== null ? ext.consultaId : null;
    const consultaStatusKey = ext.consultaStatus || null;
    const consultaStatusLabel = consultaStatusKey
      ? (consultaStatusLabels[consultaStatusKey] || humanizeLabel(consultaStatusKey))
      : null;
    const retornoDeId = ext.consultaRetornoDeId !== undefined && ext.consultaRetornoDeId !== null
      ? ext.consultaRetornoDeId
      : null;
    const statusDetail = deriveAppointmentStatusDetail(statusKey, consultaStatusKey);
    const tutorName = ext.tutorName || null;
    const animalName = ext.animalName || getPetName(eventData.animalId) || derivePetNameFromTitle(eventData.title) || 'Paciente';
    const vetName = ext.vetName || ext.veterinarioName || deriveVetNameFromTitle(eventData.title) || '—';

    const card = document.createElement('article');
    card.className = 'tutor-calendar__appointment-card';
    card.classList.add('tutor-calendar__appointment-card--' + typeKey);
    if (baseType && baseType !== typeKey) {
      card.classList.add('tutor-calendar__appointment-card--' + baseType);
    }
    card.dataset.appointmentId = String(recordId);
    card.dataset.type = typeKey;
    card.dataset.baseType = baseType;
    if (dateKey) {
      card.dataset.day = dateKey;
      card.dataset.dayLabel = displayLabel || dateKey;
    }
    const scheduledIso = raw.startStr || raw.start || (eventData.start instanceof Date ? eventData.start.toISOString() : '');
    if (scheduledIso) {
      card.dataset.scheduled = scheduledIso;
    }
    card.dataset.recordId = String(recordId);
    const editUrl = fillUrlWithId(urlTemplates.editAppointment, recordId);
    if (editUrl) {
      card.dataset.href = editUrl;
      card.dataset.boundClick = 'true';
    }

    const topRow = document.createElement('div');
    topRow.className = 'tutor-calendar__appointment-top';

    const timeBlock = document.createElement('div');
    timeBlock.className = 'tutor-calendar__appointment-time';
    const timeIconWrapper = document.createElement('span');
    timeIconWrapper.className = 'tutor-calendar__appointment-icon is-time';
    const timeIcon = document.createElement('i');
    timeIcon.className = 'fa-regular fa-clock';
    timeIcon.setAttribute('aria-hidden', 'true');
    timeIconWrapper.appendChild(timeIcon);
    timeBlock.appendChild(timeIconWrapper);
    const timeTextWrapper = document.createElement('div');
    timeTextWrapper.className = 'tutor-calendar__appointment-time-text';
    const timeLabelEl = document.createElement('span');
    timeLabelEl.className = 'tutor-calendar__appointment-subtitle';
    timeLabelEl.textContent = 'Horário';
    const timeValueEl = document.createElement('span');
    timeValueEl.className = 'tutor-calendar__appointment-time-value';
    timeValueEl.textContent = eventData.time || '--:--';
    timeTextWrapper.appendChild(timeLabelEl);
    timeTextWrapper.appendChild(timeValueEl);
    timeBlock.appendChild(timeTextWrapper);
    topRow.appendChild(timeBlock);

    const typeBadge = document.createElement('span');
    typeBadge.className = 'tutor-calendar__appointment-pill';
    typeBadge.textContent = kindLabel ? kindLabel : typeLabel;
    topRow.appendChild(typeBadge);

    if (statusLabel) {
      const statusBadge = document.createElement('span');
      statusBadge.className = `status-badge status-${statusClass} tutor-calendar__appointment-status`;
      statusBadge.textContent = statusLabel;
      topRow.appendChild(statusBadge);
    }

    card.appendChild(topRow);

    const peopleGrid = document.createElement('div');
    peopleGrid.className = 'tutor-calendar__appointment-people';

    function appendPerson(label, value, iconClass, modifier) {
      const person = document.createElement('div');
      person.className = 'tutor-calendar__appointment-person';

      const iconWrapper = document.createElement('span');
      iconWrapper.className = 'tutor-calendar__appointment-icon' + (modifier ? ` ${modifier}` : '');
      const icon = document.createElement('i');
      icon.className = iconClass;
      icon.setAttribute('aria-hidden', 'true');
      iconWrapper.appendChild(icon);
      person.appendChild(iconWrapper);

      const textWrapper = document.createElement('div');
      textWrapper.className = 'tutor-calendar__appointment-person-text';

      const labelEl = document.createElement('span');
      labelEl.className = 'tutor-calendar__appointment-person-label';
      labelEl.textContent = label;

      const valueEl = document.createElement('span');
      valueEl.className = 'tutor-calendar__appointment-person-value';
      valueEl.textContent = value || '—';

      textWrapper.appendChild(labelEl);
      textWrapper.appendChild(valueEl);
      person.appendChild(textWrapper);

      peopleGrid.appendChild(person);
    }

    appendPerson('Paciente', animalName, 'fa-solid fa-paw', 'is-pet');
    if (tutorName) {
      appendPerson('Tutor', tutorName, 'fa-solid fa-user', 'is-tutor');
    }
    appendPerson('Veterinário', vetName, 'fa-solid fa-user-doctor', 'is-vet');

    if (peopleGrid.childNodes.length) {
      card.appendChild(peopleGrid);
    }

    if (statusDetail && statusDetail.label) {
      const statusWrapper = document.createElement('div');
      statusWrapper.className = 'tutor-calendar__appointment-status-detail';
      const badge = document.createElement('span');
      const badgeClasses = ['badge'];
      if (statusDetail.badgeClass) {
        statusDetail.badgeClass.split(' ').forEach(function(token) {
          if (token) {
            badgeClasses.push(token);
          }
        });
      } else {
        badgeClasses.push('bg-secondary');
      }
      badge.className = badgeClasses.join(' ');
      badge.textContent = statusDetail.label;
      statusWrapper.appendChild(badge);
      card.appendChild(statusWrapper);
    }

    if (retornoDeId !== null) {
      const returnInfo = document.createElement('div');
      returnInfo.className = 'tutor-calendar__appointment-return-info';
      returnInfo.textContent = `Retorno da consulta #${retornoDeId}`;
      card.appendChild(returnInfo);
    }

    const infoList = document.createElement('dl');
    infoList.className = 'tutor-calendar__day-detail-info tutor-calendar__appointment-meta';

    appendDetailRow(infoList, 'Horário', eventData.time || '--:--');
    appendDetailRow(infoList, 'Paciente', animalName);
    if (tutorName) {
      appendDetailRow(infoList, 'Tutor', tutorName);
    }
    appendDetailRow(infoList, 'Veterinário', vetName);
    appendDetailRow(infoList, 'Tipo', kindLabel ? kindLabel : typeLabel);
    appendDetailRow(infoList, 'Status', statusLabel);
    appendDetailRow(infoList, 'Data', eventData.date || dateKey || '—');
    appendDetailRow(infoList, 'ID', recordId);
    if (ext.clinicId !== undefined && ext.clinicId !== null) {
      appendDetailRow(infoList, 'Clínica', ext.clinicId);
    }
    if (consultaStatusLabel) {
      appendDetailRow(infoList, 'Status da consulta', consultaStatusLabel);
    }
    if (consultaId !== null) {
      appendDetailRow(infoList, 'Consulta vinculada', `#${consultaId}`);
    }
    if (retornoDeId !== null) {
      appendDetailRow(infoList, 'Retorno da consulta', `#${retornoDeId}`);
    }

    card.appendChild(infoList);

    if (ext.notes) {
      const notes = document.createElement('div');
      notes.className = 'tutor-calendar__appointment-notes';

      const notesIconWrapper = document.createElement('span');
      notesIconWrapper.className = 'tutor-calendar__appointment-icon is-note';
      const notesIcon = document.createElement('i');
      notesIcon.className = 'fa-solid fa-note-sticky';
      notesIcon.setAttribute('aria-hidden', 'true');
      notesIconWrapper.appendChild(notesIcon);
      notes.appendChild(notesIconWrapper);

      const notesBody = document.createElement('div');
      notesBody.className = 'tutor-calendar__appointment-notes-body';
      const notesTitle = document.createElement('div');
      notesTitle.className = 'tutor-calendar__appointment-notes-title';
      notesTitle.textContent = 'Observações';
      const notesText = document.createElement('p');
      notesText.className = 'tutor-calendar__appointment-notes-text';
      notesText.textContent = ext.notes;
      notesBody.appendChild(notesTitle);
      notesBody.appendChild(notesText);
      notes.appendChild(notesBody);

      card.appendChild(notes);
    }

    const actionsWrapper = document.createElement('div');
    actionsWrapper.className = 'tutor-calendar__appointment-actions';
    const actionsTitle = document.createElement('div');
    actionsTitle.className = 'tutor-calendar__appointment-actions-title';
    actionsTitle.textContent = 'Ações rápidas';
    const actionsGrid = document.createElement('div');
    actionsGrid.className = 'tutor-calendar__appointment-actions-grid';

    function appendActionElement(element) {
      if (!element) {
        return;
      }
      element.classList.add('tutor-calendar__appointment-action');
      actionsGrid.appendChild(element);
    }

    if (ext.animalId) {
      const animalUrl = fillUrlWithId(urlTemplates.animalProfile, ext.animalId);
      if (animalUrl) {
        const btn = document.createElement('a');
        btn.className = 'btn btn-sm btn-outline-primary';
        btn.href = animalUrl;
        btn.title = 'Ficha do Animal';
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-file-medical me-1';
        icon.setAttribute('aria-hidden', 'true');
        btn.appendChild(icon);
        btn.appendChild(document.createTextNode('Ficha do Animal'));
        appendActionElement(btn);
      }
    }

    if (ext.tutorId) {
      const tutorUrl = fillUrlWithId(urlTemplates.tutorProfile, ext.tutorId);
      if (tutorUrl) {
        const btn = document.createElement('a');
        btn.className = 'btn btn-sm btn-outline-secondary';
        btn.href = tutorUrl;
        btn.title = 'Ficha do Tutor';
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-user me-1';
        icon.setAttribute('aria-hidden', 'true');
        btn.appendChild(icon);
        btn.appendChild(document.createTextNode('Ficha do Tutor'));
        appendActionElement(btn);
      }
    }

    if (permissions.canStartConsulta && ext.animalId) {
      const consultaUrl = buildConsultaUrl(ext.animalId, recordId);
      if (consultaUrl) {
        const btn = document.createElement('a');
        btn.className = 'btn btn-sm btn-outline-success';
        btn.href = consultaUrl;
        btn.title = 'Iniciar Consulta';
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-stethoscope me-1';
        icon.setAttribute('aria-hidden', 'true');
        btn.appendChild(icon);
        btn.appendChild(document.createTextNode('Iniciar Consulta'));
        appendActionElement(btn);
      }
    }

    if (consultaId !== null && ext.animalId) {
      const detailUrl = buildConsultaDetailUrl(ext.animalId, consultaId);
      if (detailUrl) {
        const btn = document.createElement('a');
        btn.className = 'btn btn-sm btn-outline-success';
        btn.href = detailUrl;
        btn.title = 'Detalhes da consulta';
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-notes-medical me-1';
        icon.setAttribute('aria-hidden', 'true');
        btn.appendChild(icon);
        btn.appendChild(document.createTextNode('Detalhes da consulta'));
        appendActionElement(btn);
      }
    }

    if (consultaId !== null) {
      const printUrl = buildConsultaPrintUrl(consultaId);
      if (printUrl) {
        const btn = document.createElement('a');
        btn.className = 'btn btn-sm btn-outline-dark';
        btn.href = printUrl;
        btn.target = '_blank';
        btn.rel = 'noopener';
        btn.title = 'Imprimir consulta';
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-print me-1';
        icon.setAttribute('aria-hidden', 'true');
        btn.appendChild(icon);
        btn.appendChild(document.createTextNode('Imprimir consulta'));
        appendActionElement(btn);
      }
    }

    if (editUrl) {
      const btn = document.createElement('a');
      btn.className = 'btn btn-sm btn-outline-info';
      btn.href = editUrl;
      btn.title = 'Propor novo horário';
      const icon = document.createElement('i');
      icon.className = 'fa-solid fa-arrows-rotate me-1';
      icon.setAttribute('aria-hidden', 'true');
      btn.appendChild(icon);
      btn.appendChild(document.createTextNode('Propor novo horário'));
      appendActionElement(btn);
    }

    if (permissions.canManageStatus) {
      const statusUrl = fillUrlWithId(urlTemplates.status, recordId);
      if (statusUrl) {
        statusActionConfig.forEach(function(action) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = statusUrl;
          form.className = 'form-confirm';
          if (recordId !== undefined && recordId !== null) {
            form.dataset.recordId = String(recordId);
          }

          if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
          }

          const statusInput = document.createElement('input');
          statusInput.type = 'hidden';
          statusInput.name = 'status';
          statusInput.value = action.status;
          form.appendChild(statusInput);

          const button = document.createElement('button');
          button.type = 'submit';
          button.className = action.buttonClass;
          button.title = action.label;
          const icon = document.createElement('i');
          icon.className = action.icon;
          icon.setAttribute('aria-hidden', 'true');
          button.appendChild(icon);
          button.appendChild(document.createTextNode(action.label));
          form.appendChild(button);

          attachConfirmHandler(form);
          attachStatusFormHandler(form, { recordId: recordId, status: action.status });
          appendActionElement(form);
        });
      }
    }

    if (permissions.canManageStatus) {
      const deleteUrl = fillUrlWithId(urlTemplates.deleteAppointment, recordId);
      if (deleteUrl) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = deleteUrl;
        form.className = 'form-confirm';
        form.setAttribute('data-confirm', 'Excluir este agendamento?');

        if (csrfToken) {
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrf_token';
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);
        }

        const button = document.createElement('button');
        button.type = 'submit';
        button.className = 'btn btn-sm btn-outline-danger';
        button.title = 'Excluir';
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-trash me-1';
        icon.setAttribute('aria-hidden', 'true');
        button.appendChild(icon);
        button.appendChild(document.createTextNode('Excluir'));
        form.appendChild(button);

        attachConfirmHandler(form);
        appendActionElement(form);
      }
    }

    if (actionsGrid.childNodes.length) {
      actionsWrapper.appendChild(actionsTitle);
      actionsWrapper.appendChild(actionsGrid);
      card.appendChild(actionsWrapper);
    }

    fragment.appendChild(card);

    return fragment;
  }

  function buildConsultaRecordBlock(eventData, displayLabel, dateKey) {
    const card = buildDayDetailCard(eventData);
    if (!card) {
      return null;
    }

    const raw = eventData.raw || {};
    const ext = raw.extendedProps || {};
    const consultaId = ext.consultaId !== undefined && ext.consultaId !== null ? ext.consultaId : null;
    const consultaStatusKey = ext.consultaStatus || null;
    const animalId = ext.animalId || eventData.animalId || null;
    const tutorId = ext.tutorId || null;

    const infoList = card.querySelector('.tutor-calendar__day-detail-info');
    if (infoList) {
      if (consultaStatusKey) {
        const consultaStatusLabel = consultaStatusLabels[consultaStatusKey] || humanizeLabel(consultaStatusKey);
        appendDetailRow(infoList, 'Status da consulta', consultaStatusLabel);
      }
      if (consultaId !== null) {
        appendDetailRow(infoList, 'Código da consulta', `#${consultaId}`);
      }
    }

    const actionsWrapper = document.createElement('div');
    actionsWrapper.className = 'tutor-calendar__appointment-actions';
    const actionsTitle = document.createElement('div');
    actionsTitle.className = 'tutor-calendar__appointment-actions-title';
    actionsTitle.textContent = 'Ações rápidas';
    const actionsGrid = document.createElement('div');
    actionsGrid.className = 'tutor-calendar__appointment-actions-grid';

    function appendActionElement(element) {
      if (!element) {
        return;
      }
      element.classList.add('tutor-calendar__appointment-action');
      actionsGrid.appendChild(element);
    }

    if (animalId) {
      const animalUrl = fillUrlWithId(urlTemplates.animalProfile, animalId);
      if (animalUrl) {
        const btn = document.createElement('a');
        btn.className = 'btn btn-sm btn-outline-primary';
        btn.href = animalUrl;
        btn.title = 'Ficha do Animal';
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-file-medical me-1';
        icon.setAttribute('aria-hidden', 'true');
        btn.appendChild(icon);
        btn.appendChild(document.createTextNode('Ficha do Animal'));
        appendActionElement(btn);
      }
    }

    if (tutorId) {
      const tutorUrl = fillUrlWithId(urlTemplates.tutorProfile, tutorId);
      if (tutorUrl) {
        const btn = document.createElement('a');
        btn.className = 'btn btn-sm btn-outline-secondary';
        btn.href = tutorUrl;
        btn.title = 'Ficha do Tutor';
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-user me-1';
        icon.setAttribute('aria-hidden', 'true');
        btn.appendChild(icon);
        btn.appendChild(document.createTextNode('Ficha do Tutor'));
        appendActionElement(btn);
      }
    }

    if (consultaId !== null && animalId) {
      const detailUrl = buildConsultaDetailUrl(animalId, consultaId);
      if (detailUrl) {
        const btn = document.createElement('a');
        btn.className = 'btn btn-sm btn-outline-success';
        btn.href = detailUrl;
        btn.title = 'Detalhes da consulta';
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-notes-medical me-1';
        icon.setAttribute('aria-hidden', 'true');
        btn.appendChild(icon);
        btn.appendChild(document.createTextNode('Detalhes da consulta'));
        appendActionElement(btn);
      }
    }

    if (consultaId !== null) {
      const printUrl = buildConsultaPrintUrl(consultaId);
      if (printUrl) {
        const btn = document.createElement('a');
        btn.className = 'btn btn-sm btn-outline-dark';
        btn.href = printUrl;
        btn.target = '_blank';
        btn.rel = 'noopener';
        btn.title = 'Imprimir consulta';
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-print me-1';
        icon.setAttribute('aria-hidden', 'true');
        btn.appendChild(icon);
        btn.appendChild(document.createTextNode('Imprimir consulta'));
        appendActionElement(btn);
      }
    }

    if (actionsGrid.childNodes.length) {
      actionsWrapper.appendChild(actionsTitle);
      actionsWrapper.appendChild(actionsGrid);
      card.appendChild(actionsWrapper);
    }

    const fragment = document.createDocumentFragment();
    fragment.appendChild(card);
    return fragment;
  }

  function buildEventDetailContent(eventData, displayLabel, dateKey) {
    if (!eventData) {
      return null;
    }
    if (isConsultaEvent(eventData)) {
      const consultaContent = buildConsultaRecordBlock(eventData, displayLabel, dateKey);
      if (consultaContent) {
        return consultaContent;
      }
    }
    const baseType = getEventBaseType(eventData);
    if (baseType && ['appointment', 'exam', 'vaccine'].includes(baseType)) {
      const appointmentContent = buildAppointmentDetailBlock(eventData, displayLabel, dateKey);
      if (appointmentContent) {
        return appointmentContent;
      }
    }
    const fallback = document.createDocumentFragment();
    fallback.appendChild(buildDayDetailCard(eventData));
    return fallback;
  }

  function updateSelectedDateHighlight() {
    const datedElements = root.querySelectorAll('[data-date]');
    const activeDate = selectedDate;
    datedElements.forEach(function(node) {
      if (!node || !node.classList) {
        return;
      }
      const isActive = Boolean(activeDate && node.dataset && node.dataset.date === activeDate);
      node.classList.toggle('is-selected', isActive);
    });
  }

  function formatDateLabel(dateKey) {
    if (!dateKey) {
      return '';
    }
    const parsedDate = parseDateKey(dateKey);
    if (!parsedDate) {
      return dateKey;
    }
    return parsedDate.toLocaleDateString('pt-BR', {
      weekday: 'long',
      day: 'numeric',
      month: 'long',
    });
  }

  function renderDayDetail(dateKey, options) {
    if (!dayDetailContainer || !dayDetailContent) {
      return;
    }

    dayDetailContainer.setAttribute('aria-busy', 'true');

    dayDetailMode = 'day';
    focusedEventId = null;

    const opts = options && typeof options === 'object' ? options : {};
    const shouldOpen = Boolean(opts.open);
    const shouldFocus = opts.focus !== false;

    const explicitDate = typeof dateKey === 'string' && dateKey ? dateKey : null;
    let targetDateKey = explicitDate || selectedDate || null;
    if (!targetDateKey) {
      targetDateKey = formatDateKey(new Date());
    }
    selectedDate = targetDateKey;

    const displayLabel = formatDateLabel(targetDateKey);
    updateDayDetailHeading(displayLabel || targetDateKey || defaultDayDetailHeadingText);

    const dayEvents = events.filter(function(event) {
      if (event.date !== targetDateKey) {
        return false;
      }
      return eventMatchesFilter(event, currentFilter);
    }).sort(sortEventsByStart);

    dayDetailContainer.dataset.date = targetDateKey;
    dayDetailContent.innerHTML = '';

    const header = document.createElement('div');
    header.className = 'tutor-calendar__day-detail-header';

    const dateEl = document.createElement('div');
    dateEl.className = 'tutor-calendar__day-detail-date';
    dateEl.textContent = displayLabel;
    header.appendChild(dateEl);

    const countEl = document.createElement('span');
    countEl.className = 'tutor-calendar__day-detail-count';
    const countLabel = dayEvents.length === 1 ? '1 compromisso' : `${dayEvents.length} compromissos`;
    countEl.textContent = countLabel;
    header.appendChild(countEl);

    dayDetailContent.appendChild(header);

    if (!dayEvents.length) {
      const emptyState = document.createElement('div');
      emptyState.className = 'tutor-calendar__day-detail-empty';

      const emptyMessage = document.createElement('p');
      emptyMessage.className = 'mb-3';
      emptyMessage.textContent = currentFilter === 'all'
        ? 'Nenhum compromisso cadastrado para este dia.'
        : 'Nenhum compromisso para este filtro neste dia.';
      emptyState.appendChild(emptyMessage);

      const scheduleHint = document.createElement('p');
      scheduleHint.className = 'small text-muted mb-3';
      scheduleHint.textContent = 'Você pode agendar um novo compromisso clicando no botão abaixo.';
      emptyState.appendChild(scheduleHint);

      const scheduleBtn = buildScheduleButton(targetDateKey);
      if (scheduleBtn) {
        emptyState.appendChild(scheduleBtn);
      }

      dayDetailContent.appendChild(emptyState);
    } else {
      const actionsBar = buildDayScheduleActions(targetDateKey);
      if (actionsBar) {
        dayDetailContent.appendChild(actionsBar);
      }
      const fragment = document.createDocumentFragment();
      dayEvents.forEach(function(eventItem) {
        fragment.appendChild(buildDayDetailCard(eventItem));
      });
      dayDetailContent.appendChild(fragment);
    }

    updateSelectedDateHighlight();
    updateEventFocusHighlight();

    dayDetailContainer.setAttribute('aria-busy', 'false');
    updateDayDetailControls();

    if (shouldOpen) {
      openDayDetail({ focus: shouldFocus, trigger: opts.trigger });
    } else if (!isDayDetailOpen) {
      dayDetailContainer.setAttribute('aria-hidden', 'true');
    }
  }

  function renderFocusedEvent(eventData, options) {
    if (!dayDetailContainer || !dayDetailContent || !eventData) {
      return;
    }

    dayDetailContainer.setAttribute('aria-busy', 'true');

    dayDetailMode = 'event';
    focusedEventId = getEventKey(eventData);

    const opts = options && typeof options === 'object' ? options : {};
    const shouldOpen = opts.open !== false;
    const shouldFocus = opts.focus !== false;

    const dateKey = eventData.date || (eventData.start ? formatDateKey(eventData.start) : selectedDate);
    if (dateKey) {
      selectedDate = dateKey;
    }

    const displayLabel = formatDateLabel(dateKey);
    const focusedTypeKey = getEventCategoryKey(eventData);
    const focusedBaseType = getEventBaseType(eventData);
    const eventTypeLabel = typeLabels[focusedTypeKey] || typeLabels[focusedBaseType] || 'Evento';
    let headingText = eventData.title;
    if (!headingText) {
      const labelParts = [eventTypeLabel];
      const dateLabel = displayLabel || dateKey;
      if (dateLabel) {
        labelParts.push(`em ${dateLabel}`);
      }
      headingText = labelParts.join(' ');
    }
    updateDayDetailHeading(headingText);

    dayDetailContainer.dataset.date = dateKey || '';
    dayDetailContent.innerHTML = '';

    const header = document.createElement('div');
    header.className = 'tutor-calendar__day-detail-header';

    const dateEl = document.createElement('div');
    dateEl.className = 'tutor-calendar__day-detail-date';
    dateEl.textContent = displayLabel || dateKey || 'Detalhes do compromisso';
    header.appendChild(dateEl);

    const typeEl = document.createElement('span');
    typeEl.className = 'tutor-calendar__day-detail-count';
    typeEl.textContent = `Compromisso: ${eventTypeLabel}`;
    header.appendChild(typeEl);

    dayDetailContent.appendChild(header);

    const content = buildEventDetailContent(eventData, displayLabel, dateKey);
    if (content) {
      dayDetailContent.appendChild(content);
    } else {
      dayDetailContent.appendChild(buildDayDetailCard(eventData));
    }

    updateSelectedDateHighlight();
    updateEventFocusHighlight();

    dayDetailContainer.setAttribute('aria-busy', 'false');
    updateDayDetailControls();

    if (shouldOpen) {
      openDayDetail({ focus: shouldFocus, trigger: opts.trigger });
    } else if (!isDayDetailOpen) {
      dayDetailContainer.setAttribute('aria-hidden', 'true');
    }
  }

  function showEventDetails(eventData, options) {
    if (!eventData) {
      return;
    }
    const opts = options && typeof options === 'object' ? options : {};
    renderFocusedEvent(eventData, {
      open: true,
      focus: opts.focus !== false,
      trigger: opts.trigger,
    });
  }

  function dispatchSlot(dateObj, timeHint) {
    const target = dateObj instanceof Date ? new Date(dateObj.getTime()) : parseDate(dateObj);
    if (!target) {
      return;
    }
    closeDayDetail({ restoreFocus: false });
    const detail = {
      date: formatDateKey(target),
      time: timeHint || formatTime(target) || '09:00',
      source: 'tutor-calendar',
    };
    const customEvent = new CustomEvent('calendarSlotChosen', {
      detail: detail,
      bubbles: true,
    });
    root.dispatchEvent(customEvent);
  }

  function renderMonthView() {
    if (!calendarGrid) {
      return;
    }

    const monthStart = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
    const gridStart = new Date(monthStart);
    gridStart.setDate(monthStart.getDate() - monthStart.getDay());
    const totalCells = 42;

    monthLabelEl && (monthLabelEl.textContent = monthStart.toLocaleDateString('pt-BR', { month: 'long' }));
    yearLabelEl && (yearLabelEl.textContent = monthStart.getFullYear());

    calendarGrid.innerHTML = '';
    const today = new Date();

    for (let i = 0; i < totalCells; i += 1) {
      const cellDate = new Date(gridStart.getFullYear(), gridStart.getMonth(), gridStart.getDate() + i);
      const iso = formatDateKey(cellDate);
      const isOutside = cellDate.getMonth() !== monthStart.getMonth() || cellDate.getFullYear() !== monthStart.getFullYear();
      const cell = document.createElement('div');
      cell.className = 'tutor-calendar__day';
      cell.dataset.date = iso;

      if (isOutside) {
        cell.classList.add('is-outside');
      }
      if (isSameDay(cellDate, today)) {
        cell.classList.add('is-today');
      }

      const dateLabel = document.createElement('div');
      dateLabel.className = 'tutor-calendar__date';
      dateLabel.textContent = String(cellDate.getDate());

      const dayHeader = document.createElement('div');
      dayHeader.className = 'tutor-calendar__day-header';
      dayHeader.appendChild(dateLabel);

      const dayEvents = events.filter(function(event) {
        if (event.date !== iso) {
          return false;
        }
        return eventMatchesFilter(event, currentFilter);
      }).sort(sortEventsByStart);

      const totalCount = dayEvents.length;
      if (totalCount > 0) {
        const dateCount = document.createElement('div');
        dateCount.className = 'tutor-calendar__date-count';
        dateCount.textContent = String(totalCount);
        dayHeader.appendChild(dateCount);
      }

      cell.appendChild(dayHeader);

      const eventsWrapper = document.createElement('div');
      eventsWrapper.className = 'tutor-calendar__event-list';

      dayEvents.forEach(function(eventData) {
        eventsWrapper.appendChild(buildEventElement(eventData));
      });

      if (!dayEvents.length) {
        const emptyMarker = document.createElement('div');
        emptyMarker.className = 'text-muted small';
        emptyMarker.textContent = '—';
        eventsWrapper.appendChild(emptyMarker);
      }

      cell.appendChild(eventsWrapper);

      cell.addEventListener('click', function() {
        selectedDate = iso;
        lastDetailTrigger = cell;
        renderDayDetail(iso, { open: true, focus: true, trigger: cell });
      });

      calendarGrid.appendChild(cell);
    }

    updateEventFocusHighlight();
  }

  function renderWeekView() {
    if (!weekViewEl) {
      return;
    }

    const start = getStartOfWeek(viewDate);
    const end = new Date(start.getFullYear(), start.getMonth(), start.getDate() + 6);
    const startLabel = start.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
    const endLabel = end.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
    monthLabelEl && (monthLabelEl.textContent = `Semana de ${startLabel} a ${endLabel}`);
    const yearLabelParts = [String(start.getFullYear())];
    if (end.getFullYear() !== start.getFullYear()) {
      yearLabelParts.push(String(end.getFullYear()));
    }
    yearLabelEl && (yearLabelEl.textContent = yearLabelParts.join(' / '));

    weekViewEl.innerHTML = '';
    const today = new Date();
    const baseMonth = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);

    for (let i = 0; i < 7; i += 1) {
      const dayDate = new Date(start.getFullYear(), start.getMonth(), start.getDate() + i);
      const iso = formatDateKey(dayDate);
      const card = document.createElement('div');
      card.className = 'tutor-calendar__week-day-card';
      card.dataset.date = iso;

      const isOutside = dayDate.getMonth() !== baseMonth.getMonth() || dayDate.getFullYear() !== baseMonth.getFullYear();
      if (isOutside) {
        card.classList.add('is-outside');
      }
      if (isSameDay(dayDate, today)) {
        card.classList.add('is-today');
      }

      const header = document.createElement('div');
      header.className = 'd-flex justify-content-between align-items-baseline mb-2';

      const dayNameEl = document.createElement('div');
      dayNameEl.className = 'text-uppercase small text-muted';
      dayNameEl.textContent = weekdays[dayDate.getDay()];

      const dateEl = document.createElement('div');
      dateEl.className = 'fw-semibold';
      dateEl.textContent = dayDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });

      header.appendChild(dayNameEl);
      header.appendChild(dateEl);
      card.appendChild(header);

      const eventsWrapper = document.createElement('div');
      eventsWrapper.className = 'tutor-calendar__event-list flex-grow-1';

      const dayEvents = events.filter(function(event) {
        if (event.date !== iso) {
          return false;
        }
        return eventMatchesFilter(event, currentFilter);
      }).sort(sortEventsByStart);

      dayEvents.forEach(function(eventData) {
        eventsWrapper.appendChild(buildEventElement(eventData));
      });

      if (!dayEvents.length) {
        const emptyMarker = document.createElement('div');
        emptyMarker.className = 'text-muted small';
        emptyMarker.textContent = '—';
        eventsWrapper.appendChild(emptyMarker);
      }

      card.appendChild(eventsWrapper);

      card.addEventListener('click', function() {
        selectedDate = iso;
        lastDetailTrigger = card;
        renderDayDetail(iso, { open: true, focus: true, trigger: card });
      });

      weekViewEl.appendChild(card);
    }

    updateEventFocusHighlight();
  }

  function renderCalendar() {
    updateFilterButtons();
    updateViewModeButtons();
    if (currentViewMode === 'week') {
      weekdaysEl && weekdaysEl.classList.add('d-none');
      calendarGrid && calendarGrid.classList.add('d-none');
      if (weekViewEl) {
        weekViewEl.classList.remove('d-none');
      }
      renderWeekView();
    } else {
      weekdaysEl && weekdaysEl.classList.remove('d-none');
      calendarGrid && calendarGrid.classList.remove('d-none');
      if (weekViewEl) {
        weekViewEl.classList.add('d-none');
      }
      renderMonthView();
    }
    if (dayDetailMode === 'event' && focusedEventId) {
      const activeKey = String(focusedEventId);
      const targetEvent = events.find(function(eventItem) {
        return getEventKey(eventItem) === activeKey;
      });
      if (targetEvent) {
        let activeElement = null;
        if (activeKey) {
          try {
            const selectorKey = activeKey.replace(/"/g, '\"');
            activeElement = root.querySelector(`[data-event-id="${selectorKey}"]`);
          } catch (error) {
            activeElement = null;
          }
        }
        if (activeElement) {
          lastDetailTrigger = activeElement;
        }
        renderFocusedEvent(targetEvent, {
          open: isDayDetailOpen,
          focus: false,
          trigger: lastDetailTrigger,
        });
        return;
      }
      dayDetailMode = 'day';
      focusedEventId = null;
    }
    renderDayDetail(null, {
      open: isDayDetailOpen,
      focus: false,
      trigger: lastDetailTrigger,
    });
  }

  function toSharedEventObject(eventApi) {
    if (!eventApi) {
      return null;
    }
    const extended = Object.assign({}, eventApi.extendedProps || {});
    const eventType = extended.eventType || extended.type || eventApi.type || null;
    return {
      id: eventApi.id || null,
      title: eventApi.title || '',
      start: eventApi.start ? eventApi.start.toISOString() : (eventApi.startStr || null),
      end: eventApi.end ? eventApi.end.toISOString() : (eventApi.endStr || null),
      allDay: !!eventApi.allDay,
      type: eventType,
      extendedProps: extended,
    };
  }

  function normalizeSharedEventPayload(item) {
    if (!item) {
      return null;
    }
    if (item.raw) {
      return normalizeSharedEventPayload(item.raw);
    }
    if (typeof item.start === 'string') {
      const plain = Object.assign({
        id: item.id || null,
        title: item.title || '',
        start: item.start || null,
        end: item.end || null,
        allDay: !!item.allDay,
      }, item);
      const extended = Object.assign({}, plain.extendedProps || {});
      if (!plain.type) {
        const derivedType = extended.eventType || extended.type;
        if (derivedType) {
          plain.type = derivedType;
        }
      }
      plain.extendedProps = extended;
      return plain;
    }
    if (item.start instanceof Date || item.end instanceof Date) {
      return toSharedEventObject(item);
    }
    const fallback = Object.assign({
      id: item.id || null,
      title: item.title || '',
      start: item.start || item.startStr || null,
      end: item.end || item.endStr || null,
      allDay: !!item.allDay,
    }, item);
    const extended = Object.assign({}, fallback.extendedProps || {});
    if (!fallback.type) {
      const derivedType = extended.eventType || extended.type;
      if (derivedType) {
        fallback.type = derivedType;
      }
    }
    fallback.extendedProps = extended;
    return fallback;
  }

  function prepareSharedEventsPayload(list) {
    return (Array.isArray(list) ? list : [])
      .map(normalizeSharedEventPayload)
      .filter(Boolean);
  }

  function dispatchLocalSharedEvents(eventsList) {
    if (typeof document === 'undefined') {
      return;
    }
    const prepared = prepareSharedEventsPayload(eventsList);
    if (typeof window !== 'undefined') {
      window.sharedCalendarEvents = prepared;
      window.sharedCalendarEventsSource = sharedCalendarSourceId;
    }
    document.dispatchEvent(new CustomEvent('sharedCalendarEvents', {
      detail: {
        events: prepared,
        source: sharedCalendarSourceId,
      },
    }));
  }

  function dispatchLocalSharedLoading(isLoading) {
    if (typeof window !== 'undefined') {
      window.sharedCalendarIsLoading = !!isLoading;
    }
    document.dispatchEvent(new CustomEvent('sharedCalendarEventsLoading', {
      detail: {
        loading: !!isLoading,
        source: sharedCalendarSourceId,
      },
    }));
  }

  function collectCurrentRawEvents() {
    return events.map(function(eventItem) {
      if (!eventItem) {
        return null;
      }
      if (eventItem.raw) {
        return eventItem.raw;
      }
      return eventItem;
    }).filter(Boolean);
  }

  function broadcastCurrentEvents() {
    const rawEvents = collectCurrentRawEvents();
    dispatchLocalSharedEvents(rawEvents);
  }

  function refreshSharedEventsFromLocal() {
    if (usingSharedCalendar) {
      return;
    }
    broadcastCurrentEvents();
  }

  function refreshEventsView(options = {}) {
    const shouldBroadcast = options.broadcast !== false;
    events = filterEventsByVet(allEvents, activeVetFilterId);
    renderCalendar();
    renderPetList();
    if (shouldBroadcast) {
      broadcastCurrentEvents();
    }
  }

  function updateEvents(newEvents, options = {}) {
    const normalized = (newEvents || []).map(normalizeEvent).filter(function(ev) {
      return ev && ev.date;
    });
    allEvents = normalized;
    refreshEventsView(options);
  }

  async function fetchEventsFromApi() {
    if (isFetchingLocalEvents) {
      return;
    }
    isFetchingLocalEvents = true;
    const shouldDispatchLoading = !usingSharedCalendar;
    if (shouldDispatchLoading) {
      dispatchLocalSharedLoading(true);
    }
    try {
      const response = await fetch(eventsUrl, {
        headers: {
          'Accept': 'application/json',
        },
        credentials: 'same-origin',
      });
      if (!response.ok) {
        throw new Error('Não foi possível carregar eventos.');
      }
      const data = await response.json();
      if (Array.isArray(data) && !usingSharedCalendar) {
        updateEvents(data);
      }
    } catch (error) {
      console.error('Erro ao carregar eventos para o calendário experimental.', error);
    } finally {
      isFetchingLocalEvents = false;
      if (shouldDispatchLoading) {
        dispatchLocalSharedLoading(false);
      }
    }
  }

  async function loadPets() {
    const shouldSkipPetLoading = !petListEl
      && !petSubtitleEl
      && !petFilterSearchInput
      && !petFilterSpeciesSelect
      && !petFilterBreedSelect
      && !petFilterClearBtn
      && !togglePetsBtn
      && !refreshPetsBtn;
    if (shouldSkipPetLoading) {
      return;
    }
    if (petListEl) {
      petListEl.innerHTML = '<div class="text-muted small">Carregando pets...</div>';
      petListEl.classList.remove('is-expanded');
    }
    currentPetLimit = petsInitialLimit;
    filteredPetsCache = [];
    hasLoadedPets = false;
    petListHasError = false;
    if (togglePetsBtn) {
      togglePetsBtn.classList.add('d-none');
      togglePetsBtn.setAttribute('aria-hidden', 'true');
      togglePetsBtn.setAttribute('aria-expanded', 'false');
      togglePetsBtn.removeAttribute('data-action');
    }
    if (petSubtitleEl) {
      petSubtitleEl.textContent = 'Carregando pets da clínica...';
    }

    try {
      const response = await fetch(petsUrl, {
        headers: {
          'Accept': 'application/json',
        },
        credentials: 'same-origin',
      });
      if (!response.ok) {
        throw new Error('Não foi possível carregar a lista de pets.');
      }
      const data = await response.json();
      const normalized = Array.isArray(data) ? data.map(function(item) {
        const copy = Object.assign({}, item);
        const rawDate = copy.dateAdded || copy.date_added || null;
        copy.dateAdded = rawDate;
        copy._speciesKey = normalizeFilterValue(copy.species);
        copy._breedKey = normalizeFilterValue(copy.breed);
        const searchParts = [];
        if (copy.name) {
          searchParts.push(copy.name);
        }
        if (copy.tutor_name) {
          searchParts.push(copy.tutor_name);
        }
        if (copy.species) {
          searchParts.push(copy.species);
        }
        if (copy.breed) {
          searchParts.push(copy.breed);
        }
        copy._searchIndex = normalizeTextForSearch(searchParts.join(' '));
        return copy;
      }) : [];
      normalized.sort(function(a, b) {
        const aDate = a.dateAdded ? new Date(a.dateAdded) : null;
        const bDate = b.dateAdded ? new Date(b.dateAdded) : null;
        const aValid = aDate && !Number.isNaN(aDate.getTime());
        const bValid = bDate && !Number.isNaN(bDate.getTime());
        if (aValid && bValid) {
          return bDate.getTime() - aDate.getTime();
        }
        if (aValid) {
          return -1;
        }
        if (bValid) {
          return 1;
        }
        const nameA = (a.name || '').toLowerCase();
        const nameB = (b.name || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });
      pets = normalized;
      hasLoadedPets = true;
      petListHasError = false;
      resetPetPagination();
      refreshPetFilterOptions();
      renderPetList();
    } catch (error) {
      console.error('Erro ao carregar pets.', error);
      pets = [];
      petListHasError = true;
      hasLoadedPets = false;
      if (petListEl) {
        petListEl.innerHTML = '<div class="text-muted small">Não foi possível carregar os pets.</div>';
        petListEl.classList.remove('is-expanded');
      }
      if (petSubtitleEl) {
        petSubtitleEl.textContent = 'Não foi possível carregar os pets.';
      }
      refreshPetFilterOptions();
      updatePetFilterClearState();
    }
  }

  function setFilter(filter) {
    currentFilter = canonicalizeEventTypeKey(filter) || 'all';
    updateFilterButtons();
    renderCalendar();
  }

  function moveView(step) {
    if (currentViewMode === 'week') {
      const base = getStartOfWeek(viewDate);
      base.setDate(base.getDate() + (step * 7));
      viewDate = base;
    } else {
      viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + step, 1);
    }
    renderCalendar();
  }

  function setViewMode(mode) {
    const normalized = mode === 'week' ? 'week' : 'month';
    if (normalized === currentViewMode) {
      return;
    }
    currentViewMode = normalized;
    if (currentViewMode === 'week') {
      viewDate = getStartOfWeek(viewDate);
    } else {
      viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
    }
    updateViewModeButtons();
    renderCalendar();
  }

  prevBtn && prevBtn.addEventListener('click', function() {
    moveView(-1);
  });

  nextBtn && nextBtn.addEventListener('click', function() {
    moveView(1);
  });

  todayBtn && todayBtn.addEventListener('click', function() {
    const now = new Date();
    const todayKey = formatDateKey(now);
    selectedDate = todayKey;
    dayDetailMode = 'day';
    focusedEventId = null;
    lastDetailTrigger = todayBtn;
    if (currentViewMode === 'week') {
      viewDate = getStartOfWeek(now);
    } else {
      viewDate = new Date(now.getFullYear(), now.getMonth(), 1);
    }
    renderCalendar();
    renderDayDetail(todayKey, {
      open: true,
      focus: true,
      trigger: todayBtn,
    });
  });

  newEventBtn && newEventBtn.addEventListener('click', function() {
    const todayKey = formatDateKey(new Date());
    let targetDateKey = selectedDate || todayKey;
    let targetDate = parseDateKey(targetDateKey);

    if (!targetDate) {
      targetDateKey = formatDateKey(viewDate instanceof Date ? viewDate : new Date());
      targetDate = parseDateKey(targetDateKey) || new Date();
    }

    selectedDate = targetDateKey;

    if (currentViewMode === 'week') {
      viewDate = getStartOfWeek(targetDate);
    } else {
      viewDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), 1);
    }

    renderCalendar();
    renderDayDetail(targetDateKey, {
      open: true,
      focus: true,
      trigger: newEventBtn,
    });

    dispatchSlot(targetDate, '09:00');
  });

  refreshPetsBtn && refreshPetsBtn.addEventListener('click', function() {
    loadPets();
  });

  togglePetsBtn && togglePetsBtn.addEventListener('click', function() {
    if (petListHasError || !hasLoadedPets) {
      return;
    }
    const totalFiltered = Array.isArray(filteredPetsCache) ? filteredPetsCache.length : 0;
    const action = togglePetsBtn.dataset.action || 'more';
    if (action === 'collapse') {
      const minimumLimit = Math.min(petsInitialLimit, totalFiltered || petsInitialLimit);
      currentPetLimit = minimumLimit;
      renderPetList();
      if (petListEl) {
        if (typeof petListEl.scrollTo === 'function') {
          petListEl.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
          petListEl.scrollTop = 0;
        }
      }
      return;
    }
    if (totalFiltered > currentPetLimit) {
      currentPetLimit = Math.min(currentPetLimit + petsPageSize, totalFiltered);
      renderPetList();
    }
  });

  if (petFilterSearchInput) {
    petFilterSearchInput.addEventListener('input', function(event) {
      petFilterState.search = event.target.value || '';
      resetPetPagination();
      renderPetList();
    });
  }

  if (petFilterSpeciesSelect) {
    petFilterSpeciesSelect.addEventListener('change', function(event) {
      petFilterState.species = normalizeFilterValue(event.target.value);
      petFilterState.breed = '';
      resetPetPagination();
      refreshPetBreedOptions();
      renderPetList();
    });
  }

  if (petFilterBreedSelect) {
    petFilterBreedSelect.addEventListener('change', function(event) {
      petFilterState.breed = normalizeFilterValue(event.target.value);
      resetPetPagination();
      renderPetList();
    });
  }

  if (petFilterClearBtn) {
    petFilterClearBtn.addEventListener('click', function() {
      if (!hasActivePetFilters()) {
        return;
      }
      petFilterState.search = '';
      petFilterState.species = '';
      petFilterState.breed = '';
      resetPetPagination();
      refreshPetFilterOptions();
      renderPetList();
    });
  }

  filterButtons.forEach(function(btn) {
    btn.addEventListener('click', function() {
      setFilter(btn.dataset.filter || 'all');
    });
  });

  viewModeButtons.forEach(function(btn) {
    btn.addEventListener('click', function() {
      setViewMode(btn.dataset.viewMode);
    });
  });

  if (dayDetailBackBtn) {
    dayDetailBackBtn.addEventListener('click', function(event) {
      event.preventDefault();
      const targetDate = (dayDetailContainer && dayDetailContainer.dataset && dayDetailContainer.dataset.date)
        || selectedDate
        || null;
      const trigger = lastDetailTrigger && typeof lastDetailTrigger.focus === 'function'
        ? lastDetailTrigger
        : null;
      dayDetailMode = 'day';
      focusedEventId = null;
      const options = {
        open: true,
        focus: true,
      };
      if (trigger) {
        options.trigger = trigger;
      }
      renderDayDetail(targetDate, options);
    });
  }

  dayDetailCloseBtn && dayDetailCloseBtn.addEventListener('click', function(event) {
    event.preventDefault();
    closeDayDetail({ restoreFocus: true });
  });

  dayDetailBackdrop && dayDetailBackdrop.addEventListener('click', function() {
    closeDayDetail({ restoreFocus: true });
  });

  if (dayDetailContent) {
    dayDetailContent.addEventListener('click', function(event) {
      if (event.defaultPrevented) {
        return;
      }
      const card = event.target && event.target.closest('.tutor-calendar__day-detail-card');
      if (!card) {
        return;
      }
      const interactiveSelector = 'a, button, input, textarea, select, [data-ignore-card-click], [role="button"]:not(.tutor-calendar__day-detail-card)';
      if (event.target && event.target.closest(interactiveSelector)) {
        return;
      }
      const eventData = findEventFromElement(card);
      if (!eventData) {
        return;
      }
      event.preventDefault();
      event.stopPropagation();
      showEventDetails(eventData, { trigger: card });
    });

    dayDetailContent.addEventListener('keydown', function(event) {
      if (!event || event.defaultPrevented) {
        return;
      }
      const card = event.target && event.target.closest('.tutor-calendar__day-detail-card');
      if (!card || event.target !== card) {
        return;
      }
      const isEnter = event.key === 'Enter';
      const isSpace = event.key === ' ' || event.key === 'Spacebar';
      if (!isEnter && !isSpace) {
        return;
      }
      const eventData = findEventFromElement(card);
      if (!eventData) {
        return;
      }
      event.preventDefault();
      event.stopPropagation();
      showEventDetails(eventData, { trigger: card });
    });
  }

  if (dayDetailContainer) {
    dayDetailContainer.addEventListener('keydown', function(event) {
      if ((event.key === 'Escape' || event.key === 'Esc') && isDayDetailOpen) {
        event.stopPropagation();
        closeDayDetail({ restoreFocus: true });
      }
    });
  }

  root.addEventListener('keydown', function(event) {
    if (!isDayDetailOpen) {
      return;
    }
    if (event.key === 'Escape' || event.key === 'Esc') {
      closeDayDetail({ restoreFocus: true });
    }
  });

  updateDayDetailControls();

  function handleVetFilterChange(event) {
    if (!event) {
      return;
    }
    const detail = event.detail || {};
    const normalized = normalizeVetFilterId(detail.vetId);
    if (normalized === activeVetFilterId) {
      return;
    }
    activeVetFilterId = normalized;
    refreshEventsView();
  }

  document.addEventListener('calendarVetFilterChange', handleVetFilterChange);

  function handleSharedEvents(event) {
    if (!event || !event.detail) {
      return;
    }
    if (event.detail.source === sharedCalendarSourceId) {
      return;
    }
    usingSharedCalendar = true;
    if (typeof window !== 'undefined') {
      window.sharedCalendarEventsSource = event.detail.source || null;
    }
    const shared = Array.isArray(event.detail.events) ? event.detail.events : [];
    updateEvents(shared);
  }

  document.addEventListener('sharedCalendarEvents', handleSharedEvents);

  document.addEventListener('sharedCalendarReady', function(evt) {
    if (usingSharedCalendar) {
      return;
    }
    const calendar = evt && evt.detail && evt.detail.calendar;
    if (calendar && typeof calendar.getEvents === 'function') {
      const calendarEvents = calendar.getEvents();
      updateEvents(calendarEvents);
      usingSharedCalendar = true;
    }
  });

  if (Array.isArray(window.sharedCalendarEvents) && window.sharedCalendarEvents.length) {
    const sharedSource = typeof window !== 'undefined' ? window.sharedCalendarEventsSource : null;
    if (sharedSource === sharedCalendarSourceId) {
      updateEvents(window.sharedCalendarEvents);
    } else {
      usingSharedCalendar = true;
      updateEvents(window.sharedCalendarEvents);
    }
  } else if (typeof window !== 'undefined' && window.sharedCalendar && typeof window.sharedCalendar.getEvents === 'function') {
    const existing = window.sharedCalendar.getEvents();
    if (Array.isArray(existing) && existing.length) {
      usingSharedCalendar = true;
      updateEvents(existing);
    }
  }

  if (!usingSharedCalendar) {
    const shouldDelayFallback = typeof window !== 'undefined' && window.sharedCalendar;
    if (shouldDelayFallback) {
      setTimeout(function() {
        if (!usingSharedCalendar) {
          fetchEventsFromApi();
        }
      }, 1200);
    } else {
      fetchEventsFromApi();
    }
  }

  renderWeekdays();
  updateViewModeButtons();
  renderCalendar();
  updateFilterButtons();
  loadPets();
});
</script>
