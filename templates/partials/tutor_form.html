{% set has_tutor = tutor is defined and tutor %}

<!-- 游댌 Busca de Tutor - Melhorado com acessibilidade e feedback visual -->
<div class="mb-4 position-relative" id="tutor-search-box" {% if has_tutor %}style="display:none;"{% endif %}>
  <label for="autocomplete-tutor" class="form-label">
    <i class="bi bi-search me-1"></i> Buscar Tutor Existente
  </label>
  <div class="input-group">
    <input type="text" id="autocomplete-tutor" class="form-control" 
           placeholder="Digite nome, e-mail, CPF ou telefone"
           aria-label="Buscar tutor existente"
           aria-describedby="tutor-search-help">
    <button class="btn btn-outline-secondary" type="button" id="clear-search">
      <i class="bi bi-x"></i>
    </button>
  </div>
  <div id="tutor-search-help" class="form-text">Busque tutores j치 cadastrados para vincular ao animal</div>
  <ul class="list-group position-absolute w-100 mt-1 d-none shadow" 
      id="autocomplete-results" style="z-index:1000; max-height:300px; overflow-y:auto;"></ul>
</div>

<!-- 游녻 Formul치rio de Tutor - Aprimorado com valida칞칚o e organiza칞칚o -->
<form id="tutor-form" method="POST" enctype="multipart/form-data"
      {% if has_tutor %}action="{{ url_for('update_tutor', user_id=tutor.id) }}"{% endif %}
      class="needs-validation" novalidate
      onsubmit="this.querySelector('button[type=submit]').disabled = true;">
  
  <h5 class="mb-4 d-flex align-items-center gap-2">
    <i class="bi bi-person-fill"></i> Cadastro do Tutor
  </h5>

  <div class="row g-3">
    <!-- Foto + Nome - Melhorado com preview e valida칞칚o -->
    <div class="col-md-6">
      <label class="form-label">Foto e Nome</label>
      <div class="d-flex align-items-center gap-3">
        <label for="profile_photo" class="cursor-pointer mb-0">
          {% if tutor.profile_photo %}
            <img id="tutor-preview" src="{{ tutor.profile_photo }}" alt="Foto de {{ tutor.name }}" 
                 class="img-thumbnail rounded-circle" style="width: 60px; height: 60px; object-fit: cover;">
          {% else %}
            <div id="tutor-preview-placeholder" 
                 class="rounded-circle bg-light d-flex align-items-center justify-content-center border" 
                 style="width: 60px; height: 60px; font-size: 26px;">
              <i class="bi bi-person"></i>
            </div>
          {% endif %}
        </label>
        <div class="flex-grow-1">
          <input id="profile_photo" name="profile_photo" type="file" accept="image/*" 
                 class="form-control d-none">
          <input type="text" name="name" class="form-control" placeholder="Nome completo do tutor"
                 value="{{ tutor.name|default('', true) if has_tutor else '' }}" required minlength="3" maxlength="100">
          <div class="invalid-feedback">Por favor, insira um nome v치lido (3-100 caracteres)</div>
        </div>
      </div>
    </div>

    <!-- Telefone - Aceita apenas n칰meros -->
    <div class="col-md-6">
      <label for="tutor-phone" class="form-label">Telefone</label>
      <input type="tel" id="tutor-phone" name="phone" class="form-control" 
             placeholder="Apenas n칰meros (ex: 99999999999)" 
             pattern="[0-9]{10,11}"
             value="{{ tutor.phone|default('', true) if has_tutor else '' }}">
      <div class="invalid-feedback">Por favor, insira um telefone v치lido (10 ou 11 d칤gitos)</div>
    </div>

    <!-- CPF - Aceita apenas n칰meros -->
    <div class="col-md-6">
      <label for="tutor-cpf" class="form-label">CPF</label>
      <input type="text" id="tutor-cpf" name="cpf" class="form-control" 
             placeholder="Apenas n칰meros (ex: 12345678901)" 
             pattern="[0-9]{11}"
             value="{{ tutor.cpf|default('', true) if has_tutor else '' }}">
      <div class="invalid-feedback">Por favor, insira um CPF v치lido (11 d칤gitos)</div>
    </div>

        <div class="col-md-6">
      <label for="tutor-rg" class="form-label">RG</label>
      <input type="text" id="tutor-rg" name="rg" class="form-control"
             placeholder="Documento de identidade" pattern="[A-Za-z0-9]+"
             value="{{ tutor.rg|default('', true) if has_tutor else '' }}">
      <div class="invalid-feedback">Por favor, insira um RG v치lido (apenas letras ou n칰meros)</div>
    </div>
    
    <!-- Data de nascimento + Idade - Com c치lculo autom치tico -->
    <div class="col-md-6">
      <label for="tutor-date-of-birth" class="form-label">Data de Nascimento</label>
      <input type="date" id="tutor-date-of-birth" name="date_of_birth" 
            class="form-control" max="{{ '%Y-%m-%d' | date_now }}"
            value="{{ tutor.date_of_birth.strftime('%Y-%m-%d') if has_tutor and tutor.date_of_birth else '' }}"
            onchange="calcularIdade()">
      <div class="invalid-feedback">Por favor, insira uma data v치lida</div>
    </div>

    <div class="col-md-6">
      <label for="tutor-age" class="form-label">Idade</label>
      <input type="text" id="tutor-age" class="form-control bg-light" disabled>
    </div>

    <!-- Email - Com valida칞칚o robusta -->
    <div class="col-md-12">
      <label for="tutor-email" class="form-label">E-mail</label>
      <input type="email" id="tutor-email" name="email" class="form-control" 
             placeholder="exemplo@email.com" required
             value="{{ tutor.email|default('', true) if has_tutor else '' }}">
      <div class="invalid-feedback">Por favor, insira um e-mail v치lido</div>
    </div>

    <!-- Endere칞o completo via CEP - Melhorado -->
    <div class="col-md-12">
      {% if has_tutor %}
        {% set endereco = tutor.endereco %}
      {% else %}
        {% set endereco = None %}
      {% endif %}
      {% include "partials/endereco_form.html" with context %}
    </div>

    <!-- Adicionado por e data - Melhorado -->
    {% if has_tutor and tutor.added_by %}
      <div class="col-md-12">
        <label for="created-info" class="form-label">
          <i class="bi bi-person-plus"></i> Adicionado por
        </label>
        <input type="text" id="created-info" class="form-control bg-light"
               data-nome="{{ tutor.added_by.name }}"
               data-created-at="{{ tutor.created_at.isoformat() if tutor.created_at else '' }}"
               disabled>
      </div>
    {% endif %}

    <!-- Bot칚o - Melhorado com feedback -->
    <div class="col-12 mt-3">
      <button type="submit" class="btn btn-primary w-100 py-2">
        <i class="bi bi-save me-2"></i> Salvar Tutor
      </button>
    </div>
  </div>
</form>

<!-- Scripts Aprimorados -->
{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Valida칞칚o do formul치rio
    const forms = document.querySelectorAll('.needs-validation');
    
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });

    // Removidas as m치scaras complexas
    // Agora s칩 permitimos n칰meros nesses campos
    document.getElementById('tutor-phone')?.addEventListener('input', function(e) {
      this.value = this.value.replace(/\D/g, '');
    });
    
    document.getElementById('tutor-cpf')?.addEventListener('input', function(e) {
      this.value = this.value.replace(/\D/g, '');
    });
    
    document.getElementById('tutor-rg')?.addEventListener('input', function(e) {
      this.value = this.value.replace(/[^0-9A-Za-z]/g, '');
    });

    // C치lculo de idade
    function calcularIdadeTutor() {
      const dataNasc = document.getElementById('tutor-date-of-birth').value;
      const idadeInput = document.getElementById('tutor-age');
      
      if (dataNasc) {
        const hoje = new Date();
        const nascimento = new Date(dataNasc);
        let idade = hoje.getFullYear() - nascimento.getFullYear();
        const mes = hoje.getMonth() - nascimento.getMonth();
        
        if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
          idade--;
        }
        
        idadeInput.value = `${idade} anos`;
      } else {
        idadeInput.value = '';
      }
    }

    document.getElementById('tutor-date-of-birth')?.addEventListener('change', calcularIdadeTutor);

    // Preview da imagem
    document.getElementById('profile_photo')?.addEventListener('change', function(event) {
      const file = event.target.files[0];
      const preview = document.getElementById('tutor-preview');
      const placeholder = document.getElementById('tutor-preview-placeholder');
      
      if (file) {
        // Valida칞칚o da imagem (2MB m치ximo, tipos permitidos)
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        const maxSize = 2 * 1024 * 1024; // 2MB
        
        if (!validTypes.includes(file.type)) {
          alert('Por favor, selecione uma imagem no formato JPEG, PNG ou WEBP.');
          return;
        }
        
        if (file.size > maxSize) {
          alert('A imagem n칚o pode ser maior que 2MB.');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          if (preview) {
            preview.src = e.target.result;
          } else {
            const newImg = document.createElement('img');
            newImg.id = 'tutor-preview';
            newImg.src = e.target.result;
            newImg.alt = 'Foto do tutor';
            newImg.className = 'img-thumbnail rounded-circle';
            newImg.style = 'width: 60px; height: 60px; object-fit: cover;';
            placeholder.replaceWith(newImg);
          }
        };
        reader.readAsDataURL(file);
      }
    });

    // Formata칞칚o da informa칞칚o "Adicionado por"
    const createdInfo = document.getElementById('created-info');
    if (createdInfo) {
      const nome = createdInfo.dataset.nome;
      const createdAt = createdInfo.dataset.createdAt;
      
      if (createdAt) {
        const date = new Date(createdAt);
        const options = { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        };
        createdInfo.value = `${nome} em ${date.toLocaleDateString('pt-BR', options)}`;
      } else {
        createdInfo.value = `${nome} (data desconhecida)`;
      }
    }

    // Limpar busca
    document.getElementById('clear-search')?.addEventListener('click', () => {
      document.getElementById('autocomplete-tutor').value = '';
      document.getElementById('autocomplete-results').classList.add('d-none');
    });

    // Auto-complete
    const autocompleteTutor = document.getElementById('autocomplete-tutor');
    if (autocompleteTutor) {
      autocompleteTutor.addEventListener('input', debounce(async (e) => {
        const termo = e.target.value.trim();
        const resultsContainer = document.getElementById('autocomplete-results');
        
        if (termo.length < 3) {
          resultsContainer.classList.add('d-none');
          return;
        }
        
        try {
          const response = await fetch(`/api/tutores/buscar?q=${encodeURIComponent(termo)}`);
          const tutores = await response.json();
          
          if (tutores.length > 0) {
            resultsContainer.innerHTML = tutores.map(tutor => `
              <li class="list-group-item list-group-item-action" 
                  data-tutor-id="${tutor.id}"
                  onclick="selecionarTutor(${tutor.id}, '${tutor.name}', '${tutor.email}')">
                <div class="d-flex justify-content-between">
                  <span>${tutor.name}</span>
                  <small class="text-muted">${tutor.email}</small>
                </div>
                <div class="d-flex gap-2 small">
                  <span>${tutor.phone || 'Sem telefone'}</span>
                  <span>${tutor.cpf ? 'CPF: ' + tutor.cpf : ''}</span>
                </div>
              </li>
            `).join('');
            resultsContainer.classList.remove('d-none');
          } else {
            resultsContainer.innerHTML = '<li class="list-group-item text-muted">Nenhum tutor encontrado</li>';
            resultsContainer.classList.remove('d-none');
          }
        } catch (error) {
          console.error('Erro na busca:', error);
          resultsContainer.innerHTML = '<li class="list-group-item text-danger">Erro na busca</li>';
          resultsContainer.classList.remove('d-none');
        }
      }, 300));
    }
  });

  // Fun칞칚o debounce para melhorar performance
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Selecionar tutor na busca
  function selecionarTutor(id, nome, email) {
    document.getElementById('tutor-search-box').style.display = 'none';
    document.getElementById('tutor-form').style.display = 'block';
    document.getElementById('autocomplete-results').classList.add('d-none');
    
    // Aqui voc칡 pode preencher os campos ou fazer o que for necess치rio
    console.log(`Tutor selecionado: ${nome} (${email})`);
  }

  function calcularIdade() {
    const dataNascimento = document.getElementById('tutor-date-of-birth').value;
    const campoIdade = document.getElementById('tutor-age');
    
    if (dataNascimento) {
      const hoje = new Date();
      const nascimento = new Date(dataNascimento);
      let idade = hoje.getFullYear() - nascimento.getFullYear();
      
      // Ajuste para caso ainda n칚o tenha feito anivers치rio este ano
      const mesAtual = hoje.getMonth();
      const mesNascimento = nascimento.getMonth();
      
      if (mesNascimento > mesAtual || 
          (mesNascimento === mesAtual && hoje.getDate() < nascimento.getDate())) {
        idade--;
      }
      
      campoIdade.value = idade + " anos";
    } else {
      campoIdade.value = "";
    }
  }

  // Calcular idade ao carregar a p치gina se j치 existir data
  document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('tutor-date-of-birth').value) {
      calcularIdade();
    }
  });
</script>
{% endblock %}