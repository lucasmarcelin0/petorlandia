<div class="tutor-management-panel">
  <div class="mb-4">
    <h3 class="fw-semibold mb-1">Gest√£o de Tutores</h3>
    <p class="text-muted small mb-0">Busque um tutor existente ou cadastre um novo sem sair desta tela.</p>
  </div>

  <!-- üîç Busca de tutor -->
  <div class="p-3 rounded-4 border bg-light-subtle mb-4">
    <div class="d-flex align-items-center gap-2 mb-2">
      <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill">üîç</span>
      <h6 class="mb-0">Buscar Tutor</h6>
    </div>
    <div class="input-group">
      <span class="input-group-text bg-light text-secondary"><i class="bi bi-search"></i></span>
      <input
        id="busca-tutor"
        class="form-control"
        placeholder="Digite nome, e-mail, CPF, RG, telefone ou endere√ßo"
        aria-label="Buscar tutor"
      >
      <div class="dropdown" data-search-filter data-search-target="tutor-panel">
        <input type="hidden" id="tutor-panel-sort" value="name_asc" data-sort-input data-target="tutor-panel">
        <button
          class="btn btn-outline-secondary"
          type="button"
          data-bs-toggle="dropdown"
          aria-expanded="false"
          aria-label="Ordenar resultados"
          data-sort-button
          data-sort-default-label="Ordem alfab√©tica"
        >
          <i class="bi bi-funnel"></i>
          <span class="d-none d-md-inline small ms-1" data-sort-label>Ordem alfab√©tica</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
          <li><button class="dropdown-item active" type="button" data-sort-option data-sort-value="name_asc" data-sort-label="Ordem alfab√©tica">Ordem alfab√©tica (A-Z)</button></li>
          <li><button class="dropdown-item" type="button" data-sort-option data-sort-value="recent_added" data-sort-label="Mais recentes">√öltimos adicionados</button></li>
          <li><button class="dropdown-item" type="button" data-sort-option data-sort-value="recent_attended" data-sort-label="Atendimentos recentes">√öltimos com atendimento</button></li>
        </ul>
      </div>
    </div>
    <ul id="lista-tutores" class="list-group shadow-sm mt-2 d-none"></ul>
    <p class="text-muted small mb-0 mt-2">Selecione para abrir a ficha do tutor.</p>
  </div>

  <!-- ‚ûï Cadastro de novo tutor -->
  <div class="d-flex align-items-center gap-2 mb-3">
    <span class="badge bg-success-subtle text-success-emphasis rounded-pill">‚ûï</span>
    <h5 class="fw-semibold mb-0">Cadastrar Novo Tutor</h5>
  </div>

  <form id="novo-tutor-form" method="POST" action="{{ url_for('tutores') }}" class="js-tutor-form" data-sync="true" novalidate>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Nome</label>
        <input name="name" class="form-control" required minlength="3" maxlength="100">
        <div class="invalid-feedback">Informe o nome completo do tutor.</div>
      </div>
      <div class="col-md-6">
        <label class="form-label">E-mail</label>
        <input name="email" type="email" class="form-control" required>
        <div class="invalid-feedback">Informe um e-mail v√°lido.</div>
      </div>
      <div class="col-md-6">
        <label class="form-label">Telefone</label>
        <input name="phone" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label">CPF</label>
        <input name="cpf" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label">RG</label>
        <input name="rg" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label">Data de Nascimento</label>
        <input id="date_of_birth" name="date_of_birth" type="text" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label">Idade</label>
        <input id="age" type="number" class="form-control" min="0">
      </div>
      <div class="col-12">
        {% include "partials/endereco_form.html" %}
      </div>
    </div>
    <button class="btn btn-success w-100 mt-4" data-original="üíæ Salvar e abrir ficha">üíæ Salvar e abrir ficha</button>
  </form>

  </div>
</div>

<!-- ‚ú® Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<script src="{{ url_for('static', filename='js/date_mask.js') }}"></script>

<!-- Script geral -->
<script>
  const inputTutor = document.getElementById('busca-tutor');
  const listaTutor = document.getElementById('lista-tutores');
  const sortInput = document.getElementById('tutor-panel-sort');
  const filterContainer = document.querySelector('[data-search-filter][data-search-target="tutor-panel"]');

  async function carregarTutores(query) {
    const params = new URLSearchParams({ q: query });
    if (sortInput && sortInput.value) {
      params.set('sort', sortInput.value);
    }
    const response = await fetch(`/buscar_tutores?${params.toString()}`);
    if (!response.ok) {
      throw new Error('Erro ao buscar tutores');
    }
    return response.json();
  }

  if (inputTutor && listaTutor) {
    const renderResultados = (data) => {
      listaTutor.innerHTML = '';
      if (!data.length) {
        listaTutor.classList.add('d-none');
        return;
      }

      data.forEach(t => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';

        const nameLine = document.createElement('div');
        nameLine.className = 'fw-semibold';
        nameLine.textContent = t.name || 'Tutor sem nome';
        li.appendChild(nameLine);

        const details = t.details || [
          t.email,
          t.phone,
          t.cpf ? `CPF: ${t.cpf}` : null,
          t.rg ? `RG: ${t.rg}` : null,
          t.worker,
        ].filter(Boolean).join(' ‚Ä¢ ');

        if (details) {
          const detailsEl = document.createElement('div');
          detailsEl.className = 'small text-muted';
          detailsEl.textContent = details;
          li.appendChild(detailsEl);
        }

        if (t.specialties) {
          const specialtiesEl = document.createElement('div');
          specialtiesEl.className = 'small text-muted';
          specialtiesEl.textContent = `Especialidades: ${t.specialties}`;
          li.appendChild(specialtiesEl);
        }

        if (t.address_summary) {
          const addressEl = document.createElement('div');
          addressEl.className = 'small text-muted';
          addressEl.textContent = t.address_summary;
          li.appendChild(addressEl);
        }

        li.onclick = () => window.location = `/ficha_tutor/${t.id}`;
        listaTutor.appendChild(li);
      });
      listaTutor.classList.remove('d-none');
    };

    inputTutor.addEventListener('input', async () => {
      const q = inputTutor.value.trim();
      if (q.length < 2) {
        listaTutor.classList.add('d-none');
        listaTutor.innerHTML = '';
        return;
      }

      try {
        const data = await carregarTutores(q);
        renderResultados(data);
      } catch (error) {
        console.error('N√£o foi poss√≠vel buscar tutores.', error);
        listaTutor.classList.add('d-none');
      }
    });

    if (filterContainer) {
      filterContainer.addEventListener('searchfilterchange', () => {
        const q = inputTutor.value.trim();
        if (q.length >= 2) {
          inputTutor.dispatchEvent(new Event('input'));
        }
      });
    }

    document.addEventListener('click', e => {
      if (!inputTutor.contains(e.target) && !listaTutor.contains(e.target)) {
        listaTutor.classList.add('d-none');
      }
    });
  }

  const novoTutorForm = document.getElementById('novo-tutor-form');
  if (novoTutorForm) {
    const requiredFields = ['name', 'email', 'cep', 'rua', 'cidade', 'estado'];
    const fieldLabels = {
      name: 'Nome',
      email: 'E-mail',
      cep: 'CEP',
      rua: 'Logradouro',
      cidade: 'Cidade',
      estado: 'Estado'
    };

    const showValidationMessage = (message) => {
      if (window.FormFeedback?.showStatus) {
        window.FormFeedback.showStatus(novoTutorForm, message, 'warning');
      } else {
        alert(message);
      }
    };

    const clearInvalidState = (field) => {
      field.classList.remove('is-invalid');
    };

    requiredFields.forEach((name) => {
      const field = novoTutorForm.querySelector(`[name="${name}"]`);
      if (field) {
        field.addEventListener('input', () => clearInvalidState(field));
        field.addEventListener('blur', () => {
          if (field.value.trim()) {
            clearInvalidState(field);
          }
        });
      }
    });

    novoTutorForm.addEventListener('submit', (event) => {
      let hasError = false;
      const missing = [];

      requiredFields.forEach((name) => {
        const field = novoTutorForm.querySelector(`[name="${name}"]`);
        if (!field) return;
        const value = field.value.trim();

        const isCep = name === 'cep';
        const isEmpty = !value;
        const invalidCep = isCep && value.replace(/\D/g, '').length !== 8;

        if (isEmpty || invalidCep) {
          field.classList.add('is-invalid');
          missing.push(fieldLabels[name] || name);
          hasError = true;
        }
      });

      const emailField = novoTutorForm.querySelector('[name="email"]');
      const emailValue = emailField ? emailField.value.trim() : '';
      if (emailField && emailValue && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) {
        emailField.classList.add('is-invalid');
        missing.push('E-mail v√°lido');
        hasError = true;
      }

      if (hasError) {
        event.preventDefault();
        event.stopPropagation();
        const message = missing.length
          ? `Preencha corretamente: ${missing.join(', ')}.`
          : 'Revise os campos obrigat√≥rios.';
        showValidationMessage(message);
        const firstInvalid = novoTutorForm.querySelector('.is-invalid');
        firstInvalid?.focus();
      }
    });
  }

  const dobInput = document.getElementById('date_of_birth');
  const ageInput = document.getElementById('age');

  if (dobInput && ageInput) {
    const atualizarIdade = (date) => {
      if (!date) {
        ageInput.value = '';
        return;
      }

      const hoje = new Date();
      let idade = hoje.getFullYear() - date.getFullYear();
      const mes = hoje.getMonth() - date.getMonth();
      if (mes < 0 || (mes === 0 && hoje.getDate() < date.getDate())) {
        idade--;
      }
      ageInput.value = Math.max(idade, 0);
    };

    const picker = flatpickr(dobInput, {
      locale: 'pt',
      dateFormat: 'Y-m-d',
      altInput: true,
      altFormat: 'd/m/Y',
      allowInput: true,
      onReady(selectedDates, dateStr, instance) {
        if (window.DateMaskUtils) {
          window.DateMaskUtils.syncMaskedInput(instance, {
            onDateSync: atualizarIdade,
            onClear: () => atualizarIdade(null),
          });
        }

        if (selectedDates.length) {
          atualizarIdade(selectedDates[0]);
        } else {
          atualizarIdade(null);
        }
      },
      onChange(selectedDates) {
        atualizarIdade(selectedDates[0] || null);
      }
    });

    ageInput.addEventListener('input', () => {
      const idade = parseInt(ageInput.value, 10);
      if (Number.isNaN(idade)) {
        if (ageInput.value.trim() === '') {
          picker.clear();
          atualizarIdade(null);
        }
        return;
      }

      const hoje = new Date();
      const dataEstimativa = new Date(hoje.getFullYear() - idade, hoje.getMonth(), hoje.getDate());
      picker.setDate(dataEstimativa, true);
    });
  }
</script>
