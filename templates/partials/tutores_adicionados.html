<div class="container d-flex justify-content-center my-5">
  <div style="width: 100%; max-width: 700px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">ðŸ‘¥ Tutores</h4>
      {% if scope is defined %}
      <div class="btn-group btn-group-sm">
        <a href="{{ url_for('tutores', scope='all') }}" class="btn btn-outline-primary {% if scope != 'mine' %}active{% endif %}">Todos</a>
        <a href="{{ url_for('tutores', scope='mine') }}" class="btn btn-outline-primary {% if scope == 'mine' %}active{% endif %}">Meus</a>
      </div>
      {% endif %}
    </div>
    <div class="row mb-3">
      <div class="col-md-8">
        <input type="text" id="tutor-filter" class="form-control" placeholder="Buscar por nome, CPF, telefone...">
      </div>
      <div class="col-md-4">
        <select id="tutor-sort" class="form-select">
          <option value="name_asc">Nome (A-Z)</option>
          <option value="name_desc">Nome (Z-A)</option>
          <option value="date_desc">Data (recentes)</option>
          <option value="date_asc">Data (antigos)</option>
          <option value="age_desc">Idade (maior)</option>
          <option value="age_asc">Idade (menor)</option>
        </select>
      </div>
    </div>
    <div id="tutor-cards" class="row g-3">
      {% if pagination and pagination.items %}
        {% for tutor in pagination.items %}
        <div class="col-md-6 d-flex" data-name="{{ tutor.name|lower }}" data-date="{{ tutor.created_at.isoformat() if tutor.created_at else '' }}" data-cpf="{{ tutor.cpf or '' }}" data-phone="{{ tutor.phone or '' }}" {% if tutor.date_of_birth %}data-dob="{{ tutor.date_of_birth.isoformat() }}"{% endif %}>
<div class="card shadow-sm rounded-4 h-100 flex-fill position-relative">
  {% if tutor.worker|lower == 'veterinario' %}
    <span class="badge bg-success position-absolute top-0 end-0 m-2">VeterinÃ¡rio</span>
  {% endif %}
            <div class="card-body d-flex flex-column justify-content-between">
              <div>
                <h5 class="card-title">{{ tutor.name }}</h5>
                <p class="mb-1"><strong>Email:</strong> {{ tutor.email }}</p>
                {% if tutor.cpf %}
                  <p class="mb-1"><strong>CPF:</strong> {{ tutor.cpf }}</p>
                {% endif %}
                {% if tutor.worker|lower == 'veterinario' and tutor.veterinario.specialties %}
                  <p class="mb-1"><strong>Especialidades:</strong> {{ tutor.veterinario.specialty_list }}</p>
                {% endif %}
              </div>
              <div class="d-flex flex-wrap gap-2 mt-3">
                <a href="{{ url_for('ficha_tutor', tutor_id=tutor.id) }}" class="btn btn-sm btn-outline-dark w-100">
                  ðŸ“‹ Ver Ficha
                </a>
                {% if tutor.worker|lower == 'veterinario' %}
                <a href="{{ url_for('edit_vet_specialties', veterinario_id=tutor.veterinario.id) }}" class="btn btn-sm btn-outline-primary w-100">
                  ðŸ©º Especialidades
                </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="text-center text-muted mt-4">
          Nenhum tutor associado Ã  clÃ­nica ainda.
        </div>
      {% endif %}
    </div>

    <!-- PaginaÃ§Ã£o -->
    {% if pagination and pagination.pages > 1 %}
    <div class="d-flex justify-content-center mt-4">
      <nav>
        <ul class="pagination">
          {% if pagination.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('tutores', page=pagination.prev_num, scope=scope) }}">Anterior</a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">Anterior</span></li>
          {% endif %}

          {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
              {% if page_num == pagination.page %}
                <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('tutores', page=page_num, scope=scope) }}">{{ page_num }}</a></li>
              {% endif %}
            {% else %}
              <li class="page-item disabled"><span class="page-link">â€¦</span></li>
            {% endif %}
          {% endfor %}

          {% if pagination.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('tutores', page=pagination.next_num, scope=scope) }}">PrÃ³xima</a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">PrÃ³xima</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterInput = document.getElementById('tutor-filter');
  const sortSelect = document.getElementById('tutor-sort');
  const container = document.getElementById('tutor-cards');
  const cards = Array.from(container.querySelectorAll('[data-name]'));

  function getAge(card) {
    if (!card.dataset.dob) return 0;
    const diff = Date.now() - new Date(card.dataset.dob).getTime();
    return Math.floor(diff / (365.25 * 24 * 60 * 60 * 1000));
    }

  function applyFilter() {
    const term = filterInput.value.toLowerCase();
    cards.forEach(card => {
      const text = card.textContent.toLowerCase();
      const cpf = (card.dataset.cpf || '').toLowerCase();
      const phone = (card.dataset.phone || '').toLowerCase();
      card.style.display = (text.includes(term) || cpf.includes(term) || phone.includes(term)) ? '' : 'none';
    });
  }

  function applySort() {
    const value = sortSelect.value;
    const visible = cards.filter(card => card.style.display !== 'none');
    const hidden = cards.filter(card => card.style.display === 'none');
    visible.sort((a, b) => {
      switch (value) {
        case 'name_desc':
          return b.dataset.name.localeCompare(a.dataset.name);
        case 'date_asc':
          return new Date(a.dataset.date) - new Date(b.dataset.date);
        case 'date_desc':
          return new Date(b.dataset.date) - new Date(a.dataset.date);
        case 'age_asc':
          return getAge(a) - getAge(b);
        case 'age_desc':
          return getAge(b) - getAge(a);
        case 'name_asc':
        default:
          return a.dataset.name.localeCompare(b.dataset.name);
      }
    });
    visible.forEach(card => container.appendChild(card));
    hidden.forEach(card => container.appendChild(card));
  }

  filterInput.addEventListener('input', () => { applyFilter(); applySort(); });
  sortSelect.addEventListener('change', applySort);
  applySort();
});
</script>
