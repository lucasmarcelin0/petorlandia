{% set compact = compact|default(False) %}
{% set card_block %}
<div class="card shadow-sm border-0 rounded-4 h-100 d-flex flex-column">
  <div class="card-header bg-white border-0 pb-0">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <h4 class="mb-1">ðŸ‘¥ Tutores</h4>
        <p class="text-muted small mb-0">Filtre, ordene e acesse os tutores da clÃ­nica com rapidez.</p>
      </div>
      {% if scope is defined %}
      <div class="btn-group btn-group-sm">
        <a href="{{ url_for('tutores', scope='all') }}" class="btn btn-outline-primary {% if scope != 'mine' %}active{% endif %}">Todos</a>
        <a href="{{ url_for('tutores', scope='mine') }}" class="btn btn-outline-primary {% if scope == 'mine' %}active{% endif %}">Meus</a>
      </div>
      {% endif %}
    </div>
  </div>
  <div class="card-body p-4 flex-grow-1 d-flex flex-column">
    <div class="row g-3 align-items-end mb-4">
      <div class="col-12 col-lg-7">
        <label for="tutor-filter" class="form-label small text-muted mb-1">Buscar</label>
        <input type="text" id="tutor-filter" class="form-control" placeholder="Buscar por nome, CPF, telefone...">
      </div>
      <div class="col-12 col-lg-5">
        <label for="tutor-sort" class="form-label small text-muted mb-1">Ordenar por</label>
        <select id="tutor-sort" class="form-select">
          <option value="name_asc">Nome (A-Z)</option>
          <option value="name_desc">Nome (Z-A)</option>
          <option value="date_desc">Data (recentes)</option>
          <option value="date_asc">Data (antigos)</option>
          <option value="age_desc">Idade (maior)</option>
          <option value="age_asc">Idade (menor)</option>
        </select>
      </div>
    </div>
    <div id="tutor-cards" class="row g-3 flex-grow-1">
      {% if tutores_adicionados %}
        {% for tutor in tutores_adicionados %}
        <div class="col-md-6 d-flex" data-name="{{ tutor.name|lower }}" data-date="{{ tutor.created_at.isoformat() if tutor.created_at else '' }}" data-cpf="{{ tutor.cpf or '' }}" data-phone="{{ tutor.phone or '' }}" {% if tutor.date_of_birth %}data-dob="{{ tutor.date_of_birth.isoformat() }}"{% endif %}>
          <div class="card shadow-sm rounded-4 h-100 flex-fill position-relative border-0">
            {% if tutor.worker|lower == 'veterinario' %}
            <span class="badge bg-success position-absolute top-0 end-0 m-2">VeterinÃ¡rio</span>
            {% endif %}
            <div class="card-body d-flex flex-column justify-content-between">
              <div class="mb-3">
                <h5 class="card-title mb-1">{{ tutor.name }}</h5>
                <p class="mb-1"><strong>Email:</strong> {{ tutor.email }}</p>
                {% if tutor.cpf %}
                <p class="mb-1"><strong>CPF:</strong> {{ tutor.cpf }}</p>
                {% endif %}
                {% if tutor.worker|lower == 'veterinario' and tutor.veterinario.specialties %}
                <p class="mb-0"><strong>Especialidades:</strong> {{ tutor.veterinario.specialty_list }}</p>
                {% endif %}
              </div>
              <div class="d-flex flex-wrap gap-2">
                <a href="{{ url_for('ficha_tutor', tutor_id=tutor.id) }}" class="btn btn-sm btn-outline-dark flex-fill">ðŸ“‹ Ver Ficha</a>
                {% if tutor.worker|lower == 'veterinario' %}
                <a href="{{ url_for('edit_vet_specialties', veterinario_id=tutor.veterinario.id) }}" class="btn btn-sm btn-outline-primary flex-fill">ðŸ©º Especialidades</a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
      <div class="col-12">
        <div class="text-center text-muted py-5 border rounded-4" style="border-style: dashed;">
          Nenhum tutor associado Ã  clÃ­nica ainda.
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% if pagination and pagination.pages > 1 %}
  <div class="card-footer bg-white border-0 pt-0">
    <div class="d-flex justify-content-center">
      <nav>
        <ul class="pagination mb-0">
          {% if pagination.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('tutores', page=pagination.prev_num, scope=scope) }}">Anterior</a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">Anterior</span></li>
          {% endif %}

          {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
              {% if page_num == pagination.page %}
                <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('tutores', page=page_num, scope=scope) }}">{{ page_num }}</a></li>
              {% endif %}
            {% else %}
              <li class="page-item disabled"><span class="page-link">â€¦</span></li>
            {% endif %}
          {% endfor %}

          {% if pagination.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('tutores', page=pagination.next_num, scope=scope) }}">PrÃ³xima</a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">PrÃ³xima</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
  {% endif %}
</div>
{% endset %}

{% if compact %}
  {{ card_block }}
{% else %}
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
      {{ card_block }}
    </div>
  </div>
</div>
{% endif %}

<script>
(function() {
  const filterInput = document.getElementById('tutor-filter');
  const sortSelect = document.getElementById('tutor-sort');
  const container = document.getElementById('tutor-cards');

  if (!filterInput || !sortSelect || !container) {
    return;
  }

  const cards = Array.from(container.querySelectorAll('[data-name]'));
  const sortStorageKey = 'tutorSortPreference';
  const filterStorageKey = 'tutorFilterPreference';

  const savedFilter = localStorage.getItem(filterStorageKey);
  if (savedFilter !== null) {
    filterInput.value = savedFilter;
  }

  const savedSort = localStorage.getItem(sortStorageKey);
  if (savedSort && Array.from(sortSelect.options).some(option => option.value === savedSort)) {
    sortSelect.value = savedSort;
  }

  function getAge(card) {
    if (!card.dataset.dob) return 0;
    const diff = Date.now() - new Date(card.dataset.dob).getTime();
    return Math.floor(diff / (365.25 * 24 * 60 * 60 * 1000));
  }

  function applyFilter() {
    const term = filterInput.value.toLowerCase();
    cards.forEach(card => {
      const text = card.textContent.toLowerCase();
      const cpf = (card.dataset.cpf || '').toLowerCase();
      const phone = (card.dataset.phone || '').toLowerCase();
      card.style.display = (text.includes(term) || cpf.includes(term) || phone.includes(term)) ? '' : 'none';
    });
  }

  function applySort() {
    const value = sortSelect.value;
    const visible = cards.filter(card => card.style.display !== 'none');
    const hidden = cards.filter(card => card.style.display === 'none');
    visible.sort((a, b) => {
      switch (value) {
        case 'name_desc':
          return b.dataset.name.localeCompare(a.dataset.name);
        case 'date_asc':
          return new Date(a.dataset.date) - new Date(b.dataset.date);
        case 'date_desc':
          return new Date(b.dataset.date) - new Date(a.dataset.date);
        case 'age_asc':
          return getAge(a) - getAge(b);
        case 'age_desc':
          return getAge(b) - getAge(a);
        case 'name_asc':
        default:
          return a.dataset.name.localeCompare(b.dataset.name);
      }
    });
    visible.forEach(card => container.appendChild(card));
    hidden.forEach(card => container.appendChild(card));
  }

  filterInput.addEventListener('input', () => {
    localStorage.setItem(filterStorageKey, filterInput.value);
    applyFilter();
    applySort();
  });

  sortSelect.addEventListener('change', () => {
    localStorage.setItem(sortStorageKey, sortSelect.value);
    applySort();
  });

  applyFilter();
  applySort();
})();
</script>
