<form>
    <div id="feedback-vacinas" class="alert d-none position-fixed" style="top: 20px; right: 20px; z-index: 1000;"></div>
    <h5 class="mb-3">💉 Registro de Vacinas</h5>

    <!-- Botão para cadastrar nova vacina -->
    <button type="button" class="btn btn-outline-primary mb-3" onclick="toggleNovaVacina()">➕ Nova vacina</button>
    <div id="nova-vacina-container" class="border rounded p-3 mb-3 bg-light d-none">
      <div class="mb-2 position-relative">
        <label for="buscar-vacina-nova" class="form-label">Pesquisar vacina existente</label>
        <input type="text" id="buscar-vacina-nova" class="form-control" placeholder="Digite para buscar..." autocomplete="off">
        <ul id="sugestoes-busca-vacina" class="list-group position-absolute w-100" style="z-index:10; max-height:300px; overflow-y:auto; display:none;"></ul>
      </div>
      <div class="mb-2">
        <label for="nova-vacina-nome" class="form-label">Nome da vacina</label>
        <input type="text" id="nova-vacina-nome" class="form-control" placeholder="Ex: Antirrábica">
      </div>
      <div class="mb-2">
        <label for="nova-vacina-tipo" class="form-label">Tipo</label>
        <input type="text" id="nova-vacina-tipo" class="form-control" placeholder="Campanha, Reforço...">
      </div>
      <div class="row mb-2">
        <div class="col-md-3">
          <label for="nova-vacina-fabricante" class="form-label">Fabricante</label>
          <input type="text" id="nova-vacina-fabricante" class="form-control">
        </div>
        <div class="col-md-3">
          <label for="nova-vacina-doses" class="form-label">Doses Totais</label>
          <input type="number" id="nova-vacina-doses" class="form-control">
        </div>
        <div class="col-md-3">
          <label for="nova-vacina-intervalo" class="form-label">Intervalo (dias)</label>
          <input type="number" id="nova-vacina-intervalo" class="form-control">
        </div>
        <div class="col-md-3">
          <label for="nova-vacina-frequencia" class="form-label">Frequência</label>
          <input type="text" id="nova-vacina-frequencia" class="form-control">
        </div>
      </div>
      <div class="mt-3">
        <button type="button" id="btn-salvar-vacina" class="btn btn-primary me-2" onclick="salvarVacinaModelo()">💾 Salvar Vacina</button>
        <button type="button" id="btn-editar-vacina" class="btn btn-success me-2 d-none" onclick="salvarVacinaModelo()">✏️ Editar</button>
        <button type="button" id="btn-excluir-vacina" class="btn btn-outline-danger d-none" onclick="excluirVacinaModelo()">🗑️ Excluir</button>
      </div>
    </div>

    <!-- Campo com autocomplete -->
    <div class="mb-3 position-relative">
      <label for="nome-vacina" class="form-label">Vacina</label>
      <input type="text" id="nome-vacina" class="form-control" placeholder="Ex: Antirrábica, V10, V8..." autocomplete="off">
      <input type="hidden" id="vacina-id">
      <ul id="sugestoes-vacinas" class="list-group position-absolute w-100 bg-white shadow border rounded mt-1" style="z-index: 1050;"></ul>
    </div>

    <!-- Tipo e data -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="tipo-vacina" class="form-label">Tipo</label>
        <select id="tipo-vacina" class="form-select">
          <option value="">Selecione...</option>
          <option value="Campanha">Campanha</option>
          <option value="Reforço">Reforço</option>
          <option value="Obrigatória">Obrigatória</option>
          <option value="Opcional">Opcional</option>
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="aplicada-vacina">
          <label class="form-check-label" for="aplicada-vacina">Aplicada?</label>
        </div>
      </div>
      <div class="col-md-4">
        <label for="aplicada-em" class="form-label">Data da Aplicação</label>
        <input type="date" id="aplicada-em" class="form-control" disabled>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-3">
        <label for="fabricante-vacina" class="form-label">Fabricante</label>
        <input type="text" id="fabricante-vacina" class="form-control">
      </div>
      <div class="col-md-3">
        <label for="doses-vacina" class="form-label">Doses Totais</label>
        <input type="number" id="doses-vacina" class="form-control">
      </div>
      <div class="col-md-3">
        <label for="intervalo-vacina" class="form-label">Intervalo (dias)</label>
        <input type="number" id="intervalo-vacina" class="form-control">
      </div>
      <div class="col-md-3">
        <label for="frequencia-vacina" class="form-label">Frequência</label>
        <input type="text" id="frequencia-vacina" class="form-control">
      </div>
    </div>

    <!-- Botão de adicionar -->
    <button type="button" class="btn btn-success mb-4" onclick="adicionarVacina()">➕ Adicionar Vacina</button>

    <!-- Lista temporária -->
    <div id="vacinas-lista" class="mb-4"></div>

    <!-- Observações -->
    <div class="mb-3">
      <label for="observacoes-vacinas" class="form-label">Observações Gerais</label>
      <textarea id="observacoes-vacinas" class="form-control" rows="3"></textarea>
    </div>

    <!-- Finalizar -->
    <button type="button" class="btn btn-primary mt-2" id="btn-finalizar-vacinas" onclick="finalizarBlocoVacinas()">💾 Finalizar Aplicações</button>
  </form>

  <!-- Histórico -->
  <div id="historico-vacinas" class="mt-5">
    {% include 'partials/historico_vacinas.html' %}
  </div>

  <script>
    let vacinas = [];
    let inputVacina, sugestoesVacinas, vacinaSelecionada = null;
    let buscaVacinaInput, sugestoesBuscaVacina;
    let aplicadaCheckbox, aplicadaEmInput;
    function mostrarFeedback(msg, tipo = 'success') {
      const fb = document.getElementById('feedback-vacinas');
      fb.textContent = msg;
      fb.className = `alert alert-${tipo} d-block`;
      setTimeout(() => fb.classList.add('d-none'), 3000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      inputVacina = document.getElementById('nome-vacina');
      sugestoesVacinas = document.getElementById('sugestoes-vacinas');
      buscaVacinaInput = document.getElementById('buscar-vacina-nova');
      sugestoesBuscaVacina = document.getElementById('sugestoes-busca-vacina');
      aplicadaCheckbox = document.getElementById('aplicada-vacina');
      aplicadaEmInput = document.getElementById('aplicada-em');

      aplicadaCheckbox.addEventListener('change', () => {
        aplicadaEmInput.disabled = !aplicadaCheckbox.checked;
        if (!aplicadaCheckbox.checked) aplicadaEmInput.value = '';
      });

      inputVacina.addEventListener('input', function () {
        const q = this.value.trim();
        console.log("🟡 Buscando vacina:", q);

        if (q.length < 2) {
          sugestoesVacinas.innerHTML = '';
          return;
        }

        fetch(`/buscar_vacinas?q=${encodeURIComponent(q)}`)
          .then(res => res.json())
          .then(data => {
            console.log("🟢 Resultados:", data);
            sugestoesVacinas.innerHTML = '';

            if (!data.length) {
              sugestoesVacinas.innerHTML = '<li class="list-group-item text-muted">Nenhuma vacina encontrada</li>';
              return;
            }

              data.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item list-group-item-action';
                li.textContent = item.nome;
                li.onclick = () => {
                  document.getElementById('vacina-id').value = item.id || '';
                  inputVacina.value = item.nome;
                  document.getElementById('tipo-vacina').value = item.tipo || '';
                  document.getElementById('fabricante-vacina').value = item.fabricante || '';
                  document.getElementById('doses-vacina').value = item.doses_totais || '';
                  document.getElementById('intervalo-vacina').value = item.intervalo_dias || '';
                  document.getElementById('frequencia-vacina').value = item.frequencia || '';
                  sugestoesVacinas.innerHTML = '';
                };
                sugestoesVacinas.appendChild(li);
              });
          })
          .catch(err => {
            console.error("❌ Erro no autocomplete:", err);
          });
      });

      // Fecha sugestões ao clicar fora
      document.addEventListener('click', e => {
        if (!sugestoesVacinas.contains(e.target) && e.target !== inputVacina) {
          sugestoesVacinas.innerHTML = '';
        }
        if (!sugestoesBuscaVacina.contains(e.target) && e.target !== buscaVacinaInput) {
          sugestoesBuscaVacina.style.display = 'none';
        }
      });

      buscaVacinaInput.addEventListener('input', () => {
        const q = buscaVacinaInput.value.trim();
        if (q.length < 2) {
          sugestoesBuscaVacina.innerHTML = '';
          sugestoesBuscaVacina.style.display = 'none';
          return;
        }
        fetch(`/buscar_vacinas?q=${encodeURIComponent(q)}`)
          .then(r => r.json())
          .then(data => {
            sugestoesBuscaVacina.innerHTML = '';
            if (!data.length) {
              sugestoesBuscaVacina.innerHTML = '<li class="list-group-item text-muted">Nenhuma vacina encontrada</li>';
              sugestoesBuscaVacina.style.display = 'block';
              return;
            }
            data.forEach(v => {
              const li = document.createElement('li');
              li.className = 'list-group-item list-group-item-action';
              li.textContent = v.nome;
              li.onclick = () => openVacinaCard(v);
              sugestoesBuscaVacina.appendChild(li);
            });
            sugestoesBuscaVacina.style.display = 'block';
          })
          .catch(err => console.error('Erro busca vacina modelo:', err));
      });

      renderVacinasTemp();
    });

    function toggleNovaVacina() {
      const box = document.getElementById('nova-vacina-container');
      if (box.classList.contains('d-none')) {
        openVacinaCard(null);
      } else {
        box.classList.add('d-none');
      }
    }

    function openVacinaCard(vac) {
      const box = document.getElementById('nova-vacina-container');
      box.classList.remove('d-none');
      sugestoesBuscaVacina.innerHTML = '';
      sugestoesBuscaVacina.style.display = 'none';
      buscaVacinaInput.value = vac?.nome || '';
      document.getElementById('nova-vacina-nome').value = vac?.nome || '';
      document.getElementById('nova-vacina-tipo').value = vac?.tipo || '';
      document.getElementById('nova-vacina-fabricante').value = vac?.fabricante || '';
      document.getElementById('nova-vacina-doses').value = vac?.doses_totais || '';
      document.getElementById('nova-vacina-intervalo').value = vac?.intervalo_dias || '';
      document.getElementById('nova-vacina-frequencia').value = vac?.frequencia || '';
      vacinaSelecionada = vac?.id ? vac : null;
      document.getElementById('btn-salvar-vacina').classList.toggle('d-none', !!vacinaSelecionada);
      document.getElementById('btn-editar-vacina').classList.toggle('d-none', !vacinaSelecionada);
      document.getElementById('btn-excluir-vacina').classList.toggle('d-none', !vacinaSelecionada);
    }

    async function salvarVacinaModelo() {
      const nome = document.getElementById('nova-vacina-nome').value.trim();
      const tipo = document.getElementById('nova-vacina-tipo').value.trim();
      const fabricante = document.getElementById('nova-vacina-fabricante').value.trim();
      const doses_totais = document.getElementById('nova-vacina-doses').value;
      const intervalo_dias = document.getElementById('nova-vacina-intervalo').value;
      const frequencia = document.getElementById('nova-vacina-frequencia').value.trim();
      if (!nome || !tipo) {
        mostrarFeedback('Preencha nome e tipo da vacina.', 'warning');
        return;
      }
      const payload = { nome, tipo, fabricante, doses_totais: doses_totais || null, intervalo_dias: intervalo_dias || null, frequencia };
      const url = vacinaSelecionada ? `/vacina_modelo/${vacinaSelecionada.id}` : '/vacina_modelo';
      const method = vacinaSelecionada ? 'PUT' : 'POST';
      try {
        const resp = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data.success) {
          mostrarFeedback(vacinaSelecionada ? 'Vacina atualizada!' : 'Vacina cadastrada com sucesso!');
          openVacinaCard(null);
          document.getElementById('nova-vacina-container').classList.add('d-none');
        } else {
          mostrarFeedback(data.message || 'Erro ao salvar vacina.', 'danger');
        }
      } catch (err) {
        console.error('❌ Erro ao salvar vacina modelo:', err);
        mostrarFeedback('Erro ao salvar vacina.', 'danger');
      }
    }

    async function excluirVacinaModelo() {
      if (!vacinaSelecionada) return;
      if (!confirm('Deseja excluir este modelo?')) return;
      try {
        const resp = await fetch(`/vacina_modelo/${vacinaSelecionada.id}`, { method: 'DELETE' });
        const data = await resp.json();
        if (data.success) {
          mostrarFeedback('Vacina excluída.');
          openVacinaCard(null);
          document.getElementById('nova-vacina-container').classList.add('d-none');
        } else {
          mostrarFeedback(data.message || 'Erro ao excluir vacina.', 'danger');
        }
      } catch (err) {
        console.error('Erro ao excluir vacina:', err);
        mostrarFeedback('Erro ao excluir vacina.', 'danger');
      }
    }

    function adicionarVacina() {
      const nome = document.getElementById('nome-vacina').value.trim();
      const tipo = document.getElementById('tipo-vacina').value.trim();
      const aplicada = document.getElementById('aplicada-vacina').checked;
      const aplicada_em = document.getElementById('aplicada-em').value;
      const fabricante = document.getElementById('fabricante-vacina').value.trim();
      const doses_totais = parseInt(document.getElementById('doses-vacina').value) || 1;
      const intervalo_dias = parseInt(document.getElementById('intervalo-vacina').value) || 0;
      const frequencia = document.getElementById('frequencia-vacina').value.trim();

      if (!nome || !tipo || (aplicada && !aplicada_em)) {
        alert('Preencha todos os campos obrigatórios.');
        return;
      }

      const base = { nome, tipo, fabricante, doses_totais, intervalo_dias, frequencia, aplicada };
      if (aplicada && aplicada_em) {
        const primeiraData = new Date(aplicada_em);
        for (let i = 0; i < doses_totais; i++) {
          const d = new Date(primeiraData);
          d.setDate(d.getDate() + i * intervalo_dias);
          const dataStr = d.toISOString().split('T')[0];
          vacinas.push({ ...base, aplicada_em: dataStr, dose_numero: i + 1 });
        }
      } else {
        vacinas.push({ ...base, aplicada_em: null, dose_numero: 1 });
      }
      renderVacinasTemp();

      document.getElementById('nome-vacina').value = '';
      document.getElementById('tipo-vacina').value = '';
      document.getElementById('aplicada-vacina').checked = false;
      document.getElementById('aplicada-em').value = '';
      document.getElementById('aplicada-em').disabled = true;
      document.getElementById('fabricante-vacina').value = '';
      document.getElementById('doses-vacina').value = '';
      document.getElementById('intervalo-vacina').value = '';
      document.getElementById('frequencia-vacina').value = '';
    }

    function removerVacina(index) {
      vacinas.splice(index, 1);
      renderVacinasTemp();
    }

    function renderVacinasTemp() {
      const lista = document.getElementById('vacinas-lista');
      lista.innerHTML = '';

      vacinas.forEach((v, i) => {
        const div = document.createElement('div');
        div.className = 'border p-2 mb-2 bg-light rounded shadow-sm';
        div.innerHTML = `
          💉 <strong>${v.nome}</strong> — ${v.tipo} ${v.aplicada ? `em ${v.aplicada_em}` : '(não aplicada)'}
          ${v.fabricante ? ` - ${v.fabricante}` : ''}
          ${v.doses_totais ? ` - dose ${v.dose_numero}/${v.doses_totais}` : ''}
          ${v.intervalo_dias ? ` - intervalo ${v.intervalo_dias}d` : ''}
          ${v.frequencia ? ` - ${v.frequencia}` : ''}
          <button class="btn btn-sm btn-danger ms-2" onclick="removerVacina(${i})">🗑️ Remover</button>
        `;
        lista.appendChild(div);
      });
    }

    async function finalizarBlocoVacinas() {
      const obs = document.getElementById('observacoes-vacinas').value.trim();

      if (vacinas.length === 0) {
        mostrarFeedback('Adicione pelo menos uma vacina.', 'warning');
        return;
      }
      const btn = document.getElementById('btn-finalizar-vacinas');
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Salvando...';

      const resp = await fetchOrQueue(`/animal/{{ animal.id }}/vacinas`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({
          vacinas,
          observacoes_gerais: obs
        })
      });
      if (resp) {
        const data = await resp.json();
        if (data.success) {
          mostrarFeedback('Vacinas registradas com sucesso!');
          if (data.html) {
            document.getElementById('historico-vacinas').innerHTML = data.html;
          }
          vacinas = [];
          renderVacinasTemp();
        } else {
          mostrarFeedback('Erro ao salvar vacinas.', 'danger');
        }
      } else {
        // Offline: registra localmente sem exibir aviso
        vacinas = [];
        renderVacinasTemp();
      }

      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  </script>
