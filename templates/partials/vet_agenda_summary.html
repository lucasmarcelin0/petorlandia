{% set vet_name = veterinario.user.name if veterinario.user else veterinario.name %}
{% set period_start = start_dt %}
{% set period_finish = period_end if period_end is defined and period_end else (end_dt - timedelta(days=1) if end_dt else None) %}
{% set kind_labels = {
  'consulta': 'Consulta',
  'retorno': 'Retorno',
  'exame': 'Exame',
  'banho_tosa': 'Banho e tosa',
  'vacina': 'Vacina'
} %}
<div class="card border-0 shadow-sm">
  <div class="card-header bg-white border-0 pb-2">
    <h5 class="mb-1 fw-semibold">
      <i class="bi bi-calendar-check me-2"></i>Minha agenda
    </h5>
    <div class="text-muted small">
      {{ vet_name or 'Veterinário' }}
      {% if period_start %}
        · {{ period_start|format_datetime_brazil('%d/%m/%Y') }}
        {% if period_finish %}
          – {{ period_finish|format_datetime_brazil('%d/%m/%Y') }}
        {% endif %}
      {% endif %}
    </div>
  </div>
  <div class="card-body pt-0">
    <section class="mb-4">
      <h6 class="fw-semibold text-primary">Agendamentos pendentes</h6>
      <ul class="list-group list-group-flush">
        {% for item in appointments_pending %}
          {% set appt = item.appt %}
          {% set animal_name = appt.animal.name if appt.animal else 'Animal não informado' %}
          {% if item.kind == 'exame' %}
            {% set owner_name = appt.animal.owner.name if appt.animal and appt.animal.owner else None %}
          {% else %}
            {% set owner_name = appt.tutor.name if appt.tutor else (appt.animal.owner.name if appt.animal and appt.animal.owner else None) %}
          {% endif %}
          <li class="list-group-item px-0">
            <div class="d-flex flex-column">
              <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="fw-semibold">{{ appt.scheduled_at|format_datetime_brazil('%d/%m/%Y %H:%M') }}</span>
                <span class="badge bg-primary-subtle text-primary">{{ kind_labels.get(item.kind, item.kind|capitalize) }}</span>
              </div>
              <div class="text-muted small mt-1">
                {{ animal_name }}{% if owner_name %} · Tutor: {{ owner_name }}{% endif %}
              </div>
              {% if appt.time_left is defined %}
              <div class="text-muted small mt-1">
                Tempo para responder: {{ appt.time_left|format_timedelta }}
              </div>
              {% endif %}
            </div>
          </li>
        {% else %}
          <li class="list-group-item px-0 text-muted small">Nenhum agendamento pendente.</li>
        {% endfor %}
      </ul>
    </section>

    <section class="mb-4">
      <h6 class="fw-semibold text-primary">Próximos compromissos</h6>
      <ul class="list-group list-group-flush">
        {% for item in appointments_upcoming %}
          {% set appt = item.appt %}
          {% set animal_name = appt.animal.name if appt.animal else 'Animal não informado' %}
          {% if item.kind == 'exame' %}
            {% set owner_name = appt.animal.owner.name if appt.animal and appt.animal.owner else None %}
          {% else %}
            {% set owner_name = appt.tutor.name if appt.tutor else (appt.animal.owner.name if appt.animal and appt.animal.owner else None) %}
          {% endif %}
          <li class="list-group-item px-0">
            <div class="d-flex flex-column">
              <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="fw-semibold">{{ appt.scheduled_at|format_datetime_brazil('%d/%m/%Y %H:%M') }}</span>
                <span class="badge bg-secondary-subtle text-secondary">{{ kind_labels.get(item.kind, item.kind|capitalize) }}</span>
              </div>
              <div class="text-muted small mt-1">
                {{ animal_name }}{% if owner_name %} · Tutor: {{ owner_name }}{% endif %}
              </div>
              {% if appt.notes %}
              <div class="text-muted small mt-1">Observações: {{ appt.notes }}</div>
              {% endif %}
            </div>
          </li>
        {% else %}
          <li class="list-group-item px-0 text-muted small">Nenhum compromisso futuro registrado.</li>
        {% endfor %}
      </ul>
    </section>

    {% if schedule_events %}
    <section>
      <h6 class="fw-semibold text-primary">Atividades recentes</h6>
      <ul class="list-unstyled mb-0">
        {% for event in schedule_events[:6] %}
          {% set event_label_map = {
            'consulta_finalizada': 'Consulta finalizada',
            'consulta_aceita': 'Consulta aceita',
            'retorno': 'Retorno programado',
            'exame': 'Exame agendado'
          } %}
          <li class="mb-2">
            <div class="fw-semibold">{{ event.timestamp|format_datetime_brazil('%d/%m/%Y %H:%M') if event.timestamp else 'Data não informada' }}</div>
            <div class="text-muted small">
              {{ event_label_map.get(event.kind, event.kind|replace('_', ' ')|capitalize) }}
              {% if event.animal %} · {{ event.animal.name }}{% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}
  </div>
</div>
