{% extends "layout.html" %}

{% block main %}
<div class="container py-4">

  <!-- Cabe√ßalho do Perfil -->
  <div class="card shadow rounded-4 p-4 mb-5 border-0">
    <form method="POST" enctype="multipart/form-data">
      {{ form.hidden_tag() }}
      <div class="row g-4 align-items-center">

        <!-- Foto -->
        <div class="col-md-4 text-center">
          {% if current_user.profile_photo %}
            <div id="photo-container" class="img-thumbnail shadow-sm mb-2 position-relative overflow-hidden" style="width: 240px; height: 240px; border-radius: 1rem;">
              <img id="profile-photo-img" src="{{ current_user.profile_photo }}" style="width:100%; height:100%; object-fit: cover; cursor: move; transform: translate({{ current_user.photo_offset_x or 0 }}px, {{ current_user.photo_offset_y or 0 }}px) rotate({{ current_user.photo_rotation or 0 }}deg) scale({{ current_user.photo_zoom or 1 }});" alt="Foto de {{ current_user.name }}">
            </div>
          {% else %}
            <div class="bg-light border d-flex align-items-center justify-content-center mb-2" style="width: 240px; height: 240px; border-radius: 1rem; font-size: 1.2rem; color: #555;">
              Sem Foto
            </div>
          {% endif %}

          <div id="campo-upload-foto" class="mt-2 d-none">
            {{ form.profile_photo(class="form-control form-control-sm", id="profile_photo") }}
            <div class="d-flex justify-content-center gap-2 my-2">
              <button type="button" id="rotate-left" class="btn btn-outline-secondary btn-sm" title="Girar 90¬∞ √† esquerda">
                <i class="fas fa-undo"></i>
              </button>
              <button type="button" id="rotate-right" class="btn btn-outline-secondary btn-sm" title="Girar 90¬∞ √† direita">
                <i class="fas fa-redo"></i>
              </button>
              <button type="button" id="zoom-out" class="btn btn-outline-secondary btn-sm" title="Diminuir zoom">-</button>
              <button type="button" id="zoom-in" class="btn btn-outline-secondary btn-sm" title="Aumentar zoom">+</button>
            </div>
            {{ form.photo_rotation(class="d-none", id="photo_rotation") }}
            {{ form.photo_zoom(class="d-none", id="photo_zoom") }}
            {{ form.photo_offset_x(class="d-none", id="photo_offset_x") }}
            {{ form.photo_offset_y(class="d-none", id="photo_offset_y") }}
          </div>
        </div>

        <!-- Informa√ß√µes -->
        <div class="col-md-8">
          <h4 class="mb-4"><i class="bi bi-person-circle me-2"></i> Meu Perfil</h4>

          {% macro field_row(label, field, field_name, value) %}
          <div class="mb-3">
            <label class="form-label">{{ label }}</label>
            <div class="d-flex align-items-center">
              <span id="{{ field_name }}-display" class="me-2 text-muted">
                {{ value if value else '---' }}
              </span>
              {% if value %}
                <span class="text-success">‚úÖ</span>
              {% else %}
                <span class="text-danger">‚ö†Ô∏è</span>
              {% endif %}
            </div>
            {{ field(class="form-control d-none mt-2", id=field_name ~ '-input') }}
          </div>
          {% endmacro %}

          {{ field_row('Nome', form.name, 'name', current_user.name) }}
          {{ field_row('Email', form.email, 'email', current_user.email) }}
          {{ field_row('Telefone', form.phone, 'phone', current_user.phone) }}

          <!-- Endere√ßo -->
          {% set tutor = current_user %}
          {% set endereco = tutor.endereco if tutor and tutor.endereco else None %}
          <div class="mb-3">
            <label class="form-label">Endere√ßo</label>
            <div class="d-flex align-items-center text-muted">
              <span>
                {% if endereco and endereco.rua %}
                  {{ endereco.rua }}{% if endereco.numero %}, {{ endereco.numero }}{% endif %}
                  {% if endereco.bairro %} - {{ endereco.bairro }}{% endif %}
                {% else %}
                  ---
                {% endif %}
              </span>
              {% if endereco and endereco.rua %}
                <span class="text-success ms-2">‚úÖ</span>
              {% else %}
                <span class="text-danger ms-2">‚ö†Ô∏è</span>
              {% endif %}
            </div>
          </div>

          <div id="endereco-campos" class="d-none">
            {% include 'partials/endereco_form.html' %}
          </div>

          <div class="d-flex gap-3 mt-4 align-items-center">
            <button type="button" class="btn btn-outline-dark rounded-pill px-4" onclick="toggleAll()">
              ‚úèÔ∏è Editar Informa√ß√µes
            </button>
            <button type="submit" class="btn btn-success rounded-pill px-4">
              üíæ Salvar Altera√ß√µes
            </button>
            <div class="dropdown">
              <button class="btn btn-outline-secondary rounded-circle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-cog"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{{ url_for('change_password') }}">üîë Alterar Senha</a></li>
                <li>
                  <button type="submit"
                          name="submit"
                          formaction="{{ url_for('delete_account') }}"
                          formmethod="post"
                          class="dropdown-item text-danger"
                          onclick="return confirm('Deseja realmente excluir sua conta? Esta a√ß√£o n√£o poder√° ser desfeita.');">
                    üóë Excluir Conta
                  </button>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </form>

  </div>




  <!-- Meus Animais -->
  <div class="mb-5">
    <h4 class="mb-3">üêæ Meus Animais Cadastrados</h4>
    <div class="row g-3">
      {% for animal in user.animals if not animal.removido_em %}
      <div class="col-md-4">
        <div class="card shadow-sm rounded-4 h-100">
          {% if animal.image %}
          <img src="{{ animal.image }}" class="card-img-top rounded-top-4" style="height: 180px; object-fit: cover;" loading="lazy" alt="Foto de {{ animal.name }}">
          {% endif %}
          <div class="card-body">
            <h5 class="card-title">{{ animal.name }}</h5>
            <p class="mb-1"><strong>Esp√©cie:</strong> {{ animal.species }}</p>
            <p class="mb-1"><strong>Ra√ßa:</strong> {{ animal.breed }}</p>
            <p class="mb-1"><strong>Idade:</strong> {{ animal.age_display }}</p>
            <div class="d-flex flex-wrap gap-2 mt-2">
              <a href="{{ url_for('ficha_animal', animal_id=animal.id) }}" class="btn btn-sm btn-outline-dark">üìã Ficha</a>
              <a href="{{ url_for('editar_animal', animal_id=animal.id) }}" class="btn btn-sm btn-outline-secondary">‚úèÔ∏è Editar</a>
              <a href="{{ url_for('planosaude_animal', animal_id=animal.id) }}" class="btn btn-sm btn-outline-success">ü©∫ Plano</a>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Bot√£o para animais removidos -->
    <div class="mt-4 text-end">
      <button class="btn btn-sm btn-link text-muted" onclick="toggleRemovidos()">
        üìÅ Ver Animais Removidos
      </button>
    </div>

    <div id="removidos-container" class="mt-2 d-none">
      <ul class="list-group">
        {% for animal in user.animals if animal.removido_em %}
        <li class="list-group-item text-muted">
          {{ animal.name }} ‚Äî <small>Removido em {{ animal.removido_em|format_datetime_brazil('%d/%m/%Y') }}</small>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Hist√≥rico de Transa√ß√µes -->
  {% if transactions %}
  <div class="mb-5">
    <h4 class="mb-3">üìú Hist√≥rico de Ado√ß√µes / Vendas</h4>
    <ul class="list-group">
      {% for t in transactions %}
      <li class="list-group-item transaction-item {% if loop.index > 3 %}d-none{% endif %}">
        <strong>{{ t.animal.name }}</strong><br>
        Tipo: {{ t.type|capitalize }}<br>
        Data: {{ t.date|format_datetime_brazil('%d/%m/%Y') }}<br>
        {% if t.from_user_id == current_user.id %}
        Para: {{ t.to_user.name }}
        {% else %}
        De: {{ t.from_user.name }}
        {% endif %}
      </li>
      {% endfor %}
    </ul>
    {% if transactions|length > 3 %}
    <div class="text-end mt-2">
      <button class="btn btn-sm btn-outline-primary" onclick="mostrarTodasTransacoes()">Ver todas</button>
    </div>
    {% endif %}
  </div>
  {% endif %}

</div>

<script>
  function toggleField(field) {
    const display = document.getElementById(field + '-display');
    const input = document.getElementById(field + '-input');
    if (input) {
      if (display) display.classList.toggle('d-none');
      input.classList.toggle('d-none');
      if (!input.classList.contains('d-none')) input.focus();
    }
  }

function toggleAll() {
  ['name', 'email', 'phone', 'address'].forEach(toggleField);
  const campoFoto = document.getElementById('campo-upload-foto');
  const camposEndereco = document.getElementById('endereco-campos');
  if (campoFoto) campoFoto.classList.toggle('d-none');
  if (camposEndereco) {
    camposEndereco.classList.toggle('d-none');
    
    // Refor√ßa a exibi√ß√£o dos valores ao ativar
    if (!camposEndereco.classList.contains('d-none')) {
      const inputs = camposEndereco.querySelectorAll('input');
      inputs.forEach(input => {
        input.value = input.defaultValue;  // ou input.setAttribute('value', input.value)
      });
    }
  }
}

document.addEventListener('DOMContentLoaded', function () {
  const img = document.getElementById('profile-photo-img');
  const fileInput = document.getElementById('profile_photo');
  const rotField = document.getElementById('photo_rotation');
  const zoomField = document.getElementById('photo_zoom');
  const offsetXField = document.getElementById('photo_offset_x');
  const offsetYField = document.getElementById('photo_offset_y');
  const rotateLeft = document.getElementById('rotate-left');
  const rotateRight = document.getElementById('rotate-right');
  const zoomIn = document.getElementById('zoom-in');
  const zoomOut = document.getElementById('zoom-out');

  let rotation = parseInt(rotField.value || 0, 10);
  let zoom = parseFloat(zoomField.value || 1);
  let offsetX = parseFloat(offsetXField.value || 0);
  let offsetY = parseFloat(offsetYField.value || 0);

  function update() {
    if (img) {
      img.style.transform = `translate(${offsetX}px, ${offsetY}px) rotate(${rotation}deg) scale(${zoom})`;
    }
    rotField.value = rotation;
    zoomField.value = zoom.toFixed(2);
    offsetXField.value = Math.round(offsetX);
    offsetYField.value = Math.round(offsetY);
  }

  if (fileInput) {
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
          if (img) img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
  }

  if (rotateLeft) rotateLeft.addEventListener('click', () => { rotation = (rotation - 90 + 360) % 360; update(); });
  if (rotateRight) rotateRight.addEventListener('click', () => { rotation = (rotation + 90) % 360; update(); });
  if (zoomIn) zoomIn.addEventListener('click', () => { zoom = Math.min(zoom + 0.25, 3); update(); });
  if (zoomOut) zoomOut.addEventListener('click', () => { zoom = Math.max(zoom - 0.25, 0.5); update(); });

  // arrastar para ajustar o corte da foto
  let dragging = false;
  let startX, startY;

  if (img) {
    img.addEventListener('mousedown', (e) => {
      dragging = true;
      startX = e.clientX - offsetX;
      startY = e.clientY - offsetY;
    });
    document.addEventListener('mousemove', (e) => {
      if (dragging) {
        offsetX = e.clientX - startX;
        offsetY = e.clientY - startY;
        update();
      }
    });
    document.addEventListener('mouseup', () => { dragging = false; });

    img.addEventListener('touchstart', (e) => {
      dragging = true;
      const t = e.touches[0];
      startX = t.clientX - offsetX;
      startY = t.clientY - offsetY;
    });
    document.addEventListener('touchmove', (e) => {
      if (dragging) {
        const t = e.touches[0];
        offsetX = t.clientX - startX;
        offsetY = t.clientY - startY;
        update();
      }
    });
    document.addEventListener('touchend', () => { dragging = false; });
  }

  update();
});


  function mostrarTodasTransacoes() {
    document.querySelectorAll('.transaction-item.d-none').forEach(function(item) {
      item.classList.remove('d-none');
    });
    event.target.style.display = 'none';
  }
</script>
{% endblock %}
